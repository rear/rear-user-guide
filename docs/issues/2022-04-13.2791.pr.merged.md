[\#2791 PR](https://github.com/rear/rear/pull/2791) `merged`: For GRUB\_RESCUE set 'root=/dev/ram0 vga=normal rw' as for other boot media
=========================================================================================================================================

**Labels**: `enhancement`, `bug`, `fixed / solved / done`

#### <img src="https://avatars.githubusercontent.com/u/26822043?v=4" width="50">[ivarmu](https://github.com/ivarmu) opened issue at [2022-04-13 13:25](https://github.com/rear/rear/pull/2791):

#### Relax-and-Recover (ReaR) Pull Request Template

Please fill in the following items before submitting a new pull request:

##### Pull Request Details:

-   Type: **Bug Fix**

-   Impact: **High**

-   Reference to related issue (URL): No issue opened right now

-   How was this pull request tested?: Local VM

-   Brief description of the changes in this pull request:  
    On RHEL8.5, if you simply add the line `GRUB_RESCUE=y` at
    `/etc/rear/site.conf` and run `rear -v mkbackup`, you'll see the new
    entry at the Grub2 menu, but that new boot option will end up with a
    Panic like the following one:

![image](https://user-images.githubusercontent.com/26822043/163188174-d61045f3-13fb-4e05-a650-04b1317f54dc.png)

The original Grub2 entry looks like the following:

    menuentry 'Relax-and-Recover' --class os {
              search --no-floppy --fs-uuid --set=root 1c0c73ea-169c-4ed5-a6d0-d0e6501fc0b6
              echo 'Loading kernel /boot/rear-kernel ...'
              linux /rear-kernel selinux=0 unattended console=ttyS0,9600 console=tty0
              echo 'Loading initrd /boot/rear-initrd.cgz (may take a while) ...'
              initrd /rear-initrd.cgz
    }

Looking at the kernel parameters used at every other boot media
generated by ReaR, the `root` parameter generated by the
`/usr/share/rear/output/default/940_grub2_rescue.sh` file is using a
wrong value, as the correct value should be `root=/dev/ram0`.

That PR is generating the grub entry with this parameter, in addition to
the `search --no-floppy --fs-uuid --set=root ...` line. Maybe that line
should disappear, but I can't test other O.S.

#### <img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50">[pcahyna](https://github.com/pcahyna) commented at [2022-04-13 14:43](https://github.com/rear/rear/pull/2791#issuecomment-1098138705):

@antonvoznia you have used `GRUB_RESCUE` recently, have you encountered
this problem?

#### <img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50">[pcahyna](https://github.com/pcahyna) commented at [2022-04-14 13:15](https://github.com/rear/rear/pull/2791#issuecomment-1099175129):

Thanks for the report and patch, interestingly, I think I have used
`GRUB_RESCUE` in the past and I don't recall having to do that, so I
wonder what exactly the problem is.

#### <img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50">[jsmeix](https://github.com/jsmeix) commented at [2022-04-20 07:38](https://github.com/rear/rear/pull/2791#issuecomment-1103570320):

I am not a GRUB expert so I may confuse things  
but I think there are two different "root" thingies here:

The "root" for GRUB (i.e. where GRUB finds its files).  
This is specified via `search --no-floppy --fs-uuid --set=root ...`

The "root" for the kernel (i.e. where Linux finds its files).  
This can be specified via a Linux kernel comand line parameter.

#### <img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50">[jsmeix](https://github.com/jsmeix) commented at [2022-04-20 07:53](https://github.com/rear/rear/pull/2791#issuecomment-1103582926):

@pcahyna  
I had used and tested GRUB\_RESCUE some longer time ago  
in particular during
[https://github.com/rear/rear/pull/942](https://github.com/rear/rear/pull/942)  
and it had worked for me at that time (on SLES12)  
for certain values of "worked", see the details in that pull request ;-)

#### <img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50">[pcahyna](https://github.com/pcahyna) commented at [2022-04-20 09:23](https://github.com/rear/rear/pull/2791#issuecomment-1103689178):

well I saw @antonvoznia using GRUB\_RESCUE recently and it worked, so
apparently sometimes it works, sometimes it does not. I will try to
reproduce it, but if not successful, I would just merge the PR and not
dedicate too much attention to the issue.

#### <img src="https://avatars.githubusercontent.com/u/26822043?v=4" width="50">[ivarmu](https://github.com/ivarmu) commented at [2022-04-20 10:00](https://github.com/rear/rear/pull/2791#issuecomment-1103741724):

> well I saw @antonvoznia using GRUB\_RESCUE recently and it worked, so
> apparently sometimes it works, sometimes it does not. I will try to
> reproduce it, but if not successful, I would just merge the PR ond not
> dedicate too much attention to the issue.

For your reference, I'm using the following config:

    OUTPUT=ISO
    OUTPUT_URL=file:///secundario/imagenes

    BACKUP=NETFS
    BACKUP_URL=file:///secundario/imagenes
    NETFS_KEEP_OLD_BACKUP_COPY=2

    EXCLUDE_VG=("secundario")
    EXCLUDE_MOUNTPOINTS=("/secundario/logs" "/secundario/imagenes")

    GRUB_RESCUE=y

    ISO_DEFAULT="automatic"

    KERNEL_CMDLINE="${KERNEL_CMDLINE:-} unattended root=/dev/ram0"

    REQUIRED_PROGS+=("/root/rear-configs/montar_disco_secundario.sh")

    PRE_RECOVERY_SCRIPT="/bin/montar_disco_secundario.sh"

    USER_INPUT_TIMEOUT=5

If I remove the `root=/dev/ram0` from the `KERNEL_CMDLINE`, the system
is unable to boot with the new Grub2 entry. Remember I'm using RHEL8.5.

#### <img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50">[jsmeix](https://github.com/jsmeix) commented at [2022-04-20 10:18](https://github.com/rear/rear/pull/2791#issuecomment-1103766770):

Because we have `root=/dev/ram0` at many other places  
I assume it is OK to also have it in general for GRUB\_RESCUE  
(I cannot imagine why `root=/dev/ram0` should not work)  
so I approve this pull request.

#### <img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50">[jsmeix](https://github.com/jsmeix) commented at [2022-04-20 10:23](https://github.com/rear/rear/pull/2791#issuecomment-1103770994):

By the way

    # find usr/share/rear -type f | xargs grep '/dev/ram0'

shows that we have at several places

    ... root=/dev/ram0 vga=normal rw $KERNEL_CMDLINE ...

so I wonder if we should use that also for GRUB\_RESCUE  
(i.e. with additional `vga=normal rw`)?

#### <img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50">[jsmeix](https://github.com/jsmeix) commented at [2022-04-21 07:22](https://github.com/rear/rear/pull/2791#issuecomment-1104809480):

@ivarmu  
could you try out if it still works (or even works better) for you  
with additional kernel command line options `vga=normal rw`  
i.e. the line in usr/share/rear/output/default/940\_grub2\_rescue.sh
like

            echo "          linux $grub_boot_dir/$boot_kernel_name root=/dev/ram0 vga=normal rw $KERNEL_CMDLINE"

@rear/contributors  
do you think additional kernel command line options `vga=normal rw`  
make sense also for GRUB\_RESCUE?

I think with additional kernel command line options `vga=normal rw`  
booting the ReaR recovery system via GRUB\_RESCUE should  
behave more in sync (in particular what video mode is used and  
that the kernel's root device is enforced mounted read-write)  
with booting the ReaR recovery system from external medium  
(e.g. from an ISO image on CDROM or from a USB drive).

#### <img src="https://avatars.githubusercontent.com/u/26822043?v=4" width="50">[ivarmu](https://github.com/ivarmu) commented at [2022-04-21 10:19](https://github.com/rear/rear/pull/2791#issuecomment-1105019251):

@jsmeix adding these settings is working without any issue for me.

#### <img src="https://avatars.githubusercontent.com/u/26822043?v=4" width="50">[ivarmu](https://github.com/ivarmu) commented at [2022-04-21 15:16](https://github.com/rear/rear/pull/2791#issuecomment-1105364660):

shit! I've vanished my PR :-(

#### <img src="https://avatars.githubusercontent.com/u/13567759?u=b037e492e58a5f63f35277b3606d500cd622c8ed&v=4" width="50">[hpannenb](https://github.com/hpannenb) commented at [2022-04-21 15:23](https://github.com/rear/rear/pull/2791#issuecomment-1105374619):

> @rear/contributors do you think additional kernel command line options
> `vga=normal rw` make sense also for GRUB\_RESCUE?

@jsmeix You might want to take a look at
[this](https://www.gnu.org/software/grub/manual/grub/grub.html#linux). I
guess the answer to adding/using `vga=normal` is: ... it depends. Though
not knowing all the "grubby" circumstances it might also be a: ... it
does not hurt ... according to
[that](https://www.kernel.org/doc/Documentation/x86/boot.txt).

Edit: updated link to GRUB2.x manual and kernel (boot) doc.

#### <img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50">[jsmeix](https://github.com/jsmeix) commented at [2022-04-22 06:12](https://github.com/rear/rear/pull/2791#issuecomment-1106046567):

I already had looked too often at the GRUB documentation  
and at the kernel command line parameters documentation  
but the more one looks at them the more one gets confused  
what "the right way" actually is in practice "out there in real world"  
so the only thing we can do in practice is to implement what results  
least issue reports from our users "out there in real world".

Therefore my argument is:  
We use `root=/dev/ram0 vga=normal rw`  
at several places except for GRUB\_RESCUE  
and we got no issue reports from our users (as far as I know)  
except this one for GRUB\_RESCUE  
so we should also use that for GRUB\_RESCUE  
in particular because it works for @ivarmu according to  
[https://github.com/rear/rear/pull/2791\#issuecomment-1105019251](https://github.com/rear/rear/pull/2791#issuecomment-1105019251)

When issues appear with GRUB 'linux' command options  
we could "provide final power to the user" by introducing  
a new config variable for GRUB 'linux' command options  
so users could specify special things if really needed.  
But currently it seems using `root=/dev/ram0 vga=normal rw`  
"just works out there in real world" so we can keep things simple  
and use that (hardcoded) everywhere.

[https://www.gnu.org/software/grub/manual/grub/grub.html\#linux](https://www.gnu.org/software/grub/manual/grub/grub.html#linux)  
reads (excerpts)

    On x86 systems, the kernel will be booted using the 32-bit boot protocol.
    Note that this means that the ‘vga=’ boot option will not work;
    ...
    GRUB can automatically detect some uses of ‘vga=’ and
    translate them to appropriate settings of ‘gfxpayload’

I guess "will not work" does not mean that booting fails  
but only means that the 'vga' boot option has no effect  
so it boots as if there was no 'vga' boot option.  
Perhaps for 'vga=normal' GRUB can automatically  
translate it to appropriate settings of 'gfxpayload'  
so in particular 'vga=normal' may even work.  
So I think 'vga=normal' does not hurt or it even works.

#### <img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50">[jsmeix](https://github.com/jsmeix) commented at [2022-04-22 06:14](https://github.com/rear/rear/pull/2791#issuecomment-1106047927):

@pcahyna  
if you agree please merge it.

#### <img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50">[pcahyna](https://github.com/pcahyna) commented at [2022-04-22 11:59](https://github.com/rear/rear/pull/2791#issuecomment-1106443670):

I agree with adding `rw` as it is related to `root=`. Isn't it better to
add `vga` separately though - it seems unrelated and I am a bit afraid
of breaking something else?

#### <img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50">[pcahyna](https://github.com/pcahyna) commented at [2022-04-22 12:01](https://github.com/rear/rear/pull/2791#issuecomment-1106444983):

> If I remove the `root=/dev/ram0` from the `KERNEL_CMDLINE`, the system
> is unable to boot with the new Grub2 entry. Remember I'm using
> RHEL8.5.

I also tried RHEL 8.5 without modifications (so without
`root=/dev/ram0`) and it worked fine. But I don't think there is any
harm in adding it for consistency, so let's do it.

#### <img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50">[jsmeix](https://github.com/jsmeix) commented at [2022-05-23 09:38](https://github.com/rear/rear/pull/2791#issuecomment-1134432619):

@ivarmu  
thank you for your clear issue description and for your fix!

------------------------------------------------------------------------

\[Export of Github issue for
[rear/rear](https://github.com/rear/rear).\]
