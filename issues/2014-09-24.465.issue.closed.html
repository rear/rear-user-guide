<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#465 Issue closed: rear configured with netfs backup deletes other folders on NFS at failure - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#465 Issue closed: rear configured with netfs backup deletes other folders on NFS at failure";
        var mkdocs_page_input_path = "issues/2014-09-24.465.issue.closed.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a> &raquo;</li>
      <li class="breadcrumb-item active">#465 Issue closed: rear configured with netfs backup deletes other folders on NFS at failure</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="465_issue_closed_rear_configured_with_netfs_backup_deletes_other_folders_on_nfs_at_failure"><a href="https://github.com/rear/rear/issues/465">#465 Issue</a> <code>closed</code>: rear configured with netfs backup deletes other folders on NFS at failure<a class="headerlink" href="#465_issue_closed_rear_configured_with_netfs_backup_deletes_other_folders_on_nfs_at_failure" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>bug</code>, <code>fixed / solved / done</code></p>
<h4 id="andreas-tarp_opened_issue_at_2014-09-24_1531"><img src="https://avatars.githubusercontent.com/u/8861999?v=4" width="50"><a href="https://github.com/andreas-tarp">andreas-tarp</a> opened issue at <a href="https://github.com/rear/rear/issues/465">2014-09-24 15:31</a>:<a class="headerlink" href="#andreas-tarp_opened_issue_at_2014-09-24_1531" title="Permanent link">&para;</a></h4>
<p>Hi,</p>
<p>when configuring rear with BACKUP=NETFS and NETFS_URL=... pointing to a
folder not only containing backups of one single node, but other data
(like backups of other nodes) rear can delete all files on the NFS
location when cleaning up tmp directories. Here the scenario to
reproduce:</p>
<ol>
<li>rear version Relax-and-Recover 1.16.1 (on SLES 11.3)</li>
<li>configure rear with BACKUP=NETFS and NETFS_URL point to a directory
    which is not empty, so used for example by other machines to store
    also their backups</li>
<li>login via ssh to the machine to be backed up</li>
<li>start to create a backup with "rear -v mkbackup" and wait until rear
    shows progress about files system backup on terminal (something like
    "Archived 434 MiB [avg 8722 KiB/sec]")</li>
<li>loose connection to your machine (either by fault or use "kill PID"
    where PID is the PID of your ssh session</li>
<li>rear now recognizes that the session died<br />
    (Log entry in rear-<hostname>.log:<br />
    /usr/share/rear/lib/_input-output-functions.sh: line 1: 38654
    Hangup)</li>
<li>rear now tries to unmount the NFS share, but this fails
    unfortunately as most likely still some data is transferred<br />
    (Log entry in rear-<hostname>.log:<br />
    ++++ umount -f -v /tmp/rear.ZsnBUJDGiKeYRNw/outputfs<br />
    .....................<br />
    umount2: Device or resource busy)</li>
<li>rear ignores the umount problem and forces removal of "temp" data<br />
    (Log entry in rear-<hostname>.log:<br />
    2014-09-24 16:56:43 Removing build area /tmp/rear.ZsnBUJDGiKeYRNw<br />
    ++++ rm -Rf /tmp/rear.ZsnBUJDGiKeYRNw/tmp<br />
    ++++ rm -Rf /tmp/rear.ZsnBUJDGiKeYRNw/rootfs<br />
    ++++ rm -Rf /tmp/rear.ZsnBUJDGiKeYRNw/outputfs)</li>
<li>result is that all folders on NFS directory mounted by rear are gone
    (so also the ones not created by rear)</li>
</ol>
<p>In my point of view this is a very nasty behaviour. Rear should not
cleanup outputfs folder when NFS unmount fails.</p>
<p>Workaround is to point NETFS_URL= to a dedicated directory on NFS to
ensure that rear can only delete backups of that single node.</p>
<p>Edit: I have a rear-<hostname>.log with debugscript mode enabled.
Unfortunately I can not attach it, github only accepts images?</p>
<p>Edit 2: Besides this rear works like a charm on HP DL380G8 servers
running SLES 11.3. Thanks a lot for the great tool.</p>
<p>BR, Andreas</p>
<h4 id="gdha_commented_at_2014-09-24_1709"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/issues/465#issuecomment-56704912">2014-09-24 17:09</a>:<a class="headerlink" href="#gdha_commented_at_2014-09-24_1709" title="Permanent link">&para;</a></h4>
<p>@andreas-tarp It is the <code>/tmp/rear.ZsnBUJDGiKeYRNw/outputfs</code> which is
causing you the pains. You can add the log via gist.github.com and copy
the link in here.</p>
<h4 id="andreas-tarp_commented_at_2014-09-25_0640"><img src="https://avatars.githubusercontent.com/u/8861999?v=4" width="50"><a href="https://github.com/andreas-tarp">andreas-tarp</a> commented at <a href="https://github.com/rear/rear/issues/465#issuecomment-56779453">2014-09-25 06:40</a>:<a class="headerlink" href="#andreas-tarp_commented_at_2014-09-25_0640" title="Permanent link">&para;</a></h4>
<p>Hi,</p>
<p>thanks for the gist.gitbug.com tip. Here the logfile:<br />
<a href="https://gist.github.com/andreas-tarp/210bee9b4ef52dec4d60/download#">https://gist.github.com/andreas-tarp/210bee9b4ef52dec4d60/download#</a></p>
<h4 id="gdha_commented_at_2014-09-25_0720"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/issues/465#issuecomment-56782850">2014-09-25 07:20</a>:<a class="headerlink" href="#gdha_commented_at_2014-09-25_0720" title="Permanent link">&para;</a></h4>
<p>I see in the log file:</p>
<pre><code>++++ rm -Rf /tmp/rear.ZsnBUJDGiKeYRNw/outputfs
rm: cannot remove `/tmp/rear.ZsnBUJDGiKeYRNw/outputfs': Device or resource busy
++++ rmdir -v /tmp/rear.ZsnBUJDGiKeYRNw
rmdir: removing directory, `/tmp/rear.ZsnBUJDGiKeYRNw'
rmdir: failed to remove `/tmp/rear.ZsnBUJDGiKeYRNw': Directory not empty
</code></pre>
<p>that the outputfs directory could not be removed. Therefore, I cannot
understand (yet) that files beneath the outputfs get deleted? Are you
saying that all the files got deleted execpt the directory itself?</p>
<h4 id="andreas-tarp_commented_at_2014-09-25_0741"><img src="https://avatars.githubusercontent.com/u/8861999?v=4" width="50"><a href="https://github.com/andreas-tarp">andreas-tarp</a> commented at <a href="https://github.com/rear/rear/issues/465#issuecomment-56784659">2014-09-25 07:41</a>:<a class="headerlink" href="#andreas-tarp_commented_at_2014-09-25_0741" title="Permanent link">&para;</a></h4>
<p>on NFS server all files and folders below the folder configured in rear
local.conf parameter NETFS_URL are deletet. I think the message</p>
<pre><code>rm: cannot remove `/tmp/rear.ZsnBUJDGiKeYRNw/outputfs': Device or resource busy
</code></pre>
<p>is shown as rear can not delete the outputfs folder on machine running
"rear mkbackup" as NFS directory is still mounte (umount failed due to
device being busy).</p>
<p>Below some printouts from NFS server showing the behavior there before
and after rear crashed due to lost ssh connection:</p>
<ol>
<li>rear backup runnning. ls -lsh output on NFS server at backup
    destination folder configured in /etc/rear/local.conf. As you can
    see there are also a few "nodeX" subfolders not belonging to current
    backup prozess which is writing to subfolder "Node20"</li>
</ol>
<!-- -->

<pre><code>-bash-3.00# pwd
/flardir/Core/
-bash-3.00# ls -lsh *
node1:
Gesamt 20496
20496 -rw------T   1 root     root         10M Sep 24 16:54 backup.0

node2:
Gesamt 0

node3:
Gesamt 0

Node20:
Gesamt 800776
33200 -rw-------   1 root     root         16M Sep 23 15:43 backup.log
642640 -rw-------   1 root     root        314M Sep 24 16:56 backup.tar.gz
110608 -rw-------   1 root     root         54M Sep 24 16:55 Node20.initrd.cgz
7728 -rw-------   1 root     root        3,8M Sep 24 16:55 Node20.kernel
   2 -rw-------   1 root     root         271 Sep 24 16:55 Node20.message
   2 -rw-------   1 root     root         516 Sep 24 16:55 README
   2 -rw-------   1 root     root         529 Sep 24 16:55 rear-Node20
6592 -rw-------   1 root     root        3,2M Sep 24 16:55 rear.log
   2 -rw-------   1 root     root         271 Sep 24 16:55 VERSION
</code></pre>
<ol>
<li>ssh session with rear running in foreground got killed, afterwards
    all files on mounted directory on NFS Server are deleted (ls does
    not show anything anymore):</li>
</ol>
<!-- -->

<pre><code>-bash-3.00# pwd
/flardir/Core/
-bash-3.00# ls -lsh *
</code></pre>
<ol>
<li>on the machine which had "rear mkbackup" running NFS destionation is
    still mounted, but rear itself has already terminated. Thats the
    reason why outputfs can not be deleted:</li>
</ol>
<!-- -->

<pre><code>Node20:/var/log/rear # mount
..............
192.168.0.177:/flardir/Core/Node20/rear/ on /tmp/rear.ZsnBUJDGiKeYRNw/outputfs type nfs (rw,nfsvers=3,nolock,addr=192.168.0.177)
</code></pre>
<h4 id="gdha_commented_at_2014-10-08_1033"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/issues/465#issuecomment-58338986">2014-10-08 10:33</a>:<a class="headerlink" href="#gdha_commented_at_2014-10-08_1033" title="Permanent link">&para;</a></h4>
<p>@andreas-tarp perhaps you could try the following : change in
<code>lib/framework-functions.sh</code>the function
cleanup_build_area_and_end_program the line
<code>rm -Rf $BUILD_DIR/outputfs</code> into <code>rmdir $v  $BUILD_DIR/outputfs</code><br />
Keep me informed if this would fix your problem?</p>
<h4 id="andreas-tarp_commented_at_2014-10-13_1111"><img src="https://avatars.githubusercontent.com/u/8861999?v=4" width="50"><a href="https://github.com/andreas-tarp">andreas-tarp</a> commented at <a href="https://github.com/rear/rear/issues/465#issuecomment-58877156">2014-10-13 11:11</a>:<a class="headerlink" href="#andreas-tarp_commented_at_2014-10-13_1111" title="Permanent link">&para;</a></h4>
<p>@gdha thanks a lot for looking into the issue. Now with the replaced
line the system behaves much better. Rear is not deleting folders on the
NFS location anymore. Of course it now fails to delete the local
/tmp/rear.xxxx folder as it is not empty. On top the NFS locations is
still beeing mounted after rear finished.<br />
But a manual unmount works fine after logging in again to the system
Maybe it would make sense to implement some waiting (maybe 10 or 20
seconds) and a umount retry afterwards. I assume, that the umount fails
until system has written cached data to NFS location, which might take
several seconds.</p>
<h4 id="gdha_commented_at_2015-02-13_1738"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/issues/465#issuecomment-74293487">2015-02-13 17:38</a>:<a class="headerlink" href="#gdha_commented_at_2015-02-13_1738" title="Permanent link">&para;</a></h4>
<p>added to the release notes so we can close this issue</p>
<h4 id="pcahyna_commented_at_2021-05-05_1953"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/465#issuecomment-832964957">2021-05-05 19:53</a>:<a class="headerlink" href="#pcahyna_commented_at_2021-05-05_1953" title="Permanent link">&para;</a></h4>
<p>The bug was reintroduced in 1.18. I reported it as #2611.</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2023 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2014-09-24.465.issue.closed.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
