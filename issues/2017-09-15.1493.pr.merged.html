<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#1493 PR merged: Improve cryptographic security and user-friendliness for LUKS volumes - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#1493 PR merged: Improve cryptographic security and user-friendliness for LUKS volumes";
        var mkdocs_page_input_path = "issues/2017-09-15.1493.pr.merged.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/backup_netfs.html">Example of BACKUP=NETFS</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/netfs_nas.html">Internal Backup with tar to NFS server</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../scenarios/netfs_rsync.md">Internal Backup with rsync to NFS server</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/rbme.html">External Backup using RBME</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/restic.html">External Backup using restic</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../development/squash-git-log-commments.html">How to squash git log comments into one line</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear29.html">Release Notes ReaR 2.9</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear28.html">Release Notes ReaR 2.8</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#1493 PR merged: Improve cryptographic security and user-friendliness for LUKS volumes</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="1493_pr_merged_improve_cryptographic_security_and_user-friendliness_for_luks_volumes"><a href="https://github.com/rear/rear/pull/1493">#1493 PR</a> <code>merged</code>: Improve cryptographic security and user-friendliness for LUKS volumes<a class="headerlink" href="#1493_pr_merged_improve_cryptographic_security_and_user-friendliness_for_luks_volumes" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>enhancement</code>, <code>fixed / solved / done</code></p>
<h4 id="olivero2_opened_issue_at_2017-09-15_0907"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> opened issue at <a href="https://github.com/rear/rear/pull/1493">2017-09-15 09:07</a>:<a class="headerlink" href="#olivero2_opened_issue_at_2017-09-15_0907" title="Permanent link">&para;</a></h4>
<h4 id="problem">Problem<a class="headerlink" href="#problem" title="Permanent link">&para;</a></h4>
<p>ReaR 2.2 with cryptsetup 1.6.6 (as on Ubuntu 16.04.3 LTS) uses
compiled-in default values which are not up-to-date in terms of
cryptographic security:</p>
<table>
<thead>
<tr class="header">
<th>Option</th>
<th>cryptsetup 1.6.6 Default</th>
<th>More Secure</th>
<th>Auto-detectable</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Key size</td>
<td>--key-size 256</td>
<td>--key-size 512</td>
<td>Yes</td>
</tr>
<tr class="even">
<td>Passphrase processing time (msecs)</td>
<td>--iter-time 1000</td>
<td>--iter-time 2000</td>
<td>No</td>
</tr>
<tr class="odd">
<td>Random number generation device</td>
<td>--use-urandom</td>
<td>--use-random</td>
<td>No</td>
</tr>
</tbody>
</table>

<p>For details, see <a href="https://wiki.archlinux.org/index.php/Dm-crypt/Device_encryption#Encryption_options_for_LUKS_mode">Encryption options for LUKS
mode</a>
in the ArchWiki.</p>
<p>In addition, ReaR can neither auto-detect nor use existing keyfiles for
the automatic decryption of recreated LUKS volumes. A recovered system
will ask the user for a passphrase where the original system would not.</p>
<h4 id="solution">Solution<a class="headerlink" href="#solution" title="Permanent link">&para;</a></h4>
<p>This PR improves LUKS recovery with these characteristics:</p>
<ul>
<li>Auto-detect the <code>--key-size</code> option from the original volume.</li>
<li>Auto-detect keyfiles in
    <a href="http://manpages.ubuntu.com/manpages/xenial/en/man5/crypttab.5.html">crypttab</a>
    and add them to recreated LUKS volumes.</li>
<li>Allow additional cryptsetup options, which cannot be auto-detected,
    to be configured.</li>
</ul>
<h4 id="strategy">Strategy<a class="headerlink" href="#strategy" title="Permanent link">&para;</a></h4>
<p>See comment in commit c9e7e1bdc5a788590e3a378839fbc6e099158a04.</p>
<p>Note: Removing the documented <code>mode</code> option is an incompatible change,
which simplifies the code by processing each option in the same way.
Since <code>disklayout.conf</code> is usually re-generated before being edited,
introducing this change seems OK to me.</p>
<p>Tested on Ubuntu 16.04.3 LTS.</p>
<h4 id="jsmeix_commented_at_2017-09-15_0936"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1493#issuecomment-329732748">2017-09-15 09:36</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-09-15_0936" title="Permanent link">&para;</a></h4>
<p>@OliverO2 only FYI<br />
you may have a look at the related issue<br />
<a href="https://github.com/rear/rear/issues/1444">https://github.com/rear/rear/issues/1444</a></p>
<p>@gozora<br />
I know nothing at all about LUKS so that it is bad luck for you ;-)<br />
that you are curious about how ReaR works with LUKS<br />
<a href="https://github.com/rear/rear/issues/1444#issuecomment-324071821">https://github.com/rear/rear/issues/1444#issuecomment-324071821</a><br />
so that I dare to assign this one to you :-)</p>
<h4 id="jsmeix_commented_at_2017-09-15_0944"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1493#issuecomment-329734844">2017-09-15 09:44</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-09-15_0944" title="Permanent link">&para;</a></h4>
<p>@OliverO2<br />
as far as I see in your comments in your<br />
usr/share/rear/finalize/GNU/Linux/240_reassign_luks_keyfiles.sh</p>
<pre>
original keyfiles should have been restored from the backup
</pre>

<p>it means that with this pull request nothing secret<br />
will be added into the ReaR recovery system?<br />
At least not by default without an explicit user setting?<br />
Cf.<br />
<a href="https://github.com/rear/rear/pull/1472#issuecomment-328459748">https://github.com/rear/rear/pull/1472#issuecomment-328459748</a><br />
and<br />
<a href="https://github.com/rear/rear/issues/1444#issuecomment-324294539">https://github.com/rear/rear/issues/1444#issuecomment-324294539</a></p>
<h4 id="olivero2_commented_at_2017-09-15_1015"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/pull/1493#issuecomment-329741971">2017-09-15 10:15</a>:<a class="headerlink" href="#olivero2_commented_at_2017-09-15_1015" title="Permanent link">&para;</a></h4>
<p>@jsmeix<br />
Yes, no secrets will be added to the rescue medium as stated in the
comment of commit c9e7e1bdc5a788590e3a378839fbc6e099158a04:</p>
<blockquote>
<p>Auto-detect 'keyfile' option, enable unattended (password-less)<br />
decryption via temporary keyfile without leaking original keyfiles
on<br />
rescue medium, securely re-assign keyfiles after restore.</p>
</blockquote>
<p>Also see <a href="https://github.com/OliverO2/rear/blob/c9e7e1bdc5a788590e3a378839fbc6e099158a04/usr/share/rear/layout/prepare/GNU/Linux/160_include_luks_code.sh#L42-L44">this comment in
160_include_luks_code.sh</a>.</p>
<p>When you have encrypted disks and you leak secrets onto the unencrypted
rescue medium it is like building an expensive underground bank vault
and then putting the key into a tin box on your desk. So I just went the
extra mile to avoid this.</p>
<p>I agree with
<a href="https://github.com/rear/rear/pull/1472#issuecomment-328459748">https://github.com/rear/rear/pull/1472#issuecomment-328459748</a>
and below.</p>
<p>My next task is actually to provide a ReaR option to encrypt ssh keys
which</p>
<ul>
<li>currently leak onto ReaR's rescue media, and</li>
<li>may lack passphrase-protection for unattended operations, and</li>
<li>may provide access to the central backup repository.</li>
</ul>
<p>The idea incorporates asking the user for an initial <em>recovery master
password</em> (resembling
<a href="https://github.com/rear/rear/issues/1444#issuecomment-324294539">https://github.com/rear/rear/issues/1444#issuecomment-324294539</a>),
although I would not recommend putting this into configuration files.</p>
<h4 id="jsmeix_commented_at_2017-09-15_1031"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1493#issuecomment-329745285">2017-09-15 10:31</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-09-15_1031" title="Permanent link">&para;</a></h4>
<p>@OliverO2<br />
many thanks for your explanation.</p>
<p>As you can also see in<br />
<a href="https://github.com/rear/rear/pull/1489#issuecomment-329424147">https://github.com/rear/rear/pull/1489#issuecomment-329424147</a><br />
encryption stuff is not one of my favourite areas of interest.<br />
Accordingly I do very much appreciate it when you check<br />
and even improve those things in ReaR.<br />
I look forward to your ssh improvements.<br />
As long as in etc/rear/local.conf even a dumb</p>
<pre>
SSH_ROOT_PASSWORD="rear"
</pre>

<p>still "just works" to "just get" ssh access into the recovery system<br />
I am happy because I use that all the time on my testing systems.<br />
( I do not what to have the "good old times" back when one had<br />
to do special setup to get ssh access into the recovery system. ;-)</p>
<h4 id="olivero2_commented_at_2017-09-25_1902"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/pull/1493#issuecomment-331980512">2017-09-25 19:02</a>:<a class="headerlink" href="#olivero2_commented_at_2017-09-25_1902" title="Permanent link">&para;</a></h4>
<p>@gozora</p>
<blockquote>
<p>For me implementing automatic volume unlocking is somehow politic
decision, and as I don't like politics I let @schlomo decide whether
something like this should or should not be implemented. (c.f. #1444
(comment)).</p>
</blockquote>
<p>Isn't that the original system administrator's decision that we just
recreate during recovery? He has finally decided to go with crypttab
keyfiles after all. Do you think that this decision should be overruled
by ReaR?</p>
<blockquote>
<p>this PR is broken for systems that don't use automatic unlocking of
volumes (which is completely valid setup)</p>
</blockquote>
<p>You are right. I'll correct this. Can you point me to the manpage you've
used? It seems to be a rather old version of the cryptsetup suite as
newer versions (<a href="http://manpages.ubuntu.com/manpages/xenial/en/man5/crypttab.5.html">like this
one</a>)
don't seem to allow verbatim passwords there anymore.</p>
<h4 id="gozora_commented_at_2017-09-25_1912"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/pull/1493#issuecomment-331982773">2017-09-25 19:12</a>:<a class="headerlink" href="#gozora_commented_at_2017-09-25_1912" title="Permanent link">&para;</a></h4>
<blockquote>
<p>Isn't that the original system administrator's decision that we just
recreate during recovery? He has finally decided to go with crypttab
keyfiles after all. Do you think that this decision should be
overruled by ReaR?</p>
</blockquote>
<p>Like I said, for me this is politics, I don't like politics. ReaR is my
spare time project and I don't do thing I don't like in my spare time.<br />
So again, if @schlomo does not object neither me will object.</p>
<blockquote>
<p>You are right. I'll correct this. Can you point me to the manpage
you've used? It seems to be a rather old version of the cryptsetup
suite as newer versions (like this one) don't seem to allow verbatim
passwords there anymore.</p>
</blockquote>
<p>I don't think so.</p>
<p>Excerpt from
<a href="http://manpages.ubuntu.com/manpages/xenial/en/man5/crypttab.5.html">http://manpages.ubuntu.com/manpages/xenial/en/man5/crypttab.5.html</a>:</p>
<blockquote>
<pre><code>   It can also be a device name (e.g. /dev/urandom), note however that
   LUKS requires a persistent key and therefore does not support random
   data keys.

   If the key file is the string “none”, a passphrase will be read
   interactively from the console. In this case, the options precheck,
   check, checkargs and tries may be useful.
</code></pre>
</blockquote>
<p>But to answer your question I've used <code>man crypttab</code> from CentOS 7.3</p>
<h4 id="olivero2_commented_at_2017-09-25_1924"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/pull/1493#issuecomment-331985932">2017-09-25 19:24</a>:<a class="headerlink" href="#olivero2_commented_at_2017-09-25_1924" title="Permanent link">&para;</a></h4>
<p>OK, I misunderstood this one:</p>
<blockquote>
<p>The third field specifies the encryption password.</p>
</blockquote>
<p>It initially sounded to me like is was meant to be a verbatim password
first, and a path to a keyfile only under certain circumstances. When
reading more carefully, it was never really meant to be a password. So
they have just improved the explanation in newer incarnations of that
manual page.</p>
<p>Anyway, I'll take care of the special cases of 'none' and '-'.</p>
<h4 id="jsmeix_commented_at_2017-09-26_0930"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1493#issuecomment-332141858">2017-09-26 09:30</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-09-26_0930" title="Permanent link">&para;</a></h4>
<p>A "caution!" regarding running any programs in ReaR<br />
that may (sometimes) do interactive user dialogs like<br />
"a passphrase will be read interactively from the console":</p>
<p>In ReaR interactive user dialogs won't work by default because<br />
both STDERR and STDOUT are redirected into ReaR's log file,<br />
cf. "What to do with stdout and stderr" at<br />
<a href="https://github.com/rear/rear/wiki/Coding-Style">https://github.com/rear/rear/wiki/Coding-Style</a></p>
<h4 id="olivero2_commented_at_2017-09-26_1713"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/pull/1493#issuecomment-332269420">2017-09-26 17:13</a>:<a class="headerlink" href="#olivero2_commented_at_2017-09-26_1713" title="Permanent link">&para;</a></h4>
<p>@gozora Should work now:</p>
<ul>
<li>temporary keyfiles are named after the target (<code>/dev/mapper</code>) name,
    which must be unique</li>
<li><code>none</code> entries in crypttab are recognized</li>
</ul>
<h4 id="olivero2_commented_at_2017-09-26_1723"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/pull/1493#issuecomment-332272484">2017-09-26 17:23</a>:<a class="headerlink" href="#olivero2_commented_at_2017-09-26_1723" title="Permanent link">&para;</a></h4>
<p>@jsmeix<br />
I've even tried to use the new <code>UserInput -C</code> variant to gather a
password in <code>layout/prepare/GNU/Linux/160_include_luks_code.sh</code>,
replacing the two branches in the <code>elif ... fi</code> section at the end with:</p>
<pre><code>    else
        if [ -n "$password" ] ; then
            password="$(UserInput -I LUKS_DEVICE_PASSWORD -C -t 0 -p "Please enter the password for LUKS device $target_name ($source_device):")"
        fi
        echo "echo \"$password\" | cryptsetup luksFormat --batch-mode $cryptsetup_options $source_device"
        echo "echo \"$password\" | cryptsetup luksOpen $source_device $target_name"
    fi
</code></pre>
<p>UserInput works as advertised...</p>
<pre><code>2017-09-26 16:17:10.938445407 UserInput: called in /usr/share/rear/layout/prepare/GNU/Linux/160_include_luks_code.sh line 54
2017-09-26 16:17:10.940826635 UserInput: No choices specified
2017-09-26 16:17:10.942013330 Please enter the password for LUKS device Foxtrot-02 (/dev/sdb1):
2017-09-26 16:17:26.970608078 UserInput: 'read' got user input
</code></pre>
<p>...but passwords then appeared in <code>diskrestore.sh</code> and in the logfile
nonetheless:</p>
<pre><code>+++ echo '2017-09-26 16:18:11.732036596 Creating luks device Foxtrot-02 on /dev/sdb1'
2017-09-26 16:18:11.732036596 Creating luks device Foxtrot-02 on /dev/sdb1
+++ echo abcdef5
+++ cryptsetup luksFormat --batch-mode --cipher aes-xts-plain64 --key-size 512 --hash sha256 --uuid e1949e50-2b2a-46ae-becf-70e0122df4fb --iter-time 2000 --use-random /dev/sdb1
+++ cryptsetup luksOpen /dev/sdb1 Foxtrot-02
+++ echo abcdef5
+++ component_created /dev/mapper/Foxtrot-02 crypt
</code></pre>
<p>So I've reverted this change.</p>
<h4 id="schlomo_commented_at_2017-09-26_1757"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/1493#issuecomment-332282307">2017-09-26 17:57</a>:<a class="headerlink" href="#schlomo_commented_at_2017-09-26_1757" title="Permanent link">&para;</a></h4>
<p>@OliverO2 isn't that in debug mode? Then I would expect the passwords to
show up. Users are not expected to use ReaR in debug mode so that
regular usage would be save.</p>
<h4 id="olivero2_commented_at_2017-09-26_1918"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/pull/1493#issuecomment-332306322">2017-09-26 19:18</a>:<a class="headerlink" href="#olivero2_commented_at_2017-09-26_1918" title="Permanent link">&para;</a></h4>
<p>@schlomo Invocation was just <code>rear recover</code>. Neither <code>-d</code> nor <code>-D</code> were
used.</p>
<p>Seems like it's in <code>diskrestore.sh</code>, which begins:</p>
<pre><code>#!/bin/bash

LogPrint "Start system layout restoration."

mkdir -p /mnt/local
if create_component "vgchange" "rear" ; then
    lvm vgchange -a n &gt;/dev/null
    component_created "vgchange" "rear"
fi

set -e
set -x
</code></pre>
<p>Log output looks like this:</p>
<pre><code>2017-09-26 19:09:23.782373730 ======================
2017-09-26 19:09:23.783321212 Running 'layout/recreate' stage
2017-09-26 19:09:23.784120375 ======================
2017-09-26 19:09:23.789236573 Including layout/recreate/default/100_ask_confirmation.sh
2017-09-26 19:09:23.790280158 Please confirm that '/var/lib/rear/layout/diskrestore.sh' is as you expect.
2017-09-26 19:09:24.823612547 User selected: 5) Continue recovery
2017-09-26 19:09:24.827109572 Including layout/recreate/default/200_run_script.sh
2017-09-26 19:09:24.830486207 Start system layout restoration.
/var/lib/rear/layout/diskrestore.sh: line 7: lvm: command not found
+++ create_component /dev/sda disk
+++ local device=/dev/sda
+++ local type=disk
+++ local touchfile=disk--dev-sda
+++ '[' -e /tmp/rear.QUvz5k8O4h9QKwx/tmp/touch/disk--dev-sda ']'
+++ return 0
+++ Log 'Stop mdadm'
++++ date '+%Y-%m-%d %H:%M:%S.%N '
+++ local 'timestamp=2017-09-26 19:09:24.835891725 '
+++ test 1 -gt 0
+++ echo '2017-09-26 19:09:24.835891725 Stop mdadm'
2017-09-26 19:09:24.835891725 Stop mdadm
+++ grep -q md /proc/mdstat
+++ Log 'Erasing MBR of disk /dev/sda'
++++ date '+%Y-%m-%d %H:%M:%S.%N '
+++ local 'timestamp=2017-09-26 19:09:24.838378106 '
+++ test 1 -gt 0
+++ echo '2017-09-26 19:09:24.838378106 Erasing MBR of disk /dev/sda'
2017-09-26 19:09:24.838378106 Erasing MBR of disk /dev/sda
+++ dd if=/dev/zero of=/dev/sda bs=512 count=1
1+0 records in
1+0 records out
512 bytes copied, 0.0308365 s, 16.6 kB/s
+++ sync

[...]

+++ component_created btrfsmountedsubvol:/mnt/reserve btrfsmountedsubvol
+++ local device=btrfsmountedsubvol:/mnt/reserve
+++ local type=btrfsmountedsubvol
+++ local touchfile=btrfsmountedsubvol-btrfsmountedsubvol:-mnt-reserve
+++ touch /tmp/rear.QUvz5k8O4h9QKwx/tmp/touch/btrfsmountedsubvol-btrfsmountedsubvol:-mnt-reserve
+++ set +x
2017-09-26 19:10:02.921303941 Disk layout created.
2017-09-26 19:10:02.923994344 Including layout/recreate/default/250_verify_mount.sh
2017-09-26 19:10:02.928602720 Finished running 'layout/recreate' stage in 39 seconds
2017-09-26 19:10:02.929844149 ======================
2017-09-26 19:10:02.930850913 Running 'restore' stage
2017-09-26 19:10:02.932030174 ======================
</code></pre>
<h4 id="schlomo_commented_at_2017-09-26_1919"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/1493#issuecomment-332306729">2017-09-26 19:19</a>:<a class="headerlink" href="#schlomo_commented_at_2017-09-26_1919" title="Permanent link">&para;</a></h4>
<p>Maybe the code around diskrestore actually enables <code>set -x</code> permanently.</p>
<h4 id="olivero2_commented_at_2017-09-26_1932"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/pull/1493#issuecomment-332310279">2017-09-26 19:32</a>:<a class="headerlink" href="#olivero2_commented_at_2017-09-26_1932" title="Permanent link">&para;</a></h4>
<p>Apparently, it's <code>layout/prepare/default/540_generate_device_code.sh</code>.
Nothing for me to mess with at this time ;-).</p>
<h4 id="gozora_commented_at_2017-09-27_0941"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/pull/1493#issuecomment-332467587">2017-09-27 09:41</a>:<a class="headerlink" href="#gozora_commented_at_2017-09-27_0941" title="Permanent link">&para;</a></h4>
<p>@OliverO2 thanks for updating this PR.<br />
From my point of view, this improvement works well enough to be merged,
so if there are not other objections I'll merge it next days.</p>
<p>V.</p>
<h4 id="jsmeix_commented_at_2017-09-27_1016"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1493#issuecomment-332476539">2017-09-27 10:16</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-09-27_1016" title="Permanent link">&para;</a></h4>
<p>Only a side note how to run commands really silently:<br />
To run commands that deal with confidential data<br />
really silently in ReaR see the comment in the<br />
UserInput function that reads:</p>
<pre>
#       If confidential user input is needed also in debugscripts mode the caller of the UserInput function
#       must call it in an appropriate (temporary) environment e.g. with STDERR redirected to /dev/null like:
#           { password="$( UserInput -I PASSWORD -C -r -s -p 'Enter the pasword' )" ; } 2>/dev/null
</pre>

<p>I.e. you need to put confidentially working commands into<br />
an appropriate silencing enviroment for example like</p>
<pre>
{ root_password="$( grep '^root:' /etc/shadow | cut -d ':' -f2 )" ; } 2>/dev/null
{ echo "$root_password" ; } 1>/dev/null 2>/dev/null
</pre>

<p>You cannot rely on that 'set -x' is not somehow set.<br />
The user can set it, a script may set it, whatever else...</p>
<h4 id="gozora_commented_at_2017-10-04_0842"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/pull/1493#issuecomment-334088727">2017-10-04 08:42</a>:<a class="headerlink" href="#gozora_commented_at_2017-10-04_0842" title="Permanent link">&para;</a></h4>
<p>@OliverO2 thanks for this improvement!</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2025 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2017-09-15.1493.pr.merged.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/rear/rear-user-guide" class="fa fa-code-fork" style="color: #fcfcfc"> rear/rear-user-guide</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
