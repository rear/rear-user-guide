<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#2739 Issue closed: Fails to copy all kernel modules if there are dangling symlinks in /lib/modules/... - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#2739 Issue closed: Fails to copy all kernel modules if there are dangling symlinks in /lib/modules/...";
        var mkdocs_page_input_path = "issues/2022-01-13.2739.issue.closed.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#2739 Issue closed: Fails to copy all kernel modules if there are dangling symlinks in /lib/modules/...</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="2739_issue_closed_fails_to_copy_all_kernel_modules_if_there_are_dangling_symlinks_in_libmodules"><a href="https://github.com/rear/rear/issues/2739">#2739 Issue</a> <code>closed</code>: Fails to copy all kernel modules if there are dangling symlinks in /lib/modules/...<a class="headerlink" href="#2739_issue_closed_fails_to_copy_all_kernel_modules_if_there_are_dangling_symlinks_in_libmodules" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>enhancement</code>, <code>fixed / solved / done</code></p>
<h4 id="damanin_opened_issue_at_2022-01-13_1941"><img src="https://avatars.githubusercontent.com/u/37876601?u=832a55ad26fa192d411932dcf7a9f13187d79380&v=4" width="50"><a href="https://github.com/DamaniN">DamaniN</a> opened issue at <a href="https://github.com/rear/rear/issues/2739">2022-01-13 19:41</a>:<a class="headerlink" href="#damanin_opened_issue_at_2022-01-13_1941" title="Permanent link">&para;</a></h4>
<h4 id="relax-and-recover_rear_issue_template">Relax-and-Recover (ReaR) Issue Template<a class="headerlink" href="#relax-and-recover_rear_issue_template" title="Permanent link">&para;</a></h4>
<p>Fill in the following items before submitting a new issue<br />
(quick response is not guaranteed with free support):</p>
<ul>
<li>ReaR version ("/usr/sbin/rear -V"):</li>
</ul>
<!-- -->

<pre><code># rear -V
Relax-and-Recover 2.6-git.4664.48ebb13.fixusrlib64forcdm.changed / 2021-12-23
</code></pre>
<ul>
<li>OS version ("cat /etc/os-release" or "lsb_release -a" or "cat
    /etc/rear/os.conf"):</li>
</ul>
<!-- -->

<pre><code># more /etc/redhat-release
Red Hat Enterprise Linux Server release 7.9 (Maipo)
</code></pre>
<ul>
<li>ReaR configuration files ("cat /etc/rear/site.conf" and/or "cat
    /etc/rear/local.conf"):</li>
</ul>
<!-- -->

<pre><code># cat /etc/rear/site.conf
cat: /etc/rear/site.conf: No such file or directory

# cat /etc/rear/local.conf

# This file etc/rear/local.conf is intended for the user's
# manual configuration of Relax-and-Recover (ReaR).
# For configuration through packages and other automated means
# we recommend a separated file named site.conf next to this file
# and leave local.conf as is (ReaR upstream will never ship a site.conf).
# The default OUTPUT=ISO creates the ReaR rescue medium as ISO image.
# You need to specify your particular backup and restore method for your data
# as the default BACKUP=REQUESTRESTORE does not really do that (see "man rear").
# Configuration variables are documented in /usr/share/rear/conf/default.conf
# and the examples in /usr/share/rear/conf/examples/ can be used as templates.
# ReaR reads the configuration files via the bash builtin command 'source'
# so bash syntax like VARIABLE="value" (no spaces at '=') is mandatory.
# Because 'source' executes the content as bash scripts you can run commands
# within your configuration files, in particular commands to set different
# configuration values depending on certain conditions as you need like
# CONDITION_COMMAND &amp;&amp; VARIABLE="special_value" || VARIABLE="usual_value"
# but that means CONDITION_COMMAND gets always executed when 'rear' is run
# so ensure nothing can go wrong if you run commands in configuration files.
OUTPUT=ISO
BACKUP=REQUESTRESTORE
</code></pre>
<ul>
<li>Hardware vendor/product (PC or PowerNV BareMetal or ARM) or VM (KVM
    guest or PowerVM LPAR):</li>
</ul>
<!-- -->

<pre><code>vSphere 6.7 virtual machine
</code></pre>
<ul>
<li>System architecture (x86 compatible or PPC64/PPC64LE or what exact
    ARM device):</li>
</ul>
<!-- -->

<pre><code>x86_64
</code></pre>
<ul>
<li>Firmware (BIOS or UEFI or Open Firmware) and bootloader (GRUB or
    ELILO or Petitboot):</li>
</ul>
<!-- -->

<pre><code>UEFI
GRUB
</code></pre>
<ul>
<li>Storage (local disk or SSD) and/or SAN (FC or iSCSI or FCoE) and/or
    multipath (DM or NVMe):</li>
</ul>
<!-- -->

<pre><code>VMware datastore VMDK.
</code></pre>
<ul>
<li>Storage layout ("lsblk -ipo
    NAME,KNAME,PKNAME,TRAN,TYPE,FSTYPE,LABEL,SIZE,MOUNTPOINT"):</li>
</ul>
<!-- -->

<pre><code># lsblk -ipo NAME,KNAME,PKNAME,TRAN,TYPE,FSTYPE,LABEL,SIZE,MOUNTPOINT
NAME                                        KNAME     PKNAME    TRAN   TYPE FSTYPE      LABEL  SIZE MOUNTPOINT
/dev/sda                                    /dev/sda                   disk                   24.4G
|-/dev/sda1                                 /dev/sda1 /dev/sda         part vfat               200M /boot/efi
|-/dev/sda2                                 /dev/sda2 /dev/sda         part xfs                  1G /boot
`-/dev/sda3                                 /dev/sda3 /dev/sda         part LVM2_member       23.2G
  |-/dev/mapper/rhel_rhel7--9--packer2-root /dev/dm-0 /dev/sda3        lvm  xfs               20.8G /
  `-/dev/mapper/rhel_rhel7--9--packer2-swap /dev/dm-1 /dev/sda3        lvm  swap               2.5G [SWAP]
/dev/sr0                                    /dev/sr0            sata   rom                    1024M
</code></pre>
<ul>
<li>Description of the issue (ideally so that others can reproduce it):</li>
</ul>
<p>When running the <code>rear -dvV mkrescue</code> command, it gives the error:</p>
<pre><code>Copying all kernel modules in /lib/modules/3.10.0-1160.49.1.el7.x86_64 (MODULES contains 'all_modules')
ERROR: Failed to copy all kernel modules in /lib/modules/3.10.0-1160.49.1.el7.x86_64
Some latest log messages since the last called script 400_copy_modules.sh:
  2022-01-13 10:48:35.463675697 Entering debugscript mode via 'set -x'.
  2022-01-13 10:48:35.477823907 Copying all kernel modules in /lib/modules/3.10.0-1160.49.1.el7.x86_64 (MODULES contains 'all_modules')
Aborting due to an error, check /var/log/rear/rear-rhel7-9-packer2.log for details
</code></pre>
<p>From the debug output, it looks like ReaR is running the command:</p>
<p><code>cp --verbose -t /var/tmp/rear.wFxcnNuhnHxRVPZ/rootfs -a -L --parents /lib/modules/3.10.0-1160.49.1.el7.x86_64</code></p>
<p>When I run this command manually, it gives this message:</p>
<pre><code># cp --verbose -t /var/tmp/rear.wFxcnNuhnHxRVPZ/rootfs -a -L --parents /lib/modules/3.10.0-1160.49.1.el7.x86_64 | grep cp:
cp: cannot stat ‘/lib/modules/3.10.0-1160.49.1.el7.x86_64/build’: No such file or directory
cp: cannot stat ‘/lib/modules/3.10.0-1160.49.1.el7.x86_64/source’: No such file or directory
</code></pre>
<p>NOTE: I added the grep command to remove all the successful copy
messages.</p>
<p>If I run <code>ls -la</code> on those two files, I see this:</p>
<pre><code># ls -la /lib/modules/3.10.0-1160.49.1.el7.x86_64/build /lib/modules/3.10.0-1160.49.1.el7.x86_64/source
lrwxrwxrwx. 1 root root 44 Jan  4 11:54 /lib/modules/3.10.0-1160.49.1.el7.x86_64/build -&gt; /usr/src/kernels/3.10.0-1160.49.1.el7.x86_64
lrwxrwxrwx. 1 root root  5 Jan  4 11:55 /lib/modules/3.10.0-1160.49.1.el7.x86_64/source -&gt; build
</code></pre>
<p>If I run <code>ls -la</code> on <code>/usr/src/kernels/3.10.0-1160.49.1.el7.x86_64</code> we
see that it does not exist:</p>
<pre><code># ls -la /usr/src/kernels/3.10.0-1160.49.1.el7.x86_64
ls: cannot access /usr/src/kernels/3.10.0-1160.49.1.el7.x86_64: No such file or directory
</code></pre>
<p>It seems that this invocation of the <code>cp</code> command cannot deal with links
that go nowhere.</p>
<ul>
<li>Workaround, if any:</li>
</ul>
<p>If I touch the missing file, the <code>rear mkrescue</code> command will work:</p>
<p><code>touch /usr/src/kernels/3.10.0-1160.49.1.el7.x86_64</code></p>
<ul>
<li>Attachments, as applicable ("rear -D mkrescue/mkbackup/recover"
    debug log files):</li>
</ul>
<p>Debug log:<br />
<a href="https://github.com/rear/rear/files/7865500/rear-rhel7-9-packer2.log">rear-rhel7-9-packer2.log</a></p>
<p>To paste verbatim text like command output or file content,<br />
include it between a leading and a closing line of three backticks like</p>
<pre><code># rear -Ddv mkrescue
Relax-and-Recover 2.6-git.4664.48ebb13.fixusrlib64forcdm.changed / 2021-12-23
Running rear mkrescue (PID 21018 date 2022-01-13 11:37:15)
Command line options: /sbin/rear -Ddv mkrescue
Using log file: /var/log/rear/rear-rhel7-9-packer2.log
Using build area: /var/tmp/rear.dT1K0LFoFNo8LCF
Running 'init' stage ======================
Running workflow mkrescue on the normal/original system
Running 'prep' stage ======================
Found EFI system partition /dev/sda1 on /boot/efi type vfat
Using UEFI Boot Loader for Linux (USING_UEFI_BOOTLOADER=1)
Using '/bin/mkisofs' to create ISO filesystem images
Using autodetected kernel '/boot/vmlinuz-3.10.0-1160.49.1.el7.x86_64' as kernel in the recovery system
Running 'layout/save' stage ======================
Creating disk layout
Overwriting existing disk layout file /var/lib/rear/layout/disklayout.conf
Disabling excluded components in /var/lib/rear/layout/disklayout.conf
Using guessed bootloader 'EFI' for 'rear recover' (found in first bytes on /dev/sda)
Verifying that the entries in /var/lib/rear/layout/disklayout.conf are correct
Created disk layout (check the results in /var/lib/rear/layout/disklayout.conf)
Running 'rescue' stage ======================
Creating recovery system root filesystem skeleton layout
Handling network interface 'ens192'
ens192 is a physical device
Handled network interface 'ens192'
Included current keyboard mapping (via 'dumpkeys -f')
Included default US keyboard mapping /lib/kbd/keymaps/legacy/i386/qwerty/defkeymap.map.gz
Included other keyboard mappings in /lib/kbd/keymaps
To log into the recovery system via ssh set up /root/.ssh/authorized_keys or specify SSH_ROOT_PASSWORD
Trying to find what to use as UEFI bootloader...
Trying to find a 'well known file' to be used as UEFI bootloader...
Using '/boot/efi/EFI/redhat/grubx64.efi' as UEFI bootloader file
Copying logfile /var/log/rear/rear-rhel7-9-packer2.log into initramfs as '/tmp/rear-rhel7-9-packer2-partial-2022-01-13T11:37:20-0800.log'
Running 'build' stage ======================
Copying files and directories
Copying binaries and libraries
Copying all kernel modules in /lib/modules/3.10.0-1160.49.1.el7.x86_64 (MODULES contains 'all_modules')
ERROR: Failed to copy all kernel modules in /lib/modules/3.10.0-1160.49.1.el7.x86_64
Some latest log messages since the last called script 400_copy_modules.sh:
  2022-01-13 11:37:41.686293147 Entering debugscript mode via 'set -x'.
  2022-01-13 11:37:41.699629083 Copying all kernel modules in /lib/modules/3.10.0-1160.49.1.el7.x86_64 (MODULES contains 'all_modules')
Aborting due to an error, check /var/log/rear/rear-rhel7-9-packer2.log for details
Exiting rear mkrescue (PID 21018) and its descendant processes ...
Running exit tasks
To remove the build area you may use (with caution): rm -Rf --one-file-system /var/tmp/rear.dT1K0LFoFNo8LCF
Terminated
</code></pre>
<h4 id="hpannenb_commented_at_2022-01-14_0840"><img src="https://avatars.githubusercontent.com/u/13567759?u=b037e492e58a5f63f35277b3606d500cd622c8ed&v=4" width="50"><a href="https://github.com/hpannenb">hpannenb</a> commented at <a href="https://github.com/rear/rear/issues/2739#issuecomment-1012917999">2022-01-14 08:40</a>:<a class="headerlink" href="#hpannenb_commented_at_2022-01-14_0840" title="Permanent link">&para;</a></h4>
<p>@DamaniN I could reproduce this on an actual CentOS 7.9 VM with current
github version of ReaR. Your current workaround would be to use ReaR 2.6
release / <code>Relax-and-Recover 2.6 / 2020-06-17</code> instead.<br />
It also shows the broken symlinks but continues creating the rescue
image.</p>
<h4 id="jsmeix_commented_at_2022-01-14_0926"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2739#issuecomment-1012949307">2022-01-14 09:26</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-01-14_0926" title="Permanent link">&para;</a></h4>
<p>Simple reproducer:</p>
<pre><code># mkdir cp-L_test

# cd cp-L_test

# echo foo &gt; foo

# ln -s foo foosymlink

# ln -s bar barsymlink

# file *
barsymlink: broken symbolic link to bar
foo:        ASCII text
foosymlink: symbolic link to foo

# mkdir /tmp/somewhere

# cp -t /tmp/somewhere -L *
cp: cannot stat 'barsymlink': No such file or directory

# echo $?
1

# file /tmp/somewhere/*
/tmp/somewhere/foo:        ASCII text
/tmp/somewhere/foosymlink: ASCII text
</code></pre>
<p>Unfortunately there is no <code>cp</code> option to let it skip/ignore broken
symlinks and<br />
unfortunately the <code>cp</code> exit code cannot be used to distinguish this case
from real errors.</p>
<h4 id="jsmeix_commented_at_2022-01-14_1012"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2739#issuecomment-1012984730">2022-01-14 10:12</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-01-14_1012" title="Permanent link">&para;</a></h4>
<p>This happens since<br />
<a href="https://github.com/rear/rear/commit/bd8e32c06bf49a8630ade196be54193aa129d146">https://github.com/rear/rear/commit/bd8e32c06bf49a8630ade196be54193aa129d146</a></p>
<pre><code>Update 400_copy_modules.sh
...
Additionally in case of MODULES=( 'all_modules' ) also use 'cp -L' to
copy the actual content to avoid dangling symlinks in the recovery system.
...
     if IsInArray "all_modules" "${MODULES[@]}" ; then
...
-        if ! cp $verbose -t $ROOTFS_DIR -a --parents ...
+        if ! cp $verbose -t $ROOTFS_DIR -a -L --parents ...
</code></pre>
<p>so the simpler and better workaround is to remove that '-L' there<br />
in usr/share/rear/build/GNU/Linux/400_copy_modules.sh<br />
so you can still use our GitHub master code and test it on your
systems<br />
and report issues to us which we need from you and which is much
appreciated<br />
because for me it "just works" (of course - otherwise I would not have
commited it).</p>
<h4 id="jsmeix_commented_at_2022-01-14_1047"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2739#issuecomment-1013010712">2022-01-14 10:47</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-01-14_1047" title="Permanent link">&para;</a></h4>
<p>I want to keep the '-L' functionality because of the reasoning in<br />
<a href="https://github.com/rear/rear/issues/2677">https://github.com/rear/rear/issues/2677</a>
therein see in particular<br />
<a href="https://github.com/rear/rear/issues/2677#issuecomment-997859219">https://github.com/rear/rear/issues/2677#issuecomment-997859219</a></p>
<p>So now I have to also care about dangling symlinks on the original
system.</p>
<h4 id="hpannenb_commented_at_2022-01-14_1128"><img src="https://avatars.githubusercontent.com/u/13567759?u=b037e492e58a5f63f35277b3606d500cd622c8ed&v=4" width="50"><a href="https://github.com/hpannenb">hpannenb</a> commented at <a href="https://github.com/rear/rear/issues/2739#issuecomment-1013038859">2022-01-14 11:28</a>:<a class="headerlink" href="#hpannenb_commented_at_2022-01-14_1128" title="Permanent link">&para;</a></h4>
<p>@DamaniN A simple workaround is to add a</p>
<p><code>MODULES=( 'loaded_modules' )</code></p>
<p>to Your <code>site.conf</code> if You do not need to use the rescue image for
migrations. In my VM Your issue just occurs for the <code>all_modules</code>
(default) use case.</p>
<h4 id="hpannenb_commented_at_2022-01-14_1616"><img src="https://avatars.githubusercontent.com/u/13567759?u=b037e492e58a5f63f35277b3606d500cd622c8ed&v=4" width="50"><a href="https://github.com/hpannenb">hpannenb</a> commented at <a href="https://github.com/rear/rear/issues/2739#issuecomment-1013262775">2022-01-14 16:16</a>:<a class="headerlink" href="#hpannenb_commented_at_2022-01-14_1616" title="Permanent link">&para;</a></h4>
<blockquote>
<p>I want to keep the '-L' functionality because of the reasoning in
#2677 therein see in particular <a href="https://github.com/rear/rear/issues/2677#issuecomment-997859219">#2677
(comment)</a></p>
<p>So now I have to also care about dangling symlinks on the original
system.</p>
</blockquote>
<p>Maybe there is an easier approach:<br />
I suppose You can keep the <code>-L</code> in the <code>MODULES=( 'loaded_modules' )</code>
case resuming the struggle in #2677 was related to the <code>readlink -e</code>
part determining the real path of the loaded modules.</p>
<p>For the case <code>MODULES = ( 'all_modules' )</code> You might revert to the
previous 2.6's <code>cp -a</code> solution since this did not cause an issue.</p>
<h4 id="damanin_commented_at_2022-01-14_1850"><img src="https://avatars.githubusercontent.com/u/37876601?u=832a55ad26fa192d411932dcf7a9f13187d79380&v=4" width="50"><a href="https://github.com/DamaniN">DamaniN</a> commented at <a href="https://github.com/rear/rear/issues/2739#issuecomment-1013372517">2022-01-14 18:50</a>:<a class="headerlink" href="#damanin_commented_at_2022-01-14_1850" title="Permanent link">&para;</a></h4>
<p>@jsmeix, thanks for the workarounds. I would suggest that since adding
the <code>-L</code> option to <code>cp</code> seems to be a breaking change to existing
systems, users should have to opt-in to it. Providing some flag to
enable <code>-L</code> on <code>cp</code> may be preferred for the GA release of the next
version of ReaR. Otherwise, many working systems may be broken by the
update.</p>
<h4 id="jsmeix_commented_at_2022-01-17_0921"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2739#issuecomment-1014304127">2022-01-17 09:21</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-01-17_0921" title="Permanent link">&para;</a></h4>
<p>When on the original system there is<br />
<code>/lib/modules/symlink -&gt; /somewhere/else/kernel_module</code><br />
the recovery system must contain the actual kernel module<br />
and not only the dangling/broken symlink <code>/lib/modules/symlink</code>.</p>
<p>This is why '-L' is also needed for <code>MODULES = ( 'all_modules' )</code>.<br />
If '-L' would be omitted for <code>MODULES = ( 'all_modules' )</code><br />
and <code>kernel_module</code> is really needed (e.g. when it is loaded by the
kernel)<br />
then the recovery system would work with
<code>MODULES=( 'loaded_modules' )</code><br />
but it would fail with the default <code>MODULES = ( 'all_modules' )</code><br />
which means ReaR would result by default a broken recovery system.</p>
<p>The latter would be a much more severe bug compared to the current<br />
error exit during "rear mkrescue" because of a bug in the original
system<br />
(dangling/broken symlinks can happen but they cannot be "right")<br />
that can easily be fixed by the admin of the original system<br />
(remove the broken symlink if is is not needed or install<br />
the actual content where the dangling symlink points to).</p>
<p>When Linux distributions have /lib/modules/ with broken symlinks<br />
it is a bug in what they provide.<br />
E.g. on my one openSUSE leap 15.3 system there is no symlink in
/lib/modules/<br />
(<code>find /lib/modules/ -type l</code> shows nothing)<br />
and on my other openSUSE leap 15.3 system with Nvidia drivers I have</p>
<pre><code># find /lib/modules/ -type l | xargs file
/lib/modules/5.3.18-59.37-default/source:                                 symbolic link to /usr/src/linux-5.3.18-59.37
/lib/modules/5.3.18-59.37-default/weak-updates/updates/nvidia-uvm.ko:     symbolic link to /lib/modules/5.3.18-57-default/updates/nvidia-uvm.ko
/lib/modules/5.3.18-59.37-default/weak-updates/updates/nvidia-peermem.ko: symbolic link to /lib/modules/5.3.18-57-default/updates/nvidia-peermem.ko
/lib/modules/5.3.18-59.37-default/weak-updates/updates/nvidia-modeset.ko: symbolic link to /lib/modules/5.3.18-57-default/updates/nvidia-modeset.ko
/lib/modules/5.3.18-59.37-default/weak-updates/updates/nvidia-drm.ko:     symbolic link to /lib/modules/5.3.18-57-default/updates/nvidia-drm.ko
/lib/modules/5.3.18-59.37-default/weak-updates/updates/nvidia.ko:         symbolic link to /lib/modules/5.3.18-57-default/updates/nvidia.ko
/lib/modules/5.3.18-59.37-default/build:                                  symbolic link to /usr/src/linux-5.3.18-59.37-obj/x86_64/default
</code></pre>
<p>A problem with those particular symlinks</p>
<pre><code>/lib/modules/5.3.18-59.37-default/source -&gt; /usr/src/linux-5.3.18-59.37
/lib/modules/5.3.18-59.37-default/build -&gt; /usr/src/linux-5.3.18-59.37-obj/x86_64/default
</code></pre>
<p>is that <code>cp -a -L</code> copies all in /usr/src/linux-5.3.18-59.37<br />
and all in /usr/src/linux-5.3.18-59.37-obj/x86_64/default<br />
which contain in my case 17549 and 9944 files that are no kernel
modules<br />
that needlessly increase the recovery system size by 123M (uncompressed)</p>
<pre><code># du -hs /usr/src/linux-5.3.18-59.37 /usr/src/linux-5.3.18-59.37-obj/x86_64/default
107M    /usr/src/linux-5.3.18-59.37
16M     /usr/src/linux-5.3.18-59.37-obj/x86_64/default
</code></pre>
<p>which increases the recovery system initrd size by about 16M
(compressed).<br />
But this is a separated problem.</p>
<p>In general:<br />
ReaR is not there to silently ignore bugs in the original system.<br />
ReaR is also not there to search for bugs in the original system.<br />
But when ReaR is hit by a bug it must not silently ignore it,<br />
cf. the section "Try hard to care about possible errors" in<br />
<a href="https://github.com/rear/rear/wiki/Coding-Style">https://github.com/rear/rear/wiki/Coding-Style</a></p>
<p>The question is if ReaR really needs to error out when<br />
<code>cp -a -L</code> fails for <code>MODULES = ( 'all_modules' )</code><br />
or if only a LogPrintError user info message<br />
could be reasonably sufficient in this case?</p>
<h4 id="jsmeix_commented_at_2022-01-17_1018"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2739#issuecomment-1014357316">2022-01-17 10:18</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-01-17_1018" title="Permanent link">&para;</a></h4>
<p>With<br />
<a href="https://github.com/rear/rear/commit/e929ae63c65ef604c678322d92ca13ff99675b63">https://github.com/rear/rear/commit/e929ae63c65ef604c678322d92ca13ff99675b63</a><br />
we do no longer error out if 'cp -a -L' failed to to copy all contents
of /lib/modules/...<br />
but we tell the user about the issue so he could inspect his system and
decide.</p>
<p>At least for now this issue should be reasonably mitigated.<br />
Perhaps a real solution could be developed later.</p>
<p>The actual root cause is a broken original system (i.e. broken symlink).</p>
<h4 id="hpannenb_commented_at_2022-01-17_1027"><img src="https://avatars.githubusercontent.com/u/13567759?u=b037e492e58a5f63f35277b3606d500cd622c8ed&v=4" width="50"><a href="https://github.com/hpannenb">hpannenb</a> commented at <a href="https://github.com/rear/rear/issues/2739#issuecomment-1014365927">2022-01-17 10:27</a>:<a class="headerlink" href="#hpannenb_commented_at_2022-01-17_1027" title="Permanent link">&para;</a></h4>
<p>BTW, does not <code>490_fix_broken_links.sh</code> take care about those broken
links anyway?</p>
<h4 id="jsmeix_commented_at_2022-01-17_1034"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2739#issuecomment-1014372099">2022-01-17 10:34</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-01-17_1034" title="Permanent link">&para;</a></h4>
<p>build/default/490_fix_broken_links.sh cares about broken symlinks
inside the recovery system<br />
but 'cp -L path/to/broken_symlink' won't copy the broken symlink into
the recovery system<br />
and build/default/490_fix_broken_links.sh can only fix broken
symlinks in the recovery system<br />
where the matching symlink on the original system is not broken (i.e.
has an actual target).<br />
Only the user can fix a broken symlink on his original system:<br />
Either remove the broken symlink if is is not needed<br />
or provide the right content where the dangling symlink points to.</p>
<h4 id="jsmeix_commented_at_2022-01-17_1234"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2739#issuecomment-1014473854">2022-01-17 12:34</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-01-17_1234" title="Permanent link">&para;</a></h4>
<p>@hpannenb<br />
or do you mean that we should in general not specfically care about
symlinks<br />
in the individual scripts i.e. that in general we just copy symlinks as
symlinks<br />
and leave it completely to build/default/490_fix_broken_links.sh<br />
to fix the broken symlinks inside the recovery system?</p>
<p>On first glance this looks wrong because each code part should do its
task right<br />
but on a second glance fix only actually broken symlinks in a generic
script at the end<br />
could have general advantages.</p>
<p>Example:<br />
Assume in the original system there are</p>
<pre><code>/path/to/huge_file
/path1/to/symlink1 -&gt; /path/to/huge_file
/path2/to/symlink2 -&gt; /path/to/huge_file
</code></pre>
<p>then 'cp -L' results that in the recovery system<br />
both /path1/to/symlink1 and /path2/to/symlink2 are regular files<br />
with identical contents as /path/to/huge_file<br />
cf.
<a href="https://github.com/rear/rear/issues/2739#issuecomment-1012949307">https://github.com/rear/rear/issues/2739#issuecomment-1012949307</a><br />
so 'cp -L' can result needlessly duplicated content<br />
in particular when /path/to/huge_file gets included anyway.</p>
<p>Another reason is that in practice it gets rather complicated<br />
to deal correctly with symlinks (e.g. this issue here) at each code
place<br />
so it could be better in practice to not care at each code place<br />
and only fix what actually needs to be fixed at the end.</p>
<p>So it could be better in practice to copy symlinks as symlinks<br />
and only add actually missing symlink targets at the end.</p>
<h4 id="hpannenb_commented_at_2022-01-17_1248"><img src="https://avatars.githubusercontent.com/u/13567759?u=b037e492e58a5f63f35277b3606d500cd622c8ed&v=4" width="50"><a href="https://github.com/hpannenb">hpannenb</a> commented at <a href="https://github.com/rear/rear/issues/2739#issuecomment-1014483568">2022-01-17 12:48</a>:<a class="headerlink" href="#hpannenb_commented_at_2022-01-17_1248" title="Permanent link">&para;</a></h4>
<blockquote>
<p>@hpannenb or do you mean that we should in general not specfically
care about symlinks in the individual scripts i.e. that in general we
just copy symlinks as symlinks and leave it completely to
build/default/490_fix_broken_links.sh to fix the broken symlinks
inside the recovery system?</p>
</blockquote>
<p>In principle that is what I meant.</p>
<blockquote>
<p>So it could be better in practice to copy symlinks as symlinks<br />
and only add actually missing symlink targets at the end.</p>
</blockquote>
<p>Yes.</p>
<h4 id="jsmeix_commented_at_2022-01-17_1308"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2739#issuecomment-1014514319">2022-01-17 13:08</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-01-17_1308" title="Permanent link">&para;</a></h4>
<p>Whether or not to<br />
copy symlinks as symlinks and add missing symlink targets at the end<br />
needs to be discussed via
<a href="https://github.com/rear/rear/issues/2740">https://github.com/rear/rear/issues/2740</a></p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2024 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2022-01-13.2739.issue.closed.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/rear/rear-user-guide" class="fa fa-code-fork" style="color: #fcfcfc"> rear/rear-user-guide</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
