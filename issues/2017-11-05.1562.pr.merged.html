<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>2017 11 05.1562.pr.merged - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "2017 11 05.1562.pr.merged";
        var mkdocs_page_input_path = "issues/2017-11-05.1562.pr.merged.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/rust.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', '366986045', 'auto');
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a> &raquo;</li>
      <li>2017 11 05.1562.pr.merged</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="1562_pr_merged_update_and_export_ld_library_path_when_using_tsm"><a href="https://github.com/rear/rear/pull/1562">#1562 PR</a> <code>merged</code>: Update and export LD_LIBRARY_PATH when using TSM<a class="headerlink" href="#1562_pr_merged_update_and_export_ld_library_path_when_using_tsm" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>bug</code>, <code>fixed / solved / done</code>, <code>external tool</code></p>
<h4 id="schabrolles_opened_issue_at_2017-11-05_0907"><img src="https://avatars.githubusercontent.com/u/19491077?u=0021b16ab426902cbe676f6831f41607bbe4d441&v=4" width="50"><a href="https://github.com/schabrolles">schabrolles</a> opened issue at <a href="https://github.com/rear/rear/pull/1562">2017-11-05 09:07</a>:<a class="headerlink" href="#schabrolles_opened_issue_at_2017-11-05_0907" title="Permanent link">&para;</a></h4>
<p>As explain in #1533, <code>rear mkrescue</code> failed when using with TSM because
of the need of additional libraries.<br />
This error comes from the image rescue check made in
<code>build/default/980_verify_rootfs.sh</code>.<br />
Two solutions here:</p>
<p>1- Update and export LD_LIBRARY_PATH in
<code>prep/TSM/default/400_prep_tsm.sh</code>. When exported, LD_LIBRARY_PATH
will be inherit into the chrooted environment used in
<code>build/default/980_verify_rootfs.sh</code>:</p>
<pre><code>for binary in $( find $ROOTFS_DIR -type f -executable -printf '/%P\n' ) ; do
    chroot $ROOTFS_DIR /bin/ldd $binary | grep -q 'not found' &amp;&amp; broken_binaries="$broken_binaries $binary"
done
</code></pre>
<p>2- We don't need all the stuff provided by the TSM client in the rescue
image (~300MB). Only <code>dsmc</code> (tsm client) binary, with some libraries and
config files.<br />
I usually use the following <code>COPY_AS_IS_TSM</code> within my conf file which
do not complain about missing libraries during <code>rear mkrescue</code> and
reduced the size of TSM client to (~30MB).</p>
<pre><code>COPY_AS_IS_TSM=( /etc/adsm/TSM.PWD /opt/tivoli/tsm/client/ba/bin/dsmc /opt/tivoli/tsm/client/ba/bin/tsmbench_inclexcl /opt/tivoli/tsm/client/ba/bin/dsm.sys /opt/tivoli/tsm/client/ba/bin/dsm.opt /opt/tivoli/tsm/client/api/bin64/libgpfs.so /opt/tivoli/tsm/client/api/bin64/libdmapi.so /opt/tivoli/tsm/client/ba/bin/EN_US/dsmclientV3.cat /usr/local/ibm/gsk8* )
</code></pre>
<p>Even if the 2nd option seems to be more optimized (size, time saving
during initrd compression) it could be also source of issues because we
cannot be sure that this set of file (name, libraries, config files)
will remain the same with the next version of TSM. So I prefer to use
the First solution (LD_LIBRARY_PATH) and let the users update
themselves their local.conf file if they want to optimize initrd size.</p>
<p>@jsmeix, I know you don't have TSM, but I would like to get your
feedback about this PR.<br />
Do you think we can use <code>export LD_LIBRARY_PATH</code> ?<br />
Could you confirm that <code>prep/TSM/default/400_prep_tsm.sh</code>is the best
place for that ?<br />
Thanks for your help and review here.</p>
<h4 id="jsmeix_commented_at_2017-11-06_1044"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1562#issuecomment-342111737">2017-11-06 10:44</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-11-06_1044" title="Permanent link">&para;</a></h4>
<p>@schabrolles<br />
I fear setting a global TSM-specific LD_LIBRARY_PATH<br />
for all programs in all ReaR scripts that run after<br />
prep/TSM/default/400_prep_tsm.sh<br />
might lead to unexpected side effects like<br />
<a href="https://github.com/rear/rear/issues/1533#issuecomment-336622504">https://github.com/rear/rear/issues/1533#issuecomment-336622504</a><br />
because libraries via LD_LIBRARY_PATH have<br />
precedence over the "normal" ones.</p>
<p>I would prefer to keep "dirty hacks" as local as possible.</p>
<p>Accordingly I suggest the TSM-specific LD_LIBRARY_PATH<br />
is only locally set for the particular 'ldd' command<br />
where it is actually needed.</p>
<p>E.g. only in build/default/980_verify_rootfs.sh something like:</p>
<pre>
local old_LD_LIBRARY_PATH
test $LD_LIBRARY_PATH && old_LD_LIBRARY_PATH=$LD_LIBRARY_PATH
if test "TSM" = "$BACKUP" ; then
    # Use a TSM-specific LD_LIBRARY_PATH to find TSM libraries
    # see https://github.com/rear/rear/issues/1533
    export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/opt/tivoli/tsm/client/ba/bin:/opt/tivoli/tsm/client/api/bin64:/opt/tivoli/tsm/client/api/bin:/opt/tivoli/tsm/client/api/bin64/cit/bin
fi
for binary in $( find $ROOTFS_DIR -type f -executable -printf '/%P\n' ) ; do
    chroot $ROOTFS_DIR /bin/ldd $binary | grep -q 'not found' && broken_binaries="$broken_binaries $binary"
done
test $old_LD_LIBRARY_PATH && export LD_LIBRARY_PATH=$old_LD_LIBRARY_PATH || unset LD_LIBRARY_PATH
</pre>

<p>I tried to avoid to have a possibly empty LD_LIBRARY_PATH<br />
set at the end.</p>
<p>I guess in case of an initially empty LD_LIBRARY_PATH<br />
the resulting TSM-specific LD_LIBRARY_PATH with<br />
a leading colon ":/opt/tivoli/tsm/client/ba/bin:/opt/..."<br />
also works?</p>
<p>@schabrolles<br />
I wonder if the hardcoded TSM-specific LD_LIBRARY_PATH<br />
is sufficiently future proof?<br />
Perhaps in default.conf a</p>
<pre>
TSM_LD_LIBRARY_PATH="/opt/tivoli/tsm/client/ba/bin:/opt/tivoli/tsm/client/api/bin64:/opt/tivoli/tsm/client/api/bin:/opt/tivoli/tsm/client/api/bin64/cit/bin"
</pre>

<p>and then</p>
<pre>
    export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$TSM_LD_LIBRARY_PATH
</pre>

<p>is better?</p>
<p>FWIW:<br />
Currently things nicely fall apart when someone has<br />
blanks in the directories in his LD_LIBRARY_PATH ;-)<br />
cf.
<a href="https://github.com/rear/rear/issues/1372">https://github.com/rear/rear/issues/1372</a></p>
<h4 id="jsmeix_commented_at_2017-11-06_1052"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1562#issuecomment-342113626">2017-11-06 10:52</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-11-06_1052" title="Permanent link">&para;</a></h4>
<p>@schabrolles<br />
and - by the way - I think you should add a comment in default.conf<br />
about how TSM users could optimize their COPY_AS_IS_TSM<br />
(I think a really small recovery ISO is required at least on<br />
some POWER systems where the initrd must be small)<br />
and what issues such an optimization might cause.</p>
<h4 id="schabrolles_commented_at_2017-11-06_1320"><img src="https://avatars.githubusercontent.com/u/19491077?u=0021b16ab426902cbe676f6831f41607bbe4d441&v=4" width="50"><a href="https://github.com/schabrolles">schabrolles</a> commented at <a href="https://github.com/rear/rear/pull/1562#issuecomment-342146335">2017-11-06 13:20</a>:<a class="headerlink" href="#schabrolles_commented_at_2017-11-06_1320" title="Permanent link">&para;</a></h4>
<p>@jsmeix, thanks ;-)<br />
I'm currently testing it</p>
<h4 id="schabrolles_commented_at_2017-11-06_1348"><img src="https://avatars.githubusercontent.com/u/19491077?u=0021b16ab426902cbe676f6831f41607bbe4d441&v=4" width="50"><a href="https://github.com/schabrolles">schabrolles</a> commented at <a href="https://github.com/rear/rear/pull/1562#issuecomment-342153344">2017-11-06 13:48</a>:<a class="headerlink" href="#schabrolles_commented_at_2017-11-06_1348" title="Permanent link">&para;</a></h4>
<p>@jsmeix, it is working. tested with rhel 6 + tsm 7<br />
I'm gonna merge this one soon if you agree.</p>
<h4 id="jsmeix_commented_at_2017-11-06_1354"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1562#issuecomment-342154952">2017-11-06 13:54</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-11-06_1354" title="Permanent link">&para;</a></h4>
<p>@schabrolles<br />
I agree</p>
<h4 id="jsmeix_commented_at_2017-11-07_1047"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1562#issuecomment-342445083">2017-11-07 10:47</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-11-07_1047" title="Permanent link">&para;</a></h4>
<p>@schabrolles<br />
would you accept a pull request from me<br />
with what I proposed in<br />
<a href="https://github.com/rear/rear/pull/1562#issuecomment-342113626">https://github.com/rear/rear/pull/1562#issuecomment-342113626</a><br />
or do you not want to have that described in default.conf<br />
and in this case I would like to know why.</p>
<h4 id="schabrolles_commented_at_2017-11-07_1145"><img src="https://avatars.githubusercontent.com/u/19491077?u=0021b16ab426902cbe676f6831f41607bbe4d441&v=4" width="50"><a href="https://github.com/schabrolles">schabrolles</a> commented at <a href="https://github.com/rear/rear/pull/1562#issuecomment-342458433">2017-11-07 11:45</a>:<a class="headerlink" href="#schabrolles_commented_at_2017-11-07_1145" title="Permanent link">&para;</a></h4>
<p>@jsmeix, Sorry, I'm a bit busy with a lot a different project those days
and I totally forget to do it.<br />
It is now done in #1566</p>
<h4 id="jsmeix_commented_at_2017-11-07_1251"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1562#issuecomment-342472863">2017-11-07 12:51</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-11-07_1251" title="Permanent link">&para;</a></h4>
<p>No need to say sorry for anything!<br />
I do appreciate all your work and contributions.</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2022 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2017-11-05.1562.pr.merged.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
