<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#1846 Issue closed: Partitioning errors in RAWDISK creation on Debian 7 and CentOS 6 - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#1846 Issue closed: Partitioning errors in RAWDISK creation on Debian 7 and CentOS 6";
        var mkdocs_page_input_path = "issues/2018-06-28.1846.issue.closed.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#1846 Issue closed: Partitioning errors in RAWDISK creation on Debian 7 and CentOS 6</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="1846_issue_closed_partitioning_errors_in_rawdisk_creation_on_debian_7_and_centos_6"><a href="https://github.com/rear/rear/issues/1846">#1846 Issue</a> <code>closed</code>: Partitioning errors in RAWDISK creation on Debian 7 and CentOS 6<a class="headerlink" href="#1846_issue_closed_partitioning_errors_in_rawdisk_creation_on_debian_7_and_centos_6" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>enhancement</code>, <code>fixed / solved / done</code></p>
<h4 id="greenblood_opened_issue_at_2018-06-28_1317"><img src="https://avatars.githubusercontent.com/u/6583431?v=4" width="50"><a href="https://github.com/GreenBlood">GreenBlood</a> opened issue at <a href="https://github.com/rear/rear/issues/1846">2018-06-28 13:17</a>:<a class="headerlink" href="#greenblood_opened_issue_at_2018-06-28_1317" title="Permanent link">&para;</a></h4>
<h4 id="relax-and-recover_rear_issue">Relax-and-Recover (ReaR) Issue<a class="headerlink" href="#relax-and-recover_rear_issue" title="Permanent link">&para;</a></h4>
<ul>
<li>ReaR version:<br />
    Relax-and-Recover 2.4-git.3020.aa7b197.master / 2018-06-21</li>
<li>OS version:<br />
    At least CentOS 6 and Debian 7 (fully updated)</li>
<li>ReaR configuration files:</li>
</ul>
<!-- -->

<pre><code>BACKUP=NETFS
OUTPUT=RAWDISK
BACKUP_TYPE=incremental
FULLBACKUPDAY="Sun"


SSH_ROOT_PASSWORD="XXXXXXX"
USE_DHCLIENT=yes

BACKUP_URL=cifs://XXXXX/XXXXX
BACKUP_OPTIONS="cred=/etc/rear/.cifs_credentials"
</code></pre>
<ul>
<li>System architecture (x86 compatible or POWER and/or what kind of
    virtual machine):<br />
    amd64</li>
<li>Are you using BIOS or UEFI or another way to boot?<br />
    classic BIOS</li>
<li>Brief description of the issue:<br />
    I've found an issue while trying to use the RAWDISK output on old
    linux distroes (Centos 6 and Debian 7)<br />
    When the mkrescue commands reaches the
    <a href="https://github.com/rear/rear/blob/master/usr/share/rear/output/RAWDISK/Linux-i386/280_create_bootable_disk_image.sh">280_create_bootable_disk_image.sh</a>
    file, it creates the raw file with dd, and adds correctly the rescue
    partition. However, on line 86 (mkfs.vfat) the program does not find
    the loop device's partition (/dev/loop0p1).</li>
</ul>
<!-- -->

<pre><code>+++ losetup --show --find /tmp/rear.H1ohZi7mUy6CZWh/tmp/rear-debian7.raw
++ disk_device=/dev/loop0
++ StopIfError 'Could not create loop device on /tmp/rear.H1ohZi7mUy6CZWh/tmp/rear-debian7.raw'
++ ((  0 != 0  ))
++ AddExitTask 'losetup -d /dev/loop0 &gt;&amp;2'
++ EXIT_TASKS=("$*" "${EXIT_TASKS[@]}")
++ Debug 'Added '\''losetup -d /dev/loop0 &gt;&amp;2'\'' as an exit task'
++ test 1
++ Log 'Added '\''losetup -d /dev/loop0 &gt;&amp;2'\'' as an exit task'
+++ date '+%Y-%m-%d %H:%M:%S.%N '
++ local 'timestamp=2018-06-28 14:58:49.154127597 '
++ test 1 -gt 0
++ echo '2018-06-28 14:58:49.154127597 Added '\''losetup -d /dev/loop0 &gt;&amp;2'\'' as an exit task'
2018-06-28 14:58:49.154127597 Added 'losetup -d /dev/loop0 &gt;&amp;2' as an exit task
++ partprobe /dev/loop0
++ local boot_partition=/dev/loop0p1
++ mkfs.vfat -v /dev/loop0p1 -n 'RESCUE SYS'
/dev/loop0p1: No such file or directory
mkfs.vfat 3.0.13 (30 Jun 2012)
++ Error 'Could not create boot file system'
++ LogPrintError 'ERROR: Could not create boot file system'
</code></pre>
<p>I tried running the losetup command myself and in fact no /dev/loop0p1
appears, even though if I run gdisk on the loop0 device it finds
correctly the partition created beforehand.</p>
<p>I guess it has to do as how those distros handle "refreshing" the
partitions available but I don't really know how to work around that.</p>
<ul>
<li>Work-around, if any:<br />
    None yet.</li>
</ul>
<p>Regards,<br />
<em>Green</em></p>
<h4 id="jsmeix_commented_at_2018-06-29_0801"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1846#issuecomment-401280008">2018-06-29 08:01</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-06-29_0801" title="Permanent link">&para;</a></h4>
<p>Support for RAWDISK output<br />
(plus TCG Opal 2-compliant self-encrypting disks)<br />
was implemented by @OliverO2 in<br />
<a href="https://github.com/rear/rear/pull/1659">https://github.com/rear/rear/pull/1659</a><br />
where <code>The code has been tested successfully on Ubuntu 16.04.3 LTS.</code></p>
<p>@OliverO2<br />
could you please have a look what goes on here?</p>
<h4 id="greenblood_commented_at_2018-06-29_1122"><img src="https://avatars.githubusercontent.com/u/6583431?v=4" width="50"><a href="https://github.com/GreenBlood">GreenBlood</a> commented at <a href="https://github.com/rear/rear/issues/1846#issuecomment-401325993">2018-06-29 11:22</a>:<a class="headerlink" href="#greenblood_commented_at_2018-06-29_1122" title="Permanent link">&para;</a></h4>
<p>Just tried on Ubuntu 14 LTS and it works fine.</p>
<p>Then I tried to update (using backports) the Debian kernel to 3.16 and
it does not change.<br />
But as debian 7 is not supported anymore (my info were outdated) we
might choose to drop it. It still leaves CentOS 6 which is still active.</p>
<p>On other news, using debian 8 there is no issue.</p>
<p>Might be related to losetup/util-linux version.</p>
<h4 id="jsmeix_commented_at_2018-06-29_1250"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1846#issuecomment-401344665">2018-06-29 12:50</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-06-29_1250" title="Permanent link">&para;</a></h4>
<p>I know nothing at all about RAWDISK output<br />
but from plain looking at the code in<br />
usr/share/rear/output/RAWDISK/Linux-i386/280_create_bootable_disk_image.sh</p>
<pre>
disk_device="$(losetup --show --find "$disk_image")"
...
local boot_partition="${disk_device}p1"
...
mkfs.vfat $v "$boot_partition" ...
</pre>

<p>it seems one cannot assume that the boot_partition device name<br />
is always of the form <code>${disk_device}p1</code>.</p>
<p>I assume how partitions are named in this case also depends on<br />
what each particular Linux distribution likes to do in this area<br />
like the various ways how each version of each Linux distribution<br />
implements their naming of multipath device nodes differently, cf.<br />
<a href="https://github.com/rear/rear/pull/1765">https://github.com/rear/rear/pull/1765</a><br />
in particular see<br />
<a href="https://github.com/rear/rear/pull/1765#issuecomment-381498504">https://github.com/rear/rear/pull/1765#issuecomment-381498504</a></p>
<p>@GreenBlood<br />
if my above assumtion is right we would need to know<br />
how on each version of each of your Linux distributions<br />
the partitions are actually named in case of loop devices.</p>
<p>You could add a line</p>
<pre>
read -p "Press ENTER to continue ... " 0&lt&6 1>&7 2>&8
</pre>

<p>anywhere in
output/RAWDISK/Linux-i386/280_create_bootable_disk_image.sh<br />
e.g. directly before the <code>mkfs.vfat ...</code> line so that it stops there<br />
and you could inspect what there actually is<br />
at exactly that state on your system.</p>
<h4 id="olivero2_commented_at_2018-06-29_1317"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/issues/1846#issuecomment-401351181">2018-06-29 13:17</a>:<a class="headerlink" href="#olivero2_commented_at_2018-06-29_1317" title="Permanent link">&para;</a></h4>
<p>@GreenBlood Thanks for reporting and your research done so far.</p>
<p>@jsmeix What you have argued so far sounds reasonable. I'll try to
figure out what could be done to improve portability.</p>
<h4 id="greenblood_commented_at_2018-06-29_1356"><img src="https://avatars.githubusercontent.com/u/6583431?v=4" width="50"><a href="https://github.com/GreenBlood">GreenBlood</a> commented at <a href="https://github.com/rear/rear/issues/1846#issuecomment-401361939">2018-06-29 13:56</a>:<a class="headerlink" href="#greenblood_commented_at_2018-06-29_1356" title="Permanent link">&para;</a></h4>
<p>@jsmeix Yeah, i've actually already tried to run the commands by hand
(dd, gdisk, losetup and such) and the loopXp1 does not appears anyhow.
But running losetup -a or fdisk -l /dev/loop0 show that the loop device
is activated.<br />
<strong>HOWEVER</strong><br />
Using a more recent kernel on the centos 6 i've managed to get it
working.</p>
<p>I noticed that util-linux was on a different version between CentOS 6
and 7, so I went and grabbed the last version source rpm and compiled
it.</p>
<p>Using the newly compiled binaries (I have not installed them as its a
pretty important package), I got this result :</p>
<pre><code>[root@centos6 util-linux-2.23.2]# losetup --show --find /tmp/rear.MOL0gr9BL4uKxck/tmp/rear-centos6.raw
/dev/loop0
[root@centos6 util-linux-2.23.2]# partx -a /dev/loop0
HDIO_GETGEO: Inappropriate ioctl for device
[root@centos6 util-linux-2.23.2]# ./partx -a /dev/loop0
[root@centos6 util-linux-2.23.2]# ls /dev/loop*
/dev/loop0  /dev/loop0p1  /dev/loop1  /dev/loop2  /dev/loop3  /dev/loop4  /dev/loop5  /dev/loop6  /dev/loop7  /dev/loop-control
</code></pre>
<p><em>While the compiled recent partx reloads the partitions, the system one
does not work</em><br />
Using the standard kernel and the compiled partx, it does not work
anymore. So I guess it's the combination of the kernel version and a
partx update that does the trick.</p>
<p>I don't know what to do with these informations, I feel like I went too
far but meh. Seems like a dead end to me. My VM is now a CentOS
Frankeinstein monster.</p>
<h4 id="olivero2_commented_at_2018-06-29_1413"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/issues/1846#issuecomment-401366883">2018-06-29 14:13</a>:<a class="headerlink" href="#olivero2_commented_at_2018-06-29_1413" title="Permanent link">&para;</a></h4>
<p>AFAIK creating device names for partitions is a kernel excercise.
Unfortunately, there doesn't seem to be a tool which reports assigned
partition device names. For example, <code>partprobe --summary</code> just outputs</p>
<pre><code>/dev/loop0: gpt partitions 1
</code></pre>
<p>As it looks like there are different opinions on how to create partition
devices names and no one to ask, my best guess would be to just rely on
the fact that partition names will consist of the device name followed
by some appendix. In this case, there is only one partition, so its name
shouldn't be too hard to guess...</p>
<p>@GreenBlood Could you change the line</p>
<pre><code>local boot_partition="${disk_device}p1"
</code></pre>
<p>to</p>
<pre><code>local boot_partition="$(echo "${disk_device}"?*)"
</code></pre>
<p>in
<code>usr/share/rear/output/RAWDISK/Linux-i386/280_create_bootable_disk_image.sh</code>
and see if that works on each distribution?</p>
<h4 id="olivero2_commented_at_2018-06-29_1425"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/issues/1846#issuecomment-401370417">2018-06-29 14:25</a>:<a class="headerlink" href="#olivero2_commented_at_2018-06-29_1425" title="Permanent link">&para;</a></h4>
<p>@GreenBlood There was an overlap in our comments: If it's not a naming
issue but a kernel failing to update its partitions table, there is
probably not much we can do here. Modern kernels should update their
partition tables automatically. Otherwise <code>partprobe "$disk_device"</code>
should instruct them to. Another idea would be to use losetup's
<code>--partscan</code> option like this:</p>
<pre><code>disk_device="$(losetup --partscan --show --find "$disk_image")"
</code></pre>
<p>Would this make it work?</p>
<h4 id="greenblood_commented_at_2018-06-29_1444"><img src="https://avatars.githubusercontent.com/u/6583431?v=4" width="50"><a href="https://github.com/GreenBlood">GreenBlood</a> commented at <a href="https://github.com/rear/rear/issues/1846#issuecomment-401376176">2018-06-29 14:44</a>:<a class="headerlink" href="#greenblood_commented_at_2018-06-29_1444" title="Permanent link">&para;</a></h4>
<p>@OliverO2 Well, It seems that CentOS 6 being nearly ten years old,
losetup does not includes <code>--partscan</code>.</p>
<p>Using my compiled losetup, it accepts this argument but does not work
any better.</p>
<pre><code>[root@centos6 util-linux-2.23.2]# ./losetup --show --find --partscan "/tmp/rear.IdSQo1PE0lrU95R/tmp/rear-centos6.raw"
/dev/loop0
[root@centos6 util-linux-2.23.2]# ls /dev/loop*
/dev/loop0  /dev/loop1  /dev/loop2  /dev/loop3  /dev/loop4  /dev/loop5  /dev/loop6  /dev/loop7
</code></pre>
<p>I guess CentOS 6 is off the list for RAWDISK, unless there is a way that
I'm unaware of.</p>
<h4 id="jsmeix_commented_at_2018-06-29_1511"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1846#issuecomment-401384488">2018-06-29 15:11</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-06-29_1511" title="Permanent link">&para;</a></h4>
<p>@OliverO2<br />
as a minimal improvement could you add a test<br />
that such a $boot_partition actually exists<br />
and error out if not like</p>
<pre>
local boot_partition="${disk_device}p1"
test -b "$boot_partition" || Error "Cannot ceate raw disk image (no $boot_partition partition on $disk_device)"
</pre>

<p>This does not make things work in environments where it currently cannot
work<br />
but it would at least tell the user what is unexpected or wrong in his
environment.</p>
<h4 id="jsmeix_commented_at_2018-06-29_1515"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1846#issuecomment-401385535">2018-06-29 15:15</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-06-29_1515" title="Permanent link">&para;</a></h4>
<p>@OliverO2<br />
in general regarding things like "kernel failing to update its
partitions table"<br />
you may have a look at the somewhat similar or related issue<br />
<a href="https://github.com/rear/rear/issues/791">https://github.com/rear/rear/issues/791</a></p>
<h4 id="olivero2_commented_at_2018-07-03_1114"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/issues/1846#issuecomment-402115034">2018-07-03 11:14</a>:<a class="headerlink" href="#olivero2_commented_at_2018-07-03_1114" title="Permanent link">&para;</a></h4>
<p>@GreenBlood Maybe there is a solution after all if you're able to
install the <code>kpartx</code> tool on your older distributions: Could you just
try to apply commit bcb0ed3e01d5e9225c6e243bb4971de90ea3c57b in my
branch
<a href="https://github.com/OliverO2/rear/tree/feature/rawdisk-portability-improvements">https://github.com/OliverO2/rear/tree/feature/rawdisk-portability-improvements</a>?</p>
<p>@jsmeix This should also improve the error message. I'll create a PR if
this has been tested successfully (currently I don't have one of these
older kernels available so I could not test it fully).</p>
<h4 id="greenblood_commented_at_2018-07-03_1324"><img src="https://avatars.githubusercontent.com/u/6583431?v=4" width="50"><a href="https://github.com/GreenBlood">GreenBlood</a> commented at <a href="https://github.com/rear/rear/issues/1846#issuecomment-402156006">2018-07-03 13:24</a>:<a class="headerlink" href="#greenblood_commented_at_2018-07-03_1324" title="Permanent link">&para;</a></h4>
<p>@OliverO2 Ok so I tried your patch but no luck.</p>
<p>But I think what @jsmeix was suggesting earlier might be the issue we're
facing. It seems that running <code>losetup</code>, then <code>kpartx -a /dev/loopX</code>
makes the device appear in /dev/disk/by-*<br />
See:</p>
<pre><code>[root@centos6 ~]# losetup -d /dev/loop0
[root@centos6 ~]# losetup --show --find rear-centos6.raw 
/dev/loop0
[root@centos6 ~]# ls /dev/disk/by-id/
(System disks)
[root@centos6 ~]# kpartx -a /dev/loop0
[root@centos6 ~]# ls /dev/disk/by-id/
dm-name-loop0p1   dm-uuid-part1-loop0        (System disks)
</code></pre>
<p>So even though <code>kpartx</code> says that its adding a /dev/loop0p1 device it's
not the case in this situation. On my server the symlinks in
/dev/disk/by-* were to /dev/dm-2.<br />
I integrated it in rear workflow to test using the correct devices on
the server and it works.<br />
I have this very ugly diff to show you what I modified (hardcoded value,
but it was just for testing purposes :</p>
<pre><code>@@ -67,9 +67,9 @@
 StopIfError "Could not create loop device on $disk_image"
 AddExitTask "losetup -d $disk_device &gt;&amp;2"

-partprobe "$disk_device" || Error "Could not make the kernel recognize loop device partitions"
-local boot_partition="${disk_device}p1"

+kpartx -a "$disk_device" || Error "Could not make the kernel recognize loop device partitions"
+local boot_partition="/dev/dm-2"

 ### Create and populate the boot file system

@@ -144,6 +144,7 @@

 umount "$boot_partition_root" || Error "Could not unmount boot file system"
 RemoveExitTask "umount $boot_partition_root &gt;&amp;2"
+kpartx -v -d /dev/loop0
 losetup -d "$disk_device" || Error "Could not delete loop device"
 RemoveExitTask "losetup -d $disk_device &gt;&amp;2"
</code></pre>
<p>I don't currently know how to "detect" where the loop device is going
tho.</p>
<p><strong>EDIT :</strong> It would seem that using
<code>lsblk -n --output "KNAME" $disk_device</code> show on the second line where
in /dev the partition is.<br />
Debian 8 :</p>
<pre><code>root@debian8:~# lsblk -n --output "KNAME" /dev/loop0
loop0
loop0p1
</code></pre>
<p>CentOS 6 :</p>
<pre><code>[root@centos6 ~]# lsblk -n --output "KNAME" /dev/loop0
loop0
dm-2
</code></pre>
<p>Ubuntu 16 LTS :</p>
<pre><code>root@ubuntu16:/tmp# lsblk -n --output "KNAME" /dev/loop0
loop0
loop0p1
</code></pre>
<p>I'd have to test on more Linux distros but as <code>lsblk</code> is part of
util-linux it's <em>a priori</em> in every distro.</p>
<h4 id="olivero2_commented_at_2018-07-03_1459"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/issues/1846#issuecomment-402187852">2018-07-03 14:59</a>:<a class="headerlink" href="#olivero2_commented_at_2018-07-03_1459" title="Permanent link">&para;</a></h4>
<p>@GreenBlood Thanks for trying. I think we're at least on the right path
here. Note that my patch uses the <code>-u</code> option of <code>kpartx</code>, not <code>-a</code>.
Unfortunately, kpartx is not well documented so it's trial and error.</p>
<p>Note that the mapping device <code>dm-name-loop0p1</code> you saw is absolutely OK.
<code>kpartx</code> creates device mappings like these but should also create links
for the proper loop device path <code>/dev/loop0p1</code>.</p>
<h2 id="diagnosis">Diagnosis<a class="headerlink" href="#diagnosis" title="Permanent link">&para;</a></h2>
<p>Could you post the relevant section of the rear log when running the
code with my patch? Maybe you could run it again even examine the state
after the kpartx call by inserting</p>
<pre><code>read -p "Press ENTER to continue ... " 0&lt;&amp;6 1&gt;&amp;7 2&gt;&amp;8
</code></pre>
<p>before the comment</p>
<pre><code># If unsuccessful, say so.
</code></pre>
<p>and look for loop devices.</p>
<p>What does <code>kpartx -l</code> say?</p>
<h2 id="alternative_solution_without_losetup">Alternative solution without losetup:<a class="headerlink" href="#alternative_solution_without_losetup" title="Permanent link">&para;</a></h2>
<p>In addition, could you try this?</p>
<ol>
<li>Replace the lines</li>
</ol>
<!-- -->

<pre><code>local disk_device  # separate 'local' statement to avoid losing $(...) exit status - cf. https://stackoverflow.com/a/10397996
disk_device="$(losetup --show --find "$disk_image")"
StopIfError "Could not create loop device on $disk_image"
AddExitTask "losetup -d $disk_device &gt;&amp;2"

local boot_partition="${disk_device}p1"
</code></pre>
<p>with</p>
<pre><code>local kpartx_fields=($(kpartx -asv "$disk_image"))
[[ ${#kpartx_fields[*]} == 6 ]] || Error "kpartx could not create loop device and its partitions (result: $kpartx_fields)"

local disk_device="${kpartx_fields[4]}"
local boot_partition="/dev/${kpartx_fields[0]}"

AddExitTask "kpartx -d $disk_image &gt;&amp;2"

LogPrint "loop device: $disk_device, boot partition: $boot_partition"
</code></pre>
<ol>
<li>Uncomment these lines:</li>
</ol>
<!-- -->

<pre><code>losetup -d "$disk_device" || Error "Could not delete loop device"
RemoveExitTask "losetup -d $disk_device &gt;&amp;2"
</code></pre>
<ol>
<li>Then run rear and post the relevant section of the log.</li>
</ol>
<h4 id="olivero2_commented_at_2018-07-03_1510"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/issues/1846#issuecomment-402191835">2018-07-03 15:10</a>:<a class="headerlink" href="#olivero2_commented_at_2018-07-03_1510" title="Permanent link">&para;</a></h4>
<p>Correction - should be</p>
<pre><code>AddExitTask "kpartx -d $disk_image &gt;&amp;2"
</code></pre>
<p>(not <code>$disk_device</code>)</p>
<h4 id="olivero2_commented_at_2018-07-03_2053"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/issues/1846#issuecomment-402288788">2018-07-03 20:53</a>:<a class="headerlink" href="#olivero2_commented_at_2018-07-03_2053" title="Permanent link">&para;</a></h4>
<p>@GreenBlood</p>
<p><strong>Update:</strong> I have pushed a new commit
26e6eece4b5e9e911784e881c6cf2241b5f0e827 onto my branch
<a href="https://github.com/OliverO2/rear/commits/feature/rawdisk-portability-improvements">https://github.com/OliverO2/rear/commits/feature/rawdisk-portability-improvements</a>.
With that commit I could successfully build a RAWDISK output file on
CentOS 6.</p>
<p>Rear configuration:</p>
<pre><code>OUTPUT=RAWDISK
OUTPUT_URL="file://$VAR_DIR/output"
</code></pre>
<p>Platform configuration:</p>
<ul>
<li>CentOS-6.10-x86_64-minimal.iso</li>
<li>additional packages: <code>gdisk</code>, <code>dosfstools</code></li>
</ul>
<p>Terminal log:</p>
<pre><code>Relax-and-Recover 2.4-git.3028.60985ac.featurerawdiskportabilityimprovements.changed / 2018-07-03
Using log file: /var/log/rear/rear-centos6.log
Creating disk layout
Using guessed bootloader 'GRUB' (found in first bytes on /dev/sda)
Creating root filesystem layout
Copying logfile /var/log/rear/rear-centos6.log into initramfs as '/tmp/rear-centos6-partial-2018-07-03T22:38:09+0200.log'
Copying files and directories
Copying binaries and libraries
Copying kernel modules
Copying all files in /lib*/firmware/
Creating recovery/rescue system initramfs/initrd initrd.cgz with gzip default compression
Created initrd.cgz with gzip default compression (74476711 bytes) in 8 seconds
Creating 83 MiB raw disk image "rear-centos6.raw"
Using syslinux to install a Legacy BIOS bootloader
Copying resulting files to file location
Saving /var/log/rear/rear-centos6.log as rear-centos6.log to file location
Exiting rear mkrescue (PID 2930) and its descendant processes
Running exit tasks
</code></pre>
<h4 id="jsmeix_commented_at_2018-07-09_0929"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1846#issuecomment-403418351">2018-07-09 09:29</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-07-09_0929" title="Permanent link">&para;</a></h4>
<p>@GreenBlood<br />
with
<a href="https://github.com/rear/rear/pull/1850">https://github.com/rear/rear/pull/1850</a>
merged<br />
this issue should be fixed where "fixed" means that now<br />
ReaR tries as far as possible to make the needed partition device nodes
appear<br />
but if they finally won't appear it must error out because it cannot
proceed<br />
without the needed partition device nodes.</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2024 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2018-06-28.1846.issue.closed.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
