<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#2018 PR merged: Improved setup of etc/resolv.conf in the recovery system (issue 2015) - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#2018 PR merged: Improved setup of etc/resolv.conf in the recovery system (issue 2015)";
        var mkdocs_page_input_path = "issues/2019-01-16.2018.pr.merged.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/backup_netfs.html">Example of BACKUP=NETFS</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear28.html">Release Notes ReaR 2.8</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#2018 PR merged: Improved setup of etc/resolv.conf in the recovery system (issue 2015)</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="2018_pr_merged_improved_setup_of_etcresolvconf_in_the_recovery_system_issue_2015"><a href="https://github.com/rear/rear/pull/2018">#2018 PR</a> <code>merged</code>: Improved setup of etc/resolv.conf in the recovery system (issue 2015)<a class="headerlink" href="#2018_pr_merged_improved_setup_of_etcresolvconf_in_the_recovery_system_issue_2015" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>enhancement</code>, <code>fixed / solved / done</code></p>
<h4 id="jsmeix_opened_issue_at_2019-01-16_1548"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> opened issue at <a href="https://github.com/rear/rear/pull/2018">2019-01-16 15:48</a>:<a class="headerlink" href="#jsmeix_opened_issue_at_2019-01-16_1548" title="Permanent link">&para;</a></h4>
<ul>
<li>
<p>Type: <strong>Enhancement</strong></p>
</li>
<li>
<p>Impact: <strong>Low</strong> and <strong>High</strong> on Ubuntu</p>
</li>
<li>
<p>Reference to related issue (URL):<br />
<a href="https://github.com/rear/rear/issues/2015">https://github.com/rear/rear/issues/2015</a></p>
</li>
<li>
<p>How was this pull request tested?<br />
    By me on my openSUSE Leap 15.0 system.<br />
    Testing on Ubuntu systems is needed.</p>
</li>
<li>
<p>Brief description of the changes in this pull request:</p>
</li>
</ul>
<p>Improved validation of etc/resolv.conf in the recovery system and<br />
provide final power to the user for DNS setup if needed via
USE_RESOLV_CONF.</p>
<p>Now it errors out during "rear mkrescue" if the recovery system
etc/resolv.conf<br />
contains no real nameserver (e.g. only loopback addresses 127.*).</p>
<p>On Ubuntu 18.x versions /etc/resol.conf is linked to
/lib/systemd/resolv.conf<br />
where its actual content is only the following single line</p>
<pre><code>nameserver 127.0.0.53
</code></pre>
<p>cf.
<a href="https://github.com/rear/rear/issues/2015#issuecomment-454082087">https://github.com/rear/rear/issues/2015#issuecomment-454082087</a></p>
<p>But a loopback IP address for the DNS nameserver cannot work within<br />
the recovery system because there is no DNS server listening at
127.0.0.53<br />
because systemd-resolved is not running within the recovery system.</p>
<p>Therefore when /etc/resolv.conf in the recovery system contains
nameserver values<br />
it means DNS should be used within the recovery system and then things
cannot work<br />
when only loopback nameservers are specified so that we error out in
this case.</p>
<p>It is o.k. to have an empty /etc/resolv.conf in the recovery system<br />
(perhaps no DNS should be used within the recovery system)<br />
and that can be even enforced via <code>USE_RESOLV_CONF="no"</code>.</p>
<h4 id="jsmeix_commented_at_2019-01-16_1555"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2018#issuecomment-454830889">2019-01-16 15:55</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-01-16_1555" title="Permanent link">&para;</a></h4>
<p>Currently USE_RESOLV_CONF is not yet documented in default.conf.<br />
I will document it if we agree to use USE_RESOLV_CONF.</p>
<h4 id="jsmeix_commented_at_2019-01-17_1638"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2018#issuecomment-455240498">2019-01-17 16:38</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-01-17_1638" title="Permanent link">&para;</a></h4>
<p>I will wait until next Monday for feedback from<br />
<a href="https://github.com/rear/rear/issues/2015#issuecomment-454831893">https://github.com/rear/rear/issues/2015#issuecomment-454831893</a><br />
and if there is none I think I will "just merge" it Monday afternoon.<br />
If issues appear later, we can fix them later.</p>
<h4 id="olivero2_commented_at_2019-03-08_1205"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/pull/2018#issuecomment-470906450">2019-03-08 12:05</a>:<a class="headerlink" href="#olivero2_commented_at_2019-03-08_1205" title="Permanent link">&para;</a></h4>
<p>While testing ReaR a Ubuntu 18.04.2 LTS desktop system which has been
upgraded from 16.04, I have encountered these situations:</p>
<ul>
<li>with ReaR version 2.4, DNS was working correctly on the recovery
    system without any intervention,</li>
<li>with ReaR's current master version, <code>rear -v mkrescue</code> aborted with
    the following message:</li>
</ul>
<!-- -->

<pre><code>ERROR: No nameserver or only loopback addresses in /tmp/rear.RK1T691WDugerN3/rootfs/etc/resolv.conf, specify a real nameserver via USE_RESOLV_CONF
Some latest log messages since the last called script 630_verify_resolv_conf_file.sh:
  2019-03-08 12:49:00.428966084 Including build/GNU/Linux/630_verify_resolv_conf_file.sh
  '/etc/resolv.conf' -&gt; '/tmp/rear.RK1T691WDugerN3/rootfs/etc/resolv.conf'
  2019-03-08 12:49:00.433446296 Useless loopback nameserver '127.0.0.53' in /tmp/rear.RK1T691WDugerN3/rootfs/etc/resolv.conf
</code></pre>
<p>So at least after a Ubuntu upgrade from 16.04 and with my (probably
pretty standard) desktop configuration (nameserver assignment via DHCP),
this PR makes ReaR fail where it did work before.</p>
<p>I'll test everything on a clean Ubuntu 18.04.2 installation, but this
will probably happen in April.</p>
<h4 id="jsmeix_commented_at_2019-03-08_1321"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2018#issuecomment-470926305">2019-03-08 13:21</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-03-08_1321" title="Permanent link">&para;</a></h4>
<p>@OliverO2<br />
your
<a href="https://github.com/rear/rear/pull/2018#issuecomment-470906450">https://github.com/rear/rear/pull/2018#issuecomment-470906450</a><br />
is the intended and expected behaviour in current ReaR master code,
cf.<br />
<a href="https://github.com/rear/rear/issues/2015#issuecomment-456058659">https://github.com/rear/rear/issues/2015#issuecomment-456058659</a><br />
and see the <code>USE_RESOLV_CONF</code> description in default.conf.</p>
<p>The reason is not that ReaR does no longer work, the reason is<br />
that /etc/resolv.conf (or its symlink target) on the original system<br />
is useless to be used in the ReaR recovery system and it is better<br />
to error out during "rear mkbackup/mkrescue" when things cannot work<br />
later during "rear recover", cf. "Try to care about possible errors"
in<br />
<a href="https://github.com/rear/rear/wiki/Coding-Style">https://github.com/rear/rear/wiki/Coding-Style</a></p>
<p>So I did what I could do which is to detect when /etc/resolv.conf<br />
(or its symlink target) on the original system is useless to be used<br />
in the ReaR recovery system and error out early in this case.</p>
<p>I would appreciate an enhancement that makes things work automatically<br />
provided that automatism works reliably and with reasonable effort,
cf.<br />
<a href="https://github.com/rear/rear/issues/2015#issuecomment-454749972">https://github.com/rear/rear/issues/2015#issuecomment-454749972</a></p>
<p>Simply put:<br />
I would be against having much systemd bloatware in the ReaR recovery
system.<br />
I would prefer to keep the recovery system simple and straightforward
(KISS).</p>
<h4 id="jsmeix_commented_at_2019-03-08_1428"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2018#issuecomment-470946842">2019-03-08 14:28</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-03-08_1428" title="Permanent link">&para;</a></h4>
<p>My immediate idea for an automatism that makes name resolution work<br />
in the recovery system when the /etc/resolv.conf content on the
original<br />
system is useless is to "just set the currently used actual
nameservers"<br />
in the /etc/resolv.conf for the recovery system.</p>
<p>Unfortunately some Googling for <code>show currently used nameserver</code><br />
results various different kind of ways how one could do that<br />
depending on what latest greatest networking stuff one uses<br />
which seems to indicate that nowadays there is no such thing<br />
as "the one generically right way" how to do that.</p>
<p>E.g.</p>
<pre><code>dig $( hostname -f ) | grep 'SERVER:' | cut -s -d '(' -f2 | cut -s -d ')' -f1
</code></pre>
<p>may look sufficiently generic on first glance but<br />
<a href="https://unix.stackexchange.com/questions/28941/what-dns-servers-am-i-using">https://unix.stackexchange.com/questions/28941/what-dns-servers-am-i-using</a><br />
tells (excerpts)</p>
<pre><code>dig yourserver.somedomain.xyz
...
Ubuntu 18.04 just shows the local dns cache:
SERVER: 127.0.0.53#53(127.0.0.53)
</code></pre>
<p>so we are back at square one...</p>
<h4 id="schlomo_commented_at_2019-03-08_1516"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/2018#issuecomment-470963117">2019-03-08 15:16</a>:<a class="headerlink" href="#schlomo_commented_at_2019-03-08_1516" title="Permanent link">&para;</a></h4>
<p>@jsmeix I think your wish to keep systemd "pollution" out of the ReaR
rescue system is not realistic. What about <code>udev</code>? This is now a systemd
service. Also PID 1 is provided by systemd.</p>
<p>I would suggest another strategy: Embrace systemd and faithfully
replicate the source system as it was. I think <code>systemd-resolved</code> is a
huge improvement over the previously widespread use of dnsmasq or other
local DNS servers.
<a href="https://www.freedesktop.org/software/systemd/man/systemd-resolved.service.html">systemd-resolved(8)</a>
nicely explains the reasons for preferring it. One which I like most is
that it finally ensures that there won't be a discrepancy between
programs querying DNS directly and those using NSS functions (back in
the day I used this problem to test young admins for their Linux
networking skills).</p>
<p>While thinking about this topic I realized that so far we only ship a
standard <code>nsswitch.conf</code> via SKEL and don't ever look at the real
<code>/etc/nsswitch.conf</code> of the system. I think that this is not correct any
more and that we should fix that and correctly process that file as
well. It will lead us to properly support the future development of
Linux with systemd.</p>
<p>Regarding this PR, I think that the possibility to manually set the DNS
configuration via ReaR config is nice, with a few adjustments:</p>
<ul>
<li>ReaR config is shell script so there is no problem to have a multi
    line string, e.g. via a <code>&lt;&lt;EOF</code> style definition instead of an array
    of configuration file lines.</li>
<li>Users must also be able to set the NSS configuration accordingly as
    using/configuring <code>resolv.conf</code> has a dependency to <code>nsswitch.conf</code></li>
</ul>
<p>I think actually that it would be easier for users if instead of the
current implementation they could set the DNS servers and DNS search
list via variables and not have to think about lines of the
<code>resolv.conf</code> configuration file. That way we could also configure
<code>nsswitch.conf</code> correctly if DNS is set manually and otherwise leave it
as it was on the source system.</p>
<p>And finally, the "best" way to get the DNS servers on a systemd system
is either asking it via <code>networkctl status</code> or looking at
<code>/run/systemd/resolve/resolv.conf</code>. But beware of systems that use
NetworkManager, like my Ubuntu 18.04 desktop. There only the generated
<code>resolv.conf</code> showed true results.</p>
<h4 id="olivero2_commented_at_2019-03-08_1521"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/pull/2018#issuecomment-470964893">2019-03-08 15:21</a>:<a class="headerlink" href="#olivero2_commented_at_2019-03-08_1521" title="Permanent link">&para;</a></h4>
<p>@jsmeix
<a href="https://github.com/rear/rear/pull/2018#issuecomment-470926305">https://github.com/rear/rear/pull/2018#issuecomment-470926305</a></p>
<blockquote>
<p>it is better to error out during "rear mkbackup/mkrescue" when things
cannot work<br />
later during "rear recover"</p>
</blockquote>
<p>While I agree with that strategy, what I have observed so far is that
ReaR actually <strong>worked</strong> with that seemingly useless <code>/etc/resolv.conf</code>
(in conjunction with whatever other files it copied). So in my case, the
assumption that recovery would fail does not hold true. Maybe we need
some more analysis before implementing a viable solution here.</p>
<h4 id="schlomo_commented_at_2019-03-08_1522"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/2018#issuecomment-470965458">2019-03-08 15:22</a>:<a class="headerlink" href="#schlomo_commented_at_2019-03-08_1522" title="Permanent link">&para;</a></h4>
<p>@OliverO2 I would guess that you used DHCP in the recovery system and
that some DHCP script actually wrote your <code>/etc/resolv.conf</code></p>
<h4 id="olivero2_commented_at_2019-03-08_1532"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/pull/2018#issuecomment-470968951">2019-03-08 15:32</a>:<a class="headerlink" href="#olivero2_commented_at_2019-03-08_1532" title="Permanent link">&para;</a></h4>
<p>@schlomo Right on the spot. '/etc/resolv.conf' reads:</p>
<pre><code>; generated by /bin/dhclient-script
search &lt;internal domain name here&gt;
nameserver &lt;internal dns ipv4 address here&gt;
</code></pre>
<h4 id="jsmeix_commented_at_2019-03-08_1541"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2018#issuecomment-470972084">2019-03-08 15:41</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-03-08_1541" title="Permanent link">&para;</a></h4>
<p>@schlomo<br />
I did what I could do with what I have on my systems, cf.<br />
<a href="https://github.com/rear/rear/issues/2015#issuecomment-453981364">https://github.com/rear/rear/issues/2015#issuecomment-453981364</a><br />
and<br />
<a href="https://github.com/rear/rear/issues/2015#issuecomment-454313695">https://github.com/rear/rear/issues/2015#issuecomment-454313695</a><br />
so that further enhancements in this area would need to be<br />
provided to ReaR by people who use that other ways<br />
of name resolution via new separated pull requests.</p>
<p>@OliverO2<br />
if you cannot avoid that "rear mkrescue" errors out for you<br />
with a <code>USE_RESOLV_CONF</code> setting in your local.conf<br />
then I would have to fix my <code>USE_RESOLV_CONF</code> stuff.</p>
<p>I cannot reproduce your particular case because<br />
I do not use your particular system here at work<br />
(and at home I do not use ReaR) but I guess one of</p>
<pre><code>USE_RESOLV_CONF="no"
USE_RESOLV_CONF="# dummy"
</code></pre>
<p>should avoid that "rear mkrescue" errors out.</p>
<p>Use <code>KEEP_BUILD_DIR="yes"</code> so that you can directly inspect<br />
the recovery system content in <code>$TMPDIR/rear.XXX/rootfs/</code><br />
in particular the <code>$TMPDIR/rear.XXX/rootfs/etc/resolv.conf</code></p>
<h4 id="olivero2_commented_at_2019-03-08_1547"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/pull/2018#issuecomment-470974047">2019-03-08 15:47</a>:<a class="headerlink" href="#olivero2_commented_at_2019-03-08_1547" title="Permanent link">&para;</a></h4>
<p>@jsmeix No problem for me here, I can easily avoid the situation. My
concern is that given a configuration like mine, ReaR would cease to
work out of the box for others.</p>
<h4 id="schlomo_commented_at_2019-03-08_1549"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/2018#issuecomment-470975001">2019-03-08 15:49</a>:<a class="headerlink" href="#schlomo_commented_at_2019-03-08_1549" title="Permanent link">&para;</a></h4>
<p>@jsmeix maybe you can adjust the default value of the new variable in a
way that avoids breaking upgrades?</p>
<h4 id="jsmeix_commented_at_2019-03-08_1619"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2018#issuecomment-470986165">2019-03-08 16:19</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-03-08_1619" title="Permanent link">&para;</a></h4>
<p>@OliverO2<br />
ReaR pretends much too often that it "just works out of the box"<br />
by "just blindly proceeding" in case of possible errors, cf.<br />
<code>Try to care about possible errors</code> in<br />
<a href="https://github.com/rear/rear/wiki/Coding-Style">https://github.com/rear/rear/wiki/Coding-Style</a></p>
<p>Then sometimes the user finds out the hard way<br />
when it is too late (i.e. by failures during "rear recover")<br />
that actually it does not work out of the box.</p>
<p>In particular
<a href="https://github.com/rear/rear/issues/2015">https://github.com/rear/rear/issues/2015</a><br />
describes a (repairable) failure for "rear recover"</p>
<pre><code>When the rescue media is created this fails to resolve DNS
and therefore also fails to resolve hostnames for remote backups
</code></pre>
<p>but it is still a major annoyance when the first "rear recover" run
fails and<br />
one must (in case of emergency and time pressure) analyze what is
wrong<br />
and what must be done in the running recovery system to repair it.</p>
<p>Therefore I am adding verification steps during "rear mkrescue"<br />
and of course that will sometimes error out with "false alarm",<br />
cf.
<a href="https://github.com/rear/rear/pull/2060#issuecomment-469705996">https://github.com/rear/rear/pull/2060#issuecomment-469705996</a></p>
<p>But a "false alarm" during "rear mkrescue" can be easily fixed<br />
when you have time for it and when you can do it step by step<br />
in a 'relaxed' way.</p>
<p>In contrast a failure during "rear recover" is often a dead end, cf.</p>
<pre><code>A note on the meaning of 'Relax' in 'Relax-and-Recover'
</code></pre>
<p>in
<a href="https://en.opensuse.org/SDB:Disaster_Recovery">https://en.opensuse.org/SDB:Disaster_Recovery</a></p>
<p>Very very seriously:<br />
I prefer SLES customer bug reports about issues during "rear mkrescue"<br />
very much over customer bug reports about failures during "rear
recover",<br />
cf. <code>Help and Support</code> in<br />
<a href="https://en.opensuse.org/SDB:Disaster_Recovery">https://en.opensuse.org/SDB:Disaster_Recovery</a><br />
I get every issue about ReaR in SLES so I do care about that most of
all.</p>
<h4 id="olivero2_commented_at_2019-03-09_1136"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/pull/2018#issuecomment-471169618">2019-03-09 11:36</a>:<a class="headerlink" href="#olivero2_commented_at_2019-03-09_1136" title="Permanent link">&para;</a></h4>
<p>@jsmeix I understand your motivation that you want your support
inquiries come in at the earliest possible time and not under pressure.
This always makes sense. I'm just wondering about the gains in this
particular case: When there's a non-working DNS on the recovery system,
could those users have tested their recovery process at all?</p>
<h4 id="jsmeix_commented_at_2019-03-11_1037"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2018#issuecomment-471487864">2019-03-11 10:37</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-03-11_1037" title="Permanent link">&para;</a></h4>
<p>@OliverO2 regarding<br />
<a href="https://github.com/rear/rear/pull/2018#issuecomment-470968951">https://github.com/rear/rear/pull/2018#issuecomment-470968951</a><br />
I assume you have in your etc/rear/local.conf <code>USE_DHCLIENT="yes"</code><br />
but you do not also have <code>USE_STATIC_NETWORKING="yes"</code></p>
<p>With
<a href="https://github.com/rear/rear/pull/2076">https://github.com/rear/rear/pull/2076</a><br />
build/GNU/Linux/630_verify_resolv_conf_file.sh<br />
does no longer error out<br />
when etc/resolv.conf has no nameserver or only loopback addresses<br />
and USE_DHCLIENT has a true value<br />
(and USE_STATIC_NETWORKING does not have a true value)<br />
because then etc/resolv.conf in the recovery system<br />
is generated anew by /bin/dhclient-script<br />
so that its content before does not matter.</p>
<h4 id="jsmeix_commented_at_2019-03-11_1059"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2018#issuecomment-471494613">2019-03-11 10:59</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-03-11_1059" title="Permanent link">&para;</a></h4>
<p>@OliverO2 regarding your<br />
<a href="https://github.com/rear/rear/pull/2018#issuecomment-471169618">https://github.com/rear/rear/pull/2018#issuecomment-471169618</a></p>
<p>In my reasoning it does not really matter whether or not<br />
users have tested their recovery process at all.</p>
<p>For the good users who test their recovery process<br />
it is easier for them to see the root cause where things start to go
wrong<br />
when ReaR errors out early with a clear error messsage<br />
so that it helps them to get faster a recovery process that really
works.</p>
<p>I think a good recent example is<br />
<a href="https://github.com/rear/rear/issues/2006">https://github.com/rear/rear/issues/2006</a><br />
where things failed late at "rear recover" and we needed<br />
a long time to find out what goes wrong (sometimes)<br />
which was the final reason for me to do<br />
<a href="https://github.com/rear/rear/pull/2060">https://github.com/rear/rear/pull/2060</a></p>
<p>Also there were those weird <code>More than 128 partitions is not supported</code>
issues<br />
where the root cause was some brokenness related to disklayout.conf
where<br />
"rear recover" blindly proceeded until it got lost in
get_partition_number()<br />
with its error message that is totally useless at that (much too late)
point.</p>
<p>For the bad users who do not test their recovery process<br />
it is easier for us when ReaR errors out early for them<br />
because this avoids that we get weird issues from those users<br />
when "rear recover" fails which are much harder to deal with<br />
compared to issues when ReaR errors out early during<br />
"rear mkbackup/mkrescue" with a clear error messsage<br />
(just <code>RTEM</code> "Read The Error Message" ;-)</p>
<h4 id="olivero2_commented_at_2019-03-11_1118"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/pull/2018#issuecomment-471499805">2019-03-11 11:18</a>:<a class="headerlink" href="#olivero2_commented_at_2019-03-11_1118" title="Permanent link">&para;</a></h4>
<p>@jsmeix
<a href="https://github.com/rear/rear/pull/2018#issuecomment-471487864">https://github.com/rear/rear/pull/2018#issuecomment-471487864</a></p>
<blockquote>
<p>I assume you have in your etc/rear/local.conf USE_DHCLIENT="yes"<br />
but you do not also have USE_STATIC_NETWORKING="yes"</p>
</blockquote>
<p>Actually, before this issue came up, I had no network-related settings
in the local configuration at all (just backup- and output-related
stuff).</p>
<p>I have only had a cursory look at the issue, but to me it looks like
this:</p>
<ul>
<li>Ubuntu 18.04 uses <code>systemd-resolved</code> to manage DNS resolution,
    supporting dynamic networking changes induced, for example, by WiFi
    roaming.</li>
<li>For backward compatibility,
    <a href="http://manpages.ubuntu.com/manpages/bionic/en/man8/systemd-resolved.8.html">systemd-resolved(8)</a>
    listens on <code>127.0.0.53</code> and directs old clients there via static
    content in <code>/etc/resolv.conf</code> (so it is neither broken nor useless).</li>
<li>It seems like ReaR does not copy the complete networking software
    required in this case (which would include a correctly configured
    <code>systemd-resolved</code>). Nonetheless, in this case the old scripts seem
    to kick in, updating <code>/etc/resolv.conf</code> as shown above.</li>
<li>For ReaR, it doesn't really seem to matter whether DNS is configured
    via netplan or something else as netplan is just a front-end and
    will update the necessary backend configuration files (in this case,
    <a href="http://manpages.ubuntu.com/manpages/bionic/man5/systemd.network.5.html">systemd.network(5)</a>).</li>
</ul>
<p>So this is just my idea of how things interact currently.</p>
<h4 id="jsmeix_commented_at_2019-03-11_1249"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2018#issuecomment-471525554">2019-03-11 12:49</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-03-11_1249" title="Permanent link">&para;</a></h4>
<p>@OliverO2<br />
your idea of how things interact currently is right and that is<br />
basically described at USE_RESOLV_CONF in default.conf.</p>
<p>I never said /etc/resolv.conf is broken or useless on the original
system.</p>
<p>I said when in the recovery system etc/resolv.conf has no nameserver
entry<br />
or when it contains only loopback addresses as nameservers,<br />
then such a etc/resolv.conf is useless in the recovery system<br />
because we do not have support for systemd-resolved.</p>
<p>The current test in<br />
build/GNU/Linux/630_verify_resolv_conf_file.sh<br />
matches this state - as far as currently known to me.</p>
<p>When things worked for you with a /etc/resolv.conf on the original
system<br />
that is useless in the recovery system even without
<code>USE_DHCLIENT="yes"</code><br />
it seems - for my current point of view - things had worked for you by
luck.</p>
<p>If you can show me that I am wong and how things had worked for you<br />
by intention by this or that ReaR scripts, I will further enhance my
test in<br />
build/GNU/Linux/630_verify_resolv_conf_file.sh<br />
to better match the current state in ReaR (i.e. do no longer error out<br />
when things are made working by intention).</p>
<p>Above in<br />
<a href="https://github.com/rear/rear/pull/2018#issuecomment-470972084">https://github.com/rear/rear/pull/2018#issuecomment-470972084</a><br />
I had written that further enhancements regarding systemd-resolved<br />
would need to be provided to ReaR by people who use it<br />
via separated pull requests.</p>
<p>It seems @schlomo also uses systemd-resolved and according to his<br />
<a href="https://github.com/rear/rear/pull/2018#issuecomment-470963117">https://github.com/rear/rear/pull/2018#issuecomment-470963117</a><br />
he likes to have support in ReaR for systemd-resolved<br />
so that I look forward to a pull request.</p>
<h4 id="jsmeix_commented_at_2019-03-11_1525"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2018#issuecomment-471585924">2019-03-11 15:25</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-03-11_1525" title="Permanent link">&para;</a></h4>
<p>With
<a href="https://github.com/rear/rear/pull/2076">https://github.com/rear/rear/pull/2076</a>
merged<br />
build/GNU/Linux/630_verify_resolv_conf_file.sh does no longer error
out<br />
when etc/resolv.conf has no nameserver or only loopback addresses<br />
and USE_DHCLIENT is true (and USE_STATIC_NETWORKING is not true)<br />
because then etc/resolv.conf in the recovery system is generated anew<br />
by /bin/dhclient-script so that its content before does not matter.</p>
<p>This way it should in particular no longer falsely error out on
systems<br />
that use systemd-resolved (like Ubuntu 18.04) and do their networking<br />
setup via DHCP (probably pretty standard on usual desktop systems),<br />
cf.
<a href="https://github.com/rear/rear/pull/2018#issuecomment-470906450">https://github.com/rear/rear/pull/2018#issuecomment-470906450</a></p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2024 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2019-01-16.2018.pr.merged.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/rear/rear-user-guide" class="fa fa-code-fork" style="color: #fcfcfc"> rear/rear-user-guide</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
