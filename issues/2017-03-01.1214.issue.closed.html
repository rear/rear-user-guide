<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#1214 Issue closed: Add support for Arch Linux systemd-boot f.k.a. gummiboot (UEFI boot) - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#1214 Issue closed: Add support for Arch Linux systemd-boot f.k.a. gummiboot (UEFI boot)";
        var mkdocs_page_input_path = "issues/2017-03-01.1214.issue.closed.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/backup_netfs.html">Example of BACKUP=NETFS</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/netfs_nas.html">Internal Backup with tar to NFS server</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/netfs_rsync.html">Internal Backup with rsync to NFS server</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/rsync.html">Internal Backup using BACKUP=RSYNC method</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/rbme.html">External Backup using RBME</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/restic.html">External Backup using restic</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../development/squash-git-log-commments.html">How to squash git log comments into one line</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear29.html">Release Notes ReaR 2.9</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear28.html">Release Notes ReaR 2.8</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#1214 Issue closed: Add support for Arch Linux systemd-boot f.k.a. gummiboot (UEFI boot)</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="1214_issue_closed_add_support_for_arch_linux_systemd-boot_fka_gummiboot_uefi_boot"><a href="https://github.com/rear/rear/issues/1214">#1214 Issue</a> <code>closed</code>: Add support for Arch Linux systemd-boot f.k.a. gummiboot (UEFI boot)<a class="headerlink" href="#1214_issue_closed_add_support_for_arch_linux_systemd-boot_fka_gummiboot_uefi_boot" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>enhancement</code>, <code>discuss / RFC</code></p>
<h4 id="probackup-nl_opened_issue_at_2017-03-01_1810"><img src="https://avatars.githubusercontent.com/u/515451?u=4f985fa15d087babc5049c337be90b42b56c8b8b&v=4" width="50"><a href="https://github.com/ProBackup-nl">ProBackup-nl</a> opened issue at <a href="https://github.com/rear/rear/issues/1214">2017-03-01 18:10</a>:<a class="headerlink" href="#probackup-nl_opened_issue_at_2017-03-01_1810" title="Permanent link">&para;</a></h4>
<p><a href="https://www.freedesktop.org/wiki/Software/systemd/systemd-boot/">systemd-boot</a>
(f.k.a. <a href="https://en.wikipedia.org/wiki/Gummiboot_(software)">gummiboot</a>)
is a simple UEFI boot manager which executes configured EFI images.
<a href="https://www.freedesktop.org/wiki/Software/systemd/systemd-boot/">systemd-boot</a>
is included with the systemd, which is installed on an <strong>Arch Linux</strong>
system by default.</p>
<p>Change in Relax-and-Recover:</p>
<ul>
<li>remove Syslinux dependency at
    <a href="https://github.com/rear/rear/blob/master/usr/share/rear/prep/USB/Linux-i386/340_find_mbr_bin.sh#L22">/usr/share/rear/prep/USB/Linux-i386/340_find_mbr_bin.sh:22</a></li>
</ul>
<p>Detection on x86-64 systems:</p>
<ul>
<li>file exists: <code>/boot/loader/loader.conf</code> (optional, systemd-boot can
    even boot without this file)</li>
<li>file exists: <code>/boot/EFI/systemd/systemd-bootx64.efi</code></li>
<li>file exists: <code>/boot/EFI/Boot/BOOTX64.EFI</code></li>
<li>at least 1 file matching <code>/boot/loader/entries/*.conf</code></li>
<li><code>/boot/EFI/systemd/systemd-bootx64.efi</code> is identical to
    <code>/boot/EFI/Boot/BOOTX64.EFI</code> (md5sum)</li>
</ul>
<p>Mkrescue command needs to copy at least these files to the new recovery
partition to reach a recovery prompt:</p>
<ul>
<li><code>/boot/initramfs-linux.img</code></li>
<li><code>/boot/intel-ucode.img</code></li>
<li><code>/boot/vmlinuz-linux</code></li>
</ul>
<p>Optional copy:</p>
<ul>
<li><code>/boot/initramfs-linux-fallback.img</code></li>
</ul>
<p>For each recovery menu line create a corresponding .conf file at
<em>recoveryESP</em>/loader/entries/.</p>
<p>Create <em>recoveryESP</em>/loader/loader.conf file, with contents like:</p>
<ul>
<li><code>timeout 999999</code> (0 will not show a menu)</li>
<li><code>editor   1</code></li>
</ul>
<h4 id="probackup-nl_commented_at_2017-03-01_2132"><img src="https://avatars.githubusercontent.com/u/515451?u=4f985fa15d087babc5049c337be90b42b56c8b8b&v=4" width="50"><a href="https://github.com/ProBackup-nl">ProBackup-nl</a> commented at <a href="https://github.com/rear/rear/issues/1214#issuecomment-283477094">2017-03-01 21:32</a>:<a class="headerlink" href="#probackup-nl_commented_at_2017-03-01_2132" title="Permanent link">&para;</a></h4>
<p>@gozora Some hints on whether this "feature request" fits
Relax-and-Recover, and how/where to plug this in, are welcome. I would
guess next to Lilo and Grub.</p>
<h4 id="jsmeix_commented_at_2017-03-02_0842"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1214#issuecomment-283591754">2017-03-02 08:42</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-03-02_0842" title="Permanent link">&para;</a></h4>
<p>@ProBackup-nl<br />
what is the reason behind why ReaR should also support<br />
systemd-boot/gummiboot?</p>
<p>Is it that systemd-boot/gummiboot is used as bootloader<br />
on the original system and during "rear recover" ReaR<br />
must reinstall the systemd-boot/gummiboot bootloader<br />
in the recreated system (i.e. via chroot into /mnt/local/)?</p>
<p>Or is it that systemd-boot/gummiboot should be used as<br />
bootloader of ReaR's own recovery system?</p>
<p>In the latter case I wonder why ReaR should support<br />
two bootloaders for its own recovery system because<br />
that would mean we need someone who implements it<br />
and then - even more important - who continuously<br />
maintains this functionality (i.e. updates and bugfixes).<br />
Would you @ProBackup-nl do that?</p>
<p>From my point of view the only reason why to use another<br />
bootloader for ReaR's own recovery system would be<br />
when the current syslinux is actually insufficient.</p>
<p>Furthermore in general regarding what to use as future<br />
bootloader for ReaR's own recovery system see also<br />
<a href="https://github.com/rear/rear/issues/764">https://github.com/rear/rear/issues/764</a></p>
<h4 id="probackup-nl_commented_at_2017-03-04_0041"><img src="https://avatars.githubusercontent.com/u/515451?u=4f985fa15d087babc5049c337be90b42b56c8b8b&v=4" width="50"><a href="https://github.com/ProBackup-nl">ProBackup-nl</a> commented at <a href="https://github.com/rear/rear/issues/1214#issuecomment-284109567">2017-03-04 00:41</a>:<a class="headerlink" href="#probackup-nl_commented_at_2017-03-04_0041" title="Permanent link">&para;</a></h4>
<p>@jsmeix<br />
The latter is my request: systemd-boot/gummiboot should be used as
bootloader of ReaR's own recovery system.</p>
<p>When ReaR would support systemd-boot/gummiboot then no extra 4.61 MiB of
syslinux-6.03-6 software installation is needed for Arch Linux systems,
because <a href="https://wiki.archlinux.org/index.php/Systemd-boot">a default Arch Linux installation already contains
systemd-boot</a>.</p>
<h4 id="schlomo_commented_at_2017-03-06_1037"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/issues/1214#issuecomment-284360484">2017-03-06 10:37</a>:<a class="headerlink" href="#schlomo_commented_at_2017-03-06_1037" title="Permanent link">&para;</a></h4>
<p>@ProBackup-nl so what about non-UEFI systems? I think your suggestion is
worth following after we get rid of supporting BIOS booting.</p>
<p>OTOH I think that we also should consider GRUB as the "universal" boot
loader for the ReaR rescue system as it probably supports most if not
all of our platforms.</p>
<p>With regard to detection, IMHO the only way to go is to check the output
of <code>efibootmgr</code> and follow the breadcrumb trail from there:</p>
<pre><code>$ sudo efibootmgr -v
BootCurrent: 0000
Timeout: 5 seconds
BootOrder: 0000
Boot0000* ubuntu    HD(1,GPT,ef2a7e35-5378-4d76-8d7c-024c8f67de08,0x800,0x100000)/File(\EFI\ubuntu\shimx64.efi)
</code></pre>
<p>Once you do that you will know for sure how this system was booted.
Everything else is just blind guessing. That it IMHO actually a big
advantage of UEFI in general, that we can actually ask the UEFI BIOS
about how it boots the computer.</p>
<p>While I wholeheartedly support the beauty of systemd and its holistic
approach to Linux, ReaR must keep supporting older systems. Therefore we
either split the relevant code paths in ReaR into a legacy and a systemd
path or we stick with the legacy stuff till nobody needs it any more.</p>
<p>If your goal is reducing the size of the rescue system then firmware is
indeed a good start, if you are willing to compromise on hardware
support during recovery. Otherwise please note that most backup software
adds 50-300MB to the rescue image size when included. And that is still
the primary use case for ReaR: Supplementing backup software with true
bare metal disaster recovery. Optimizing the rescue image size for the
included backup methods (tar, rsync ...) will therefore only help a part
of our users and even that depends on the other things that they choose
to include.</p>
<h4 id="probackup-nl_commented_at_2017-03-06_1126"><img src="https://avatars.githubusercontent.com/u/515451?u=4f985fa15d087babc5049c337be90b42b56c8b8b&v=4" width="50"><a href="https://github.com/ProBackup-nl">ProBackup-nl</a> commented at <a href="https://github.com/rear/rear/issues/1214#issuecomment-284371153">2017-03-06 11:26</a>:<a class="headerlink" href="#probackup-nl_commented_at_2017-03-06_1126" title="Permanent link">&para;</a></h4>
<p>@schlomo Regarding "non-UEFI systems"? They will still use the
mechanisms that are currently in ReaR.</p>
<p>There are even more UEFI booted situations:</p>
<pre><code># efibootmgr -v
No BootOrder is set; firmware will attempt recovery
</code></pre>
<p>With my little knowledge of ReaR I would start inserting code into
<a href="https://github.com/rear/rear/blob/2c12a52b3322f833c81cae2a8bc5baa799c3187d/usr/share/rear/prep/USB/Linux-i386/340_find_mbr_bin.sh">rear/usr/share/rear/prep/USB/Linux-i386/340_find_mbr_bin.sh</a>.</p>
<p>For the suggestion to split the relevant code paths in ReaR into a
legacy and a systemd path, at which file would you start the split?</p>
<p>Not including <code>rsync</code> is a bad example to reduce space for someone that
is willing to use RBME. I hope that RBME will not add 300MB :-)</p>
<h4 id="gozora_commented_at_2017-03-06_1132"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/1214#issuecomment-284372223">2017-03-06 11:32</a>:<a class="headerlink" href="#gozora_commented_at_2017-03-06_1132" title="Permanent link">&para;</a></h4>
<p>Hello @schlomo</p>
<blockquote>
<p>OTOH I think that we also should consider GRUB as the "universal" boot
loader for the ReaR rescue system as it probably supports most if not
all of our platforms.</p>
</blockquote>
<p>I can say that e.g. SLES11 SP4 uses elilo once installed on UEFI.</p>
<p>V.</p>
<h4 id="gozora_commented_at_2017-03-06_1133"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/1214#issuecomment-284372558">2017-03-06 11:33</a>:<a class="headerlink" href="#gozora_commented_at_2017-03-06_1133" title="Permanent link">&para;</a></h4>
<p>@ProBackup-nl careful with UEFI boot, doesn't matter how simple it might
look, it is very easy to break!</p>
<p>V.</p>
<h4 id="probackup-nl_commented_at_2017-03-09_0017"><img src="https://avatars.githubusercontent.com/u/515451?u=4f985fa15d087babc5049c337be90b42b56c8b8b&v=4" width="50"><a href="https://github.com/ProBackup-nl">ProBackup-nl</a> commented at <a href="https://github.com/rear/rear/issues/1214#issuecomment-285213421">2017-03-09 00:17</a>:<a class="headerlink" href="#probackup-nl_commented_at_2017-03-09_0017" title="Permanent link">&para;</a></h4>
<blockquote>
<p>it is very easy to break</p>
</blockquote>
<p>An example: having set the EFI boot menu using <code>efibootmgr</code>, after the
first reboot the EFI boot menu can be completely vanished:</p>
<pre><code># efibootmgr -v
No BootOrder is set; firmware will attempt recovery
</code></pre>
<h4 id="probackup-nl_commented_at_2017-03-09_1611"><img src="https://avatars.githubusercontent.com/u/515451?u=4f985fa15d087babc5049c337be90b42b56c8b8b&v=4" width="50"><a href="https://github.com/ProBackup-nl">ProBackup-nl</a> commented at <a href="https://github.com/rear/rear/issues/1214#issuecomment-285396934">2017-03-09 16:11</a>:<a class="headerlink" href="#probackup-nl_commented_at_2017-03-09_1611" title="Permanent link">&para;</a></h4>
<p>I will also add some minor improvements, including labelling the GPT
partitions so <code>parted ... print</code>will show partitions with information
that gives more clues what the purpose of each partition is:</p>
<pre><code>Number  Start    End       Size      File system  Name      Flags
 1      4.00MiB  100MiB    96.0MiB   fat16        EFIBOOT   boot, esp
 2      100MiB   14906MiB  14806MiB  ext2         REARDATA
</code></pre>
<p>Instead of:</p>
<pre><code>Number  Start    End       Size      File system  Name  Flags
 1      4.00MiB  100MiB    96.0MiB   fat16              legacy_boot
 2      100MiB   14906MiB  14806MiB  ext2
</code></pre>
<h4 id="probackup-nl_commented_at_2017-03-09_2151"><img src="https://avatars.githubusercontent.com/u/515451?u=4f985fa15d087babc5049c337be90b42b56c8b8b&v=4" width="50"><a href="https://github.com/ProBackup-nl">ProBackup-nl</a> commented at <a href="https://github.com/rear/rear/issues/1214#issuecomment-285494879">2017-03-09 21:51</a>:<a class="headerlink" href="#probackup-nl_commented_at_2017-03-09_2151" title="Permanent link">&para;</a></h4>
<p>Also add <del>EFISTUB</del> <ins>systemd-boot</ins> support to
bootloader detection. For instance at
<a href="https://github.com/rear/rear/blob/2c12a52b3322f833c81cae2a8bc5baa799c3187d/usr/share/rear/prep/default/500_guess_bootloader.sh">rear/usr/share/rear/prep/default/500_guess_bootloader.sh</a>:</p>
<pre><code>echo "SYSTEMD-BOOT" &gt;$VAR_DIR/recovery/bootloader
</code></pre>
<h4 id="probackup-nl_commented_at_2017-03-10_0116"><img src="https://avatars.githubusercontent.com/u/515451?u=4f985fa15d087babc5049c337be90b42b56c8b8b&v=4" width="50"><a href="https://github.com/ProBackup-nl">ProBackup-nl</a> commented at <a href="https://github.com/rear/rear/issues/1214#issuecomment-285543406">2017-03-10 01:16</a>:<a class="headerlink" href="#probackup-nl_commented_at_2017-03-10_0116" title="Permanent link">&para;</a></h4>
<p>Status: boot menu is OK when booting from ReaR rescue USB device; Kernel
panic - Unable to mount root fs on unknown-block(0,0)
<code>initramfs unpacking failed: junk in compressed archive</code>; I need to
check whether a RAM based root fs will improve.</p>
<h4 id="probackup-nl_commented_at_2017-03-10_2220"><img src="https://avatars.githubusercontent.com/u/515451?u=4f985fa15d087babc5049c337be90b42b56c8b8b&v=4" width="50"><a href="https://github.com/ProBackup-nl">ProBackup-nl</a> commented at <a href="https://github.com/rear/rear/issues/1214#issuecomment-285800914">2017-03-10 22:20</a>:<a class="headerlink" href="#probackup-nl_commented_at_2017-03-10_2220" title="Permanent link">&para;</a></h4>
<p>Still stuck at the kernel panic. The current Arch Linux kernel is build
like:</p>
<pre><code>CONFIG_BLK_DEV_RAM=m
CONFIG_BLK_DEV_RAM_COUNT=16 #number
CONFIG_BLK_DEV_RAM_SIZE=16384 #size in kb
</code></pre>
<p>Where <code>CONFIG_BLK_DEV_RAM=m</code> makes the RAM drive a module. Though I yet
can't find which file name the module carries. What are the chances that
<code>CONFIG_BLK_DEV_RAM=m</code> makes<br />
it impossible to pass an <code>initrd</code> image since <code>populate_rootfs()</code> in
<code>init/initramfs.c</code> omits<br />
code for checking whether the image is an initrd or not?</p>
<h4 id="probackup-nl_commented_at_2017-03-10_2246"><img src="https://avatars.githubusercontent.com/u/515451?u=4f985fa15d087babc5049c337be90b42b56c8b8b&v=4" width="50"><a href="https://github.com/ProBackup-nl">ProBackup-nl</a> commented at <a href="https://github.com/rear/rear/issues/1214#issuecomment-285806037">2017-03-10 22:46</a>:<a class="headerlink" href="#probackup-nl_commented_at_2017-03-10_2246" title="Permanent link">&para;</a></h4>
<h2 id="initramfs_unpacking_failed_junk_in_compressed_archive">initramfs unpacking failed: junk in compressed archive<a class="headerlink" href="#initramfs_unpacking_failed_junk_in_compressed_archive" title="Permanent link">&para;</a></h2>
<p>This error is caused by the the lz4 initramfs compression I added in
#1218. When switching back to "<strong>fast</strong>" initramfs compression, the
systemd-boot (menu) boot to Relax-and-Recover 2.00 / Git succeeds.</p>
<p>Thanks go to:
<a href="https://bbs.archlinux.org/viewtopic.php?id=137961">https://bbs.archlinux.org/viewtopic.php?id=137961</a></p>
<h4 id="probackup-nl_commented_at_2017-03-11_1119"><img src="https://avatars.githubusercontent.com/u/515451?u=4f985fa15d087babc5049c337be90b42b56c8b8b&v=4" width="50"><a href="https://github.com/ProBackup-nl">ProBackup-nl</a> commented at <a href="https://github.com/rear/rear/issues/1214#issuecomment-285860610">2017-03-11 11:19</a>:<a class="headerlink" href="#probackup-nl_commented_at_2017-03-11_1119" title="Permanent link">&para;</a></h4>
<h1 id="efistub_boot_loader">EFISTUB boot loader<a class="headerlink" href="#efistub_boot_loader" title="Permanent link">&para;</a></h1>
<p>Now systemd-boot boot loader is implemented at
<a href="https://github.com/rear/rear/blob/c4754a35dc70fae8ad913f991ff8ea0051fefbf5/usr/share/rear/output/USB/Linux-i386/100_create_efiboot.sh">100_create_efiboot</a>
it is time to work on the EFISTUB boot loader using the UEFI boot menu.
That is the boot loader menu that is integrated into the UEFI firmware.</p>
<h4 id="probackup-nl_commented_at_2017-03-11_1956"><img src="https://avatars.githubusercontent.com/u/515451?u=4f985fa15d087babc5049c337be90b42b56c8b8b&v=4" width="50"><a href="https://github.com/ProBackup-nl">ProBackup-nl</a> commented at <a href="https://github.com/rear/rear/issues/1214#issuecomment-285895663">2017-03-11 19:56</a>:<a class="headerlink" href="#probackup-nl_commented_at_2017-03-11_1956" title="Permanent link">&para;</a></h4>
<p>Mmm, there already is
<a href="https://github.com/rear/rear/blob/2c12a52b3322f833c81cae2a8bc5baa799c3187d/usr/share/rear/finalize/Linux-i386/230_run_efibootmgr.sh">.../finalize/Linux-i386/230_run_efibootmgr.sh</a>.</p>
<p>Why isn't that script executed upon <code>rear mkrescue</code>?</p>
<p>My guess, because the script is in the folder <code>Linux-i386</code> instead of
<code>GNU/Linux</code>.</p>
<p>Can't this script be moved to <code>default</code>?</p>
<h4 id="jsmeix_commented_at_2017-03-13_0934"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1214#issuecomment-286056772">2017-03-13 09:34</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-03-13_0934" title="Permanent link">&para;</a></h4>
<p>@ProBackup-nl<br />
in general regarding why some scripts are sourced or not<br />
see the SourceStage function in<br />
lib/framework-functions.sh</p>
<p>I.e. something like .../stage_name/default/123_foo.sh<br />
gets always souced for stage 'stage_name'<br />
but .../stage_name/Linux-i386/456_bar.sh<br />
is only souced when one of those zillions of variables<br />
that are tested in the SourceStage function is "Linux-i386".</p>
<p>Caution with moving a script to 'default' because then<br />
this script is sourced in any case.<br />
I would recommend to better set one of those zillions<br />
of variables right for Arch Linux so that<br />
finalize/Linux-i386/230_run_efibootmgr.sh<br />
gets sourced.</p>
<p>How to set those variables right for Arch Linux see<br />
the SetOSVendorAndVersion function in<br />
lib/config-functions.sh<br />
There is already a (<em>archlinux</em>) case but I assume<br />
this needs some enhancements to actually work well.</p>
<p>Regarding what stages are sourced for a workflow,<br />
see the WORKFLOW_workflow_name functions<br />
in the lib/workflow_name-workflow.sh scriprts,<br />
e.g. for the 'recover" workflow<br />
the WORKFLOW_recover function<br />
in lib/recover-workflow.sh</p>
<h4 id="probackup-nl_commented_at_2017-03-14_0121"><img src="https://avatars.githubusercontent.com/u/515451?u=4f985fa15d087babc5049c337be90b42b56c8b8b&v=4" width="50"><a href="https://github.com/ProBackup-nl">ProBackup-nl</a> commented at <a href="https://github.com/rear/rear/issues/1214#issuecomment-286293451">2017-03-14 01:21</a>:<a class="headerlink" href="#probackup-nl_commented_at_2017-03-14_0121" title="Permanent link">&para;</a></h4>
<p>@jsmeix To me it looks like "Linux-i386" is starting to be configured
around line 77 of
<a href="https://github.com/rear/rear/blob/4fb1f98a2b6ff777e006424ff991d1bd27029018/usr/share/rear/conf/default.conf#L77">https://github.com/rear/rear/blob/4fb1f98a2b6ff777e006424ff991d1bd27029018/usr/share/rear/conf/default.conf#L77</a>
... where at line 79
<a href="https://github.com/rear/rear/blob/4fb1f98a2b6ff777e006424ff991d1bd27029018/usr/share/rear/conf/default.conf#L79">https://github.com/rear/rear/blob/4fb1f98a2b6ff777e006424ff991d1bd27029018/usr/share/rear/conf/default.conf#L79</a>
the "x86_64" of <code>uname -m</code> is converted to i386.</p>
<p>The "Linux" part is configured at <a href="https://github.com/rear/rear/blob/4fb1f98a2b6ff777e006424ff991d1bd27029018/usr/share/rear/conf/default.conf#L89">line
89</a>
using <code>uname -s</code>.</p>
<p>When my head is clearer I will try again to have a look at why
<a href="https://github.com/rear/rear/blob/4fb1f98a2b6ff777e006424ff991d1bd27029018/usr/share/rear/finalize/Linux-i386/230_run_efibootmgr.sh">finalize/Linux-i386/230_run_efibootmgr.sh</a>
doesn't seem to get sourced.</p>
<h4 id="gdha_commented_at_2017-03-14_0731"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/issues/1214#issuecomment-286343104">2017-03-14 07:31</a>:<a class="headerlink" href="#gdha_commented_at_2017-03-14_0731" title="Permanent link">&para;</a></h4>
<p>@ProBackup-nl Could you run <code>rear dump</code> once so we can what ReaR thinks
it has under his motor cap?</p>
<h4 id="jsmeix_commented_at_2017-03-14_0845"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1214#issuecomment-286356904">2017-03-14 08:45</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-03-14_0845" title="Permanent link">&para;</a></h4>
<p>@ProBackup-nl<br />
with probability one
(<a href="https://en.wikipedia.org/wiki/Almost_surely">https://en.wikipedia.org/wiki/Almost_surely</a>)<br />
I confused how exactly what of those zillions of variables is set ;-)</p>
<p>In general to find out how exactly something happens inside ReaR,<br />
run it with full debugging "rear -d -D ..." and inspect the log file,
cf.<br />
"Debugging issues with Relax-and-Recover" at<br />
<a href="https://en.opensuse.org/SDB:Disaster_Recovery">https://en.opensuse.org/SDB:Disaster_Recovery</a></p>
<h4 id="jsmeix_commented_at_2017-03-14_1354"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1214#issuecomment-286427865">2017-03-14 13:54</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-03-14_1354" title="Permanent link">&para;</a></h4>
<p>FYI<br />
regarding the SetOSVendorAndVersion function<br />
and the (perhaps buggy?) SourceStage function, see<br />
<a href="https://github.com/rear/rear/pull/1241">https://github.com/rear/rear/pull/1241</a></p>
<h4 id="probackup-nl_commented_at_2017-03-14_1359"><img src="https://avatars.githubusercontent.com/u/515451?u=4f985fa15d087babc5049c337be90b42b56c8b8b&v=4" width="50"><a href="https://github.com/ProBackup-nl">ProBackup-nl</a> commented at <a href="https://github.com/rear/rear/issues/1214#issuecomment-286429238">2017-03-14 13:59</a>:<a class="headerlink" href="#probackup-nl_commented_at_2017-03-14_1359" title="Permanent link">&para;</a></h4>
<p>@gdha</p>
<pre><code># usr/sbin/rear dump
Relax-and-Recover 2.00 / Git
Using log file: /root/rear/var/log/rear/rear-d2.log.lockless
Dumping out configuration and system information
This is a 'Linux-x86_64' system, compatible with 'Linux-i386'.
System definition:
                                    ARCH = Linux-i386
                                      OS = GNU/Linux
                        OS_MASTER_VENDOR =
                       OS_MASTER_VERSION = rolling
                   OS_MASTER_VENDOR_ARCH = i386
                OS_MASTER_VENDOR_VERSION = rolling
           OS_MASTER_VENDOR_VERSION_ARCH = rolling/i386
                               OS_VENDOR = Arch
                              OS_VERSION = rolling
                          OS_VENDOR_ARCH = Arch/i386
                       OS_VENDOR_VERSION = Arch/rolling
                  OS_VENDOR_VERSION_ARCH = Arch/rolling/i386
Configuration tree:
                         Linux-i386.conf : OK
                          GNU/Linux.conf : OK
                               i386.conf : missing/empty
                            rolling.conf : missing/empty
                       rolling/i386.conf : missing/empty
                               Arch.conf : missing/empty
                          Arch/i386.conf : missing/empty
                       Arch/rolling.conf : missing/empty
                  Arch/rolling/i386.conf : missing/empty
                               site.conf : OK
                              local.conf : OK
Backup with RBME
                             RBME_BACKUP =
                           RBME_HOSTNAME = d2
                  BACKUP_INTEGRITY_CHECK =
                         BACKUP_MOUNTCMD =
                     BACKUP_ONLY_EXCLUDE = no
                     BACKUP_ONLY_INCLUDE = no
                          BACKUP_OPTIONS =
      BACKUP_RESTORE_MOVE_AWAY_DIRECTORY = /root/rear/var/lib/rear/moved_away_after_backup_restore/
          BACKUP_RESTORE_MOVE_AWAY_FILES =
                    BACKUP_RSYNC_OPTIONS = --sparse --archive --hard-links --numeric-ids --stats
                  BACKUP_SELINUX_DISABLE = 1
                             BACKUP_TYPE =
                        BACKUP_UMOUNTCMD =
                              BACKUP_URL =
Output to USB
                              USB_DEVICE = /dev/disk/by-label/REAR-000
                   USB_DEVICE_FILESYSTEM = ext4
            USB_DEVICE_FILESYSTEM_PARAMS = -b 4096 -E stride=8,stripe-width=256 -O sparse_super,^has_journal
        USB_DEVICE_FILESYSTEM_PERCENTAGE = 100
                 USB_DEVICE_PARTED_LABEL = gpt
                               USB_FILES =
          USB_PARTITION_ALIGN_BLOCK_SIZE = 4
                    USB_RETAIN_BACKUP_NR = 2
                              USB_SUFFIX =
                      USB_UEFI_PART_SIZE = 200
                           RESULT_MAILTO =

/root/rear/usr/share/rear/lib/validated/Arch/rolling/i386.txt
Your system is not yet validated. Please carefully check all functions
and create a validation record with 'rear validate'. This will help others
to know about the validation status of Relax-and-Recover on this system.
Saving /root/rear/var/log/rear/rear-d2.log.lockless as /root/rear/var/log/rear/rear-d2.log
</code></pre>
<h4 id="probackup-nl_commented_at_2017-03-14_1429"><img src="https://avatars.githubusercontent.com/u/515451?u=4f985fa15d087babc5049c337be90b42b56c8b8b&v=4" width="50"><a href="https://github.com/ProBackup-nl">ProBackup-nl</a> commented at <a href="https://github.com/rear/rear/issues/1214#issuecomment-286438368">2017-03-14 14:29</a>:<a class="headerlink" href="#probackup-nl_commented_at_2017-03-14_1429" title="Permanent link">&para;</a></h4>
<p>Does this <code>-d -D</code> debug logging snippet means that
/finalize/Linux-i386/230_run_efibootmgr.sh gets executed?</p>
<pre><code>++ [[ ! -d /root/rear/usr/share/rear/finalize/Linux-i386/230_run_efibootmgr.sh ]]
++ [[ -x /root/rear/usr/share/rear/finalize/Linux-i386/230_run_efibootmgr.sh ]]
++ echo /root/rear/usr/share/rear/finalize/Linux-i386/230_run_efibootmgr.sh
</code></pre>
<p>No, I don't think that finalize/Linux-i386/230_run_efibootmgr.sh gets
sourced/executed here. It is a check whether the file is not a directory
and is executable.</p>
<h4 id="probackup-nl_commented_at_2017-03-14_1449"><img src="https://avatars.githubusercontent.com/u/515451?u=4f985fa15d087babc5049c337be90b42b56c8b8b&v=4" width="50"><a href="https://github.com/ProBackup-nl">ProBackup-nl</a> commented at <a href="https://github.com/rear/rear/issues/1214#issuecomment-286444678">2017-03-14 14:49</a>:<a class="headerlink" href="#probackup-nl_commented_at_2017-03-14_1449" title="Permanent link">&para;</a></h4>
<p>I don't see a 'finalize' stage running on <code>mkrescue</code>. Maybe 'finalize'
only executes on <code>mkbackup</code>.</p>
<p>The stages I see at <code>mkrescue</code> are in order of occurence:</p>
<ol>
<li>init</li>
<li>prep</li>
<li>layout/save</li>
<li>rescue</li>
<li>build</li>
<li>pack</li>
<li>output</li>
</ol>
<h4 id="gdha_commented_at_2017-03-14_1455"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/issues/1214#issuecomment-286446807">2017-03-14 14:55</a>:<a class="headerlink" href="#gdha_commented_at_2017-03-14_1455" title="Permanent link">&para;</a></h4>
<p>@ProBackup-nl Use the <code>-s</code> option with the workflow to see which scripts
will be executed in which order.</p>
<h4 id="probackup-nl_commented_at_2017-03-14_1502"><img src="https://avatars.githubusercontent.com/u/515451?u=4f985fa15d087babc5049c337be90b42b56c8b8b&v=4" width="50"><a href="https://github.com/ProBackup-nl">ProBackup-nl</a> commented at <a href="https://github.com/rear/rear/issues/1214#issuecomment-286448944">2017-03-14 15:02</a>:<a class="headerlink" href="#probackup-nl_commented_at_2017-03-14_1502" title="Permanent link">&para;</a></h4>
<p><a href="https://github.com/rear/rear/blob/d15591e65461dfa43df6b7dbf23015d8e5598648/usr/share/rear/lib/recover-workflow.sh#L16">usr/share/rear/lib/recover-workflow.sh</a></p>
<pre><code>    SourceStage "layout/prepare"
    SourceStage "layout/recreate"

    SourceStage "restore"

    SourceStage "finalize"
    SourceStage "wrapup"
}
</code></pre>
<p>Aha, finalize is only used for the <code>recover</code> command, not for
<code>mkrescue</code>. Now I think I know that I can't move that file, and need to
duplicate most of it's code for creating an EFISTUB booted recovery
medium.</p>
<p>It wasn't clear to me, that there is no <em>finalize</em> phase available in
<code>mkrescue</code>.</p>
<h4 id="jsmeix_commented_at_2017-03-14_1503"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1214#issuecomment-286449377">2017-03-14 15:03</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-03-14_1503" title="Permanent link">&para;</a></h4>
<p>For comparison on my SLES12 SP2 system (with BIOS):</p>
<pre>
# usr/sbin/rear -s recover | grep finalize
Source layout/prepare/default/550_finalize_script.sh
Source finalize/default/010_prepare_checks.sh
Source finalize/default/100_populate_dev.sh
Source finalize/GNU/Linux/150_migrate_disk_devices_layout.sh
Source finalize/GNU/Linux/150_migrate_lun_wwid.sh
Source finalize/GNU/Linux/150_migrate_uuid_tags.sh
Source finalize/GNU/Linux/160_rename_diskbyid.sh
Source finalize/SUSE_LINUX/i386/170_rebuild_initramfs.sh
Source finalize/Linux-i386/210_install_grub.sh
Source finalize/Linux-i386/220_install_elilo.sh
Source finalize/Linux-i386/220_install_grub2.sh
Source finalize/Linux-i386/230_run_efibootmgr.sh
Source finalize/GNU/Linux/300_create_mac_mapping.sh
Source finalize/GNU/Linux/410_migrate_udev_rules.sh
Source finalize/GNU/Linux/420_migrate_network_configuration_files.sh
Source finalize/default/880_check_for_mount_by_id.sh
Source finalize/default/890_finish_checks.sh
Source finalize/default/900_remount_sync.sh

# usr/sbin/rear -s mkbackup | grep finalize
[no output]

# usr/sbin/rear -d -D mkrescue
Relax-and-Recover 2.00 / Git
Using log file: /root/rear/var/log/rear/rear-e205.log
...

# grep ' source ' var/log/rear/rear-e205.log
+ source /root/rear/usr/share/rear/conf/Linux-i386.conf
+ source /root/rear/usr/share/rear/conf/GNU/Linux.conf
+ source /root/rear/usr/share/rear/conf/SUSE_LINUX.conf
+ source /root/rear/etc/rear/local.conf
+ source /root/rear/usr/share/rear/init/default/010_set_drlm_env.sh
+ source /root/rear/usr/share/rear/init/default/030_update_recovery_system.sh
...
[many more scripts that get 'source'd]
</pre>

<h4 id="probackup-nl_commented_at_2017-03-20_1257"><img src="https://avatars.githubusercontent.com/u/515451?u=4f985fa15d087babc5049c337be90b42b56c8b8b&v=4" width="50"><a href="https://github.com/ProBackup-nl">ProBackup-nl</a> commented at <a href="https://github.com/rear/rear/issues/1214#issuecomment-287751348">2017-03-20 12:57</a>:<a class="headerlink" href="#probackup-nl_commented_at_2017-03-20_1257" title="Permanent link">&para;</a></h4>
<p><a href="https://github.com/rhinstaller/efibootmgr/issues/41">efibootmgr is lacking support for
OsRecovery####</a>
and <a href="https://github.com/rhinstaller/efibootmgr/issues/68">efibootmgr is lacking support for USB (WWID)
devices</a> yet,
otherwise I could have added support for UEFI boot manager (for USB
devices).</p>
<h4 id="gdha_commented_at_2017-12-22_0837"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/issues/1214#issuecomment-353549882">2017-12-22 08:37</a>:<a class="headerlink" href="#gdha_commented_at_2017-12-22_0837" title="Permanent link">&para;</a></h4>
<p>@ProBackup-nl According your last comment is this PR obsolete, or does
it need some rework?</p>
<h4 id="probackup-nl_commented_at_2017-12-22_1034"><img src="https://avatars.githubusercontent.com/u/515451?u=4f985fa15d087babc5049c337be90b42b56c8b8b&v=4" width="50"><a href="https://github.com/ProBackup-nl">ProBackup-nl</a> commented at <a href="https://github.com/rear/rear/issues/1214#issuecomment-353570995">2017-12-22 10:34</a>:<a class="headerlink" href="#probackup-nl_commented_at_2017-12-22_1034" title="Permanent link">&para;</a></h4>
<p>@gdha Here I lost track. First it took me a week to create the changes,
and afterwords another week (mostly fumbling with git to get the changes
uploaded) to re-create and upload the changes a second time. I am
passing the on this PR due to "lost interest".</p>
<h4 id="gdha_commented_at_2017-12-29_1132"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/issues/1214#issuecomment-354434779">2017-12-29 11:32</a>:<a class="headerlink" href="#gdha_commented_at_2017-12-29_1132" title="Permanent link">&para;</a></h4>
<p>Based on the above comments we close this issue until the need
re-arises.</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2025 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2017-03-01.1214.issue.closed.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/rear/rear-user-guide" class="fa fa-code-fork" style="color: #fcfcfc"> rear/rear-user-guide</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
