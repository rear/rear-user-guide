<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#926 Issue closed: Local data backup with BACKUP=NETFS fails - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#926 Issue closed: Local data backup with BACKUP=NETFS fails";
        var mkdocs_page_input_path = "issues/2016-07-18.926.issue.closed.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#926 Issue closed: Local data backup with BACKUP=NETFS fails</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="926_issue_closed_local_data_backup_with_backupnetfs_fails"><a href="https://github.com/rear/rear/issues/926">#926 Issue</a> <code>closed</code>: Local data backup with BACKUP=NETFS fails<a class="headerlink" href="#926_issue_closed_local_data_backup_with_backupnetfs_fails" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>enhancement</code>, <code>bug</code>, <code>cleanup</code>, <code>fixed / solved / done</code></p>
<h4 id="tcerna_opened_issue_at_2016-07-18_0855"><img src="https://avatars.githubusercontent.com/u/17880584?u=6b03fa3ad0e06b52aa12a38c04e4d31e92686106&v=4" width="50"><a href="https://github.com/tcerna">tcerna</a> opened issue at <a href="https://github.com/rear/rear/issues/926">2016-07-18 08:55</a>:<a class="headerlink" href="#tcerna_opened_issue_at_2016-07-18_0855" title="Permanent link">&para;</a></h4>
<h1 id="relax-and-recover_rear_issue_template">Relax-and-Recover (rear) Issue Template<a class="headerlink" href="#relax-and-recover_rear_issue_template" title="Permanent link">&para;</a></h1>
<p>Please fill in the following items before submitting a new issue:</p>
<ul>
<li>rear version (/usr/sbin/rear -V):<br />
    rear-1.17.2-1.el7.noarch</li>
<li>OS version (cat /etc/rear/os.conf or lsb_release -a):<br />
    RHEL-7</li>
<li>rear configuration files (cat /etc/rear/site.conf or cat
    /etc/rear/local.conf):</li>
</ul>
<!-- -->

<pre><code># cat /etc/rear/local.conf
BACKUP=NETFS
BACKUP_URL=file:///tmp/rearbackup
</code></pre>
<ul>
<li>
<p>Brief description of the issue</p>
<p>When running <code>rear -v mkbackuponly</code> with BACKUP=NETFS and specified
BACKUP_URL in local.conf it fails with ERROR: Making backup on / is
forbidden.</p>
</li>
<li>
<p>Actual results:<br />
    ERROR: Making backup on / is forbidden. Use an external device!<br />
    Terminated</p>
</li>
<li>
<p>Expected results:<br />
    Data backup is created in specified directory.</p>
</li>
</ul>
<h4 id="jsmeix_commented_at_2016-07-18_1039"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/926#issuecomment-233296462">2016-07-18 10:39</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-07-18_1039" title="Permanent link">&para;</a></h4>
<p>Works for me<br />
(with currently newest rear GitHub master code):</p>
<pre>
f121:~/rear # grep -v '^#' etc/rear/local.conf 
OUTPUT=ISO
BACKUP=NETFS
BACKUP_URL=file:///tmp/rearbackup
...
f121:~/rear # usr/sbin/rear -d -D mkbackup
Relax-and-Recover 1.18 / Git
Using log file: /root/rear/var/log/rear/rear-f121.log
Creating disk layout
Creating root filesystem layout
Copying files and directories
Copying binaries and libraries
Copying kernel modules
Creating initramfs
Making ISO image
Wrote ISO image: /root/rear/var/lib/rear/output/rear-f121.iso (28M)
Copying resulting files to file location
Encrypting disabled
Creating tar archive '/tmp/rearbackup/f121/backup.tar.gz'
Archived 1192 MiB [avg 10009 KiB/sec]OK
Archived 1192 MiB in 123 seconds [avg 9927 KiB/sec]
f121:~/rear # find /tmp/rearbackup
/tmp/rearbackup
/tmp/rearbackup/f121
/tmp/rearbackup/f121/rear-f121.iso
/tmp/rearbackup/f121/VERSION
/tmp/rearbackup/f121/README
/tmp/rearbackup/f121/rear.log
/tmp/rearbackup/f121/backup.tar.gz
/tmp/rearbackup/f121/backup.log
</pre>

<p>@tcerna<br />
the "Making backup on / is forbidden" error message comes from<br />
usr/share/rear/prep/NETFS/default/40_automatic_exclude_recreate.sh</p>
<p>You need to run it in debug mode:</p>
<pre>
rear -d -D mkbackup
</pre>

<p>and then inspect the rear log file what leads to that error<br />
in your particular case.</p>
<p>Inspect your rear log file what happens after the line</p>
<pre>
+ source /root/rear/usr/share/rear/prep/NETFS/default
</pre>

<h4 id="jsmeix_commented_at_2016-07-18_1120"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/926#issuecomment-233303159">2016-07-18 11:20</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-07-18_1120" title="Permanent link">&para;</a></h4>
<p>Something smells here...</p>
<p>Sometimes it also fails for me, sometimes it works for me.</p>
<p>I tested different BACKUP_URL=file://<br />
but that does not matter whether or not it work.</p>
<p>Below it worked with BACKUP_URL=file:///rearbackup</p>
<p>When it works for me I have in the rear log file:</p>
<pre>
+ source /root/rear/usr/share/rear/prep/NETFS/default/40_automatic_exclude_recreate.sh
+++ url_scheme file:///rearbackup
+++ local url=file:///rearbackup
+++ local scheme=file
+++ echo file
+++ grep -q :
+++ echo file
++ local scheme=file
+++ url_path file:///rearbackup
+++ local url=file:///rearbackup
+++ local url_without_scheme=/rearbackup
+++ echo /rearbackup
++ local path=/rearbackup
++ case $scheme in
+++ df -P /rearbackup
+++ tail -1
+++ awk '{print $6}'
++ _mntpt=
++ [[ '' = \/ ]]
</pre>

<p>I.e. when it works for me the command</p>
<pre>
_mntpt=$(df -P ${path} 2>/dev/null | tail -1 | awk '{print $6}')
</pre>

<p>results an empty _mntpt variable<br />
regardless that on command line I get</p>
<pre>
f121:~ # df -P /rearbackup                                         
Filesystem     1024-blocks    Used Available Capacity Mounted on
/dev/sda2         19437568 5222120  13775032      28% /
f121:~ # df -P /rearbackup 2>/dev/null | tail -1 | awk '{print $6}'
/
</pre>

<p>Something is wrong here =&gt; somewhere there is a bug.</p>
<h4 id="jsmeix_commented_at_2016-07-18_1123"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/926#issuecomment-233303635">2016-07-18 11:23</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-07-18_1123" title="Permanent link">&para;</a></h4>
<p>I love git blame!<br />
;-)</p>
<p>git blame
usr/share/rear/prep/NETFS/default/40_automatic_exclude_recreate.sh</p>
<p>shows that the "Making backup on / is forbidden" code<br />
was added by @gdha via<br />
git commit 4bfd2e3a235ab6a86ddd403a7cfe542c40d314c3</p>
<h4 id="jsmeix_commented_at_2016-07-18_1130"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/926#issuecomment-233304673">2016-07-18 11:30</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-07-18_1130" title="Permanent link">&para;</a></h4>
<p>@gdha<br />
can you provide background information about the<br />
reason why "Making backup on / is forbidden"?</p>
<p>Is perhaps meant that for a locally stored backup<br />
the backup directory must be on a different filesystem<br />
than what the '/' directory is to avoid a loop where<br />
the backup directory content gets also backed up?</p>
<p>Do you perhaps even have an idea why sometimes</p>
<pre>
_mntpt=$(df -P ${path} 2>/dev/null | tail -1 | awk '{print $6}')
</pre>

<p>results an empty _mntpt variable?</p>
<p>As a side note:<br />
I also do not understand what you meant with<br />
the comment in the line</p>
<pre>
     (file) # if user added path manually then there is no need to do it again
</pre>

<p>in prep/NETFS/default/40_automatic_exclude_recreate.sh<br />
</pre></p>
<h4 id="tcerna_commented_at_2016-07-20_1439"><img src="https://avatars.githubusercontent.com/u/17880584?u=6b03fa3ad0e06b52aa12a38c04e4d31e92686106&v=4" width="50"><a href="https://github.com/tcerna">tcerna</a> commented at <a href="https://github.com/rear/rear/issues/926#issuecomment-233969412">2016-07-20 14:39</a>:<a class="headerlink" href="#tcerna_commented_at_2016-07-20_1439" title="Permanent link">&para;</a></h4>
<p>I tried it again and I have to results: good and bad:</p>
<p>BAD ONE:</p>
<pre><code>[root@rearclient ~]# cat /etc/rear/local.conf
BACKUP=NETFS
BACKUP_URL="file:///tmp/rear"

[root@rearclient ~]# rear -v -d -D mkbackup
Relax-and-Recover 1.17.2 / Git
Using log file: /var/log/rear/rear-rearclient.log
ERROR: Making backup on / is forbidden. Use an external device!
Aborting due to an error, check /var/log/rear/rear-rearclient.log for details
You should also rm -Rf /tmp/rear.MqH2f4NMbLXbssk
Terminated

[root@rearclient ~]# echo $?
143
</code></pre>
<p>I didn't find any strange in log file, but it does not mean that there
is any strangeness.</p>
<p>GOOD ONE:</p>
<pre><code>[root@rearclient ~]# cat /etc/rear/local.conf
BACKUP_URL="file:///tmp/rear"

[root@rearclient ~]# rear -v -d -D mkbackup
Relax-and-Recover 1.17.2 / Git
Using log file: /var/log/rear/rear-rearclient.log
Creating disk layout
Creating root filesystem layout
Copying files and directories
Copying binaries and libraries
Copying kernel modules
Creating initramfs
Making ISO image
Wrote ISO image: /var/lib/rear/output/rear-rearclient.iso (128M)
Copying resulting files to file location
You should also rm -Rf /tmp/rear.QOY6wAAs4K2LPQn

[root@rearclient ~]# echo $?
0
</code></pre>
<h4 id="scr4bble_commented_at_2016-07-20_1601"><img src="https://avatars.githubusercontent.com/u/6439904?u=19f55ae5b61bfca418bc3876f0288302b041dfcb&v=4" width="50"><a href="https://github.com/scr4bble">scr4bble</a> commented at <a href="https://github.com/rear/rear/issues/926#issuecomment-233995804">2016-07-20 16:01</a>:<a class="headerlink" href="#scr4bble_commented_at_2016-07-20_1601" title="Permanent link">&para;</a></h4>
<ul>
<li>rear version (/usr/sbin/rear -V):<br />
    Relax-and-Recover 1.17.2 / Git</li>
<li>OS version (cat /etc/rear/os.conf or lsb_release -a):<br />
    RedHatEnterpriseServer 7</li>
<li>rear configuration files (cat /etc/rear/site.conf or cat
    /etc/rear/local.conf):</li>
</ul>
<!-- -->

<pre><code>OUTPUT=ISO
OUTPUT_URL="file:///root/"
BACKUP=NETFS
BACKUP_URL="file:///root/backup/"
GRUB_RESCUE=1
GRUB_RESCUE_PASSWORD="...."
</code></pre>
<ul>
<li>Brief description of the issue</li>
</ul>
<p>When I run <code>rear mkbackup -v</code> for the first time with above settings it
creates backup with image successfully.<br />
If I wants to make backup again (with same settings, but without
deleting previously created files), it fails with this error (bellow) -
no matter what backup... it fails with all "subcommands": mkbackup,
mkbackuponly, mkrescue!!!</p>
<pre><code>Using log file: /var/log/rear/rear-rearserver.log
ERROR: Making backup on / is forbidden. Use an external device!
Aborting due to an error, check /var/log/rear/rear-rearserver.log for details
</code></pre>
<ul>
<li>Questions &amp; suggestions:</li>
</ul>
<p>Is there a problem with overwriting files ? (if yes, it could print
proper message)<br />
Is storing backup on the same filesystem forbidden ?<br />
I think it shouldn't block to make a rescue image even if there is any
problem with BACKUP* variables/settings.</p>
<h4 id="jsmeix_commented_at_2016-07-21_0715"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/926#issuecomment-234175559">2016-07-21 07:15</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-07-21_0715" title="Permanent link">&para;</a></h4>
<p>I think by default "rear mkbackup" does not care about old files<br />
(i.e. it just overwrites them).<br />
Regarding avoiding overwriting files see<br />
NETFS_KEEP_OLD_BACKUP_COPY<br />
cf. "Relax-and-Recover (rear) versus backup and restore"<br />
at
<a href="https://en.opensuse.org/SDB:Disaster_Recovery">https://en.opensuse.org/SDB:Disaster_Recovery</a></p>
<p>I think "rear mkbackup" should error out whenever there<br />
is an error, cf.
<a href="https://github.com/rear/rear/wiki/Coding-Style">https://github.com/rear/rear/wiki/Coding-Style</a></p>
<p>I think it must error out whenever a specified thing<br />
cannot be done, cf.
<a href="https://github.com/rear/rear/issues/913#issuecomment-232661112">https://github.com/rear/rear/issues/913#issuecomment-232661112</a></p>
<p>I assume the root cause here is that rear does not care<br />
sufficiently about possible errors at the actually right place<br />
and blindly proceeds until it errors out somewhere later<br />
at an unrelated place with a weird error message which leads<br />
to false assumptions about the root cause of the issue and then<br />
to false fixes that cure only a symptom but not the root cause.</p>
<p>I will do a deeper analysis what actually goes on here.</p>
<p>I would very much appreciate any help from others with that<br />
analysis so that finally we can fix it properly.</p>
<p>"Given enough eyeballs, all bugs are shallow"<br />
cf.
<a href="https://en.wikipedia.org/wiki/Linus%27s_Law">https://en.wikipedia.org/wiki/Linus%27s_Law</a></p>
<h4 id="jsmeix_commented_at_2016-07-21_1008"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/926#issuecomment-234212053">2016-07-21 10:08</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-07-21_1008" title="Permanent link">&para;</a></h4>
<p>One must avoid a BACKUP_URL=file:///dir<br />
where /dir is included in the backup.</p>
<p>For me "rear mkbackup" with BACKUP_URL=file:///rearbackup<br />
(where /rearbackup did not already exist before) worked<br />
but results the backup in the backup:</p>
<pre>
# tar -tzvf /rearbackup/f121/backup.tar.gz | grep rearbackup
drwx------ root/root            0 2016-07-21 11:35 rearbackup/
drwxr-x--- root/root            0 2016-07-21 11:35 rearbackup/f121/
-rw------- root/root            0 2016-07-21 11:35 rearbackup/f121/.lockfile
-rw------- root/root    120426496 2016-07-21 11:35 rearbackup/f121/rear-f121.iso
-rw------- root/root          262 2016-07-21 11:35 rearbackup/f121/VERSION
-rw------- root/root          202 2016-07-21 11:35 rearbackup/f121/README
-rw------- root/root      6747236 2016-07-21 11:35 rearbackup/f121/rear.log
-rw------- root/root   1385283584 2016-07-21 11:37 rearbackup/f121/backup.tar.gz
# ls -l /rearbackup/f121/
total 2823976
-rw------- 1 root root   11080034 Jul 21 11:38 backup.log
-rw------- 1 root root 2753482505 Jul 21 11:38 backup.tar.gz
-rw------- 1 root root        202 Jul 21 11:35 README
-rw------- 1 root root  120426496 Jul 21 11:35 rear-f121.iso
-rw------- 1 root root    6747236 Jul 21 11:35 rear.log
-rw------- 1 root root        262 Jul 21 11:35 VERSION
</pre>

<p>Restoring that backup results a /rearbackup/$HOSTNAME<br />
directory that contains invalid files (in particular an invalid<br />
backup.tar.gz).</p>
<p>I think "rear recover" that restores /rearbackup/$HOSTNAME<br />
directory that contains invalid files only looks not nice<br />
but it does not lead to an actually broken system<br />
because the other files should be o.k.</p>
<p>What matters more is that having the backup in the backup<br />
increases needlessly the backup size to basically double size<br />
at least in my case where /rearbackup/$HOSTNAME/backup.tar.gz<br />
was added last to the backup as reported in<br />
/rearbackup/$HOSTNAME/backup.log</p>
<pre>
# tail -n20 /rearbackup/f121/backup.log
block 5531760: /root/rear/var/lib/rear/layout/lvm/
block 5531763: /root/rear/var/lib/rear/sysreqs/
block 5531766: /root/rear/var/lib/rear/sysreqs/Minimal_System_Requirements.txt
block 5531771: /root/.Xauthority-n
block 5531774: /root/.viminfo
block 5531793: /selinux/
block 5531796: /rearbackup/
block 5531799: /rearbackup/f121/
block 5531802: /rearbackup/f121/.lockfile
block 5531805: /rearbackup/f121/rear-f121.iso
block 5767016: /rearbackup/f121/VERSION
block 5767020: /rearbackup/f121/README
block 5767024: /rearbackup/f121/rear.log
block 5780206: /rearbackup/f121/backup.tar.gz
tar: /rearbackup/f121/backup.tar.gz: file changed as we read it
block 8485826: /root/rear/var/log/rear/rear-f121.log
Total bytes written: 4344750080 (4.1GiB, 24MiB/s)
5377895+1 records in
5377895+1 records out
2753482505 bytes (2.8 GB) copied, 174.252 s, 15.8 MB/s
</pre>

<p>But again a needlessly increased backup size<br />
is not a fatal error.</p>
<p>I wonder if rear should try to be smarter than the user<br />
and implement sophisticated test to avoid such kind<br />
of user faults.</p>
<p>I think it belongs to the user to think about in advance<br />
how to set up rear correctly.</p>
<p>From my current point of view I would close that issue<br />
as an example of improper usage of rear.</p>
<p>The only bug that is see is the misleading error message</p>
<pre>
ERROR: Making backup on / is forbidden. Use an external device!
</pre>

<p>when one does a second "rear mkbackup"<br />
with BACKUP_URL=file:///rearbackup<br />
where /rearbackup did already exists.</p>
<h4 id="jsmeix_commented_at_2016-07-21_1032"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/926#issuecomment-234217021">2016-07-21 10:32</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-07-21_1032" title="Permanent link">&para;</a></h4>
<p>With BACKUP_URL=file:///rearbackup<br />
where /rearbackup is a mountpoint of a separated filesystem<br />
(ex2 on /dev/sdb1in my case) the backup is o.k.:</p>
<pre>
# ls -l /rearbackup/f121/backup.tar.gz
-rw------- 1 root root 1266451979 Jul 21 12:20 /rearbackup/f121/backup.tar.gz
# tar -tzvf /rearbackup/f121/backup.tar.gz | grep rearbackup
drwxr-xr-x root/root            0 2016-07-21 12:18 rearbackup/
[no further output]
# mount | grep sdb
/dev/sdb1 on /rearbackup type ext2 (rw,relatime)
</pre>

<p>Now even a second "rear mkbackup" works as intended<br />
regardless that /rearbackup already exists.<br />
I have NETFS_KEEP_OLD_BACKUP_COPY=yes<br />
and accordingly I have after the second "rear mkbackup"</p>
<pre>
# find /rearbackup
/rearbackup
/rearbackup/f121.old
/rearbackup/f121.old/VERSION
/rearbackup/f121.old/backup.tar.gz
/rearbackup/f121.old/rear-f121.iso
/rearbackup/f121.old/README
/rearbackup/f121.old/rear.log
/rearbackup/f121.old/backup.log
/rearbackup/lost+found
/rearbackup/f121
/rearbackup/f121/VERSION
/rearbackup/f121/backup.tar.gz
/rearbackup/f121/rear-f121.iso
/rearbackup/f121/README
/rearbackup/f121/rear.log
/rearbackup/f121/backup.log
# ls -l /rearbackup/*/backup.tar.gz
-rw------- 1 root root 1266910902 Jul 21 12:30 /rearbackup/f121/backup.tar.gz
-rw------- 1 root root 1266451979 Jul 21 12:20 /rearbackup/f121.old/backup.tar.gz
</pre>

<h4 id="jsmeix_commented_at_2016-07-21_1135"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/926#issuecomment-234228799">2016-07-21 11:35</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-07-21_1135" title="Permanent link">&para;</a></h4>
<p>And a third "rear mkbackup" now<br />
without NETFS_KEEP_OLD_BACKUP_COPY<br />
just overwrites the files in /rearbackup/f121/<br />
in particular I have now</p>
<pre>
# ls -l /rearbackup/*/backup.tar.gz
-rw------- 1 root root 1266897447 Jul 21 13:23 /rearbackup/f121/backup.tar.gz
-rw------- 1 root root 1266451979 Jul 21 12:20 /rearbackup/f121.old/backup.tar.gz
</pre>

<p>Conclusion from my point of view:</p>
<p>With a proper set up everything works fine for me with<br />
BACKUP_URL=file:///...</p>
<p>The only thing left is to find out how the "_mntpt" test<br />
in prep/NETFS/default/40_automatic_exclude_recreate.sh<br />
is meant:</p>
<p>@gdha<br />
see
<a href="https://github.com/rear/rear/issues/926#issuecomment-233304673">https://github.com/rear/rear/issues/926#issuecomment-233304673</a><br />
can you explain how the "_mntpt" test<br />
in prep/NETFS/default/40_automatic_exclude_recreate.sh<br />
is meant to work - i.e. what is the idea behind that test.</p>
<h4 id="jsmeix_commented_at_2016-07-21_1202"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/926#issuecomment-234233695">2016-07-21 12:02</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-07-21_1202" title="Permanent link">&para;</a></h4>
<p>Stupid me!</p>
<p>The "_mntpt" test<br />
in prep/NETFS/default/40_automatic_exclude_recreate.sh<br />
results an empty _mntpt when the directory in<br />
BACKUP_URL=file:///directory<br />
does not yet exist because</p>
<pre>
# df -P qqq 2>/dev/null
# df -P qqq
df: 'qqq': No such file or directory
</pre>

<p>and it correctly finds out that the director is mounted at '/'<br />
when it already exists.</p>
<p>I will enhace the test to be more fail-safe...</p>
<h4 id="jsmeix_commented_at_2016-07-21_1257"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/926#issuecomment-234245055">2016-07-21 12:57</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-07-21_1257" title="Permanent link">&para;</a></h4>
<p>With<br />
<a href="https://github.com/rear/rear/pull/936">https://github.com/rear/rear/pull/936</a><br />
I tried to make<br />
prep/NETFS/default/40_automatic_exclude_recreate.sh<br />
more fail safe.</p>
<p>@gdha<br />
please have a look if you like it this way<br />
or if I may have misunderstood something</p>
<h4 id="jsmeix_commented_at_2016-07-21_1311"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/926#issuecomment-234248477">2016-07-21 13:11</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-07-21_1311" title="Permanent link">&para;</a></h4>
<p>With
<a href="https://github.com/rear/rear/pull/936">https://github.com/rear/rear/pull/936</a>
I get:</p>
<p>With BACKUP_URL=file:///rootfsrearbackup I get<br />
when /rootfsrearbackup does not yet exist</p>
<pre>
ERROR: URL 'file:///rootfsrearbackup' would result the backup directory '/rootfsrearbackup' in the '/' filesystem which is forbidden.
</pre>

<p>and when /rootfsrearbackup does already exist</p>
<pre>
ERROR: URL 'file:///rootfsrearbackup' has the backup directory '/rootfsrearbackup' in the '/' filesystem which is forbidden.
</pre>

<p>With BACKUP_URL=file:///etc/rear/local.conf I get</p>
<pre>
ERROR: URL 'file:///etc/rear/local.conf' specifies '/etc/rear/local.conf' which is not a directory.
</pre>

<p>With BACKUP_URL=file:///rearbackup (as above)<br />
where /rearbackup is a mountpoint of a separated filesystem<br />
it still works for me:</p>
<pre>
# usr/sbin/rear -d -D mkbackup
Relax-and-Recover 1.18 / Git
Using log file: /root/rear/var/log/rear/rear-f121.log
Creating disk layout
Excluding component fs:/rearbackup
...
</pre>

<h4 id="jsmeix_commented_at_2016-07-21_1339"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/926#issuecomment-234255678">2016-07-21 13:39</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-07-21_1339" title="Permanent link">&para;</a></h4>
<p>But with BACKUP_URL=file:///rearbackup/subdir<br />
where /rearbackup is a mountpoint of a separated filesystem<br />
but /rearbackup/subdir does not yet exist<br />
it did not work correctly:</p>
<pre>
ERROR: URL 'file:///rearbackup/subdir' would result the backup directory '/rearbackup/subdir' in the '/' filesystem which is forbidden.
</pre>

<p>I fixed handling when backup directory does not yet exist in<br />
<a href="https://github.com/rear/rear/pull/936">https://github.com/rear/rear/pull/936</a><br />
so that now BACKUP_URL=file:///rearbackup/subdir<br />
also works as intended</p>
<pre>
# usr/sbin/rear -d -D mkbackup
Relax-and-Recover 1.18 / Git
Using log file: /root/rear/var/log/rear/rear-f121.log
Creating disk layout
Excluding component fs:/rearbackup
...
</pre>

<p>and in rear-f121.log I get now</p>
<pre>
+ source /root/rear/usr/share/rear/prep/NETFS/default/40_automatic_exclude_recreate.sh
+++ url_scheme file:///rearbackup/subdir
+++ local url=file:///rearbackup/subdir
+++ local scheme=file
+++ grep -q :
+++ echo file
+++ echo file
++ local scheme=file
+++ url_path file:///rearbackup/subdir
+++ local url=file:///rearbackup/subdir
+++ local url_without_scheme=/rearbackup/subdir
+++ echo /rearbackup/subdir
++ local backup_directory=/rearbackup/subdir
++ local backup_directory_mountpoint=
++ case $scheme in
++ test -e /rearbackup/subdir
++ mkdir -v -p /rearbackup/subdir
mkdir: created directory '/rearbackup/subdir'
++ test -d /rearbackup/subdir
+++ tail -1
+++ awk '{print $6}'
+++ df -P /rearbackup/subdir
++ backup_directory_mountpoint=/rearbackup
++ test / = /rearbackup
...
</pre>

<p>and this is result</p>
<pre>
# ls -l /rearbackup/*/*/backup.tar.gz
-rw------- 1 root root 1266459574 Jul 21 15:34 /rearbackup/subdir/f121/backup.tar.gz
</pre>

<h4 id="jsmeix_commented_at_2016-07-21_1419"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/926#issuecomment-234268037">2016-07-21 14:19</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-07-21_1419" title="Permanent link">&para;</a></h4>
<p>Since
<a href="https://github.com/rear/rear/issues/926#issuecomment-234255678">https://github.com/rear/rear/issues/926#issuecomment-234255678</a><br />
it looks hood to me and I like to have it tested by @tcerna<br />
so that I simply merged
<a href="https://github.com/rear/rear/pull/936">https://github.com/rear/rear/pull/936</a>
now.</p>
<p>@tcerna<br />
does it now work better for you with current GitHub master code?</p>
<h4 id="jsmeix_commented_at_2016-07-22_1302"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/926#issuecomment-234537571">2016-07-22 13:02</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-07-22_1302" title="Permanent link">&para;</a></h4>
<p>Of course I also like to have it tested by<br />
@scr4bble<br />
does it now work better for you with current GitHub master code?</p>
<h4 id="gdha_commented_at_2016-07-23_1041"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/issues/926#issuecomment-234711803">2016-07-23 10:41</a>:<a class="headerlink" href="#gdha_commented_at_2016-07-23_1041" title="Permanent link">&para;</a></h4>
<p>@jsmeix thank you for your troubleshooting and fix</p>
<h4 id="jsmeix_commented_at_2016-07-29_1018"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/926#issuecomment-236145748">2016-07-29 10:18</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-07-29_1018" title="Permanent link">&para;</a></h4>
<p>No feedback from users.<br />
Assuming no news are good news.<br />
Closing it.</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2024 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2016-07-18.926.issue.closed.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
