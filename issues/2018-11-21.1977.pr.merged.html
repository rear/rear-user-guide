<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#1977 PR merged: Ignore relabeling of /boot/efi only if directory exists. - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#1977 PR merged: Ignore relabeling of /boot/efi only if directory exists.";
        var mkdocs_page_input_path = "issues/2018-11-21.1977.pr.merged.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/backup_netfs.html">Example of BACKUP=NETFS</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/netfs_nas.html">Internal Backup with tar to NFS server</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../scenarios/netfs_rsync.md">Internal Backup with rsync to NFS server</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/rbme.html">External Backup using RBME</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/restic.html">External Backup using restic</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../development/squash-git-log-commments.html">How to squash git log comments into one line</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear29.html">Release Notes ReaR 2.9</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear28.html">Release Notes ReaR 2.8</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#1977 PR merged: Ignore relabeling of /boot/efi only if directory exists.</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="1977_pr_merged_ignore_relabeling_of_bootefi_only_if_directory_exists"><a href="https://github.com/rear/rear/pull/1977">#1977 PR</a> <code>merged</code>: Ignore relabeling of /boot/efi only if directory exists.<a class="headerlink" href="#1977_pr_merged_ignore_relabeling_of_bootefi_only_if_directory_exists" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>enhancement</code>, <code>cleanup</code>, <code>fixed / solved / done</code>,
<code>minor bug</code></p>
<h4 id="gozora_opened_issue_at_2018-11-21_1731"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> opened issue at <a href="https://github.com/rear/rear/pull/1977">2018-11-21 17:31</a>:<a class="headerlink" href="#gozora_opened_issue_at_2018-11-21_1731" title="Permanent link">&para;</a></h4>
<h5 id="pull_request_details">Pull Request Details:<a class="headerlink" href="#pull_request_details" title="Permanent link">&para;</a></h5>
<ul>
<li>
<p>Type: <strong>Enhancement</strong></p>
</li>
<li>
<p>Impact: <strong>Low</strong></p>
</li>
<li>
<p>Reference to related issue (URL):
    <a href="https://github.com/rear/rear/issues/1972">https://github.com/rear/rear/issues/1972</a></p>
</li>
<li>
<p>How was this pull request tested?<br />
    By running <code>rear recover</code> on Arch Linux.</p>
</li>
<li>
<p>Brief description of the changes in this pull request:<br />
    This patch avoids <code>rear recover</code> to end with error if /boot/efi
    directory does not exist in late recover stage (archive is already
    restored), and instead adds /boot/efi to SElinux relabeling ignore
    list, only if /boot/efi directory exists.</p>
</li>
</ul>
<h4 id="gozora_commented_at_2018-11-21_1758"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/pull/1977#issuecomment-440758194">2018-11-21 17:58</a>:<a class="headerlink" href="#gozora_commented_at_2018-11-21_1758" title="Permanent link">&para;</a></h4>
<p>After thinking about this PR for a while, I've decided for less invasive
and IMHO more correct way ...</p>
<p>V.</p>
<h4 id="jsmeix_commented_at_2018-11-22_0827"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1977#issuecomment-440950313">2018-11-22 08:27</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-11-22_0827" title="Permanent link">&para;</a></h4>
<p>Argh!</p>
<p>@gozora<br />
thank you to call my attention to that script.</p>
<p>I never had a look at that script before because I do not use SELinux.<br />
In general I do not like unconditioned special case handling.</p>
<p>The following issues exist since the beginning in that script:</p>
<p>With that script every user who has UEFI (and /boot/efi) gets a new
file<br />
/etc/selinux/fixfiles_exclude_dirs created during "rear recover".</p>
<p>What about users who do not use SELinux?<br />
They get a useless /etc/selinux/fixfiles_exclude_dirs created.</p>
<p>What about users who have already a /etc/selinux/fixfiles_exclude_dirs
file?<br />
They get their /etc/selinux/fixfiles_exclude_dirs overwritten.</p>
<p>This means two more conditions need to be checked:</p>
<p>(a)<br />
Do nothing when SELinux is not used.</p>
<p>(b)<br />
Do not silently overwrite user's files.<br />
An existing file is user data that was restored from the his backup
and<br />
user data is usually sacrosanct unless the user confirmed otherwise<br />
or at least ReaR has to save user's files before overwriting them, cf.<br />
<a href="https://github.com/rear/rear/issues/1854#issuecomment-403013334">https://github.com/rear/rear/issues/1854#issuecomment-403013334</a>
and<br />
<a href="https://github.com/rear/rear/commit/632bc2dee4d5b82cfe91416c81254f0bc9919a70">https://github.com/rear/rear/commit/632bc2dee4d5b82cfe91416c81254f0bc9919a70</a></p>
<p>@gozora<br />
because you are already working on it I would very much appreciate it<br />
if you could also clean up that script in general.</p>
<h4 id="gozora_commented_at_2018-11-22_0937"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/pull/1977#issuecomment-440969594">2018-11-22 09:37</a>:<a class="headerlink" href="#gozora_commented_at_2018-11-22_0937" title="Permanent link">&para;</a></h4>
<p>Hello @jsmeix</p>
<p>My knowledge of SELinux is limited to disabling of this feature ;-)</p>
<blockquote>
<p>(a)<br />
Do nothing when SELinux is not used.</p>
</blockquote>
<p>I'm not sure if we can detect SELinux usage and mode of operation
reliably across all distributions...</p>
<blockquote>
<p>Do not silently overwrite user's files.</p>
</blockquote>
<p>Fully agree, Maybe using:</p>
<pre><code>-  cat &gt; $TARGET_FS_ROOT/etc/selinux/fixfiles_exclude_dirs &lt;&lt;EOF
+  cat &gt;&gt; $TARGET_FS_ROOT/etc/selinux/fixfiles_exclude_dirs &lt;&lt;EOF
...
</code></pre>
<p>Would be better ...</p>
<p>V.</p>
<h4 id="jsmeix_commented_at_2018-11-22_1014"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1977#issuecomment-440980648">2018-11-22 10:14</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-11-22_1014" title="Permanent link">&para;</a></h4>
<p>@gdha<br />
I assigned you too here because I assume you could help<br />
with the SELinux related questions here.</p>
<p>But there is no need to do the general clean up right now here.<br />
We could also do it later in a separated step as time permits.</p>
<h4 id="jsmeix_commented_at_2018-11-22_1021"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1977#issuecomment-440982991">2018-11-22 10:21</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-11-22_1021" title="Permanent link">&para;</a></h4>
<p>@gozora<br />
I also know nothing at all about SELinux setup.</p>
<p>But even without any SELinux knowledge only by plain looking at the
code<br />
I assume at the beginning an additional condition like</p>
<pre>
# Skip if there is no etc/selinux/ directory (e.g. when SELinux is not used)
# and if there is no etc/selinux/ directory creating a fixfiles_exclude_dirs file
# therein cannot work anyway:
test -d $TARGET_FS_ROOT/etc/selinux || return 0
</pre>

<p>is needed to make the subsequent code work fail-safe.</p>
<h4 id="jsmeix_commented_at_2018-11-22_1033"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1977#issuecomment-440986677">2018-11-22 10:33</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-11-22_1033" title="Permanent link">&para;</a></h4>
<p>A proposal how to clean it up and make it work more straightforward:</p>
<pre>
# For UEFI we should avoid SElinux relabeling vfat filesystem /boot/efi

# Skip if UEFI is not used:
is_true $USING_UEFI_BOOTLOADER || return 0

# Skip if there is no etc/selinux/ directory (e.g. when SELinux is not used)
# and if there is no etc/selinux/ directory creating a fixfiles_exclude_dirs
# file therein cannot work anyway:
test -d $TARGET_FS_ROOT/etc/selinux || return 0

# Skip if there is no boot/efi directory:
test -d $TARGET_FS_ROOT/boot/efi || return 0

# Do not overwrite an existing etc/selinux/fixfiles_exclude_dirs file
# An existing file is user data that was restored from his backup and
# user data is sacrosanct unless the user had confirmed otherwise:
if test -s $TARGET_FS_ROOT/etc/selinux/fixfiles_exclude_dirs ; then
    Log "Not overwriting the existing etc/selinux/fixfiles_exclude_dirs file"
    return 0
fi

# Create etc/selinux/fixfiles_exclude_dirs file from scratch:
cat &gt; $TARGET_FS_ROOT/etc/selinux/fixfiles_exclude_dirs &lt;&lt;EOF
/boot/efi
/boot/efi(/.*)?
EOF
</pre>

<p>By the way:<br />
What if /boot/efi is not a mounted vfat filesystem?<br />
Can this happen with UEFI?<br />
I think this cannot happen with UEFI on Linux because<br />
<a href="https://en.wikipedia.org/wiki/EFI_system_partition">https://en.wikipedia.org/wiki/EFI_system_partition</a><br />
reads</p>
<pre>
The EFI system partition needs to be formatted
with a file system whose specification is based
on the FAT file system and maintained as part
of the UEFI specification; therefore, the file system
specification is independent from the original
FAT specification.
</pre>

<p>But what if the ESP is not mounted at all (can this happen on Linux?)?<br />
or if the ESP is mounted but not at /boot/efi (e.g. on Arch Linux)?<br />
<a href="https://en.wikipedia.org/wiki/EFI_system_partition">https://en.wikipedia.org/wiki/EFI_system_partition</a><br />
reads</p>
<pre>
The mount point for the EFI system partition
is usually /boot/efi, where its content is
accessible after Linux is booted
</pre>

<p>The "usually" indicates we cannot rely on ESP mounted at <code>/boot/efi</code><br />
and I don't know if the ESP content needs to be accessible after<br />
Linux is booted in any case.</p>
<h4 id="gozora_commented_at_2018-11-22_1047"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/pull/1977#issuecomment-440990567">2018-11-22 10:47</a>:<a class="headerlink" href="#gozora_commented_at_2018-11-22_1047" title="Permanent link">&para;</a></h4>
<p>@jsmeix<br />
Nice one!<br />
I'll update PR later today.<br />
Thanks for your help!</p>
<p>V.</p>
<h4 id="jsmeix_commented_at_2018-11-22_1355"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1977#issuecomment-441037816">2018-11-22 13:55</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-11-22_1355" title="Permanent link">&para;</a></h4>
<p>Using code to "Determine where the EFI System Partition (ESP) is
mounted" from<br />
<a href="https://github.com/rear/rear/commit/14bfcd40d8d78ba6c45db11cbd31b2f83d0fb6c2">https://github.com/rear/rear/commit/14bfcd40d8d78ba6c45db11cbd31b2f83d0fb6c2</a></p>
<pre>
# Determine where the EFI System Partition (ESP) is mounted in the currently running recovery system:
esp_mountpoint=$( df -P "$TARGET_FS_ROOT/$UEFI_BOOTLOADER" | tail -1 | awk '{print $6}' )
# Use TARGET_FS_ROOT/boot/efi as fallback ESP mountpoint:
test "$esp_mountpoint" || esp_mountpoint="$TARGET_FS_ROOT/boot/efi"
</pre>

<p>should sufficiently mitigate possible issues where ESP is mounted<br />
also in this case here.</p>
<p>Perhaps also the test in<br />
<a href="https://github.com/rear/rear/commit/14bfcd40d8d78ba6c45db11cbd31b2f83d0fb6c2">https://github.com/rear/rear/commit/14bfcd40d8d78ba6c45db11cbd31b2f83d0fb6c2</a></p>
<pre>
# UEFI_BOOTLOADER empty or not a regular file means using BIOS cf. rescue/default/850_save_sysfs_uefi_vars.sh
# Double quotes are mandatory here because 'test -f' without any (possibly empty) argument results true:
test -f "$UEFI_BOOTLOADER" || return 0
</pre>

<p>could be useful in this case here?</p>
<p>If I am right, those duplicated testing code snippets in several
scripts<br />
might be later combined and moved into one general function...</p>
<h4 id="jsmeix_commented_at_2018-11-22_1428"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1977#issuecomment-441046721">2018-11-22 14:28</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-11-22_1428" title="Permanent link">&para;</a></h4>
<p>Enhanced proposal how to clean it up<br />
as in
<a href="https://github.com/rear/rear/pull/1977#issuecomment-440986677">https://github.com/rear/rear/pull/1977#issuecomment-440986677</a><br />
plus
<a href="https://github.com/rear/rear/pull/1977#issuecomment-441037816">https://github.com/rear/rear/pull/1977#issuecomment-441037816</a></p>
<pre>
# For UEFI we should avoid SELinux relabeling the
# vfat filesystem of the EFI System Partition (ESP)
# which is usually mounted at boot/efi

# Skip if there is no etc/selinux/ directory (e.g. when SELinux is not used)
# and if there is no etc/selinux/ directory creating a fixfiles_exclude_dirs
# file therein (see the code at the end) cannot work anyway:
test -d $TARGET_FS_ROOT/etc/selinux || return 0

# The following four code parts are same also in
# finalize/Linux-i386/630_run_efibootmgr.sh

# USING_UEFI_BOOTLOADER empty or not true means using BIOS
is_true $USING_UEFI_BOOTLOADER || return 0

# UEFI_BOOTLOADER empty or not a regular file means using BIOS cf. rescue/default/850_save_sysfs_uefi_vars.sh
# Double quotes are mandatory here because 'test -f' without any (possibly empty) argument results true:
test -f "$UEFI_BOOTLOADER" || return 0

# Determine where the EFI System Partition (ESP) is mounted in the currently running recovery system:
esp_mountpoint=$( df -P "$TARGET_FS_ROOT/$UEFI_BOOTLOADER" | tail -1 | awk '{print $6}' )
# Use TARGET_FS_ROOT/boot/efi as fallback ESP mountpoint:
test "$esp_mountpoint" || esp_mountpoint="$TARGET_FS_ROOT/boot/efi"

# Skip if there is no esp_mountpoint directory (e.g. the fallback ESP mountpoint may not exist).
# Double quotes are mandatory here because 'test -d' without any (possibly empty) argument results true:
test -d "$esp_mountpoint" || return 0

# Do not overwrite an existing etc/selinux/fixfiles_exclude_dirs file
# An existing file is user data that was restored from his backup and
# user data is sacrosanct unless the user had confirmed otherwise:
if test -s $TARGET_FS_ROOT/etc/selinux/fixfiles_exclude_dirs ; then
    Log "Not overwriting the existing etc/selinux/fixfiles_exclude_dirs file"
    return 0
fi

# The ESP mountpoint directory values in fixfiles_exclude_dirs
# must match what there will be on the recreated target system
# i.e. esp_mountpoint without TARGET_FS_ROOT prefix:
target_esp_mountpoint=${esp_mountpoint#$TARGET_FS_ROOT}

# Create etc/selinux/fixfiles_exclude_dirs file from scratch:
cat &gt; $TARGET_FS_ROOT/etc/selinux/fixfiles_exclude_dirs &lt;&lt;EOF
$target_esp_mountpoint
$target_esp_mountpoint(/.*)?
EOF
</pre>

<p>FYI:<br />
I added the "Skip if there is no esp_mountpoint directory"<br />
also to finalize/Linux-i386/630_run_efibootmgr.sh via<br />
<a href="https://github.com/rear/rear/commit/cb6fe3be719c1361b22d0484cd940c681752a973">https://github.com/rear/rear/commit/cb6fe3be719c1361b22d0484cd940c681752a973</a></p>
<h4 id="gozora_commented_at_2018-11-22_1737"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/pull/1977#issuecomment-441092329">2018-11-22 17:37</a>:<a class="headerlink" href="#gozora_commented_at_2018-11-22_1737" title="Permanent link">&para;</a></h4>
<p>@jsmeix<br />
Just for a record, I guess you've meant:</p>
<pre><code>-  cat &lt; $TARGET_FS_ROOT/etc/selinux/fixfiles_exclude_dirs &lt;&lt;EOF
+  cat &gt; $TARGET_FS_ROOT/etc/selinux/fixfiles_exclude_dirs &lt;&lt;EOF
$target_esp_mountpoint
$target_esp_mountpoint(/.*)?
EOF
</code></pre>
<p>V.</p>
<h4 id="jsmeix_commented_at_2018-11-23_0806"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1977#issuecomment-441175204">2018-11-23 08:06</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-11-23_0806" title="Permanent link">&para;</a></h4>
<p>@gozora<br />
of course it must be<br />
<code>cat &gt; $TARGET_FS_ROOT/etc/selinux/fixfiles_exclude_dirs &lt;&lt;EOF</code><br />
(I fixed it in my comments above).</p>
<p>For the (not so) fun of it:<br />
The reason for the typo was that I use <code>&lt;pre&gt; ... &lt;/pre&gt;</code><br />
for preformatted text blocks but within <code>&lt;pre&gt; ... &lt;/pre&gt;</code><br />
one cannot use <code>&lt;</code> or <code>&gt;</code> literally because they are reserverd HTML
charaters<br />
so that to display <code>&lt;</code> or <code>&gt;</code> one must use their HTML entities <code>&amp;lt;</code>
and <code>&amp;gt;</code><br />
and I had accidentally used <code>&amp;lt;</code> for <code>&gt;</code> instead of <code>&amp;gt;</code> but now I
learned<br />
that I can also use three backticks <code>```</code> and even how to
display backticks<br />
as backticks by having them in backticks plus leading and trailing
spaces,<br />
it's just so easy to simply write Markdown that even shows plain ASCII
text<br />
(braindead modern world)...</p>
<h4 id="gdha_commented_at_2018-11-26_0914"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/pull/1977#issuecomment-441568420">2018-11-26 09:14</a>:<a class="headerlink" href="#gdha_commented_at_2018-11-26_0914" title="Permanent link">&para;</a></h4>
<p>@schlomo are you fine with this PR?</p>
<h4 id="schlomo_commented_at_2018-11-26_1044"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/1977#issuecomment-441595442">2018-11-26 10:44</a>:<a class="headerlink" href="#schlomo_commented_at_2018-11-26_1044" title="Permanent link">&para;</a></h4>
<p>@gozora @gdha I cannot form an opinion as I am too far away from this
problem.</p>
<p>Just wondering, if the <code>fixfiles_exclude_dirs</code> file exists and does not
contain the ESP mount point, will the recovered system still work? Why
not simply inject/append the ESP there?</p>
<h4 id="jsmeix_commented_at_2018-11-26_1132"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1977#issuecomment-441608348">2018-11-26 11:32</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-11-26_1132" title="Permanent link">&para;</a></h4>
<p>Because this is only about to avoid SElinux relabeling the vfat
filesystem of the ESP<br />
my assumption was that it is "the right thing" to skip the actual action
in that script<br />
(which is creating etc/selinux/fixfiles_exclude_dirs file from
scratch)<br />
when any of the needed conditions is not met.</p>
<h4 id="gdha_commented_at_2018-11-26_1403"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/pull/1977#issuecomment-441649110">2018-11-26 14:03</a>:<a class="headerlink" href="#gdha_commented_at_2018-11-26_1403" title="Permanent link">&para;</a></h4>
<p>@gozora You can merge this PR from my point of view.</p>
<h4 id="rmetrich_commented_at_2019-04-10_0702"><img src="https://avatars.githubusercontent.com/u/1163635?u=36b5e32e1dd55f1ce77cad431a5683fce40a7934&v=4" width="50"><a href="https://github.com/rmetrich">rmetrich</a> commented at <a href="https://github.com/rear/rear/pull/1977#issuecomment-481561220">2019-04-10 07:02</a>:<a class="headerlink" href="#rmetrich_commented_at_2019-04-10_0702" title="Permanent link">&para;</a></h4>
<p>@gozora Sorry for the late wakeup, didn't see this until now, but adding
/boot/efi to exclusion list is not needed at all. Internally, SELinux's
<code>fixfiles</code> checks if the file system supports security labels, and VFAT
doesn't, so it never tries to relabel <code>/boot/efi</code>.</p>
<h4 id="gozora_commented_at_2019-04-10_0715"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/pull/1977#issuecomment-481565103">2019-04-10 07:15</a>:<a class="headerlink" href="#gozora_commented_at_2019-04-10_0715" title="Permanent link">&para;</a></h4>
<p>Hello @rmetrich,</p>
<p>Reading
<a href="https://github.com/rear/rear/issues/1972">https://github.com/rear/rear/issues/1972</a>,
this PR was mostly about correcting</p>
<pre><code>if ! test -d "$TARGET_FS_ROOT/boot/efi" ; then
    Error "Could not find directory $TARGET_FS_ROOT/boot/efi"
fi
</code></pre>
<p>whew
<a href="https://github.com/rear/rear/blob/master/usr/share/rear/restore/NETFS/Linux-i386/510_selinux_fixfiles_exclude_dirs.sh">510_selinux_fixfiles_exclude_dirs.sh</a>
runs.</p>
<p><em>/boot/efi</em> was part of
<code>$TARGET_FS_ROOT/etc/selinux/fixfiles_exclude_dirs</code> even before this PR
...</p>
<p>But honestly I did not spent much time hacking SELinux, so if you think
that <em>/boot/efi</em> is not needed in this list, feel free to update the
code ;-).</p>
<p>V.</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2025 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2018-11-21.1977.pr.merged.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/rear/rear-user-guide" class="fa fa-code-fork" style="color: #fcfcfc"> rear/rear-user-guide</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
