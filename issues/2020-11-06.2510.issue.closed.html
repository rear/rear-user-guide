<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#2510 Issue closed: R&amp;D: New 'storage' stage/code as future replacement of the 'layout' stage/code - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#2510 Issue closed: R\u0026amp;D: New \u0027storage\u0027 stage/code as future replacement of the \u0027layout\u0027 stage/code";
        var mkdocs_page_input_path = "issues/2020-11-06.2510.issue.closed.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/backup_netfs.html">Example of BACKUP=NETFS</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/netfs_nas.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../development/squash-git-log-commments.html">How to squash git log comments into one line</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear29.html">Release Notes ReaR 2.9</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear28.html">Release Notes ReaR 2.8</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#2510 Issue closed: R&amp;D: New 'storage' stage/code as future replacement of the 'layout' stage/code</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="2510_issue_closed_rd_new_storage_stagecode_as_future_replacement_of_the_layout_stagecode"><a href="https://github.com/rear/rear/issues/2510">#2510 Issue</a> <code>closed</code>: R&amp;D: New 'storage' stage/code as future replacement of the 'layout' stage/code<a class="headerlink" href="#2510_issue_closed_rd_new_storage_stagecode_as_future_replacement_of_the_layout_stagecode" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>enhancement</code>, <code>cleanup</code>, <code>discuss / RFC</code>,
<code>severe improvement</code>, <code>no-issue-activity</code></p>
<h4 id="jsmeix_opened_issue_at_2020-11-06_1420"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> opened issue at <a href="https://github.com/rear/rear/issues/2510">2020-11-06 14:20</a>:<a class="headerlink" href="#jsmeix_opened_issue_at_2020-11-06_1420" title="Permanent link">&para;</a></h4>
<p>The overall goal of a new 'storage' stage/code is to<br />
make "rear recover" behave reasonably dynamically<br />
depending on what there is on the replacement hardware<br />
and depending on how the replacement hardware behaves.</p>
<p>The current 'layout' stage/code works rather statically<br />
depending on what there is on the original system.<br />
What there is on the original system<br />
(like disks, partitions, volumes, filesystems, mountpoints)<br />
is stored as some parameter values into a disklayout.conf file.<br />
When "rear recover" runs on the replacement hardware<br />
it reads the disklayout.conf file contents and generates<br />
a diskrestore.sh script with basically static setup comands<br />
to recreate partitions, volumes, filesystems, mountpoints.<br />
Currently there is only some rather limited support when disk names
change.<br />
E.g. when /dev/sda on the original system becomes /dev/sdb on the
replacement hardware<br />
the same static setup comands get generated with /dev/sdb instead of
/dev/sda as parameter.<br />
But in general things fall apart during "rear recover" when the
replacement hardware<br />
is different and/or behaves different compared to the original system in
less predictable ways.<br />
A consequence of the current rather static dependancy on what there is
on the original system<br />
is that currently "rear recover" must run on fully compatible
replacement hardware.</p>
<p>The intent of the new 'storage' stage/code is not to make "rear
recover"<br />
'simply just work' even on arbitrarily different replacement hardware<br />
but the intent of the new 'storage' stage/code is to make "rear recover"
behave<br />
better (in particular more gracefully) on reasonably similar replacement
hardware.</p>
<p>I got the official SUSE task that starting next week<br />
I can spend a reasonable amount of my working time<br />
(cf.
<a href="https://github.com/rear/rear/issues/799#issuecomment-531247109">https://github.com/rear/rear/issues/799#issuecomment-531247109</a>
)<br />
to do research and development (R&amp;D) for a<br />
new 'storage' stage/code that is intended<br />
as future replacement of the 'layout' stage/code.</p>
<p>The topmost important driving issue behind is<br />
<a href="https://github.com/rear/rear/issues/2254">https://github.com/rear/rear/issues/2254</a><br />
"ReaR must work independent of kernel device names"</p>
<p>Another related driving goal behind is to improve ReaR for system
migrations<br />
when there are different kernel device names on the replacement
hardware<br />
e.g. from "usual" disks to NVMe disks or from hardware disks to virtual
disks<br />
(but not for advanced system migrations with a totally different disk
structure).</p>
<p>As long as the new 'storage' stage/code is under research and
development<br />
(which will likely take some years) the stable 'layout' stage/code will
still<br />
be actively maintained and still be used by default as described in<br />
<a href="https://github.com/rear/rear/issues/791#issuecomment-406513969">https://github.com/rear/rear/issues/791#issuecomment-406513969</a></p>
<p>When ReaR must work independent of kernel device names it means that
the<br />
kernel device names on the replacement hardware are no longer known in
advance.<br />
E.g. when the original system was on /dev/sda we can no longer assume<br />
there will be also a /dev/sda on the replacement hardware.</p>
<p>Simply put:<br />
Kernel device names on the replacement hardware are unpredictable.</p>
<p>When ReaR must work with unpredictable kernel device names it means
that<br />
it is no longer possible with reasonable effort to generate a
diskrestore.sh script<br />
from data in disklayout.conf (that is partially "old/outdated" data from
the original system)<br />
and then run that generated fixed/hardcoded diskrestore.sh script<br />
to create partitions/volumes/filesystems/mountpoints/...<br />
with a predefined static sequence of setup commands and parameters.</p>
<p>When ReaR must work with unpredictable kernel device names it means<br />
we must create partitions/volumes/filesystems just in time as needed
step by step<br />
based on some possibly "old/outdated" data from the original system<br />
that is more used as a guidance what to set up than as a strict
specification.</p>
<p>We can no longer rely on that a newly set up "strorage thingy" will
appear<br />
with a kernel device name that is known in advance.<br />
Instead we set up a new "strorage thingy" and then wait and see<br />
with what kernel device name that new "strorage thingy" appears.<br />
As a positive side-effect this new storage setup behaviour will solve<br />
<a href="https://github.com/rear/rear/issues/791">https://github.com/rear/rear/issues/791</a></p>
<p>Finally
<a href="https://github.com/rear/rear/issues/799">https://github.com/rear/rear/issues/799</a>
will also be implemented<br />
for the new 'storage' stage/code because it is needed as a
precondition<br />
for the new storage setup behaviour which must run on fully clean
disks<br />
where not any old leftover "strorage thingies" exist<br />
because when we want to wait and see with what kernel device name<br />
a new "strorage thingy" appears there must not be any old "strorage
thingies".</p>
<p>In the end the new storage setup behaviour should be the same<br />
as what an admin would do manually when he sets up a system from
scratch.<br />
So for an admin the new storage setup behaviour should be more
predictable<br />
because it should behave same as when he would set up things manually.</p>
<h4 id="jsmeix_commented_at_2020-11-12_1144"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2510#issuecomment-726027940">2020-11-12 11:44</a>:<a class="headerlink" href="#jsmeix_commented_at_2020-11-12_1144" title="Permanent link">&para;</a></h4>
<p>Regarding the above<br />
"[recreate] based on some possibly "old/outdated" data from the
original system<br />
that is more used as a guidance what to set up than as a strict
specification"<br />
see
<a href="https://github.com/rear/rear/pull/2514#issuecomment-725512823">https://github.com/rear/rear/pull/2514#issuecomment-725512823</a><br />
that reads (excerpts):</p>
<pre><code>When migrating from rotating rust disks to SSDs
new disk alignment is usually needed so that
the partition boundaries on the SSDs match the
phsyical "sector size" or "segment size" or "erase block size"
(i.e. the physical read/write unit size) of the SSD
which is 4 MiB or 8 MiB or even more on nowadays SSDs
cf. USB_PARTITION_ALIGN_BLOCK_SIZE in default.conf
https://github.com/rear/rear/blob/master/usr/share/rear/conf/default.conf#L853

So when migrating from rotating rust disks to SSDs
the partition begin values must be adapted to be
multiples of the physical read/write unit size of the SSD
i.e. multiples of 4 MiB or 8 MiB or even more.

So when migrating from rotating rust disks to SSDs
the partition begin values (that are usually multiples
of 1 MiB or less on rotating rust disks)
need to be shifted to multiples of 4 MiB or 8 MiB or more
which means in the end to recreate the disk partitions with an offset.

So an option to recreate the disk partitions with an offset
is needed anyway in ReaR and such an option can then
also be (mis)-used to avoid issues when recreating on a used disk
the same storage objects at exact same positions on the disk
(i.e. to avoid exact same positions when recreating
same storage objects)
in particular when recreating on the same hardware (i.e. when
the replacement hardware is the original system hardware).

Of course when we recreate the disk partitions with an offset
the next needed feature is to also adapt the sizes of nested
storage objects inside disk partitions like LVM volumes
which is yet another feature that we need since a long time
to make migration easier for the user.
</code></pre>
<p>But is is not always possible to change the size of a storage object<br />
so there must be some way for the user to specify which sizes<br />
could be changed and which sizes must be strictly kept.</p>
<p>In particular in some cases one cannot shrink the size at all<br />
(not even by a single byte) for example when the content is<br />
not stored as a usual backup of files but as some kind of<br />
"whole storage object image" e.g. a 'dd' of a partition<br />
in case of the BACKUP=BLOCKCLONE method, cf.<br />
<a href="https://github.com/rear/rear/blob/master/doc/user-guide/12-BLOCKCLONE.adoc">https://github.com/rear/rear/blob/master/doc/user-guide/12-BLOCKCLONE.adoc</a></p>
<h4 id="github-actions_commented_at_2021-01-12_0245"><img src="https://avatars.githubusercontent.com/in/15368?v=4" width="50"><a href="https://github.com/apps/github-actions">github-actions</a> commented at <a href="https://github.com/rear/rear/issues/2510#issuecomment-758357834">2021-01-12 02:45</a>:<a class="headerlink" href="#github-actions_commented_at_2021-01-12_0245" title="Permanent link">&para;</a></h4>
<p>Stale issue message</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2025 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2020-11-06.2510.issue.closed.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/rear/rear-user-guide" class="fa fa-code-fork" style="color: #fcfcfc"> rear/rear-user-guide</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
