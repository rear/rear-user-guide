<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#1385 PR merged: Do not recreate BOOTX64.efi, if Secure boot is enabled. - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#1385 PR merged: Do not recreate BOOTX64.efi, if Secure boot is enabled.";
        var mkdocs_page_input_path = "issues/2017-06-19.1385.pr.merged.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a> &raquo;</li>
      <li class="breadcrumb-item active">#1385 PR merged: Do not recreate BOOTX64.efi, if Secure boot is enabled.</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="1385_pr_merged_do_not_recreate_bootx64efi_if_secure_boot_is_enabled"><a href="https://github.com/rear/rear/pull/1385">#1385 PR</a> <code>merged</code>: Do not recreate BOOTX64.efi, if Secure boot is enabled.<a class="headerlink" href="#1385_pr_merged_do_not_recreate_bootx64efi_if_secure_boot_is_enabled" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>fixed / solved / done</code>, <code>minor bug</code></p>
<h4 id="gozora_opened_issue_at_2017-06-19_1332"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> opened issue at <a href="https://github.com/rear/rear/pull/1385">2017-06-19 13:32</a>:<a class="headerlink" href="#gozora_opened_issue_at_2017-06-19_1332" title="Permanent link">&para;</a></h4>
<p>If server have Secure Boot enabled, ReaR should not try to create boot
loader (BL) for recovery system (which is handy in other cases). As we
are not able to sign it, it will be refused by Secure Boot.</p>
<p>This patch just skips ReaRs attempt to create BL and uses original
shipped with OS.</p>
<p>c.f.
<a href="https://github.com/rear/rear/issues/1374">https://github.com/rear/rear/issues/1374</a></p>
<h4 id="jsmeix_commented_at_2017-06-20_0819"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1385#issuecomment-309679964">2017-06-20 08:19</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-06-20_0819" title="Permanent link">&para;</a></h4>
<p>@gozora<br />
a side note to be perhaps more future proof:<br />
Currently (also in output/ISO/Linux-i386/250_populate_efibootimg.sh)<br />
the following test is used</p>
<pre>
if [[ $(basename ${UEFI_BOOTLOADER}) = shim.efi ]]; then
</pre>

<p>to do "the right things" in case of Secure Boot.<br />
I wonder about the hardcoded fixed file name 'shim.efi'.<br />
Can we assume with sufficiently high probability that<br />
the properly signed bootloader for Secure Boot will<br />
be in a file named 'shim.efi' or should we do some<br />
guesswork to find it under different file names too<br />
or even add a config variable like<br />
SECURE_BOOT_BOOTLOADER="shim.efi"<br />
so that the user can specify - if needed - his actually<br />
used bootloader for Secure Boot?<br />
( Hint: "Arch Linux" ;-)</p>
<h4 id="gozora_commented_at_2017-06-20_0915"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/pull/1385#issuecomment-309694405">2017-06-20 09:15</a>:<a class="headerlink" href="#gozora_commented_at_2017-06-20_0915" title="Permanent link">&para;</a></h4>
<p>Hello @jsmeix,</p>
<p>Reading
<a href="https://github.com/rear/rear/blob/master/usr/share/rear/rescue/default/850_save_sysfs_uefi_vars.sh">850_save_sysfs_uefi_vars.sh</a>,
<em>shim.efi</em> just can't be guessed by ReaR so user must set
<strong>UEFI_BOOTLOADER</strong> variable (otherwise Secure Boot will not work).<br />
At this stage I'm not sure how guessing could be done, because as you've
mentioned <em>shim.efi</em> is not a constant and can be arbitrary named.</p>
<p>I personally would let user to decide ...</p>
<p>V.</p>
<h4 id="gdha_commented_at_2017-06-20_0931"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/pull/1385#issuecomment-309698529">2017-06-20 09:31</a>:<a class="headerlink" href="#gdha_commented_at_2017-06-20_0931" title="Permanent link">&para;</a></h4>
<p>@gozora I fully agree with you</p>
<h4 id="schlomo_commented_at_2017-06-20_0937"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/1385#issuecomment-309700064">2017-06-20 09:37</a>:<a class="headerlink" href="#schlomo_commented_at_2017-06-20_0937" title="Permanent link">&para;</a></h4>
<p>Why can't we read the current boot configuration? Like this:</p>
<pre><code>$ sudo efibootmgr -v
BootCurrent: 0000
Timeout: 2 seconds
BootOrder: 0000,001A,001B,001C,0017,0018,0019
Boot0000* ubuntu    HD(1,GPT,f8dd62b6-355c-4843-b6f0-3fc9b07f29f2,0x800,0x1e8000)/File(\EFI\ubuntu\shimx64.efi)
Boot0010  Setup FvFile(721c8b66-426c-4e86-8e99-3457c46ab0b9)
Boot0011  Boot Menu FvFile(126a762d-5758-4fca-8531-201a7f57f850)
Boot0012  Diagnostic Splash Screen  FvFile(a7d8d9a6-6ab0-4aeb-ad9d-163e59a7a380)
Boot0013  Lenovo Diagnostics    FvFile(3f7e615b-0d45-4f80-88dc-26b234958560)
Boot0014  Startup Interrupt Menu    FvFile(f46ee6f4-4785-43a3-923d-7f786c3c8479)
Boot0015  Rescue and Recovery   FvFile(665d3f60-ad3e-4cad-8e26-db46eee9f1b5)
Boot0016  MEBx Hot Key  FvFile(ac6fd56a-3d41-4efd-a1b9-870293811a28)
Boot0017* USB CD    VenMsg(bc7838d2-0f82-4d60-8316-c068ee79d25b,86701296aa5a7848b66cd49dd3ba6a55)
Boot0018* USB FDD   VenMsg(bc7838d2-0f82-4d60-8316-c068ee79d25b,6ff015a28830b543a8b8641009461e49)
Boot0019* NVMe0 VenMsg(bc7838d2-0f82-4d60-8316-c068ee79d25b,001c199932d94c4eae9aa0b6e98eb8a400)
Boot001A* ATA HDD0  VenMsg(bc7838d2-0f82-4d60-8316-c068ee79d25b,91af625956449f41a7b91f4f892ab0f600)
Boot001B* USB HDD   VenMsg(bc7838d2-0f82-4d60-8316-c068ee79d25b,33e821aaaf33bc4789bd419f88c50803)
Boot001C* PCI LAN   VenMsg(bc7838d2-0f82-4d60-8316-c068ee79d25b,78a84aaf2b2afc4ea79cf5cc8f3d3803)
Boot001D* IDER BOOT CDROM   PciRoot(0x0)/Pci(0x16,0x2)/Ata(0,1,0)
Boot001E* IDER BOOT Floppy  PciRoot(0x0)/Pci(0x16,0x2)/Ata(0,0,0)
Boot001F* ATA HDD   VenMsg(bc7838d2-0f82-4d60-8316-c068ee79d25b,91af625956449f41a7b91f4f892ab0f6)
Boot0020* ATAPI CD  VenMsg(bc7838d2-0f82-4d60-8316-c068ee79d25b,aea2090adfde214e8b3a5e471856a354)
</code></pre>
<p>And from there we see which file is used on the source system and simply
use that also for ReaR and put it back after recovery.</p>
<h4 id="gozora_commented_at_2017-06-20_1029"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/pull/1385#issuecomment-309712392">2017-06-20 10:29</a>:<a class="headerlink" href="#gozora_commented_at_2017-06-20_1029" title="Permanent link">&para;</a></h4>
<p>@schlomo I was thinking about this approach in the past.<br />
However, UEFI is so variable that even <code>efibootmgr</code> don't need to
display right values.<br />
Problem is that your system might be booted from <em>EFI shell</em> (either
automatically or with help of <em>startup.nsh</em>) so that would mean
additional parsing or searching UEFI firmware for correct values.<br />
IMHO this could become quite a hell to maintain.</p>
<p>V.</p>
<h4 id="jsmeix_commented_at_2017-06-20_1114"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1385#issuecomment-309721854">2017-06-20 11:14</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-06-20_1114" title="Permanent link">&para;</a></h4>
<p>Perhaps I confuse something here but assume<br />
for a particular user the bootloader for Secure Boot<br />
is in a file named 'mysignedbootloader'<br />
and the user specified that with<br />
UEFI_BOOTLOADER=/boot/efi/EFI/mysignedbootloader<br />
then I wonder how the test for the hardcoded 'shim.efi'<br />
would work?</p>
<h4 id="gdha_commented_at_2017-06-20_1116"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/pull/1385#issuecomment-309722359">2017-06-20 11:16</a>:<a class="headerlink" href="#gdha_commented_at_2017-06-20_1116" title="Permanent link">&para;</a></h4>
<p>@jsmeix if you know how to sign your own UEFI bootloader then you can do
what you want - it is not that hard, but is IMHO out-of-scope for ReaR
recovery</p>
<h4 id="gdha_commented_at_2017-06-20_1120"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/pull/1385#issuecomment-309723182">2017-06-20 11:20</a>:<a class="headerlink" href="#gdha_commented_at_2017-06-20_1120" title="Permanent link">&para;</a></h4>
<p>@schlomo the <code>efibootmgr</code> is a crappy piece of software - years ago when
I implemented the UEFI boot stuff it gave me lost of issues.<br />
I fully agree with @gozora that sometimes the user knows best what to
do. The only thing that we might foresee is a better explanation in the
default.conf file perhaps?</p>
<h4 id="jsmeix_commented_at_2017-06-20_1121"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1385#issuecomment-309723307">2017-06-20 11:21</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-06-20_1121" title="Permanent link">&para;</a></h4>
<p>@gdha<br />
look at what @schlomo wrote above in his<br />
<a href="https://github.com/rear/rear/pull/1385#issuecomment-309700064">https://github.com/rear/rear/pull/1385#issuecomment-309700064</a><br />
(excerpt)</p>
<pre>
Boot0000* ubuntu ... /File(\EFI\ubuntu\shimx64.efi)
</pre>

<p>which seems to indicate that on Ubuntu the<br />
bootloader for Secure Boot is in a file named 'shimx64.efi'<br />
so that - if I understand @gozora<br />
<a href="https://github.com/rear/rear/pull/1385#issuecomment-309694405">https://github.com/rear/rear/pull/1385#issuecomment-309694405</a><br />
correctly the user would have to specify it like</p>
<pre>
UEFI_BOOTLOADER=/boot/EFI/ubuntu/shimx64.efi
</pre>

<p>and then</p>
<pre>
if [[ $(basename ${UEFI_BOOTLOADER}) = shim.efi ]]; then
</pre>

<p>would not match.</p>
<h4 id="gdha_commented_at_2017-06-20_1126"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/pull/1385#issuecomment-309724340">2017-06-20 11:26</a>:<a class="headerlink" href="#gdha_commented_at_2017-06-20_1126" title="Permanent link">&para;</a></h4>
<p>@jsmeix I think that rear will pick this up automatically? @gozora Can
you confirm this? I don't use UEFI anymore myself.</p>
<h4 id="gozora_commented_at_2017-06-20_1139"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/pull/1385#issuecomment-309727248">2017-06-20 11:39</a>:<a class="headerlink" href="#gozora_commented_at_2017-06-20_1139" title="Permanent link">&para;</a></h4>
<p>Actually @jsmeix is right!<br />
If something else than <em>shim.efi</em> is used, problems might occur again.<br />
So introducing SECURE_BOOT_BOOTLOADER and removing "shim.efi" from
code is a good idea!</p>
<p>V.</p>
<h4 id="schlomo_commented_at_2017-06-20_1147"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/1385#issuecomment-309728890">2017-06-20 11:47</a>:<a class="headerlink" href="#schlomo_commented_at_2017-06-20_1147" title="Permanent link">&para;</a></h4>
<p>Good point about the fact that UEFI allows also other boot methods. IMHO
we should try our best guess that works automagically for systems there
where set up without manual customizing (like my laptop here).
Additionally we should allow manual configuration via variables for
those cases where the automagic mode did not work.</p>
<h4 id="gozora_commented_at_2017-06-20_1203"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/pull/1385#issuecomment-309732248">2017-06-20 12:03</a>:<a class="headerlink" href="#gozora_commented_at_2017-06-20_1203" title="Permanent link">&para;</a></h4>
<p>@schlomo</p>
<blockquote>
<p>IMHO we should try our best guess that works automagically for systems
there where set up without manual customizing (like my laptop here).
Additionally we should allow manual configuration via variables for
those cases where the automagic mode did not work.</p>
</blockquote>
<p>I guess this is something we already have in place ;-). I personally
like current UEFI implementation.</p>
<p>@schlomo, @jsmeix, @gdha<br />
So everybody OK with introducing <strong>SECURE_BOOT_BOOTLOADER</strong> in
<em>default.conf</em> ?<br />
If so, I'd update my PR later today ...</p>
<p>V.</p>
<h4 id="schlomo_commented_at_2017-06-20_1204"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/1385#issuecomment-309732418">2017-06-20 12:04</a>:<a class="headerlink" href="#schlomo_commented_at_2017-06-20_1204" title="Permanent link">&para;</a></h4>
<p>üëç</p>
<h4 id="jsmeix_commented_at_2017-06-20_1301"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1385#issuecomment-309745815">2017-06-20 13:01</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-06-20_1301" title="Permanent link">&para;</a></h4>
<p>I always like to have config variables for basically everything, cf.<br />
<a href="https://github.com/rear/rear/pull/1204#issuecomment-282252947">https://github.com/rear/rear/pull/1204#issuecomment-282252947</a><br />
<a href="https://github.com/rear/rear/issues/1213#issuecomment-285618629">https://github.com/rear/rear/issues/1213#issuecomment-285618629</a></p>
<h4 id="jsmeix_commented_at_2017-06-21_0753"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1385#issuecomment-309993107">2017-06-21 07:53</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-06-21_0753" title="Permanent link">&para;</a></h4>
<p>@gozora<br />
I fear I am a pain in your neck when I write this<br />
but I think it is better when I tell about my thoughts.<br />
In the end it is your code and you make the final decision<br />
what the best way is how to implement it.</p>
<p>For me without background knowledge plain looking at</p>
<pre>
UEFI_BOOTLOADER="/boot/efi/EFI/BOOT/shim.efi"
SECURE_BOOT_BOOTLOADER="shim.efi"
</pre>

<p>looks somewhat intricate and/or overcomplicated<br />
so that I wonder if it really must be this way.</p>
<p>When I see that I think something like<br />
"Why does one need to specify 'shim.efi' twice?<br />
Why does not only something like this</p>
<pre>
SECURE_BOOT_BOOTLOADER="/boot/efi/EFI/BOOT/shim.efi"
</pre>

<p>work?<br />
Why is UEFI_BOOTLOADER a full path but<br />
SECURE_BOOT_BOOTLOADER is only a file name?"</p>
<p>I would expect that when SECURE_BOOT_BOOTLOADER<br />
is non-empty, it means Secure Boot is used and<br />
then SECURE_BOOT_BOOTLOADER specifies the<br />
full path to the right (signed) Secure Boot bootloader.</p>
<p>In this case the tests could be simplified to something like</p>
<pre>
if test -e "$SECURE_BOOT_BOOTLOADER" ; then
</pre>

<p>and the build_bootx86_efi call might be even simplified to</p>
<pre>
test -e "$SECURE_BOOT_BOOTLOADER" || build_bootx86_efi
</pre>

<p>Perhaps additionally something like</p>
<pre>
if test -e "$SECURE_BOOT_BOOTLOADER" ; then
    UEFI_BOOTLOADER="$SECURE_BOOT_BOOTLOADER"
fi
</pre>

<p>is also needed because Secure Boot implies UEFI.</p>
<p>Or alternatively when SECURE_BOOT_BOOTLOADER is<br />
specified UEFI_BOOTLOADER can be used to specify<br />
the payload of the Secure Boot bootloader?</p>
<p>Because in the curent code I notice another semi-hardcoded<br />
filename 'grub*.efi':</p>
<pre>
    # if shim is used, bootloader can be actually anything
    # named as grub*.efi (follow-up loader is shim compile time option)
    # http://www.rodsbooks.com/efi-bootloaders/secureboot.html#initial_shim
    cp $v $(dirname ${UEFI_BOOTLOADER})/grub*.efi $TMP_DIR/mnt/EFI/BOOT/ >&2
</pre>

<p>I guess "follow-up loader" means the payload of shim.<br />
As far as I know the payload of shim can be anything<br />
so that it might be good when ReaR is prepared to be able<br />
to copy any shim payload into the recovery system<br />
via something like</p>
<pre>
if test -e "$SECURE_BOOT_BOOTLOADER" ; then
    # When SECURE_BOOT_BOOTLOADER is specified
    # the Secure Boot bootloader is shim.
    # When shim is used the shim payload
    # must be copied into the recovery system.
    # The shim payload is a shim compile-time setting, see
    # http://www.rodsbooks.com/efi-bootloaders/secureboot.html#initial_shim
    # Usually the shim payload is a follow-up bootloader
    # which is usually a file named grub*.efi
    # so that we use this as default for the shim payload:
    shim_payload=$( dirname ${SECURE_BOOT_BOOTLOADER} )/grub*.efi
    # When SECURE_BOOT_BOOTLOADER is specified
    # UEFI_BOOTLOADER can be used to explicitly
    # specify the shim payload file:
    test -e "$UEFI_BOOTLOADER" && shim_payload=$UEFI_BOOTLOADER
    cp $v $shim_payload $TMP_DIR/mnt/EFI/BOOT/ >&2
fi
</pre>

<h4 id="gozora_commented_at_2017-06-21_0824"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/pull/1385#issuecomment-310004453">2017-06-21 08:24</a>:<a class="headerlink" href="#gozora_commented_at_2017-06-21_0824" title="Permanent link">&para;</a></h4>
<p>@jsmeix</p>
<blockquote>
<p>I fear I am a pain in your neck when I write this</p>
</blockquote>
<p>No, you are not!</p>
<p>I like your idea. At the end we would have basically two *_BOOTLOADER
variables.</p>
<ol>
<li>UEFI_BOOTLOADER</li>
<li>SECURE_BOOT_BOOTLOADER</li>
</ol>
<p>If <em>SECURE_BOOT_BOOTLOADER</em> is set, <em>UEFI_BOOTLOADER</em> will be
overwritten by value of <em>SECURE_BOOT_BOOTLOADER</em> (hope I've understood
it right)</p>
<p>That is indeed much simpler to understand!</p>
<p>Thanks for your inputs</p>
<p>I'll update PR later today.</p>
<p>V.</p>
<h4 id="schlomo_commented_at_2017-06-21_0839"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/1385#issuecomment-310008735">2017-06-21 08:39</a>:<a class="headerlink" href="#schlomo_commented_at_2017-06-21_0839" title="Permanent link">&para;</a></h4>
<p>Maybe I missed a point somewhere. After reading all this I have one main
question:</p>
<p>Why do we need <strong>two</strong> variables? In the end, we can only configure
<strong>one</strong> EFI program to be loaded by the EFI firmware, so why two inputs
leading to one output?</p>
<p>Specifically, if we faithfully replicate the boot scripts, EFI programs
etc. of the source system then it should be - in my simple world view -
enough to put the original EFI program back into the firmware and
everything else should be as before.</p>
<p>So if the source OS used shim.efi or shimx64,efi then we put that back.
If it used grubx86.efi or systemd-bootx64.efi then we put that back into
the EFI firmware. As long as we restored the EFI partition to its
original state everything else should also work.</p>
<p>So the question is, why not simply have one variable named
UEFI_BOOTLOADER which also supports secure boot if needed. As different
distros use different signed boot files (Arch uses PreLoader.efi, Ubuntu
and others shim ...) we probably have to keep our code sufficiently
generic in any case.</p>
<p>If I understand this PR in its original intention it was to stop
recreating boot files and using the existing ones that where part of the
source system. I also think that this is the right approach wherever
possible.</p>
<p>Maybe the original author (@gdha ?) of the secure boot implementation
can fill in why we needed to recreate EFI files in the beginning and
what prevented using the existing files.</p>
<p>Another aspect we should keep in mind: Custom Machine Owner Keys. I am
not sure if we can properly automate that and I wonder who in the real
world (e.g. large setups) actually does that. In any case I can easily
imagine that prepping the replacement hardware with custom MoKs is out
of scope for ReaR.</p>
<p>With regard to merging this PR: IMHO those with access to secure boot
enabled hardware <strong>and</strong> the time to test it should have a say, which
unfortunately excludes myself ATM.</p>
<h4 id="jsmeix_commented_at_2017-06-21_0909"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1385#issuecomment-310017524">2017-06-21 09:09</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-06-21_0909" title="Permanent link">&para;</a></h4>
<p>I think for Secure Boot we always need two config variables:</p>
<p>One config variable to specify the initial bootloader which is<br />
usually GRUB2 for UEFI without Secure Boot<br />
and shim for UEFI with Secure Boot.</p>
<p>For Secure Boot we need a second config variable<br />
to specify the payload file for shim which<br />
also must be copied into the recovery system.</p>
<p>It is crucial that many config variables do not necessarily mean<br />
that the user must specify all of them in any case.</p>
<p>Ideally all "just works" automatically "out of the box".</p>
<p>In this case ReaR would automatically find out<br />
what the initial bootloader is<br />
whether or not Secure Boot is used and<br />
when Secure Boot is used what the shim payload is.</p>
<p>For me the main purpose and advantage of config variables<br />
in contrast to hardcoded values hidden somewhere in the code<br />
is that when things do not work automatically the user can<br />
specify the config variable values to make things work for him.</p>
<p>This results two advantages for the ReaR developers<br />
and for the ReaR users:</p>
<ol>
<li></li>
</ol>
<p>Initially the implementation can be simple because<br />
no automatisms need to be implemented right from the start.<br />
This way ReaR can support things initially in a manual way<br />
where the user must specify the config variable values<br />
to make it work.<br />
Over time when we learn more and more how to do things<br />
automatically more and more automatisms can be added<br />
to make thinks more and more work automatically.</p>
<ol>
<li></li>
</ol>
<p>When things do not work automatically (i.e. when a user<br />
submits a GitHub issue) we can easily and quickly help<br />
the user by explaining how he can manually specify<br />
appropriate config variable values to make things<br />
work for him.</p>
<h4 id="schlomo_commented_at_2017-06-21_0916"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/1385#issuecomment-310019944">2017-06-21 09:16</a>:<a class="headerlink" href="#schlomo_commented_at_2017-06-21_0916" title="Permanent link">&para;</a></h4>
<p>Thank you @jsmeix for pointing out the part I missed: This is all about
how the rescue system can boot.</p>
<p>Maybe this is yet another case where the code would be much simpler if
we could limit support to systemd booting. I know, I keep dreaming about
a new rear major version that does away with all the old stuff. As only
recent distros support Secure Boot this actually does sound like a great
candidate.</p>
<p>Nevertheless, I stay by my own words. Those who know and can test should
decide on the PR.</p>
<h4 id="gdha_commented_at_2017-06-21_0921"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/pull/1385#issuecomment-310021518">2017-06-21 09:21</a>:<a class="headerlink" href="#gdha_commented_at_2017-06-21_0921" title="Permanent link">&para;</a></h4>
<p>@schlomo As far as I can remember (and it has been a while ago - years)
the original code main concern was to get the ISO image UEFI aware and
therefore, I needed to recreate the EFI image (I think). For the rest it
was a pure restore of the <code>/boot/efi</code> vfat directory.<br />
Furthermore, afterwards the local grub entry came along (which was wrong
to implement IMHO), which made things only complicated.<br />
We should stick to the essence and bare minimum: recover the OS and
nothing more and hopefully get it bootable again.<br />
My brains are not big enough to understand why we need 2 variables, but
I'm not the authority on UEFI anymore (as I removed it from all my
systems).</p>
<h4 id="jsmeix_commented_at_2017-06-21_0937"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1385#issuecomment-310025616">2017-06-21 09:37</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-06-21_0937" title="Permanent link">&para;</a></h4>
<p>Only a side note FYI:<br />
Because I am also dreaming about a new ReaR major version<br />
that does away with all the old stuff so that I did now<br />
<a href="https://github.com/rear/rear/issues/1390">https://github.com/rear/rear/issues/1390</a></p>
<h4 id="jsmeix_commented_at_2017-06-21_0954"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1385#issuecomment-310029675">2017-06-21 09:54</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-06-21_0954" title="Permanent link">&para;</a></h4>
<p>@gozora<br />
could it perhaps avoid most issues if by default the whole<br />
/boot/efi/ content gets copied into the recovery system<br />
plus a config variable to specify the initial bootloader<br />
(or more general: the file to be loaded by the EFI firmware)?</p>
<p>But even then I think we still need two config variables:<br />
One to specify the file to be loaded by the EFI firmware and<br />
another one (probably an array) to specify what EFI files<br />
should be copied into the recovery system (by default /boot/efi/).</p>
<h4 id="gozora_commented_at_2017-06-21_1059"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/pull/1385#issuecomment-310043638">2017-06-21 10:59</a>:<a class="headerlink" href="#gozora_commented_at_2017-06-21_1059" title="Permanent link">&para;</a></h4>
<p>@jsmeix</p>
<blockquote>
<p>could it perhaps avoid most issues if by default the whole<br />
/boot/efi/ content gets copied into the recovery system<br />
plus a config variable to specify the initial bootloader<br />
(or more general: the file to be loaded by the EFI firmware)?</p>
</blockquote>
<p>We basically could. But we would need to count on fact that users might
need to have some basic UEFI knowledge to manually trigger boot
loader.<br />
Reason why current UEFI code might look complicated is because we are
trying to ensure that boot loader is always launched and all the user
have to do, is press enter to boot.<br />
If you ask me, this is what first 'R' stands for in ReaR ;-)</p>
<p>@schlomo<br />
What do you mean by systemd booting? I've heard about it here somewhere
but not sure what is suppose to be?</p>
<p>V.</p>
<h4 id="schlomo_commented_at_2017-06-21_1110"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/1385#issuecomment-310045988">2017-06-21 11:10</a>:<a class="headerlink" href="#schlomo_commented_at_2017-06-21_1110" title="Permanent link">&para;</a></h4>
<p>@gozora
<a href="https://wiki.archlinux.org/index.php/systemd-boot">https://wiki.archlinux.org/index.php/systemd-boot</a>
has a good introduction. I tried it and loved on first sight. Reduced to
the absolute minimum needed for booting on EFI. Also handles the EFI
firmware. Really nice CLI interface. Basically the quality you know from
systemd applied to EFI booting.</p>
<h4 id="gozora_commented_at_2017-06-21_1122"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/pull/1385#issuecomment-310048908">2017-06-21 11:22</a>:<a class="headerlink" href="#gozora_commented_at_2017-06-21_1122" title="Permanent link">&para;</a></h4>
<p>@schlomo it basically looks like kernel efistub.<br />
Since I works with UEFI I still did not decided if omitting grub is good
or bad idea ...</p>
<h4 id="schlomo_commented_at_2017-06-21_1146"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/1385#issuecomment-310053719">2017-06-21 11:46</a>:<a class="headerlink" href="#schlomo_commented_at_2017-06-21_1146" title="Permanent link">&para;</a></h4>
<p>Yes, systemd-boot can only load other EFI programs. It provides a simple
menu that you can configure in Linux and that allows you to add kernel
parameters on the fly. If you never need to do that then you can also
use efistub directly.</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2023 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2017-06-19.1385.pr.merged.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
