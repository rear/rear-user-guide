<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>2017 12 12.1644.issue.closed - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "2017 12 12.1644.issue.closed";
        var mkdocs_page_input_path = "issues/2017-12-12.1644.issue.closed.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/rust.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', '366986045', 'auto');
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a> &raquo;</li>
      <li>2017 12 12.1644.issue.closed</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="1644_issue_closed_serial_ttys0_respawns_continuously_on_a_vm_without_a_serial_console"><a href="https://github.com/rear/rear/issues/1644">#1644 Issue</a> <code>closed</code>: Serial ttyS0 respawns continuously on a VM without a serial console<a class="headerlink" href="#1644_issue_closed_serial_ttys0_respawns_continuously_on_a_vm_without_a_serial_console" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>bug</code>, <code>fixed / solved / done</code>, <code>blocker</code></p>
<h4 id="gdha_opened_issue_at_2017-12-12_1535"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> opened issue at <a href="https://github.com/rear/rear/issues/1644">2017-12-12 15:35</a>:<a class="headerlink" href="#gdha_opened_issue_at_2017-12-12_1535" title="Permanent link">&para;</a></h4>
<ul>
<li>rear version (/usr/sbin/rear -V): 2.3pre (frozen)</li>
<li>OS version (cat /etc/rear/os.conf or lsb_release -a): ubuntu 16 /
    fedora26</li>
<li>Are you using legacy BIOS or UEFI boot? BIOS</li>
<li>Brief description of the issue: after applying PR
    <a href="https://github.com/rear/rear/pull/1615">https://github.com/rear/rear/pull/1615</a>
    we see issues with serial ttyS0 on ubuntu16 and with fedora26</li>
</ul>
<p><strong>fedora 26</strong> had the following issue with a recover VM that contains a
serial console (libvirt)(timeout after a couple of minutes), but
afterwards everything seems normal:<br />
<img alt="screenshot_rear-recover-kvm_2017-12-12_16 02
53" src="https://user-images.githubusercontent.com/888633/33891541-8417c5de-df56-11e7-8725-c6ff4d601bc6.png" /></p>
<p><strong>fedora26</strong> <em>without</em> a serial console has the following problem:</p>
<pre><code>Dec 12 15:23:37 fedora agetty[525]: /dev/ttyS0: not a tty
Dec 12 15:23:40 fedora kernel: random: crng init done
Dec 12 15:23:47 fedora systemd[1]: Received SIGCHLD from PID 525 (agetty).
Dec 12 15:23:47 fedora systemd[1]: Child 525 (agetty) died (code=exited, status=1/FAILURE)
Dec 12 15:23:47 fedora systemd[1]: serial-getty@ttyS0.service: Child 525 belongs to serial-getty@ttyS0.service
Dec 12 15:23:47 fedora systemd[1]: serial-getty@ttyS0.service: Main process exited, code=exited, status=1/FAILURE
Dec 12 15:23:47 fedora systemd[1]: serial-getty@ttyS0.service: Changed running -&gt; dead
Dec 12 15:23:47 fedora systemd[1]: serial-getty@ttyS0.service: Changed dead -&gt; auto-restart
Dec 12 15:23:47 fedora systemd[1]: serial-getty@ttyS0.service: Service has no hold-off time, scheduling restart.
Dec 12 15:23:47 fedora systemd[1]: serial-getty@ttyS0.service: Trying to enqueue job serial-getty@ttyS0.service/restart/fail
Dec 12 15:23:47 fedora systemd[1]: serial-getty@ttyS0.service: Installed new job serial-getty@ttyS0.service/restart as 39
Dec 12 15:23:47 fedora systemd[1]: serial-getty@ttyS0.service: Enqueued job serial-getty@ttyS0.service/restart as 39
Dec 12 15:23:47 fedora systemd[528]: serial-getty@ttyS0.service: Executing: /sbin/agetty -s ttyS0 115200,38400,9600
Dec 12 15:23:47 fedora agetty[528]: /dev/ttyS0: not a tty
</code></pre>
<p><strong>ubuntu 16.04</strong> : The serial ttyS0 is getting re-spawned continuously.
The test VM has no serial ttyS0 defined (in virtual box). We see the
same messages as we saw in fedora26.</p>
<p>Has to do with #878 and PR #1615 - @didacog is aware of the issue and
is looking into it.</p>
<h4 id="gdha_commented_at_2017-12-13_0858"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/issues/1644#issuecomment-351326142">2017-12-13 08:58</a>:<a class="headerlink" href="#gdha_commented_at_2017-12-13_0858" title="Permanent link">&para;</a></h4>
<p>Document
<a href="https://serverfault.com/questions/736624/systemd-service-automatic-restart-after-startlimitinterval">https://serverfault.com/questions/736624/systemd-service-automatic-restart-after-startlimitinterval</a>
contains some useful info to improve the situation IMHO</p>
<h4 id="didacog_commented_at_2017-12-13_1057"><img src="https://avatars.githubusercontent.com/u/5380209?u=163f1571e6b9c9c7df94e2c6ca152b0a7406b52d&v=4" width="50"><a href="https://github.com/didacog">didacog</a> commented at <a href="https://github.com/rear/rear/issues/1644#issuecomment-351357037">2017-12-13 10:57</a>:<a class="headerlink" href="#didacog_commented_at_2017-12-13_1057" title="Permanent link">&para;</a></h4>
<p>@gdha</p>
<p>I've already tested with StartLimitBurst but it not worked in my test,
I'll try with more effort if works.<br />
Nevertheless I tested with <strong>Restart=no</strong> and it worked fine, with
serial port started OK and without serial no errors in journal and the
service is not present in systemctl status output. (with ubuntu 16.04 in
virtualbox)</p>
<p>Tomorrow I will test it on real HW with RHEL7.2</p>
<p>On the other hand I've detected that, at the recovery boot process, the
serial console has no output in last steps, and with
Before=getty.service configured you get the serial console prompt before
the whole process ends. But if not this way, with After=getty.service if
you are only connected to the serial the wait is long and seems it
hanged.</p>
<p>What option seems better in your opinion?<br />
IMHO I prefer getting a fast login prompt, maybe is possible to put some
warning to check if finished before run rear recover or better, if
possible, mirror the ouptut form serial and console :P.</p>
<p>Regards,</p>
<h4 id="didacog_commented_at_2017-12-13_1825"><img src="https://avatars.githubusercontent.com/u/5380209?u=163f1571e6b9c9c7df94e2c6ca152b0a7406b52d&v=4" width="50"><a href="https://github.com/didacog">didacog</a> commented at <a href="https://github.com/rear/rear/issues/1644#issuecomment-351478873">2017-12-13 18:25</a>:<a class="headerlink" href="#didacog_commented_at_2017-12-13_1825" title="Permanent link">&para;</a></h4>
<p>Hi again, I found a cleaner solution than <strong>Restart=no</strong>.</p>
<p>/usr/share/rear/skel/default/usr/lib/systemd/system/serial-getty@.service</p>
<pre>
#  This file is part of systemd.
#
[Unit]
Description=Serial Getty on %I
BindTo=dev-%i.device
After=dev-%i.device

# We must wait for ReaR boot script to finish.
# this prevents the login serial prompt to
# be ready before the whole recovery boot process is done
After=getty.target


[Service]
Environment=TERM=vt100
ExecStart=-/sbin/agetty -s %I 115200,38400,9600
Restart=on-failure
RestartSec=0
StartLimitAction=none
StartLimitBurst=3
StartLimitInterval=60
UtmpIdentifier=%I
KillMode=process


# Some login implementations ignore SIGTERM, so we send SIGHUP
# instead, to ensure that login terminates cleanly.
KillSignal=SIGHUP

[Install]
WantedBy=getty.target
</pre>

<p>The key is <strong>Restart=</strong> action, now is on-failure (see this:
<a href="https://www.freedesktop.org/software/systemd/man/systemd.service.html">https://www.freedesktop.org/software/systemd/man/systemd.service.html</a>)
and in case of failure will use StartLimit* settings ( finally worked
after some attemtps :P ). This prevents restarts of the serial if not
present, and also aviods weird messages in console like "... Failed to
start getty on ttyS0 ..." when StartLimitInterval is reached and no more
auto-restart attempts will be done.</p>
<p>On the other hand, improving this also reduced some of the waiting time
for login prompt in the serial console with the <strong>After=getty.target</strong>
clause set. Now I rather think that is better to keep it <after> and
avoid running rear recover by mistake from serial connection before rear
boot script is finished.<br />
Maybe a future improvement could be possible to show the rear boot
script output to console to provide better feedback to the user.</p>
<p>During the debugging of the issue I found that the <strong>getty.service</strong>
clause <strong>DefautInstance=tty0</strong> was not recognized because a typo (my
fault), I also adjusted it to Defau<strong>l</strong>tInstance=%I (see:
<a href="https://www.freedesktop.org/software/systemd/man/systemd.unit.html#DefaultInstance=">https://www.freedesktop.org/software/systemd/man/systemd.unit.html#DefaultInstance=</a>)
and now is working Ok.</p>
<p>All this was tested on VBox with Ubuntu 16.04 VMs with and without
serial connected. All tests worked well, and there are no more infinite
serial-getty respawns in journal.</p>
<p>Tomorrow I will test these changes on physical HW with RHEL7.2 and
serial console. If no issues a PR will be ready by tomorrow evening, I
guess.</p>
<p>Correct me if I'm wrong, but a new PR is needed, isn't it?</p>
<p>Regards,<br />
Didac</p>
<h4 id="gdha_commented_at_2017-12-14_0723"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/issues/1644#issuecomment-351629294">2017-12-14 07:23</a>:<a class="headerlink" href="#gdha_commented_at_2017-12-14_0723" title="Permanent link">&para;</a></h4>
<p>@didacog great news indeed! I think you have found the fix 👍 And, yes
please prepare a fresh PR which will be accepted with great pleasure :-)</p>
<h4 id="didacog_commented_at_2017-12-14_1125"><img src="https://avatars.githubusercontent.com/u/5380209?u=163f1571e6b9c9c7df94e2c6ca152b0a7406b52d&v=4" width="50"><a href="https://github.com/didacog">didacog</a> commented at <a href="https://github.com/rear/rear/issues/1644#issuecomment-351684496">2017-12-14 11:25</a>:<a class="headerlink" href="#didacog_commented_at_2017-12-14_1125" title="Permanent link">&para;</a></h4>
<p>@gdha, last changes worked also on SuperdomeX servers with RHEL7.2 with
serial console.</p>
<p>Later today I will send the PR with updated changes, this should solve
all problems from issue #878 and PR #1615 without the infinite respawn
problem. :-)</p>
<p>Regards,<br />
Didac</p>
<h4 id="schabrolles_commented_at_2017-12-14_1139"><img src="https://avatars.githubusercontent.com/u/19491077?u=0021b16ab426902cbe676f6831f41607bbe4d441&v=4" width="50"><a href="https://github.com/schabrolles">schabrolles</a> commented at <a href="https://github.com/rear/rear/issues/1644#issuecomment-351687407">2017-12-14 11:39</a>:<a class="headerlink" href="#schabrolles_commented_at_2017-12-14_1139" title="Permanent link">&para;</a></h4>
<p>@didacog did you have a look on
<code>/usr/lib/systemd/system-generators/systemd-getty-generator</code> ?<br />
It should be responsible of serial console detection and automatically
create <code>serial-ttyS0@.service</code> or <code>serial-hvc0@.service</code>. Have a look on
#1442 and #1448</p>
<h4 id="didacog_commented_at_2017-12-14_1532"><img src="https://avatars.githubusercontent.com/u/5380209?u=163f1571e6b9c9c7df94e2c6ca152b0a7406b52d&v=4" width="50"><a href="https://github.com/didacog">didacog</a> commented at <a href="https://github.com/rear/rear/issues/1644#issuecomment-351744586">2017-12-14 15:32</a>:<a class="headerlink" href="#didacog_commented_at_2017-12-14_1532" title="Permanent link">&para;</a></h4>
<p>@schabrolles yes I've tested, as it is, with
"/usr/lib/systemd/system-generators/systemd-getty-generator" in
COPY_AS_IS without changes, but issue #878 happens.</p>
<p>Maybe with some bigger changes/cleanups in getty services in systemd
could work with the generator at the end, but at least for now, I prefer
to solve these issues and after, with them solved, we may start a
discussion in how to improve it to have a better implementation?</p>
<h4 id="didacog_commented_at_2017-12-14_1554"><img src="https://avatars.githubusercontent.com/u/5380209?u=163f1571e6b9c9c7df94e2c6ca152b0a7406b52d&v=4" width="50"><a href="https://github.com/didacog">didacog</a> commented at <a href="https://github.com/rear/rear/issues/1644#issuecomment-351751299">2017-12-14 15:54</a>:<a class="headerlink" href="#didacog_commented_at_2017-12-14_1554" title="Permanent link">&para;</a></h4>
<p>PR is ready! :-P</p>
<h4 id="jsmeix_commented_at_2017-12-15_1034"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1644#issuecomment-351972133">2017-12-15 10:34</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-12-15_1034" title="Permanent link">&para;</a></h4>
<p>With
<a href="https://github.com/rear/rear/pull/1649">https://github.com/rear/rear/pull/1649</a>
merged<br />
I consider this issue to be fixed (if not it can be reopened).</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2022 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2017-12-12.1644.issue.closed.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
