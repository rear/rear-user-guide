<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#885 Issue closed: Messages on screen missing in log file - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#885 Issue closed: Messages on screen missing in log file";
        var mkdocs_page_input_path = "issues/2016-06-17.885.issue.closed.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/backup_netfs.html">Example of BACKUP=NETFS</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#885 Issue closed: Messages on screen missing in log file</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="885_issue_closed_messages_on_screen_missing_in_log_file"><a href="https://github.com/rear/rear/issues/885">#885 Issue</a> <code>closed</code>: Messages on screen missing in log file<a class="headerlink" href="#885_issue_closed_messages_on_screen_missing_in_log_file" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>enhancement</code>, <code>cleanup</code>, <code>fixed / solved / done</code></p>
<h4 id="jsmeix_opened_issue_at_2016-06-17_1322"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> opened issue at <a href="https://github.com/rear/rear/issues/885">2016-06-17 13:22</a>:<a class="headerlink" href="#jsmeix_opened_issue_at_2016-06-17_1322" title="Permanent link">&para;</a></h4>
<p>rear master</p>
<p>During
<a href="https://github.com/rear/rear/issues/882#issuecomment-226765335">https://github.com/rear/rear/issues/882#issuecomment-226765335</a>
I noticed messages on the screen<br />
that are not logged in the rear log file.</p>
<p>I did "rear -d -D recover" and got this on the screen<br />
(excerpts - long lines wrapped):</p>
<pre>
RESCUE g130:~ # rear -d -D recover
...
Creating filesystem of type btrfs with mount point / on /dev/sda3.
8 bytes [5f 42 48 52 66 53 5f 4d] erased at offset 0x10040 (btrfs)

Btrfs v3.18.2+

ATTENTION:

mkfs.btrfs is not intended to be used directly. Please use the
YaST partitioner to create and manage btrfs filesystems to be
in a supported state on SUSE Linux Enterprise systems.

Performing full device TRIM (18.38GiB) ...
Turning ON incompat feature 'extref': increased hardlink limit
 per file to 65536
fs created label (null) on /dev/sda3
        nodesize 4096 leafsize 4096 sectorsize 4096 size 18.38GiB
Mounting filesystem /
</pre>

<p>But in /var/log/rear/rear-g130.log (in the running recovery system)<br />
there is only (excerpt - long lines wrapped):</p>
<pre>
+++ LogPrint 'Creating filesystem of type btrfs with mount
 point / on /dev/sda3.'
+++ Log 'Creating filesystem of type btrfs with mount point / on /dev/sda3.'
+++ test 1 -gt 0
++++ Stamp
++++ date '+%Y-%m-%d %H:%M:%S.%N '
+++ echo '2016-06-17 14:42:24.248377595 Creating filesystem of type btrfs
 with mount point / on /dev/sda3.'
2016-06-17 14:42:24.248377595 Creating filesystem of type btrfs with
 mount point / on /dev/sda3.
+++ Print 'Creating filesystem of type btrfs with mount point / on /dev/sda3.'
+++ test -n 1
+++ echo -e 'Creating filesystem of type btrfs with mount point / on /dev/sda3.'
+++ mount
+++ grep -q /dev/sda3
+++ wipefs -a /dev/sda3
+++ grep -q /dev/sda3
+++ mount
+++ mkfs -t btrfs -f /dev/sda3
++++ grep -o 'uuid: .*'
++++ cut -d : -f 2
++++ tr -d '[:space:]'
++++ btrfs filesystem show /dev/sda3
+++ new_uuid=56e33393-d7aa-4750-8a41-67a5e8b12fda
+++ '[' ffa23495-df2a-4a08-9233-4b84faea5d40 '!=' 56e33393-d7aa-4750-8a41-67a5e8b12fda ']'
+++ grep -q ffa23495-df2a-4a08-9233-4b84faea5d40 /var/lib/rear/layout/fs_uuid_mapping
grep: /var/lib/rear/layout/fs_uuid_mapping: No such file or directory
+++ echo 'ffa23495-df2a-4a08-9233-4b84faea5d40 56e33393-d7aa-4750-8a41-67a5e8b12fda /dev/sda3'
+++ LogPrint 'Mounting filesystem /'
+++ Log 'Mounting filesystem /'
+++ test 1 -gt 0
++++ Stamp
++++ date '+%Y-%m-%d %H:%M:%S.%N '
+++ echo '2016-06-17 14:42:24.390821545 Mounting filesystem /'
2016-06-17 14:42:24.390821545 Mounting filesystem /
+++ Print 'Mounting filesystem /'
+++ test -n 1
+++ echo -e 'Mounting filesystem /'
</pre>

<p>I.e. nothing at all in the log about</p>
<pre>
Btrfs v3.18.2+

ATTENTION:

mkfs.btrfs is not intended to be used directly. Please use the
YaST partitioner to create and manage btrfs filesystems to be
in a supported state on SUSE Linux Enterprise systems.

Performing full device TRIM (18.38GiB) ...
Turning ON incompat feature 'extref': increased hardlink limit
 per file to 65536
fs created label (null) on /dev/sda3
        nodesize 4096 leafsize 4096 sectorsize 4096 size 18.38GiB
</pre>

<p>Perhaps this is a general missing functionality in rear<br />
that everything what appears on the screen is also logged?</p>
<p>@gdha<br />
do you know if everything what appears on the screen<br />
should also be logged when '-d' and '-D' is used<br />
or do I do something wrong?</p>
<h4 id="gdha_commented_at_2016-06-17_1429"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/issues/885#issuecomment-226784037">2016-06-17 14:29</a>:<a class="headerlink" href="#gdha_commented_at_2016-06-17_1429" title="Permanent link">&para;</a></h4>
<p>@jsmeix Try using
<a href="https://github.com/gdha/mismas/blob/master/make_rear_diskrestore_script.sh">https://github.com/gdha/mismas/blob/master/make_rear_diskrestore_script.sh</a>
to generate the <code>disk_restore.sh</code> (see also
<a href="http://www.it3.be/2016/06/08/rear-diskrestore/">http://www.it3.be/2016/06/08/rear-diskrestore/</a>
for more info).<br />
You will notice that the mkfs commands do not have <code>&gt;&amp;2</code> appended (I
guess that was done on purpose so that the user see something on the
screen).</p>
<h4 id="jsmeix_commented_at_2016-06-17_1441"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/885#issuecomment-226787322">2016-06-17 14:41</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-06-17_1441" title="Permanent link">&para;</a></h4>
<p>Do I understand it correctly that only stderr gets into the log<br />
but stdout does not get into the log?</p>
<p>If in usr/sbin/rear the command</p>
<pre>
exec 2>"$LOGFILE" ...
</pre>

<p>is the only one that redirects things into the log<br />
then only stderr gets into the log<br />
but stdout stays on the screen.</p>
<p>To get both stdout and stderr on the screen and also in the log<br />
see my scripts in the section<br />
"Generic usage of the plain SUSE installation system for backup and
recovery"<br />
in<br />
<a href="https://en.opensuse.org/SDB:Disaster_Recovery">https://en.opensuse.org/SDB:Disaster_Recovery</a></p>
<p>In those scripts I implemeted advanced logging functionality<br />
so that everything what "appears on the screen" is also logged<br />
as follows (excerpts):</p>
<pre>
# Start logging:
my_name=${0##*/}
starting_timestamp=$( date +%Y%m%d%H%M%S )
log_file=$my_name.$starting_timestamp.log
# Have a new file descriptor 3 which is a copy of the stdout file descriptor:
exec 3>&1
# Have a new file descriptor 4 which is a copy of the stderr file descriptor:
exec 4>&2
# Have stdout on the terminal and also in the log file:
exec 1> >( exec -a $my_name:tee tee -a $log_file )
logging_tee_pid=$!
# Make stderr what stdout already is (i.e. terminal and also in the log file):
exec 2>&1
...
# Stop logging:
# Have stdout and stderr on the terminal but no longer in the log file that is in use by the my_name:tee process
# which was forked at "Start logging" via: exec 1> >( exec -a $my_name:tee tee -a $log_file )
# Close stdout and stderr to finish the my_name:tee logging process:
exec 1>&-
exec 2>&-
# Reopen stdout as what was saved in file descriptor 3:
exec 1>&3
# Reopen stderr as what was saved in file descriptor 4:
exec 2>&4
# Wait one second to be on the safe side that the my_name:tee logging process has finished:
sleep 1
if ps $logging_tee_pid 1>/dev/null
then echo "$my_name:tee process (PID $logging_tee_pid) still running (writes to $log_file)."
     echo "Waiting 10 seconds to give the $my_name:tee logging process more time to finish."
     sleep 10
fi
</pre>

<p>@gdha<br />
if you like to have such kind of advanced logging functionality<br />
I can work on it to implement that also for rear.</p>
<p>Of course I will use appropriate command line options<br />
so that by default the user does not get zillions of<br />
debug log messages on the screen.</p>
<h4 id="gdha_commented_at_2016-06-18_0720"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/issues/885#issuecomment-226926922">2016-06-18 07:20</a>:<a class="headerlink" href="#gdha_commented_at_2016-06-18_0720" title="Permanent link">&para;</a></h4>
<p>@schlomo would like to see your opinion on this topic as well?</p>
<h4 id="jsmeix_commented_at_2016-06-21_0742"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/885#issuecomment-227364620">2016-06-21 07:42</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-06-21_0742" title="Permanent link">&para;</a></h4>
<p>To avoid misunderstanding:</p>
<p>I do not plan to change the current behaviour.</p>
<p>My current idea is to add two command line parameters like</p>
<pre>
Logging:
 -l  have stdout on the terminal and also in the log file
 -L  have stderr in the log file and also on the terminal
By default (i.e. without '-l' and/or '-L')
stdout is on the terminal and stderr goes to the log file.
</pre>

<h4 id="schlomo_commented_at_2017-06-20_1216"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/issues/885#issuecomment-309735170">2017-06-20 12:16</a>:<a class="headerlink" href="#schlomo_commented_at_2017-06-20_1216" title="Permanent link">&para;</a></h4>
<p>I think it would be nice to also duplicate stdout into the log file. I
don't see the additional benefit (beyond us developers) to mirror stderr
to the terminal as well. Quite the opposite, for ReaR users it is our
job to handle all the error situations either with a meaningful response
in our code or by aborting and asking the user to look into the log
file.</p>
<p>So, as in any case the logfile is the important source of truth I would
add the stdout to the logfile so that the logfile gives a more complete
picture. If a single command has output on stderr that we prefer on
stdout then for this single command we should redirect the output to
stdout (<code>2&gt;&amp;1</code>).</p>
<p>As in many other cases, I think that making this configurable adds more
complexity for little value. Adding stdout to the log is however
valuable to complete the picture in the logfile. BTW, looking at the
title of this issue also reminds me to keep it simple and just implement
that: screen messages in logfile.</p>
<h4 id="jsmeix_commented_at_2017-06-20_1425"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/885#issuecomment-309772613">2017-06-20 14:25</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-06-20_1425" title="Permanent link">&para;</a></h4>
<p>@schlomo<br />
I will implement to duplicate stdout into the log file.</p>
<p>I agree that it is sufficient when all is in the log file.<br />
It is not needed to have all on the terminal.</p>
<p>I think duplicating stdout into the log file could be done<br />
in any case even without any additional option.</p>
<h4 id="schlomo_commented_at_2017-06-20_1432"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/issues/885#issuecomment-309775165">2017-06-20 14:32</a>:<a class="headerlink" href="#schlomo_commented_at_2017-06-20_1432" title="Permanent link">&para;</a></h4>
<p>Yes, that's what I meant: Simply add all stdout into the logfile by
default, that should not be an option.</p>
<h4 id="jsmeix_commented_at_2017-06-20_1442"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/885#issuecomment-309779465">2017-06-20 14:42</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-06-20_1442" title="Permanent link">&para;</a></h4>
<p>I like it so much that after some discussion<br />
we find simple solutions that "just do the right thing"!</p>
<h4 id="jsmeix_commented_at_2017-06-21_1343"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/885#issuecomment-310082587">2017-06-21 13:43</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-06-21_1343" title="Permanent link">&para;</a></h4>
<p>Unfortunately it is not so simple as it looks to<br />
"Simply add all stdout into the logfile"<br />
if one wants to keep strict ordering of stdout and stderr outputs.</p>
<p>With</p>
<pre>
exec 1> >( exec -a $my_name:tee tee -i -a $log_file )
exec 2>>$log_file
</pre>

<p>one gets stdout on the terminal and also in the log file<br />
and stderr only in the log file (but no longer on the terminal)<br />
but then stdout and stderr outputs that happen at basically<br />
the same time can show up in the opposite order in the log file<br />
(usually stderr gets shown first).</p>
<p>I think the reason is that for stdout there is the 'tee' process<br />
in beween where output is even further delayed by the named pipe<br />
with its buffers that are also in beween compared to stderr<br />
that gets directly appended to the log file.</p>
<p>What would keep the ordering is</p>
<pre>
exec 1> >( exec -a $my_name:tee tee -i -a $log_file )
exec 2>&1
</pre>

<p>because with 2&gt;&amp;1 both streams are correctly merged, cf.<br />
<a href="https://unix.stackexchange.com/questions/157689/how-to-capture-ordered-stdout-stderr-and-add-timestamp-prefixes">https://unix.stackexchange.com/questions/157689/how-to-capture-ordered-stdout-stderr-and-add-timestamp-prefixes</a><br />
because now bash outputs stdout and stderr both via<br />
the exact same file descriptor (that happens to be a<br />
named pipe with a 'tee' consumer process).</p>
<p>But of course one same file descriptor for stdout and stderr<br />
results that both stdout and stderr appear on the terminal<br />
(and in the log file) and I guess we definitely do not want<br />
stderr on the terminal for "rear -d -D ..." ;-)</p>
<p>BUT:</p>
<p>Usually we also do not want stdout on the terminal,<br />
cf. "What to do with stdout and stderr" in<br />
<a href="https://github.com/rear/rear/wiki/Coding-Style">https://github.com/rear/rear/wiki/Coding-Style</a></p>
<p>Therefore I wonder now if I should perhaps by default<br />
redirect both stdout and stderr only to the log file<br />
and have both of them no longer on the terminal.</p>
<p>For output that is really meant for the user on the terminal<br />
one could use explicit termial output e.g. via things like</p>
<pre>
test -w /dev/tty && echo "output for the user" >/dev/tty
</pre>

<p>or like the Print function does it by explicitly using fd7<br />
as implemented in _input-output-functions.sh</p>
<pre>
# duplication STDOUT to fd7 to use for Print
exec 7>&1

...

function Print () {
    test "$VERBOSE" && echo -e "${MESSAGE_PREFIX}$*" >&7 || true
}
</pre>

<p>My question is now:</p>
<p>Should I implement stdout on the terminal and also in the log file<br />
and stderr only in the log file (but not on the terminal)<br />
without keeping strict ordering of stdout and stderr outputs</p>
<p>or</p>
<p>should I redirect both stdout and stderr only to the log file<br />
and have both of them no longer on the terminal<br />
(which keeps strict ordering of stdout and stderr outputs<br />
in the log file).</p>
<p>In the latter case I would also have to fix all actually intended<br />
user dialogs via the terminal - in particular all places that<br />
ask the user for input via a generic user input function, cf.<br />
<a href="https://github.com/rear/rear/issues/1366">https://github.com/rear/rear/issues/1366</a></p>
<h4 id="schlomo_commented_at_2017-06-21_1406"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/issues/885#issuecomment-310089419">2017-06-21 14:06</a>:<a class="headerlink" href="#schlomo_commented_at_2017-06-21_1406" title="Permanent link">&para;</a></h4>
<p>I think that a first good step is to make sure that all output intended
for the screen is generated by a ReaR custom function like Print and not
plain echo.</p>
<p>Once that is done we can experiment with global redirects. I am afraid
that if we start with global redirects before that then we might end up
missing crucial messages.</p>
<h4 id="jsmeix_commented_at_2017-06-21_1431"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/885#issuecomment-310097212">2017-06-21 14:31</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-06-21_1431" title="Permanent link">&para;</a></h4>
<p>Of course I had meant fixing all actually intended user dialogs<br />
via the terminal as a precondition before redirecting stdout<br />
only to the log file.</p>
<p>But that could be a long task.</p>
<p>Therefore - if you agree - I would like to do the following:</p>
<p>As a first step for now I will implement<br />
duplicating stdout on the terminal and also in the log file<br />
without keeping strict ordering of stdout and stderr outputs.</p>
<p>Then as a second step I will fix all actually intended user messages<br />
and dialogs by using generic ReaR user input/output functions.</p>
<p>Finally as last step (after wating some time for possible bugs)<br />
I would implement redirecting both stdout and stderr<br />
only to the log file.</p>
<h4 id="schlomo_commented_at_2017-06-21_1718"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/issues/885#issuecomment-310146762">2017-06-21 17:18</a>:<a class="headerlink" href="#schlomo_commented_at_2017-06-21_1718" title="Permanent link">&para;</a></h4>
<p>@jsmeix I am afraid that adding stdout to the log with wrong ordering
will do us more harm than good. It will be extremely confusing to
analyze such logs as you will have to <strong>guess</strong> what belongs where.</p>
<h4 id="jsmeix_commented_at_2017-06-22_0756"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/885#issuecomment-310305249">2017-06-22 07:56</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-06-22_0756" title="Permanent link">&para;</a></h4>
<p>O.k. then I will do it right from the start:</p>
<p>First as a precondition I will fix all actually intended user messages<br />
and dialogs by using generic ReaR user input/output functions<br />
which means in particular that I will first do<br />
<a href="https://github.com/rear/rear/issues/1366">https://github.com/rear/rear/issues/1366</a></p>
<h4 id="jsmeix_commented_at_2017-06-22_0805"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/885#issuecomment-310307082">2017-06-22 08:05</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-06-22_0805" title="Permanent link">&para;</a></h4>
<p>@schlomo<br />
I think usually the ordering would not go totally wrong<br />
but only a bit misplaced.<br />
But theoretically the 'tee' process with its named pipe<br />
could delay the stdout output arbitrarily so that it is not<br />
impossible that the ordering gets arbitrarily messed up.</p>
<h4 id="jsmeix_commented_at_2017-06-22_0812"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/885#issuecomment-310308763">2017-06-22 08:12</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-06-22_0812" title="Permanent link">&para;</a></h4>
<p>FYI<br />
here my stand-alone testing script<br />
cf.
<a href="https://github.com/rear/rear/issues/885#issuecomment-226787322">https://github.com/rear/rear/issues/885#issuecomment-226787322</a></p>
<pre>
#!/bin/bash
my_name=${0##*/}
starting_timestamp=$( date +%Y%m%d%H%M%S )
# Start logging:
# A side note regarding preserving the ordering of stdout and stderr outputs see
# https://stackoverflow.com/questions/12517519/how-to-redirect-stdoutstderr-to-one-file-while-keeping-streams-separate
# that states that it is futile to try to preserve ordering because it is impossible
# because when there are writes to stderr and stdout that happen basically at the same time
# they can show up in the opposite order in the log file and also on the terminal.
log_file=$my_name.$starting_timestamp.log
# Have a new file descriptor 3 which is a copy of the stdout file descriptor:
exec 3>&1
# Have a new file descriptor 4 which is a copy of the stderr file descriptor:
exec 4>&2
# Have stdout on the terminal and also in the log file by
# redirecting stdout '1>' into a named pipe '>()' running 'tee'.
# Using 'tee -i' to avoid that signal interrupts (traps) disrupt stdout in the main script
# e.g. if there is a "trap 'echo Exiting' EXIT" and one does [Ctrl]+[C] one will not have "Exiting" in the log file, cf.
# https://stackoverflow.com/questions/3173131/redirect-copy-of-stdout-to-log-file-from-within-bash-script-itself
exec 1> >( exec -a $my_name:tee tee -i -a $log_file )
logging_tee_pid=$!
# Have stderr only in the log file (but no longer on the terminal).
# This cannot keeping strict ordering of stdout and stderr outputs.
# It is crucial to append to the log file '>>' instead of plain writing to it '>'
# because when a program (bash in this case) is plain writing to the log file it can overwrite
# output of the simultaneously running 'tee -a' process that appends stdout to the log file
# (i.e. with plain '2>$log_file' at least some stdout would be missing in the log file):
#exec 2>>$log_file
# Make stderr the same what stdout already is (i.e. terminal and also in the log file).
# This keeps strict ordering of stdout and stderr outputs
# because now both stdout and stderr use one same file descriptor
# (that happens to be a named pipe with a 'tee' consumer process):
exec 2>&1
# Test logging:
trap 'echo Exiting' EXIT
for i in $( seq 9 )
do echo "a 1 stdout message $i"
   echo "a 2 stderr message $i" 1>&2
   echo "b 1 stdout message $i"
   echo "b 2 stderr message $i" 1>&2
   test -w /dev/tty && echo "tty sleeping 1 second" >>/dev/tty
   sleep 1
done
# Stop logging:
# Have stdout and stderr on the terminal but no longer in the log file that is in use by the my_name:tee process
# which was forked at "Start logging" via: exec 1> >( exec -a $my_name:tee tee -i -a $log_file )
# Close stdout and stderr to finish the my_name:tee logging process:
exec 1>&-
exec 2>&-
# Reopen stdout as what was saved in file descriptor 3:
exec 1>&3
# Reopen stderr as what was saved in file descriptor 4:
exec 2>&4
# Wait one second to be on the safe side that the my_name:tee logging process has finished:
sleep 1
if ps $logging_tee_pid 1>/dev/null
then echo "$my_name:tee process (PID $logging_tee_pid) still running (writes to $log_file)."
     echo "Waiting 10 seconds to give the $my_name:tee logging process more time to finish."
     sleep 10
fi
</pre>

<h4 id="jsmeix_commented_at_2017-06-22_1405"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/885#issuecomment-310390201">2017-06-22 14:05</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-06-22_1405" title="Permanent link">&para;</a></h4>
<p>Only an intermediate info:</p>
<p>I am currently experimenting with this in usr/sbin/rear<br />
to get both STDOUT and STDERR into the log file:</p>
<pre>
# Source usr/share/rear/lib/_input-output-functions.sh because therein
# the original STDOUT and STDERR file descriptors are saved as fd7 and fd8
# so that ReaR functions for actually intended user messages can use fd7 and fd8
# to show messages to the user regardless whereto STDOUT and STDERR are redirected:
source $SHARE_DIR/lib/_input-output-functions.sh

# Keep old log file:
test -r "$RUNTIME_LOGFILE" && mv -f "$RUNTIME_LOGFILE" "$RUNTIME_LOGFILE".old 2>/dev/null

# Start logging:
mkdir -p $LOG_DIR || echo "ERROR: Could not create $LOG_DIR" >&2
cat /dev/null >"$RUNTIME_LOGFILE"
# Redirect both STDOUT and STDERR into the log file:
exec 2>>"$RUNTIME_LOGFILE"
exec 1>&2

# Include functions after RUNTIME_LOGFILE is set and readonly
# so that functions can use a fixed RUNTIME_LOGFILE value:
for script in $SHARE_DIR/lib/[a-z]*.sh ; do
    source $script
done
</pre>

<p>With this I get "interesting" looking results:</p>
<p>Now some scripts spit out error messages on the terminal<br />
regardless that STDOUT and STDERR should go to the log file.</p>
<p>It seems there is much to do and to clean up<br />
until also redirecting STDOUT works properly.</p>
<p>It seems parts of ReaR somehow depend<br />
on STDOUT not being redirected.</p>
<p>I think ReaR should work properly regardless whereto<br />
STDOUT and STDERR might be redirected because<br />
I think it must be possible that the user calls 'rear' from<br />
within any environment with any STDOUT and STDERR<br />
redirections set up by the user as he likes it (e.g. for<br />
whatever automated use case like via cron or whatever).</p>
<p>I think having by default STDOUT and STDERR redirected<br />
into the log file is only one particular use case.</p>
<h4 id="jsmeix_commented_at_2017-06-22_1416"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/885#issuecomment-310393496">2017-06-22 14:16</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-06-22_1416" title="Permanent link">&para;</a></h4>
<p>Found a first easy explanation why error messages<br />
appear unexpectedly on the terminal.<br />
It is the old deprecated usage of '&gt;&amp;8'<br />
e.g. as in prep/GNU/Linux/200_include_serial_console.sh</p>
<pre>
    for devnode in $(ls /dev/ttyS[0-9]* | sort); do
        if stty -F $devnode >&8 2>&1; then
            USE_SERIAL_CONSOLE=y
        fi
    done
</pre>

<p>because now with my new _input-output-functions.sh<br />
the original STDOUT and STDERR file descriptors<br />
are now saved as fd7 and fd8 so that all what is sent to fd8<br />
appears on the original STDERR which is the terminal.</p>
<p>I was already aware of it that I also have<br />
to fix all the old deprecated usage of '&gt;&amp;8'<br />
and if that is all, it is easy - much to do but easy.</p>
<p>I look forward to finally get all that old stuff cleaned up!</p>
<h4 id="jsmeix_commented_at_2017-06-22_1423"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/885#issuecomment-310395408">2017-06-22 14:23</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-06-22_1423" title="Permanent link">&para;</a></h4>
<p>I.e. solving
<a href="https://github.com/rear/rear/issues/887">https://github.com/rear/rear/issues/887</a><br />
is another precondition for this issue here.</p>
<h4 id="jsmeix_commented_at_2017-06-26_1226"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/885#issuecomment-311044549">2017-06-26 12:26</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-06-26_1226" title="Permanent link">&para;</a></h4>
<p>With
<a href="https://github.com/rear/rear/pull/1391">https://github.com/rear/rear/pull/1391</a>
merged<br />
this issue should be already solved regardless<br />
that
<a href="https://github.com/rear/rear/issues/887">https://github.com/rear/rear/issues/887</a><br />
is not yet solved, for an explanation why see<br />
<a href="https://github.com/rear/rear/pull/1391#issuecomment-311040948">https://github.com/rear/rear/pull/1391#issuecomment-311040948</a></p>
<h4 id="jsmeix_commented_at_2017-06-26_1245"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/885#issuecomment-311048654">2017-06-26 12:45</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-06-26_1245" title="Permanent link">&para;</a></h4>
<p>In
<a href="https://github.com/rear/rear/wiki/Coding-Style">https://github.com/rear/rear/wiki/Coding-Style</a><br />
I explained "What to do with stdout and stderr" when<br />
both stdout and stderr are redirected into ReaR's log file.</p>
<h4 id="jsmeix_commented_at_2017-06-28_1429"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/885#issuecomment-311677217">2017-06-28 14:29</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-06-28_1429" title="Permanent link">&para;</a></h4>
<p>The redirection of STDOUT into the log file can<br />
cause regressions when interactive tools are "just called",<br />
see
<a href="https://github.com/rear/rear/issues/1398">https://github.com/rear/rear/issues/1398</a></p>
<h4 id="jsmeix_commented_at_2017-07-19_0903"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/885#issuecomment-316320858">2017-07-19 09:03</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-07-19_0903" title="Permanent link">&para;</a></h4>
<p>I reopen this issue because the<br />
redirection of STDOUT into the log file<br />
will not happen for ReaR v 2.2.</p>
<p>Because ReaR v 2.2 was preponed, cf.<br />
<a href="https://github.com/rear/rear/issues/1398#issuecomment-315318878">https://github.com/rear/rear/issues/1398#issuecomment-315318878</a><br />
I postponed the redirection of STDOUT vor ReaR v 2.2 in<br />
<a href="https://github.com/rear/rear/commit/f47f705c0857e46b93c2ccc49b8ba504c05559eb">https://github.com/rear/rear/commit/f47f705c0857e46b93c2ccc49b8ba504c05559eb</a><br />
cf.<br />
<a href="https://github.com/rear/rear/issues/1398#issuecomment-315325470">https://github.com/rear/rear/issues/1398#issuecomment-315325470</a></p>
<h4 id="jsmeix_commented_at_2017-10-20_1001"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/885#issuecomment-338163343">2017-10-20 10:01</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-10-20_1001" title="Permanent link">&para;</a></h4>
<p>For ReaR v2.3 redirection of stdout into the log file is re-enabled
via<br />
<a href="https://github.com/rear/rear/commit/6ab3c4173fe425bb018880af4a8461bf575ba1e0">https://github.com/rear/rear/commit/6ab3c4173fe425bb018880af4a8461bf575ba1e0</a><br />
so that this issue is fixed for ReaR v 2.3.</p>
<h4 id="jsmeix_commented_at_2018-05-18_0856"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/885#issuecomment-390142152">2018-05-18 08:56</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-05-18_0856" title="Permanent link">&para;</a></h4>
<p>An addedum regarding the above<br />
<a href="https://github.com/rear/rear/issues/885#issuecomment-310308763">https://github.com/rear/rear/issues/885#issuecomment-310308763</a><br />
that reads</p>
<pre>
# It is crucial to append to the log file '>>' instead of plain writing to it '>'
# because when a program (bash in this case) is plain writing to the log file it can overwrite
# output of the simultaneously running 'tee -a' process that appends stdout to the log file
# (i.e. with plain '2>$log_file' at least some stdout would be missing in the log file):
</pre>

<p>here an example command that shows how append to one same log file
works:</p>
<pre>
{ of=/tmp/out ; cat /dev/null >$of ; \
  ( for i in $( seq 10 29 ) ; do echo "i=$i" ; cat i=$i ; done 1>>$of 2>&1 ) & \
  ( for j in $( seq 10 29 ) ; do echo "j=$j" ; cat j=$j ; done 1>>$of 2>&1 ) & \
  wait ; \
  echo $( grep -o 'i=..' $of | wc -l ) i messages ; \
  echo $( grep -o 'j=..' $of | wc -l ) j messages ; \
  cat -n $of ; } | less
</pre>

<p>that results e.g. this output</p>
<pre>
40 i messages
40 j messages
     1  i=10
     2  j=10
     3  cat: 'i=10': No such file or directory
     4  cat: 'j=10': No such file or directory
     5  i=11
     6  j=11
     7  cat: 'i=11': No such file or directory
     8  cat: 'j=11': No such file or directory
     9  i=12
    10  j=12
    11  cat: 'i=12': No such file or directorycat: 
    12  'j=12': No such file or directory
    13  i=13
    14  j=13
    15  cat: 'i=13'cat: 'j=13': No such file or directory: No such file or directory
    16
    17  j=14
    18  i=14
    19  cat: 'i=14'cat: 'j=14': No such file or directory
    20  : No such file or directory
    21  i=15
    22  j=15
    23  cat: 'j=15'cat: 'i=15': No such file or directory
    24  : No such file or directory
    25  j=16
    26  i=16
    27  cat: 'j=16'cat: 'i=16': No such file or directory
    28  : No such file or directory
    29  j=17
    30  i=17
    31  cat: 'j=17': No such file or directory
    32  cat: 'i=17': No such file or directory
    33  j=18
    34  i=18
    35  cat: 'j=18': No such file or directory
    36  cat: 'i=18': No such file or directory
    37  j=19
    38  i=19
    39  cat: 'j=19'cat: 'i=19': No such file or directory
    40  : No such file or directory
    41  j=20
    42  i=20
    43  cat: 'i=20': No such file or directory
    44  cat: 'j=20': No such file or directory
    45  i=21
    46  j=21
    47  cat: 'i=21': No such file or directory
    48  cat: 'j=21': No such file or directory
    49  i=22
    50  j=22
    51  cat: 'i=22': No such file or directory
    52  cat: 'j=22'i=23
    53  : No such file or directory
    54  j=23
    55  cat: 'i=23': No such file or directory
    56  cat: 'j=23': No such file or directory
    57  i=24
    58  j=24
    59  cat: 'j=24'cat: 'i=24': No such file or directory
    60  : No such file or directory
    61  j=25
    62  i=25
    63  cat: 'i=25': No such file or directory
    64  cat: 'j=25': No such file or directory
    65  i=26
    66  j=26
    67  cat: 'i=26': No such file or directory
    68  cat: 'j=26': No such file or directory
    69  i=27
    70  j=27
    71  cat: 'j=27'cat: 'i=27': No such file or directory
    72  : No such file or directory
    73  j=28
    74  i=28
    75  cat: 'j=28': No such file or directory
    76  j=29
    77  cat: 'i=28': No such file or directory
    78  i=29
    79  cat: 'j=29': No such file or directory
    80  cat: 'i=29': No such file or directory
</pre>

<p>Message lines of the two simultaneously running processes can get
intermixed<br />
but on the other hand all output of the two processes appears in the log
file and<br />
all output appears in the exact right chronological ordering<br />
(which is the reason why message lines get intermixed).</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2024 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2016-06-17.885.issue.closed.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/rear/rear-user-guide" class="fa fa-code-fork" style="color: #fcfcfc"> rear/rear-user-guide</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
