<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#2275 Issue closed: "rear recover" cannot install GRUB2-EFI on CentOS 7 minimal installation - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#2275 Issue closed: \"rear recover\" cannot install GRUB2-EFI on CentOS 7 minimal installation";
        var mkdocs_page_input_path = "issues/2019-11-11.2275.issue.closed.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/backup_netfs.html">Example of BACKUP=NETFS</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#2275 Issue closed: "rear recover" cannot install GRUB2-EFI on CentOS 7 minimal installation</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="2275_issue_closed_rear_recover_cannot_install_grub2-efi_on_centos_7_minimal_installation"><a href="https://github.com/rear/rear/issues/2275">#2275 Issue</a> <code>closed</code>: "rear recover" cannot install GRUB2-EFI on CentOS 7 minimal installation<a class="headerlink" href="#2275_issue_closed_rear_recover_cannot_install_grub2-efi_on_centos_7_minimal_installation" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>enhancement</code>, <code>documentation</code>, <code>cleanup</code>,
<code>no-issue-activity</code></p>
<h4 id="franciscohosting_opened_issue_at_2019-11-11_2034"><img src="https://avatars.githubusercontent.com/u/56039320?v=4" width="50"><a href="https://github.com/franciscohosting">franciscohosting</a> opened issue at <a href="https://github.com/rear/rear/issues/2275">2019-11-11 20:34</a>:<a class="headerlink" href="#franciscohosting_opened_issue_at_2019-11-11_2034" title="Permanent link">&para;</a></h4>
<h4 id="relax-and-recover_rear_issue_template">Relax-and-Recover (ReaR) Issue Template<a class="headerlink" href="#relax-and-recover_rear_issue_template" title="Permanent link">&para;</a></h4>
<ul>
<li>ReaR version ("/usr/sbin/rear -V"):</li>
</ul>
<p>Relax-and-Recover 2.5 / 2019-05-10</p>
<ul>
<li>OS version ("cat /etc/rear/os.conf" or "lsb_release -a" or "cat
    /etc/os-release"):</li>
</ul>
<!-- -->

<pre><code>OS_VENDOR=RedHatEnterpriseServer
OS_VERSION=7
</code></pre>
<ul>
<li>ReaR configuration files ("cat /etc/rear/site.conf" and/or "cat
    /etc/rear/local.conf"):</li>
</ul>
<!-- -->

<pre><code>COPY_AS_IS_BAREOS=( "${COPY_AS_IS[@]}" /etc/bareos /usr/src/kernels/3.10.0-1062.4.1.el7.x86_64 )
BACKUP=BAREOS
BAREOS_CLIENT=labobject2-fd
BAREOS_FILESET=LinuxAll
BAREOS_RESTORE_JOB=restoreLabobject2-fdIso
OUTPUT_URL=file:///tmp/bareos-restores
#KEEP_BUILD_DIR="yes"
SSH_ROOT_PASSWORD=********
</code></pre>
<ul>
<li>Hardware (PC or PowerNV BareMetal or ARM) or virtual machine (KVM
    guest or PoverVM LPAR):</li>
</ul>
<p>PC</p>
<ul>
<li>System architecture (x86 compatible or PPC64/PPC64LE or what exact
    ARM device):</li>
</ul>
<p>x86_64</p>
<ul>
<li>Firmware (BIOS or UEFI or Open Firmware) and bootloader (GRUB or
    ELILO or Petitboot):</li>
</ul>
<p>UEFI and Grub2</p>
<ul>
<li>Storage (local disk or SSD) and/or SAN (FC or iSCSI or FCoE) and/or
    multipath (DM or NVMe):</li>
</ul>
<p>local disk</p>
<ul>
<li>Description of the issue (ideally so that others can reproduce it):</li>
</ul>
<p>Restoring with bareos and rear fails to install grub on Centos 7 minimal
installation</p>
<ul>
<li>Workaround, if any:</li>
</ul>
<p>Reinstalling GRUB2 with Centos 7 install CD in recovery mode,
following:<br />
[(https://www.thegeekdiary.com/centos-rhel-7-how-to-reinstall-grub2-from-rescue-mode/)]</p>
<ul>
<li>Attachments, as applicable ("rear -D mkrescue/mkbackup/recover"
    debug log files):</li>
</ul>
<!-- -->

<pre><code>WARNING:
For this system
RedHatEnterpriseServer/7 on Linux-i386 (based on Fedora/7/i386)
there is no code to install a boot loader on the recovered system
or the code that we have failed to install the boot loader correctly.
Please contribute appropriate code to the Relax-and-Recover project,
see http://relax-and-recover.org/development/
Take a look at the scripts in /usr/share/rear/finalize,
for example see the scripts
/usr/share/rear/finalize/Linux-i386/630_install_grub.sh
/usr/share/rear/finalize/Linux-i386/660_install_grub2.sh
</code></pre>
<h4 id="jsmeix_commented_at_2019-11-12_1413"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2275#issuecomment-552910449">2019-11-12 14:13</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-11-12_1413" title="Permanent link">&para;</a></h4>
<p>@franciscohosting<br />
I am not a CentOS user so that I cannot reproduce such issues.</p>
<p>Therefore some generic questions and information:</p>
<p>Does it perhaps work with a "normal" CentOS installation?</p>
<p>I ask because "rear recover" installs GRUB2 by 'chroot' into<br />
the restored system and run 'gub-install' therein, cf.<br />
usr/share/rear/finalize/Linux-i386/660_install_grub2.sh<br />
<a href="https://github.com/rear/rear/blob/master/usr/share/rear/finalize/Linux-i386/660_install_grub2.sh">https://github.com/rear/rear/blob/master/usr/share/rear/finalize/Linux-i386/660_install_grub2.sh</a></p>
<p>But perhaps a CentOS minimal installation is so minimal<br />
that one cannot successfully re-install GRUB2 therein?</p>
<p>Perhaps it helps to explicitly specify the <code>BOOTLOADER</code>, cf.<br />
<a href="https://github.com/rear/rear/blob/master/usr/share/rear/conf/default.conf#L2608">https://github.com/rear/rear/blob/master/usr/share/rear/conf/default.conf#L2608</a></p>
<p>To analyze your issue we really need both your<br />
"rear -D mkrescue/mkbackup" and your<br />
"rear -D recover" debug log files, cf.<br />
"Debugging issues with Relax-and-Recover" in<br />
<a href="https://en.opensuse.org/SDB:Disaster_Recovery">https://en.opensuse.org/SDB:Disaster_Recovery</a></p>
<h4 id="franciscohosting_commented_at_2019-11-12_2049"><img src="https://avatars.githubusercontent.com/u/56039320?v=4" width="50"><a href="https://github.com/franciscohosting">franciscohosting</a> commented at <a href="https://github.com/rear/rear/issues/2275#issuecomment-553107709">2019-11-12 20:49</a>:<a class="headerlink" href="#franciscohosting_commented_at_2019-11-12_2049" title="Permanent link">&para;</a></h4>
<p>First of all thanks for your quick answer!<br />
Then in a fresh Centos 7 minimal installation with all upgraded, bareos
configured and rear installed, I get the following warnings:</p>
<pre><code>Broken symlink '/etc/grub2.cfg' in recovery system because 'readlink' cannot determine its link target
Broken symlink '/usr/lib/modules/3.10.0-1062.el7.x86_64/build' in recovery system because 'readlink' cannot determine its link target
Broken symlink '/usr/lib/modules/3.10.0-1062.el7.x86_64/source' in recovery system because 'readlink' cannot determine its link target\
ERROR: grub2-mkimage would not make bootable EFI image of GRUB2 (no /usr/lib/grub*/x86_64-efi/moddep.lst file)
</code></pre>
<p>So I configured rear to work bareos and did: yum install
grub2-efi-x64-modules (rebooted and deleted the old kernel)<br />
and as u suggested added BOOTLOADER="GRUB2-EFI" to site.conf<br />
that made the warning of Broken symlink
'/usr/lib/modules/3.10.0-1062.el7.x86_64/source' disappear<br />
then:<br />
<code>rear -D mkrescue</code><br />
gave me this log file:<br />
<a href="https://github.com/rear/rear/files/3838140/rear-labobject2.log">rear-labobject2.log</a><br />
then booting from the live cd, doing the full restore and finally
doing:<br />
<code>rear -D recover</code><br />
<a href="https://github.com/rear/rear/files/3838158/rear-labobject2Recover.log">rear-labobject2Recover.log</a></p>
<h4 id="jsmeix_commented_at_2019-11-13_1040"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2275#issuecomment-553344920">2019-11-13 10:40</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-11-13_1040" title="Permanent link">&para;</a></h4>
<p>I am not at all an expert in UEFI booting<br />
but think I may have found something:</p>
<p>I think in your<br />
<a href="https://github.com/rear/rear/files/3838158/rear-labobject2Recover.log">https://github.com/rear/rear/files/3838158/rear-labobject2Recover.log</a><br />
an interesting part is</p>
<pre><code>+ source /usr/share/rear/finalize/Linux-i386/660_install_grub2.sh
++ is_true 1
++ case "$1" in
++ return 0
++ is_true 1
++ case "$1" in
++ return 0
++ return
+ source_return_code=0
+ test 0 -eq 0
+ test 1
+ Debug 'Leaving debugscripts mode (back to previous bash flags and options settings).'
+ test 1
+ Log 'Leaving debugscripts mode (back to previous bash flags and options settings).'
+ echo '2019-11-12 21:45:43.662378243 Leaving debugscripts mode (back to previous bash flags and options settings).'
2019-11-12 21:45:43.662378243 Leaving debugscripts mode (back to previous bash flags and options settings).
2019-11-12 21:45:43.668776305 Including finalize/Linux-i386/670_run_efibootmgr.sh
2019-11-12 21:45:43.670469868 Entering debugscripts mode via 'set -x'.
+ source /usr/share/rear/finalize/Linux-i386/670_run_efibootmgr.sh
++ is_true 1
++ case "$1" in
++ return 0
++ is_true no
++ case "$1" in
++ return 1
++ test -f /mnt/local//boot/efi/EFI/centos/grubx64.efi
++ return 0
+ source_return_code=0
</code></pre>
<p>which shows that<br />
both /usr/share/rear/finalize/Linux-i386/660_install_grub2.sh<br />
and /usr/share/rear/finalize/Linux-i386/670_run_efibootmgr.sh<br />
do basically nothing so that in the end no bootloader is installed.</p>
<p>/usr/share/rear/finalize/Linux-i386/660_install_grub2.sh<br />
does nothing because it returns early at</p>
<pre><code># For UEFI systems with grub2 we should use efibootmgr instead,
# cf. finalize/Linux-i386/670_run_efibootmgr.sh
is_true $USING_UEFI_BOOTLOADER &amp;&amp; return
</code></pre>
<p>But the subsequent<br />
/usr/share/rear/finalize/Linux-i386/670_run_efibootmgr.sh<br />
that should set up the bootloader "For UEFI systems with grub2"<br />
also returns early at</p>
<pre><code># When UEFI_BOOTLOADER is not a regular file in the restored target system
# (cf. how esp_mountpoint is set below) it means BIOS is used
# (cf. rescue/default/850_save_sysfs_uefi_vars.sh)
# which includes that also an empty UEFI_BOOTLOADER means using BIOS
# because when UEFI_BOOTLOADER is empty the test below evaluates to
#   test -f /mnt/local/
# which also returns false because /mnt/local/ is a directory
# (cf. https://github.com/rear/rear/pull/2051/files#r258826856):
test -f "$TARGET_FS_ROOT/$UEFI_BOOTLOADER" || return 0
</code></pre>
<p>So I think it may help when you also set UEFI_BOOTLOADER<br />
to the right value for your particular system, cf.<br />
<a href="https://github.com/rear/rear/blob/master/usr/share/rear/conf/default.conf#L2675">https://github.com/rear/rear/blob/master/usr/share/rear/conf/default.conf#L2675</a></p>
<p>Regarding UEFI_BOOTLOADER there is in your<br />
<a href="https://github.com/rear/rear/files/3838140/rear-labobject2.log">https://github.com/rear/rear/files/3838140/rear-labobject2.log</a></p>
<pre><code>+ source /usr/share/rear/rescue/default/850_save_sysfs_uefi_vars.sh
...
++ Print 'Trying to find a '\''well known file'\'' to be used as UEFI bootloader...'
+++ find /boot/efi -name 'grub*.efi'
+++ tail -1
++ UEFI_BOOTLOADER=/boot/efi/EFI/centos/grubx64.efi
++ test -f /boot/efi/EFI/centos/grubx64.efi
++ continue
++ LogPrint 'Using '\''/boot/efi/EFI/centos/grubx64.efi'\'' as UEFI bootloader file'
</code></pre>
<p>So it seems on your original system there is a file</p>
<pre><code>/boot/efi/EFI/centos/grubx64.efi
</code></pre>
<p>which is no longer there on your recreated system<br />
after your backup was restored into <code>/mnt/local/</code> as</p>
<pre><code>/mnt/local//boot/efi/EFI/centos/grubx64.efi
</code></pre>
<p>In general I suggest to inspect all those bootloader related<br />
config variables in default.conf - perhaps further manual<br />
settings are needed for a CentOS 7 minimal installation?</p>
<h4 id="jsmeix_commented_at_2019-11-13_1443"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2275#issuecomment-553433772">2019-11-13 14:43</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-11-13_1443" title="Permanent link">&para;</a></h4>
<p>@gozora<br />
could you please have a look here as time permits.</p>
<p>I think we have one more issue in
finalize/Linux-i386/670_run_efibootmgr.sh<br />
which looks to me at least as an inconsistency in its following code
parts:</p>
<pre><code># When UEFI_BOOTLOADER is not a regular file in the restored target system
# (cf. how esp_mountpoint is set below) it means BIOS is used
# (cf. rescue/default/850_save_sysfs_uefi_vars.sh)
# which includes that also an empty UEFI_BOOTLOADER means using BIOS
# because when UEFI_BOOTLOADER is empty the test below evaluates to
#   test -f /mnt/local/
# which also returns false because /mnt/local/ is a directory
# (cf. https://github.com/rear/rear/pull/2051/files#r258826856):
test -f "$TARGET_FS_ROOT/$UEFI_BOOTLOADER" || return 0
</code></pre>
<p>where we test for <code>$TARGET_FS_ROOT/$UEFI_BOOTLOADER</code><br />
according to
<a href="https://github.com/rear/rear/pull/2051/files">https://github.com/rear/rear/pull/2051/files</a><br />
and its final implemenmtation<br />
<a href="https://github.com/rear/rear/commit/1bba7ff1b832849108ac6a92d313739235727821">https://github.com/rear/rear/commit/1bba7ff1b832849108ac6a92d313739235727821</a><br />
BUT<br />
later the code is</p>
<pre><code>BootLoader=$( echo $UEFI_BOOTLOADER | cut -d"/" -f4- | sed -e 's;/;\\;g' )
LogPrint "Creating  EFI Boot Manager entry '$OS_VENDOR $OS_VERSION' for '$BootLoader' (UEFI_BOOTLOADER='$UEFI_BOOTLOADER')"
Log efibootmgr --create --gpt --disk ${Disk} --part ${ParNr} --write-signature --label \"${OS_VENDOR} ${OS_VERSION}\" --loader \"\\${BootLoader}\"
if efibootmgr --create --gpt --disk ${Disk} --part ${ParNr} --write-signature --label "${OS_VENDOR} ${OS_VERSION}" --loader "\\${BootLoader}" ; then
    # ok, boot loader has been set-up - tell rear we are done using following var.
    NOBOOTLOADER=''
    return
fi
</code></pre>
<p>where efibootmgr is called with <code>--loader $BootLoader</code><br />
but here BootLoader is set by using plain <code>$UEFI_BOOTLOADER</code><br />
instead of <code>$TARGET_FS_ROOT/$UEFI_BOOTLOADER</code></p>
<p>So from my point of view<br />
either<br />
the current test is wrong and then<br />
<a href="https://github.com/rear/rear/pull/2051">https://github.com/rear/rear/pull/2051</a>
was also wrong<br />
or<br />
<code>BootLoader</code> should be set by using <code>$TARGET_FS_ROOT/$UEFI_BOOTLOADER</code></p>
<h4 id="jsmeix_commented_at_2019-11-13_1500"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2275#issuecomment-553440847">2019-11-13 15:00</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-11-13_1500" title="Permanent link">&para;</a></h4>
<p>I think how BootLoader is currently set via</p>
<pre><code>BootLoader=$( echo $UEFI_BOOTLOADER | cut -d"/" -f4- | sed -e 's;/;\\;g' )
</code></pre>
<p>looks terribly fragile because the result depends in a hardcoded way<br />
how many <code>/</code> characters there are - for example as in</p>
<pre><code># echo '/mnt/local//boot/efi/EFI/centos/grubx64.efi' | cut -d"/" -f4- | sed -e 's;/;\\;g'
\boot\efi\EFI\centos\grubx64.efi

# echo '/mnt/local/boot/efi/EFI/centos/grubx64.efi' | cut -d"/" -f4- | sed -e 's;/;\\;g'
boot\efi\EFI\centos\grubx64.efi

# echo '/boot/efi/EFI/boot/bootx64.efi' | cut -d"/" -f4- | sed -e 's;/;\\;g'
EFI\boot\bootx64.efi

# echo 'boot/efi/EFI/boot/bootx64.efi' | cut -d"/" -f4- | sed -e 's;/;\\;g'
boot\bootx64.efi
</code></pre>
<p>and no comment that tells the reason behind<br />
the hardcoded cut after 3 '/' characters.</p>
<p>@gdha<br />
do you perhaps know about the reason behind the</p>
<pre><code>... | cut -d"/" -f4- | ...
</code></pre>
<p>part?</p>
<h4 id="franciscohosting_commented_at_2019-11-13_1534"><img src="https://avatars.githubusercontent.com/u/56039320?v=4" width="50"><a href="https://github.com/franciscohosting">franciscohosting</a> commented at <a href="https://github.com/rear/rear/issues/2275#issuecomment-553455971">2019-11-13 15:34</a>:<a class="headerlink" href="#franciscohosting_commented_at_2019-11-13_1534" title="Permanent link">&para;</a></h4>
<p>I found a mistake in my backup, I wasn't backing up /boot/efi because it
was in fat16 and I was using a LinuxAll File system, I'm not sure if you
know about the file-sets in bareos, but here is my updated file-set:<br />
<a href="https://github.com/rear/rear/files/3841966/labobject2-test.txt">labobject2-test.txt</a><br />
Now I get this log file with rear -D recover:<br />
<a href="https://github.com/rear/rear/files/3841985/rear-labobject2.log">rear-labobject2.log</a><br />
Something about<br />
<code>EFI variables are not supported on this system.</code></p>
<p>I don't know if its important, but I created the bootable usb doing:</p>
<pre><code>isohybrid -u rear-labobject2.iso
sudo dd if=rear-labobject2.iso of=/dev/sdb bs=4M &amp;&amp; syn
</code></pre>
<h4 id="jsmeix_commented_at_2019-11-13_1609"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2275#issuecomment-553472043">2019-11-13 16:09</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-11-13_1609" title="Permanent link">&para;</a></h4>
<p>@franciscohosting<br />
in your new <code>rear -D recover</code> log file<br />
<a href="https://github.com/rear/rear/files/3841985/rear-labobject2.log">https://github.com/rear/rear/files/3841985/rear-labobject2.log</a><br />
there is</p>
<pre><code>+ source /usr/share/rear/finalize/Linux-i386/670_run_efibootmgr.sh
...
++ test -f /mnt/local//boot/efi/EFI/centos/grubx64.efi
...
+++ echo /boot/efi/EFI/centos/grubx64.efi
+++ cut -d/ -f4-
+++ sed -e 's;/;\\;g'
++ BootLoader='EFI\centos\grubx64.efi'
...
++ efibootmgr --create --gpt --disk /dev/sdb --part 1 --write-signature --label 'RedHatEnterpriseServer 7' --loader '\EFI\centos\grubx64.efi'
EFI variables are not supported on this system.
</code></pre>
<p>so the <code>efibootmgr</code> call fails with</p>
<pre><code>EFI variables are not supported on this system.
</code></pre>
<p>but I am not a sufficient UEFI expert to know what that actually means.</p>
<p>What I found by Googling for</p>
<pre><code>efibootmgr "EFI variables are not supported on this system"
</code></pre>
<p>is<br />
<a href="https://unix.stackexchange.com/questions/91620/efi-variables-are-not-supported-on-this-system">https://unix.stackexchange.com/questions/91620/efi-variables-are-not-supported-on-this-system</a><br />
and<br />
<a href="https://bbs.archlinux.org/viewtopic.php?id=223874">https://bbs.archlinux.org/viewtopic.php?id=223874</a><br />
that both talk about the <code>efivars</code> kernel module.</p>
<p>As far as I understand it the kernel that is used when <code>efibootmgr</code> is
run<br />
is the kernel of the ReaR recovery system so I think that kernel has<br />
no <code>efivars</code> kernel module loaded.</p>
<p>To get it loaded run</p>
<pre><code>modprobe efivars
</code></pre>
<p>directly after you logged in as root in the ReaR recovery system<br />
(i.e. before you run <code>rear -D recover</code>).</p>
<p>For example on my currently used openSUSE Leap 15.0 UEFI system<br />
I have the <code>efivars</code> kernel module loaded</p>
<pre><code># lsmod | grep -i efi
efivarfs               16384  1
</code></pre>
<p>Because since ReaR 2.5. there is by default <code>MODULES=( 'all_modules' )</code>,
cf.<br />
<a href="https://github.com/rear/rear.github.com/blob/master/documentation/release-notes-2-5.md">https://github.com/rear/rear.github.com/blob/master/documentation/release-notes-2-5.md</a><br />
you should have all kernel modules available in the<br />
ReaR recovery system so that <code>modprobe efivars</code> therein<br />
should work.</p>
<p>In general regarding issues with third party backup tools:<br />
Usually there is nothing at all what we at ReaR upstream<br />
could do in case of issues with third-party backup tools<br />
because usually we neither have nor use such software<br />
so that we can neither test nor reproduce anything.<br />
Therefore in case of issues with third party backup tools<br />
you shoud also ask for help and support where<br />
you got your particular third party backup tool.</p>
<h4 id="gozora_commented_at_2019-11-13_1902"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/2275#issuecomment-553551362">2019-11-13 19:02</a>:<a class="headerlink" href="#gozora_commented_at_2019-11-13_1902" title="Permanent link">&para;</a></h4>
<p>Hello @jsmeix</p>
<blockquote>
<p>So from my point of view<br />
either<br />
the current test is wrong and then<br />
#2051 was also wrong<br />
or<br />
BootLoader should be set by using $TARGET_FS_ROOT/$UEFI_BOOTLOADER</p>
</blockquote>
<p>Actually non of above is true ;-)</p>
<p><code>test -f "$TARGET_FS_ROOT/$UEFI_BOOTLOADER" || return 0</code> is executed in
finalize stage after restore is over. As the description of #2051 says
(allow me narcissistically quote my self):</p>
<blockquote>
<p>When system is set for UEFI boot,
finalize/Linux-i386/630_run_efibootmgr.sh script should create boot
menu entry via efibootmgr. This however never happens because script
is looking for $UEFI_BOOTLOADER outside chroot (/mnt/local)
environment, where we unlikely find $UEFI_BOOTLOADER. This leads to
messages like shown in #2035 (comment) (despite system might still
boot without any problem).<br />
This patch changes condition mentioned earlier and looks for
$UEFI_BOOTLOADER inside of chrooted environment (/mnt/local).</p>
</blockquote>
<p><code>efibootmgr --create ... --loader "\\${BootLoader}"</code> on the other hand
creates UEFI boot entry (similar to entry in <em>grub.cfg</em>) where we can't
prefix <em>$TARGET_FS_ROOT</em> because such path simply doesn't exist when
system is restored and rebooted.</p>
<p>So from my point of view, current ReaR code is totally fine.</p>
<p>V.</p>
<h4 id="franciscohosting_commented_at_2019-11-13_1955"><img src="https://avatars.githubusercontent.com/u/56039320?v=4" width="50"><a href="https://github.com/franciscohosting">franciscohosting</a> commented at <a href="https://github.com/rear/rear/issues/2275#issuecomment-553574726">2019-11-13 19:55</a>:<a class="headerlink" href="#franciscohosting_commented_at_2019-11-13_1955" title="Permanent link">&para;</a></h4>
<p>in Centos 7 running normally, the following commands give no output:</p>
<pre><code># modprobe efivars
# smod | grep -i efi
</code></pre>
<p>but if I do:</p>
<pre><code># mount -t efivarfs efivarfs /sys/firmware/efi/efivars
mount: efivarfs is already mounted or /sys/firmware/efi/efivars busy
       efivarfs is already mounted on /sys/firmware/efi/efivars
</code></pre>
<p>In rear doing the first two commands don't give an output too, but
<code>mount -t efivarfs efivarfs /mnt/local/sys/firmware/efi/efivars</code>
gives:<br />
<code>mount: unknown filesystem type 'efivarfs'</code></p>
<h4 id="gozora_commented_at_2019-11-13_2101"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/2275#issuecomment-553600367">2019-11-13 21:01</a>:<a class="headerlink" href="#gozora_commented_at_2019-11-13_2101" title="Permanent link">&para;</a></h4>
<p>@franciscohosting I don't see this as a problem,<br />
If you have <em>efivarfs</em> mounted and don't see any module loaded, it is
most probably direct part of your kernel.</p>
<p>This however does not explain your message
<code>EFI variables are not supported on this system.</code> in ReaR recovery
system.</p>
<p>Are you restoring your original system to same HW or to new one ?<br />
Are you 100% sure that your destination HW is UEFI compatible at the
time of restore ?</p>
<p>V.</p>
<h4 id="franciscohosting_commented_at_2019-11-13_2259"><img src="https://avatars.githubusercontent.com/u/56039320?v=4" width="50"><a href="https://github.com/franciscohosting">franciscohosting</a> commented at <a href="https://github.com/rear/rear/issues/2275#issuecomment-553643569">2019-11-13 22:59</a>:<a class="headerlink" href="#franciscohosting_commented_at_2019-11-13_2259" title="Permanent link">&para;</a></h4>
<p>I did it! It seems that the bios forced legacy when booting with the usb
(didn't have an option to force UEFI or disable legacy support), I
burned the image to a DVD and worked without an issue, Thanks every one!</p>
<h4 id="jsmeix_commented_at_2019-11-14_0857"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2275#issuecomment-553790179">2019-11-14 08:57</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-11-14_0857" title="Permanent link">&para;</a></h4>
<p>@gozora<br />
thank you so much for your help and your explanation<br />
how things are meant to work!</p>
<p>I will add explanatory comments to the <code>efibootmgr</code> call in<br />
usr/share/rear/finalize/Linux-i386/670_run_efibootmgr.sh<br />
because that part was obscure to me (as a non UEFI expert).</p>
<p>I still have a question because we still have a possibly severe<br />
issue in the code that belongs to the <code>efibootmgr</code> call, see<br />
<a href="https://github.com/rear/rear/issues/2275#issuecomment-553440847">https://github.com/rear/rear/issues/2275#issuecomment-553440847</a></p>
<pre><code>BootLoader=$( echo $UEFI_BOOTLOADER | cut -d"/" -f4- | sed -e 's;/;\\;g' )
...
... efibootmgr ... --loader "\\${BootLoader}" ...
</code></pre>
<p>where that <code>cut -d"/" -f4-</code> cuts away the fist hardcoded two or three<br />
directories (depending on whether or not there is a leading <code>/</code>)<br />
so that all depends on that there are always two or three leading<br />
directories (and that there is or is not a leading <code>/</code>) that need<br />
to be cut away to get the right value for <code>--loader</code>.</p>
<p>My question is:<br />
What is the generically right value for the <code>efibootmgr  --loader</code>
option?</p>
<p>My <code>man efibootmgr</code> does not tell anything useful about what the<br />
right value for <code>--loader</code> is.</p>
<p>What I need to learn is:<br />
When some leading directories need to be cut away from the<br />
path to the efibootmgr loader file in the currently running system<br />
what trailing part of the system's efibootmgr loader file path is
right<br />
so that things work for the UEFI firmware during booting?</p>
<h4 id="jsmeix_commented_at_2019-11-14_0928"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2275#issuecomment-553802315">2019-11-14 09:28</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-11-14_0928" title="Permanent link">&para;</a></h4>
<p>@franciscohosting<br />
thank you for your prompt feedback what made things working for you.</p>
<p>I think I vaguely remember that a colleague had told me<br />
it depends on the boot medium whether or not the firmware<br />
goes into UEFI mode or falls back to BIOS mode.</p>
<p>I think he told me to install a Linux system where<br />
UEFI should be used to boot the installed Linux system<br />
the installation system boot medium must let the firmware<br />
boot in UEFI mode - otherwise (i.e. when the firmware boots<br />
the installation system in BIOS mode) the installed system<br />
can use only BIOS mode to set up its bootloader.</p>
<p>Because the ReaR recovery system is a Linux installation system,<br />
cf. "Disaster recovery means installation (reinstalling from scratch)"<br />
and "How disaster recovery with ReaR basically works" in<br />
<a href="https://en.opensuse.org/SDB:Disaster_Recovery">https://en.opensuse.org/SDB:Disaster_Recovery</a><br />
you need to boot the ReaR recovery system in UEFI mode<br />
to be able to reinstall your Linux system with ReaR<br />
when UEFI should be used to boot the reinstalled system.</p>
<p>Regarding how to create a UEFI bootable ReaR recovery system on USB<br />
see the <code>USB_*</code> variables in default.conf in particular
USB_UEFI_PART_SIZE<br />
and you need to prepare your USB device with "rear format" where you<br />
need to explicitly specify the '--efi' option like</p>
<pre><code>rear -v format -- --efi /dev/sdX
</code></pre>
<p>Note the mandatory <code>--</code> before the format workflow specific options,
cf.<br />
<a href="https://github.com/rear/rear/pull/2172#issuecomment-508376871">https://github.com/rear/rear/pull/2172#issuecomment-508376871</a></p>
<h4 id="franciscohosting_commented_at_2019-11-14_1405"><img src="https://avatars.githubusercontent.com/u/56039320?v=4" width="50"><a href="https://github.com/franciscohosting">franciscohosting</a> commented at <a href="https://github.com/rear/rear/issues/2275#issuecomment-553902503">2019-11-14 14:05</a>:<a class="headerlink" href="#franciscohosting_commented_at_2019-11-14_1405" title="Permanent link">&para;</a></h4>
<p>Ok, so I checked again default.conf, and it shows a way of creating raw
bootable images, that can be easily used with usb sticks:<br />
<a href="https://github.com/rear/rear/blob/master/usr/share/rear/conf/default.conf#L792">https://github.com/rear/rear/blob/master/usr/share/rear/conf/default.conf#L792</a><br />
I updated my site.conf to:</p>
<pre><code>BACKUP=BAREOS
BAREOS_CLIENT=labobject2-fd
BAREOS_FILESET=labobject2-test
BAREOS_RESTORE_JOB=restoreLabobject2-fdIso
SSH_ROOT_PASSWORD=*******
OUTPUT_URL=file:///tmp/bareos-restores
OUTPUT=RAWDISK
RAWDISK_IMAGE_COMPRESSION_COMMAND=''
RAWDISK_BOOT_EXCLUDE_SYSLINUX_LEGACY='yes'
RAWDISK_BOOT_EXCLUDE_SYSLINUX_EFI='yes'
RAWDISK_BOOT_EXCLUDE_GRUB2_EFI='no'
</code></pre>
<p>but when doing <code>rear -D mkrescue</code> it gives me the following error:<br />
<code>ERROR: Creating a raw disk image requires an EFI bootloader or syslinux</code><br />
with this log:<br />
<a href="https://github.com/rear/rear/files/3846834/rear-labobject2.log">rear-labobject2.log</a></p>
<p>Which is weird, because rear has detected my EFI bootloader as it can be
seen here:</p>
<pre><code>[root@labobject2 ~]# rear -D mkrescue
Relax-and-Recover 2.5 / 2019-05-10
Running rear mkrescue (PID 8259)
Using log file: /var/log/rear/rear-labobject2.log
Found EFI system partition /dev/sdb1 on /boot/efi type vfat
Using UEFI Boot Loader for Linux (USING_UEFI_BOOTLOADER=1)
Using autodetected kernel '/boot/vmlinuz-3.10.0-1062.4.1.el7.x86_64' as kernel in the recovery system
Creating disk layout
Using guessed bootloader 'EFI' (found in first bytes on /dev/sda)
Verifying that the entries in /var/lib/rear/layout/disklayout.conf are correct ...
Creating root filesystem layout
Handling network interface 'enp6s0'
enp6s0 is a physical device
Handled network interface 'enp6s0'
Trying to find what to use as UEFI bootloader...
Trying to find a 'well known file' to be used as UEFI bootloader...
Using '/boot/efi/EFI/centos/grubx64.efi' as UEFI bootloader file
Copying logfile /var/log/rear/rear-labobject2.log into initramfs as '/tmp/rear-labobject2-partial-2019-11-14T15:01:14+0100.log'
Copying files and directories
Copying binaries and libraries
Copying all kernel modules in /lib/modules/3.10.0-1062.4.1.el7.x86_64 (MODULES contains 'all_modules')
Copying all files in /lib*/firmware/
Skip copying broken symlink '/etc/mtab' target '/proc/16412/mounts' on /proc/ /sys/ /dev/ or /run/
Broken symlink '/usr/lib/modules/3.10.0-1062.4.1.el7.x86_64/build' in recovery system because 'readlink' cannot determine its link target
Broken symlink '/usr/lib/modules/3.10.0-1062.4.1.el7.x86_64/source' in recovery system because 'readlink' cannot determine its link target
Broken symlink '/var/lib/rear/moved_away_after_backup_restore/boot/grub2/grubenv' in recovery system because 'readlink' cannot determine its link target
Testing that the recovery system in /tmp/rear.i1BncSvGFMrsL5d/rootfs contains a usable system
Creating recovery/rescue system initramfs/initrd initrd.cgz with gzip default compression
Created initrd.cgz with gzip default compression (253401523 bytes) in 25 seconds
DISABLED: Using syslinux to create a BIOS Legacy bootloader
ERROR: Creating a raw disk image requires an EFI bootloader or syslinux
Some latest log messages since the last called script 280_create_bootable_disk_image.sh:
  2019-11-14 15:01:57.988092527 Including output/RAWDISK/Linux-i386/280_create_bootable_disk_image.sh
  2019-11-14 15:01:57.990264151 Entering debugscripts mode via 'set -x'.
  2019-11-14 15:01:57.997809976 DISABLED: Using syslinux to create a BIOS Legacy bootloader
Aborting due to an error, check /var/log/rear/rear-labobject2.log for details
Exiting rear mkrescue (PID 8259) and its descendant processes ...
Running exit tasks
You should also rm -Rf /tmp/rear.i1BncSvGFMrsL5d
Terminated
</code></pre>
<h4 id="franciscohosting_commented_at_2019-11-14_1436"><img src="https://avatars.githubusercontent.com/u/56039320?v=4" width="50"><a href="https://github.com/franciscohosting">franciscohosting</a> commented at <a href="https://github.com/rear/rear/issues/2275#issuecomment-553914996">2019-11-14 14:36</a>:<a class="headerlink" href="#franciscohosting_commented_at_2019-11-14_1436" title="Permanent link">&para;</a></h4>
<p>I found the mistake, in 270_create_grub2_efi_bootloader.sh, it looks
if binary <code>grub-mkimage</code> exists, but it should be <code>grub2-mkimage</code>,
should I make a pull request?</p>
<h4 id="jsmeix_commented_at_2019-11-14_1456"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2275#issuecomment-553923647">2019-11-14 14:56</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-11-14_1456" title="Permanent link">&para;</a></h4>
<p>@franciscohosting<br />
we appreciate all contributions that improve ReaR<br />
in particular GitHub pull requests.</p>
<p>Regarding how to make a GitHub pull request<br />
you may have a look at the section "Contributing" in<br />
<a href="http://relax-and-recover.org/development">http://relax-and-recover.org/development</a><br />
and the section "How to contribute to Relax-and-Recover" in<br />
<a href="https://en.opensuse.org/SDB:Disaster_Recovery">https://en.opensuse.org/SDB:Disaster_Recovery</a></p>
<p>In this particular case regarding GRUB2 program names<br />
like <code>grub-something</code> versus <code>grub2-something</code>:</p>
<p>Both kind of names exist "out there in the wild"<br />
so special code is needed so that ReaR works everywhere,<br />
cf. the section "Maintain backward compatibility" in<br />
<a href="https://github.com/rear/rear/wiki/Coding-Style">https://github.com/rear/rear/wiki/Coding-Style</a></p>
<p>Fortunately in other scripts this issue is already solved<br />
so that you can reuse the matching code e.g. from<br />
<a href="https://github.com/rear/rear/blob/master/usr/share/rear/finalize/Linux-i386/660_install_grub2.sh#L57">https://github.com/rear/rear/blob/master/usr/share/rear/finalize/Linux-i386/660_install_grub2.sh#L57</a><br />
where in particular a variable <code>grub_name</code> is set to <code>grub2</code> or <code>grub</code><br />
depending if <code>boot/grub2</code> or <code>boot/grub</code> exists - it even shows an
error<br />
if neither exist, cf. "Try hard to care about possible errors" in<br />
<a href="https://github.com/rear/rear/wiki/Coding-Style">https://github.com/rear/rear/wiki/Coding-Style</a><br />
so that later GRUB2 programs can be called as <code>$grub_name-...</code></p>
<h4 id="franciscohosting_commented_at_2019-11-14_1541"><img src="https://avatars.githubusercontent.com/u/56039320?v=4" width="50"><a href="https://github.com/franciscohosting">franciscohosting</a> commented at <a href="https://github.com/rear/rear/issues/2275#issuecomment-553944485">2019-11-14 15:41</a>:<a class="headerlink" href="#franciscohosting_commented_at_2019-11-14_1541" title="Permanent link">&para;</a></h4>
<p>Ok! will do!</p>
<h4 id="gozora_commented_at_2019-11-14_1855"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/2275#issuecomment-554028783">2019-11-14 18:55</a>:<a class="headerlink" href="#gozora_commented_at_2019-11-14_1855" title="Permanent link">&para;</a></h4>
<p>Hello @jsmeix</p>
<p>I think that <code>cut -d"/" -f4-</code> is just some kind of leftover from good
old times, when it was expected that UEFI bootloader will be on fixed
location (/boot/efi/EFI/&lt;some_directory&gt;/bootx64.efi). I agree
that it is not very safe, but it seems to cover most of the cases. There
might be several reasons why it was not reported so far.</p>
<ul>
<li>many people still use UEFI in legacy mode just because this mode
    make more sense for them, or because of historical reasons.</li>
<li>If people use UEFI they don't mess with bootloader and keep it on
    default location (many distros use variant of location I've
    mentioned earlier.</li>
<li>if people use UEFI and recover server with ReaR they don't even need
    to notice that something went wrong with <code>efibootmgr</code> because boot
    entry is already there and system boots OK.</li>
<li>even if it might not appear at first glance, UEFI have some very
    reasonable defaults when looking for boot loader and many times it
    finds some working boot loader during its fallback trip ...</li>
</ul>
<blockquote>
<p>What is the generically right value for the efibootmgr --loader
option?</p>
</blockquote>
<p><code>--loader</code> value is working path to bootloader binary (e.g. bootx64.efi)
but this value relative to ESP.<br />
I'll take my home computer as an example:<br />
I have following entry in <em>/etc/fstab</em></p>
<pre><code>UUID=B4EF-728C  /boot/efi       vfat    umask=0077      0       1
</code></pre>
<p>and following UEFI entry:</p>
<pre><code>root@hugo:~# efibootmgr -v
...
Boot0004* debian    HD(3,GPT,bcd3c68d-6b4b-4f50-af18-cbc7ca9d77e6,0x121800,0x32000)/File(\EFI\DEBIAN\GRUBX64.EFI)
...
</code></pre>
<p>Full path to boot loader when normally booted inside LInux looks
something like: <em>/boot/efi/EFI/boot/bootx64.efi</em><br />
<code>\EFI\DEBIAN\GRUBX64.EFI</code> is <code>--loader</code> value. To construct this value,
you most probably need to take value of <code>$UEFI_BOOTLOADER</code> and remove
string representing ESP, from the beginning of the string (/boot/efi in
my case) and maybe flip forward slashes to back slashes (I think this
flipping slashes is not needed any more ...).<br />
UEFI doesn't know about other filesystems types that vfat, hence when in
UEFI all you can see is partition represented by <em>UUID=B4EF-728C</em> in
this example, hence from UEFI shell point of view your boot loader is
located under <em>\EFI\DEBIAN\GRUBX64.EFI</em>.</p>
<p>Hope it helps!</p>
<p>V.</p>
<h4 id="jsmeix_commented_at_2019-11-15_0848"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2275#issuecomment-554269093">2019-11-15 08:48</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-11-15_0848" title="Permanent link">&para;</a></h4>
<p>@gozora<br />
no need to "hope" you helped because as always<br />
your help helped me more than anything had helped before<br />
( huh! - it even became a rhyme - perhaps the beginning<br />
of a future glorious "Hymn of Praise to @gozora" ;-)<br />
cf.
<a href="https://en.wikipedia.org/wiki/Vogon#Poetry">https://en.wikipedia.org/wiki/Vogon#Poetry</a></p>
<p>Don't worry!<br />
You won't get a hymn from me but a pull request for review.<br />
( phew! - almost again a rhyme - but fortunately only almost ;-)</p>
<h4 id="jsmeix_commented_at_2019-11-15_0902"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2275#issuecomment-554273557">2019-11-15 09:02</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-11-15_0902" title="Permanent link">&para;</a></h4>
<p>@gozora<br />
some spontaneous (perhaps crazy) offhanded ideas<br />
based on your above 'mount' and <code>efibootmgr -v</code> info.</p>
<p>FYI<br />
what I have on my openSUSE Leap 15.0 system<br />
where I use UEFI but no secure boot:</p>
<pre><code># mount | grep vfat
/dev/sda1 on /boot/efi type vfat (rw,relatime,fmask=0022,dmask=0022,codepage=437,iocharset=iso8859-1,shortname=mixed,errors=remount-ro)

# efibootmgr -v
BootCurrent: 0000
Timeout: 2 seconds
BootOrder: 0000,0016,0017,0014,001A,0012,0013,0015,0010
Boot0000* opensuse-secureboot   HD(1,GPT,841a03d5-4e52-4634-b21a-43935c88f5af,0x800,0xfa000)/File(\EFI\opensuse\shim.efi)
Boot0010  Diskette Drive        BBS(Floppy,Diskette Drive,0x0)..BO
Boot0012* SAMSUNG SSD SM951 M.2 256G    BBS(HD,P0: SAMSUNG SSD SM951 M.2 256G,0x0)..BO
Boot0013* USB Storage Device    BBS(USB,USB Storage Device,0x0)..BO
Boot0014* CD/DVD/CD-RW Drive    BBS(CDROM,P0: PLDS DVD+/-RW DH-16AES    ,0x0)..BO
Boot0015* Onboard NIC   BBS(Network,IBA GE Slot 00C8 v1550,0x0)..BO
Boot0016* Onboard NIC(IPV4)     PciRoot(0x0)/Pci(0x19,0x0)/MAC(64006a64c006,0)/IPv4(0.0.0.0:0&lt;-&gt;0.0.0.0:0,0,0)..BO
Boot0017* Onboard NIC(IPV6)     PciRoot(0x0)/Pci(0x19,0x0)/MAC(64006a64c006,0)/IPv6([::]:&lt;-&gt;[::]:,0,0)..BO
Boot001A* WDC WD10EZEX-75M2NA0          BBS(HD,P0: WDC WD10EZEX-75M2NA0      ,0x0)..BO

# find /boot/efi | grep shim.efi
/boot/efi/EFI/opensuse/shim.efi
</code></pre>
<p>My ideas:</p>
<p>1.)<br />
In finalize/Linux-i386/670_run_efibootmgr.sh<br />
we already determine the ESP mount point in $TARGET_FS_ROOT<br />
so I think this is the leading part that actually needs to be cut<br />
from the loader's full path name on the Linux system<br />
to get the loader's path name inside the ESP.</p>
<p>2.)<br />
Perhaps it works to run <code>efibootmgr -v</code> inside
<code>chroot $TARGET_FS_ROOT</code><br />
(I don't know what environment <code>efibootmgr -v</code> needs to work
properly).<br />
If this works we could "grep" the loader's path name inside the ESP<br />
from the <code>efibootmgr -v</code> output.</p>
<h4 id="jsmeix_commented_at_2019-11-26_0805"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2275#issuecomment-558510246">2019-11-26 08:05</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-11-26_0805" title="Permanent link">&para;</a></h4>
<p>I think with
<a href="https://github.com/rear/rear/pull/2278">https://github.com/rear/rear/pull/2278</a>
merged<br />
the part of this issue
<a href="https://github.com/rear/rear/pull/2277">https://github.com/rear/rear/pull/2277</a><br />
is now fixed.</p>
<p>But the other parts (basically some UEFI booting cleanup)<br />
are not yet fixed.</p>
<h4 id="github-actions_commented_at_2020-06-29_0137"><img src="https://avatars.githubusercontent.com/in/15368?v=4" width="50"><a href="https://github.com/apps/github-actions">github-actions</a> commented at <a href="https://github.com/rear/rear/issues/2275#issuecomment-650857763">2020-06-29 01:37</a>:<a class="headerlink" href="#github-actions_commented_at_2020-06-29_0137" title="Permanent link">&para;</a></h4>
<p>Stale issue message</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2024 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2019-11-11.2275.issue.closed.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/rear/rear-user-guide" class="fa fa-code-fork" style="color: #fcfcfc"> rear/rear-user-guide</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
