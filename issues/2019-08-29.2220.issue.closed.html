<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#2220 Issue closed: bash internal overflow because element zero of CLONE_USERS array is "", resulting in rear doing 'getent passwd' following by 'getent group' for all GIDs - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#2220 Issue closed: bash internal overflow because element zero of CLONE_USERS array is \"\", resulting in rear doing \u0027getent passwd\u0027 following by \u0027getent group\u0027 for all GIDs";
        var mkdocs_page_input_path = "issues/2019-08-29.2220.issue.closed.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/backup_netfs.html">Example of BACKUP=NETFS</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../development/squash-git-log-commments.html">How to squash git log comments into one line</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear29.html">Release Notes ReaR 2.9</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear28.html">Release Notes ReaR 2.8</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#2220 Issue closed: bash internal overflow because element zero of CLONE_USERS array is "", resulting in rear doing 'getent passwd' following by 'getent group' for all GIDs</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="2220_issue_closed_bash_internal_overflow_because_element_zero_of_clone_users_array_is_resulting_in_rear_doing_getent_passwd_following_by_getent_group_for_all_gids"><a href="https://github.com/rear/rear/issues/2220">#2220 Issue</a> <code>closed</code>: bash internal overflow because element zero of CLONE_USERS array is "", resulting in rear doing 'getent passwd' following by 'getent group' for all GIDs<a class="headerlink" href="#2220_issue_closed_bash_internal_overflow_because_element_zero_of_clone_users_array_is_resulting_in_rear_doing_getent_passwd_following_by_getent_group_for_all_gids" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>bug</code>, <code>fixed / solved / done</code></p>
<h4 id="pcahyna_opened_issue_at_2019-08-29_1807"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> opened issue at <a href="https://github.com/rear/rear/issues/2220">2019-08-29 18:07</a>:<a class="headerlink" href="#pcahyna_opened_issue_at_2019-08-29_1807" title="Permanent link">&para;</a></h4>
<h4 id="relax-and-recover_rear_issue_template">Relax-and-Recover (ReaR) Issue Template<a class="headerlink" href="#relax-and-recover_rear_issue_template" title="Permanent link">&para;</a></h4>
<p>Fill in the following items before submitting a new issue<br />
(quick response is not guaranteed with free support):</p>
<ul>
<li>
<p>ReaR version ("/usr/sbin/rear -V"):<br />
    Relax-and-Recover 2.4 / Git</p>
</li>
<li>
<p>OS version ("cat /etc/rear/os.conf" or "lsb_release -a" or "cat
    /etc/os-release"):<br />
    RedHatEnterpriseServer 7</p>
</li>
<li>
<p>ReaR configuration files ("cat /etc/rear/site.conf" and/or "cat
    /etc/rear/local.conf"):<br />
    not available</p>
</li>
<li>
<p>Hardware (PC or PowerNV BareMetal or ARM) or virtual machine (KVM
    guest or PoverVM LPAR):<br />
    PC</p>
</li>
<li>
<p>System architecture (x86 compatible or PPC64/PPC64LE or what exact
    ARM device):<br />
    x86_64</p>
</li>
<li>
<p>Firmware (BIOS or UEFI or Open Firmware) and bootloader (GRUB or
    ELILO or Petitboot):<br />
    Any/GRUB</p>
</li>
<li>
<p>Storage (local disk or SSD) and/or SAN (FC or iSCSI or FCoE) and/or
    multipath (DM or NVMe):<br />
    any</p>
</li>
<li>
<p>Description of the issue (ideally so that others can reproduce
    it):<br />
    With a huge number of users, groups and users in each group (tens of
    thousands), ReaR may abort with this in the log:</p>
<pre><code>Including rescue/default/900_clone_users_and_groups.sh
Cloning users:  daemon rpc usbmuxd usbmux vcsa nobody dbus
/usr/share/rear/rescue/default/900_clone_users_and_groups.sh: xrealloc: cannot allocate 18446744071562067968 bytes (6635520 bytes allocated)
</code></pre>
<p>The underlying problem is:</p>
<ul>
<li>
<p>/usr/share/rear/conf/GNU/Linux.conf ends up setting
    <code>${CLONE_USERS[0]}</code> to <code>""</code>:
        CLONE_USERS=( "${CLONE_USERS[@]:-}" daemon rpc usbmuxd usbmux vcsa nobody dbus )</p>
</li>
<li>
<p>This then results in the for loop in
    <a href="https://github.com/rear/rear/blob/b7a75c3a39ee8cf0402f83da7fca8df231c7b979/usr/share/rear/rescue/default/900_clone_users_and_groups.sh#L42">https://github.com/rear/rear/blob/b7a75c3a39ee8cf0402f83da7fca8df231c7b979/usr/share/rear/rescue/default/900_clone_users_and_groups.sh#L42</a>
    doing 'getent passwd' without additional parameters in the first
    iteration, thus dumping ALL users (<code>$user</code> is set to <code>""</code>)
        for user in "${CLONE_USERS[@]}" ; do
            # Skip if the user exists already in the ReaR recovery system:
            grep -q "^$user:" $ROOTFS_DIR/etc/passwd &amp;&amp; continue
            # Skip if the user does not exist in the current system:
            if ! passwd_entry="$( getent passwd $user )" ; then
                Debug "Cannot clone user $user because it does not exist"
                continue
            fi</p>
</li>
<li>
<p>The script then ends up doing a 'getent group $groupID' where
    groupID which is every users GID
        groupID="$( cut -d ':' -f '4' &lt;&lt;&lt;"$passwd_entry" )"
        if ! group_entry="$( getent group $groupID )" ; then</p>
</li>
<li>
<p>With such a large number of users, groups and users in each
    groups, the output of the last command is so huge that the
    assignment to <code>group_entry</code> overflows some internal limit of
    bash.</p>
</li>
</ul>
<p>The problematic case is hard to reproduce as it requires a really
large amount of users, groups and users per group. However, the
underlying problem (which seems mostly harmless in more limited
settings) manifests itself easily:</p>
<pre><code>Cloning users:  daemon rpc usbmuxd usbmux vcsa nobody dbus
</code></pre>
<p>Note the additional space after :. This space is printed in the
first iteration of the loop with <code>$user</code> empty.</p>
<p>The root cause is the introduction of empty array elements in PR
#699 to pacify <code>set -ue</code> in bash 3, which can not cope with empty
arrays - so those were replaced by arrays with one empty member.
(Since there are more arrays which were changed this way in this
commit, it is possible that similar errors are more widespread.) See
our discussion in
<a href="https://github.com/rear/rear/commit/c19647fcd95f0c3f4020f39f5fad428e8359ec92#r32912187">https://github.com/rear/rear/commit/c19647fcd95f0c3f4020f39f5fad428e8359ec92#r32912187</a>,
<a href="https://github.com/rear/rear/commit/c19647fcd95f0c3f4020f39f5fad428e8359ec92#r32911995">https://github.com/rear/rear/commit/c19647fcd95f0c3f4020f39f5fad428e8359ec92#r32911995</a>,
<a href="https://github.com/rear/rear/commit/c19647fcd95f0c3f4020f39f5fad428e8359ec92#r32912160">https://github.com/rear/rear/commit/c19647fcd95f0c3f4020f39f5fad428e8359ec92#r32912160</a></p>
</li>
<li>
<p>Workaround, if any:<br />
    Not sure about workaround, but there are several possible fixes:</p>
<ul>
<li>
<p>The cleanest would be to revert the parts of PR #699 that
    introduce those empty array elements. The resulting problem in
    bash 3 and <code>set -ue</code> could be dealt with in the following ways:</p>
<ul>
<li>by ignoring it, i.e desupport bash 3 together with
    <code>set -ue</code>.<br />
    This does not seem to be a big problem, as <code>set -ue</code> in
    general (even bash 4) is apparently broken without anybody
    noticing:
    <a href="https://github.com/rear/rear/pull/1720/files#r317556097">https://github.com/rear/rear/pull/1720/files#r317556097</a>
    and there are further places that probably broke it more for
    bash 3 (non-exhaustive list, and some of them may be false
    positives, i.e. the arrays become non-empty at some point):<ul>
<li><code>BACKUP_PROG_INCLUDE</code>:<br />
<a href="https://github.com/rear/rear/commit/eb89244bad4a73eaed3bfcc4ddb9e85658819230#r34830311">https://github.com/rear/rear/commit/eb89244bad4a73eaed3bfcc4ddb9e85658819230#r34830311</a>
    <a href="https://github.com/rear/rear/blob/b7a75c3a39ee8cf0402f83da7fca8df231c7b979/usr/share/rear/backup/NETFS/default/400_create_include_exclude_files.sh#L3">https://github.com/rear/rear/blob/b7a75c3a39ee8cf0402f83da7fca8df231c7b979/usr/share/rear/backup/NETFS/default/400_create_include_exclude_files.sh#L3</a>
    <a href="https://github.com/rear/rear/blob/d8f1571a213a9df272327bb070e8a87f78fc14c3/usr/share/rear/layout/save/default/310_include_exclude.sh#L27">https://github.com/rear/rear/blob/d8f1571a213a9df272327bb070e8a87f78fc14c3/usr/share/rear/layout/save/default/310_include_exclude.sh#L27</a></li>
<li><code>BACKUP_PROG_EXCLUDE</code>:
    <a href="https://github.com/rear/rear/blob/950d14af59b9262525adf2f0f08bd990cb931e8c/usr/share/rear/backup/NETFS/default/400_create_include_exclude_files.sh#L19">https://github.com/rear/rear/blob/950d14af59b9262525adf2f0f08bd990cb931e8c/usr/share/rear/backup/NETFS/default/400_create_include_exclude_files.sh#L19</a></li>
<li><code>EXCLUDE_MOUNTPOINTS</code>:
    <a href="https://github.com/rear/rear/commit/7c3b34d467b9e03ca6c36b7478f6e6ae6f609ba7#r34830344">https://github.com/rear/rear/commit/7c3b34d467b9e03ca6c36b7478f6e6ae6f609ba7#r34830344</a>
    <a href="https://github.com/rear/rear/blob/b7a75c3a39ee8cf0402f83da7fca8df231c7b979/usr/share/rear/backup/NETFS/default/400_create_include_exclude_files.sh#L29">https://github.com/rear/rear/blob/b7a75c3a39ee8cf0402f83da7fca8df231c7b979/usr/share/rear/backup/NETFS/default/400_create_include_exclude_files.sh#L29</a></li>
<li><code>EXCLUDE_MD</code>:
    <a href="https://github.com/rear/rear/blob/d8f1571a213a9df272327bb070e8a87f78fc14c3/usr/share/rear/layout/save/default/310_include_exclude.sh#L35">https://github.com/rear/rear/blob/d8f1571a213a9df272327bb070e8a87f78fc14c3/usr/share/rear/layout/save/default/310_include_exclude.sh#L35</a></li>
<li><code>EXCLUDE_VG</code>:
    <a href="https://github.com/rear/rear/blob/d8f1571a213a9df272327bb070e8a87f78fc14c3/usr/share/rear/layout/save/default/310_include_exclude.sh#L41">https://github.com/rear/rear/blob/d8f1571a213a9df272327bb070e8a87f78fc14c3/usr/share/rear/layout/save/default/310_include_exclude.sh#L41</a></li>
<li><code>EXCLUDE_COMPONENTS</code>:
    <a href="https://github.com/rear/rear/blob/d8f1571a213a9df272327bb070e8a87f78fc14c3/usr/share/rear/layout/save/default/310_include_exclude.sh#L57">https://github.com/rear/rear/blob/d8f1571a213a9df272327bb070e8a87f78fc14c3/usr/share/rear/layout/save/default/310_include_exclude.sh#L57</a></li>
<li><code>EXCLUDE_RECREATE</code>:
    <a href="https://github.com/rear/rear/blob/d8f1571a213a9df272327bb070e8a87f78fc14c3/usr/share/rear/layout/save/default/310_include_exclude.sh#L63">https://github.com/rear/rear/blob/d8f1571a213a9df272327bb070e8a87f78fc14c3/usr/share/rear/layout/save/default/310_include_exclude.sh#L63</a></li>
<li><code>RmInArray</code>:
    <a href="https://github.com/rear/rear/commit/e51bbef1034bc8c18112299ffe81da1572bbbf50#r34792188">https://github.com/rear/rear/commit/e51bbef1034bc8c18112299ffe81da1572bbbf50#r34792188</a></li>
</ul>
</li>
<li>by protecting the array expansion in a bash 3 and <code>set -ue</code>
    compatible way: i.e. instead of <code>for i in "${A[@]}"</code> write
    <code>for i in ${A+"${A[@]:-}"}</code>. To test for an empty array,
    write <code>(( ${#A[@]} ))</code> or <code>[ ${#A[@]} -gt 0 ]</code>. This is
    possible, but would require lots of changes which would make
    the code a bit less readable.</li>
</ul>
</li>
<li>
<p>In the present case, a less invasive change would be to replace
    the appending to the array</p>
<pre><code>   CLONE_USERS=( "${CLONE_USERS[@]:-}" daemon rpc usbmuxd usbmux vcsa nobody dbus )
</code></pre>
<p>by <code>+=</code>, i.e.</p>
<pre><code>   CLONE_USERS+=( daemon rpc usbmuxd usbmux vcsa nobody dbus )
</code></pre>
<p>(I've verified that <code>+=</code> works properly even in bash 3 and
<code>set -ue</code>.) This would fix the present case and other cases
where the problem lies in appending to arrays, but not those
where the array is already initialized to <code>("")</code>.</p>
</li>
<li>
<p>The most basic fix is to compensate for the fake empty element:</p>
<pre><code>for user in "${CLONE_USERS[@]}" ; do
    [[ -z ${user:-} ]] &amp;&amp; continue
    # Skip if the user exists already in the ReaR recovery system:
</code></pre>
<p>and if similar problems are found or newly introduced elsewhere,
fix them in a similar way.</p>
<p>It is also the least desirable fix IMHO, because it pollutes the
code to work around an artificial element that should not be
there in the first place, and one will have to remember to work
around it in every new loop that is introduced.</p>
</li>
</ul>
<p>I would to like to discuss which path to take and I will then submit
a PR.</p>
</li>
<li>
<p>Attachments, as applicable ("rear -D mkrescue/mkbackup/recover"
    debug log files):<br />
    See above for relevant log snippets.</p>
</li>
</ul>
<h4 id="jsmeix_commented_at_2019-08-30_1359"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2220#issuecomment-526612502">2019-08-30 13:59</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-08-30_1359" title="Permanent link">&para;</a></h4>
<p>@pcahyna<br />
thank you so much for your careful analysis of the underlying root
cause<br />
and for your explanatory and comprehensive description.</p>
<p>Offhandedly I think this is just one more example that shows<br />
why 'set -eu' looks good in theory but does not work well in practice.</p>
<p>What does in particular not work in practice (with reasonable effort)<br />
is 'set -u'.</p>
<p>I experienced that yesterday with a privately made and used bash
script.<br />
While 'set -e' can be quite useful in practice at places where one must
not<br />
blindly proceeed with the next command unless the current command
succeeded<br />
(the best example for that in ReaR is the diskrestore.sh script),<br />
I think 'set -u' is only useful while one is making and testing a
script<br />
because it helps to detect misspelled variable names (for example<br />
as in <code>counter=conuter+1</code>) but from my experience 'set -u' as a general
setting<br />
while scripts are run does more harm than good.</p>
<p>So my current conclusion is to revert those things (in particular the
dummy<br />
array elements) that I had added to make the code work with 'set -u'<br />
because those added stuff breakes other code at other places.</p>
<p>Furthermore the ReaR code is meant to be adapted and enhanced as
needed<br />
by the user which means our scripts should be as much as possible in
compliance<br />
with "the usual way" how a normal bash script is made nowadays in
practice<br />
to avoid unexpected behaviour for the user when he changed a script.</p>
<p>By the way a related side note:<br />
Our global <code>shopt -s nullglob</code> setting in usr/sbin/rear<br />
<a href="https://github.com/rear/rear/blob/master/usr/sbin/rear#L292">https://github.com/rear/rear/blob/master/usr/sbin/rear#L292</a><br />
is another example where ReaR scripts do not behave as usually
expected:<br />
Have "fun" with code like <code>grep something my*files</code><br />
when nothing matches <code>my*files</code> ;-)</p>
<h4 id="pcahyna_commented_at_2019-08-30_1447"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/2220#issuecomment-526630034">2019-08-30 14:47</a>:<a class="headerlink" href="#pcahyna_commented_at_2019-08-30_1447" title="Permanent link">&para;</a></h4>
<p>@jsmeix the analysis of the particular problem was actually done by
@hartsjc - thanks! I did only the analysis of the root cause, related
issues and possible fixes.</p>
<h4 id="jsmeix_commented_at_2019-08-30_1550"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2220#issuecomment-526652580">2019-08-30 15:50</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-08-30_1550" title="Permanent link">&para;</a></h4>
<p>@pcahyna<br />
regarding your</p>
<pre><code>... set -ue in general (even bash 4) is apparently broken
without anybody noticing:
https://github.com/rear/rear/pull/1720/files#r317556097
</code></pre>
<p>Currently only the 'help' workflow should work with 'set -ue'<br />
all other workflows do not yet work with 'set -ue', cf.<br />
<a href="https://github.com/rear/rear/issues/700#issuecomment-158332829">https://github.com/rear/rear/issues/700#issuecomment-158332829</a><br />
and in<br />
<a href="https://github.com/rear/rear/pull/699">https://github.com/rear/rear/pull/699</a></p>
<pre><code>2.)
I fixed all what fails because of 'set -ue -o pipefail'
for the "help" workflow as a very first step into that direction.
</code></pre>
<p>Since that time nothing more was done, because it is questionable<br />
if it is worth the effort to make the code ready for 'set -eu',<br />
see also the later comments in<br />
<a href="https://github.com/rear/rear/issues/700">https://github.com/rear/rear/issues/700</a></p>
<h4 id="jsmeix_commented_at_2019-09-03_1418"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2220#issuecomment-527479184">2019-09-03 14:18</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-09-03_1418" title="Permanent link">&para;</a></h4>
<p>What needs to be fixed in any case in<br />
rescue/default/900_clone_users_and_groups.sh<br />
is the above mentioned</p>
<pre><code>The most basic fix is to compensate for the fake empty element:

for user in "${CLONE_USERS[@]}" ; do
    [[ -z ${user:-} ]] &amp;&amp; continue
</code></pre>
<p>because CLONE_USERS and CLONE_GROUPS are user config variables<br />
and things need to still work if the user had set (by accident) an array
element<br />
that is empty or only blanks<br />
cf.
<a href="https://github.com/rear/rear/commit/c19647fcd95f0c3f4020f39f5fad428e8359ec92#r32912521">https://github.com/rear/rear/commit/c19647fcd95f0c3f4020f39f5fad428e8359ec92#r32912521</a></p>
<h4 id="jsmeix_commented_at_2019-09-03_1427"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2220#issuecomment-527483029">2019-09-03 14:27</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-09-03_1427" title="Permanent link">&para;</a></h4>
<p>With
<a href="https://github.com/rear/rear/commit/36cf20e2d8bc136b334c2a70460b645afb770a24">https://github.com/rear/rear/commit/36cf20e2d8bc136b334c2a70460b645afb770a24</a><br />
I skip empty user and group values (in a simple but not save for
<code>set -u</code> way).</p>
<h4 id="jsmeix_commented_at_2019-09-03_1441"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2220#issuecomment-527489396">2019-09-03 14:41</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-09-03_1441" title="Permanent link">&para;</a></h4>
<p>@hartsjc<br />
many thanks for your laborious analysis of the issue!</p>
<p>I think I will add a new section</p>
<pre><code>Beware of the emptiness!
</code></pre>
<p>to
<a href="https://github.com/rear/rear/wiki/Coding-Style">https://github.com/rear/rear/wiki/Coding-Style</a><br />
because so many tools behave very different if run with empty argument<br />
for example<br />
<code>grep something $some_file</code> when $some_file is empty or only blanks<br />
STDIN is used which lets rear hang up in practice because<br />
the user won't provide input<br />
or<br />
<code>ls $some_dir</code> when $some_dir is empty or only blanks which<br />
lists the current working directory (cf. above <code>shopt -s nullglob</code>)<br />
which is in practice always wrong because if one wants to list<br />
the current working directory one would not use $some_dir<br />
and so on...</p>
<h4 id="pcahyna_commented_at_2019-09-03_1911"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/2220#issuecomment-527598031">2019-09-03 19:11</a>:<a class="headerlink" href="#pcahyna_commented_at_2019-09-03_1911" title="Permanent link">&para;</a></h4>
<blockquote>
<p>What needs to be fixed in any case in<br />
rescue/default/900_clone_users_and_groups.sh<br />
is the above mentioned</p>
<pre><code>The most basic fix is to compensate for the fake empty element:

for user in "${CLONE_USERS[@]}" ; do
    [[ -z ${user:-} ]] &amp;&amp; continue
</code></pre>
<p>because CLONE_USERS and CLONE_GROUPS are user config variables<br />
and things need to still work if the user had set (by accident) an
array element<br />
that is empty or only blanks<br />
cf.
<a href="https://github.com/rear/rear/commit/c19647fcd95f0c3f4020f39f5fad428e8359ec92#r32912521">c19647f#r32912521</a></p>
</blockquote>
<p>I would not say it is a good idea to clutter the code with such tests
for things that user might do wrong with variables. What if users
accidentally sets it to "-h" or "-V" for example, I doubt that "getent"
will work as expected in this case. If this is really a concern, I
rather propose a shared function to validate arrays.<br />
I will send a PR for appending using +=, which is IMO the preferable
way, as it is simple yet clean (and does not interfere with your fix).
PR #2223</p>
<h4 id="hartsjc_commented_at_2019-09-03_2016"><img src="https://avatars.githubusercontent.com/u/5044577?u=0483f5a756fc60e2b2721b8303a30a84556f9b05&v=4" width="50"><a href="https://github.com/hartsjc">hartsjc</a> commented at <a href="https://github.com/rear/rear/issues/2220#issuecomment-527621879">2019-09-03 20:16</a>:<a class="headerlink" href="#hartsjc_commented_at_2019-09-03_2016" title="Permanent link">&para;</a></h4>
<blockquote>
<p>@hartsjc<br />
many thanks for your laborious analysis of the issue!</p>
</blockquote>
<p>Glad to be of help.</p>
<h4 id="jsmeix_commented_at_2019-09-03_2038"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2220#issuecomment-527629760">2019-09-03 20:38</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-09-03_2038" title="Permanent link">&para;</a></h4>
<p>@pcahyna<br />
I think there is a practical difference between when the user sets<br />
a non-empty wrong value where it is visible that this cannot work<br />
e.g. the value <code>$( rm -rf * )</code> ;-)<br />
compared to an empty or empty looking value where one may<br />
assume that what one cannot see cannot have a (bad) effect,<br />
so I think "beware of the emptiness" is reasonable and helpful<br />
in practice while it would be over the top if we tried to make ReaR<br />
safe against any possible nonsense values.</p>
<h4 id="jsmeix_commented_at_2019-09-05_1236"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2220#issuecomment-528343007">2019-09-05 12:36</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-09-05_1236" title="Permanent link">&para;</a></h4>
<p>Via
<a href="https://github.com/rear/rear/commit/b8b7e466ed85891eff67e6653fb2239f41655f82">https://github.com/rear/rear/commit/b8b7e466ed85891eff67e6653fb2239f41655f82</a><br />
I replaced in the comments in default.conf<br />
<code>ARRAY=( "${ARRAY[@]}" additional elements</code>)<br />
with the simpler and more fail safe<br />
<code>ARRAY+=( additional elements )</code><br />
according to
<a href="https://github.com/rear/rear/issues/2220#issue-487102052">https://github.com/rear/rear/issues/2220#issue-487102052</a></p>
<pre><code>I've verified that += works properly even in bash 3 and set -ue
</code></pre>
<h4 id="jsmeix_commented_at_2019-09-05_1249"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2220#issuecomment-528347818">2019-09-05 12:49</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-09-05_1249" title="Permanent link">&para;</a></h4>
<p>@pcahyna<br />
do you think it would be a good idea to replace<br />
<code>ARRAY=( "${ARRAY[@]}" additional elements )</code><br />
with<br />
<code>ARRAY+=( additional elements )</code><br />
everywhere in the ReaR code?</p>
<p>I did a quick <code>find . | xargs grep '=(.*[@]'</code> in ReaR master code<br />
which indicates there are more than 400 places where we use<br />
<code>ARRAY=( "${ARRAY[@]}" additional elements )</code></p>
<h4 id="pcahyna_commented_at_2019-09-05_1456"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/2220#issuecomment-528411039">2019-09-05 14:56</a>:<a class="headerlink" href="#pcahyna_commented_at_2019-09-05_1456" title="Permanent link">&para;</a></h4>
<p>@jsmeix yes, I don't see a reason why not to append using +=, do you
know why it has not been used in ReaR?</p>
<h4 id="pcahyna_commented_at_2019-09-05_1505"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/2220#issuecomment-528414774">2019-09-05 15:05</a>:<a class="headerlink" href="#pcahyna_commented_at_2019-09-05_1505" title="Permanent link">&para;</a></h4>
<blockquote>
<p>I think I will add a new section</p>
<pre><code>Beware of the emptiness!
</code></pre>
<p>to
<a href="https://github.com/rear/rear/wiki/Coding-Style">https://github.com/rear/rear/wiki/Coding-Style</a><br />
because so many tools behave very different if run with empty
argument<br />
for example<br />
<code>grep something $some_file</code> when $some_file is empty or only blanks<br />
STDIN is used which lets rear hang up in practice because<br />
the user won't provide input<br />
or<br />
<code>ls $some_dir</code> when $some_dir is empty or only blanks which<br />
lists the current working directory (cf. above <code>shopt -s nullglob</code>)<br />
which is in practice always wrong because if one wants to list<br />
the current working directory one would not use $some_dir<br />
and so on...</p>
</blockquote>
<p><code>grep something "$some_file"</code> and <code>ls "$some_dir"</code> behave properly, i.e.
fail. Empty parameter is not the same as a missing parameter, which
indeed often has a special meaning. The problem with bash that it makes
way too easy to treat undefined variables as missing values, instead of
as empty values. One more reason to quote variable expansion properly
(one should do it anyway because of blanks in values etc.). I think it
is therefore more productive to focus on quoting parameter expansion
rather than on inserting more and more code to guard against empty or
blank values.</p>
<h4 id="jsmeix_commented_at_2019-09-10_1325"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2220#issuecomment-529933383">2019-09-10 13:25</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-09-10_1325" title="Permanent link">&para;</a></h4>
<p>@pcahyna<br />
I do not know why <code>+=</code> was not used in ReaR.<br />
I guess perhaps because at the time when ReaR started<br />
<code>+=</code> might have been not yet supported in bash?</p>
<p>I would very much appreciate it if you could find an automated command<br />
(e.g. via <code>sed</code> or whatever tool you like) that replaces</p>
<pre><code>ARRAY=( "${ARRAY[@]}" additional elements )
</code></pre>
<p>with</p>
<pre><code>ARRAY+=( additional elements )
</code></pre>
<p>everywhere in the ReaR code without changing "false positives"<br />
i.e. without creating regressions.</p>
<p>You are right that proper quoting is mandatory for fail safe code<br />
but in practice ... :-(</p>
<p>FYI<br />
an example where I intentionally do not quote:</p>
<pre><code># Ensure $foo is a single non empty and non blank word
# (no quoting because test " " returns zero exit code):
test $foo ...
</code></pre>
<p>Perhaps there is a better way to do that?</p>
<h4 id="pcahyna_commented_at_2020-05-25_1258"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/2220#issuecomment-633560089">2020-05-25 12:58</a>:<a class="headerlink" href="#pcahyna_commented_at_2020-05-25_1258" title="Permanent link">&para;</a></h4>
<blockquote>
<p>Our global <code>shopt -s nullglob</code> setting in usr/sbin/rear<br />
<a href="https://github.com/rear/rear/blob/master/usr/sbin/rear#L292">https://github.com/rear/rear/blob/master/usr/sbin/rear#L292</a><br />
is another example where ReaR scripts do not behave as usually
expected:<br />
Have "fun" with code like <code>grep something my*files</code><br />
when nothing matches <code>my*files</code> ;-)</p>
</blockquote>
<p>@jsmeix Would it work to use <code>shopt -s failglob</code> instead of
<code>shopt -s nullglob</code> ?</p>
<h4 id="jsmeix_commented_at_2020-05-26_0614"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2220#issuecomment-633827714">2020-05-26 06:14</a>:<a class="headerlink" href="#jsmeix_commented_at_2020-05-26_0614" title="Permanent link">&para;</a></h4>
<p>I think in practice (i.e. with reasonable effort)<br />
we cannot change our global bash globbing settings<br />
because we cannot know at which places in all of the scripts<br />
the <code>nullglob</code> behaviour is required to make things work<br />
because usually there are no comments or other signs<br />
how we could detect places that need <code>nullglob</code>.</p>
<p>An example how <code>nullglob</code> behaviour lets things work as intened<br />
while <code>failglob</code> would let things completely fail in a bad way:</p>
<pre><code># ( shopt -s nullglob ; set -x ; tar -cvf /tmp/testy.tar /etc/issue /optional/stuff* /etc/fstab &amp;&amp; echo OK || echo Error $? )

+ tar -cvf /tmp/testy.tar /etc/issue /etc/fstab
tar: Removing leading `/' from member names
/etc/issue
tar: Removing leading `/' from hard link targets
/etc/fstab
+ echo OK
OK
</code></pre>
<p>where <code>nullglob</code> gracefully skips non-existent optional files<br />
versus</p>
<pre><code># ( shopt -s failglob ; set -x ; tar -cvf /tmp/testy.tar /etc/issue /optional/stuff* /etc/fstab &amp;&amp; echo OK || echo Error $? )

-bash: no match: /optional/stuff*
</code></pre>
<p>where the whole command is not at all executed.</p>
<p>But how could one autodetect pieces of code like</p>
<pre><code>tar -cvf /tmp/testy.tar /etc/issue /optional/stuff* /etc/fstab &amp;&amp; echo OK || echo Error $?
</code></pre>
<p>that require <code>nullglob</code> behaviour ?</p>
<p>Searching for any bash globbing patterns in the code would be possible<br />
but I fear there are way too many places where bash globbing patterns<br />
are used in the code so I think in practice (i.e. with reasonable
effort)<br />
we cannot change our global bash globbing settings.</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2025 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2019-08-29.2220.issue.closed.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/rear/rear-user-guide" class="fa fa-code-fork" style="color: #fcfcfc"> rear/rear-user-guide</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
