<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#1338 Issue closed: Potentially patching wrong files during recovery - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#1338 Issue closed: Potentially patching wrong files during recovery";
        var mkdocs_page_input_path = "issues/2017-05-01.1338.issue.closed.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#1338 Issue closed: Potentially patching wrong files during recovery</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="1338_issue_closed_potentially_patching_wrong_files_during_recovery"><a href="https://github.com/rear/rear/issues/1338">#1338 Issue</a> <code>closed</code>: Potentially patching wrong files during recovery<a class="headerlink" href="#1338_issue_closed_potentially_patching_wrong_files_during_recovery" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>enhancement</code>, <code>cleanup</code>, <code>no-issue-activity</code></p>
<h4 id="schlomo_opened_issue_at_2017-05-01_2002"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> opened issue at <a href="https://github.com/rear/rear/issues/1338">2017-05-01 20:02</a>:<a class="headerlink" href="#schlomo_opened_issue_at_2017-05-01_2002" title="Permanent link">&para;</a></h4>
<p>because somebody follows symlinks into the rescue system. I suppose that
we should look into doing all sorts of file-based operations in the
restored file space under <code>chroot</code> so that absolute symlinks will
actually refer to the matching files <strong>in</strong> the restores file systems.</p>
<p><img alt="image" src="https://cloud.githubusercontent.com/assets/101384/25592633/c8618160-2eb9-11e7-9c4e-6a135037161d.png" /></p>
<h4 id="jsmeix_commented_at_2017-05-16_0851"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1338#issuecomment-301717820">2017-05-16 08:51</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-05-16_0851" title="Permanent link">&para;</a></h4>
<p>@schlomo<br />
I do not fully understand what exactly you mean but<br />
I guess you are talking about the section</p>
<pre>
        # sed -i bails on symlinks, so we follow the symlink and patch the result
        # on dead links we warn and skip them
        # TODO: maybe we must put this into a chroot so that absolute symlinks will work correctly
        if test -L "$file" ; then
                if linkdest="$(readlink -f "$file")" ; then
                        # if link destination is residing on /proc we skip it silently
                        echo $linkdest | grep -q "^/proc" && continue
                        LogPrint "Patching '$linkdest' instead of '$file'"
                        file="$linkdest"
                else
                        LogPrint "Not patching dead link '$file'"
                        continue
                fi
        fi
</pre>

<p>in each of the<br />
finalize/GNU/Linux/250_migrate_disk_devices_layout.sh<br />
finalize/GNU/Linux/250_migrate_lun_wwid.sh<br />
finalize/GNU/Linux/280_migrate_uuid_tags.sh<br />
scripts?</p>
<h4 id="jsmeix_commented_at_2017-05-16_0904"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1338#issuecomment-301720967">2017-05-16 09:04</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-05-16_0904" title="Permanent link">&para;</a></h4>
<p>Interestingly there is another 'finalize' script<br />
finalize/GNU/Linux/320_migrate_network_configuration_files.sh<br />
that also runs 'sed -i' but does not care about symlinks:</p>
<pre>
        for network_file in $TARGET_FS_ROOT/etc/sysconfig/*/ifcfg-*${new_mac}* $TARGET_FS_ROOT/etc/sysconfig/*/ifcfg-*${dev}*; do
        ...
            sed -i -e "$SED_SCRIPT" "$network_file"
</pre>

<h4 id="jsmeix_commented_at_2017-05-16_0925"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1338#issuecomment-301726095">2017-05-16 09:25</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-05-16_0925" title="Permanent link">&para;</a></h4>
<p>On my SLES11 and SLES12 systems (I will not look at SLES10 ;-)<br />
"man sed" shows:</p>
<pre>
       --follow-symlinks
              follow symlinks when processing in place

       -i[SUFFIX], --in-place[=SUFFIX]
              edit files in place (makes backup if SUFFIX supplied)
</pre>

<p>so that "sed --follow-symlinks -i file_or_symlink" should "just
work"<br />
which it does on my SLES12 system:</p>
<pre>
# echo old >foo

# ln -s foo slfoo

# ls -l *foo
-rw-r--r-- 1 root root 4 May 16 11:12 foo
lrwxrwxrwx 1 root root 3 May 16 11:12 slfoo -> foo

# sed --follow-symlinks -i -e 's/old/new/' slfoo

# echo $?
0

e205:~ # cat foo
new
</pre>

<p>BUT hooray!:-( the same "just fails" on my SLES11 system with</p>
<pre>
# ls -l *foo
-rw-r--r-- 1 root root 4 May 16 11:15 foo
lrwxrwxrwx 1 root root 3 May 16 11:09 slfoo -> foo

# sed --follow-symlinks -i -e 's/old/new/' slfoo
sed: ck_follow_symlink: couldn't lstat s/foo: No such file or directory

# echo $?
4
</pre>

<p>WTH blabbers it about 's/foo'?<br />
It is left as an exercise to the reader to find some<br />
matching bug reports about 'sed' on the Internet ;-)</p>
<h4 id="gdha_commented_at_2018-01-12_0821"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/issues/1338#issuecomment-357172574">2018-01-12 08:21</a>:<a class="headerlink" href="#gdha_commented_at_2018-01-12_0821" title="Permanent link">&para;</a></h4>
<p>When we implement request from issue #1638 this may fix this?</p>
<h4 id="gdha_commented_at_2018-01-12_0823"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/issues/1338#issuecomment-357173058">2018-01-12 08:23</a>:<a class="headerlink" href="#gdha_commented_at_2018-01-12_0823" title="Permanent link">&para;</a></h4>
<p>@jsmeix As you are owner of issue #1638 I dare to assign this issue to
you as well - if you think this is not appropriate then un-assign
yourself</p>
<h4 id="jsmeix_commented_at_2018-01-12_1306"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1338#issuecomment-357233459">2018-01-12 13:06</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-01-12_1306" title="Permanent link">&para;</a></h4>
<p>I will have a look - as time permits.</p>
<p>Offhandedly I think
<a href="https://github.com/rear/rear/issues/1638">https://github.com/rear/rear/issues/1638</a><br />
is different but somehow related (also about symlink weirdness).</p>
<h4 id="gdha_commented_at_2018-05-10_0838"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/issues/1338#issuecomment-387991001">2018-05-10 08:38</a>:<a class="headerlink" href="#gdha_commented_at_2018-05-10_0838" title="Permanent link">&para;</a></h4>
<p>@jsmeix any update on this topic. It wouldn't hurt to move the milestone
in my opinion as well if you do not have the time for it. It is not
urgent at all. Thanks</p>
<h4 id="jsmeix_commented_at_2018-05-14_0748"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1338#issuecomment-388727211">2018-05-14 07:48</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-05-14_0748" title="Permanent link">&para;</a></h4>
<p>@gdha<br />
unfortunately I found no time to have a closer look at this issue<br />
but because we got no actualy issue reports in this area<br />
I think we can move it to the next ReaR 2.5.</p>
<h4 id="jsmeix_commented_at_2019-02-26_1521"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1338#issuecomment-467480495">2019-02-26 15:21</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-02-26_1521" title="Permanent link">&para;</a></h4>
<p>In
<a href="https://github.com/rear/rear/pull/2055">https://github.com/rear/rear/pull/2055</a><br />
I tried to improve symlink handling in finalize scripts a bit<br />
(avoid to patch wrong files as a first step)<br />
but to me the finalize scripts look somewhat obscure<br />
(it seems they "just do" some stuff without much care)<br />
so that basically I feel somewhat overstrained with that task...</p>
<h4 id="jsmeix_commented_at_2019-02-28_1351"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1338#issuecomment-468279516">2019-02-28 13:51</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-02-28_1351" title="Permanent link">&para;</a></h4>
<p>Via
<a href="https://github.com/rear/rear/pull/2055">https://github.com/rear/rear/pull/2055</a><br />
a first step towards actually fixing this issue is done.</p>
<p>Fixing this issue is not doable in the currently planned time until
the<br />
ReaR 2.5 release so that I postpone it for the next ReaR 2.6 release,
cf.<br />
<a href="https://github.com/rear/rear/milestones">https://github.com/rear/rear/milestones</a></p>
<h4 id="jsmeix_commented_at_2020-04-29_1537"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1338#issuecomment-621292067">2020-04-29 15:37</a>:<a class="headerlink" href="#jsmeix_commented_at_2020-04-29_1537" title="Permanent link">&para;</a></h4>
<p>Via<br />
<a href="https://github.com/rear/rear/commit/78d7a519b4700c828544df00763a90886e0847a6">https://github.com/rear/rear/commit/78d7a519b4700c828544df00763a90886e0847a6</a><br />
I introduced the <code>valid_restored_file_for_patching</code> function for now
only in<br />
finalize/GNU/Linux/320_migrate_network_configuration_files.sh<br />
<a href="https://github.com/rear/rear/blob/master/usr/share/rear/finalize/GNU/Linux/320_migrate_network_configuration_files.sh#L47">https://github.com/rear/rear/blob/master/usr/share/rear/finalize/GNU/Linux/320_migrate_network_configuration_files.sh#L47</a><br />
to see if and how it works there.</p>
<p>If things work o.k. there I think the <code>valid_restored_file_for_patching</code>
function<br />
is the right generic way to determine the actualy right target system
files.</p>
<h4 id="github-actions_commented_at_2020-07-02_0133"><img src="https://avatars.githubusercontent.com/in/15368?v=4" width="50"><a href="https://github.com/apps/github-actions">github-actions</a> commented at <a href="https://github.com/rear/rear/issues/1338#issuecomment-652727896">2020-07-02 01:33</a>:<a class="headerlink" href="#github-actions_commented_at_2020-07-02_0133" title="Permanent link">&para;</a></h4>
<p>Stale issue message</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2023 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2017-05-01.1338.issue.closed.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
