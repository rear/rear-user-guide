<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#1923 Issue closed: mkrescue doesn't contain valid .conf files when files are symlinks - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#1923 Issue closed: mkrescue doesn\u0027t contain valid .conf files when files are symlinks";
        var mkdocs_page_input_path = "issues/2018-10-08.1923.issue.closed.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/backup_netfs.html">Example of BACKUP=NETFS</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#1923 Issue closed: mkrescue doesn't contain valid .conf files when files are symlinks</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="1923_issue_closed_mkrescue_doesnt_contain_valid_conf_files_when_files_are_symlinks"><a href="https://github.com/rear/rear/issues/1923">#1923 Issue</a> <code>closed</code>: mkrescue doesn't contain valid .conf files when files are symlinks<a class="headerlink" href="#1923_issue_closed_mkrescue_doesnt_contain_valid_conf_files_when_files_are_symlinks" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>bug</code>, <code>fixed / solved / done</code></p>
<h4 id="rmetrich_opened_issue_at_2018-10-08_1442"><img src="https://avatars.githubusercontent.com/u/1163635?u=36b5e32e1dd55f1ce77cad431a5683fce40a7934&v=4" width="50"><a href="https://github.com/rmetrich">rmetrich</a> opened issue at <a href="https://github.com/rear/rear/issues/1923">2018-10-08 14:42</a>:<a class="headerlink" href="#rmetrich_opened_issue_at_2018-10-08_1442" title="Permanent link">&para;</a></h4>
<ul>
<li>
<p>ReaR version ("/usr/sbin/rear -V"): All, including latest</p>
</li>
<li>
<p>OS version ("cat /etc/rear/os.conf" or "lsb_release -a" or "cat
    /etc/os-release"): RHEL7 and RHEL6</p>
</li>
<li>
<p>ReaR configuration files ("cat /etc/rear/site.conf" and/or "cat
    /etc/rear/local.conf"): Default one</p>
</li>
<li>
<p>Hardware (PC or PowerNV BareMetal or ARM) or virtual machine (KVM
    guest or PoverVM LPAR): ALL</p>
</li>
<li>
<p>System architecture (x86 compatible or PPC64/PPC64LE or what exact
    ARM device): ALL</p>
</li>
<li>
<p>Firmware (BIOS or UEFI or Open Firmware) and bootloader (GRUB or
    ELILO or Petitboot): ALL</p>
</li>
<li>
<p>Storage (lokal disk or SSD) and/or SAN (FC or iSCSI or FCoE) and/or
    multipath (DM or NVMe): ALL</p>
</li>
<li>
<p>Description of the issue (ideally so that others can reproduce it):</p>
</li>
</ul>
<p>When not using the standard configuration files <code>/etc/rear/*.conf</code> but
its own configuration directory, e.g. <code>/etc/rear/myconf</code> and having the
conf files be symlinks, the configuration files are not included
properly in the ISO image:</p>
<h3 id="create_configuration">Create configuration<a class="headerlink" href="#create_configuration" title="Permanent link">&para;</a></h3>
<pre><code># mkdir /etc/rear/myconf
# touch /etc/rear/site.conf
# ln -s /etc/rear/os.conf /etc/rear/myconf/
# ln -s /etc/rear/site.conf /etc/rear/myconf/
</code></pre>
<h3 id="create_iso">Create ISO<a class="headerlink" href="#create_iso" title="Permanent link">&para;</a></h3>
<pre><code># rear -dD mkrescue
</code></pre>
<h3 id="check_iso_content_broken">Check ISO content (broken)<a class="headerlink" href="#check_iso_content_broken" title="Permanent link">&para;</a></h3>
<pre><code># ls -l /tmp/rear.*/rootfs/etc/rear
-rw-------. 1 root root  534 Oct  8 16:15 local.conf
lrwxrwxrwx. 1 root root   10 Oct  8 16:15 os.conf -&gt; ../os.conf
-rw-r--r--. 1 root root 1039 Oct  8 16:15 rescue.conf
lrwxrwxrwx. 1 root root   12 Oct  8 16:15 site.conf -&gt; ../site.conf
</code></pre>
<p>We have here, <code>os.conf</code> point to <code>/etc/os.conf</code> and <code>site.conf</code> point to
non-existing file <code>/etc/site.conf</code>.</p>
<p>This is due to using <code>cp $v -r</code> command in
<code>/usr/share/rear/build/GNU/Linux/100_copy_as_is.sh</code> on line 83:</p>
<pre><code> 76 Log "Copying ReaR configuration directory"
 77 # Copy ReaR configuration directory:
 78 mkdir $v -p $ROOTFS_DIR/etc/rear
 79 # This will do same job as lines below.
 80 # On top of that, it does not throw log warning like:
 81 # "cp: missing destination file operand after"
 82 # if hidden file (.&lt;filename&gt;) is missing in $CONFIG_DIR
 83 cp $v -r $CONFIG_DIR/. $ROOTFS_DIR/etc/rear/ 1&gt;&amp;2
 84
</code></pre>
<p>With this <code>cp</code>, symlinks are kept instead of content copied. This ends
up not having <code>os.conf</code> and <code>site.conf</code> be created.</p>
<p>Additionallly <code>/etc/os.conf</code> is only having the content generated by
<code>/usr/share/rear/build/default/990_update_os_conf.sh</code>. This is due to
having the symlink <code>/etc/rear/os.conf</code> point to non-existing
<code>/etc/os.conf</code>, but that latter file gets populated by
<code>/usr/share/rear/build/default/990_update_os_conf.sh</code> echoes.</p>
<ul>
<li>Work-around, if any: Use hard links instead of soft links for the
    configuration files</li>
</ul>
<h4 id="rmetrich_commented_at_2018-10-08_1443"><img src="https://avatars.githubusercontent.com/u/1163635?u=36b5e32e1dd55f1ce77cad431a5683fce40a7934&v=4" width="50"><a href="https://github.com/rmetrich">rmetrich</a> commented at <a href="https://github.com/rear/rear/issues/1923#issuecomment-427862301">2018-10-08 14:43</a>:<a class="headerlink" href="#rmetrich_commented_at_2018-10-08_1443" title="Permanent link">&para;</a></h4>
<p>The <code>cp $v -r</code> should be replaced by <code>cp $v -r -L</code> to dereference links.</p>
<h4 id="jsmeix_commented_at_2018-10-08_1524"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1923#issuecomment-427877211">2018-10-08 15:24</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-10-08_1524" title="Permanent link">&para;</a></h4>
<p>@rmetrich<br />
you may also have a look at<br />
usr/share/rear/build/GNU/Linux/390_copy_binaries_libraries.sh<br />
because there is already code that copies symlink targets<br />
and all link target components.</p>
<p>FYI:<br />
On my personal "secret future stuff" TODO list is<br />
to add a check for dangling symlinks in the recovery system<br />
that is run during "rear mkrescue/mkbackup" via<br />
usr/share/rear/build/default/980_verify_rootfs.sh</p>
<h4 id="jsmeix_commented_at_2018-10-08_1541"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1923#issuecomment-427882710">2018-10-08 15:41</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-10-08_1541" title="Permanent link">&para;</a></h4>
<p>I wonder if <code>cp -r -L</code> is really "the right thing" because it replaces<br />
what was originally a symbolic link by the content of the link target<br />
so that afterwards that content may exist in two independent regular
files<br />
i.e. the meaning of the symlink (same conent under different file
names)<br />
was destroyed which might have unwanted bad consequences in some cases.</p>
<h4 id="rmetrich_commented_at_2018-10-08_1543"><img src="https://avatars.githubusercontent.com/u/1163635?u=36b5e32e1dd55f1ce77cad431a5683fce40a7934&v=4" width="50"><a href="https://github.com/rmetrich">rmetrich</a> commented at <a href="https://github.com/rear/rear/issues/1923#issuecomment-427883369">2018-10-08 15:43</a>:<a class="headerlink" href="#rmetrich_commented_at_2018-10-08_1543" title="Permanent link">&para;</a></h4>
<p>Well, the copy is used to copy files from local system to recovery
system (in the tmp build dir), so I don't see why this would be an
issue.</p>
<h4 id="schlomo_commented_at_2018-10-08_1554"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/issues/1923#issuecomment-427887152">2018-10-08 15:54</a>:<a class="headerlink" href="#schlomo_commented_at_2018-10-08_1554" title="Permanent link">&para;</a></h4>
<p>@jsmeix I remember us introducing the <code>-L</code> to be sure not to have
dangling symlinks via a "brute force" copy at the potential waste of
some storage space. This was to solve various really stupid cases where
OS files of some support packages where symlinks on some OS and regular
files on others. update-alternatives is another candidate that can
create symlinks at unexpected places.</p>
<p>üëç for the idea to also copy the ReaR config with <code>-L</code></p>
<h4 id="jsmeix_commented_at_2018-10-08_1558"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1923#issuecomment-427888513">2018-10-08 15:58</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-10-08_1558" title="Permanent link">&para;</a></h4>
<p>Only an offhanded guess (I did not check the details):<br />
One might get the same config file content then in two separated regular
files<br />
so that one would have to find and edit both of them in the recovery
system<br />
to get a consistent change (e.g. before one runs <code>rear recover</code>).</p>
<p>In general I think when <code>cp -r</code> is used the intent is to copy whole
trees of files<br />
and in this case I assume the usual intent is to keep the copied tree<br />
as much as possible the same as the original tree was and I think this<br />
is the reason why
<code>When copying from a symbolic link, cp normally follows the link only when not copying recursively</code>
cf.<br />
<a href="https://www.gnu.org/software/coreutils/manual/html_node/cp-invocation.html">https://www.gnu.org/software/coreutils/manual/html_node/cp-invocation.html</a></p>
<p>But perhaps I am overpedantic in this particular case here.</p>
<p>@schlomo<br />
I do not mind a bit of wasted storage space.<br />
I do mind sudden unexpected duplicates.</p>
<p>FYI:<br />
Another one my personal "secret future stuff" TODO list is<br />
to use (if available) <code>fdupes</code> in the recovery system<br />
to find duplicate content files.</p>
<h4 id="rmetrich_commented_at_2018-10-08_1604"><img src="https://avatars.githubusercontent.com/u/1163635?u=36b5e32e1dd55f1ce77cad431a5683fce40a7934&v=4" width="50"><a href="https://github.com/rmetrich">rmetrich</a> commented at <a href="https://github.com/rear/rear/issues/1923#issuecomment-427890470">2018-10-08 16:04</a>:<a class="headerlink" href="#rmetrich_commented_at_2018-10-08_1604" title="Permanent link">&para;</a></h4>
<p>For rear configuration files, there is no other option than copying
dereferenced files, since rear modifies files specified with <code>-c /path</code>
into <code>/etc/rear</code> forcibly.</p>
<h4 id="jsmeix_commented_at_2018-10-09_0705"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1923#issuecomment-428083473">2018-10-09 07:05</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-10-09_0705" title="Permanent link">&para;</a></h4>
<p>@rmetrich<br />
as always thank you so much for your essential explanation in<br />
<a href="https://github.com/rear/rear/issues/1923#issuecomment-427890470">https://github.com/rear/rear/issues/1923#issuecomment-427890470</a></p>
<p>Now even I understand why <code>cp -r -L</code> is "the right thing" in this
particular case.</p>
<p>I fixed it directly via<br />
<a href="https://github.com/rear/rear/commit/2a17522668105a1cf4448865f1b69135d32f049e">https://github.com/rear/rear/commit/2a17522668105a1cf4448865f1b69135d32f049e</a></p>
<h4 id="jsmeix_commented_at_2018-10-09_0730"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1923#issuecomment-428089756">2018-10-09 07:30</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-10-09_0730" title="Permanent link">&para;</a></h4>
<p>By the way I was also looking at the additional config files<br />
in $CONFIG_APPEND_FILES (specified via '-C') and I did a usability fix
via<br />
<a href="https://github.com/rear/rear/commit/839796e18f7c8825200dce93547ad3b673a8a8d0">https://github.com/rear/rear/commit/839796e18f7c8825200dce93547ad3b673a8a8d0</a></p>
<h4 id="jsmeix_commented_at_2018-10-09_0810"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1923#issuecomment-428100706">2018-10-09 08:10</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-10-09_0810" title="Permanent link">&para;</a></h4>
<p>Now I even found the reason why I am in general cautious<br />
when the idea is to "just copy symlink targets":</p>
<p>See<br />
<a href="https://github.com/rear/rear/pull/1636#issuecomment-350258366">https://github.com/rear/rear/pull/1636#issuecomment-350258366</a><br />
and the other comments related to it.</p>
<p>We must not "just copy symlink targets" into the recovery system<br />
unless in exceptional cases where we know it won't hurt too much<br />
(hopefully nobody has symlinks in $CONFIG_DIR that point to huge files
;-)</p>
<h4 id="jsmeix_commented_at_2018-10-09_0834"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1923#issuecomment-428108036">2018-10-09 08:34</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-10-09_0834" title="Permanent link">&para;</a></h4>
<p>And finally - so that it is documented here -<br />
(probably a somewhat artificial example)<br />
why copying symlink targets in $CONFIG_DIR<br />
could lead to unexpected behaviour for the user:</p>
<p>Assume /etc/rear/local.conf is a symbolic link that<br />
points to one of several predefined system-specific config<br />
files like /etc/rear/host_foo.conf /etc/rear/host_bar.conf<br />
/etc/rear/web_server.conf /etc/rear/mail_server.conf ...<br />
(the user may like to have all of them on his systems<br />
and let his local.conf symlink point to the right one).</p>
<p>In the recovery system that symlink is replaced by what its target<br />
was during "rear mkrescue/mkbackup" so that the config files structure<br />
is different in the recovery system which could be unexpected for the
user<br />
(regardless that "rear recover" should usually still work).</p>
<p>We can enhance copying config files when such kind of issues<br />
actually get reported to us by real users.</p>
<p>At least for now the current <code>cp -r -L</code> should be "good enough".</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2024 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2018-10-08.1923.issue.closed.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/rear/rear-user-guide" class="fa fa-code-fork" style="color: #fcfcfc"> rear/rear-user-guide</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
