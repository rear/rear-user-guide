<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#866 Issue closed: EFI bootable ISO image: first boot option is broken - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#866 Issue closed: EFI bootable ISO image: first boot option is broken";
        var mkdocs_page_input_path = "issues/2016-06-07.866.issue.closed.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/backup_netfs.html">Example of BACKUP=NETFS</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#866 Issue closed: EFI bootable ISO image: first boot option is broken</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="866_issue_closed_efi_bootable_iso_image_first_boot_option_is_broken"><a href="https://github.com/rear/rear/issues/866">#866 Issue</a> <code>closed</code>: EFI bootable ISO image: first boot option is broken<a class="headerlink" href="#866_issue_closed_efi_bootable_iso_image_first_boot_option_is_broken" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>bug</code>, <code>waiting for info</code>, <code>fixed / solved / done</code></p>
<h4 id="abbbi_opened_issue_at_2016-06-07_1026"><img src="https://avatars.githubusercontent.com/u/3919561?u=473291dd3dbd58fd0af45714935992a3d416aa6e&v=4" width="50"><a href="https://github.com/abbbi">abbbi</a> opened issue at <a href="https://github.com/rear/rear/issues/866">2016-06-07 10:26</a>:<a class="headerlink" href="#abbbi_opened_issue_at_2016-06-07_1026" title="Permanent link">&para;</a></h4>
<p>hi,</p>
<p>with the actual GIT version i was able to create a SLES12 based EFI boot
iso image, but the first<br />
boot option (Relax and Recover (no Secure Boot)) does not work, the
generated grub.cfg<br />
looks like:</p>
<p>menuentry "Relax and Recover (no Secure Boot)" --class gnu-linux --class
gnu --class os {<br />
echo 'Loading kernel ...'<br />
linux /isolinux/kernel [..]</p>
<p>The "Secure Boot" option however works, difference is that this one uses
"linuxefi" instead<br />
of "linux":</p>
<p>menuentry "Relax and Recover (Secure Boot)" --class gnu-linux --class
gnu --class os {<br />
echo 'Loading kernel ...'<br />
linuxefi /isolinux/kernel [..]</p>
<h4 id="jsmeix_commented_at_2016-06-07_1147"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/866#issuecomment-224256632">2016-06-07 11:47</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-06-07_1147" title="Permanent link">&para;</a></h4>
<p>Because it is about SLE I assing it to me regardless that<br />
basically I know nothing at all about (U)EFI or Secure Boot.</p>
<p>@gozora<br />
could you please have a look?</p>
<h4 id="gdha_commented_at_2016-06-07_1156"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/issues/866#issuecomment-224258489">2016-06-07 11:56</a>:<a class="headerlink" href="#gdha_commented_at_2016-06-07_1156" title="Permanent link">&para;</a></h4>
<p>@abbbi "No Secure boot" means booting without UEFI (or via BIOS mode),
which if UEFI is turned on will fail for obvious reasons. I don't
consider this as a bug, perhaps, opinions may be different?<br />
@gozora what is your point of view on this question?</p>
<h4 id="abbbi_commented_at_2016-06-07_1158"><img src="https://avatars.githubusercontent.com/u/3919561?u=473291dd3dbd58fd0af45714935992a3d416aa6e&v=4" width="50"><a href="https://github.com/abbbi">abbbi</a> commented at <a href="https://github.com/rear/rear/issues/866#issuecomment-224258892">2016-06-07 11:58</a>:<a class="headerlink" href="#abbbi_commented_at_2016-06-07_1158" title="Permanent link">&para;</a></h4>
<p>@gdha Ok, Thanks for clarification. Maybe the Naming should be different
(No UEFI/UEFI boot) or something, to make it more obvious.</p>
<h4 id="gozora_commented_at_2016-06-07_1208"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/866#issuecomment-224260797">2016-06-07 12:08</a>:<a class="headerlink" href="#gozora_commented_at_2016-06-07_1208" title="Permanent link">&para;</a></h4>
<p>Hello Guys,<br />
First of all, my knowledge of EFI secure boot (SB) is limited to theory
only. I don't have hands on experience with it :-(. I can however take
closer look on this technology and how ReaR handles it, but it will take
a day or two, as I need to get my dirty hands on some SLES12
installation DVD, coz I don't have any SLES12 installed so far in my
collection ...</p>
<h4 id="jsmeix_commented_at_2016-06-07_1233"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/866#issuecomment-224266274">2016-06-07 12:33</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-06-07_1233" title="Permanent link">&para;</a></h4>
<p>@gdha<br />
when "No Secure boot" actually means<br />
"booting without UEFI (i.e. via BIOS)"<br />
I will prepare a pull request to get that<br />
currently misleading naming fixed.</p>
<p>@gozora<br />
accordingly I think this is not a SLE12-specific issue<br />
so that you do not need to do a special test with SLE12.<br />
But if you like to try our SLE12 see<br />
<a href="https://www.suse.com/products/server/download">https://www.suse.com/products/server/download</a><br />
how to get a free download of SLES12.</p>
<h4 id="gozora_commented_at_2016-06-07_1245"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/866#issuecomment-224269182">2016-06-07 12:45</a>:<a class="headerlink" href="#gozora_commented_at_2016-06-07_1245" title="Permanent link">&para;</a></h4>
<p>yes, might be, but prefer reproducing the issue on as similar HW/SW as
possible.<br />
Thanks for the link, I'm installing now ;-).</p>
<h4 id="jsmeix_commented_at_2016-06-07_1332"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/866#issuecomment-224280978">2016-06-07 13:32</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-06-07_1332" title="Permanent link">&para;</a></h4>
<p>@gdha<br />
see
<a href="https://github.com/rear/rear/pull/867">https://github.com/rear/rear/pull/867</a>
whether or not you like it.</p>
<h4 id="jsmeix_commented_at_2016-06-07_1335"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/866#issuecomment-224281737">2016-06-07 13:35</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-06-07_1335" title="Permanent link">&para;</a></h4>
<p>I think more meaningful names for the recovery system boot<br />
options is only a first step.</p>
<p>I think the real solution would be when boot options that<br />
cannot work are not shown at all - but that is something<br />
for someone who is much more an expert in grub setup<br />
than I am...</p>
<h4 id="gozora_commented_at_2016-06-07_2020"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/866#issuecomment-224401559">2016-06-07 20:20</a>:<a class="headerlink" href="#gozora_commented_at_2016-06-07_2020" title="Permanent link">&para;</a></h4>
<p>Hello @ll,<br />
After some struggle with new features of SLES12 (God bless
<code>/etc/modprobe.d/10-unsupported-modules.conf</code> and systemd) and severe
brain damage I found out why secure boot option works (unlike no secure
boot).<br />
This thing is that grub2 installed on SLES12 and using secure boot, uses
module <strong>linuxefi</strong>, which includes commands:</p>
<ul>
<li><code>linuxefi</code> for loading kernel</li>
<li><code>initrdefi</code> for loading initrd</li>
</ul>
<p>but for some reason does not include <strong>linux</strong> module which uses <code>linux</code>
and <code>initrd</code> commands to load initrd and kernel</p>
<p>According this I'd recommend to modify create_grub2_cfg() to use
<code>linuxefi</code> and <code>initrdefi</code> only in case of secure boot. I can create
pull request for this of course, but I'm a bit tight with time these
days, so I'm not sure if I'll be able to make it this week...</p>
<p>@abbbi I was not able to reproduce your problem with <strong>sysfs</strong> and
USING_UEFI_BOOTLOADER=0.<br />
A thing that would bring some light into this would be if you could set
shell debug options (<code>set -x</code> at the beginning and <code>set +x</code> at the end)
in file
<code>/usr/share/rear/output/ISO/Linux-i386/25_populate_efibootimg.sh</code> run
<code>rear mkrescue</code> and send me just the debug output.<br />
Would that be possible from your site?</p>
<p>@gdha, @jsmeix<br />
And maybe one point that jumped out but could hit us in the back later.
Once I was booting from rear recovery media I've got kernel panic due
problem with execution of <code>/init</code>. Fortunately it was just due missing
<strong>root=root_disk</strong> in grub2. I'll not open issue for this right now
because I need to take a closer look why it was not a problem until now.
It might be that I didn't used btrfs before (yes, shame on me ;-) ). But
it could be some misconfiguration on my site (would not be for first
time). Anyhow just keep this in mind if someone complaints about kernel
panic ;-)</p>
<h4 id="abbbi_commented_at_2016-06-08_0705"><img src="https://avatars.githubusercontent.com/u/3919561?u=473291dd3dbd58fd0af45714935992a3d416aa6e&v=4" width="50"><a href="https://github.com/abbbi">abbbi</a> commented at <a href="https://github.com/rear/rear/issues/866#issuecomment-224506690">2016-06-08 07:05</a>:<a class="headerlink" href="#abbbi_commented_at_2016-06-08_0705" title="Permanent link">&para;</a></h4>
<p>@gozora the SYSFS seems to be fixed with the latest git version, i was
using version 1.18, i already verified with @jsmeix that it works with
the latest git checkout, no troubles here.</p>
<h4 id="jsmeix_commented_at_2016-06-08_0755"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/866#issuecomment-224515990">2016-06-08 07:55</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-06-08_0755" title="Permanent link">&para;</a></h4>
<p>@gozora<br />
many thanks for your analysis!</p>
<p>I have a general question about the naming<br />
"UEFI boot" versus "Secure Boot":</p>
<p>As far as I know "UEFI boot" and "Secure Boot"<br />
are different things.</p>
<p>As far as I know UEFI is a precondition for "Secure Boot"<br />
but one can do "plain UEFI boot" without "Secure Boot".</p>
<p>Therefore I am confused with the current naming<br />
of the boot options of the rear recovery system.</p>
<p>I would expect three boot options like</p>
<pre>
traditional boot (BIOS boot on x86 architecture)
plain UEFI boot (without Secure Boot)
Secure Boot (only on UEFI systems)
</pre>

<p>Curently I do not understand why there are only two<br />
boot options of the rear recovery system.</p>
<p>From my current point of view it seems something is<br />
shomehow mixed up here so that first and foremost<br />
I would like to get it sorted out.</p>
<p>In short, my question is:</p>
<p>What is the fully correct naming of the<br />
booting options of the recovery system?</p>
<h4 id="jsmeix_commented_at_2016-06-08_0825"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/866#issuecomment-224522255">2016-06-08 08:25</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-06-08_0825" title="Permanent link">&para;</a></h4>
<p>@gozora<br />
a question regarding your recommendation to<br />
"modify create_grub2_cfg() to use linuxefi and initrdefi<br />
only in case of secure boot."</p>
<p>I don't see how I could currently test in rear whether or not<br />
Secure Boot is used.</p>
<p>As far as I see I can currently only test in rear whether or not<br />
UEFI is used via the USING_UEFI_BOOTLOADER variable.</p>
<p>Do you perhaps mean to use linuxefi and initrdefi only<br />
in case of UEFI boot?</p>
<p>Do you mean to add tests for USING_UEFI_BOOTLOADER<br />
to create_grub2_cfg() so that only those "menuentry" blocks<br />
are output that match the actually used bootloader?</p>
<h4 id="jsmeix_commented_at_2016-06-08_1034"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/866#issuecomment-224551729">2016-06-08 10:34</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-06-08_1034" title="Permanent link">&para;</a></h4>
<p>I have dark forebodings about 'linuxefi' and 'initrdefi':</p>
<p>Because I cannot find them in the GRUB2 upstream sources.<br />
I assume 'linuxefi' and 'initrdefi' is SUSE-specific stuff.</p>
<p>In this case anything in rear regarding 'linuxefi' and 'initrdefi'<br />
would need to be implemented as a special case<br />
only for SUSE.</p>
<p>Or is perhaps 'linuxefi' and 'initrdefi' also used in other<br />
Linux distributions?</p>
<h4 id="gozora_commented_at_2016-06-08_1101"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/866#issuecomment-224556935">2016-06-08 11:01</a>:<a class="headerlink" href="#gozora_commented_at_2016-06-08_1101" title="Permanent link">&para;</a></h4>
<p>@jsmeix</p>
<blockquote>
<p>I would expect three boot options like</p>
</blockquote>
<p>I agree with you! However I'm not author of those entries so I can't
guess their porpose :-(. I guess that this mess comes from HANAs running
SLES11. I've saw some installations with both grub and elilo installed
and was never able to find out why ...</p>
<blockquote>
<p>I don't see how I could currently test in rear whether or not Secure
Boot is used.</p>
</blockquote>
<p>You can identify secure boot when <code>uefi_bootloader_basename=shim.efi</code> so
it should be enough to add if .. else in function.</p>
<blockquote>
<p>I have dark forebodings about 'linuxefi' and 'initrdefi':</p>
</blockquote>
<p>Yesterday as I was doing some research I've found this post for
<a href="https://lists.fedoraproject.org/pipermail/devel/2013-January/177568.html">fedora</a>
and this one for
<a href="https://falstaff.agner.ch/2012/12/12/secure-boot-implementation-of-ubuntu-12-10-quantal-quetzal/">ubuntu</a>
both describing <code>linuxefi</code> resp <code>initrdefi</code>, but grub2 documentation is
not mentioning them. So maybe we appeared our selves in middle of war
secure boot vs no secure boot ...</p>
<h4 id="abbbi_commented_at_2016-06-08_1134"><img src="https://avatars.githubusercontent.com/u/3919561?u=473291dd3dbd58fd0af45714935992a3d416aa6e&v=4" width="50"><a href="https://github.com/abbbi">abbbi</a> commented at <a href="https://github.com/rear/rear/issues/866#issuecomment-224563239">2016-06-08 11:34</a>:<a class="headerlink" href="#abbbi_commented_at_2016-06-08_1134" title="Permanent link">&para;</a></h4>
<p>to make things more interesting i just created a Debian 8 based UEFI
image with REAR (installed ebiso on the system) and the Secureboot does
not work here (kernel has invalid signature). The "No Secureboot"
however does.</p>
<p>So:</p>
<p>SLES12: (No Secureboot) fails with "can't find command linux"<br />
Debian: (Secureboot) fails with "invalid signature"</p>
<h4 id="jsmeix_commented_at_2016-06-08_1207"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/866#issuecomment-224569648">2016-06-08 12:07</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-06-08_1207" title="Permanent link">&para;</a></h4>
<p>Yes, we appeared right in the middle of a war...</p>
<p>I asked the SUSE grub2 package maintainer<br />
and got this information:</p>
<pre>
> I am wondering if 'linuxefi' (and 'initrdefi')
> in our grub2 RPM is a SUSE specific thing?
NO. It's a UEFI Secure Boot specfic thing.
> I am wondering if loading the kernel
> and initrd in grub.cfg via
> ---------------------------------------------------------
> menuentry ...
>     linuxefi /boot/vmlinuz...
>     initrdefi /boot/initrd...
> ---------------------------------------------------------
> is a SUSE specific way how to configure
> GRUB2 to boot on (U)EFI systems?
We have to support UEFI Secure Boot
so we have to use linuxefi as it implemented
the need verification mechanism via shim-lock
protocol to loaded the grub2 image ..
Moreover it leverages the kernel UEFI handover
protcol to boot the kernel via its own efistub
and beneficial from kernel bug fixing for
firmware issues. ..
> According to your grub2 RPM changelog entry
> ---------------------------------------------------------------
> * Mon Nov 26 2012 mchang@suse.com
> - ship a Secure Boot UEFI compatible bootloader (fate#314485)
> - added secureboot patches which introduces new linuxefi module
>   that is able to perform verifying signed images via exported
>   protocol from shim.
>   ...
>   - grub2-secureboot-add-linuxefi.patch
> ---------------------------------------------------------------
> it seems linuxefi in grub2 is a SUSE specific thing
> that is not in upstream GRUB2.
It's not upstreamed for various reasons ..
Although down-stream distros like SUSE
and RedHat already used that for a while,
upstream is still have problem accepting it ..
> Background information:
> 
> The reason why I am interested in 'linuxefi' and 'initrdefi'
> is that the Relax-and-Recover (rear) recovery system also
> needs to boot on (U)EFI systems and to do that the
> bootloader of the rear recovery system needs to
> be configured appropriately.
> When grub2 in SUSE needs specific configuration that
> is different compared to upstream GRUB2, then I must
> adapt rear to create its recovery system different
> on SUSE systems.
Please consider it a standard to boot
in UEFI Secure Boot for now, until someone
could convince upstream to include it,
there no other grub command could be used
for now in UEFI Secure Boot as Microsoft only
recongize linuxefi as a they audit the code
to issue their certifcates for shim loader ... 
</pre>

<p>Accordingly 'linuxefi' (and 'initrdefi') is<br />
the current de-facto standard to boot<br />
in UEFI Secure Boot that is used by<br />
various Linux distributions like SUSE,<br />
Red Hat, and Debian (where the latter<br />
indicates that also Ubuntu uses it).</p>
<h4 id="jsmeix_commented_at_2016-06-08_1216"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/866#issuecomment-224571520">2016-06-08 12:16</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-06-08_1216" title="Permanent link">&para;</a></h4>
<p>Currently ther rear recovery system offers in any case<br />
both methods to load kernel and initrd via</p>
<pre>
menuentry ...
    linux /isolinux/kernel ...
    initrd /isolinux/initrd.cgz ...
</pre>

<p>and via</p>
<pre>
menuentry ...
    linuxefi /isolinux/kernel ...
    initrdefi /isolinux/initrd.cgz ...
</pre>

<p>I do not like to exclude one of them because I fear<br />
regressions in this or that use-cases.</p>
<p>Perhaps sometimes only the 'linux'/'initrd' method works,<br />
perhaps sometimes only the 'linuxefi'/'initrdefi' method works.</p>
<p>I do not want to make in rear a decision which method<br />
works in what cases.</p>
<p>Therefore I will change my
<a href="https://github.com/rear/rear/pull/867">https://github.com/rear/rear/pull/867</a><br />
a bit so that the naming is more technically correct.</p>
<p>At least for now I leave it up to the user to find out<br />
what method actually works in his particular<br />
boot environment.</p>
<p>Later - when we know better about all the various details - then<br />
rear might get enhanced so that non-working recovery system<br />
boot menue entries are automatically suppressed.</p>
<h4 id="jsmeix_commented_at_2016-06-08_1258"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/866#issuecomment-224580560">2016-06-08 12:58</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-06-08_1258" title="Permanent link">&para;</a></h4>
<p>I changed
<a href="https://github.com/rear/rear/pull/867">https://github.com/rear/rear/pull/867</a>
so that now<br />
I renamed recovery system boot menue entries<br />
to no longer so nice looking but (hopefully)<br />
technically more correct ones.</p>
<p>I do not like that very much but I am not at all<br />
a sufficient bootloader expert to implement a<br />
real solution here.</p>
<h4 id="jsmeix_commented_at_2016-06-08_1300"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/866#issuecomment-224581292">2016-06-08 13:00</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-06-08_1300" title="Permanent link">&para;</a></h4>
<p>@abbbi regarding
<a href="https://github.com/rear/rear/issues/866#issuecomment-224563239">https://github.com/rear/rear/issues/866#issuecomment-224563239</a><br />
many thanks for you tests!<br />
It helps a lot to understand how messy it currently is.</p>
<h4 id="jsmeix_commented_at_2016-06-08_1318"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/866#issuecomment-224585715">2016-06-08 13:18</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-06-08_1318" title="Permanent link">&para;</a></h4>
<p>@gozora regarding<br />
"SLES11 ... with both grub and elilo installed"</p>
<p>Curently I don't know any details about that<br />
but I think I vaguely remember I heard about<br />
some complicated reasoning behind it.</p>
<p>In short: This is not because SUSE likes to make<br />
things overcomplicated but because something<br />
that had needed to be solved for customers.</p>
<p>Fortunately on SLE12 GRUB 2 is the only bootloader<br />
but now we have Secure Boot to keep things complicated.</p>
<h4 id="gozora_commented_at_2016-08-07_1741"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/866#issuecomment-238096555">2016-08-07 17:41</a>:<a class="headerlink" href="#gozora_commented_at_2016-08-07_1741" title="Permanent link">&para;</a></h4>
<p>Ah, me and my memory. I've forgotten about this completely :-(<br />
Fortunately after (another) week spent with grub and UEFI, I might have
an idea how to solve this nice and simple ...</p>
<h4 id="gozora_commented_at_2016-08-08_1643"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/866#issuecomment-238295932">2016-08-08 16:43</a>:<a class="headerlink" href="#gozora_commented_at_2016-08-08_1643" title="Permanent link">&para;</a></h4>
<p>Hi @abbbi<br />
I've just posted pull request #955 that should solve problem of
yours.<br />
Could you please give it a try?</p>
<p>With this patch both entries (<em>secure boot</em> and <em>no secure boot</em>) in
grub menu should be working (assuming you have correctly signed kernel
;-)</p>
<h4 id="jsmeix_commented_at_2016-08-09_0805"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/866#issuecomment-238482634">2016-08-09 08:05</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-08-09_0805" title="Permanent link">&para;</a></h4>
<p>With
<a href="https://github.com/rear/rear/pull/955">https://github.com/rear/rear/pull/955</a>
merged<br />
I consider this issue to be fixed, in particular because<br />
@gozora has tested that it works at least for him<br />
on SLES12 SP1, Debian and Centos,<br />
cf.
<a href="https://github.com/rear/rear/pull/955#issuecomment-238481175">https://github.com/rear/rear/pull/955#issuecomment-238481175</a></p>
<p>@abbbi<br />
in general regarding how to test the currently<br />
newest rear GitHub master code:<br />
Basically "git clone" it into a directory and<br />
then run rear from within that directory.</p>
<pre>
# git clone https://github.com/rear/rear.git
# cd rear
# vi etc/rear/local.conf
# usr/sbin/rear -d -D mkbackup
</pre>

<p>@abbbi<br />
please provide feedback whether or not<br />
the current rear GitHub master code<br />
also works for you.</p>
<h4 id="jsmeix_commented_at_2016-08-09_0839"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/866#issuecomment-238490007">2016-08-09 08:39</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-08-09_0839" title="Permanent link">&para;</a></h4>
<p>@gozora I have a question regarding your comment<br />
<a href="https://github.com/rear/rear/issues/866#issuecomment-238295932">https://github.com/rear/rear/issues/866#issuecomment-238295932</a></p>
<pre>
both entries (secure boot and no secure boot) in grub menu
should be working
</pre>

<p>As far as I understand what @abbbi reported above in<br />
<a href="https://github.com/rear/rear/issues/866#issuecomment-224563239">https://github.com/rear/rear/issues/866#issuecomment-224563239</a></p>
<pre>
SLES12: (No Secureboot) fails with "can't find command linux"
</pre>

<p>it seems in case of (U)EFI on SLES12 the GRUB 2 there<br />
does not know about the linux command - in only<br />
knows the linuxefi command so that</p>
<pre>
linux /isolinux/kernel ...
</pre>

<p>cannot load the kernel in case of (U)EFI on SLES12, only</p>
<pre>
linuxefi /isolinux/kernel ...
</pre>

<p>can in case of (U)EFI on SLES12.</p>
<p>See also what I wrote in<br />
<a href="https://github.com/rear/rear/pull/867#issuecomment-238487352">https://github.com/rear/rear/pull/867#issuecomment-238487352</a></p>
<p>I am still confused about the meaning of the names<br />
for those GRUB menue entries.</p>
<p>For me the code looks as if it is about "(U)EFI" versus "no (U)EFI"<br />
but the GRUB menue names make it look for the user as if it is<br />
about "Secure Boot" versus "no Secure Boot".</p>
<h4 id="gozora_commented_at_2016-08-09_0852"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/866#issuecomment-238493050">2016-08-09 08:52</a>:<a class="headerlink" href="#gozora_commented_at_2016-08-09_0852" title="Permanent link">&para;</a></h4>
<p>Actually Grub2 commands naming <strong>linux</strong> vs <strong>linuxefi</strong> is quite
confusing ...<br />
From what I've understood so far, whether you use <strong>linux</strong> or
<strong>linuxefi</strong> depends if you want secure boot or not:</p>
<p>In other words:</p>
<ul>
<li>linuxefi loads and check kernel signature</li>
<li>linux just loads kernel</li>
</ul>
<p>So you can use both command while UEFI booting (depending if you want
secure boot or not), but you can use only <strong>linux</strong> command if using
legacy boot.</p>
<h4 id="gozora_commented_at_2016-08-09_0912"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/866#issuecomment-238497736">2016-08-09 09:12</a>:<a class="headerlink" href="#gozora_commented_at_2016-08-09_0912" title="Permanent link">&para;</a></h4>
<blockquote>
<p>it seems in case of (U)EFI on SLES12 the GRUB 2 there<br />
does not know about the linux command - in only<br />
knows the linuxefi command so that</p>
</blockquote>
<p>This is actually caused by "incomplete bootx64.efi" (missing Linux
module). This was a tricky bug. If you are interested I can explain it
in full detail this afternoon (once I'm off my work) ...</p>
<h4 id="jsmeix_commented_at_2016-08-09_0922"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/866#issuecomment-238500043">2016-08-09 09:22</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-08-09_0922" title="Permanent link">&para;</a></h4>
<p>@gozora<br />
of course I am always interested in detailed explanations!</p>
<h4 id="gozora_commented_at_2016-08-09_1716"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/866#issuecomment-238623713">2016-08-09 17:16</a>:<a class="headerlink" href="#gozora_commented_at_2016-08-09_1716" title="Permanent link">&para;</a></h4>
<p>@jsmeix as now I'm home far from screams of my work, beer opened I'll
try to awake author in me and as promised describe this fix in more
detail.</p>
<p>I'll first summarize my assumptions that lead me through writing this
patch:<br />
Grub2 options (let's call them like this for this time) behave as
follows:</p>
<ul>
<li>linux/initrd just loads kernel/initrd (this is our beloved simplest
    option inherited from legacy boot times)</li>
<li>linuxefi/initrdefi instead of just loading kernel/initrd, checks
    whether kernel signatures are valid or not and refuses to load
    kernel that is not signed or have wrong signature. This is our
    Secure boot.</li>
</ul>
<p>In <em>25_populate_efibootimg.sh</em> we have following code on line 15:</p>
<p><code>cp $v "${UEFI_BOOTLOADER}" $TMP_DIR/mnt/EFI/BOOT/BOOTX64.efi &gt;&amp;2</code></p>
<p>so just take whatever is in <strong>$UEFI_BOOTLADER</strong> and copy it to
preparation area that will be later part of ISO. (let use call this
<strong>default BOOTX64.efi</strong> for now). This operation is useful for ELILO as
you will learn later.</p>
<p>In order to successfully boot UEFI system, we need to have boot loader
(*.efi). In case of Grub2 we can create our own using <em>grub(2)-mkimage</em>
and embed modules we need to boot (which is IMHO preferred way) or in
case of ELILO we can use one located under /boot/efi like done in
previous <em>cp</em> command. This copy approach can be utilized even for
Grub2, but can have nasty side effects in form for missing Grub2
functionality.</p>
<p>If we go on in <em>25_populate_efibootimg.sh</em>, nothing really interesting
is going on there (except your FIXMEs which I've noticed ;-) and
thinking about them) until line 69:<br />
<strong>build_bootx86_efi</strong> this function intends to build our own
BOOTX64.efi (which of course should overwrite default BOOTX64.efi) that
shall be used to boot ISO.</p>
<p><strong>build_bootx86_efi</strong> is defined in <em>uefi-functions.sh</em><br />
and we had following code in it:<br />
...<br />
<code>[[ ! -d /usr/lib/grub/x86_64-efi ]] &amp;&amp; return</code><br />
…<br />
<code>$gmkimage $v -O x86_64-efi -c $TMP_DIR/mnt/EFI/BOOT/embedded_grub.cfg -d /usr/lib/grub/x86_64-efi -o $TMP_DIR/mnt/EFI/BOOT/BOOTX64.efi ...</code></p>
<p>as SLES12 SP1 have Grub2 modules stored in
/usr/lib/grub<strong>2</strong>/x86_64-efi, grub(2)-mkimage was never allowed to
create BOOTX64.efi and we were left with default BOOTX64.efi.</p>
<p>I assume that abbi installed system with Secure Boot enabled, which
caused default BOOTX64.efi be build without <strong>linux</strong> Grub2 module
embedded (that normally includes linux and initrd options), and as
default BOOTX64.eif not overwritten with <strong>build_bootx86_efi</strong>, it
caused effect described in this issue.<br />
Normally Grub2 is capable to load modules from disk in case of need (you
might have been noticed all that insmods in grub.cfg), Grub2 modules are
however not part of the ISO (we rather use embedding) so I guess error
message abbi saw was something like “error: can't find command `linux'”</p>
<p>What I did to correct this issue was just to remove condition:<br />
<code>[[ ! -d /usr/lib/grub/x86_64-efi ]] &amp;&amp; return</code><br />
and removed <em>-d /usr/lib/grub/x86_64-efi</em> from grub(2)-mkimage as -d
option of always defaults to location where Grub2 modules are
installed.<br />
This allowed function <strong>build_bootx86_efi</strong> to overwrite default
BOOTX64.efi in case Grub2 is in use, as well as keep default BOOTX64.efi
in case of ELILO</p>
<p>So this is not about Grub2 knowing or not knowing linux/initrd options,
I'd call it just a bad coincidence aka bug ;-). Grub2 options/command
are enabled by modules and modules can be either loaded dynamically
(with insmod) or can be embedded to boot loader file (*.efi)<br />
I've btw discovered that list of commands modules contain is listed in
<em>/usr/lib/grub(2)/x86_64-efi)/command.lst</em>, might be useful in future
...</p>
<p>If SLES12 would use <em>/usr/lib/grub/x86_64-efi</em> for Grub2 module storing
(like Debian or Centos does) we'd probably never discovered this.</p>
<p>I hope this brought a bit of light to this issue,</p>
<h4 id="jsmeix_commented_at_2016-08-10_1517"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/866#issuecomment-238900258">2016-08-10 15:17</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-08-10_1517" title="Permanent link">&para;</a></h4>
<p>@gozora<br />
wow!<br />
Many thanks for your awesome explanation.</p>
<p>I think such enlightening background explanations<br />
should be stored somewhere in the actual rear sources<br />
(and not only in a GitHub issue comment)<br />
to make it easier for others to adapt and enhance the code<br />
if needed at any later time when nobody remembers the<br />
exact reasoning behind why the current code is as it is, cf<br />
<a href="https://github.com/rear/rear/wiki/Coding-Style">https://github.com/rear/rear/wiki/Coding-Style</a></p>
<p>@gdha<br />
what do you think about having such background information<br />
in the actual rear sources?</p>
<p>Personally I would provide it as comments directly in the scripts.<br />
Why not have long explanatory comments directly in the scripts?<br />
I think it is sufficiently easy to skip over them when coding<br />
and having them directly in the scripts hopefully avoids that the<br />
code documentation gets outdated when the code is changed.<br />
Perhaps very long comments could be added after the actual code<br />
at the bottom of the script and in the actual code have only some<br />
kind of references to sections in the code documentation at the end?</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2024 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2016-06-07.866.issue.closed.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/rear/rear-user-guide" class="fa fa-code-fork" style="color: #fcfcfc"> rear/rear-user-guide</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
