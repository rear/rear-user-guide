<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#2079 PR merged: Add new implementation to recreate all mounted Btrfs subvolumes - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#2079 PR merged: Add new implementation to recreate all mounted Btrfs subvolumes";
        var mkdocs_page_input_path = "issues/2019-03-11.2079.pr.merged.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a> &raquo;</li>
      <li class="breadcrumb-item active">#2079 PR merged: Add new implementation to recreate all mounted Btrfs subvolumes</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="2079_pr_merged_add_new_implementation_to_recreate_all_mounted_btrfs_subvolumes"><a href="https://github.com/rear/rear/pull/2079">#2079 PR</a> <code>merged</code>: Add new implementation to recreate all mounted Btrfs subvolumes<a class="headerlink" href="#2079_pr_merged_add_new_implementation_to_recreate_all_mounted_btrfs_subvolumes" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>enhancement</code>, <code>fixed / solved / done</code></p>
<h4 id="olivero2_opened_issue_at_2019-03-11_1938"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> opened issue at <a href="https://github.com/rear/rear/pull/2079">2019-03-11 19:38</a>:<a class="headerlink" href="#olivero2_opened_issue_at_2019-03-11_1938" title="Permanent link">&para;</a></h4>
<h5 id="pull_request_details">Pull Request Details:<a class="headerlink" href="#pull_request_details" title="Permanent link">&para;</a></h5>
<ul>
<li>
<p>Type: <strong>Bug Fix</strong></p>
</li>
<li>
<p>Impact: <strong>High</strong> (in specific Btrfs use cases, ReaR recover would
    fail)</p>
</li>
<li>
<p>Reference to related issue (URL):
    <a href="https://github.com/rear/rear/issues/2067">https://github.com/rear/rear/issues/2067</a></p>
</li>
<li>
<p>How was this pull request tested? On Ubuntu 18.04.2 LTS with
    different combinations of Btrfs file systems and subvolume
    hierarchies.</p>
</li>
<li>
<p>Brief description of the changes in this pull request:</p>
</li>
</ul>
<p>This PR aims to recreate all Btrfs file systems which have been mounted
on the original system. It is a re-write of the original Btrfs subvolume
code.</p>
<p>Although this code is simpler and focuses on mounted subvolumes only,
its effects are intended to be entirely compatible with Btrfs scenarios
addressed previously (e.g. using <code>snapper</code>). The assumptions are:</p>
<ol>
<li><em>All</em> Btrfs subvolumes, which were actually mounted on the original
    system, are relevant for recovery and will finally be populated with
    backup data (or if not, at least their existence won't hurt).</li>
<li>Non-mounted subvolumes are not relevant for recovery at all.</li>
</ol>
<p>Of course, we can only know for sure when people would actually try this
on different systems. The code is not enabled by default, but must be
activated by putting a line like this into the local configuration:</p>
<pre><code>BTRFS_SETUP_IMPLEMENTATION="new"
</code></pre>
<p>Hope this helps.</p>
<h4 id="jsmeix_commented_at_2019-03-12_0917"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2079#issuecomment-471918346">2019-03-12 09:17</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-03-12_0917" title="Permanent link">&para;</a></h4>
<p>@OliverO2<br />
Wow! I am deeply impressed.</p>
<p>By plain looking at the code I think your new
btrfs_subvolumes_setup()<br />
will not correctly recreate SUSE's SLES 12 SP1 (and later) special<br />
btrfs subvolumes setup with a snapper controlled default subvolume<br />
because it does not call <code>/usr/lib/snapper/installation-helper</code>, see<br />
<a href="https://github.com/rear/rear/blob/master/usr/share/rear/layout/prepare/GNU/Linux/130_include_mount_subvolumes_code.sh#L209">https://github.com/rear/rear/blob/master/usr/share/rear/layout/prepare/GNU/Linux/130_include_mount_subvolumes_code.sh#L209</a><br />
and subsequent lines what it does, in particular</p>
<pre><code>... Configuring snapper for root filesystem ...
... creating snapshot of first root filesystem ...
</code></pre>
<p>In SLES 12 SP1 (and later) for the subvolume that is mounted at <code>/</code><br />
there is already a snapper snapshot (that is needed to be able to<br />
roll back to that initial pristine installation state).</p>
<p>Because your new btrfs_subvolumes_setup() is a strictly separated
add-on<br />
that already works for Ubuntu 18.04 I would like to merge it right now
as is<br />
so that we have it in ReaR 2.5 and then we can improve things step by
step<br />
as needed.</p>
<p>I plan already one change:<br />
I would like to be able to use both the old btrfs_subvolumes_setup()<br />
and the new btrfs_subvolumes_setup() as neeeded for each <code>$device</code>.<br />
This means both functions must have different names and a new<br />
config variable BTRFS_SETUP_NEW_IMPLEMENTATION would be an<br />
array that contains those <code>$device</code> values where the new function is
used<br />
and layout/prepare/GNU/Linux/130_include_mount_filesystem_code.sh<br />
will be adapted to call the right btrfs_subvolumes_setup... e.g. like</p>
<pre><code>if IsInArray "$device" ${BTRFS_SETUP_NEW_IMPLEMENTATION[@]} ; then
    btrfs_subvolumes_setup_new $device $mountpoint $mountopts
else
    btrfs_subvolumes_setup_old $device $mountpoint $mountopts
fi
</code></pre>
<p>Of course the names should be better...</p>
<p>@rear/contributors<br />
if you do not object, I would like to merge it as is today afternoon.</p>
<h4 id="olivero2_commented_at_2019-03-12_1020"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/pull/2079#issuecomment-471940752">2019-03-12 10:20</a>:<a class="headerlink" href="#olivero2_commented_at_2019-03-12_1020" title="Permanent link">&para;</a></h4>
<p>@jsmeix Thanks for looking at it that quickly!</p>
<p>As I've already indicated, I won't be able to really spend time on ReaR
stuff for the rest of this month. Nevertheless, feel free to add missing
functionality in the mean time.</p>
<p>Regarding switching between old and new implementation:</p>
<ul>
<li>Rename the function any way you like, the current function name
    override is just a provisional solution.</li>
<li>Ideally, in the end we'd have only one implementation and it would
    be functionally complete and as simple as possible.</li>
<li>Could you explain a bit more of your use case for per-device
    switching? When would one use that instead of using just one
    implementation for all devices?</li>
<li>If per-device switching is required, I'd ask you to include a
    setting which says "use the old/new implementation for all devices"
    without forcing the user to figure out which devices were actually
    relevant. That way we could use such a setting it in a network-wide
    configuration for differently configured systems.</li>
</ul>
<p>Regarding snapper:</p>
<ul>
<li>Unfortunately I could not figure out quickly what
    <code>installation-helper</code> does as I did not find a manual page and the
    source code does not provide sufficient information about its
    purpose at first glance.</li>
<li>My idea was that any snapper configuration should be restored from a
    backup and from then on everything should run smoothly without extra
    assistance.</li>
<li>If I'm wrong and snapper really needs extra assistance, the
    necessary code should be built into the new solution, of course.
    (Unfortunately, I cannot really help here, as I do not plan to use
    snapper due to complexity issues - I'm using a pretty simple
    internal Btrfs-only snapshot solution.)</li>
</ul>
<p>Regarding nitpicking ;-):</p>
<ul>
<li>I decided to stick with plain bash code, as it's easily testable
    without including any library functions. <code>is_true</code> seems geared
    towards user-controlled configuration variables with a possible
    variety of values. <code>mount_required</code> is just a tiny little internal
    thingy with strictly controlled values.</li>
</ul>
<h4 id="jsmeix_commented_at_2019-03-12_1115"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2079#issuecomment-471958783">2019-03-12 11:15</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-03-12_1115" title="Permanent link">&para;</a></h4>
<p>Of course the goal is to have only one implementation<br />
that is functionally complete and simple and straightforward.</p>
<p>My use case for per-device switching is to be able to still use<br />
the old btrfs_subvolumes_setup for snapper controlled btrfs
filesystems<br />
(in prticular when btrfs is used as root filesystem on SLES12)<br />
while the new btrfs_subvolumes_setup could be used for<br />
additional btrfs filesystems that the user may have created manually.</p>
<p>With <code>BTRFS_SETUP_NEW_IMPLEMENTATION=( 'yes' )</code> (or <code>true</code> or <code>1</code>)<br />
versus <code>BTRFS_SETUP_NEW_IMPLEMENTATION=( 'no' )</code> (or <code>false</code> or <code>0</code>)<br />
the new btrfs_subvolumes_setup can be enforced for all btrfs
filesystems<br />
or forbidden to be used for any btrfs filesystem.<br />
With <code>BTRFS_SETUP_NEW_IMPLEMENTATION=()</code> we could implement<br />
some autodetection what code should be used and so on...<br />
cf. AUTORESIZE_PARTITIONS or MODULES and similar variables.</p>
<p>Neither could I figure out with reasonable effort what that<br />
<code>installation-helper</code> thingy does - and I had even inspected<br />
its source code but there one gets lost in function calls...<br />
...so that I just call it as a black box that "does the right thing".<br />
I know what it does from a general higher point of view<br />
but the details may change for each SLES service pack, cf.<br />
<a href="https://github.com/rear/rear/issues/1368#issuecomment-302410707">https://github.com/rear/rear/issues/1368#issuecomment-302410707</a><br />
so calling it as a black box that "does the right thing"<br />
is the only right thing I can do in ReaR with reasonable effort<br />
and I do not plan to understand the internals due to complexity issues
;-)</p>
<h4 id="olivero2_commented_at_2019-03-12_1217"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/pull/2079#issuecomment-471976579">2019-03-12 12:17</a>:<a class="headerlink" href="#olivero2_commented_at_2019-03-12_1217" title="Permanent link">&para;</a></h4>
<p>@jsmeix<br />
Your catch-all setting for <code>BTRFS_SETUP_NEW_IMPLEMENTATION</code> looks good
to me.</p>
<p>Now I see the issues you have ben facing with snapper. I've also looked
at
<a href="https://github.com/openSUSE/snapper/blob/master/client/installation-helper.cc"><code>snapper/installation-helper.cc</code></a>
and noticed - apart from its lack of documentation - that its <code>main()</code>
function doesn't even consistently return an exit code. I hope that
these circumstances and different Btrfs setups will not lead to too much
bloat and/or fragility in ReaR's Btrfs code. I still wonder what the
point is of letting <code>installation-helper</code> create a snapshot on an empty
subvolume. Weren't that supposed to be done after the backup has been
restored? (And even then, that snapshot would never be the original
"pristine state" since a recovery does not have access to the original
Btrfs snapshot's contents.)</p>
<p>Finally, an idea for a future release:</p>
<p>Right now the new implementation does not require any change to existing
layout analysis code (the stuff in
<code>usr/share/rear/layout/save/GNU/Linux/230_filesystem_layout.sh</code>). Once
we're confident to settle everything, that code could eventually shrink
to the point of just putting out one line per mounted subvolume like</p>
<pre><code>btrfssubvolume $device $subvolume_mountpoint $mount_options $btrfs_subvolume_path $is_default $uses_copy_on_write
</code></pre>
<p>where</p>
<ul>
<li><code>is_default</code> specifies whether the subvolume is the default
    subvolume (<code>Y</code>) or not (<code>N</code>),</li>
<li><code>uses_copy_on_write</code> specifies whether the subvolume uses CoW (<code>Y</code>,
    the default) or not (<code>N</code>, set via <code>chattr +C</code>).</li>
</ul>
<p>Doing so could further simplify the code and make <code>disklayout.conf</code> more
concise.</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2023 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2019-03-11.2079.pr.merged.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
