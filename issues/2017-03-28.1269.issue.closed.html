<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#1269 Issue closed: 400_autoresize_disks.sh incorrectly calculates $new_size with mawk (Debian) - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#1269 Issue closed: 400_autoresize_disks.sh incorrectly calculates $new_size with mawk (Debian)";
        var mkdocs_page_input_path = "issues/2017-03-28.1269.issue.closed.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/backup_netfs.html">Example of BACKUP=NETFS</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../development/squash-git-log-commments.html">How to squash git log comments into one line</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear29.html">Release Notes ReaR 2.9</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear28.html">Release Notes ReaR 2.8</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#1269 Issue closed: 400_autoresize_disks.sh incorrectly calculates $new_size with mawk (Debian)</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="1269_issue_closed_400_autoresize_diskssh_incorrectly_calculates_new_size_with_mawk_debian"><a href="https://github.com/rear/rear/issues/1269">#1269 Issue</a> <code>closed</code>: 400_autoresize_disks.sh incorrectly calculates $new_size with mawk (Debian)<a class="headerlink" href="#1269_issue_closed_400_autoresize_diskssh_incorrectly_calculates_new_size_with_mawk_debian" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>enhancement</code>, <code>cleanup</code>, <code>fixed / solved / done</code>,
<code>minor bug</code></p>
<h4 id="gozora_opened_issue_at_2017-03-28_1810"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> opened issue at <a href="https://github.com/rear/rear/issues/1269">2017-03-28 18:10</a>:<a class="headerlink" href="#gozora_opened_issue_at_2017-03-28_1810" title="Permanent link">&para;</a></h4>
<h4 id="relax-and-recover_rear_issue_template">Relax-and-Recover (ReaR) Issue Template<a class="headerlink" href="#relax-and-recover_rear_issue_template" title="Permanent link">&para;</a></h4>
<ul>
<li>rear version (/usr/sbin/rear -V): Relax-and-Recover 2.00 / Git</li>
<li>OS version (cat /etc/rear/os.conf or lsb_release -a): Debian
    GNU/Linux 8.7 (jessie)</li>
<li>rear configuration files (cat /etc/rear/site.conf or cat
    /etc/rear/local.conf):</li>
</ul>
<!-- -->

<pre><code>BACKUP=NETFS
OUTPUT=ISO

OUTPUT_URL=nfs://beta/mnt/rear/iso
BACKUP_URL=nfs://beta/mnt/rear

EXCLUDE_BACKUP=( ${EXCLUDE_BACKUP[@]} fs:/crash fs:/usr/sap fs:/oracle )
BACKUP_PROG_EXCLUDE=( ${BACKUP_PROG_EXCLUDE[@]} '/mnt/*' '/media/*' )

ISO_MKISOFS_BIN=/usr/bin/ebiso

GRUB_RESCUE=n

USE_STATIC_NETWORKING=y
NETWORKING_PREPARATION_COMMANDS=(ifconfig eth1 inet 192.168.0.23)
</code></pre>
<ul>
<li>Are you using legacy BIOS or UEFI boot? UEFI</li>
<li>Brief description of the issue:<br />
    During <code>rear recover</code> partition size is incorrectly calculated with
    mawk.<br />
    Following code is executed by <em>400_autoresize_disks.sh</em></li>
</ul>
<!-- -->

<pre><code>new_size=$(echo "$partition_size $resizeable_space $available_space" | awk '{ printf "%d", ($1/$2)*$3; }')
</code></pre>
<p>With gawk values are correct:</p>
<pre><code>echo '8333033472 8333033472 39473643520' | awk '{ printf "%d", ($1/$2)*$3; }'
39473643520
</code></pre>
<p>With mawk however, values are maxed to 0xFFFFFFFF (2147483647)</p>
<pre><code>echo '8333033472 8333033472 39473643520' | awk '{ printf "%d", ($1/$2)*$3; }'
2147483647
</code></pre>
<ul>
<li>Work-around, if any:<br />
    Change of awk conversion specification format:</li>
</ul>
<!-- -->

<pre><code>- new_size=$(echo "$partition_size $resizeable_space $available_space" | awk '{ printf "%d", ($1/$2)*$3; }')
+ new_size=$(echo "$partition_size $resizeable_space $available_space" | awk '{ printf "%.0f", ($1/$2)*$3; }')
</code></pre>
<p>Or maybe use bash arithmetic expansion ?</p>
<pre><code>- new_size=$(echo "$partition_size $resizeable_space $available_space" | awk '{ printf "%d", ($1/$2)*$3; }')
+ new_size=$(( ($partition_size/$resizeable_space)*$available_space ))
</code></pre>
<h4 id="jsmeix_commented_at_2017-03-29_0727"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1269#issuecomment-290006467">2017-03-29 07:27</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-03-29_0727" title="Permanent link">&para;</a></h4>
<p>I do very very much appreciate it whenever<br />
needless external tool calls are replaced<br />
by native bash 3.0 functionality to<br />
Keep the Implementation Simple and Straightforward.</p>
<p>Furthermore I personally prefer when spaces<br />
are used when possible to aid readability like</p>
<pre>
new_size=$(( ( $partition_size / $resizeable_space ) * $available_space ))
</pre>

<p>which at least helps my elderly eyes ;-)<br />
cf.
<a href="https://github.com/rear/rear/wiki/Coding-Style">https://github.com/rear/rear/wiki/Coding-Style</a></p>
<p>For me with GNU bash version 3.2.51 on SLES11 32-bit<br />
bash arithmetic evaluation and expansion works with your values</p>
<pre>
# partition_size=8333033472 ; resizeable_space=8333033472 ; available_space=39473643520 ; new_size=$(( ( $partition_size / $resizeable_space ) * $available_space )) ; echo $new_size
39473643520
</pre>

<p>According to<br />
<a href="http://unix.stackexchange.com/questions/117280/what-is-the-rationale-for-the-bash-shell-not-warning-you-of-arithmetic-overflow">http://unix.stackexchange.com/questions/117280/what-is-the-rationale-for-the-bash-shell-not-warning-you-of-arithmetic-overflow</a><br />
I tried what the maximum value is for my GNU bash version 3.2.51<br />
on SLES11 32-bit and it is 2^63 - 1</p>
<pre>
# max=$(( 2**63 - 1 )) ; echo $max
9223372036854775807

# max=$(( 2**63 )) ; echo $max
-9223372036854775808

# echo '2^63 - 1' | bc -l
9223372036854775807

# echo '2^63' | bc -l
9223372036854775808
</pre>

<p>and I get same results with GNU bash version 4.2.47<br />
on openSUSE Laep 42.1 64-bit:</p>
<pre>
# max=$(( 2**63 - 1 )) ; echo $max
9223372036854775807

# max=$(( 2**63 )) ; echo $max
-9223372036854775808
</pre>

<p>so that I conclude that in practice the maximum value for<br />
bash arithmetic evaluation is 2^63 - 1 = 9223372036854775807<br />
which is 8388608 GiB - 1 so that we can use bash arithmetic<br />
for disks up to 8388607 GiB.</p>
<h4 id="gdha_commented_at_2017-03-29_0808"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/issues/1269#issuecomment-290015525">2017-03-29 08:08</a>:<a class="headerlink" href="#gdha_commented_at_2017-03-29_0808" title="Permanent link">&para;</a></h4>
<p>@gozora choose the <strong>bash</strong> way üëç</p>
<h4 id="gozora_commented_at_2017-03-29_0852"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/1269#issuecomment-290026030">2017-03-29 08:52</a>:<a class="headerlink" href="#gozora_commented_at_2017-03-29_0852" title="Permanent link">&para;</a></h4>
<p>@gdha, @jsmeix</p>
<p>Thanks a lot for your inputs!<br />
I'll prepare PR later today.</p>
<p>V.</p>
<h4 id="jsmeix_commented_at_2017-03-29_0900"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1269#issuecomment-290027920">2017-03-29 09:00</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-03-29_0900" title="Permanent link">&para;</a></h4>
<p>@gozora<br />
I think in layout/prepare/GNU/Linux/100_include_partition_code.sh</p>
<pre>
    start=$( echo "$start" | awk '{printf "%u", $1+4096-($1%4096);}')
</pre>

<p>is also a place where mawk could fail because I think<br />
the partition start values in ReaR use bytes as unit<br />
so that on bigger disks it could overflow with mawk.</p>
<h4 id="jsmeix_commented_at_2017-03-29_0901"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1269#issuecomment-290028349">2017-03-29 09:01</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-03-29_0901" title="Permanent link">&para;</a></h4>
<p>@gozora<br />
thanks a lot for your careful testing<br />
that reveals those generic bugs in ReaR!</p>
<h4 id="gozora_commented_at_2017-03-29_0905"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/1269#issuecomment-290029277">2017-03-29 09:05</a>:<a class="headerlink" href="#gozora_commented_at_2017-03-29_0905" title="Permanent link">&para;</a></h4>
<blockquote>
<p>I think in layout/prepare/GNU/Linux/100_include_partition_code.sh</p>
<pre><code>start=$( echo "$start" | awk '{printf "%u", $1+4096-($1%4096);}')
</code></pre>
<p>is also a place where mawk could fail because I think<br />
the partition start values in ReaR use bytes as unit<br />
so that on bigger disks it could overflow with mawk.</p>
</blockquote>
<p>Good catch @jsmeix, I'll rewrite this one as well.</p>
<blockquote>
<p>thanks a lot for your careful testing<br />
that reveals those generic bugs in ReaR!</p>
</blockquote>
<p>No problem, it just somehow happens that I keep finding those bugs :-)</p>
<h4 id="jsmeix_commented_at_2017-03-29_0919"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1269#issuecomment-290032733">2017-03-29 09:19</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-03-29_0919" title="Permanent link">&para;</a></h4>
<p>I fear the whole</p>
<pre>
start=$( echo "$start" | awk '{printf "%u", $1+4096-($1%4096);}')
</pre>

<p>is plain wrong - or I do something wrong here:</p>
<pre>
# start=$(( 4096 * 1234 ))
# echo $start
5054464

# rounded_start=$( echo "$start" | awk '{printf "%u", $1+4096- $1%4096);}')
# echo $rounded_start
5058560

# echo $(( rounded_start / 4096 ))
1235
</pre>

<p>I.e. even for a exact matching start value, the current code<br />
recalculates it to a new start + 4096 value.</p>
<p>I guess nobody notices a change of 4096 bytes in practice<br />
but it would be a major bug in ReaR when it does not recreate<br />
the partitioning exactly as it was before when possible.</p>
<p>If I am right the above is perhaps the cause of the mysterious<br />
changes of partitioning after "rear recover" that you detected<br />
during your tests with your BACKUP=BLOCKCLONE<br />
in particular for Windows NTFS partitions, cf.<br />
<a href="https://github.com/rear/rear/issues/1078#issuecomment-266099227">https://github.com/rear/rear/issues/1078#issuecomment-266099227</a></p>
<h4 id="jsmeix_commented_at_2017-03-29_0937"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1269#issuecomment-290037319">2017-03-29 09:37</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-03-29_0937" title="Permanent link">&para;</a></h4>
<p>The more I try to understand it the less I understand it.</p>
<p>I cannot reproduce it in practice on my original system:</p>
<pre>
# parted /dev/sda unit B print
Model: ATA QEMU HARDDISK (scsi)
Disk /dev/sda: 21474836480B
Sector size (logical/physical): 512B/512B
Partition Table: msdos
Disk Flags: 

Number  Start        End           Size          Type     File system     Flags
 1      1048576B     1562378239B   1561329664B   primary  linux-swap(v1)  type=82
 2      1562378240B  21474836479B  19912458240B  primary  ext4            boot, type=83
</pre>

<p>and after "rear recover"</p>
<pre>
# parted /dev/sda unit B print
Model: ATA QEMU HARDDISK (scsi)
Disk /dev/sda: 21474836480B
Sector size (logical/physical): 512B/512B
Partition Table: msdos
Disk Flags: 

Number  Start        End           Size          Type     File system     Flags
 1      1048576B     1562378239B   1561329664B   primary  linux-swap(v1)  type=83
 2      1562378240B  21474836479B  19912458240B  primary  ext4            boot, type=83
</pre>

<p>but when I try the current code with my /dev/sda2 partition<br />
start value it calculates a wrong new start value:</p>
<pre>
# start=$(( 1048576 + 1561329664 )) ; echo $start ; echo $(( start / 4096 ))
1562378240
381440

# rounded_start=$( echo "$start" | awk '{printf "%u", $1+4096-($1%4096);}')

# echo $rounded_start ; echo $(( rounded_start / 4096 ))
1562382336
381441
</pre>

<p>Am I mad or what goes on here?</p>
<h4 id="gozora_commented_at_2017-03-29_1022"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/1269#issuecomment-290048138">2017-03-29 10:22</a>:<a class="headerlink" href="#gozora_commented_at_2017-03-29_1022" title="Permanent link">&para;</a></h4>
<p>Hehe, looks like a skeleton in the closet.<br />
I'll try to check it as well ...</p>
<h4 id="jsmeix_commented_at_2017-03-29_1043"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1269#issuecomment-290052694">2017-03-29 10:43</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-03-29_1043" title="Permanent link">&para;</a></h4>
<p>@gozora<br />
only a side note FYI if you work on 100_include_partition_code.sh<br />
and do not like the hardcoded '4096' guess of<br />
"most device's block size":<br />
You may have a look at the current<br />
USB_PARTITION_ALIGN_BLOCK_SIZE<br />
implementation in 300_format_usb_disk.sh<br />
cf.
<a href="https://github.com/rear/rear/issues/1201">https://github.com/rear/rear/issues/1201</a><br />
and
<a href="https://github.com/rear/rear/pull/1217">https://github.com/rear/rear/pull/1217</a></p>
<h4 id="jsmeix_commented_at_2017-03-29_1348"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1269#issuecomment-290095323">2017-03-29 13:48</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-03-29_1348" title="Permanent link">&para;</a></h4>
<p>@gozora<br />
cf.
<a href="https://github.com/rear/rear/issues/1270">https://github.com/rear/rear/issues/1270</a><br />
i.e. be careful with parted units when you like<br />
to stay backward compatible with older parted.</p>
<h4 id="jsmeix_commented_at_2017-03-30_0850"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1269#issuecomment-290344953">2017-03-30 08:50</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-03-30_0850" title="Permanent link">&para;</a></h4>
<p>Hooray!<br />
Even with GNU bash, version 3.1.17 on SLES10<br />
bash arithmetic evaluation works up to 2^63 - 1<br />
at least on x86_64:</p>
<pre>
# cat /etc/issue
Welcome to SUSE Linux Enterprise Server 10 SP4  (x86_64)

# bash --version
GNU bash, version 3.1.17(1)-release (x86_64-suse-linux)

# max=$(( 2**63 - 1 )) ; echo $max
9223372036854775807

# max=$(( 2**63 )) ; echo $max
-9223372036854775808
</pre>

<p>cf.
<a href="https://github.com/rear/rear/issues/1269#issuecomment-290006467">https://github.com/rear/rear/issues/1269#issuecomment-290006467</a></p>
<p>Therefore we can use bytes 'B' as unit for parted<br />
(cf.
<a href="https://github.com/rear/rear/issues/1270">https://github.com/rear/rear/issues/1270</a>)<br />
up to disk sizes of 9223372036854775807 bytes<br />
i.e. up to 8589934592 GiB minus one byte<br />
or 838861 TiB minus one byte<br />
or 8192 PiB minus one byte<br />
or 8 EiB minus one byte<br />
which looks sufficiently future-proof<br />
(at least from my current point of view).</p>
<h4 id="jsmeix_commented_at_2017-03-31_0723"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1269#issuecomment-290637224">2017-03-31 07:23</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-03-31_0723" title="Permanent link">&para;</a></h4>
<p>With
<a href="https://github.com/rear/rear/pull/1272">https://github.com/rear/rear/pull/1272</a>
merged,<br />
this particular issue is fixed.</p>
<p>Any "grand cleanup" of the code in 100_include_partition_code.sh<br />
can be done later as time permits.</p>
<h4 id="jsmeix_commented_at_2017-04-03_1127"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1269#issuecomment-291116581">2017-04-03 11:27</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-04-03_1127" title="Permanent link">&para;</a></h4>
<p>An addendum FYI:<br />
Also on a 32-bit SLES10 installation on a 32-bit virtual machine<br />
(we did not find some real 32-bit hardware for that test)<br />
with bash version 3.1.17 arithmetic evaluation works<br />
up to 2^63 - 1</p>
<h4 id="probackup-nl_commented_at_2017-04-16_2033"><img src="https://avatars.githubusercontent.com/u/515451?u=4f985fa15d087babc5049c337be90b42b56c8b8b&v=4" width="50"><a href="https://github.com/ProBackup-nl">ProBackup-nl</a> commented at <a href="https://github.com/rear/rear/issues/1269#issuecomment-294372656">2017-04-16 20:33</a>:<a class="headerlink" href="#probackup-nl_commented_at_2017-04-16_2033" title="Permanent link">&para;</a></h4>
<p>@jsmeix For GNU Bash 4.4.12 x86_64 the bash arithmetic resize code
fails at least for each situation where $resizeable_space is larger
than $partition_size.</p>
<blockquote>
<p>( $partition_size / $resizeable_space )</p>
</blockquote>
<pre><code>$ echo $(( (2/3)*9999 ))
0
</code></pre>
<p>Failing workaround: Mimicking the example by first multiplying fails
because bash is not able to correctly multiply 20G with 30G.</p>
<pre><code>$ bash --version
GNU bash, version 3.2.53(1)-release (x86_64-apple-darwin13)
$ echo $(( 20971520000*30971520000 ))
3883808530565693440
$ bash --version
GNU bash, version 4.4.12(1)-release (x86_64-unknown-linux-gnu)
$ echo $(( 20971520000*30971520000 ))
3883808530565693440
</code></pre>
<h4 id="jsmeix_commented_at_2017-04-26_0940"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1269#issuecomment-297321546">2017-04-26 09:40</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-04-26_0940" title="Permanent link">&para;</a></h4>
<p>Summary from what we learned above<br />
and in
<a href="https://github.com/rear/rear/issues/1307">https://github.com/rear/rear/issues/1307</a></p>
<p>When a tool calculates correctly for numbers up to 2^N<br />
one can in practice only use it for input numbers up to 2^(N/2)<br />
when a single multiplication of such numbers should work<br />
because 2^(N/2) * 2^(N/2) = 2^N</p>
<p>This means when bash can calculate up to 2^63 - 1<br />
we can use in practice bash only for input numbers<br />
up to something about 2^31 - 1.</p>
<p>Inputs of 2^32 - 1 do not work in general:</p>
<pre>
# echo '2^32 - 1' | bc
4294967295

# echo '4294967295 * 4294967295' | bc
18446744065119617025

# echo $(( 4294967295 * 4294967295 ))
-8589934591
</pre>

<p>Multiplication works in general up to 2^31 - 1</p>
<pre>
# echo '2^31 - 1' | bc
2147483647

# echo '2147483647 * 2147483647' | bc
4611686014132420609

# echo $(( 2147483647 * 2147483647 ))
4611686014132420609
</pre>

<p>Some bigger special cases may still work<br />
like (2^31 - 1) * (2^32)</p>
<pre>
# echo '2^32' | bc
4294967296

# echo '2147483647 * 4294967296' | bc
9223372032559808512

# echo $(( 2147483647 * 4294967296 ))
9223372032559808512
</pre>

<p>but nothing more</p>
<pre>
# echo '2^31' | bc
2147483648

# echo '2147483648 * 4294967296' | bc
9223372036854775808

# echo $(( 2147483648 * 4294967296 ))
-9223372036854775808
</pre>

<h4 id="jsmeix_commented_at_2017-04-26_1156"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1269#issuecomment-297379076">2017-04-26 11:56</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-04-26_1156" title="Permanent link">&para;</a></h4>
<p>With
<a href="https://github.com/rear/rear/pull/1332">https://github.com/rear/rear/pull/1332</a>
merged<br />
this issue should (hopefully) be finally solved.</p>
<h4 id="probackup-nl_commented_at_2017-05-10_2129"><img src="https://avatars.githubusercontent.com/u/515451?u=4f985fa15d087babc5049c337be90b42b56c8b8b&v=4" width="50"><a href="https://github.com/ProBackup-nl">ProBackup-nl</a> commented at <a href="https://github.com/rear/rear/issues/1269#issuecomment-300618109">2017-05-10 21:29</a>:<a class="headerlink" href="#probackup-nl_commented_at_2017-05-10_2129" title="Permanent link">&para;</a></h4>
<p>@gozora My source OS (Arch Linux) has no <code>bc</code> tool installed (by
default).</p>
<p>Despite all your effort for fixing the <code>mawk</code> (Mike Brennan's AWK
speedup by using a bytecode compiler) issue, the result is that a broken
<code>awk</code> now introduces an additional dependency for ReaR to work properly:
<code>bc</code>.</p>
<p>I would love a solution that leaves the old code in place, and extend
that for the cases where <code>(m)awk</code> will fail. For instance change '<code>awk</code>'
to explicitly use '<code>gawk</code>'. And for the users that haven't got <code>gawk</code>
installed, fall back to <code>bc</code> for math calculations.</p>
<h4 id="gozora_commented_at_2017-05-11_0633"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/1269#issuecomment-300696043">2017-05-11 06:33</a>:<a class="headerlink" href="#gozora_commented_at_2017-05-11_0633" title="Permanent link">&para;</a></h4>
<p>@ProBackup-nl how can we be sure that <code>awk</code> will be installed (by
default) on your Arch next time?</p>
<p>V.</p>
<h4 id="probackup-nl_commented_at_2017-05-11_0741"><img src="https://avatars.githubusercontent.com/u/515451?u=4f985fa15d087babc5049c337be90b42b56c8b8b&v=4" width="50"><a href="https://github.com/ProBackup-nl">ProBackup-nl</a> commented at <a href="https://github.com/rear/rear/issues/1269#issuecomment-300708995">2017-05-11 07:41</a>:<a class="headerlink" href="#probackup-nl_commented_at_2017-05-11_0741" title="Permanent link">&para;</a></h4>
<p>@gozora We can never be sure. However at the moment the <code>gawk</code> package
is <strong>required</strong> by, for example:</p>
<ul>
<li><a href="https://www.archlinux.org/packages/extra/any/archboot/">archboot</a></li>
<li><a href="https://www.archlinux.org/packages/extra/any/hwdetect/">hwdetect</a></li>
<li><a href="https://www.archlinux.org/packages/core/any/mkinitcpio/">mkinitcpio</a></li>
<li><a href="https://www.archlinux.org/packages/core/i686/gawk/">and 26 more Arch Linux
    packages</a></li>
</ul>
<h4 id="jsmeix_commented_at_2017-05-11_0828"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1269#issuecomment-300719707">2017-05-11 08:28</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-05-11_0828" title="Permanent link">&para;</a></h4>
<p>Simply put:<br />
One cannot use any kind of 'awk' or any kind of<br />
traditional tool for calculations nowadays.</p>
<p>All those tools have usually certain limitations<br />
that hit us in this or that way when calculating big numbers.</p>
<p>For example using usual floating point arithmetik also leads<br />
to wrong results when calculating big integer numbers.</p>
<p>We need a tool that is known to work for big numbers.</p>
<p>E.g. 2^100 + 1 - 2^100 must result 1 and never ever 0:</p>
<pre>
# echo '2^100 + 1 - 2^100' | bc -l
1

# awk 'BEGIN{print 2^52 + 1 - 2^52 }'
1

# awk 'BEGIN{print 2^53 + 1 - 2^53 }'  || echo fail
0
</pre>

<p>I do not even want to know why my 'awk' fails at 2^53<br />
and not at things like 2^31 2^32 2^63 2^64 and why<br />
my 'awk' even does not show its calculation failure<br />
with a non-zero exit code or an error message.</p>
<p>All what matters is that tools like 'awk' cannot be used<br />
because calculations just have to be correct - always.</p>
<p>Accordingly ReaR cannot be used on systems without<br />
a tool that is known to work for big numbers.</p>
<p>FWIW:<br />
I was 'awk' (more precisely 'gawk') package maintainer<br />
some time ago and - guess what - every now and then<br />
on the <a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#98;&#117;&#103;&#45;&#103;&#97;&#119;&#107;&#64;&#103;&#110;&#117;&#46;&#111;&#114;&#103;">&#98;&#117;&#103;&#45;&#103;&#97;&#119;&#107;&#64;&#103;&#110;&#117;&#46;&#111;&#114;&#103;</a> mailing list issues were reported<br />
by this or that gawk user that "awk calculates wrong"<br />
in this or that particular unexpected way.</p>
<h4 id="probackup-nl_commented_at_2017-05-11_0953"><img src="https://avatars.githubusercontent.com/u/515451?u=4f985fa15d087babc5049c337be90b42b56c8b8b&v=4" width="50"><a href="https://github.com/ProBackup-nl">ProBackup-nl</a> commented at <a href="https://github.com/rear/rear/issues/1269#issuecomment-300741744">2017-05-11 09:53</a>:<a class="headerlink" href="#probackup-nl_commented_at_2017-05-11_0953" title="Permanent link">&para;</a></h4>
<p>A link to a <a href="https://github.com/ThomasDickey/original-mawk/issues/23">2013 bug submission by gratien....@gmail.com for the lack
of large integer support in mawk / incorrect output of %d
format</a> and the
quoted response:</p>
<blockquote>
<p>This is a known limitation: mawk's format for %d is limited by the
format.<br />
The limitation is done to improve performance.</p>
<p>You can get more precision using one of the floating formats (and can
construct<br />
one which prints like a %d, e.g., by putting a ".0" on the end of the
format).</p>
</blockquote>
<p>Does ReaR need this kind of large integer precision here?<br />
Or can the math in ReaR work with a floating point calculation that is
converted to an integer?</p>
<h4 id="gozora_commented_at_2017-05-11_1022"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/1269#issuecomment-300748205">2017-05-11 10:22</a>:<a class="headerlink" href="#gozora_commented_at_2017-05-11_1022" title="Permanent link">&para;</a></h4>
<p>@ProBackup-nl using different conversion type was discussed already (see
<a href="https://github.com/rear/rear/issues/1269#issue-217646048">https://github.com/rear/rear/issues/1269#issue-217646048</a>)
and we decided to use <code>bc</code> instead ...</p>
<p>V.</p>
<h4 id="probackup-nl_commented_at_2017-05-11_1036"><img src="https://avatars.githubusercontent.com/u/515451?u=4f985fa15d087babc5049c337be90b42b56c8b8b&v=4" width="50"><a href="https://github.com/ProBackup-nl">ProBackup-nl</a> commented at <a href="https://github.com/rear/rear/issues/1269#issuecomment-300751187">2017-05-11 10:36</a>:<a class="headerlink" href="#probackup-nl_commented_at_2017-05-11_1036" title="Permanent link">&para;</a></h4>
<p>In case the choice for <code>bc</code> decision will be reconsidered, floating
point gawk returns the expected output for gratien's example:</p>
<pre><code># echo '26341277696 26341278720 47819259904' | gawk '{ printf "%.0f", ($1/$2)*$3; }'
47819258045
# gawk -V
GNU Awk 4.1.4, API: 1.1 (GNU MPFR 3.1.5-p2, GNU MP 6.1.2)
</code></pre>
<h4 id="schlomo_commented_at_2017-05-11_1251"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/issues/1269#issuecomment-300779368">2017-05-11 12:51</a>:<a class="headerlink" href="#schlomo_commented_at_2017-05-11_1251" title="Permanent link">&para;</a></h4>
<p>@ProBackup-nl ReaR will always require some software that might not be
installed by default on some Linux distro. Therefore we check for it
with <code>REQUIRED_PROGS</code> and also include those packages in the distro
packages.</p>
<p>I therefore see absolutely no value in writing code that supplements
<code>bc</code> instead of requiring <code>bc</code> to be present.</p>
<p>If you are an Archlinux user then I would kindly ask you to help ReaR by
making sure that the Archlinuc package also includes such required
tools.</p>
<p>Specifically to this point about <code>gawk</code> or <code>bc</code> I see that the current
<code>PKGBUILD</code>
<a href="https://github.com/rear/rear/blob/master/packaging/arch/PKGBUILD">file</a>
already includes a hard dependency on <code>gawk</code> which we could easily
extend to also include <code>bc</code>:</p>
<pre><code>depends=(lsb-release iproute2 parted cpio openssl gawk)
</code></pre>
<h4 id="probackup-nl_commented_at_2017-05-11_1817"><img src="https://avatars.githubusercontent.com/u/515451?u=4f985fa15d087babc5049c337be90b42b56c8b8b&v=4" width="50"><a href="https://github.com/ProBackup-nl">ProBackup-nl</a> commented at <a href="https://github.com/rear/rear/issues/1269#issuecomment-300873965">2017-05-11 18:17</a>:<a class="headerlink" href="#probackup-nl_commented_at_2017-05-11_1817" title="Permanent link">&para;</a></h4>
<p>@schlomo As long as <code>bc</code> isn't an <strong>optional</strong> dependency, I don't feel
any need.</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2025 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2017-03-28.1269.issue.closed.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/rear/rear-user-guide" class="fa fa-code-fork" style="color: #fcfcfc"> rear/rear-user-guide</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
