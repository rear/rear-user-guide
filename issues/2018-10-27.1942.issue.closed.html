<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#1942 Issue closed: Support EFISTUB booting (e.g. on Arch Linux) - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#1942 Issue closed: Support EFISTUB booting (e.g. on Arch Linux)";
        var mkdocs_page_input_path = "issues/2018-10-27.1942.issue.closed.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/backup_netfs.html">Example of BACKUP=NETFS</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/netfs_nas.html">Internal Backup with tar to NFS server</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/netfs_rsync.html">Internal Backup with rsync to NFS server</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/rsync.html">Internal Backup using BACKUP=RSYNC method</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/rbme.html">External Backup using RBME</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/restic.html">External Backup using restic</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../development/squash-git-log-commments.html">How to squash git log comments into one line</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear29.html">Release Notes ReaR 2.9</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear28.html">Release Notes ReaR 2.8</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#1942 Issue closed: Support EFISTUB booting (e.g. on Arch Linux)</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="1942_issue_closed_support_efistub_booting_eg_on_arch_linux"><a href="https://github.com/rear/rear/issues/1942">#1942 Issue</a> <code>closed</code>: Support EFISTUB booting (e.g. on Arch Linux)<a class="headerlink" href="#1942_issue_closed_support_efistub_booting_eg_on_arch_linux" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>enhancement</code>, <code>cleanup</code>, <code>fixed / solved / done</code></p>
<h4 id="johnny-cash_opened_issue_at_2018-10-27_1539"><img src="https://avatars.githubusercontent.com/u/37628193?v=4" width="50"><a href="https://github.com/johnny-cash">johnny-cash</a> opened issue at <a href="https://github.com/rear/rear/issues/1942">2018-10-27 15:39</a>:<a class="headerlink" href="#johnny-cash_opened_issue_at_2018-10-27_1539" title="Permanent link">&para;</a></h4>
<p>rear/usr/share/rear/finalize/Linux-i386/630_run_efibootmgr.sh</p>
<p>This script fails because arch linux loads uefi from /boot and not from
/boot/efi</p>
<pre>
# check if $TARGET_FS_ROOT/boot/efi is mounted
[[ -d "$TARGET_FS_ROOT/boot/efi" ]]
StopIfError "Could not find directory $TARGET_FS_ROOT/boot/efi"

BootEfiDev="$( mount | grep "boot/efi" | awk '{print $1}' )"
Dev=$( get_device_name $BootEfiDev )    # /dev/sda1 or /dev/mapper/vol34_part2 or /dev/mapper/mpath99p4
ParNr=$( get_partition_number $Dev )  # 1 (must anyway be a low nr <9)
Disk=$( echo ${Dev%$ParNr} ) # /dev/sda or /dev/mapper/vol34_part or /dev/mapper/mpath99p
</pre>

<h4 id="jsmeix_commented_at_2018-10-29_0933"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1942#issuecomment-433843508">2018-10-29 09:33</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-10-29_0933" title="Permanent link">&para;</a></h4>
<p>@gozora<br />
could you have a look here how to enhance it because<br />
it seems Arch Linux uses /boot and not /boot/efi</p>
<h4 id="gozora_commented_at_2018-10-29_0950"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/1942#issuecomment-433848552">2018-10-29 09:50</a>:<a class="headerlink" href="#gozora_commented_at_2018-10-29_0950" title="Permanent link">&para;</a></h4>
<p>@jsmeix I'll take a look as a time permits ...</p>
<p>@johnny-cash there is several ways ho Arch can deal with UEFI, can you
please describe yours in more detail ?<br />
It would also help if you'd not ignore our issue template ...</p>
<p>V.</p>
<h4 id="jsmeix_commented_at_2018-10-29_1646"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1942#issuecomment-433986248">2018-10-29 16:46</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-10-29_1646" title="Permanent link">&para;</a></h4>
<p>@gdha<br />
I also assigned you here because</p>
<pre>
git log -p --follow usr/share/rear/finalize/Linux-i386/630_run_efibootmgr.sh
</pre>

<p>shows that 630_run_efibootmgr.sh was intitially from you<br />
and<br />
I assigned me because I think 630_run_efibootmgr.sh needs to be<br />
generally overhauled like I did it for 620_install_grub2.sh<br />
in particular I think 'finalize' stage scripts should usually not error
out,<br />
see my comment in 620_install_grub2.sh</p>
<h4 id="jsmeix_commented_at_2018-10-29_1652"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1942#issuecomment-433988861">2018-10-29 16:52</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-10-29_1652" title="Permanent link">&para;</a></h4>
<p>At a very first glance I think I can use the UEFI_BOOTLOADER value<br />
to get the right directory where the ESP is mounted<br />
cf. the code in rescue/default/850_save_sysfs_uefi_vars.sh<br />
... more tomorrow ...</p>
<h4 id="jsmeix_commented_at_2018-10-29_1700"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1942#issuecomment-433992083">2018-10-29 17:00</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-10-29_1700" title="Permanent link">&para;</a></h4>
<p>@johnny-cash<br />
in your ReaR log file (and on your terminal when you run ReaR in verbose
mode)<br />
you got a message like</p>
<pre>
Using '/boot/loader.efi' as UEFI bootloader file
</pre>

<p>What exactly did you get?</p>
<p>Best provide us a whole rear debug log file,<br />
see what we need at<br />
<a href="https://github.com/rear/rear/blob/master/.github/ISSUE_TEMPLATE.md">https://github.com/rear/rear/blob/master/.github/ISSUE_TEMPLATE.md</a><br />
and the section<br />
"Debugging issues with Relax-and-Recover" at<br />
<a href="https://en.opensuse.org/SDB:Disaster_Recovery">https://en.opensuse.org/SDB:Disaster_Recovery</a></p>
<h4 id="gozora_commented_at_2018-10-29_1720"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/1942#issuecomment-433999468">2018-10-29 17:20</a>:<a class="headerlink" href="#gozora_commented_at_2018-10-29_1720" title="Permanent link">&para;</a></h4>
<p>I currently see two problems here:</p>
<ol>
<li>Arch gives you freedom during installation to set up your UEFI
    partition (esp) wherever you like. As an example I've managed to
    setup my Arch as follows:</li>
</ol>
<!-- -->

<pre><code>/dev/sda2 on / type ext4 (rw,relatime)
/dev/sda1 on /boot/hello type vfat (rw,relatime,fmask=0022,dmask=0022,codepage=437,iocharset=iso8859-1,shortname=mixed,utf8,errors=remount-ro)
</code></pre>
<p>Hence heaving esp in <em>/boot/hello</em> ...</p>
<p>This is good for Arch users but can quite easily become nightmare for
us, since we can't rely on "standard" filesystem layout when determining
which EFI files to copy.</p>
<ol>
<li>You can setup Arch not to use GRUB2 (or any other boot loader) and
    nicely tell UEFI "Hey UEFI, don't bother with grubx64.efi and
    friends but rather boot vmliuz directly!". (a.k.a. EFISTUB) Such
    setup which is recommended directly by <a href="https://wiki.archlinux.org/index.php/EFI_system_partition#Mount_the_partition">Arch
    wiki</a>,
    and which I guess is reason of @johnny-cash trouble, will most
    probably avoid ReaR to create recovery system as you are not bound
    to have any boot loader helper utilities (GRUB, elilo, ...)
    installed.<br />
    And even if you'd install them, and you'd convince ReaR to ignore
    all the hard coded <em>boot/efi</em> references, ReaR would incorrectly
    install GRUB on finalize stage, instead using EFISTUB ...</li>
</ol>
<p>In upcoming days (if time permits) I'll try to find some reasonable way
to implement EFISTUB into ReaR.</p>
<p>V.</p>
<h4 id="jsmeix_commented_at_2018-10-30_0925"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1942#issuecomment-434228496">2018-10-30 09:25</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-10-30_0925" title="Permanent link">&para;</a></h4>
<p>@gozora<br />
give me a bit of time - I would like to do a pull request soon - then
you can<br />
have a look if you like it...</p>
<h4 id="gozora_commented_at_2018-10-30_1002"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/1942#issuecomment-434240063">2018-10-30 10:02</a>:<a class="headerlink" href="#gozora_commented_at_2018-10-30_1002" title="Permanent link">&para;</a></h4>
<p>@jsmeix you have all the time of the world, I'm currently exploring new
feeling of booting without Grub ;-) (strange feeling BTW), but not
actually writing any ReaR code ...</p>
<p>V.</p>
<h4 id="gozora_commented_at_2018-10-30_1010"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/1942#issuecomment-434242489">2018-10-30 10:10</a>:<a class="headerlink" href="#gozora_commented_at_2018-10-30_1010" title="Permanent link">&para;</a></h4>
<p>@rear/contributors I'm doing small research.<br />
Can you please look for string "<em>EFI</em>" in kernels of your testing
systems and paste results to this thread together with kernel version
and distro? It doesn't really matter if your OS is setup for LEGACY or
UEFI boot ...</p>
<p>Something like:</p>
<pre><code>arch-efi:(/root)(root)# cat /etc/os-release; uname -r &amp;&amp; strings /boot/vmlinuz-linux | grep EFI
NAME="Arch Linux"
PRETTY_NAME="Arch Linux"
ID=arch
ID_LIKE=archlinux
ANSI_COLOR="0;36"
HOME_URL="https://www.archlinux.org/"
SUPPORT_URL="https://bbs.archlinux.org/"
BUG_REPORT_URL="https://bugs.archlinux.org/"
4.18.16-arch1-1-ARCH
EFI stub: ERROR: Failed to alloc mem for file handle list
EFI stub: ERROR: Failed to alloc highmem for files
EFI stub: ERROR: We've run out of free low memory
EFI stub: ERROR: Failed to read file
EFI stub: ERROR: Failed to allocate usable memory for kernel.
EFI stub: UEFI Secure Boot is enabled.
EFI stub: ERROR: Could not determine UEFI Secure Boot status.
</code></pre>
<p>Thanks</p>
<p>V.</p>
<h4 id="jsmeix_commented_at_2018-10-30_1012"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1942#issuecomment-434243181">2018-10-30 10:12</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-10-30_1012" title="Permanent link">&para;</a></h4>
<p>@gozora @gdha<br />
have a look at my blind attempt to clean up 630_run_efibootmgr.sh<br />
('blind' because I did not test anything I only looked at the code)<br />
in
<a href="https://github.com/rear/rear/pull/1945">https://github.com/rear/rear/pull/1945</a></p>
<h4 id="gdha_commented_at_2018-10-30_1018"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/issues/1942#issuecomment-434244986">2018-10-30 10:18</a>:<a class="headerlink" href="#gdha_commented_at_2018-10-30_1018" title="Permanent link">&para;</a></h4>
<p>My laptop is capable of UEFI booting, but I turned it off.</p>
<pre><code>$ sudo cat /etc/os-release; uname -r &amp;&amp; strings /boot/vmlinuz-3.10.0-862.14.4.el7.x86_64 | grep EFI
NAME="CentOS Linux"
VERSION="7 (Core)"
ID="centos"
ID_LIKE="rhel fedora"
VERSION_ID="7"
PRETTY_NAME="CentOS Linux 7 (Core)"
ANSI_COLOR="0;31"
CPE_NAME="cpe:/o:centos:centos:7"
HOME_URL="https://www.centos.org/"
BUG_REPORT_URL="https://bugs.centos.org/"

CENTOS_MANTISBT_PROJECT="CentOS-7"
CENTOS_MANTISBT_PROJECT_VERSION="7"
REDHAT_SUPPORT_PRODUCT="centos"
REDHAT_SUPPORT_PRODUCT_VERSION="7"

3.10.0-862.14.4.el7.x86_64
EFI stub: ERROR: Failed to alloc mem for initrds
EFI stub: ERROR: Failed to alloc highmem for initrds
EFI stub: ERROR: We've run out of free low memory
EFI stub: ERROR: Failed to read initrd
EFI stub: ERROR: Failed to alloc mem for kernel
</code></pre>
<h4 id="jsmeix_commented_at_2018-10-30_1020"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1942#issuecomment-434245459">2018-10-30 10:20</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-10-30_1020" title="Permanent link">&para;</a></h4>
<p>On my worksation where I use UEFI:</p>
<pre>
# cat /etc/os-release
NAME="openSUSE Leap"
VERSION="15.0"
ID="opensuse-leap"
ID_LIKE="suse opensuse"
VERSION_ID="15.0"
PRETTY_NAME="openSUSE Leap 15.0"
ANSI_COLOR="0;32"
CPE_NAME="cpe:/o:opensuse:leap:15.0"
BUG_REPORT_URL="https://bugs.opensuse.org"
HOME_URL="https://www.opensuse.org/"

# ls -lhtr /boot/vmlinu*
-rw-r--r-- 1 root root 7.7M Oct  5 10:22 /boot/vmlinux-4.12.14-lp150.12.19-default.gz
-rw-r--r-- 1 root root 6.8M Oct  5 10:47 /boot/vmlinuz-4.12.14-lp150.12.19-default
-rw-r--r-- 1 root root 7.7M Oct 13 16:55 /boot/vmlinux-4.12.14-lp150.12.22-default.gz
-rw-r--r-- 1 root root 6.8M Oct 13 17:24 /boot/vmlinuz-4.12.14-lp150.12.22-default
lrwxrwxrwx 1 root root   35 Oct 17 08:47 /boot/vmlinuz -> vmlinuz-4.12.14-lp150.12.22-default

# uname -r
4.12.14-lp150.12.22-default

# strings /boot/vmlinuz-4.12.14-lp150.12.22-default | grep EFI
EFI_SUCCESS
EFI_LOAD_ERROR
EFI_INVALID_PARAMETER
EFI_UNSUPPORTED
EFI_BAD_BUFFER_SIZE
EFI_BUFFER_TOO_SMALL
EFI_NOT_READY
EFI_DEVICE_ERROR
EFI_WRITE_PROTECTED
EFI_OUT_OF_RESOURCES
EFI_NOT_FOUND
EFI_ABORTED
EFI_SECURITY_VIOLATION
EFI stub: ERROR: Failed to alloc mem for file handle list
EFI stub: ERROR: Failed to alloc highmem for files
EFI stub: ERROR: We've run out of free low memory
EFI stub: ERROR: Failed to read file
EFI stub: ERROR: Failed to allocate usable memory for kernel.
EFI stub: UEFI Secure Boot is enabled.
EFI stub: ERROR: Could not determine UEFI Secure Boot status.
</pre>

<p>On my old SLES11 32-bit system with BIOS:</p>
<pre>
 # cat /etc/os-release 
NAME="SLED"
VERSION="11.4"
VERSION_ID="11.4"
PRETTY_NAME="SUSE Linux Enterprise Desktop 11 SP4"
ID="sled"
ANSI_COLOR="0;32"
CPE_NAME="cpe:/o:suse:sled:11:4"

# ls -lhtr /boot/vmlinuz*
-rw-r--r-- 1 root root 3.8M Dec 31  2017 /boot/vmlinuz-3.0.101-108.21-pae
lrwxrwxrwx 1 root root   26 Jan 15  2018 /boot/vmlinuz -> vmlinuz-3.0.101-108.21-pae

# uname -r
3.0.101-108.21-pae

# strings /boot/vmlinuz-3.0.101-108.21-pae | grep EFI
[no output]
</pre>

<h4 id="gozora_commented_at_2018-10-30_1448"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/1942#issuecomment-434331127">2018-10-30 14:48</a>:<a class="headerlink" href="#gozora_commented_at_2018-10-30_1448" title="Permanent link">&para;</a></h4>
<p>To my big surprise I just successfully recovered Arch Linux with EFISTUB
without changing a bit in actual ReaR code.(OK, OK, I've used @jsmeix
<a href="https://github.com/rear/rear/pull/1945">https://github.com/rear/rear/pull/1945</a>,
BTW I'd like to once write such code unblinded ;-)).<br />
When using EFISTUB, ReaR incorrectly sets <em>USING_UEFI_BOOTLOADER=0</em>,
by :</p>
<pre><code>+ source /usr/share/rear/prep/default/320_include_uefi_env.sh
...
+++ find /boot -maxdepth 1 -iname efi -type d
++ test ''
++ return 0
</code></pre>
<p>and continues ... As a side effect of such wrong evaluation, ReaR
recovery ISO can't automatically boot, however recovery system can be
booted manually using UEFI shell (with EFISTUB we have kernel that can
be booted directly without helper tools or boot loaders).<br />
After <code>rear recover</code> finishes, I've got</p>
<pre><code>For this system
Arch/ on Linux-i386 (based on /i386)
there is no code to install a boot loader on the recovered system
or the code that we have failed to install the boot loader correctly.
Please contribute appropriate code to the Relax-and-Recover project,
see http://relax-and-recover.org/development/
Take a look at the scripts in /usr/share/rear/finalize,
for example see the scripts
/usr/share/rear/finalize/Linux-i386/210_install_grub.sh
/usr/share/rear/finalize/Linux-i386/220_install_grub2.sh

---------------------------------------------------
|  IF YOU DO NOT INSTALL A BOOT LOADER MANUALLY,  |
|  THEN YOUR SYSTEM WILL NOT BE ABLE TO BOOT.     |
---------------------------------------------------

You can use 'chroot /mnt/local bash --login'
to change into the recovered system.
You should at least mount /proc in the recovered system
e.g. via 'mount -t proc none /mnt/local/proc'
before you change into the recovered system
and manually install a boot loader therein.

Finished recovering your system. You can explore it under '/mnt/local'.
Exiting rear recover (PID 434) and its descendant processes
Running exit tasks
</code></pre>
<p>message, but again, since system boots with EFISTUB manual boot in EFI
shell did the trick, and system is up and running ...</p>
<p>When I've did another test with <em>USING_UEFI_BOOTLOADER=y</em> enforced in
<em>/etc/rear/local.conf</em>,<br />
<code>rear mkrescue</code> failed with:</p>
<pre><code>ERROR: Cannot autodetect what to use as UEFI_BOOTLOADER, you have to manually specify it in /etc/rear/local.conf
Some latest log messages since the last called script 850_save_sysfs_uefi_vars.sh:
  2018-10-30 15:32:24.854058742 Including rescue/default/850_save_sysfs_uefi_vars.sh
  2018-10-30 15:32:24.855709222 Trying to find what to use as UEFI bootloader...
  2018-10-30 15:32:24.871059830 Trying to find a 'well known file' to be used as UEFI bootloader...
  find: '/boot/efi': No such file or directory
  find: '/boot/efi': No such file or directory
  find: '/boot/EFI': No such file or directory
  2018-10-30 15:32:24.889992856 Trying to autodetect from EFI variables what to use as UEFI bootloader file...
  grep: Trailing backslash
Aborting due to an error, check /var/log/rear/rear-arch-efi.log for details
Terminated
</code></pre>
<p>The problem here simply is that, there is nothing that could be used as
<em>UEFI_BOOTLOADER</em>, bacause EFISTUB ...</p>
<p>Now I'm not sure if I want to fix something that is actually working :-)</p>
<p>V.</p>
<h4 id="gozora_commented_at_2018-10-31_0956"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/1942#issuecomment-434626899">2018-10-31 09:56</a>:<a class="headerlink" href="#gozora_commented_at_2018-10-31_0956" title="Permanent link">&para;</a></h4>
<p>I'll give
<a href="https://www.freedesktop.org/wiki/Software/systemd/systemd-boot/">systemd-boot</a>
a try to implement EFISTUB ...</p>
<p>V.</p>
<h4 id="jsmeix_commented_at_2018-10-31_1046"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1942#issuecomment-434641389">2018-10-31 10:46</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-10-31_1046" title="Permanent link">&para;</a></h4>
<p>@gozora<br />
I think it should be possible (with reasonable effort) to enhance<br />
the existing USING_UEFI_BOOTLOADER and UEFI_BOOTLOADER<br />
config variables to also support EFISTUB cleanly in the code.<br />
Not necessarily automatically out of the box but at least manually<br />
e.g. via something like</p>
<pre>
USING_UEFI_BOOTLOADER=1
UEFI_BOOTLOADER="EFISTUB"
</pre>

<p>plus additional conditions in the code that "officially skip" what is
not needed<br />
in case of EFISTUB (and perhaps even set <code>NOBOOTLOADER=''</code> to avoid<br />
the non helpful warning that one needs to manually install a boot
loader)<br />
instead of now where the code blindly and accidentally lets things<br />
somehow work even for EFISTUB.</p>
<p>This way EFISTUB could be generically supported by ReaR<br />
without a requirement of systemd-boot - except in practice<br />
systemd-boot is always used on systems that boot via EFISTUB.</p>
<h4 id="gozora_commented_at_2018-10-31_1115"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/1942#issuecomment-434649188">2018-10-31 11:15</a>:<a class="headerlink" href="#gozora_commented_at_2018-10-31_1115" title="Permanent link">&para;</a></h4>
<p>@jsmeix<br />
In general I agree.</p>
<p>The reason for using systemd-boot as boot loader, is plain and simple
automatic start of boot menu of ReaR recovery system. Without
systemd-boot we would need to somehow tell server what kernel + initrd +
options to boot. This means that we would either need to somehow mess up
with <code>efibootmgr</code> or instruct user around EFI shell, maybe by
documenting it (and I don't like any of these options).</p>
<p>From what I've checked so far, <em>systemd-bootx64.efi</em> is standard part of
Systemd hence available on Linux distributions using Systemd. So we
would not need to install any additional software.</p>
<p>These is my very early idea (which might change over time) how thing
could work. I'd need to continue with research on this topic. I keep you
posted.</p>
<p>V.</p>
<h4 id="jsmeix_commented_at_2018-10-31_1608"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1942#issuecomment-434747675">2018-10-31 16:08</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-10-31_1608" title="Permanent link">&para;</a></h4>
<p>Thanks to mention that 'systemd-boot' actually is <code>systemd-bootx64.efi</code></p>
<p><a href="https://www.freedesktop.org/wiki/Software/systemd/systemd-boot/">https://www.freedesktop.org/wiki/Software/systemd/systemd-boot/</a><br />
does not tell that.</p>
<p>On my SLES15-like openSUSE Leap 15.0 system I have it</p>
<pre>
# rpm -qf /usr/lib/systemd/boot/efi/systemd-bootx64.efi
systemd-234-lp150.20.6.1.x86_64
</pre>

<p>and on my SLES12 system it also exists</p>
<pre>
# rpm -qf /usr/lib/systemd/boot/efi/systemd-bootx64.efi
systemd-228-150.46.1.x86_64
</pre>

<p>For the fun of it:<br />
When you "don't like non of these options" you like them all ;-)</p>
<h4 id="gozora_commented_at_2018-10-31_1720"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/1942#issuecomment-434774197">2018-10-31 17:20</a>:<a class="headerlink" href="#gozora_commented_at_2018-10-31_1720" title="Permanent link">&para;</a></h4>
<p>@jsmeix<br />
Sorry for my previous inconsistencies. I'm pretty new in this EFISTUB
thingy and I'm still exploring its possibilities and ways how we could
use them in ReaR.<br />
The fact that it looks to be widely available across distros, together
with fact that kernels are nowadays build with EFISTUB support, could
simplify ReaR booting code a lot in the future (at least for systems
booting with UEFI).</p>
<blockquote>
<p>For the fun of it:<br />
When you "don't like non of these options" you like them all ;-)</p>
</blockquote>
<p>Comment updated, thanks for pointing it out ;-).</p>
<p>V.</p>
<h4 id="jsmeix_commented_at_2018-11-05_1211"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1942#issuecomment-435853085">2018-11-05 12:11</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-11-05_1211" title="Permanent link">&para;</a></h4>
<p>@gozora<br />
I look forward to your first EFISTUB support in ReaR!</p>
<p>Booting the kernel directly by the UEFI firmware without<br />
a traditional bootloader in between looks right to me<br />
in particular because it avoids RFC 1925 item 6a:<br />
"It is always possible to add another level of indirection."</p>
<p>But booting via EFISTUB could only simplify the ReaR booloader<br />
setup code provided the original system is booted this way.</p>
<p>Because ReaR intends to recreate a system as far as possible as it was
before<br />
"rear recover" would have to recreate a system that boots via UEFI<br />
with GRUB2 in between when the original system booted this way.</p>
<p>I assume there are use cases where GRUB2 in between is useful<br />
even on UEFI hardware and EFISTUB support in the kernel.<br />
I guess GRUB2 in between provides features that plain UEFI doesn't.</p>
<h4 id="gozora_commented_at_2018-11-05_1935"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/1942#issuecomment-436006512">2018-11-05 19:35</a>:<a class="headerlink" href="#gozora_commented_at_2018-11-05_1935" title="Permanent link">&para;</a></h4>
<p>@jsmeix</p>
<blockquote>
<p>I look forward to your first EFISTUB support in ReaR!</p>
</blockquote>
<p>Unfortunately I'm quite short on time last few weeks, I'll try to start
my work on EFISTUB support next week ...</p>
<p>Automatically detecting EFISTUB would be similar precarious task as
finding right UEFI boot loader, hence I'll most probably let user
manually specify <em>UEFI_BOOTLOADER="EFISTUB"</em> at lest for early stages.</p>
<p>V.</p>
<h4 id="jsmeix_commented_at_2018-11-06_1213"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1942#issuecomment-436231918">2018-11-06 12:13</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-11-06_1213" title="Permanent link">&para;</a></h4>
<p>@gozora<br />
no rush - take your time!</p>
<p>Yes, first and foremost the user must be able to specify what he wants<br />
so that he has the final power to command what ReaR does.<br />
Then as fallback if nothing was specified a best effort attempt<br />
to guess how the system was booted can be done,<br />
cf. rescue/default/850_save_sysfs_uefi_vars.sh</p>
<h4 id="gozora_commented_at_2018-11-12_1626"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/1942#issuecomment-437943236">2018-11-12 16:26</a>:<a class="headerlink" href="#gozora_commented_at_2018-11-12_1626" title="Permanent link">&para;</a></h4>
<p>I've put together some very basic
<a href="https://github.com/rear/rear/compare/master...gozora:EFISTUB">code</a> for
EFISTUB support in ReaR, it currently works only for <em>OUTPUT=ISO</em> and
restore (<code>rear recover</code>) part does not work at all.<br />
I've finally decided not to use <em>UEFI_BOOTLOADER="EFISTUB"</em>, since it
don't feel right and can become quite confusing, since EFISTUB doesn't
really use traditional Linux boot loader.</p>
<p>New variable <em>EFI_STUB</em> in <em>global.conf</em>.was introduced and will imply
<em>USING_UEFI_BOOTLOADER=1</em> and
<em>UEFI_BOOTLOADER="/usr/lib/systemd/boot/efi/systemd-bootx64.efi"</em> with
message in log file in case that user will try to set these variables.</p>
<p>When using <em>EFISTUB=y</em>, <em>UEFI_BOOTLOADER</em> have meaning only for
creation process of ReaR recovery system where it is used to display
boot menu in same way like Syslinux, Grub or Elilo did.</p>
<p>V.</p>
<h4 id="jsmeix_commented_at_2018-11-13_0821"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1942#issuecomment-438176941">2018-11-13 08:21</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-11-13_0821" title="Permanent link">&para;</a></h4>
<p>@gozora<br />
great to have some very basic EFISTUB support in ReaR!<br />
Now there is an entry point where things can be further enhanced as
needed.</p>
<p>I do not understand what you wrote<br />
<code>it ... works ... for ... restore</code> and<br />
<code>rear recover part does not work at all</code><br />
because 'restore' is usually a part of "rear recover" (when 'restore'<br />
means the 'restore' of the backup during "rear recover").</p>
<p>Some initial review of your<br />
<a href="https://github.com/rear/rear/compare/master...gozora:EFISTUB">https://github.com/rear/rear/compare/master...gozora:EFISTUB</a><br />
by plain looking at the code:</p>
<p>I think in usr/share/rear/pack/GNU/Linux/500_check_EFISTUB.sh<br />
the 'StopIfError' is not needed and could be simplified to plain
'Error'<br />
because the 'if' condition had already tested that this is the error
case<br />
(I wonder why there is <code>$( ... )</code> command substitution in the 'if'
condition).<br />
Because 'Error' exits the whole ReaR I think it could be simplified<br />
to a single <code>COMMAND || Error</code> line for example like</p>
<pre>
grep -q -i "EFI stub" $KERNEL_FILE || Error "$KERNEL_FILE is not compiled with EFISTUB support"
LogPrint "Using $KERNEL_FILE with EFISTUB support"
</pre>

<p>or similar.</p>
<p>In usr/share/rear/rescue/default/850_save_sysfs_uefi_vars.sh<br />
the hardcoded</p>
<pre>
UEFI_BOOTLOADER="/usr/lib/systemd/boot/efi/systemd-bootx64.efi"
</pre>

<p>should have at least a test that this file exists<br />
as it is done elsewhere in that script like</p>
<pre>
if is_true $EFI_STUB; then
    # Add checks here
    UEFI_BOOTLOADER="/usr/lib/systemd/boot/efi/systemd-bootx64.efi"
    test -f "$UEFI_BOOTLOADER" && return
    Error "EFISTUB requires $UEFI_BOOTLOADER"
fi
</pre>

<p>because otherwise it could bindly proceed with a UEFI_BOOTLOADER
value<br />
that cannot work and then things may fail later at an unexpected place<br />
cf. "Try to care about possible errors" in<br />
<a href="https://github.com/rear/rear/wiki/Coding-Style">https://github.com/rear/rear/wiki/Coding-Style</a></p>
<h4 id="gozora_commented_at_2018-11-13_0921"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/1942#issuecomment-438194614">2018-11-13 09:21</a>:<a class="headerlink" href="#gozora_commented_at_2018-11-13_0921" title="Permanent link">&para;</a></h4>
<p>Hello @jsmeix,</p>
<p>Thanks for your inputs ...</p>
<blockquote>
<p>I do not understand what you wrote<br />
it ... works ... for ... restore and<br />
rear recover part does not work at all<br />
because 'restore' is usually a part of "rear recover" (when
'restore'<br />
means the 'restore' of the backup during "rear recover").</p>
</blockquote>
<p>Let me simplify this ;-), it works currently only to create ReaR
recovery system and backup (<code>rear mkbackup/mkrescue</code>).</p>
<p>For hardcoded:
<code>UEFI_BOOTLOADER="/usr/lib/systemd/boot/efi/systemd-bootx64.efi"</code> there
will be checks for file existence, as you can see in comment:</p>
<pre><code>if is_true $EFI_STUB; then
    # Add checks here
   ...
</code></pre>
<p>I was mostly interested about general opinion on introducing $EFI_STUB
configuration variable and its functionality when it is internally
overriding variables that can be normally set by user (UEFI_BOOTLOADER
and USING_UEFI_BOOTLOADER).<br />
I'm not sure if we have some other code in ReaR that behaves like
this.<br />
I personally as user, don't like situations where I configure some
settings and they are overridden by application for whatever reason
without even simple explanation why ...</p>
<p>V.</p>
<h4 id="jsmeix_commented_at_2018-11-13_0941"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1942#issuecomment-438201020">2018-11-13 09:41</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-11-13_0941" title="Permanent link">&para;</a></h4>
<p>@gozora<br />
using separated config variables for separated things is "the right
thing".</p>
<p>In particular I prefer to Keep Separated Issues Separated (KSIS)<br />
to avoid RFC 1925 item (5)
<a href="https://tools.ietf.org/html/rfc1925">https://tools.ietf.org/html/rfc1925</a><br />
as a precondition to Keep It Simple and Straightforward (KISS).</p>
<p>We have other cases in ReaR where some config variable sets another<br />
config variable if the other config variable was not explicitly
specified<br />
e.g. "If you do not specify OUTPUT_URL variable then by default<br />
it will be aligned to what was defined by variable BACKUP_URL" in<br />
<a href="https://github.com/rear/rear/blob/master/doc/rear.8.adoc">https://github.com/rear/rear/blob/master/doc/rear.8.adoc</a></p>
<p>I saw your 'Add checks here' comment but misunderstood it<br />
as if it meant that some automated search for <code>systemd-bootx64.efi</code><br />
could be added later here (something like the other automated<br />
search code in rescue/default/850_save_sysfs_uefi_vars.sh).</p>
<h4 id="gozora_commented_at_2018-11-13_0948"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/1942#issuecomment-438202988">2018-11-13 09:48</a>:<a class="headerlink" href="#gozora_commented_at_2018-11-13_0948" title="Permanent link">&para;</a></h4>
<blockquote>
<p>We have other cases in ReaR where some config variable sets another<br />
config variable if the other config variable was not explicitly
specified<br />
e.g. "If you do not specify OUTPUT_URL variable then by default<br />
it will be aligned to what was defined by variable BACKUP_URL" in<br />
<a href="https://github.com/rear/rear/blob/master/doc/rear.8.adoc">https://github.com/rear/rear/blob/master/doc/rear.8.adoc</a></p>
</blockquote>
<p>Yes I know about situations like this, but what I'm planning to do, is
to override UEFI_BOOTLOADER and USING_UEFI_BOOTLOADER even if they
are explicitly set by user in local.conf or site.conf.</p>
<p>V.</p>
<h4 id="schlomo_commented_at_2018-11-13_1014"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/issues/1942#issuecomment-438211121">2018-11-13 10:14</a>:<a class="headerlink" href="#schlomo_commented_at_2018-11-13_1014" title="Permanent link">&para;</a></h4>
<p>Looking over your branch and reading through this issue I have a few
thoughts/questions:</p>
<ul>
<li>Can we somehow separate between the "rescue media boot method" and
    "recovered system boot method" topics? They don't have to be same
    same and IMHO they should not be coupled.</li>
<li>Everything that modifies the rescue media should IMHO show up when
    you do a <code>rear dump</code>. Easiest way to achieve that (and to make it
    obvious to the user) is to prefix such variables with <code>OUTPUT_</code>
    because then they are shown by <code>rear dump</code> with the other output
    related stuff.</li>
<li>Before setting a variable to the full path of <code>systemd-bootx64.efi</code>
    it might be prudent to check that this file actually exists (or
    maybe I missed the check).</li>
<li>Changing the boot loader of the recovered system is a heavy change
    and part of a migration. IMHO a variable to control that should
    start with <code>MIGRATE_</code> or something like this. Probably it would be
    good to add a section to the output of <code>rear dump</code> that will print
    all variables starting from <code>MIGRAT</code> so that users can much easier
    see migration-related settings.</li>
<li>IMHO the <em>only correct</em> way of finding (and not guessing) the <a href="https://en.wikipedia.org/wiki/EFI_system_partition">EFI
    System
    Partition</a> is<ol>
<li>find the first GPT partition with a GUID of
    <code>C12A7328-F81F-11D2-BA4B-00A0C93EC93B</code> (or MBR partition with a
    type of <code>0xEF</code>)</li>
<li>find where this partition is mounted in the system</li>
</ol>
</li>
<li>Maybe we should have the <code>dump</code> workflow also run
    <code>SourceStage "prep"</code> initially so that the <code>dump</code> output will
    actually reflect the calculated variables and not only show the
    static configuration.</li>
</ul>
<p>Just for my understanding: Is EFISTUB the default UEFI boot loader in
Arch? Does Arch with grub2 on UEFI work already (the find-the-ESP
problem should be the same there, no?)?</p>
<p>If the core problem of this issue is "support EFISTUB booting on Arch"
then we should maybe rename it so.</p>
<h4 id="jsmeix_commented_at_2018-11-13_1027"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1942#issuecomment-438215291">2018-11-13 10:27</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-11-13_1027" title="Permanent link">&para;</a></h4>
<p>@gozora<br />
what the user commands is sacrosanct, cf. "WHAT A MESS!" in<br />
<a href="https://github.com/rear/rear/pull/1733#issuecomment-367680598">https://github.com/rear/rear/pull/1733#issuecomment-367680598</a></p>
<p>In current default.conf there is</p>
<pre>
USING_UEFI_BOOTLOADER=
...
UEFI_BOOTLOADER=""
...
SECURE_BOOT_BOOTLOADER=""
</pre>

<p>so by default none of those config variables have an actual value.<br />
In this default case you can set their value to whatever looks right<br />
when EFI_STUB has a true value because when a config value has<br />
no real value it means ReaR can do and does automated things.</p>
<p>But when a config variable has a real value this is a command<br />
from the user and then ReaR has to obey where "obey" also means<br />
ReaR has to error out if the user commanded something impossible.</p>
<p>Accordingly if the user specified</p>
<pre>
EFI_STUB=true
UEFI_BOOTLOADER="/usr/lib/mysystemd/myboot/myefi/mysystemd-bootx64.efi"
</pre>

<p>and '/usr/lib/mysystemd/myboot/myefi/mysystemd-bootx64.efi' exists<br />
(on Arch Linux things can be anything anywhere) ReaR has to obey<br />
but otherwise (when that file does not exist) ReaR has to error out.</p>
<p>Accordingly I suggest in
rescue/default/850_save_sysfs_uefi_vars.sh<br />
code like</p>
<pre>
for dummy in "once" ; do
    if test -f "$SECURE_BOOT_BOOTLOADER" ; then
        UEFI_BOOTLOADER="$SECURE_BOOT_BOOTLOADER"
    fi

    ...
    test -f "$UEFI_BOOTLOADER" && continue

    if is_true $EFI_STUB; then
        UEFI_BOOTLOADER="/usr/lib/systemd/boot/efi/systemd-bootx64.efi"
        test -f "$UEFI_BOOTLOADER" && return
        Error "EFISTUB requires $UEFI_BOOTLOADER"
    fi
</pre>

<p>I do not know how SECURE_BOOT_BOOTLOADER and EFI_STUB<br />
could be related to each other - perhaps additional checks are needed?</p>
<p>Furthermore in prep/default/320_include_uefi_env.sh an additional
check<br />
is needed at the beginning to error out if USING_UEFI_BOOTLOADER is
false<br />
but EFI_STUB is true like</p>
<pre>
# by default the variable USING_UEFI_BOOTLOADER is empty which means ReaR will decide (this script)
# except when the variable USING_UEFI_BOOTLOADER has an explicit 'false' value set:
if is_false $USING_UEFI_BOOTLOADER ; then
    # we forced the variable to zero (in local.conf) so we do not want UEFI stuff
    # except EFI_STUB is true which conflicts here:
    is_true $EFI_STUB && Error "EFI_STUB true conflicts with USING_UEFI_BOOTLOADER false"
    Log "We do not want UEFI capabilities in ReaR (USING_UEFI_BOOTLOADER=0)"
    return
fi
</pre>

<h4 id="jsmeix_commented_at_2018-11-13_1036"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1942#issuecomment-438217922">2018-11-13 10:36</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-11-13_1036" title="Permanent link">&para;</a></h4>
<p>@gozora<br />
and you can (and should) explain special interdependencies<br />
between config variables (and/or their values) in default.conf<br />
so that users who manually specify those config values are informed.</p>
<h4 id="jsmeix_commented_at_2018-11-13_1045"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1942#issuecomment-438220832">2018-11-13 10:45</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-11-13_1045" title="Permanent link">&para;</a></h4>
<p>@schlomo<br />
thanks to mention</p>
<pre>
separate between the "rescue media boot method"
and "recovered system boot method"
</pre>

<p>because I fear I already confused both methods here.<br />
I usually confuse them because their config variable names<br />
do not make it obvious whereto they belong but we cannot<br />
change config variable names...</p>
<p>There are no properly and meaningful prefixed<br />
config variables to distinguish between things that belong to<br />
the ReaR recovery system (e.g. SECURE_BOOT_BOOTLOADER)<br />
versus things for the original system (e.g. GRUB_RESCUE)<br />
versus things for the recreated system (e.g. BOOTLOADER)<br />
versus things that belong both to the ReaR recovery system<br />
and to the recreated system (e.g. UEFI_BOOTLOADER).</p>
<h4 id="gozora_commented_at_2018-11-13_1117"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/1942#issuecomment-438230002">2018-11-13 11:17</a>:<a class="headerlink" href="#gozora_commented_at_2018-11-13_1117" title="Permanent link">&para;</a></h4>
<p>Hello @schlomo</p>
<blockquote>
<p>IMHO the only correct way of finding (and not guessing) the ...</p>
</blockquote>
<p>The thing is, that with EFISTUB we don't need to look for esp, nor doing
all the guess work for boot loaders (*.efi) detection.</p>
<blockquote>
<p>Just for my understanding: Is EFISTUB the default UEFI boot loader in
Arch?</p>
</blockquote>
<p>It is hard to say what is actual default on Arch :-). According almighty
<a href="https://wiki.archlinux.org/index.php/Arch_boot_process">Arch wiki</a>:</p>
<p><strong>Under UEFI</strong><br />
...</p>
<ol>
<li>
<p>Firmware launches the EFI application.</p>
</li>
<li>
<p>This could be a boot loader or the Arch kernel itself using EFISTUB.</p>
</li>
<li>It could be some other EFI application such as a UEFI shell or a
    boot manager like systemd-boot or rEFInd.</li>
</ol>
<blockquote>
<p>Does Arch with grub2 on UEFI work already (the find-the-ESP problem
should be the same there, no?)?</p>
</blockquote>
<p>The main "problem" is that Arch allows you to setup system booting
whatever you like. The possibilities are endless and I think ReaR can't
cover them all. So if you setup Arch with Grub on UEFI with esp on
<em>/boot/efi</em> everything should work just fine.</p>
<p>V.</p>
<h4 id="gozora_commented_at_2018-11-13_1122"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/1942#issuecomment-438231515">2018-11-13 11:22</a>:<a class="headerlink" href="#gozora_commented_at_2018-11-13_1122" title="Permanent link">&para;</a></h4>
<p>@jsmeix your
<a href="https://github.com/rear/rear/issues/1942#issuecomment-438215291">https://github.com/rear/rear/issues/1942#issuecomment-438215291</a>
makes perfect sense.<br />
It is much better to stop execution if configuration values are
conflicting or incorrect, than changing things behind the scenes ...</p>
<p>V.</p>
<h4 id="schlomo_commented_at_2018-11-13_1128"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/issues/1942#issuecomment-438233034">2018-11-13 11:28</a>:<a class="headerlink" href="#schlomo_commented_at_2018-11-13_1128" title="Permanent link">&para;</a></h4>
<blockquote>
<p>The thing is, that with EFISTUB we don't need to look for esp, nor
doing all the guess work for boot loaders (*.efi) detection.</p>
</blockquote>
<p>What about adding the correct kernel &amp; kernel command line to the UEFI
boot menu via <code>efibootmgr</code>? Don't we need to know where to find the ESP
for that?</p>
<h4 id="gozora_commented_at_2018-11-13_1133"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/1942#issuecomment-438234540">2018-11-13 11:33</a>:<a class="headerlink" href="#gozora_commented_at_2018-11-13_1133" title="Permanent link">&para;</a></h4>
<blockquote>
<p>What about adding the correct kernel &amp; kernel command line to the UEFI
boot menu via efibootmgr? Don't we need to know where to find the ESP
for that?</p>
</blockquote>
<p>No, we could either use <code>efibootmgr -v</code> where all the boot options
should be visible (AFAIK they are in unicode, so some additional work
would be required), or check <em>/proc/cmdline</em></p>
<p>V.</p>
<h4 id="schlomo_commented_at_2018-11-13_1134"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/issues/1942#issuecomment-438234990">2018-11-13 11:34</a>:<a class="headerlink" href="#schlomo_commented_at_2018-11-13_1134" title="Permanent link">&para;</a></h4>
<p>IMHO checking command line of the currently running kernel is not
enough. There could be also other boot entries, e.g. to start a previous
kernel version or to start in some safe mode or single user mode.</p>
<h4 id="gozora_commented_at_2018-11-13_1138"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/1942#issuecomment-438236008">2018-11-13 11:38</a>:<a class="headerlink" href="#gozora_commented_at_2018-11-13_1138" title="Permanent link">&para;</a></h4>
<p>You mean that someone could run <code>rear mkbackup</code> when currently booted in
single user more, or in previous kernel, ... ?</p>
<p>V.</p>
<h4 id="schlomo_commented_at_2018-11-13_1142"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/issues/1942#issuecomment-438237099">2018-11-13 11:42</a>:<a class="headerlink" href="#schlomo_commented_at_2018-11-13_1142" title="Permanent link">&para;</a></h4>
<p>No, I mean that there could be other boot configurations. On SLES, RHEL,
Debian for example you will find another boot configuration for the
previous kernel (in case the new kernel won't boot) and also additional
"safe mode" boot configurations. We should restore them if they exist.</p>
<h4 id="gozora_commented_at_2018-11-13_1148"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/1942#issuecomment-438238639">2018-11-13 11:48</a>:<a class="headerlink" href="#gozora_commented_at_2018-11-13_1148" title="Permanent link">&para;</a></h4>
<p>For something like this, we could either dump whole EFI boot entries
related configuration and restore it after <code>rear recover</code>, or introduce
some new configuration variable where user could specify <code>efibootmgr</code>
command to create entries after <code>rear recover</code> is done ...</p>
<p>But for neither of these cases we need to know location of <em>esp</em>.</p>
<p>V.</p>
<h4 id="jsmeix_commented_at_2018-11-13_1237"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1942#issuecomment-438251322">2018-11-13 12:37</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-11-13_1237" title="Permanent link">&para;</a></h4>
<p>Regarding additional special boot options for the bootloader<br />
of the recreated system you may have a look at<br />
<a href="https://github.com/rear/rear/issues/1828#issuecomment-399050741">https://github.com/rear/rear/issues/1828#issuecomment-399050741</a><br />
which looks related to things like<br />
"another boot configuration for the previous kernel"</p>
<p>My point therein is</p>
<pre>
Because on a by "rear recover" recreated system
there is no such thing as a meaningful previous boot
(because "rear recover" recreates a system by reinstalling it
completely from scratch) so that there is no meaningful use-case
to remember any information from a possible previous boot.
</pre>

<p>In general regarding other boot configurations on SLES and RHEL:<br />
As far as I know at least on SLES only GRUB is used as bootloader<br />
(there is no EFISTUB support on SLES as far as I know)<br />
so that the GRUB config files get restored from the backup<br />
during "rear recover" that should result the same GRUB configuration<br />
as it was on the original system.</p>
<h4 id="gozora_commented_at_2018-11-18_1505"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/1942#issuecomment-439699523">2018-11-18 15:05</a>:<a class="headerlink" href="#gozora_commented_at_2018-11-18_1505" title="Permanent link">&para;</a></h4>
<p>Thanks for all comments so far!<br />
Some of them have already been
<a href="https://github.com/rear/rear/compare/master...gozora:EFISTUB">implemented</a>.</p>
<p>V.</p>
<h4 id="jsmeix_commented_at_2018-11-19_0909"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1942#issuecomment-439820498">2018-11-19 09:09</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-11-19_0909" title="Permanent link">&para;</a></h4>
<p>@gozora<br />
thank you for your continuous efforts to add EFISTUB support in ReaR!</p>
<p>I had a quick look at your latest<br />
<a href="https://github.com/rear/rear/compare/master...gozora:EFISTUB">https://github.com/rear/rear/compare/master...gozora:EFISTUB</a><br />
and found (I cannot add comments directly there so that I post them
here):</p>
<p>(a)<br />
In your usr/share/rear/lib/bootloader-functions.sh there is (excerpts)</p>
<pre>
    # Use grep ' on / ' with explicitly specified spaces as separators instead of
    # grep -w 'on /' ...
    ...
    echo $(mount | grep -w ' on / ' | ...
</pre>

<p>so that the code <code>grep -w ' on / '</code> does no longer match its comment.<br />
What is the reason that the <code>-w</code> option is now needed in addition<br />
to the explicitly specified spaces as separators in <code>' on / '</code>?<br />
Such a reason should be explained in the comment so that others<br />
know why the code must be this way (and do not attempt to simplify it<br />
into something that does no longer work in this or that special cases).</p>
<p>(b)<br />
In usr/share/rear/output/ISO/Linux-i386/250_populate_efibootimg.sh<br />
there is (excerpt)</p>
<pre>
# Use 260_populate_efistub.sh instead.
# There much of Grub/Elilo code here exclude it in menaningfull way.
is_true $EFI_STUB || return 0
</pre>

<p>which skips 250_populate_efibootimg.sh when EFI_STUB is not used<br />
but the comment indicates the opposite that
250_populate_efibootimg.sh<br />
should be skipped when EFI_STUB is used - or what do I misunderstand
here?</p>
<p>(c)<br />
In usr/share/rear/pack/GNU/Linux/500_check_EFISTUB.sh</p>
<pre>
! is_true $USING_UEFI_BOOTLOADER && Error "..."
</pre>

<p>is there a reason why not using</p>
<pre>
is_true $USING_UEFI_BOOTLOADER || Error "..."
</pre>

<p>which would be simpler from my personal point of view (which is<br />
a matter of taste how I personally read code)?</p>
<p>(d)<br />
In usr/share/rear/rescue/default/850_save_sysfs_uefi_vars.sh
(excerpts):</p>
<pre>
    # ... we will use systemd-bootx64.efi (if not overridden in local.conf / site.conf).
    ...
    # This looks to be the best guess for finding our boot loader.
    UEFI_BOOTLOADER="/usr/lib/systemd/boot/efi/systemd-bootx64.efi"
</pre>

<p>this way '/usr/lib/systemd/boot/efi/systemd-bootx64.efi' is used
hardcoded<br />
so that the user cannot override what to use.<br />
Therefore I would suggest something like</p>
<pre>
    # ... we will use systemd-bootx64.efi (if not overridden in local.conf / site.conf).
    ...
    # If not specified by the user use /usr/lib/systemd/boot/efi/systemd-bootx64.efi
    test -f "$UEFI_BOOTLOADER" || UEFI_BOOTLOADER="/usr/lib/systemd/boot/efi/systemd-bootx64.efi"
</pre>

<h4 id="gozora_commented_at_2018-11-19_1116"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/1942#issuecomment-439858514">2018-11-19 11:16</a>:<a class="headerlink" href="#gozora_commented_at_2018-11-19_1116" title="Permanent link">&para;</a></h4>
<p>Hello @jsmeix,</p>
<p>Thanks for your valuable inputs, I'll check them later today ...</p>
<p>V.</p>
<h4 id="gozora_commented_at_2018-11-19_1121"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/1942#issuecomment-439860100">2018-11-19 11:21</a>:<a class="headerlink" href="#gozora_commented_at_2018-11-19_1121" title="Permanent link">&para;</a></h4>
<p>@jsmeix I can comment at least for point d):</p>
<blockquote>
<p>this way '/usr/lib/systemd/boot/efi/systemd-bootx64.efi' is used
hardcoded<br />
so that the user cannot override what to use.<br />
Therefore I would suggest something like</p>
</blockquote>
<p>User can override UEFI_BOOTLOADER by code already present in
850_save_sysfs_uefi_vars.sh</p>
<pre><code>for dummy in "once" ; do
    if test -f "$SECURE_BOOT_BOOTLOADER" ; then
      UEFI_BOOTLOADER="$SECURE_BOOT_BOOTLOADER"
    fi

    # When the user has specified UEFI_BOOTLOADER in /etc/rear/local.conf use it if exists and is a regular file.
    # Double quotes are mandatory here because 'test -f' without any (possibly empty) argument results true:
    test -f "$UEFI_BOOTLOADER" &amp;&amp; continue &lt;== Here it UEFI_BOOTLOADER is set at this stage, further loop execution will stop ...
    ...
</code></pre>
<p>V.</p>
<h4 id="jsmeix_commented_at_2018-11-19_1230"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1942#issuecomment-439877321">2018-11-19 12:30</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-11-19_1230" title="Permanent link">&para;</a></h4>
<p>@gozora<br />
you are right - my misunderstanding happened because<br />
I had only looked at the diff but not at the whole file.</p>
<h4 id="gozora_commented_at_2018-11-19_1636"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/1942#issuecomment-439957297">2018-11-19 16:36</a>:<a class="headerlink" href="#gozora_commented_at_2018-11-19_1636" title="Permanent link">&para;</a></h4>
<p>Hello @jsmeix,</p>
<p>About your comment:
<a href="https://github.com/rear/rear/issues/1942#issuecomment-439820498">https://github.com/rear/rear/issues/1942#issuecomment-439820498</a></p>
<p>First and foremost, thanks for carefully checking my code!</p>
<p>Points a), b) and c) were corrected.</p>
<p>For point a) your are 100% right!<br />
I've mistakenly changed the code to use -w because change in
<a href="https://github.com/rear/rear/compare/master...gozora:EFISTUB#diff-7f052550597fa70483fe418e92ef6f8c">940_grub2_rescue.sh</a>:</p>
<pre><code>-    root_uuid=$(mount | grep -w 'on /' | awk '{print $1}' | xargs blkid -s UUID -o value)
+    root_uuid=$(get_root_disk_UUID)
</code></pre>
<p>but I did not noticed code is using <code>'on /'</code> instead of <code>' on / '</code>.</p>
<p>Thanks for pointing this out!</p>
<p>V.</p>
<h4 id="jsmeix_commented_at_2018-11-20_1000"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1942#issuecomment-440214368">2018-11-20 10:00</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-11-20_1000" title="Permanent link">&para;</a></h4>
<p>I am happy I was able to contribute at least a little bit here<br />
( when I hear [U]EFI I usually try to escape ;-)</p>
<h4 id="gozora_commented_at_2018-11-22_1948"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/1942#issuecomment-441110811">2018-11-22 19:48</a>:<a class="headerlink" href="#gozora_commented_at_2018-11-22_1948" title="Permanent link">&para;</a></h4>
<p>I'm somehow not OK with using UEFI_BOOTLOADER together with EFISTUB.<br />
It don't feel right as EFISTUB doesn't really use a boot loader (only
for auto-magic boot of ReaR rescue system).<br />
I've created another
<a href="https://github.com/gozora/rear/compare/gozora:master...EFISTUB_experiment">branch</a>
where I'm experimenting a bit.<br />
I'm thinking about throwing error when user manually sets
UEFI_BOOTLOADER and use new variable (something like
REAR_RESCUE_EFISTUB_BOOT_LOADER_LOCATION, or maybe something
shorter :-)), to distinguish between booting UEFI with Grub/Elilo and
EFISTUB.</p>
<p>V.</p>
<h4 id="schlomo_commented_at_2018-11-23_0938"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/issues/1942#issuecomment-441193062">2018-11-23 09:38</a>:<a class="headerlink" href="#schlomo_commented_at_2018-11-23_0938" title="Permanent link">&para;</a></h4>
<p> for quality.</p>
<p>Would it be possible to use variables starting with <code>OUTPUT_</code> to
configure and describe everything related to the operation of the ReaR
rescue image? That way a <code>rear dump</code> will actually show them.</p>
<h4 id="gozora_commented_at_2018-11-23_0939"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/1942#issuecomment-441193363">2018-11-23 09:39</a>:<a class="headerlink" href="#gozora_commented_at_2018-11-23_0939" title="Permanent link">&para;</a></h4>
<p>@schlomo sure ...</p>
<h4 id="jsmeix_commented_at_2018-11-23_1017"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1942#issuecomment-441202144">2018-11-23 10:17</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-11-23_1017" title="Permanent link">&para;</a></h4>
<p>Is EFISTUB only about EFISTUB booting of the recovery system<br />
(in this case OUTPUT_EFISTUB* variables would be o.k.)<br />
and it will be never ever intended to be also used<br />
to set up EFISTUB booting of the recreated system?</p>
<p>I think usually booting related config variables affect both<br />
booting of the recovery system and booting of the recreated system<br />
(except exceptions), cf. my above<br />
<a href="https://github.com/rear/rear/issues/1942#issuecomment-438220832">https://github.com/rear/rear/issues/1942#issuecomment-438220832</a></p>
<h4 id="jsmeix_commented_at_2018-11-23_1023"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1942#issuecomment-441203417">2018-11-23 10:23</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-11-23_1023" title="Permanent link">&para;</a></h4>
<p>I wished we had<br />
OUTPUT_BOOT* variables for booting the recovery system<br />
versus<br />
TARGET_BOOT* variables for booting the recreated system</p>
<p>Probably empty OUTPUT_BOOT* variables could inherit<br />
the values from matching TARGET_BOOT* variables<br />
and vice versa for user convenience.</p>
<h4 id="gozora_commented_at_2018-11-23_1032"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/1942#issuecomment-441205377">2018-11-23 10:32</a>:<a class="headerlink" href="#gozora_commented_at_2018-11-23_1032" title="Permanent link">&para;</a></h4>
<blockquote>
<p>Is EFISTUB only about EFISTUB booting of the recovery system<br />
(in this case OUTPUT_EFISTUB* variables would be o.k.)<br />
and it will be never ever intended to be also used<br />
to set up EFISTUB booting of the recreated system?</p>
</blockquote>
<p>EFISTUB is a great simplification of Linux boot process. Where we don't
need to guess, search or build boot loaders on running system (set
UEFI_BOOTLOADER during <code>rear mkbackup/mkrescue</code>) neither we need to
install boot loaders during <code>rear recover</code>.<br />
All we need to know for successful boot is location of kernel file (that
must be compiled with EFISTUB support) and options that should be passed
to kernel (initrd, kernel options as we know them from Grub/Elilo).<br />
I'm planning to write code that will be capable of some auto-magic
detection of these options or allow user to set them manually.</p>
<p>V.</p>
<h4 id="jsmeix_commented_at_2018-11-23_1338"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1942#issuecomment-441243362">2018-11-23 13:38</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-11-23_1338" title="Permanent link">&para;</a></h4>
<p>But I think the user should have a config variable where he could<br />
enforce or forbid ReaR to set up EFISTUB booting.</p>
<p>Assume ReaR determines the kernel is compiled with EFISTUB support<br />
and ReaR does not find a GRUB config, does that mean to set up<br />
EFISTUB booting for the recovery system and the recreated system<br />
in any case and there is no way for the user to get something else?</p>
<p>Assume ReaR determines the kernel is compiled with EFISTUB support<br />
and ReaR finds a GRUB config, does that mean to set up GRUB booting<br />
in any case and there is no way for the user to enforce a migration<br />
to EFISTUB booting for the recreated system?</p>
<h4 id="gozora_commented_at_2018-11-23_1453"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/1942#issuecomment-441260238">2018-11-23 14:53</a>:<a class="headerlink" href="#gozora_commented_at_2018-11-23_1453" title="Permanent link">&para;</a></h4>
<p>EFISTUB has to be activated manually (EFI_STUB=y), because I currently
don't know 100% reliable way for detecting EFISTUB (boot loaders might
or might not be installed, but not used).<br />
I'm planning to create documentation on this topic though ...</p>
<p>V.</p>
<h4 id="gozora_commented_at_2018-12-10_1935"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/1942#issuecomment-445943696">2018-12-10 19:35</a>:<a class="headerlink" href="#gozora_commented_at_2018-12-10_1935" title="Permanent link">&para;</a></h4>
<p>Just goofing around with <a href="https://github.com/gozora/rear/compare/master...gozora:EFISTUB">EFISTUB
code</a><br />
With enabled settings in <em>local.conf</em></p>
<pre><code>...
EFI_STUB=y
KERNEL_FILE="/boot/efi/vmlinuz-4.4.21-69-default"
EFI_STUB_EFIBOOTMGR_ARGS="initrd=initrd-4.4.21-69-default root=/dev/mapper/system-root"
</code></pre>
<p>ReaR was capable to migrate SLES12 SP2 from Grub to EFISTUB nearly out
of the box :-).<br />
Another site effect of EFISTUB is that it might send <em>ebiso</em> into
retirement ...</p>
<p>V.</p>
<h4 id="jsmeix_commented_at_2018-12-11_0917"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1942#issuecomment-446128665">2018-12-11 09:17</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-12-11_0917" title="Permanent link">&para;</a></h4>
<p>@gozora<br />
awesome!</p>
<p>Could you explan what "nearly out of the box" exactly means?<br />
I.e. did you need to do other manual stuff (except specifying the right
config variables)?</p>
<p>FYI<br />
regarding "migrate from Grub to EFISTUB"<br />
we have the related more general issue<br />
<a href="https://github.com/rear/rear/issues/1437">https://github.com/rear/rear/issues/1437</a><br />
so that "migrate from Grub to EFISTUB" could be<br />
a first example where ReaR migrates the bootloader.</p>
<h4 id="jsmeix_commented_at_2018-12-11_0939"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1942#issuecomment-446135800">2018-12-11 09:39</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-12-11_0939" title="Permanent link">&para;</a></h4>
<p>@gozora<br />
because I cannot add coments to your<br />
<a href="https://github.com/gozora/rear/compare/master...gozora:EFISTUB">https://github.com/gozora/rear/compare/master...gozora:EFISTUB</a><br />
I post them here:</p>
<p>In usr/share/rear/finalize/default/050_prepare_checks.sh you set</p>
<pre><code>is_true $EFI_STUB &amp;&amp; NOBOOTLOADER=""
</code></pre>
<p>I wonder if 050_prepare_checks.sh is the right place for that.<br />
Usually <code>NOBOOTLOADER=""</code> is only set at the end of a script<br />
that actually successfully had installed a bootloader.<br />
Accordingly I think <code>NOBOOTLOADER=""</code> should happen<br />
only after EFISTUP setup was actually done successfully.</p>
<p>In general you use always the test <code>is_true $EFI_STUB</code>.<br />
I did not carefully check the details in your code - I think it is o.k.</p>
<p>In general be careful with using <code>is_true</code> and <code>is_false</code><br />
because both are not logical inverse, see the comments<br />
in lib/global-functions.sh (excerpt)</p>
<pre><code>'! is_true' is not the same as 'is_false'
and '! is_false' is not the same as 'is_true'
</code></pre>
<p>Simply put - also imagine what happens in case of<br />
<code>EFI_STUB=''</code> or <code>EFI_STUB=' '</code> or <code>EFI_STUB='fubar'</code><br />
(then both <code>is_true $EFI_STUB</code> and <code>is_false $EFI_STUB</code> return
'false')<br />
even then some reasonable default/fallback behaviour should happen<br />
alternatively you may perhaps add a test in the 'init' stage that errors
out<br />
when both <code>is_true $EFI_STUB</code> and <code>is_false $EFI_STUB</code> return 'false'?</p>
<h4 id="gozora_commented_at_2018-12-11_1019"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/1942#issuecomment-446148676">2018-12-11 10:19</a>:<a class="headerlink" href="#gozora_commented_at_2018-12-11_1019" title="Permanent link">&para;</a></h4>
<p>Hello @jsmeix,</p>
<blockquote>
<p>Could you explan what "nearly out of the box" exactly means?<br />
I.e. did you need to do other manual stuff (except specifying the
right config variables)?</p>
</blockquote>
<p>I'm planning to fully explain this in documentation that I'll prepare
once I'm OK with EFISTUB code.</p>
<p>But in general I had SLES12SP2 with Grub installed booting using UEFI.<br />
Once of the requirements for EFISTUB will be that your KERNEL_FILE MUST
be located on VFAT partition.<br />
Since this requirement was not met, I had to copy KERNEL_FILE and
initrd to /boot/efi (VFAT filesystem) and tell ReaR where EFISTUB
capable kernel is located
(<code>KERNEL_FILE="/boot/efi/vmlinuz-4.4.21-69-default"</code>).<br />
After <code>rear recover</code> was over, ReaR recreated initrd what was located on
original location (in <em>/boot</em>) so I had to copy it again to /boot/efi,
because initrd in <em>/boot/efi</em> is the real initrd that is booted by
EFISTUB.</p>
<p>This could be avoided if I would simply migrate <em>/boot</em> from ext3 to
vfat ....</p>
<p>I'll send you reply to your
<a href="https://github.com/rear/rear/issues/1942#issuecomment-446135800">https://github.com/rear/rear/issues/1942#issuecomment-446135800</a>
later today (or later tomorrow) once I have a bit more time ...</p>
<p>V.</p>
<h4 id="gozora_commented_at_2019-01-05_1256"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/1942#issuecomment-451653345">2019-01-05 12:56</a>:<a class="headerlink" href="#gozora_commented_at_2019-01-05_1256" title="Permanent link">&para;</a></h4>
<p>Hello @jsmeix,</p>
<blockquote>
<p>I wonder if 050_prepare_checks.sh is the right place for that.<br />
Usually NOBOOTLOADER="" is only set at the end of a script<br />
that actually successfully had installed a bootloader.<br />
Accordingly I think NOBOOTLOADER="" should happen<br />
only after EFISTUP setup was actually done successfully.</p>
</blockquote>
<p>I've moved "reset" of NOBOOTLOADER variable directly into
<a href="https://github.com/gozora/rear/commit/98fb9f61932239b3fc38e3ab9fcd5a355ec461ad#diff-56139131511534f2e446dbae527b8711">script</a>
responsible for boot entry creation. It really makes more sense ...</p>
<blockquote>
<p>general be careful with using is_true and is_false ...</p>
</blockquote>
<p>Corrected by
<a href="https://github.com/gozora/rear/commit/400a72ca9d5a8d75b185b408ae932db3ae7c3072">commit</a></p>
<p>Thanks for your inputs.</p>
<p>Soon I'll start writing some small documentation on <a href="https://github.com/rear/rear/compare/master...gozora:EFISTUB?expand=1">EFISTUB
code</a>
describing supported/tested setup and possible behavior during migration
to EFISTUB.</p>
<p>V</p>
<h4 id="gozora_commented_at_2019-02-11_2015"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/1942#issuecomment-462477632">2019-02-11 20:15</a>:<a class="headerlink" href="#gozora_commented_at_2019-02-11_2015" title="Permanent link">&para;</a></h4>
<p>@johnny-cash<br />
With
<a href="https://github.com/rear/rear/pull/1945">https://github.com/rear/rear/pull/1945</a>
and
<a href="https://github.com/rear/rear/pull/2030">https://github.com/rear/rear/pull/2030</a>
merged, changes that "whatever wild boot UEFI setup" can be successfully
restored by ReaR have grown a bit more ;-).</p>
<p>Please test and let us know!</p>
<p>V.</p>
<h4 id="jsmeix_commented_at_2019-02-22_1111"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1942#issuecomment-466362045">2019-02-22 11:11</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-02-22_1111" title="Permanent link">&para;</a></h4>
<p>No news are good news.</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2025 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2018-10-27.1942.issue.closed.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/rear/rear-user-guide" class="fa fa-code-fork" style="color: #fcfcfc"> rear/rear-user-guide</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
