<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#2909 PR merged: Inform the user when it could not umount something - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#2909 PR merged: Inform the user when it could not umount something";
        var mkdocs_page_input_path = "issues/2023-01-10.2909.pr.merged.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#2909 PR merged: Inform the user when it could not umount something</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="2909_pr_merged_inform_the_user_when_it_could_not_umount_something"><a href="https://github.com/rear/rear/pull/2909">#2909 PR</a> <code>merged</code>: Inform the user when it could not umount something<a class="headerlink" href="#2909_pr_merged_inform_the_user_when_it_could_not_umount_something" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>enhancement</code>, <code>fixed / solved / done</code></p>
<h4 id="jsmeix_opened_issue_at_2023-01-10_1148"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> opened issue at <a href="https://github.com/rear/rear/pull/2909">2023-01-10 11:48</a>:<a class="headerlink" href="#jsmeix_opened_issue_at_2023-01-10_1148" title="Permanent link">&para;</a></h4>
<ul>
<li>
<p>Type: <strong>Enhancement</strong></p>
</li>
<li>
<p>Impact: <strong>Normal</strong></p>
</li>
<li>
<p>Reference to related issue (URL):<br />
<a href="https://github.com/rear/rear/issues/2908">https://github.com/rear/rear/issues/2908</a></p>
</li>
<li>
<p>How was this pull request tested?<br />
    Not tested by me.</p>
</li>
<li>
<p>Brief description of the changes in this pull request:</p>
</li>
</ul>
<p>In output/ISO/Linux-i386/700_create_efibootimg.sh<br />
make umounting the EFI virtual image more fail-safe:<br />
In any case 'sleep 1' after 'cp' before normal 'umount'<br />
and if this fails try 'umount --lazy' and if that also fails<br />
show the user a LogPrintError (and proceed bona fide)<br />
so the user can understand why later at the end<br />
cleanup_build_area_and_end_program() may show</p>
<pre><code>Could not remove build area
</code></pre>
<p>when lazy umount could not clean up things until then.</p>
<p>In restore/NETFS/default/400_restore_backup.sh and<br />
same also in restore/YUM/default/410_restore_backup.sh<br />
it calls <code>umount "$BUILD_DIR/outputfs"</code><br />
because BUILD_DIR/outputfs is needed as mountpoint<br />
to mount something (a medium that contains the backup)<br />
so inform the user about an umounting failure<br />
(if there was something mounted at BUILD_DIR/outputfs)<br />
so he can understand why the subsequent mounting fails<br />
or why several things got mounted stacked one over the other.</p>
<h4 id="jsmeix_commented_at_2023-01-12_1356"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2909#issuecomment-1380392192">2023-01-12 13:56</a>:<a class="headerlink" href="#jsmeix_commented_at_2023-01-12_1356" title="Permanent link">&para;</a></h4>
<p>Primarily for my own information<br />
here some links about 'umount --lazy' and related things:</p>
<p><a href="https://superuser.com/questions/412109/lazy-umount-or-unmounting-a-busy-disk-in-linux">https://superuser.com/questions/412109/lazy-umount-or-unmounting-a-busy-disk-in-linux</a></p>
<p><a href="https://stackoverflow.com/questions/7878707/how-to-unmount-a-busy-device">https://stackoverflow.com/questions/7878707/how-to-unmount-a-busy-device</a></p>
<p><a href="https://serverfault.com/questions/1101277/how-does-a-lazy-unmount-actually-work">https://serverfault.com/questions/1101277/how-does-a-lazy-unmount-actually-work</a></p>
<p><a href="https://unix.stackexchange.com/questions/385645/how-do-i-know-when-lazy-umount-l-completes">https://unix.stackexchange.com/questions/385645/how-do-i-know-when-lazy-umount-l-completes</a></p>
<p><a href="https://www.unix.com/linux/119194-umount-l-dangerous.html">https://www.unix.com/linux/119194-umount-l-dangerous.html</a></p>
<p><a href="https://unix.stackexchange.com/questions/111779/how-to-find-out-easily-whether-a-block-device-or-a-part-of-it-is-mounted-someh">https://unix.stackexchange.com/questions/111779/how-to-find-out-easily-whether-a-block-device-or-a-part-of-it-is-mounted-someh</a></p>
<h4 id="jsmeix_commented_at_2023-01-12_1416"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2909#issuecomment-1380419767">2023-01-12 14:16</a>:<a class="headerlink" href="#jsmeix_commented_at_2023-01-12_1416" title="Permanent link">&para;</a></h4>
<p>@pcahyna<br />
in my current change here for<br />
output/ISO/Linux-i386/700_create_efibootimg.sh<br />
I call only plain 'umount --lazy' without additional '--force'<br />
so I cannot use the <code>umount_mountpoint_lazy</code> function here<br />
because that calls <code>umount $v -f -l $mountpoint</code>.</p>
<p>I do not like '--lazy' with additional '--force'<br />
because "man umount" tells:</p>
<pre><code>-f, --force
Force an unmount (in case of an unreachable NFS system).
Note that this option does not guarantee that umount command does not hang.
</code></pre>
<p>As usual the description is rather terse and does not explain things<br />
so one has to imagine what could be meant.</p>
<p>Currently I understand this as if '--force' may hang up<br />
because in general to enforce something one must try hard<br />
to get that something done which means "don't give up"<br />
but "try hard endlessly" so it may never finish.</p>
<p>In contrast '--lazy' has opposite meaning<br />
so 'umount --lazy' basically always returns and<br />
lets things clean up on its own in the background,<br />
e.g. see<br />
<a href="https://serverfault.com/questions/1101277/how-does-a-lazy-unmount-actually-work">https://serverfault.com/questions/1101277/how-does-a-lazy-unmount-actually-work</a><br />
that reads (excerpt):</p>
<pre><code>Lazy umount is a regular umount, which happens in background.
In addition is hides the mount entry, which makes it looks
like umount have worked (or Detach the filesystem from
the file hierarchy, how man page says). In really the
unmount will happen when filesystem is not in use anymore.

Thus, for a real umount one should use --force and wait ...
</code></pre>
<p>So I think '--lazy' and '--force' contradict each other.</p>
<p>Or what do I misunderstand here?</p>
<h4 id="pcahyna_commented_at_2023-01-12_1423"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/2909#issuecomment-1380429424">2023-01-12 14:23</a>:<a class="headerlink" href="#pcahyna_commented_at_2023-01-12_1423" title="Permanent link">&para;</a></h4>
<p>@jsmeix I am not sure myself. The impression I get from the manual page
is that the main motivation for umount options is the case of NFS mount
where the server became unreachable. I am not even sure whether <code>-f</code>
does anything useful in the case of local filesystems.</p>
<h4 id="schlomo_commented_at_2023-02-13_2006"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/2909#issuecomment-1428604658">2023-02-13 20:06</a>:<a class="headerlink" href="#schlomo_commented_at_2023-02-13_2006" title="Permanent link">&para;</a></h4>
<p>We still do <code>umount ... || LogPrintError ...</code> so that <code>rear</code> will
happily continue even in case of an <code>umount</code> error.</p>
<p>I'm wondering if we maybe should be more strict and actually
<code>StopIfError</code> to avoid follow-up problems like reported by @thomas-merz
originally? That way he would have noticed the problem via a direct
error message from ReaR instead of via some other monitoring noticing
lots of new filesystems...</p>
<p>Also, maybe the discussed <code>sleep 1</code> would also be a good solution
instead of a cascae of <code>umount</code> attempts?</p>
<p>I find the <code>fuser</code> really useful in case of umount troubles, great idea!</p>
<p>And finally, maybe <code>umount</code> should be converted into a ReaR function to
always have that error handling attached to it?</p>
<h4 id="jsmeix_commented_at_2023-02-14_1059"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2909#issuecomment-1429530985">2023-02-14 10:59</a>:<a class="headerlink" href="#jsmeix_commented_at_2023-02-14_1059" title="Permanent link">&para;</a></h4>
<p>It is my goal behind to get in the end a<br />
sufficiently simple and reliably working<br />
umounting function in ReaR.</p>
<p>But this will take some time in particular<br />
to get sufficient experience how things behave<br />
for real users out there on their systems.</p>
<p>What "just works" for us on our clean test systems<br />
may terribly fail for users on problematic systems.</p>
<p>E.g. see
<a href="https://github.com/rear/rear/issues/2908">https://github.com/rear/rear/issues/2908</a><br />
As far as I can remember we never had an issue<br />
like that with plain and simple 'umount' before.</p>
<p>E.g. see my comment in this pull request code<br />
how 'fuser' must be called to avoid possibly<br />
scaring and misleading output in certain cases.</p>
<p>Bottom line:<br />
RFC 1925 item (8) It is more complicated than you think.</p>
<p>That one should even better read:<br />
In practice it is more complicated than one imagines in theory.</p>
<h4 id="jsmeix_commented_at_2023-03-20_1232"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2909#issuecomment-1476143234">2023-03-20 12:32</a>:<a class="headerlink" href="#jsmeix_commented_at_2023-03-20_1232" title="Permanent link">&para;</a></h4>
<p>@rear/contributors<br />
I would like to merge it tomorrow afternoon<br />
unless there are objections.</p>
<p>This is only a first step towards a (hopefully) sufficiently<br />
simple and reliably working umounting function in ReaR, cf.<br />
<a href="https://github.com/rear/rear/pull/2909#issuecomment-1429530985">https://github.com/rear/rear/pull/2909#issuecomment-1429530985</a></p>
<h4 id="pcahyna_commented_at_2023-03-21_1600"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/2909#issuecomment-1478107065">2023-03-21 16:00</a>:<a class="headerlink" href="#pcahyna_commented_at_2023-03-21_1600" title="Permanent link">&para;</a></h4>
<p>jsmeix with the addition of <code>sleep</code> it helps with #2908, right?</p>
<h4 id="jsmeix_commented_at_2023-03-22_1212"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2909#issuecomment-1479468465">2023-03-22 12:12</a>:<a class="headerlink" href="#jsmeix_commented_at_2023-03-22_1212" title="Permanent link">&para;</a></h4>
<p>Yes, the "sleep 1 and retry" helps in particular with<br />
issues like
<a href="https://github.com/rear/rear/issues/2908">https://github.com/rear/rear/issues/2908</a><br />
but in general I prefer to try simple things first,<br />
see my new comments via my recent<br />
<a href="https://github.com/rear/rear/pull/2909/commits/d6559072f4bc64c5ba18ff2fdd03b410ad340ace">https://github.com/rear/rear/pull/2909/commits/d6559072f4bc64c5ba18ff2fdd03b410ad340ace</a></p>
<p>When normal umount works after simple 'sleep 1'<br />
it avoids in particular possible issues with 'fuser -M'<br />
on older Linux distributions that do not support '-M'.</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2024 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2023-01-10.2909.pr.merged.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
