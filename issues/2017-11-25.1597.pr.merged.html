<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#1597 PR merged: Trigger udev to reload changed rules (and 1s sleep time as final fallback) - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#1597 PR merged: Trigger udev to reload changed rules (and 1s sleep time as final fallback)";
        var mkdocs_page_input_path = "issues/2017-11-25.1597.pr.merged.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/backup_netfs.html">Example of BACKUP=NETFS</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear28.html">Release Notes ReaR 2.8</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#1597 PR merged: Trigger udev to reload changed rules (and 1s sleep time as final fallback)</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="1597_pr_merged_trigger_udev_to_reload_changed_rules_and_1s_sleep_time_as_final_fallback"><a href="https://github.com/rear/rear/pull/1597">#1597 PR</a> <code>merged</code>: Trigger udev to reload changed rules (and 1s sleep time as final fallback)<a class="headerlink" href="#1597_pr_merged_trigger_udev_to_reload_changed_rules_and_1s_sleep_time_as_final_fallback" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>enhancement</code>, <code>fixed / solved / done</code>, <code>minor bug</code></p>
<h4 id="schabrolles_opened_issue_at_2017-11-25_1713"><img src="https://avatars.githubusercontent.com/u/19491077?u=0021b16ab426902cbe676f6831f41607bbe4d441&v=4" width="50"><a href="https://github.com/schabrolles">schabrolles</a> opened issue at <a href="https://github.com/rear/rear/pull/1597">2017-11-25 17:13</a>:<a class="headerlink" href="#schabrolles_opened_issue_at_2017-11-25_1713" title="Permanent link">&para;</a></h4>
<p>Without the 1s sleep time, I got the following error
<code>Cannot find device "eth0"</code> during a network migration (sles12sp2).</p>
<pre><code>Running 55-migrate-network-devices.sh...
The only original network interface eth0 00:1a:4a:16:01:cc is not available
and no mapping is specified in /etc/rear/mappings/mac
Mapping it to the only available eth1 1a:f4:ea:94:64:0c
Reloading udev ... done.
Running 58-start-dhclient.sh...
Running 60-network-devices.sh...
Cannot find device "eth0"
Cannot find device "eth0"
Cannot find device "eth0"
Running 62-routing.sh...
Cannot find device "eth0"
Running 63-teaming.sh...
Running 65-sysctl.sh...
Running 67-check-by-label-cdrom.sh...
Running 99-makedev.sh...
</code></pre>
<p>This is solve by adding a 1s delay before triggering udev.</p>
<h4 id="jsmeix_commented_at_2017-11-25_2037"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1597#issuecomment-346964598">2017-11-25 20:37</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-11-25_2037" title="Permanent link">&para;</a></h4>
<p>Only FYI:<br />
In general think triggering udev should usually not be needed, cf.<br />
<a href="https://github.com/rear/rear/issues/791">https://github.com/rear/rear/issues/791</a><br />
but I am not a udev expert to make a decision here.<br />
Perhaps all what is actually needed is the "sleep 1"<br />
to enforce waiting a bit until udev had done its stuff (hopefully).<br />
Perhaps the real solution would be to wait for the particular<br />
network interface to actually appear?</p>
<h4 id="jsmeix_commented_at_2017-11-25_2059"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1597#issuecomment-346965836">2017-11-25 20:59</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-11-25_2059" title="Permanent link">&para;</a></h4>
<p>@schabrolles<br />
as always with udev issues I do not understand what actually goes on.<br />
Can you perhaps describe how it happens that you get a</p>
<pre>
Cannot find device "eth0"
</pre>

<p>error message when ReaR had reported</p>
<pre>
The only original network interface eth0 00:1a:4a:16:01:cc is not available
...
Mapping it to the only available eth1 1a:f4:ea:94:64:0c
</pre>

<p>so that after ReaR had applied the mapping in
55-migrate-network-devices.sh<br />
I would understand that a</p>
<pre>
Cannot find device "eth1"
</pre>

<p>error message can happen as long as udev had not finished<br />
but I do not understand an error message about "eth0" which<br />
does not exist according to what ReaR reported.</p>
<h4 id="schabrolles_commented_at_2017-11-26_0912"><img src="https://avatars.githubusercontent.com/u/19491077?u=0021b16ab426902cbe676f6831f41607bbe4d441&v=4" width="50"><a href="https://github.com/schabrolles">schabrolles</a> commented at <a href="https://github.com/rear/rear/pull/1597#issuecomment-346994432">2017-11-26 09:12</a>:<a class="headerlink" href="#schabrolles_commented_at_2017-11-26_0912" title="Permanent link">&para;</a></h4>
<p>@jsmeix, Let me give you more details about the issue I got.</p>
<ul>
<li><strong>Scenario:</strong> Migration from <strong>system-A</strong> to <strong>system-B</strong></li>
<li><strong>system-A</strong> has 1 network interface <strong>eth0</strong> with mac address
    <code>MAC-A</code> and IP set to <code>IP-A</code> in <code>ifcfg-eth0</code> and
    <code>60-network-devices.sh</code> (when booting in rescue image).</li>
<li>When I boot <strong>system-B</strong> the rescue image generated from
    <strong>system-A</strong>, a new interface <strong>eth1</strong> is discovered (in sles12,
    udev rules file already contains <code>MAC-A</code> which is related to the
    <strong>eth0</strong> device name).</li>
<li>during the rescue-image boot phase, the script
    <code>55-migrate-network-devices.sh</code> is suppose to modify the udev rule
    file to replace <code>MAC-A</code> to <code>MAC-B</code> (eth1 MAC address). That's why
    you got the message:</li>
</ul>
<!-- -->

<pre><code>Mapping it to the only available eth1 1a:f4:ea:94:64:0c
</code></pre>
<p>=&gt; <code>MAC-B</code> should be re-named <strong>eth0</strong> after udev trigger (which is
by the way done by <code>55-migrate-network-devices.sh</code>)<br />
This was perfectly working before commit dd0c711. But now I got:</p>
<pre><code>Running 60-network-devices.sh...
Cannot find device "eth0"
Cannot find device "eth0"
Cannot find device "eth0"
</code></pre>
<ul>
<li><code>60-network-devices.sh</code> contains information about <strong>eth0</strong>, but
    <strong>eth0</strong> is not there. it is still <strong>eth1</strong>.<br />
    That is why I got <code>cannot find device eth0</code>.</li>
<li>Because it is still <strong>eth1</strong> when the system is completely booted,
    this mean adding sleep time after udev triger would not help. (so it
    is not related to #791).</li>
<li>It works before dd0c711, and this commit add the automatic renaming
    of interface when only one is available (which is a good feature).
    Udev rule file is well updated with <code>MAC-B</code> instead of <code>MAC-A</code>... so
    it is definitely related to udev trigger. If I force udev trigger
    again (when loggin into the rescue image) <strong>eth1</strong> is well renamed
    in <strong>eth0</strong>.</li>
<li>Previously (before dd0c711), the user add to select the interface
    from the prompt which add a bit of delay somewhere.<br />
    (It is also working if I add the delay at the end of the
    modification made in dd0c711:</li>
</ul>
<!-- -->

<pre><code>[...]
   if test ${#ORIGINAL_MACS[@]} -eq 1 -a ${#NEW_DEVICES[@]} -eq 1 ; then
        index=0
        old_dev=${ORIGINAL_DEVICES[$index]}
        old_mac=${ORIGINAL_MACS[$index]}
        choice="${NEW_DEVICES[$index]}"
        # Split choice="dev mac driver" into words:
        dev_mac_driver=( $choice )
        new_dev=${dev_mac_driver[0]}
        new_mac=${dev_mac_driver[1]}
        # Output the old_mac-&gt;new_mac mapping for later use below:
        echo "$old_mac $new_mac $old_dev" &gt;&gt;$MAC_MAPPING_FILE
        # Get new device name from current MAC address:
        new_dev=$( get_device_by_hwaddr "$new_mac" )
        # Tell the user about the automated mapping (and how he could avoid it):
        echo "The only original network interface $old_dev $old_mac is not available"
        echo "and no mapping is specified in $MAC_MAPPING_FILE"
        echo "Mapping it to the only available $new_dev $new_mac"
        sleep 1
    else
[...]
</code></pre>
<p>Sorry, I don't have the real cause, so I can't propose the perfect
solution here. That's why I'm sharing my findings here. May be you will
have a better solution.</p>
<h4 id="schabrolles_commented_at_2017-11-26_1409"><img src="https://avatars.githubusercontent.com/u/19491077?u=0021b16ab426902cbe676f6831f41607bbe4d441&v=4" width="50"><a href="https://github.com/schabrolles">schabrolles</a> commented at <a href="https://github.com/rear/rear/pull/1597#issuecomment-347011094">2017-11-26 14:09</a>:<a class="headerlink" href="#schabrolles_commented_at_2017-11-26_1409" title="Permanent link">&para;</a></h4>
<p>@jsmeix I change the <code>sleep 1</code> with <code>udevadm control --reload-rules</code><br />
This command forces udev to reload rules files. As the file was just
modify to change MAC address, Forcing reload the files looks a good idea
before a <code>udev trigger</code>.<br />
I does the job for SLES12 sp2.</p>
<h4 id="jsmeix_commented_at_2017-11-27_1056"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1597#issuecomment-347147735">2017-11-27 10:56</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-11-27_1056" title="Permanent link">&para;</a></h4>
<p>@schabrolles<br />
many thanks for your great explanation.<br />
I fully agree with the current fix (i.e. udevadm control
--reload-rules)<br />
because now it really looks like the right solution.<br />
I guess the delay helps by chance because - as far as I vaguely<br />
remember - udev watches its rules files for changes (via inotify<br />
or something like this if I remember correctly) and that may need<br />
a bit of time so that a "slelep 1" delay helps (usually).</p>
<p>Regarding the udevadm control command syntax:<br />
On my SLE11 system "man udevadm" reads (excerpts):</p>
<pre>
  udevadm control
    ...
    --reload-rules
    Signal udevd to reload the rules files.
    The udev daemon detects changes automatically,
    this option is usually not needed. Reloading rules
    does not apply any changes to already existing devices.
</pre>

<p>while in contrast<br />
on my SLE12 system "man udevadm" reads (excerpts):</p>
<pre>
  udevadm control
    ...
    -R, --reload
    Signal systemd-udevd to reload the rules files
    and other databases like the kernel module index.
    Reloading rules and databases does not apply
    any changes to already existing devices; the new
    configuration will only be applied to new events.
</pre>

<p>but is seems "udevadm control --reload-rules"<br />
works backward compatible on my SLE12 system:</p>
<pre>
# udevadm control --reload-rules && echo ok
ok
</pre>

<p>so that we can assume (at least for now) that<br />
"udevadm control --reload-rules"<br />
should be the right way.</p>
<p>@schabrolles<br />
just merge it so that the automated tests of @gdha are run.</p>
<h4 id="schabrolles_commented_at_2017-11-27_1144"><img src="https://avatars.githubusercontent.com/u/19491077?u=0021b16ab426902cbe676f6831f41607bbe4d441&v=4" width="50"><a href="https://github.com/schabrolles">schabrolles</a> commented at <a href="https://github.com/rear/rear/pull/1597#issuecomment-347158444">2017-11-27 11:44</a>:<a class="headerlink" href="#schabrolles_commented_at_2017-11-27_1144" title="Permanent link">&para;</a></h4>
<p>@jsmeix what about using :<br />
« udevadm control —reload-rules || udevadm control —reload || sleep
1 ».<br />
Just to be safe... what do you think ?</p>
<h4 id="jsmeix_commented_at_2017-11-27_1158"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1597#issuecomment-347161323">2017-11-27 11:58</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-11-27_1158" title="Permanent link">&para;</a></h4>
<p>Absolutely perfect for me!<br />
But please add a comment why that two fallbacks are there,<br />
cf. "Dirty hacks welcome" in<br />
<a href="https://github.com/rear/rear/wiki/Coding-Style">https://github.com/rear/rear/wiki/Coding-Style</a></p>
<p>FYI<br />
why I still think it is a "dirty hack" that is same as<br />
<a href="https://github.com/rear/rear/issues/791">https://github.com/rear/rear/issues/791</a></p>
<p>I think the real solution could be to<br />
replace in 55-migrate-network-devices.sh<br />
the whole "Reload udev if we have MAC mappings" part with a<br />
"wait for the expected new network interfaces to appear"<br />
and just let udev do its stuff without interfering with udev.</p>
<p>The latter requires we know what new network interfaces<br />
to wait for, cf. my "TODO" in 55-migrate-network-devices.sh<br />
about "$old_mac $new_mac $old_dev $new_dev".</p>
<p>With that we could wait for each $new_dev to appear.</p>
<p>Then we could even show meaningful information to the user<br />
when one does not appear after a reasonable timeout,<br />
perhaps together with a subsequent user dialog where<br />
he could set up missing network interfaces manually.</p>
<p>But that would be definitely something for a future ReaR<br />
release (if at all).</p>
<h4 id="jsmeix_commented_at_2017-11-27_1229"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1597#issuecomment-347167870">2017-11-27 12:29</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-11-27_1229" title="Permanent link">&para;</a></h4>
<p>@schabrolles<br />
as always many thanks for your testing!<br />
It helps so much because it reveals shortcomings in the code.<br />
It seems on my KVM/QEMU virtual machines udev works<br />
too fast to let such issues show up.</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2024 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2017-11-25.1597.pr.merged.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/rear/rear-user-guide" class="fa fa-code-fork" style="color: #fcfcfc"> rear/rear-user-guide</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
