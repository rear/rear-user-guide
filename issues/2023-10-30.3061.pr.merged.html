<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#3061 PR merged: Save LVM pool metadata volume size in disk layout - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#3061 PR merged: Save LVM pool metadata volume size in disk layout";
        var mkdocs_page_input_path = "issues/2023-10-30.3061.pr.merged.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#3061 PR merged: Save LVM pool metadata volume size in disk layout</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="3061_pr_merged_save_lvm_pool_metadata_volume_size_in_disk_layout"><a href="https://github.com/rear/rear/pull/3061">#3061 PR</a> <code>merged</code>: Save LVM pool metadata volume size in disk layout<a class="headerlink" href="#3061_pr_merged_save_lvm_pool_metadata_volume_size_in_disk_layout" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>enhancement</code>, <code>bug</code>, <code>fixed / solved / done</code></p>
<h4 id="pcahyna_opened_issue_at_2023-10-30_1742"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> opened issue at <a href="https://github.com/rear/rear/pull/3061">2023-10-30 17:42</a>:<a class="headerlink" href="#pcahyna_opened_issue_at_2023-10-30_1742" title="Permanent link">&para;</a></h4>
<h5 id="pull_request_details">Pull Request Details:<a class="headerlink" href="#pull_request_details" title="Permanent link">&para;</a></h5>
<ul>
<li>
<p>Type: <strong>Bug Fix</strong></p>
</li>
<li>
<p>Impact: <strong>Normal</strong></p>
</li>
<li>
<p>Reference to related issue (URL):</p>
</li>
<li>
<p>How was this pull request tested?</p>
<ul>
<li>Installed RHEL 9 system to a thin pool</li>
<li>Extended the thin pool to another disk, while artificially
    keeping its metadata volume size unchanged, and using 100% of
    the VG (no free space in the VG left).</li>
<li>Backed up and recovered</li>
</ul>
</li>
</ul>
<p>With ReaR version before this change, recovery fails with:</p>
<pre><code>+++ lvm lvcreate -y -L 1073741824b -n swap rhel_kvm-08-guest06
  Volume group "rhel_kvm-08-guest06" has insufficient free space (250 extents): 256 required.
</code></pre>
<p>swap is not part of the thin pool and is created after the thin pool.
Without the change, the thin pool consumes too much space in the VG due
to the metadata volume being too large, and there is not enough space
for the swap volume, leading to the error above. With this change the
recovery is successful.</p>
<ul>
<li>Description of the changes in this pull request:</li>
</ul>
<p>Instead of letting LVM use the default pool metadata volume size when
restoring a layout with thin pools, use the size from the original
system. The pool metadata size will be saved in disklayout.conf as the
new key "poolmetadatasize" on the thin pool LV.</p>
<p>This makes the layout of the recovered system closer to the original
system.</p>
<p>Prevents some cases of recovery failures during layout restoration: if
the original system used a non-default (in particular, smaller) metadata
volume size, and the space in the VG was fully used, there would not be
enough space in the VG for recovery of all LVs (as layout restoration
would create a larger pool metadata size than before and if restoring to
disks of the same size, the space will be missing elsewhere).</p>
<h4 id="jsmeix_commented_at_2023-10-31_0905"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/3061#issuecomment-1786791418">2023-10-31 09:05</a>:<a class="headerlink" href="#jsmeix_commented_at_2023-10-31_0905" title="Permanent link">&para;</a></h4>
<p>Because the code already contains</p>
<pre><code># Check for 'lvs' support of the 'lv_layout' field:
</code></pre>
<p>I wonder if the here new added <code>lv_metadata_size</code> field<br />
is always supported in practice - i.e. if it is also supported<br />
for reasonably older Linux distributions (older than RHEL 9)?</p>
<h4 id="jsmeix_commented_at_2023-10-31_0930"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/3061#issuecomment-1786834370">2023-10-31 09:30</a>:<a class="headerlink" href="#jsmeix_commented_at_2023-10-31_0930" title="Permanent link">&para;</a></h4>
<p>Here a general overview which fields are supported<br />
with older LVM versions:</p>
<p>I test with</p>
<pre><code># lvs_fields="origin,lv_name,vg_name,lv_size,lv_layout,pool_lv,chunk_size,stripes,stripe_size,seg_size,lv_metadata_size"

# lvs --separator=':' --noheadings --units b --nosuffix -o $lvs_fields 2&gt;&amp;1 | grep "Unrecognised field"
</code></pre>
<p>and reduce step by step lvs_fields by what is reported as "Unrecognised
field".</p>
<p>On SLES10 SP4<br />
with lvm2-2.02.17<br />
those fields are supported<br />
origin,lv_name,vg_name,lv_size,chunk_size,stripes,stripe_size,seg_size<br />
i.e. those fields are not supported<br />
lv_layout<br />
pool_lv<br />
lv_metadata_size</p>
<pre><code># lvs_fields="origin,lv_name,vg_name,lv_size,chunk_size,stripes,stripe_size,seg_size"

# lvs --separator=':' --noheadings --units b --nosuffix -o $lvs_fields &amp;&amp; echo OK
  No volume groups found
OK
</code></pre>
<p>ReaR would fail on SLE10.</p>
<p>On SLES11 SP3<br />
with lvm2-2.02.98<br />
those fields are supported<br />
origin,lv_name,vg_name,lv_size,pool_lv,chunk_size,stripes,stripe_size,seg_size,lv_metadata_size<br />
i.e. only one field is not supported<br />
lv_layout</p>
<pre><code># lvs_fields="origin,lv_name,vg_name,lv_size,pool_lv,chunk_size,stripes,stripe_size,seg_size,lv_metadata_size"

# lvs --separator=':' --noheadings --units b --nosuffix -o $lvs_fields &amp;&amp; echo OK
  No volume groups found
OK
</code></pre>
<p>ReaR should still work on SLE11.</p>
<p>On SLES12 SP5<br />
with lvm2-2.02.180<br />
all those fields<br />
origin,lv_name,vg_name,lv_size,lv_layout,pool_lv,chunk_size,stripes,stripe_size,seg_size,lv_metadata_size<br />
are supported<br />
so ReaR should work on SLE12 and later.</p>
<p>Summary:</p>
<p>I do not care about SLE10.<br />
ReaR on SLE10 was never officially supported by SUSE.</p>
<p>I do no longer care about SLE11.<br />
ReaR on SLE11 was officially supported by SUSE.<br />
Meanwhile SLE11 is out of official SUSE support, see<br />
<a href="https://www.suse.com/lifecycle/#product-suse-linux-enterprise-high-availability-extension">https://www.suse.com/lifecycle/#product-suse-linux-enterprise-high-availability-extension</a></p>
<pre><code>SUSE Linux Enterprise High Availability Extension 11
General Support Ends    31 Mar 2019
LTSS Ends               31 Mar 2022
</code></pre>
<p>But in this case ReaR should even still work on SLE11.</p>
<h4 id="pcahyna_commented_at_2023-10-31_1003"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/3061#issuecomment-1786892789">2023-10-31 10:03</a>:<a class="headerlink" href="#pcahyna_commented_at_2023-10-31_1003" title="Permanent link">&para;</a></h4>
<p>@jsmeix I tested that as well, lv_metadata_size (and lv_layout) is
supported even on RHEL 6.</p>
<p>Given that</p>
<blockquote>
<p>On SLES12 SP5<br />
with lvm2-2.02.180<br />
all those fields<br />
origin,lv_name,vg_name,lv_size,lv_layout,pool_lv,chunk_size,stripes,stripe_size,seg_size,lv_metadata_size<br />
are supported</p>
</blockquote>
<p>and</p>
<blockquote>
<p>I do no longer care about SLE11.</p>
</blockquote>
<p>I propose to remove the whole lv_layout_supported=no branch, which
would simplify the code a bit.</p>
<h4 id="pcahyna_commented_at_2023-10-31_1022"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/3061#issuecomment-1786925686">2023-10-31 10:22</a>:<a class="headerlink" href="#pcahyna_commented_at_2023-10-31_1022" title="Permanent link">&para;</a></h4>
<blockquote>
<p>LGTM.</p>
<p>Reading the code again (really not trivial), I realized - probably
again - that those "LV Pairs" are actually command line arguments to
<a href="https://linux.die.net/man/8/lvcreate">lvcreate</a> and that ReaR sort of
relies on that implicitly.</p>
<p>Maybe worth explaining this context somewhere.</p>
</blockquote>
<p>@schlomo Good point! It also took me a while to realize that I can not
give the key any name that I want, unless I want to implement a special
case in 110_include_lvm_code.sh . Please have a look at my last
commit.</p>
<h4 id="jsmeix_commented_at_2023-10-31_1319"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/3061#issuecomment-1787205445">2023-10-31 13:19</a>:<a class="headerlink" href="#jsmeix_commented_at_2023-10-31_1319" title="Permanent link">&para;</a></h4>
<p>@pcahyna<br />
feel free to remove all what belongs to "lv_layout_supported".</p>
<p>By the way:<br />
I noticed an outdated comment and an outdated message<br />
at another code place:<br />
Meanwhile, cf.<br />
<a href="https://github.com/rear/rear/commit/29e739ae7c0651f8f77c60846bfbe2b6c91baa29">https://github.com/rear/rear/commit/29e739ae7c0651f8f77c60846bfbe2b6c91baa29</a><br />
<a href="https://github.com/rear/rear/pull/2903">https://github.com/rear/rear/pull/2903</a><br />
the code calls <code>lvm pvdisplay -C --separator '|' ...</code><br />
but later there still is <code>lvm pvdisplay -c</code></p>
<pre><code>    # Check the exit code of "lvm pvdisplay -c"
    # in the "lvm pvdisplay -c | while read line ; do ... done" pipe:
    pvdisplay_exit_code=${PIPESTATUS[0]}
    test $pvdisplay_exit_code -eq 0 || Error "LVM command 'lvm pvdisplay -c' failed with exit code $pvdisplay_exit_code"
</code></pre>
<p>which should be updated to something like</p>
<pre><code>    # Check the exit code of "lvm pvdisplay -C ..."
    # in the "lvm pvdisplay -C ... | while read line ; do ... done" pipe:
    pvdisplay_exit_code=${PIPESTATUS[0]}
    test $pvdisplay_exit_code -eq 0 || Error "LVM command 'lvm pvdisplay' failed with exit code $pvdisplay_exit_code"
</code></pre>
<h4 id="schlomo_commented_at_2023-10-31_1337"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/3061#issuecomment-1787236108">2023-10-31 13:37</a>:<a class="headerlink" href="#schlomo_commented_at_2023-10-31_1337" title="Permanent link">&para;</a></h4>
<p>I'd recommend merging this before it turns into a general overhaul of
that code area</p>
<h4 id="pcahyna_commented_at_2023-10-31_1745"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/3061#issuecomment-1787692739">2023-10-31 17:45</a>:<a class="headerlink" href="#pcahyna_commented_at_2023-10-31_1745" title="Permanent link">&para;</a></h4>
<blockquote>
<p>I noticed an outdated comment and an outdated message<br />
at another code place:</p>
</blockquote>
<p>@jsmeix thanks, fixed in the last commit (although it does not belong to
this PR that much).</p>
<h4 id="pcahyna_commented_at_2023-10-31_1747"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/3061#issuecomment-1787697002">2023-10-31 17:47</a>:<a class="headerlink" href="#pcahyna_commented_at_2023-10-31_1747" title="Permanent link">&para;</a></h4>
<blockquote>
<p>Big thanks for making ReaR solve even more challenging DR scenarios!!
This is where show the commercial tools our true value :-)</p>
</blockquote>
<p>@schlomo and the scenario is very much real. One can encounter quite
unusal setups in practice (sometimes due to creative ways of deploying
systems).</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2023 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2023-10-30.3061.pr.merged.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
