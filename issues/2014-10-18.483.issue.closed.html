<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#483 Issue closed: drbd problem - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#483 Issue closed: drbd problem";
        var mkdocs_page_input_path = "issues/2014-10-18.483.issue.closed.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/backup_netfs.html">Example of BACKUP=NETFS</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#483 Issue closed: drbd problem</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="483_issue_closed_drbd_problem"><a href="https://github.com/rear/rear/issues/483">#483 Issue</a> <code>closed</code>: drbd problem<a class="headerlink" href="#483_issue_closed_drbd_problem" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>enhancement</code>, <code>bug</code>, <code>fixed / solved / done</code></p>
<h4 id="tbsky_opened_issue_at_2014-10-18_1535"><img src="https://avatars.githubusercontent.com/u/9283275?v=4" width="50"><a href="https://github.com/tbsky">tbsky</a> opened issue at <a href="https://github.com/rear/rear/issues/483">2014-10-18 15:35</a>:<a class="headerlink" href="#tbsky_opened_issue_at_2014-10-18_1535" title="Permanent link">&para;</a></h4>
<p>hi:<br />
I use drbd on lvm at scientific linux 6.5 x86_64. drbd rpm package from
ELRepo.<br />
under linux, the same lvm logic volume can be accessed by several path.
so "/dev/rootvg/my-lv" and "/dev/mapper/rootvg-my--lv" are the same
thing. rear may confused about this when analyze the disk layout.<br />
for example, I have a drbd locate on /dev/rootvg/kvm-wiki. rear analyzed
result below:</p>
<p>disklayout.conf:</p>
<pre><code>lvmvol /dev/rootvg kvm-wiki 2048 16777216
drbd /dev/drbd9 wiki /dev/rootvg/kvm-wiki
</code></pre>
<p>diskdeps.conf:</p>
<pre><code>/dev/mapper/rootvg-kvm--wiki /dev/rootvg
/dev/drbd9 /dev/rootvg/kvm-wiki
</code></pre>
<p>disktodo.conf:</p>
<pre><code>todo /dev/mapper/rootvg-kvm--wiki lvmvol
todo /dev/drbd9 drbd
</code></pre>
<p>rear assume "/dev/drbd9" is depend on "/dev/rootvg/kvm-wik", but it only
knows about "/dev/mapper/rootvg-kvm--wiki" when re-create layout. so
"/dev/drbd9" can not satisfy dependency when doing "rear recover".</p>
<p>I can not find a simple and proper way to fix rear code. I think maybe
rear should analyze the soft links of the device, since the same problem
may happened on anything above lvm, not just drbd.</p>
<p>the workarround is to make sure drbd configuration use the correct
format that rear will use. in my case, I need to modify the drbd
configuration, use "/dev/mapper/rootvg-kvm--wiki" instead of
"/dev/rootvg/kvm-wiki". "rear recover" will then satisfied about the
dependency and re-create drbd.</p>
<p>there is one thing to note about drbd &gt;= 8.4.5, the drbd-utils are
now an independent package. so we need more tools when re-create drbd.
in my case, "drbdadm" will call "drbdadm-84" and "drbdsetup-84". so I
need to add these two programs to rear "$PROGS". or the recover will
fail.</p>
<h4 id="tbsky_commented_at_2014-10-19_0639"><img src="https://avatars.githubusercontent.com/u/9283275?v=4" width="50"><a href="https://github.com/tbsky">tbsky</a> commented at <a href="https://github.com/rear/rear/issues/483#issuecomment-59641142">2014-10-19 06:39</a>:<a class="headerlink" href="#tbsky_commented_at_2014-10-19_0639" title="Permanent link">&para;</a></h4>
<p>hi:<br />
I got more problems when dealing with drbd with rear. I am still
fighting with them. the first problem is critical. I have drbd device
"drbd1" and "drbd10", rear use code below which will can not distinguish
them so cause many problems:</p>
<pre><code>read drbd disk resource device junk &lt; &lt;(grep "^drbd $1" "$LAYOUT_FILE")
</code></pre>
<p>I find the same bug are shared by many other scripts, .like
"12_include_raid_code.sh", "16_include_luks_code.sh" and more. but
"10_include_partition_code.sh" is fine. so the bug maybe introduced
at rear later versions.</p>
<p>second and third problem logs like below:</p>
<pre><code>+++ Print 'Creating DRBD resource bot-ubuntu-12-04'
+++ test 1
+++ echo -e 'Creating DRBD resource bot-ubuntu-12-04'
+++ dd if=/dev/zero of=/dev/mapper/rootvg-kvm--bot--ubuntu--12--04 bs=1M count=20
20+0 records in
20+0 records out
20971520 bytes (21 MB) copied, 0.0918644 s, 228 MB/s
+++ sync
+++ drbdadm create-md bot-ubuntu-12-04
You want me to create a v08 style flexible-size internal meta data block.
There appears to be a v08 flexible-size internal meta data block
already in place on /dev/rootvg/kvm-bot-ubuntu-12-04 at byte offset 34359734272
NOT initializing bitmap
+++ drbdadm attach bot-ubuntu-12-04
2: Failure: (127) Device minor not allocated
additional info from kernel:
unknown minor
Command 'drbdsetup-84 attach 2 /dev/rootvg/kvm-bot-ubuntu-12-04 /dev/rootvg/kvm-bot-ubuntu-12-0
4 internal --fencing=resource-and-stonith --al-extents=3389 --disk-flushes=no --disk-barrier=no
' terminated with exit code 10
2014-10-19 19:19:11 An error occurred during layout recreation.
</code></pre>
<p>rear use "dd" to try to clean existing drbd metadata. but drbd meta is
at the end of device, not at the begining. another problem is "drbdadm
attach" failed. but I am not familiar with this command and I don't need
it, so I will not trace the problem further for now</p>
<p>first and sceond problem patch below (not including third problem
"drbdadm attach" fix):</p>
<pre><code>--- 15_include_drbd_code.sh.orig        2014-05-12 14:37:21.000000000 +0800
+++ 15_include_drbd_code.sh     2014-10-19 14:14:50.019529211 +0800
@@ -3,7 +3,7 @@
 # This requires DRBD configuration present!
 create_drbd() {
     local drbd disk resource device junk
-    read drbd disk resource device junk &lt; &lt;(grep "^drbd $1" "$LAYOUT_FILE")
+    read drbd disk resource device junk &lt; &lt;(grep "^drbd $1 " "$LAYOUT_FILE")

     cat &gt;&gt; "$LAYOUT_CODE" &lt;&lt;EOF
 if [ ! -e /proc/drbd ] ; then
@@ -13,9 +13,7 @@
 mkdir -p /var/lib/drbd

 LogPrint "Creating DRBD resource $resource"
-dd if=/dev/zero of=$device bs=1M count=20
-sync
-drbdadm create-md $resource
+drbdadm -- --force create-md $resource

 EOF
</code></pre>
<p>the biggest problem I am facing now is rear can not recognize drbd
resource which has more then one device. rear assumes every drbd
resource has only one drbd device. it seems a fundamental issue. I will
try to fxi it or rear can not be used in our environment. that would be
sad..</p>
<h4 id="tbsky_commented_at_2014-10-19_1134"><img src="https://avatars.githubusercontent.com/u/9283275?v=4" width="50"><a href="https://github.com/tbsky">tbsky</a> commented at <a href="https://github.com/rear/rear/issues/483#issuecomment-59647026">2014-10-19 11:34</a>:<a class="headerlink" href="#tbsky_commented_at_2014-10-19_1134" title="Permanent link">&para;</a></h4>
<p>hi:<br />
I have workaround the multiple volumes in one drbd resource problem.
it's not a proper fix. the drbd volumes will be "create-md" multiple
times when "rear recover". and "drbdadm primary" or "drbdadm attach" is
not happy when running multiple times with same resource. but I don't
need them so finally rear is working for me. and since "rear recover" is
not a ervery-day job, so I can live with it.<br />
I also found that in my environment it's a little hard to use
"/dev/mapper/*" for drbd configuration. so I also workaround rear code
to produce "/dev/mapper/vg-lv" layout from "/dev/vg/lv" layout.<br />
workarround code below. it's not a proper patch, just workaround for
current drbd problem.</p>
<pre><code>--- 25_drbd_layout.sh.orig      2012-02-23 23:57:55.000000000 +0800
+++ 25_drbd_layout.sh   2014-10-19 18:23:34.705786559 +0800
@@ -4,9 +4,26 @@
     Log "Saving DRBD configuration."

     for resource in $(drbdadm sh-resources) ; do
-        dev=$(drbdadm sh-dev $resource)
-        disk=$(drbdadm sh-ll-dev $resource)
+        dev=( $(drbdadm sh-dev $resource) )
+        disk=( $(drbdadm sh-ll-dev $resource) )

-        echo "drbd $dev $resource $disk" &gt;&gt; $DISKLAYOUT_FILE
+        for i in ${!dev[*]}; do
+            vol_dev=${dev[$i]}
+            vol_disk=${disk[$i]}
+
+            # map disk to rear way (/dev/mapper)
+            if drbd_dm=`readlink $vol_disk`; then
+               for dm in /dev/mapper/*; do
+                   if lvm_dm=`readlink $dm`; then
+                      if [ "$drbd_dm" = "$lvm_dm" ]; then
+                         vol_disk=$dm
+                         break
+                      fi
+                   fi
+               done
+            fi
+
+            echo "drbd $vol_dev $resource $vol_disk" &gt;&gt; $DISKLAYOUT_FILE
+        done
     done
 fi
</code></pre>
<h4 id="gdha_commented_at_2014-10-21_1145"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/issues/483#issuecomment-59915336">2014-10-21 11:45</a>:<a class="headerlink" href="#gdha_commented_at_2014-10-21_1145" title="Permanent link">&para;</a></h4>
<p>@tbsky a pull request would be nice.<br />
@jhoekx Jeroen, what is your feedback on the proposed solution?</p>
<h4 id="jhoekx_commented_at_2014-10-21_1212"><img src="https://avatars.githubusercontent.com/u/783473?v=4" width="50"><a href="https://github.com/jhoekx">jhoekx</a> commented at <a href="https://github.com/rear/rear/issues/483#issuecomment-59917815">2014-10-21 12:12</a>:<a class="headerlink" href="#jhoekx_commented_at_2014-10-21_1212" title="Permanent link">&para;</a></h4>
<p>I don't have any drbd systems running, so I can't test easily. As long
as the old functionality is not broken and this solves a problem, I'm
happy :-)</p>
<p>For translating the names, did you try the <code>get_device_name</code> function?
That one should be able to receive any kind of device name and produce
the name used everywhere in Rear.</p>
<p>I don't know why we didn't use the --force option to create-md. Do you
happend to know if it always existed? Otherwise we might have to have
the two options and enable --force inside a feature flag...</p>
<h4 id="tbsky_commented_at_2014-10-21_1742"><img src="https://avatars.githubusercontent.com/u/9283275?v=4" width="50"><a href="https://github.com/tbsky">tbsky</a> commented at <a href="https://github.com/rear/rear/issues/483#issuecomment-59967150">2014-10-21 17:42</a>:<a class="headerlink" href="#tbsky_commented_at_2014-10-21_1742" title="Permanent link">&para;</a></h4>
<p>hi jhoekx:</p>
<p>I will check "get_device_name" and see what to do this weekend.<br />
"--force" is not a create-md option, it will be passed to underlying
sub-program (drbdmeta) by create-md, so the usage is a little tricky.
you won't see that option when you "man drbdadm". you need to "man
drbdmeta" to know it. so maybe you guys missed that.</p>
<p>about the drbd version, I didn't know exactly what feature comes with
the what version. I am using latest version of drbd84, and I can take a
look at latest version of drbd83, but I am afraid I can not check other
earlier versions.</p>
<h4 id="tbsky_commented_at_2014-10-24_1556"><img src="https://avatars.githubusercontent.com/u/9283275?v=4" width="50"><a href="https://github.com/tbsky">tbsky</a> commented at <a href="https://github.com/rear/rear/issues/483#issuecomment-60407611">2014-10-24 15:56</a>:<a class="headerlink" href="#tbsky_commented_at_2014-10-24_1556" title="Permanent link">&para;</a></h4>
<p>hi jhoekx:<br />
just check the function "get_device_name". I think the idea is great,
but unfortunately that function is too simple and seems only cover two
case: cciss and dm-X. it didn't cover lvm naming like /dev/vg/lv.<br />
I am a little confused. since I think the naming scheme /dev/vg/lv is
popular, I think anything above that will be broken, not just drbd?</p>
<h4 id="tbsky_commented_at_2014-10-24_1643"><img src="https://avatars.githubusercontent.com/u/9283275?v=4" width="50"><a href="https://github.com/tbsky">tbsky</a> commented at <a href="https://github.com/rear/rear/issues/483#issuecomment-60414400">2014-10-24 16:43</a>:<a class="headerlink" href="#tbsky_commented_at_2014-10-24_1643" title="Permanent link">&para;</a></h4>
<p>hi jhoekx:<br />
I tried to use /dev/vg/lv to create filesystem and swap and put then at
/etc/fstab. but rear use other ways to detect these without fstab, so
they are fine. so far I can see only drbd is affected. but I think the
correct way should be fix get_device_name so it can handle more cases.
I will try to do that..</p>
<h4 id="tbsky_commented_at_2014-10-27_1545"><img src="https://avatars.githubusercontent.com/u/9283275?v=4" width="50"><a href="https://github.com/tbsky">tbsky</a> commented at <a href="https://github.com/rear/rear/issues/483#issuecomment-60615090">2014-10-27 15:45</a>:<a class="headerlink" href="#tbsky_commented_at_2014-10-27_1545" title="Permanent link">&para;</a></h4>
<p>hi:<br />
I fixed the code, so most of them can work correctly both under drbd 8.3
and 8.4. it can also support multiple volumes of drbd 8.4. there is one
strange issue about "drbdadm attach" which works under 8.3, but failed
under 8.4.4 and 8.4.5. I think it is a drbdadm bug. if I run "drbdadm -d
attach xxxx" under 8.4.5, it failed because it forgot to create resource
and device first. under 8.3.16 everything is ok. we can workarround this
but I don't know if it is necessary. maybe 8.4.6 will fix this bug if
report upstream.</p>
<h4 id="gdha_commented_at_2014-10-30_1510"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/issues/483#issuecomment-61108338">2014-10-30 15:10</a>:<a class="headerlink" href="#gdha_commented_at_2014-10-30_1510" title="Permanent link">&para;</a></h4>
<p>committed 3 pull requests of @tbsky<br />
waiting on feedback to see whether all issues are resolved?</p>
<h4 id="tbsky_commented_at_2014-10-30_1606"><img src="https://avatars.githubusercontent.com/u/9283275?v=4" width="50"><a href="https://github.com/tbsky">tbsky</a> commented at <a href="https://github.com/rear/rear/issues/483#issuecomment-61118642">2014-10-30 16:06</a>:<a class="headerlink" href="#tbsky_commented_at_2014-10-30_1606" title="Permanent link">&para;</a></h4>
<p>hi gdha:<br />
yes all my drbd issues are resolved, since I don't need "drbdadm
attach". I don't know what kind of situation of "drbdadm attach" will be
used. since under that state drbd can not be accessed(rear only try
attach it but not make it primary), maybe jhoekx knows better.</p>
<p>I already write drbd email list about "drbdadm attach" error under
8.4.5. but didn't get response yet. I will try to write again.</p>
<h4 id="tbsky_commented_at_2014-11-04_0604"><img src="https://avatars.githubusercontent.com/u/9283275?v=4" width="50"><a href="https://github.com/tbsky">tbsky</a> commented at <a href="https://github.com/rear/rear/issues/483#issuecomment-61597334">2014-11-04 06:04</a>:<a class="headerlink" href="#tbsky_commented_at_2014-11-04_0604" title="Permanent link">&para;</a></h4>
<p>hi:<br />
drbdadm upstream reply that 8.4 "drbdadm attach" not working is a
feature, not bug. so we need to tune the code. reply at
<a href="http://lists.linbit.com/pipermail/drbd-user/2014-November/021686.html">http://lists.linbit.com/pipermail/drbd-user/2014-November/021686.html</a><br />
I will try to test what command can make both 8.3/8.4 happy..</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2024 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2014-10-18.483.issue.closed.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/rear/rear-user-guide" class="fa fa-code-fork" style="color: #fcfcfc"> rear/rear-user-guide</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
