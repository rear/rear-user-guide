<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#2827 PR merged: Use fail-safe 'yes' pipe for "lvm lvcreate" - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#2827 PR merged: Use fail-safe \u0027yes\u0027 pipe for \"lvm lvcreate\"";
        var mkdocs_page_input_path = "issues/2022-06-22.2827.pr.merged.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/backup_netfs.html">Example of BACKUP=NETFS</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#2827 PR merged: Use fail-safe 'yes' pipe for "lvm lvcreate"</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="2827_pr_merged_use_fail-safe_yes_pipe_for_lvm_lvcreate"><a href="https://github.com/rear/rear/pull/2827">#2827 PR</a> <code>merged</code>: Use fail-safe 'yes' pipe for "lvm lvcreate"<a class="headerlink" href="#2827_pr_merged_use_fail-safe_yes_pipe_for_lvm_lvcreate" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>enhancement</code>, <code>bug</code>, <code>fixed / solved / done</code></p>
<h4 id="jsmeix_opened_issue_at_2022-06-22_1143"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> opened issue at <a href="https://github.com/rear/rear/pull/2827">2022-06-22 11:43</a>:<a class="headerlink" href="#jsmeix_opened_issue_at_2022-06-22_1143" title="Permanent link">&para;</a></h4>
<ul>
<li>
<p>Type: <strong>Bug Fix</strong></p>
</li>
<li>
<p>Impact: <strong>Normal</strong></p>
</li>
<li>
<p>Reference to related issue (URL):</p>
</li>
</ul>
<p><a href="https://github.com/rear/rear/issues/513">https://github.com/rear/rear/issues/513</a><br />
<a href="https://github.com/rear/rear/issues/2820">https://github.com/rear/rear/issues/2820</a></p>
<ul>
<li>How was this pull request tested?</li>
</ul>
<p>Works for me on SLES11 SP4 and SLES15 SP3</p>
<ul>
<li>Brief description of the changes in this pull request:</li>
</ul>
<p>In layout/prepare/GNU/Linux/110_include_lvm_code.sh<br />
pipe as many 'y' as asked for into "lvm lvcreate"</p>
<h4 id="jsmeix_commented_at_2022-06-22_1304"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2827#issuecomment-1163071755">2022-06-22 13:04</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-06-22_1304" title="Permanent link">&para;</a></h4>
<p>@pcahyna<br />
thank you for having a look!</p>
<p>I am currently fighting with testing it on SLES11<br />
...<br />
e.g. there is no 'git' in the default SLES11 repository<br />
(how was life possible at that ancient time without 'git' ? :-)</p>
<h4 id="jsmeix_commented_at_2022-06-22_1453"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2827#issuecomment-1163210490">2022-06-22 14:53</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-06-22_1453" title="Permanent link">&para;</a></h4>
<p>To test it one must be in MIGRATION_MODE during "rear recover"<br />
(e.g. via <code>export MIGRATION_MODE='true'</code> before <code>rear recover</code>)<br />
because if not in MIGRATION_MODE the code in<br />
layout/prepare/GNU/Linux/110_include_lvm_code.sh<br />
restores LVM stuff via 'vgcfgrestore'<br />
and then the traditional 'vgcreate/lvcreate' commands<br />
are not used to restores LVM stuff.</p>
<p>On SLES11 SP4:</p>
<p>Original system (with LVM that is LUKS encrypted):</p>
<pre><code># lsblk -o NAME,KNAME,FSTYPE,LABEL,SIZE,MOUNTPOINT,UUID
NAME                     KNAME FSTYPE      LABEL  SIZE MOUNTPOINT UUID
sda                      sda                       15G            
├─sda1                   sda1  ext3               156M /boot      d5e7c2fd-14cf-402c-86c7-c66a34530ae3
└─sda2                   sda2  crypto_LUKS       14.9G            70fc2b5a-d3b8-4ba9-8ff0-6f3e5d0fa4a9
  └─cr_sda2 (dm-0)       dm-0  LVM2_member       14.9G            ba31sh-fZwU-2EvK-smlc-3q3z-UxCi-X94KZc
    ├─system-root (dm-1) dm-1  ext3                10G /          9e3dd4f2-cc78-4eb3-a79e-6b3ae61ce85d
    └─system-swap (dm-2) dm-2  swap                 2G [SWAP]     85800711-afb6-406e-b7bc-97c1a4c1f88c
</code></pre>
<p>Recovery (excerpts)</p>
<pre><code>RESCUE linux-a5v5:~ # export MIGRATION_MODE='true'

RESCUE linux-a5v5:~ # rear -D recover
...
Start system layout restoration.
Disk '/dev/sda': creating 'msdos' partition table
Disk '/dev/sda': creating partition number 1 with name 'primary'
Disk '/dev/sda': creating partition number 2 with name 'primary'
Creating LUKS volume cr_sda2 on /dev/sda2
Set the password for LUKS volume cr_sda2 (for 'cryptsetup luksFormat' on /dev/sda2):
Enter LUKS passphrase: 
Enter the password for LUKS volume cr_sda2 (for 'cryptsetup luksOpen' on /dev/sda2):
Enter passphrase for /dev/sda2: 
Creating LVM PV /dev/mapper/cr_sda2
Creating LVM VG 'system' (some properties may not be preserved)
Creating LVM volume 'system/swap' (some properties may not be preserved)
Creating LVM volume 'system/root' (some properties may not be preserved)
Creating filesystem of type ext3 with mount point / on /dev/mapper/system-root.
Mounting filesystem /
Creating filesystem of type ext3 with mount point /boot on /dev/sda1.
Mounting filesystem /boot
Creating swap on /dev/mapper/system-swap
Disk layout created.
...
Backup restore program 'tar' started in subshell (PID=4306)
Restored 145 MiB [avg. 49520 KiB/sec] 
...
Restored 2667 MiB in 212 seconds [avg. 12882 KiB/sec]
Restoring finished (verify backup restore log messages in /var/lib/rear/restore/recover.backup.tar.gz.914.restore.log)
...
Running 'finalize' stage ======================
/etc/mtab: FAILED
md5sum: WARNING: 1 computed checksum did NOT match
Error: Restored files do not match the recreated system in /mnt/local
...
Recreated initrd (/sbin/mkinitrd).
Installing GRUB Legacy boot loader:
...
Finished 'recover'. The target system is mounted at '/mnt/local'.

RESCUE linux-a5v5:~ # grep -1 lvcreate /var/lib/rear/layout/diskrestore.sh

    if ! ( yes 2&gt;/dev/null || true ) | lvm lvcreate --stripes 1 -L 2147483648b -n swap system ; then
        LogPrintError "Failed to create LVM volume 'system/swap' with lvcreate --stripes 1 -L 2147483648b -n swap system"
        if ( yes 2&gt;/dev/null || true ) | lvm lvcreate --stripes 1 -l 100%FREE -n swap system ; then
            LogPrintError "Created LVM volume 'system/swap' using fallback options lvcreate --stripes 1 -l 100%FREE -n swap system"
        else
            LogPrintError "Also failed to create LVM volume 'system/swap' with lvcreate --stripes 1 -l 100%FREE -n swap system"
            # Explicit 'false' is needed to let the whole 'if then else fi' command exit with non zero exit state
--

    if ! ( yes 2&gt;/dev/null || true ) | lvm lvcreate --stripes 1 -L 10737418240b -n root system ; then
        LogPrintError "Failed to create LVM volume 'system/root' with lvcreate --stripes 1 -L 10737418240b -n root system"
        if ( yes 2&gt;/dev/null || true ) | lvm lvcreate --stripes 1 -l 100%FREE -n root system ; then
            LogPrintError "Created LVM volume 'system/root' using fallback options lvcreate --stripes 1 -l 100%FREE -n root system"
        else
            LogPrintError "Also failed to create LVM volume 'system/root' with lvcreate --stripes 1 -l 100%FREE -n root system"
            # Explicit 'false' is needed to let the whole 'if then else fi' command exit with non zero exit state

RESCUE linux-a5v5:~ # grep -3 lvcreate /var/log/rear/rear-linux-a5v5.log
2022-06-22 16:22:45.512783556 Creating LVM volume 'system/swap' (some properties may not be preserved)
+++ Print 'Creating LVM volume '\''system/swap'\'' (some properties may not be preserved)'
+++ yes
+++ lvm lvcreate --stripes 1 -L 2147483648b -n swap system
+++ true
  Logical volume "swap" created
+++ component_created /dev/mapper/system-swap lvmvol
--
2022-06-22 16:22:45.680975780 Creating LVM volume 'system/root' (some properties may not be preserved)
+++ Print 'Creating LVM volume '\''system/root'\'' (some properties may not be preserved)'
+++ yes
+++ lvm lvcreate --stripes 1 -L 10737418240b -n root system
+++ true
  Logical volume "root" created
+++ component_created /dev/mapper/system-root lvmvol

RESCUE linux-a5v5:~ # lsblk -o NAME,KNAME,FSTYPE,LABEL,SIZE,MOUNTPOINT,UUID
NAME                     KNAME FSTYPE      LABEL  SIZE MOUNTPOINT      UUID
sda                      sda                       15G                 
|-sda1                   sda1  ext3               156M /mnt/local/boot d5e7c2fd-14cf-402c-86c7-c66a34530ae3
`-sda2                   sda2  crypto_LUKS       14.9G                 d8b60a40-8163-49e0-871f-bdc45024d2d0
  `-cr_sda2 (dm-0)       dm-0  LVM2_member       14.9G                 ba31sh-fZwU-2EvK-smlc-3q3z-UxCi-X94KZc
    |-system-swap (dm-1) dm-1  swap                 2G                 85800711-afb6-406e-b7bc-97c1a4c1f88c
    `-system-root (dm-2) dm-2  ext3                10G /mnt/local      9e3dd4f2-cc78-4eb3-a79e-6b3ae61ce85d
</code></pre>
<p>The UUID of the sda2 crypto_LUKS has changed<br />
because cryptsetup 1.1.3 in SLES11 SP4<br />
does not support UUID and some other things<br />
so some manual adaptions in disklayout.conf before "rear recover"<br />
plus <code>LUKS_CRYPTSETUP_OPTIONS="--iter-time 200"</code> in local.conf<br />
(i.e. removal of the <code>--use-random</code> default option that is<br />
not supported on SLES11) were needed for LUKS recovery.<br />
But at least the changed UUID should not matter<br />
because it is not used according to</p>
<pre><code>RESCUE linux-a5v5:~ # cat /mnt/local/etc/crypttab 
cr_sda2         /dev/disk/by-id/ata-QEMU_HARDDISK_QM00001-part2 none       none

RESCUE linux-a5v5:~ # ls -l /dev/disk/by-id/ata-QEMU_HARDDISK_QM00001-part2
lrwxrwxrwx 1 root root 10 Jun 22 16:26 /dev/disk/by-id/ata-QEMU_HARDDISK_QM00001-part2 -&gt; ../../sda2
</code></pre>
<p>and at least for me the recreated system boots OK.</p>
<p>The recreated system:</p>
<pre><code># lsblk -o NAME,KNAME,FSTYPE,LABEL,SIZE,MOUNTPOINT,UUID
NAME                     KNAME FSTYPE      LABEL  SIZE MOUNTPOINT UUID
sda                      sda                       15G            
├─sda1                   sda1  ext3               156M /boot      d5e7c2fd-14cf-402c-86c7-c66a34530ae3
└─sda2                   sda2  crypto_LUKS       14.9G            d8b60a40-8163-49e0-871f-bdc45024d2d0
  └─cr_sda2 (dm-0)       dm-0  LVM2_member       14.9G            ba31sh-fZwU-2EvK-smlc-3q3z-UxCi-X94KZc
    ├─system-swap (dm-1) dm-1  swap                 2G [SWAP]     85800711-afb6-406e-b7bc-97c1a4c1f88c
    └─system-root (dm-2) dm-2  ext3                10G /          9e3dd4f2-cc78-4eb3-a79e-6b3ae61ce85d

# file /etc/mtab
/etc/mtab: ASCII text
</code></pre>
<p>Only for the fun of it:<br />
That /etc/mtab is ASCII text in SLES11<br />
causes the false alarm during "rear recover"</p>
<pre><code>/etc/mtab: FAILED
md5sum: WARNING: 1 computed checksum did NOT match
Error: Restored files do not match the recreated system in /mnt/local
</code></pre>
<p>but I don't care about such cosmetic issues on old SLES11.<br />
In contrast it proves that our new verification tests do work.</p>
<h4 id="jsmeix_commented_at_2022-06-22_1504"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2827#issuecomment-1163226568">2022-06-22 15:04</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-06-22_1504" title="Permanent link">&para;</a></h4>
<p>For tomorrow I intend to test it on SLES15.</p>
<h4 id="jsmeix_commented_at_2022-06-23_1346"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2827#issuecomment-1164428971">2022-06-23 13:46</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-06-23_1346" title="Permanent link">&para;</a></h4>
<p>Tested SLES15 SP3:</p>
<p>Original system VM:</p>
<pre><code># lsblk -ipo NAME,KNAME,PKNAME,TYPE,FSTYPE,SIZE,MOUNTPOINT,UUID
NAME                                               KNAME     PKNAME    TYPE  FSTYPE       SIZE MOUNTPOINT UUID
/dev/sda                                           /dev/sda            disk                15G            
|-/dev/sda1                                        /dev/sda1 /dev/sda  part                 8M            
`-/dev/sda2                                        /dev/sda2 /dev/sda  part  crypto_LUKS   15G            e528a556-1ae8-4c47-b76e-bff0d6daccf4
  `-/dev/mapper/cr_ata-QEMU_HARDDISK_QM00001-part2 /dev/dm-0 /dev/sda2 crypt LVM2_member   15G            0CbZRG-P7o5-uoh6-22nG-iQ8V-uv0o-41gMpL
    |-/dev/mapper/system-rootLV                    /dev/dm-1 /dev/dm-0 lvm   btrfs         12G /          1b7f1eb0-93ff-484c-abab-38ea4440f3cd
    |-/dev/mapper/system-swapLV                    /dev/dm-2 /dev/dm-0 lvm   swap           1G [SWAP]     9ba95ad9-7aac-457d-888c-8770019f1be5
    `-/dev/mapper/system-homeLV                    /dev/dm-3 /dev/dm-0 lvm   xfs            1G /home      3dfef038-fd46-4db8-88a9-37ac3a6037aa

# grep -v '^#' etc/rear/local.conf 
OUTPUT=ISO
BACKUP=NETFS
BACKUP_OPTIONS="nfsvers=3,nolock"
BACKUP_URL=nfs://192.168.122.1/nfs
REQUIRED_PROGS+=( snapper chattr )
PROGS+=( lsattr )
COPY_AS_IS+=( /usr/lib/snapper/installation-helper /etc/snapper/config-templates/default )
BACKUP_PROG_INCLUDE=( /boot/grub2/x86_64-efi /boot/grub2/i386-pc /opt /root /srv /usr/local /tmp /var )
POST_RECOVERY_SCRIPT=( 'if snapper --no-dbus -r $TARGET_FS_ROOT get-config | grep -q "^QGROUP.*[0-9]/[0-9]" ; then snapper --no-dbus -r $TARGET_FS_ROOT set-config QGROUP= ; snapper --no-dbus -r $TARGET_FS_ROOT setup-quota &amp;&amp; echo snapper setup-quota done || echo snapper setup-quota failed ; else echo snapper setup-quota not used ; fi' )
SSH_ROOT_PASSWORD='rear'
USE_DHCLIENT="yes"
FIRMWARE_FILES=( 'no' )
MODULES=( 'loaded_modules' )
PROGRESS_MODE="plain"
PROGRESS_WAIT_SECONDS="3"
LUKS_CRYPTSETUP_OPTIONS+=" --force-password"
DISKS_TO_BE_WIPED=''
</code></pre>
<p>On replacement system VM (with same virtual disk size):</p>
<pre><code>RESCUE localhost:~ # export MIGRATION_MODE='true'

RESCUE localhost:~ # rear -D recover
...
Start system layout restoration.
Disk '/dev/sda': creating 'gpt' partition table
Disk '/dev/sda': creating partition number 1 with name ''sda1''
Disk '/dev/sda': creating partition number 2 with name ''sda2''
Creating LUKS volume cr_ata-QEMU_HARDDISK_QM00001-part2 on /dev/sda2
Set the password for LUKS volume cr_ata-QEMU_HARDDISK_QM00001-part2 (for 'cryptsetup luksFormat' on /dev/sda2):
Enter passphrase for /dev/sda2: 
Enter the password for LUKS volume cr_ata-QEMU_HARDDISK_QM00001-part2 (for 'cryptsetup luksOpen' on /dev/sda2):
Enter passphrase for /dev/sda2: 
Creating LVM PV /dev/mapper/cr_ata-QEMU_HARDDISK_QM00001-part2
Creating LVM VG 'system' (some properties may not be preserved)
Creating LVM volume 'system/homeLV' (some properties may not be preserved)
Creating LVM volume 'system/swapLV' (some properties may not be preserved)
Creating LVM volume 'system/rootLV' (some properties may not be preserved)
Creating filesystem of type btrfs with mount point / on /dev/mapper/system-rootLV.
Mounting filesystem /
Running snapper/installation-helper
Creating filesystem of type xfs with mount point /home on /dev/mapper/system-homeLV.
Mounting filesystem /home
Creating swap on /dev/mapper/system-swapLV
Disk layout created.
...
Finished 'recover'. The target system is mounted at '/mnt/local'

RESCUE localhost:~ # grep -1 lvcreate /var/lib/rear/layout/diskrestore.sh

    if ! ( yes 2&gt;/dev/null || true ) | lvm lvcreate -L 1073741824b -n homeLV system ; then
        LogPrintError "Failed to create LVM volume 'system/homeLV' with lvcreate -L 1073741824b -n homeLV system"
        if ( yes 2&gt;/dev/null || true ) | lvm lvcreate -l 100%FREE -n homeLV system ; then
            LogPrintError "Created LVM volume 'system/homeLV' using fallback options lvcreate -l 100%FREE -n homeLV system"
        else
            LogPrintError "Also failed to create LVM volume 'system/homeLV' with lvcreate -l 100%FREE -n homeLV system"
            # Explicit 'false' is needed to let the whole 'if then else fi' command exit with non zero exit state
--

    if ! ( yes 2&gt;/dev/null || true ) | lvm lvcreate -L 1073741824b -n swapLV system ; then
        LogPrintError "Failed to create LVM volume 'system/swapLV' with lvcreate -L 1073741824b -n swapLV system"
        if ( yes 2&gt;/dev/null || true ) | lvm lvcreate -l 100%FREE -n swapLV system ; then
            LogPrintError "Created LVM volume 'system/swapLV' using fallback options lvcreate -l 100%FREE -n swapLV system"
        else
            LogPrintError "Also failed to create LVM volume 'system/swapLV' with lvcreate -l 100%FREE -n swapLV system"
            # Explicit 'false' is needed to let the whole 'if then else fi' command exit with non zero exit state
--

    if ! ( yes 2&gt;/dev/null || true ) | lvm lvcreate -L 12884901888b -n rootLV system ; then
        LogPrintError "Failed to create LVM volume 'system/rootLV' with lvcreate -L 12884901888b -n rootLV system"
        if ( yes 2&gt;/dev/null || true ) | lvm lvcreate -l 100%FREE -n rootLV system ; then
            LogPrintError "Created LVM volume 'system/rootLV' using fallback options lvcreate -l 100%FREE -n rootLV system"
        else
            LogPrintError "Also failed to create LVM volume 'system/rootLV' with lvcreate -l 100%FREE -n rootLV system"
            # Explicit 'false' is needed to let the whole 'if then else fi' command exit with non zero exit state

RESCUE localhost:~ # grep -3 lvcreate /var/log/rear/rear-localhost.log 
+++ echo '2022-06-23 15:36:05.613519646 Creating LVM volume '\''system/homeLV'\'' (some properties may not be preserved)'
2022-06-23 15:36:05.613519646 Creating LVM volume 'system/homeLV' (some properties may not be preserved)
+++ Print 'Creating LVM volume '\''system/homeLV'\'' (some properties may not be preserved)'
+++ lvm lvcreate -L 1073741824b -n homeLV system
+++ yes
+++ true
  Logical volume "homeLV" created.
--
+++ echo '2022-06-23 15:36:05.726581428 Creating LVM volume '\''system/swapLV'\'' (some properties may not be preserved)'
2022-06-23 15:36:05.726581428 Creating LVM volume 'system/swapLV' (some properties may not be preserved)
+++ Print 'Creating LVM volume '\''system/swapLV'\'' (some properties may not be preserved)'
+++ lvm lvcreate -L 1073741824b -n swapLV system
+++ yes
+++ true
  Logical volume "swapLV" created.
--
+++ echo '2022-06-23 15:36:05.826265780 Creating LVM volume '\''system/rootLV'\'' (some properties may not be preserved)'
2022-06-23 15:36:05.826265780 Creating LVM volume 'system/rootLV' (some properties may not be preserved)
+++ Print 'Creating LVM volume '\''system/rootLV'\'' (some properties may not be preserved)'
+++ lvm lvcreate -L 12884901888b -n rootLV system
+++ yes
+++ true
  Logical volume "rootLV" created.

RESCUE localhost:~ # lsblk -ipo NAME,KNAME,PKNAME,TYPE,FSTYPE,SIZE,MOUNTPOINT,UUID
NAME                                               KNAME     PKNAME    TYPE  FSTYPE       SIZE MOUNTPOINT      UUID
/dev/sda                                           /dev/sda            disk                15G                 
|-/dev/sda1                                        /dev/sda1 /dev/sda  part                 8M                 
`-/dev/sda2                                        /dev/sda2 /dev/sda  part  crypto_LUKS   15G                 e528a556-1ae8-4c47-b76e-bff0d6daccf4
  `-/dev/mapper/cr_ata-QEMU_HARDDISK_QM00001-part2 /dev/dm-0 /dev/sda2 crypt LVM2_member   15G                 0CbZRG-P7o5-uoh6-22nG-iQ8V-uv0o-41gMpL
    |-/dev/mapper/system-homeLV                    /dev/dm-1 /dev/dm-0 lvm   xfs            1G /mnt/local/home 3dfef038-fd46-4db8-88a9-37ac3a6037aa
    |-/dev/mapper/system-swapLV                    /dev/dm-2 /dev/dm-0 lvm   swap           1G                 9ba95ad9-7aac-457d-888c-8770019f1be5
    `-/dev/mapper/system-rootLV                    /dev/dm-3 /dev/dm-0 lvm   btrfs         12G /mnt/local      1b7f1eb0-93ff-484c-abab-38ea4440f3cd
</code></pre>
<p>The rebooted recreated system VM:</p>
<pre><code># lsblk -ipo NAME,KNAME,PKNAME,TYPE,FSTYPE,SIZE,MOUNTPOINT,UUID
NAME                                               KNAME     PKNAME    TYPE  FSTYPE       SIZE MOUNTPOINT UUID
/dev/sda                                           /dev/sda            disk                15G            
|-/dev/sda1                                        /dev/sda1 /dev/sda  part                 8M            
`-/dev/sda2                                        /dev/sda2 /dev/sda  part  crypto_LUKS   15G            e528a556-1ae8-4c47-b76e-bff0d6daccf4
  `-/dev/mapper/cr_ata-QEMU_HARDDISK_QM00001-part2 /dev/dm-0 /dev/sda2 crypt LVM2_member   15G            0CbZRG-P7o5-uoh6-22nG-iQ8V-uv0o-41gMpL
    |-/dev/mapper/system-rootLV                    /dev/dm-1 /dev/dm-0 lvm   btrfs         12G /          1b7f1eb0-93ff-484c-abab-38ea4440f3cd
    |-/dev/mapper/system-homeLV                    /dev/dm-2 /dev/dm-0 lvm   xfs            1G /home      3dfef038-fd46-4db8-88a9-37ac3a6037aa
    `-/dev/mapper/system-swapLV                    /dev/dm-3 /dev/dm-0 lvm   swap           1G [SWAP]     9ba95ad9-7aac-457d-888c-8770019f1be5
</code></pre>
<h4 id="jsmeix_commented_at_2022-06-23_1357"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2827#issuecomment-1164441547">2022-06-23 13:57</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-06-23_1357" title="Permanent link">&para;</a></h4>
<p>@rear/contributors<br />
if there are no objections<br />
I would like to merge it tomorrow afternoon.</p>
<h4 id="pcahyna_commented_at_2022-07-01_1618"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/2827#issuecomment-1172507654">2022-07-01 16:18</a>:<a class="headerlink" href="#pcahyna_commented_at_2022-07-01_1618" title="Permanent link">&para;</a></h4>
<blockquote>
<p>Looks good. I can try an actual test in several days.</p>
</blockquote>
<p>Test done. Fails, because there is no <code>yes</code> in the rescue system, and
things are actually worse now, because previously there was at least one
<code>y</code>. The debug log does not have any <code>yes: command not found</code>, because
it was clobbered by the <code>2&gt; /dev/null</code> redirection. Oops.</p>
<h4 id="jsmeix_commented_at_2022-07-04_0744"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2827#issuecomment-1173467419">2022-07-04 07:44</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-07-04_0744" title="Permanent link">&para;</a></h4>
<p>Sigh :-(<br />
Nowadays computing things are too convoluted with subtle
interdependencies<br />
that at least for me it is impossible in practice with reasonable
effort<br />
to understand what actually goes on.</p>
<h4 id="jsmeix_commented_at_2022-07-04_0752"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2827#issuecomment-1173475397">2022-07-04 07:52</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-07-04_0752" title="Permanent link">&para;</a></h4>
<p>@pcahyna<br />
once more a big thank you for your careful testing of the actual issue<br />
by setting up a specifically prepared test case in<br />
<a href="https://github.com/rear/rear/pull/2834#issue-1291807720">https://github.com/rear/rear/pull/2834#issue-1291807720</a><br />
where "lvm lvcreate" actually needs 'yes' input.</p>
<h4 id="pcahyna_commented_at_2022-07-04_0810"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/2827#issuecomment-1173495169">2022-07-04 08:10</a>:<a class="headerlink" href="#pcahyna_commented_at_2022-07-04_0810" title="Permanent link">&para;</a></h4>
<p>@jsmeix glad to have helped! Actually, the special test case was not
needed to test this particular problem, because if one restores in
migration mode to existing disks, one needs at least one <code>y</code> and the
change here removed even that (but I have not tested this simple case,
because I have not expected a regression). Of course, in order to have
trust in the original problem being fixed, one should do a test crafted
specifically to trigger it.</p>
<h4 id="jsmeix_commented_at_2022-07-04_0817"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2827#issuecomment-1173503354">2022-07-04 08:17</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-07-04_0817" title="Permanent link">&para;</a></h4>
<p>Now I wonder why my tests above had "just worked" for me.<br />
I guess I did not do a second "rear recover" on the recovered system<br />
i.e. I think I did not test with a disk that already has LVM metadata<br />
at the exact same bytes where it will be re-recreated.</p>
<h4 id="pcahyna_commented_at_2022-07-04_0842"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/2827#issuecomment-1173530826">2022-07-04 08:42</a>:<a class="headerlink" href="#pcahyna_commented_at_2022-07-04_0842" title="Permanent link">&para;</a></h4>
<p>The key must be</p>
<blockquote>
<p>On replacement system VM (with same virtual disk size):</p>
</blockquote>
<p>that seems to imply you restored to clean disks. My tests almost always
restore to disks with existing data.</p>
<h4 id="jsmeix_commented_at_2022-07-04_1009"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2827#issuecomment-1173626730">2022-07-04 10:09</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-07-04_1009" title="Permanent link">&para;</a></h4>
<p>Yes, usually I test with one "original system"<br />
that I do not overwrite because I like to be able to adapt<br />
things in the original system if something does not work.<br />
I run "rear recover" on another VM usually with same disk size.</p>
<p>In this particular case I was unable to reproduce<br />
the initial issue, see<br />
<a href="https://github.com/rear/rear/issues/2820#issuecomment-1161902999">https://github.com/rear/rear/issues/2820#issuecomment-1161902999</a><br />
so I could only test if the 'yes' pipe doesn't cause regressions<br />
but I didn't imagine that the fail-safe 'yes' pipe could have<br />
silenty failed because my ReaR debug log messages like</p>
<pre><code>+++ lvm lvcreate ...
+++ yes
+++ true
  Logical volume "..." created.
</code></pre>
<p>matched so well my wishful expectations.</p>
<p>Right now I checked again that the running 'true'<br />
does not indicate that 'yes' had really failed<br />
so the running 'true' is the normal case when all is well:</p>
<pre><code># ( set -x ; ( yes 2&gt;/dev/null || true ) | head -n2 )
+ yes
+ head -n2
y
y
+ true

# ( set -x ; ( yes || true ) | head -n2 )
+ yes
+ head -n2
y
y
yes: standard output: Broken pipe
+ true
</code></pre>
<p>because all is well when 'yes' fails with "Broken pipe"<br />
(at least on my openSUSE Leap 15.3 system).</p>
<h4 id="jsmeix_commented_at_2022-07-04_1017"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2827#issuecomment-1173635575">2022-07-04 10:17</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-07-04_1017" title="Permanent link">&para;</a></h4>
<p>Strictly speaking is it not sufficient to only verify<br />
that the original problem is fixed via a crafted test<br />
specifically to trigger the original problem.<br />
It is also needed to verify that the fix does not introduce<br />
regressions for various normal cases without the original problem.<br />
So every code change would have to be tested multiple times<br />
which is more than what we can do currently in practice.</p>
<h4 id="jsmeix_commented_at_2022-07-04_1043"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2827#issuecomment-1173663486">2022-07-04 10:43</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-07-04_1043" title="Permanent link">&para;</a></h4>
<p>@pcahyna<br />
when your tests almost always restore to disks with existing data<br />
I would very much appreciate it if you could also test with</p>
<pre><code>DISKS_TO_BE_WIPED=''
</code></pre>
<p>because I need feedback how wiping disks during "rear recover"<br />
works in practice on other systems "out there in the wild".</p>
<h4 id="pcahyna_commented_at_2022-07-04_1301"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/2827#issuecomment-1173794233">2022-07-04 13:01</a>:<a class="headerlink" href="#pcahyna_commented_at_2022-07-04_1301" title="Permanent link">&para;</a></h4>
<blockquote>
<p>Strictly speaking is it not sufficient to only verify<br />
that the original problem is fixed via a crafted test<br />
specifically to trigger the original problem.<br />
It is also needed to verify that the fix does not introduce<br />
regressions for various normal cases without the original problem.</p>
</blockquote>
<p>yes. We were lucky in this case that the relevant normal cases were a
subset of the original problem (both involve migration mode and old data
on target disks).<br />
We have been working on automated tests that will run on each commit (it
is a diploma thesis topic). Stay tuned...</p>
<blockquote>
<p><code>DISKS_TO_BE_WIPED=''</code></p>
</blockquote>
<p>yes, I saw your changes related to wiping disks and I am sorry for not
having reviewed them in detail. I can test that, but not immediately.
Please describe the test case that you need (migration mode on or off?
One disk or many? Same disk sizes or different sizes? Data to be
preserved on some of the disks or everything to be wiped?) and I will
test it when I can.</p>
<h4 id="pcahyna_commented_at_2022-07-04_1306"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/2827#issuecomment-1173798972">2022-07-04 13:06</a>:<a class="headerlink" href="#pcahyna_commented_at_2022-07-04_1306" title="Permanent link">&para;</a></h4>
<blockquote>
<p>because all is well when 'yes' fails with "Broken pipe"</p>
</blockquote>
<p>indeed, the problem is that for <code>yes</code> an error exit is part of its
normal operation (why can't it handle SIGPIPE?) so if you hide that, you
also hide real problems. You could avoid the stderr redirection, this
way you would have some "broken pipe" messages in the log, but also real
diagnostics in case of real errors.</p>
<h4 id="pcahyna_commented_at_2022-07-04_1308"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/2827#issuecomment-1173801878">2022-07-04 13:08</a>:<a class="headerlink" href="#pcahyna_commented_at_2022-07-04_1308" title="Permanent link">&para;</a></h4>
<blockquote>
<p>Sigh :-( Nowadays computing things are too convoluted with subtle
interdependencies that at least for me it is impossible in practice
with reasonable effort to understand what actually goes on.</p>
</blockquote>
<p>I wanted to avoid the <code>yes</code> pipeline for this reason: to avoid
increasing the amount of complexity and interdependencies. I think we
should remove it and replace by <code>-y</code> as soon as you stop caring about
old SLES versions.</p>
<h4 id="jsmeix_commented_at_2022-07-04_1324"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2827#issuecomment-1173819195">2022-07-04 13:24</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-07-04_1324" title="Permanent link">&para;</a></h4>
<p>Currently (in particular for ReaR 2.7) there is</p>
<pre><code>DISKS_TO_BE_WIPED='false'
</code></pre>
<p>in default.conf to avoid issues until this feature was more tested<br />
so we have plenty of time to test it.<br />
Basically I would like to test just everything with</p>
<pre><code>DISKS_TO_BE_WIPED=''
</code></pre>
<p>because - provided it works sufficiently well<br />
which means first and foremost sufficiently fail-safe<br />
(no wrong disk must ever be wiped by accident) -<br />
my intent is to have that in ReaR 2.8 (or in any<br />
later version if things don't work sufficiently well).</p>
<p>In particular when MIGRATION_MODE is automatically set to true<br />
wiping disks is likely not so much needed because then disks<br />
are different so that remainders on a used disk are unlikely<br />
to reappear after partitioning during "rear recover".</p>
<p>Where automated wiping disks is likely much more needed<br />
is when the disks on the replacement system are same<br />
as the ones on the original system - in particular when<br />
"rear recover" is run on the original system (e.g. to<br />
recover from soft errors like messed up filesystems)<br />
because then it is more likely that remainders on the<br />
original disk reappear during "rear recover".</p>
<h4 id="jsmeix_commented_at_2022-07-04_1340"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2827#issuecomment-1173836441">2022-07-04 13:40</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-07-04_1340" title="Permanent link">&para;</a></h4>
<p>An ultimate fail-safe false-alarm-handling 'yes' pipe:</p>
<pre><code># ( set -x ; ( yes || echo "A 'broken pipe' would be false alarm from 'yes'" 1&gt;&amp;2 ) | head -n2 )
+ yes
+ head -n2
y
y
yes: standard output: Broken pipe
+ echo 'A '\''broken pipe'\'' would be false alarm from '\''yes'\'''
A 'broken pipe' would be false alarm from 'yes'
</code></pre>
<p>I don't plan to use that - it gets over the top.</p>
<p>After ReaR 2.7 was released I will replace the 'yes' pipe with</p>
<pre><code>lvm lvcreate -y ...
</code></pre>
<p>then let's see how that might fail in unexpected ways<br />
e.g. for some cases with some (future) LVM versions<br />
one might need more than one <code>-y</code> or additionally <code>-f</code><br />
or even <code>-ff -yy</code> or whatever ;-)</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2024 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2022-06-22.2827.pr.merged.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/rear/rear-user-guide" class="fa fa-code-fork" style="color: #fcfcfc"> rear/rear-user-guide</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
