<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#1733 PR merged: Replace 400_autoresize_disks by 420_autoresize_last_partitions and 430_autoresize_all_partitions - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#1733 PR merged: Replace 400_autoresize_disks by 420_autoresize_last_partitions and 430_autoresize_all_partitions";
        var mkdocs_page_input_path = "issues/2018-02-16.1733.pr.merged.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#1733 PR merged: Replace 400_autoresize_disks by 420_autoresize_last_partitions and 430_autoresize_all_partitions</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="1733_pr_merged_replace_400_autoresize_disks_by_420_autoresize_last_partitions_and_430_autoresize_all_partitions"><a href="https://github.com/rear/rear/pull/1733">#1733 PR</a> <code>merged</code>: Replace 400_autoresize_disks by 420_autoresize_last_partitions and 430_autoresize_all_partitions<a class="headerlink" href="#1733_pr_merged_replace_400_autoresize_disks_by_420_autoresize_last_partitions_and_430_autoresize_all_partitions" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>enhancement</code>, <code>bug</code>, <code>cleanup</code>, <code>fixed / solved / done</code></p>
<h4 id="jsmeix_opened_issue_at_2018-02-16_1334"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> opened issue at <a href="https://github.com/rear/rear/pull/1733">2018-02-16 13:34</a>:<a class="headerlink" href="#jsmeix_opened_issue_at_2018-02-16_1334" title="Permanent link">&para;</a></h4>
<ul>
<li>
<p>Type: <strong>Bug Fix</strong> <strong>Enhancement</strong></p>
</li>
<li>
<p>Impact: <strong>High</strong></p>
</li>
<li>
<p>Reference to related issue (URL):<br />
<a href="https://github.com/rear/rear/issues/1731">https://github.com/rear/rear/issues/1731</a></p>
</li>
<li>
<p>How was this pull request tested?<br />
    Currently this is in a "submit early" state<br />
    where subsequent "submit often" commits will follow<br />
    that is currently mainly intended for others to see what I have up
    to now<br />
    which is currently only a little bit tested by me</p>
</li>
<li>
<p>Brief description of the changes in this pull request:</p>
</li>
</ul>
<p>Renamed 400_autoresize_disks.sh into
430_autoresize_all_partitions.sh<br />
to keep full backward compatible old weird behaviour but now that<br />
needs to be explicity wanted by the user via the new config variable<br />
AUTORESIZE_PARTITIONS=true<br />
and<br />
implemented new default 420_autoresize_last_partitions.sh<br />
that only resizes the last partition on each disk (if at all).</p>
<ul>
<li>Longer description of the changes in this pull request:</li>
</ul>
<p>The new default behaviour is to only resize the last partition on each
disk<br />
which means to only change the end vaule of the last partitions.</p>
<p>This way ReaR should behave now fail save.</p>
<p>I think ReaR is meant to recreate a system as much as possible<br />
exactly as it was before and not to do a complete repartitioning.</p>
<p>I talked to colleagues in general about resizing partitions during
disaster recovery<br />
and got consensus that the general expectation is that by default the
recreated<br />
system should be "the same" regardless if a replacement disk is
bigger.<br />
In particular nobody wants changed partitions when the replacement
disk<br />
is only a bit bigger (e.g. some small disk model specific differences).</p>
<p>The new automated resizing implements a "minimal changes" approach<br />
in the new 420_autoresize_last_partitions.sh script.</p>
<p>The old 430_autoresize_all_partitions.sh and<br />
the new 420_autoresize_last_partitions.sh<br />
are mutually excluding each other via the AUTORESIZE_PARTITIONS value.</p>
<p>Because only the end value of the last partition may get changed,<br />
the partitioning alignment of the original system is not changed,<br />
cf.
<a href="https://github.com/rear/rear/issues/102">https://github.com/rear/rear/issues/102</a><br />
so that with the new default behaviour "rear recover" can no longer
result<br />
a partitioning that is worse than what it was on the original system.</p>
<p>Additionally there are limits via the new config variables<br />
AUTOSHRINK_DISK_SIZE_LIMIT_PERCENTAGE and<br />
AUTOINCREASE_DISK_SIZE_THRESHOLD_PERCENTAGE<br />
when the last partition will be changed at all to avoid changes<br />
when the new disk is only a little bit bigger and to avoid that<br />
the backup cannot be restored when the new disk is much smaller.</p>
<p>When the new disk is a bit smaller<br />
(at most AUTOSHRINK_DISK_SIZE_LIMIT_PERCENTAGE percent),<br />
the last (active - i.e. not commented in disklayout.conf) partition<br />
gets shrinked but all other partitions are not changed.<br />
When the new disk is smaller than<br />
AUTOSHRINK_DISK_SIZE_LIMIT_PERCENTAGE percent it errors out.<br />
To migrate onto a substantially smaller new disk the user must in
advance<br />
manually adapt his disklayout.conf file before he runs "rear recover".</p>
<p>When the new disk is only a bit bigger<br />
(less than AUTOINCREASE_DISK_SIZE_THRESHOLD_PERCENTAGE percent),<br />
no partition gets increased (which leaves the bigger disk space<br />
at the end of the disk unused).<br />
When the new disk is substantially bigger<br />
(at least AUTOINCREASE_DISK_SIZE_THRESHOLD_PERCENTAGE percent),<br />
the last (active) partition gets increased but all other partitions are
not changed.<br />
To migrate various partitions onto a substantially bigger new disk the
user must<br />
in advance manually adapt his disklayout.conf file before he runs "rear
recover".</p>
<p>Furthermore the user has the final power because via the new config
variables<br />
AUTORESIZE_EXCLUDE_PARTITIONS and AUTORESIZE_PARTITIONS<br />
the user can specify what partitions should be explicitly excluded or
inculed<br />
to be resized.</p>
<p>The new config variables apply only to the new
420_autoresize_last_partitions.sh<br />
because currently the old 430_autoresize_all_partitions.sh is there<br />
to keep full backward compatible old weird behaviour.</p>
<p>Perhaps later - if there is really no use-case for the old weird
behaviour - the<br />
430_autoresize_all_partitions.sh could be enhanced to resize more
than<br />
only the last partition in a fail-safe way, but currently this is not at
all<br />
my scope or my intention of this pull request.</p>
<p>I tried two times to enhance the old 400_autoresize_disks.sh into
something<br />
that works both backward compatible and reasonably fail-safe<br />
but I failed two times so that I will no longer try to enhance that
script<br />
in any way - of course would I appreciate it if others could do it.</p>
<h4 id="jsmeix_commented_at_2018-02-16_1350"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1733#issuecomment-366239970">2018-02-16 13:50</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-02-16_1350" title="Permanent link">&para;</a></h4>
<p>I forgot to mention that the new 420_autoresize_last_partitions.sh<br />
provides much broader support to exclude 'boot' 'swap' and now also
'efi'<br />
partitions from being resized via AUTORESIZE_EXCLUDE_PARTITIONS:<br />
The special values 'boot', 'swap', and 'efi' specify that</p>
<p>partitions where its filesystem mountpoint contains 'boot' or 'bios' or
'grub'<br />
or where its GPT name or flags contain 'boot' or 'bios' or 'grub'
(anywhere case insensitive)</p>
<p>partitions for which an active 'swap' entry exists in disklayout.conf<br />
or where its GPT name or flags contain 'swap' (anywhere case
insensitive)</p>
<p>partitions where its filesystem mountpoint contains 'efi' or 'esp'<br />
or where its GPT name or flags contains 'efi' or 'esp' (anywhere case
insensitive)</p>
<p>are excluded from being resized via<br />
AUTORESIZE_EXCLUDE_PARTITIONS=( boot swap efi )</p>
<p>This exludes more often boot and swap partitions<br />
as the old code in 430_autoresize_all_partitions.sh does.</p>
<h4 id="jsmeix_commented_at_2018-02-17_1149"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1733#issuecomment-366436113">2018-02-17 11:49</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-02-17_1149" title="Permanent link">&para;</a></h4>
<p>It is explicitly intended to also work reasonably well when the disk
size shrinked.</p>
<p>Shrinking can only work to some reasonable extent because I think<br />
no automatism can work if the disk is too small so that it has less
space<br />
than the backup restore would need.<br />
I think this cannot be checked at partitioning time.<br />
Or do we have a stored value what the uncompressed backup needs?<br />
Don't we have some disk usage values from the original system stored?<br />
If yes I will use those vaules to check if shrinking should be o.k.<br />
I will have a closer look next week...</p>
<p>FYI<br />
What is currently missing is:</p>
<p>a)<br />
Resizing when the last partition is a logical partition<br />
i.e. when the last partition is "inside" a "container partition" (an
extended partition).<br />
Then I also need to adjust the end value of the "container partition"<br />
to have all values right in disklayout.conf.</p>
<p>I want to always have all values perfectly right in disklayout.conf
because<br />
in migration mode the user is asked to confirm that disklayout.conf is
right.<br />
But what should the user do when just before a ReaR script had messed
up<br />
his original disklayout.conf with inconsistent values that look plain
wrong?<br />
The user must then assume ReaR is broken.</p>
<p>b)<br />
Shrinking when the last partitions ends before the end of disk on the
original system<br />
i.e. when there was unused disk space at the end of the disk on the
original system.<br />
Then on a smaller replacement disk the last partition may not need to be
shrinked.<br />
This case is an important use-case because things should "just work"
when the<br />
user had intentionally left some unused space at the end of the original
disk<br />
to be prepared to recover without any partitioning changes on a bit
smaller<br />
replacement disk (i.e. small disk size differences between different
disk models<br />
that are all labeled as e.g. "2 TB" sized disks).</p>
<h4 id="jsmeix_commented_at_2018-02-19_1137"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1733#issuecomment-366664398">2018-02-19 11:37</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-02-19_1137" title="Permanent link">&para;</a></h4>
<p>FYI:<br />
In case of b) in<br />
<a href="https://github.com/rear/rear/pull/1733#issuecomment-366436113">https://github.com/rear/rear/pull/1733#issuecomment-366436113</a><br />
i.e. when the last partitions ends before the end of disk on the
original system<br />
it currently blindly proceeds and luckily fails by accident as follows:</p>
<p>On the original system I have now the last partition smaller than to end
of disk:</p>
<pre>
# parted -s /dev/sdb unit B print
Model: ATA QEMU HARDDISK (scsi)
Disk /dev/sdb: 2147483648B
Sector size (logical/physical): 512B/512B
Partition Table: gpt
Number  Start        End          Size        File system     Name   Flags
 1      8388608B     847249407B   838860800B  ext2            data1
 2      847249408B   1266679807B  419430400B  linux-swap(v1)  swap1
 3      1266679808B  1476395007B  209715200B  ext2            data2
 4      1476395008B  1790967807B  314572800B  linux-swap(v1)  swap2
</pre>

<p>and with that "rear recover" fails with</p>
<pre>
Last partition /dev/sdb4 must be shrinked by -248512512 bytes to still fit on disk
ERROR: Last partition /dev/sdb4 cannot be shrinked (new disk more than 3% smaller)
</pre>

<p>The wrong negative shrink value happens because when the new disk is
smaller<br />
it calculates the shrink value from the original end of partition to the
end of new disk<br />
which results a wrong negative shrink value if the original end of
partition is<br />
less than end of new disk which means there is no need to do any
shrinking<br />
but my current insufficient code blindly proceeds and luckily stops at
that error.</p>
<h4 id="jsmeix_commented_at_2018-02-20_1328"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1733#issuecomment-366977141">2018-02-20 13:28</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-02-20_1328" title="Permanent link">&para;</a></h4>
<p>With the above last three commits<br />
case of b) in<br />
<a href="https://github.com/rear/rear/pull/1733#issuecomment-366436113">https://github.com/rear/rear/pull/1733#issuecomment-366436113</a><br />
should be solved<br />
plus (via the third of the three commits)<br />
the user gets a warning (one of the rare cases where a "WARNING" is
justified)<br />
when the new size of last partition will be smaller than its disk usage
was<br />
which needs 510_current_disk_usage.sh to be enhaced so that now<br />
the values in var/lib/rear/layout/config/df.txt can be used to
calculate<br />
in 420_autoresize_last_partitions.sh if the current disk usage still
fits<br />
on a smaller disk (when the last partition must be shrinked).</p>
<p>On my original system I have now (my sdb is 2 GiB):</p>
<pre>
# df -Pl -BM -x encfs -x tmpfs -x devtmpfs
Filesystem     1048576-blocks  Used Available Capacity Mounted on
/dev/sda2              18684M 2699M    15036M      16% /
/dev/sdb4                591M  551M       10M      99% /data3

# ls -lh /data3/
total 551M
drwx------ 2 root root  16K Feb 20 13:22 lost+found
-rw-r--r-- 1 root root 550M Feb 20 13:29 udandom550MiBs.data
</pre>

<p>How it looks during "rear recover" with a new sdb of only 1.9 GiB
(excerpts):</p>
<pre>
# rear -D recover
...
WARNING: New size of last partition /dev/sdb4 will be smaller than its disk usage was
Last partition /dev/sdb4 must be shrinked by 66060288 bytes to still fit on disk
Shrinking last partition /dev/sdb4 to end of disk (new disk at most 5% smaller)
Changed last partition /dev/sdb4 size from 629145600 to 563085312 bytes
...
Restoring data3/udandom550MiBs.data 
...
Restored 2608 MiB [avg. 19353 KiB/sec] 
OK
Backup restore program 'tar' failed with exit code '2'. Check '/var/log/rear/rear-d57.log' and the restored system.
...

# grep ^tar: /var/log/rear/rear-d57.log
tar: data3/udandom550MiBs.data: Wrote only 3584 of 10240 bytes
tar: Exiting with failure status due to previous errors

# df -Pl -BM -x encfs -x tmpfs -x devtmpfs
Filesystem     1048576-blocks  Used Available Capacity Mounted on
/dev/sda2              18684M 2473M    15452M      14% /mnt/local
/dev/sdb4                529M  529M        0M     100% /mnt/local/data3

# ls -lh /mnt/local/data3
total 529M
drwx------ 2 root root  16K Feb 20 13:22 lost+found
-rw-r--r-- 1 root root 528M Feb 20 13:29 udandom550MiBs.data
</pre>

<p>('udandom' should have been 'urandom' but that doesn't matter)</p>
<h4 id="jsmeix_commented_at_2018-02-21_1256"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1733#issuecomment-367317079">2018-02-21 12:56</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-02-21_1256" title="Permanent link">&para;</a></h4>
<p>I will now work on case a) in<br />
<a href="https://github.com/rear/rear/pull/1733#issuecomment-366436113">https://github.com/rear/rear/pull/1733#issuecomment-366436113</a></p>
<p>Now I have this sdb:</p>
<pre>
# parted -s /dev/sdb unit MiB print
Model: ATA QEMU HARDDISK (scsi)
Disk /dev/sdb: 2048MiB
Sector size (logical/physical): 512B/512B
Partition Table: msdos
Number  Start    End      Size     Type      File system     Flags
 1      8.00MiB  808MiB   800MiB   primary   ext2            type=83
 2      808MiB   1208MiB  400MiB   primary   linux-swap(v1)  type=82
 3      1208MiB  1708MiB  500MiB   extended                  lba, type=0f
 5      1209MiB  1300MiB  91.0MiB  logical   ext2            type=83
 6      1400MiB  1600MiB  200MiB   logical   ext2            type=83
</pre>

<p>Note the gaps around the second logical partition /dev/sdb6 and<br />
the gap from the end of the extended partition to the end of disk:</p>
<pre>
1208MiB start extended
1209MiB start logical1
1300MiB end logical1
gap
1400MiB start logical2
1600MiB end logical2
gap
1708MiB end extended
gap
2048MiB end disk
</pre>

<p>What must work is to shrink the disk to those values</p>
<p>1708MiB (or more):<br />
no changes of the partitioning</p>
<p>less than 1708MiB but not less than 1600MiB:<br />
end extended is adjusted to new end of disk<br />
but logical2 is not changed</p>
<p>less than 1600MiB but still more than 1400MiB:<br />
end extended and end logical2 are adjusted to new end of disk<br />
plus test if new logical2 size is smaller than logical2 disk usage</p>
<p>1400MiB (or less):<br />
error out with some "no space for logical2 on disk" message<br />
regardless that start logical2 could be moved down to end logical1<br />
but such things will not be implemented now (perhaps later, perhaps
never).</p>
<h4 id="jsmeix_commented_at_2018-02-22_1314"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1733#issuecomment-367676894">2018-02-22 13:14</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-02-22_1314" title="Permanent link">&para;</a></h4>
<p>While working on it I try out various stuff in the recovery system and<br />
I got confused how original config files (in particular
disklayout.conf)<br />
were saved and restored and improved that with my last commit here.</p>
<h4 id="jsmeix_commented_at_2018-02-22_1329"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1733#issuecomment-367680598">2018-02-22 13:29</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-02-22_1329" title="Permanent link">&para;</a></h4>
<p>There is a severe bug in current ReaR master code<br />
at least regarding the size of an extended partition:</p>
<p>With this sdb<br />
( same as in
<a href="https://github.com/rear/rear/pull/1733#issuecomment-367317079">https://github.com/rear/rear/pull/1733#issuecomment-367317079</a>
)</p>
<pre>
# parted -s /dev/sdb unit MiB print
Model: ATA QEMU HARDDISK (scsi)
Disk /dev/sdb: 2048MiB
Sector size (logical/physical): 512B/512B
Partition Table: msdos
Number  Start    End      Size     Type      File system     Flags
 1      8.00MiB  808MiB   800MiB   primary   ext2            type=83
 2      808MiB   1208MiB  400MiB   primary   linux-swap(v1)  type=82
 3      1208MiB  1708MiB  500MiB   extended                  lba, type=0f
 5      1209MiB  1300MiB  91.0MiB  logical   ext2            type=83
 6      1400MiB  1600MiB  200MiB   logical   ext2            type=83

# parted -s /dev/sdb unit B print
Model: ATA QEMU HARDDISK (scsi)
Disk /dev/sdb: 2147483648B
Sector size (logical/physical): 512B/512B
Partition Table: msdos
Number  Start        End          Size        Type      File system     Flags
 1      8388608B     847249407B   838860800B  primary   ext2            type=83
 2      847249408B   1266679807B  419430400B  primary   linux-swap(v1)  type=82
 3      1266679808B  1790967807B  524288000B  extended                  lba, type=0f
 5      1267728384B  1363148799B  95420416B   logical   ext2            type=83
 6      1468006400B  1677721599B  209715200B  logical   ext2            type=83
</pre>

<p>I get after "rear mkrescue" this<br />
var/lib/rear/layout/disklayout.conf entries for sdb</p>
<pre>
# Disk /dev/sdb
# Format: disk &lt;devname> &lt;size(bytes)> &lt;partition label type>
disk /dev/sdb 2147483648 msdos
# Partitions on /dev/sdb
# Format: part &lt;device> &lt;partition size(bytes)> &lt;partition start(bytes)> &lt;partition type|name> &lt;flags> /dev/&lt;partition>
part /dev/sdb 838860800 8388608 primary none /dev/sdb1
part /dev/sdb 419430400 847249408 primary none /dev/sdb2
part /dev/sdb 1024 1266679808 extended lba /dev/sdb3
part /dev/sdb 95420416 1267728384 logical none /dev/sdb5
part /dev/sdb 209715200 1468006400 logical none /dev/sdb6
</pre>

<p>where the size of the extended partition is only 1024 bytes<br />
in contrast to its actual size shown by parted of 524288000 bytes = 500
MiB.</p>
<p>And that is what I get with current ReaR master code after "rear
recover"</p>
<pre>
RESCUE d57:~ # rear -D recover
...
User confirmed disk layout file
Partition primary on /dev/sda: size reduced to fit on disk.
Partition logical on /dev/sdb: size reduced to fit on disk.
...
User confirmed disk recreation script
Start system layout restoration.
Creating partitions for disk /dev/sda (msdos)
Creating partitions for disk /dev/sdb (msdos)
Creating filesystem of type ext3 with mount point / on /dev/sda2.
Mounting filesystem /
Creating filesystem of type ext2 with mount point /data.logical2 on /dev/sdb6.
Mounting filesystem /data.logical2
Creating swap on /dev/sda1
Disk layout created.
Restoring from '/tmp/rear.EShvaipVvXXIREv/outputfs/d57/backup.tar.gz'...
...
Restoring finished.
...
Finished recovering your system. You can explore it under '/mnt/local'.
Exiting rear recover (PID 842) and its descendant processes
Running exit tasks

RESCUE d57:~ # parted -s /dev/sdb unit MiB print
Model: ATA QEMU HARDDISK (scsi)
Disk /dev/sdb: 1843MiB
Sector size (logical/physical): 512B/512B
Partition Table: msdos
Number  Start    End      Size    Type      File system  Flagsfinal commandment 
 1      2.00MiB  991MiB   989MiB  primary                type=83
 2      991MiB   1485MiB  494MiB  primary                type=83
 3      1485MiB  1843MiB  358MiB  extended               lba, type=0f
 5      1485MiB  1598MiB  112MiB  logical                type=83
 6      1598MiB  1843MiB  245MiB  logical   ext2         type=83

RESCUE d57:~ # parted -s /dev/sdb unit B print
Model: ATA QEMU HARDDISK (scsi)
Disk /dev/sdb: 1932735488B
Sector size (logical/physical): 512B/512B
Partition Table: msdos
Number  Start        End          Size         Type      File system  Flags
 1      2097152B     1039111167B  1037014016B  primary                type=83
 2      1039114240B  1557621247B  518507008B   primary                type=83
 3      1557622784B  1932735487B  375112704B   extended               lba, type=0f
 5      1557626880B  1675587583B  117960704B   logical                type=83
 6      1675591680B  1932735487B  257143808B   logical   ext2         type=83
</pre>

<p>What a mess: I got a very different partitioning.</p>
<p>That insane</p>
<pre>
Partition primary on /dev/sda: size reduced to fit on disk.
Partition logical on /dev/sdb: size reduced to fit on disk.
</pre>

<p>comes from layout/prepare/GNU/Linux/100_include_partition_code.sh<br />
which arbitrarily changes my disklayout.conf after</p>
<pre>
User confirmed disk layout file
</pre>

<p>so that with current ReaR master code "rear recover" clearly works<br />
blindly against what the user has confirmed that should be set up<br />
in migration mode.</p>
<p>WHAT A MESS!</p>
<p>In migration mode what the user has confirmed that should be set up<br />
is sacrosanct: It is the user's final commandment that must be obeyed.</p>
<p>If the user's confirmed disklayout.conf partitioning cannot be set up,<br />
100_include_partition_code.sh has to error out (at least in migration
mode)<br />
so that the user can adapt disklayout.conf but
100_include_partition_code.sh<br />
must not arbitrarily change the user's confirmed partitioning to
whatever<br />
that script "thinks" is best.</p>
<h4 id="jsmeix_commented_at_2018-02-23_1445"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1733#issuecomment-368028494">2018-02-23 14:45</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-02-23_1445" title="Permanent link">&para;</a></h4>
<p>And now what I get with my current code of this pull request<br />
after "rear recover" (with same original system)</p>
<pre>
RESCUE d57:~ # rear -D recover
...
User confirmed disk mapping
Last partition /dev/sda2 cannot be resized (new disk less than 1% bigger)
Last partition /dev/sdb6 will not be resized (original last partition still fits on the new smaller disk)
...
User confirmed disk recreation script
Start system layout restoration.
...
Finished recovering your system. You can explore it under '/mnt/local'.
Exiting rear recover (PID 850) and its descendant processes
Running exit tasks

RESCUE d57:~ # parted -s /dev/sdb unit MiB print
Model: ATA QEMU HARDDISK (scsi)
Disk /dev/sdb: 1843MiB
Sector size (logical/physical): 512B/512B
Partition Table: msdos
Number  Start    End      Size     Type      File system  Flags
 1      2.00MiB  802MiB   800MiB   primary                type=83
 2      802MiB   1202MiB  400MiB   primary                type=83
 3      1202MiB  1843MiB  641MiB   extended               lba, type=0f
 5      1202MiB  1293MiB  91.0MiB  logical                type=83
 6      1293MiB  1493MiB  200MiB   logical   ext2         type=83

RESCUE d57:~ # parted -s /dev/sdb unit B print
Model: ATA QEMU HARDDISK (scsi)
Disk /dev/sdb: 1932735488B
Sector size (logical/physical): 512B/512B
Partition Table: msdos
Number  Start        End          Size        Type      File system  Flags
 1      2097152B     840957951B   838860800B  primary                type=83
 2      840962048B   1260392447B  419430400B  primary                type=83
 3      1260396544B  1932735487B  672338944B  extended               lba, type=0f
 5      1260400640B  1355821055B  95420416B   logical                type=83
 6      1355825152B  1565540351B  209715200B  logical   ext2         type=83
</pre>

<p>The MiB values look o.k. but the byte values reveal bad alignment after
"rear recover"</p>
<pre>
RESCUE d57:~ # echo "bytes = MiB" ; for start in 2097152 840962048 1260396544 1260400640 1355825152 ; do echo -n "$start = " ; echo "$start / 1024 /1024" | bc -l ; done

bytes = MiB
2097152 = 2.00000000000000000000
840962048 = 802.00390625000000000000
1260396544 = 1202.00781250000000000000
1260400640 = 1202.01171875000000000000
1355825152 = 1293.01562500000000000000
</pre>

<p>in contrast to the good alignemt on the original system:</p>
<pre>
# echo "bytes = MiB" ; for start in 8388608 847249408 1266679808 1267728384 1468006400 ; do echo -n "$start = " ; echo "$start / 1024 /1024" | bc -l ; done

bytes = MiB
8388608 = 8.00000000000000000000
847249408 = 808.00000000000000000000
1266679808 = 1208.00000000000000000000
1267728384 = 1209.00000000000000000000
1468006400 = 1400.00000000000000000000
</pre>

<p>I.e. regardless that disklayout.conf was not changed during "rear
recover"</p>
<pre>
RESCUE d57:~ # diff -us /var/lib/rear/layout/disklayout.conf.20180223152350.recover.850.orig /var/lib/rear/layout/disklayout.conf
Files /var/lib/rear/layout/disklayout.conf.20180223152350.recover.850.orig and /var/lib/rear/layout/disklayout.conf are identical
</pre>

<p>I do not get same partitioning after "rear recover"<br />
so something must still silently change the partitioning.</p>
<h4 id="jsmeix_commented_at_2018-02-23_1459"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1733#issuecomment-368032755">2018-02-23 14:59</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-02-23_1459" title="Permanent link">&para;</a></h4>
<p>I think my next step (for next week) will be to check the functions in<br />
layout/prepare/GNU/Linux/100_include_partition_code.sh<br />
to what extent those functions may change the partitioning<br />
to something different than what is specified in disklayout.conf.</p>
<h4 id="jsmeix_commented_at_2018-02-23_1601"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1733#issuecomment-368051895">2018-02-23 16:01</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-02-23_1601" title="Permanent link">&para;</a></h4>
<p>I found out why in my disklayout.conf the<br />
size of the extended partition is only 1024 bytes:</p>
<p>This happens in layout/save/GNU/Linux/200_partition_layout.sh<br />
at this call</p>
<pre>
        size=$(get_disk_size ${path#/sys/block/})
</pre>

<p>that multiplies the values of<br />
/sys/block/sdb/sdb*/size and
/sys/block/sdb/queue/logical_block_size<br />
which are in my case:</p>
<pre>
# cat /sys/block/sdb/sdb*/size
1638400
819200
2
186368
409600

# cat /sys/block/sdb/queue/logical_block_size
512
</pre>

<p>i.e. the /sys/block/sdb/sdb3/size value is 2 which is not right<br />
but the other values are:</p>
<pre>
# for s in $( cat /sys/block/sdb/sdb*/size ) ; do echo "$s * 512" | bc -l ; done
838860800
419430400
1024
95420416
209715200
</pre>

<p>This fixes it for me:</p>
<pre>
--- a/usr/share/rear/layout/save/GNU/Linux/200_partition_layout.sh
+++ b/usr/share/rear/layout/save/GNU/Linux/200_partition_layout.sh
@@ -241,6 +239,23 @@ extract_partitions() {
                     sed -i /^$partition_nr\ /s/\ primary\ /\ extended\ / $TMP_DIR/partitions
                 fi
             fi
+
+            # Replace currently possibly wrong extended partition size value
+            # by the value that parted reports if those values differ, cf.
+            # https://github.com/rear/rear/pull/1733#issuecomment-368051895
+            # In SLE10 there is GNU Parted 1.6.25.1 which supports 'unit B'
+            # that is documented in 'info parted' (but not yet in 'man parted').
+            # Example of a parted_extended_partition_line:
+            #   # parted -s /dev/sdb unit B print | grep -w '3' | grep -w 'extended'
+            #    3      1266679808B  1790967807B  524288000B  extended                  lba, type=0f
+            # where the size is 524288000B i.e. parted_extended_partition_line[3]
+            parted_extended_partition_line=( $( parted -s $device unit B print | grep -w "$partition_nr" | grep -w 'extended' ) )
+            parted_extended_partition_size="${parted_extended_partition_line[3]%%B*}"
+            if test $size -ne $parted_extended_partition_size ; then
+                 Log "Replacing probably wrong extended partition size $size by what parted reports $parted_extended_partition_size"
+                 sed -i /^$partition_nr\ /s/\ $size\ /\ $parted_extended_partition_size\ / $TMP_DIR/partitions
+            fi
+
         done &lt; $TMP_DIR/partitions-data
     fi

</pre>

<h4 id="gdha_commented_at_2018-02-23_1742"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/pull/1733#issuecomment-368083755">2018-02-23 17:42</a>:<a class="headerlink" href="#gdha_commented_at_2018-02-23_1742" title="Permanent link">&para;</a></h4>
<p>@jsmeix Not sure you can see the content of
<a href="https://access.redhat.com/solutions/2943451">https://access.redhat.com/solutions/2943451</a>
?</p>
<p>Issue</p>
<pre><code>ReaR uses a value for disk size that does not match physical disk info.
The disk size determined by rear is 9592809455616B bytes
according to the disklayout.conf generated
The correct size is visible in the fdisk output below:

&lt;snip&gt;
WARNING: fdisk GPT support is currently new, and therefore in an experimental phase. Use at your own discretion.

Disk /dev/sda: 1199.1 GB, 1199101181952 bytes, 292749312 sectors
Units = sectors of 1 * 4096 = 4096 bytes
Sector size (logical/physical): 4096 bytes / 4096 bytes
I/O size (minimum/optimal): 4096 bytes / 4096 bytes
Disk label type: gpt
&lt;snip&gt;
</code></pre>
<p>Resolution<br />
Permanent Solution</p>
<p>A permanent solution is currently being pursued via the following public
bug report:<br />
Workaround</p>
<p>So as to avoid the overage, the following alteration can be used:</p>
<p>1 - In the /usr/share/rear/lib/layout-functions.sh file, alter the
following from:</p>
<pre><code># Get the block size of a disk.
get_block_size() {
    # Only newer kernels have an interface to get the block size
    if [ -r /sys/block/$1/queue/logical_block_size ] ; then
    echo $( &lt; /sys/block/$1/queue/logical_block_size)
    else
    echo "512"
    fi
}
</code></pre>
<p>To:</p>
<pre><code># Get the block size of a disk.
get_block_size() {
    echo "512"
}
</code></pre>
<p>2 - Build a new rescue image.<br />
3 - verify the resulting disklayout.conf and restoration succeeds with
the correct size.<br />
Root Cause</p>
<p>The reason for the failure is specifically that the kernel-provided
/sys/block/<disk>/queue/logical_block_size value is reported as 4096
bytes by the kernel instead of the traditional 512 bytes. This value is
correct, due to the use of AF hard disks, but does not apply to the
/sys/block/<disk>/size interface that rear uses to determine the number
of blocks. The latter is not a discovered value, but a block count
measured in 512 bytes.</p>
<pre><code>Disk /dev/sda: 1199.1 GB, 1199101181952 bytes, 292749312 sectors
Units = sectors of 1 * 4096 = 4096 bytes
Sector size (logical/physical): 4096 bytes / 4096 bytes
I/O size (minimum/optimal): 4096 bytes / 4096 bytes
Disk label type: gpt
</code></pre>
<p>In the output above, the logical sector size is 4096 bytes. This causes
the following to occur within the rear backup solution;</p>
<pre><code># Get the size in bytes of a disk/partition.
# For partitions, use "sda/sda1" as argument.
get_disk_size() {
    local disk_name=$1

    local block_size=$(get_block_size ${disk_name%/*})

    [ -r /sys/block/$disk_name/size ]
    BugIfError "Could not determine size of disk $disk_name, please file a bug."

    local nr_blocks=$( &lt; /sys/block/$disk_name/size)
    local disk_size=$(( nr_blocks * block_size ))

    ### Make sure we always return a number
    echo $(( disk_size ))
}

# Get the block size of a disk.
get_block_size() {
    # Only newer kernels have an interface to get the block size
    if [ -r /sys/block/$1/queue/logical_block_size ] ; then
    echo $( &lt; /sys/block/$1/queue/logical_block_size)
    else
    echo "512"
    fi
}
</code></pre>
<p>Note the disk_size member is evaluated as the nr_blocks (size)
multiplied by the block_size (logical_block_size). This evaluation
should be hard-coded to (nr_block * 512).</p>
<h4 id="jsmeix_commented_at_2018-02-26_1242"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1733#issuecomment-368488004">2018-02-26 12:42</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-02-26_1242" title="Permanent link">&para;</a></h4>
<p>My last commit here
<a href="https://github.com/rear/rear/pull/1733/commits/6efb681d8b4c6a4d9f20b2900bbea79548c624a8">https://github.com/rear/rear/pull/1733/commits/6efb681d8b4c6a4d9f20b2900bbea79548c624a8</a><br />
fixes only
<a href="https://github.com/rear/rear/pull/1733#issuecomment-368051895">https://github.com/rear/rear/pull/1733#issuecomment-368051895</a>
for me.</p>
<p>In contrast
<a href="https://github.com/rear/rear/pull/1733#issuecomment-368083755">https://github.com/rear/rear/pull/1733#issuecomment-368083755</a><br />
is a different issue with a different root cause (as far as I understand
it).</p>
<p>Currently I do not understand why in<br />
usr/share/rear/layout/save/GNU/Linux/200_partition_layout.sh<br />
the 'part' data for disklayout.conf is not simply what parted reports<br />
(because later also parted will be used to recreate those partitions)<br />
but instead the partitioning data is read from /sys/block/ files?<br />
Why is there that RFC 1925 item 6a "another level of indirection"?<br />
Why not simply parted output data =&gt; parted input data?</p>
<p>Because I do not understand how
layout/save/GNU/Linux/200_partition_layout.sh<br />
works as a whole I can currently not fix or clean up generic things
therein<br />
or in the functions that belong to the disk layout code.</p>
<h4 id="jsmeix_commented_at_2018-02-26_1351"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1733#issuecomment-368509747">2018-02-26 13:51</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-02-26_1351" title="Permanent link">&para;</a></h4>
<p>Only FYI:</p>
<p>With extended partition size fixed<br />
I get now those results:</p>
<p>Original system (same as above):</p>
<pre>
# parted -s /dev/sdb unit MiB print
Model: ATA QEMU HARDDISK (scsi)
Disk /dev/sdb: 2048MiB
Sector size (logical/physical): 512B/512B
Partition Table: msdos
Number  Start    End      Size     Type      File system     Flags
 1      8.00MiB  808MiB   800MiB   primary   ext2            type=83
 2      808MiB   1208MiB  400MiB   primary   linux-swap(v1)  type=82
 3      1208MiB  1708MiB  500MiB   extended                  lba, type=0f
 5      1209MiB  1300MiB  91.0MiB  logical   ext2            type=83
 6      1400MiB  1600MiB  200MiB   logical   ext2            type=83

d57:~/rear.issue1733 # parted -s /dev/sdb unit B print
Model: ATA QEMU HARDDISK (scsi)
Disk /dev/sdb: 2147483648B
Sector size (logical/physical): 512B/512B
Partition Table: msdos
Number  Start        End          Size        Type      File system     Flags
 1      8388608B     847249407B   838860800B  primary   ext2            type=83
 2      847249408B   1266679807B  419430400B  primary   linux-swap(v1)  type=82
 3      1266679808B  1790967807B  524288000B  extended                  lba, type=0f
 5      1267728384B  1363148799B  95420416B   logical   ext2            type=83
 6      1468006400B  1677721599B  209715200B  logical   ext2            type=83
</pre>

<p>On the recreated system</p>
<pre>
RESCUE d57:~ # rear -D recover
...
Last partition /dev/sdb6 will not be resized (original last partition still fits on the new smaller disk)
...
Finished recovering your system. You can explore it under '/mnt/local'.

RESCUE d57:~ # diff -us /var/lib/rear/layout/disklayout.conf.20180226142731.recover.786.orig /var/lib/rear/layout/disklayout.conf
Files /var/lib/rear/layout/disklayout.conf.20180226142731.recover.786.orig and /var/lib/rear/layout/disklayout.conf are identical

RESCUE d57:~ # grep sdb /var/lib/rear/layout/disklayout.conf
# Disk /dev/sdb
disk /dev/sdb 2147483648 msdos
# Partitions on /dev/sdb
part /dev/sdb 838860800 8388608 primary none /dev/sdb1
part /dev/sdb 419430400 847249408 primary none /dev/sdb2Last partition /dev/sdb6 will not be resized (original last partition still fits on the new smaller disk)
part /dev/sdb 524288000 1266679808 extended lba /dev/sdb3
part /dev/sdb 95420416 1267728384 logical none /dev/sdb5
part /dev/sdb 209715200 1468006400 logical none /dev/sdb6

RESCUE d57:~ # grep 'parted .*sdb' /var/lib/rear/layout/diskrestore.sh
parted -s /dev/sdb mklabel msdos >&2
parted -s /dev/sdb mkpart "'primary'" 2097152B 840957951B >&2
parted -s /dev/sdb mkpart "'primary'" 840962048B 1260392447B >&2
parted -s /dev/sdb mkpart "'extended'" 1260396544B 1932735487B >&2
parted -s /dev/sdb set 3 lba on >&2
parted -s /dev/sdb mkpart "'logical'" 1784688640B 1880109055B >&2
parted -s /dev/sdb mkpart "'logical'" 1880113152B 1932735487B >&2

RESCUE d57:~ # parted -s /dev/sdb unit MiB print
Model: ATA QEMU HARDDISK (scsi)
Disk /dev/sdb: 1843MiB
Sector size (logical/physical): 512B/512B
Partition Table: msdos
Number  Start    End      Size     Type      File system  Flags
 1      2.00MiB  802MiB   800MiB   primary                type=83
 2      802MiB   1202MiB  400MiB   primary                type=83
 3      1202MiB  1843MiB  641MiB   extended               lba, type=0f
 5      1702MiB  1793MiB  91.0MiB  logical                type=83
 6      1793MiB  1843MiB  50.2MiB  logical   ext2         type=83

RESCUE d57:~ # parted -s /dev/sdb unit B print
Model: ATA QEMU HARDDISK (scsi)
Disk /dev/sdb: 1932735488B
Sector size (logical/physical): 512B/512B
Partition Table: msdos
Number  Start        End          Size        Type      File system  Flags
 1      2097152B     840957951B   838860800B  primary                type=83
 2      840962048B   1260392447B  419430400B  primary                type=83
 3      1260396544B  1932735487B  672338944B  extended               lba, type=0f
 5      1784688640B  1880109055B  95420416B   logical                type=83
 6      1880113152B  1932735487B  52622336B   logical   ext2         type=83
</pre>

<p>Regardless that my code in 420_autoresize_last_partitions.sh<br />
does not change disklayout.conf in any way because<br />
<code>Last partition /dev/sdb6 will not be resized (original last partition still fits on the new smaller disk)</code><br />
the actual parted commands in diskrestore.sh do not match<br />
the partition values in disklayout.conf so that the resulting MiB values
look o.k.<br />
but the byte values reveal bad alignment after "rear recover" as in<br />
<a href="https://github.com/rear/rear/pull/1733#issuecomment-368028494">https://github.com/rear/rear/pull/1733#issuecomment-368028494</a></p>
<p>Now I will try to fix things in 100_include_partition_code.sh ...</p>
<h4 id="jsmeix_commented_at_2018-02-26_1506"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1733#issuecomment-368532746">2018-02-26 15:06</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-02-26_1506" title="Permanent link">&para;</a></h4>
<p>With my latest commit here<br />
<a href="https://github.com/rear/rear/pull/1733/commits/f4273dc500be87263297f88827508b64d521ccf1">https://github.com/rear/rear/pull/1733/commits/f4273dc500be87263297f88827508b64d521ccf1</a><br />
things work o.k. for me for the first time:</p>
<p>Now I get:</p>
<pre>
RESCUE d57:~ # rear -D recover
...
Last partition /dev/sdb6 will not be resized (original last partition still fits on the new smaller disk)
...
Finished recovering your system. You can explore it under '/mnt/local'.

RESCUE d57:~ # diff -us /var/lib/rear/layout/disklayout.conf.20180226152840.recover.830.orig /var/lib/rear/layout/disklayout.conf
Files /var/lib/rear/layout/disklayout.conf.20180226152840.recover.830.orig and /var/lib/rear/layout/disklayout.conf are identical

RESCUE d57:~ # grep sdb /var/lib/rear/layout/disklayout.conf
# Disk /dev/sdb
disk /dev/sdb 2147483648 msdos
# Partitions on /dev/sdb
part /dev/sdb 838860800 8388608 primary none /dev/sdb1
part /dev/sdb 419430400 847249408 primary none /dev/sdb2
part /dev/sdb 524288000 1266679808 extended lba /dev/sdb3
part /dev/sdb 95420416 1267728384 logical none /dev/sdb5
part /dev/sdb 209715200 1468006400 logical none /dev/sdb6

RESCUE d57:~ # parted -s /dev/sdb unit B print
Model: ATA QEMU HARDDISK (scsi)
Disk /dev/sdb: 1932735488B
Sector size (logical/physical): 512B/512B
Partition Table: msdos
Number  Start        End          Size        Type      File system  Flags
 1      8388608B     847249407B   838860800B  primary                type=83
 2      847249408B   1266679807B  419430400B  primary                type=83
 3      1266679808B  1790967807B  524288000B  extended               lba, type=0f
 5      1267728384B  1363148799B  95420416B   logical                type=83
 6      1468006400B  1677721599B  209715200B  logical   ext2         type=83

RESCUE d57:~ # parted -s /dev/sdb unit B print | grep '^ [1-9]' | tr -s ' ' | cut -d ' ' -f3,5 | tr -d 'B'
8388608 838860800
847249408 419430400
1266679808 524288000
1267728384 95420416
1468006400 209715200

RESCUE d57:~ # grep '^part .* /dev/sdb[1-9]' /var/lib/rear/layout/disklayout.conf | cut -d ' ' -f3,4 | awk '{print $2, $1}'
8388608 838860800
847249408 419430400
1266679808 524288000
1267728384 95420416
1468006400 209715200
</pre>

<p>HOORAY!<br />
Now there is byte-by-byte identical re-partitioning of the recreated
sdb.</p>
<p>Now the first (and simplest) case in<br />
<a href="https://github.com/rear/rear/pull/1733#issuecomment-367317079">https://github.com/rear/rear/pull/1733#issuecomment-367317079</a></p>
<pre>
1708MiB (or more):
no changes of the partitioning
</pre>

<p>seems to work for me as intended.</p>
<h4 id="jsmeix_commented_at_2018-02-26_1508"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1733#issuecomment-368533428">2018-02-26 15:08</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-02-26_1508" title="Permanent link">&para;</a></h4>
<p>Now I need to enhance step by step<br />
layout/prepare/default/420_autoresize_last_partitions.sh<br />
to make it also work for the other cases in<br />
<a href="https://github.com/rear/rear/pull/1733#issuecomment-367317079">https://github.com/rear/rear/pull/1733#issuecomment-367317079</a></p>
<h4 id="jsmeix_commented_at_2018-02-28_1501"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1733#issuecomment-369266568">2018-02-28 15:01</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-02-28_1501" title="Permanent link">&para;</a></h4>
<p>With unchanged sdb as above I get now with</p>
<pre>
AUTORESIZE_PARTITIONS=( /dev/sda2 /dev/sdb6 /dev/sdb3 )
</pre>

<p>during "rear -D recover"</p>
<pre>
Examining /dev/sda to automatically resize its last active partition
Checking /dev/sda1 if it is the last partition on /dev/sda
Checking /dev/sda2 if it is the last partition on /dev/sda
Found 'primary' partition /dev/sda2 as last partition on /dev/sda
Determining if last partition /dev/sda2 is resizeable
Last partition should be resized (/dev/sda2 in AUTORESIZE_PARTITIONS)
Determining new size for last partition /dev/sda2
Determining if last partition /dev/sda2 actually needs to be increased or shrinked
New /dev/sda is 107374592 bigger than old disk
Last partition /dev/sda2 cannot be resized (new disk less than 1% bigger)
Examining /dev/sdb to automatically resize its last active partition
Checking /dev/sdb1 if it is the last partition on /dev/sdb
Checking /dev/sdb2 if it is the last partition on /dev/sdb
Checking /dev/sdb3 if it is the last partition on /dev/sdb
Found extended partition /dev/sdb3 on /dev/sdb
Checking /dev/sdb5 if it is the last partition on /dev/sdb
Checking /dev/sdb6 if it is the last partition on /dev/sdb
Found 'logical' partition /dev/sdb6 as last partition on /dev/sdb
Determining if last partition /dev/sdb6 is resizeable
Last partition should be resized (/dev/sdb6 in AUTORESIZE_PARTITIONS)
Extended partition should be increased (/dev/sdb3 in AUTORESIZE_PARTITIONS)
Determining new size for last partition /dev/sdb6
Increasing extended partition /dev/sdb3 to end of disk
Increased extended partition /dev/sdb3 size from 524288000 to 665845760 bytes
Determining if last partition /dev/sdb6 actually needs to be increased or shrinked
New /dev/sdb is 214748160 smaller than old disk
Last partition /dev/sdb6 will not be resized (original last partition still fits on the new smaller disk)
</pre>

<p>which results only this change in disklayout.conf</p>
<pre>
-part /dev/sdb 524288000 1266679808 extended lba /dev/sdb3
+part /dev/sdb 665845760 1266679808 extended lba /dev/sdb3
</pre>

<p>and this recreated sdb:</p>
<pre>
RESCUE d57:~ # parted -s /dev/sdb unit MiB print
Model: ATA QEMU HARDDISK (scsi)
Disk /dev/sdb: 1843MiB
Sector size (logical/physical): 512B/512B
Partition Table: msdos
Number  Start    End      Size     Type      File system  Flags
 1      8.00MiB  808MiB   800MiB   primary                type=83
 2      808MiB   1208MiB  400MiB   primary                type=83
 3      1208MiB  1843MiB  635MiB   extended               lba, type=0f
 5      1209MiB  1300MiB  91.0MiB  logical                type=83
 6      1400MiB  1600MiB  200MiB   logical   ext2         type=83
</pre>

<p>all perfectly as I expect it to be.</p>
<p>Now the user can specify that only the extended partition is increased
up to the end of disk<br />
when there is no other partition after the end of the extended
partition<br />
i.e. when the last partition is a logical partition<br />
regardless if also the last logical partition gets resized.<br />
This way the user can migrate onto a bigger disk and gets only an
increased extended partition<br />
where he can later add more logical partitions as he likes.</p>
<h4 id="jsmeix_commented_at_2018-03-01_0831"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1733#issuecomment-369514406">2018-03-01 08:31</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-03-01_0831" title="Permanent link">&para;</a></h4>
<p>I will do a few more tests today (but I cannot test everything with
reasonable effort)<br />
and then I would like to merge it today (if it looks to work o.k. for
me)<br />
so that also others who use the current ReaR GitHub master code<br />
will test it on their systems because I do need real user feedback<br />
for such major changes while we are in development phase<br />
to avoid bugs in the ReaR 2.4 release.</p>
<h4 id="jsmeix_commented_at_2018-03-01_1030"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1733#issuecomment-369548894">2018-03-01 10:30</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-03-01_1030" title="Permanent link">&para;</a></h4>
<p>The next case in<br />
<a href="https://github.com/rear/rear/pull/1733#issuecomment-367317079">https://github.com/rear/rear/pull/1733#issuecomment-367317079</a></p>
<pre>
less than 1708MiB but not less than 1600MiB:
end extended is adjusted to new end of disk
but logical2 is not changed
</pre>

<p>works o.k. for me.</p>
<p>I have now in local.conf</p>
<pre>
AUTORESIZE_EXCLUDE_PARTITIONS=( boot swap efi )
AUTOINCREASE_DISK_SIZE_THRESHOLD_PERCENTAGE=1
AUTOSHRINK_DISK_SIZE_LIMIT_PERCENTAGE=40
BACKUP_PROG_INCLUDE=( /data.logical2 )
</pre>

<p>With same 2GiB original sdb as above<br />
I get with a 1638MiB replacement sdb<br />
during "rear recover"</p>
<pre>
Examining /dev/sda to automatically resize its last active partition
Checking /dev/sda1 if it is the last partition on /dev/sda
Checking /dev/sda2 if it is the last partition on /dev/sda
Found 'primary' partition /dev/sda2 as last partition on /dev/sda
Determining if last partition /dev/sda2 is resizeable
Last partition /dev/sda2 not resizeable (used during boot)
Determining new size for last partition /dev/sda2
Determining if last partition /dev/sda2 actually needs to be increased or shrinked
New /dev/sda is 107374592 bigger than old disk
Skip increasing last partition /dev/sda2 (new disk less than 1% bigger)
Examining /dev/sdb to automatically resize its last active partition
Checking /dev/sdb1 if it is the last partition on /dev/sdb
Checking /dev/sdb2 if it is the last partition on /dev/sdb
Checking /dev/sdb3 if it is the last partition on /dev/sdb
Found extended partition /dev/sdb3 on /dev/sdb
Checking /dev/sdb5 if it is the last partition on /dev/sdb
Checking /dev/sdb6 if it is the last partition on /dev/sdb
Found 'logical' partition /dev/sdb6 as last partition on /dev/sdb
Determining if last partition /dev/sdb6 is resizeable
Determining new size for last partition /dev/sdb6
Shrinking extended partition /dev/sdb3 to end of disk
Shrinked extended partition /dev/sdb3 size from 524288000 to 450887680 bytes
Determining if last partition /dev/sdb6 actually needs to be increased or shrinked
New /dev/sdb is 429496320 smaller than old disk
Skip shrinking last partition /dev/sdb6 (original last partition still fits on the new smaller disk)
</pre>

<p>which results that recreated sdb</p>
<pre>
# parted -s /dev/sdb unit MiB print
Model: ATA QEMU HARDDISK (scsi)
Disk /dev/sdb: 1638MiB
Sector size (logical/physical): 512B/512B
Partition Table: msdos
Number  Start    End      Size     Type      File system  Flags
 1      8.00MiB  808MiB   800MiB   primary                type=83
 2      808MiB   1208MiB  400MiB   primary                type=83
 3      1208MiB  1638MiB  430MiB   extended               lba, type=0f
 5      1209MiB  1300MiB  91.0MiB  logical                type=83
 6      1400MiB  1600MiB  200MiB   logical   ext2         type=83
</pre>

<h4 id="jsmeix_commented_at_2018-03-01_1058"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1733#issuecomment-369556007">2018-03-01 10:58</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-03-01_1058" title="Permanent link">&para;</a></h4>
<p>The next case in<br />
<a href="https://github.com/rear/rear/pull/1733#issuecomment-367317079">https://github.com/rear/rear/pull/1733#issuecomment-367317079</a></p>
<pre>
less than 1600MiB but still more than 1400MiB:
end extended and end logical2 are adjusted to new end of disk
plus test if new logical2 size is smaller than logical2 disk usage
</pre>

<p>works o.k for me.</p>
<p>With same 2GiB original sdb as above<br />
I get with a 1536MiB replacement sdb<br />
during "rear recover" (excerpts):</p>
<pre>
Examining /dev/sda to automatically resize its last active partition
Checking /dev/sda1 if it is the last partition on /dev/sda
Checking /dev/sda2 if it is the last partition on /dev/sda
Found 'primary' partition /dev/sda2 as last partition on /dev/sda
Determining if last partition /dev/sda2 is resizeable
Last partition /dev/sda2 not resizeable (used during boot)
Determining new size for last partition /dev/sda2
Determining if last partition /dev/sda2 actually needs to be increased or shrinked
New /dev/sda is 107374592 bigger than old disk
Skip increasing last partition /dev/sda2 (new disk less than 1% bigger)
Examining /dev/sdb to automatically resize its last active partition
Checking /dev/sdb1 if it is the last partition on /dev/sdb
Checking /dev/sdb2 if it is the last partition on /dev/sdb
Checking /dev/sdb3 if it is the last partition on /dev/sdb
Found extended partition /dev/sdb3 on /dev/sdb
Checking /dev/sdb5 if it is the last partition on /dev/sdb
Checking /dev/sdb6 if it is the last partition on /dev/sdb
Found 'logical' partition /dev/sdb6 as last partition on /dev/sdb
Determining if last partition /dev/sdb6 is resizeable
Determining new size for last partition /dev/sdb6
WARNING: New size of last partition /dev/sdb6 will be smaller than its disk usage was
Shrinking extended partition /dev/sdb3 to end of disk
Shrinked extended partition /dev/sdb3 size from 524288000 to 343932928 bytes
Determining if last partition /dev/sdb6 actually needs to be increased or shrinked
New /dev/sdb is 536870912 smaller than old disk
Last partition /dev/sdb6 must be shrinked by 67108864 bytes to still fit on disk
Shrinking last partition /dev/sdb6 to end of disk (new disk at most 40% smaller)
Changed last partition /dev/sdb6 size from 209715200 to 142606336 bytes
...
Backup restore program 'tar' started in subshell (PID=3826)
Restored 0 MiB [avg. 0 KiB/sec] 
Restoring data.logical2/urandom150MiBs.data 
Restored 177 MiB [avg. 12114 KiB/sec] 
...
Backup restore program 'tar' failed with exit code '2'. Check '/var/log/rear/rear-d57.log' and the restored system.
</pre>

<p>which results that recreated sdb</p>
<pre>
# parted -s /dev/sdb unit MiB print
Model: ATA QEMU HARDDISK (scsi)
Disk /dev/sdb: 1536MiB
Sector size (logical/physical): 512B/512B
Partition Table: msdos
Number  Start    End      Size     Type      File system  Flags
 1      8.00MiB  808MiB   800MiB   primary                type=83
 2      808MiB   1208MiB  400MiB   primary                type=83
 3      1208MiB  1536MiB  328MiB   extended               lba, type=0f
 5      1209MiB  1300MiB  91.0MiB  logical                type=83
 6      1400MiB  1536MiB  136MiB   logical   ext2         type=83
</pre>

<p>and those expected 'tar' error messages in the ReaR log file</p>
<pre>
# grep 'tar:' /var/log/rear/rear-d57.log
tar: data.logical2/urandom150MiBs.data: Wrote only 3584 of 10240 bytes
tar: Exiting with failure status due to previous errors
</pre>

<h4 id="jsmeix_commented_at_2018-03-01_1105"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1733#issuecomment-369557817">2018-03-01 11:05</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-03-01_1105" title="Permanent link">&para;</a></h4>
<p>The last case in<br />
<a href="https://github.com/rear/rear/pull/1733#issuecomment-367317079">https://github.com/rear/rear/pull/1733#issuecomment-367317079</a></p>
<pre>
1400MiB (or less):
error out with some "no space for logical2 on disk" message
</pre>

<p>works o.k for me.</p>
<p>With same 2GiB original sdb as above<br />
I get with a 1331MiB replacement sdb<br />
during "rear recover" (excerpt):</p>
<pre>
Examining /dev/sda to automatically resize its last active partition
Checking /dev/sda1 if it is the last partition on /dev/sda
Checking /dev/sda2 if it is the last partition on /dev/sda
Found 'primary' partition /dev/sda2 as last partition on /dev/sda
Determining if last partition /dev/sda2 is resizeable
Last partition /dev/sda2 not resizeable (used during boot)
Determining new size for last partition /dev/sda2
Determining if last partition /dev/sda2 actually needs to be increased or shrinked
New /dev/sda is 107374592 bigger than old disk
Skip increasing last partition /dev/sda2 (new disk less than 1% bigger)
Examining /dev/sdb to automatically resize its last active partition
Checking /dev/sdb1 if it is the last partition on /dev/sdb
Checking /dev/sdb2 if it is the last partition on /dev/sdb
Checking /dev/sdb3 if it is the last partition on /dev/sdb
Found extended partition /dev/sdb3 on /dev/sdb
Checking /dev/sdb5 if it is the last partition on /dev/sdb
Checking /dev/sdb6 if it is the last partition on /dev/sdb
Found 'logical' partition /dev/sdb6 as last partition on /dev/sdb
Determining if last partition /dev/sdb6 is resizeable
Determining new size for last partition /dev/sdb6
ERROR: No space for last partition /dev/sdb6 on new disk (new last partition size would be less than 1 MiB)
Aborting due to an error, check /var/log/rear/rear-d57.log for details
</pre>

<h4 id="jsmeix_commented_at_2018-03-01_1110"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1733#issuecomment-369559083">2018-03-01 11:10</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-03-01_1110" title="Permanent link">&para;</a></h4>
<p>With same 2GiB original sdb as above<br />
I get with an also 2GiB sized replacement sdb<br />
(but sda is still a bit bigger)<br />
during "rear recover" (excerpt):</p>
<pre>
Examining /dev/sda to automatically resize its last active partition
Checking /dev/sda1 if it is the last partition on /dev/sda
Checking /dev/sda2 if it is the last partition on /dev/sda
Found 'primary' partition /dev/sda2 as last partition on /dev/sda
Determining if last partition /dev/sda2 is resizeable
Last partition /dev/sda2 not resizeable (used during boot)
Determining new size for last partition /dev/sda2
Determining if last partition /dev/sda2 actually needs to be increased or shrinked
New /dev/sda is 107374592 bigger than old disk
Skip increasing last partition /dev/sda2 (new disk less than 1% bigger)
Examining /dev/sdb to automatically resize its last active partition
Skipping /dev/sdb (size of new disk same as size of old disk)
</pre>

<h4 id="jsmeix_commented_at_2018-03-01_1116"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1733#issuecomment-369560355">2018-03-01 11:16</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-03-01_1116" title="Permanent link">&para;</a></h4>
<p>With same sized replacement sda and sdb<br />
all works for me as before.</p>
<p>Of course not really as before with current master code! :-)</p>
<p>Now I get byte-by-byte identical partitioning on sdb,<br />
in particular with exactly all the gaps as on the original system.</p>
<h4 id="jsmeix_commented_at_2018-03-01_1130"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1733#issuecomment-369563496">2018-03-01 11:30</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-03-01_1130" title="Permanent link">&para;</a></h4>
<p>With same sized replacement sda<br />
but replacement sdb is more than<br />
AUTOINCREASE_DISK_SIZE_THRESHOLD_PERCENTAGE=1<br />
bigger I get during "rear recover" (excerpt):</p>
<pre>
Examining /dev/sda to automatically resize its last active partition
Skipping /dev/sda (size of new disk same as size of old disk)
Examining /dev/sdb to automatically resize its last active partition
Checking /dev/sdb1 if it is the last partition on /dev/sdb
Checking /dev/sdb2 if it is the last partition on /dev/sdb
Checking /dev/sdb3 if it is the last partition on /dev/sdb
Found extended partition /dev/sdb3 on /dev/sdb
Checking /dev/sdb5 if it is the last partition on /dev/sdb
Checking /dev/sdb6 if it is the last partition on /dev/sdb
Found 'logical' partition /dev/sdb6 as last partition on /dev/sdb
Determining if last partition /dev/sdb6 is resizeable
Determining new size for last partition /dev/sdb6
Determining if last partition /dev/sdb6 actually needs to be increased or shrinked
New /dev/sdb is 214749184 bigger than old disk
Increasing last partition /dev/sdb6 up to end of disk (new disk at least 1% bigger)
Increasing extended partition /dev/sdb3 up to end of disk
Changed last partition /dev/sdb6 size from 209715200 to 893386752 bytes
Increased extended partition /dev/sdb3 size from 524288000 to 1094713344 bytes
</pre>

<p>and this partitioning on sdb</p>
<pre>
# parted -s /dev/sdb unit MiB print
Model: ATA QEMU HARDDISK (scsi)
Disk /dev/sdb: 2253MiB
Sector size (logical/physical): 512B/512B
Partition Table: msdos
Number  Start    End      Size     Type      File system  Flags
 1      8.00MiB  808MiB   800MiB   primary                type=83
 2      808MiB   1208MiB  400MiB   primary                type=83
 3      1208MiB  2252MiB  1044MiB  extended               lba, type=0f
 5      1209MiB  1300MiB  91.0MiB  logical                type=83
 6      1400MiB  2252MiB  852MiB   logical   ext2         type=83
</pre>

<p>Note that only partition end values (and therefore partition sizes) got
changed.<br />
No partition start value was changed so no change in any partition
alignment.<br />
For easier comparison the original sdb (still same as above) here again:</p>
<pre>
# parted -s /dev/sdb unit MiB print
Model: ATA QEMU HARDDISK (scsi)
Disk /dev/sdb: 2048MiB
Sector size (logical/physical): 512B/512B
Partition Table: msdos
Number  Start    End      Size     Type      File system     Flags
 1      8.00MiB  808MiB   800MiB   primary   ext2            type=83
 2      808MiB   1208MiB  400MiB   primary   linux-swap(v1)  type=82
 3      1208MiB  1708MiB  500MiB   extended                  lba, type=0f
 5      1209MiB  1300MiB  91.0MiB  logical   ext2            type=83
 6      1400MiB  1600MiB  200MiB   logical   ext2            type=83
</pre>

<p>Only /dev/sdb6 is mounted on /data.logical2 which is the reason<br />
why no other filesystems were re-created during "rear recover".</p>
<h4 id="jsmeix_commented_at_2018-03-01_1133"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1733#issuecomment-369564284">2018-03-01 11:33</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-03-01_1133" title="Permanent link">&para;</a></h4>
<p>Unless there are furious objections right now<br />
I will merge it after lunch (i.e. in about one hour).</p>
<p>Of course I will fix bugs that appear when things get tested<br />
also by other users on other systems "out there".</p>
<h4 id="gdha_commented_at_2018-03-01_1141"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/pull/1733#issuecomment-369565950">2018-03-01 11:41</a>:<a class="headerlink" href="#gdha_commented_at_2018-03-01_1141" title="Permanent link">&para;</a></h4>
<p>@jsmeix because you were so brave to work on this damn complicated code
you have my blessing </p>
<h4 id="jsmeix_commented_at_2018-03-01_1313"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1733#issuecomment-369587629">2018-03-01 13:13</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-03-01_1313" title="Permanent link">&para;</a></h4>
<p>I used the code of my last commit here<br />
<a href="https://github.com/rear/rear/pull/1733/commits/c09bae8c230b55ae5c9310af0c2bb040bd97c712">https://github.com/rear/rear/pull/1733/commits/c09bae8c230b55ae5c9310af0c2bb040bd97c712</a><br />
on my local test system for my tests starting at<br />
<a href="https://github.com/rear/rear/pull/1733#issuecomment-369548894">https://github.com/rear/rear/pull/1733#issuecomment-369548894</a><br />
i.e. the code of my last commit was tested by me.</p>
<h4 id="jsmeix_commented_at_2018-03-01_1315"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1733#issuecomment-369588015">2018-03-01 13:15</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-03-01_1315" title="Permanent link">&para;</a></h4>
<p>@gdha<br />
thank you very much for your faith in me,<br />
it is very much appreciated!</p>
<h4 id="jsmeix_commented_at_2018-03-01_1342"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1733#issuecomment-369594835">2018-03-01 13:42</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-03-01_1342" title="Permanent link">&para;</a></h4>
<p>Phew!</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2023 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2018-02-16.1733.pr.merged.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
