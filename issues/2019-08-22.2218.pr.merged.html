<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#2218 PR merged: Do not keep the build dir when used noninteractively - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#2218 PR merged: Do not keep the build dir when used noninteractively";
        var mkdocs_page_input_path = "issues/2019-08-22.2218.pr.merged.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#2218 PR merged: Do not keep the build dir when used noninteractively</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="2218_pr_merged_do_not_keep_the_build_dir_when_used_noninteractively"><a href="https://github.com/rear/rear/pull/2218">#2218 PR</a> <code>merged</code>: Do not keep the build dir when used noninteractively<a class="headerlink" href="#2218_pr_merged_do_not_keep_the_build_dir_when_used_noninteractively" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>cleanup</code>, <code>fixed / solved / done</code></p>
<h4 id="pcahyna_opened_issue_at_2019-08-22_0959"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> opened issue at <a href="https://github.com/rear/rear/pull/2218">2019-08-22 09:59</a>:<a class="headerlink" href="#pcahyna_opened_issue_at_2019-08-22_0959" title="Permanent link">&para;</a></h4>
<p>Print helpful messages about keeping/not keeping the build directory in
case of errors.</p>
<h4 id="relax-and-recover_rear_pull_request_template">Relax-and-Recover (ReaR) Pull Request Template<a class="headerlink" href="#relax-and-recover_rear_pull_request_template" title="Permanent link">&para;</a></h4>
<p>Please fill in the following items before submitting a new pull request:</p>
<h5 id="pull_request_details">Pull Request Details:<a class="headerlink" href="#pull_request_details" title="Permanent link">&para;</a></h5>
<ul>
<li>
<p>Type: <strong>Bug Fix</strong></p>
</li>
<li>
<p>Impact: <strong>High</strong></p>
</li>
<li>
<p>Reference to related issue (URL):<br />
    #2121,
    <a href="https://bugzilla.redhat.com/show_bug.cgi?id=1693608">https://bugzilla.redhat.com/show_bug.cgi?id=1693608</a></p>
</li>
<li>
<p>How was this pull request tested?</p>
</li>
</ul>
<!-- -->

<pre><code>yum -y install rear
echo 'COPY_AS_IS+=( /usr/bin/xterm )' &gt;&gt; /etc/rear/local.conf
yum -y install xterm
rpm  -e --nodeps libXaw.x86_64 # don't do it on a workstation
</code></pre>
<p>This makes ReaR complain about broken xterm and abort. To test it
interactively:</p>
<pre><code>rear mkrescue
</code></pre>
<p>Result:</p>
<pre><code>Broken symlink '/usr/lib/modules/3.10.0-1077.el7.x86_64/build' in recovery system because 'readlink' cannot determine its link target
Broken symlink '/usr/lib/modules/3.10.0-1077.el7.x86_64/source' in recovery system because 'readlink' cannot determine its link target
There are binaries or libraries in the ReaR recovery system that need additional libraries
/bin/xterm requires additional libraries (fatal error)
        libXaw.so.7 =&gt; not found
Build area kept for investigation in /tmp/rear.YiON7zQALRvXj6Q, remove it when not needed
ReaR recovery system in '/tmp/rear.YiON7zQALRvXj6Q/rootfs' needs additional libraries, check /root/rear/var/log/rear/rear-ci-vm-10-0-137-193.log for details
ERROR: ReaR recovery system in '/tmp/rear.YiON7zQALRvXj6Q/rootfs' not usable (required libraries are missing)
Some latest log messages since the last called script 990_verify_rootfs.sh:
  stty is /bin/stty
  parted is /bin/parted
  partprobe is /bin/partprobe
  wipefs is /bin/wipefs
  mkfs is /bin/mkfs
  mkfs.xfs is /bin/mkfs.xfs
  xfs_admin is /bin/xfs_admin
  ldconfig is /bin/ldconfig
Aborting due to an error, check /root/rear/var/log/rear/rear-ci-vm-10-0-137-193.log for details
Terminated
</code></pre>
<p>To test noninteractively:</p>
<pre><code>crontab -e
#add
#*/5 * * * * /usr/sbin/rear mkrescue
</code></pre>
<p>and wait several minutes. Mail from cron will read:</p>
<pre><code>There are binaries or libraries in the ReaR recovery system that need additional
 libraries
Build area /tmp/rear.pHJTicEpfOCMZVf will be removed
To preserve it for investigation set KEEP_BUILD_DIR=1 or run ReaR with -d
/bin/xterm requires additional libraries (fatal error)
        libXaw.so.7 =&gt; not found
ERROR: ReaR recovery system in '/tmp/rear.pHJTicEpfOCMZVf/rootfs' not usable
Aborting due to an error, check /var/log/rear/rear-ci-vm-10-0-137-193.log for details
</code></pre>
<ul>
<li>Brief description of the changes in this pull request:<br />
    The rear package in Fedora and derived distributions drops a file to
    /etc/cron.d which runs <code>rear mkrescue</code>.<br />
    When the recovery system is broken (an example is #2144),
    <code>rear mkrescue</code> will fail and leave the build area behind, without
    giving a hint that the build area should be removed (because this
    hit is printed only when running rear with the -v flag).<br />
    This change:<ul>
<li>does not disable the removal of the build area when used
    noninteractively - instead it gives a hint how to keep the build
    area should one really want it</li>
<li>when the build area is kept, print a more prominent message,
    even when run without -v.</li>
</ul>
</li>
</ul>
<h4 id="pcahyna_commented_at_2019-08-22_1011"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/2218#issuecomment-523840886">2019-08-22 10:11</a>:<a class="headerlink" href="#pcahyna_commented_at_2019-08-22_1011" title="Permanent link">&para;</a></h4>
<p>The description of KEEP_BUILD_DIR from #2121 should be updated
together with this change.</p>
<h4 id="pcahyna_commented_at_2019-08-28_1053"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/2218#issuecomment-525691641">2019-08-28 10:53</a>:<a class="headerlink" href="#pcahyna_commented_at_2019-08-28_1053" title="Permanent link">&para;</a></h4>
<blockquote>
<p>The description of KEEP_BUILD_DIR from #2121 should be updated
together with this change.</p>
</blockquote>
<p>Done.</p>
<h4 id="pcahyna_commented_at_2019-08-29_0945"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/2218#issuecomment-526111008">2019-08-29 09:45</a>:<a class="headerlink" href="#pcahyna_commented_at_2019-08-29_0945" title="Permanent link">&para;</a></h4>
<p>according to a review by @xjezda00, I introduced a new variable
<code>KEEP_BUILD_DIR_ON_ERRORS</code> which can be used to restore the previous
behaviour of keeping the build dir on errors always by setting it to
<code>yes</code>.</p>
<h4 id="pcahyna_commented_at_2019-08-29_1045"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/2218#issuecomment-526131568">2019-08-29 10:45</a>:<a class="headerlink" href="#pcahyna_commented_at_2019-08-29_1045" title="Permanent link">&para;</a></h4>
<p>see
<a href="https://bugzilla.redhat.com/show_bug.cgi?id=1693608#c4">https://bugzilla.redhat.com/show_bug.cgi?id=1693608#c4</a></p>
<h4 id="jsmeix_commented_at_2019-08-29_1116"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2218#issuecomment-526141095">2019-08-29 11:16</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-08-29_1116" title="Permanent link">&para;</a></h4>
<p>I am still not in the office and will not be for some more weeks<br />
so I cannot actually work on ReaR.</p>
<h4 id="jsmeix_commented_at_2019-08-29_1140"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2218#issuecomment-526147673">2019-08-29 11:40</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-08-29_1140" title="Permanent link">&para;</a></h4>
<p>Offhandedly I think I did it wrong to set KEEP_BUILD_DIR=1 in a
script<br />
because this is against what the user specified and I am in general
against it<br />
when ReaR works in an automated way against the user because I want<br />
the user to always have the final power.</p>
<p>So if the user wants to keep the build directory for whatever reason<br />
he can run ReaR with the -D option or he can specify
KEEP_BUILD_DIR=1<br />
in his etc/rear/local.conf file.</p>
<p>So from my current point of view I think the right, clean, and simple
solution is<br />
to remove the KEEP_BUILD_DIR=1 settings from the
990_verify_rootfs.sh script.</p>
<p>Furthermore that I had not added a comment that explains why I thought<br />
it would be right to set KEEP_BUILD_DIR=1 in 990_verify_rootfs.sh<br />
(which is against
<a href="https://github.com/rear/rear/wiki/Coding-Style">https://github.com/rear/rear/wiki/Coding-Style</a>)<br />
basically proves that I had done that without a real good reason.</p>
<p>Finally that the current attempts to solve it result more and more<br />
complicated code indicate that the actual root cause is "something
else"<br />
(i.e. the actual root cause are my wrong hardcoded KEEP_BUILD_DIR=1<br />
settings in the 990_verify_rootfs.sh script).</p>
<h4 id="pcahyna_commented_at_2019-08-29_1153"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/2218#issuecomment-526151452">2019-08-29 11:53</a>:<a class="headerlink" href="#pcahyna_commented_at_2019-08-29_1153" title="Permanent link">&para;</a></h4>
<blockquote>
<p>Offhandedly I think I did it wrong to set KEEP_BUILD_DIR=1 in a
script</p>
</blockquote>
<p>I found it strange as well. Just removing it would be definitely a
simplification, but it would be less helpful for debugging of errors, as
@xjezda00 pointed out in
<a href="https://bugzilla.redhat.com/show_bug.cgi?id=1693608#c4">https://bugzilla.redhat.com/show_bug.cgi?id=1693608#c4</a>
. I would recommend keeping the error message part of the PR if this
solution is accepted:<br />
<a href="https://github.com/rear/rear/pull/2218/files#diff-14e72ffdba2836896118ed562369b421R27">https://github.com/rear/rear/pull/2218/files#diff-14e72ffdba2836896118ed562369b421R27</a></p>
<h4 id="jsmeix_commented_at_2019-08-29_1153"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2218#issuecomment-526151458">2019-08-29 11:53</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-08-29_1153" title="Permanent link">&para;</a></h4>
<p>@schlomo<br />
I added you as reviewer here because I would like to get your opinion<br />
about the generic issue that lays behind here:</p>
<p>I had added a hardcoded KEEP_BUILD_DIR=1 in 990_verify_rootfs.sh<br />
when that script detects an error in the ReaR recovery system so that<br />
the user could directy inspect the contents of the recovery system<br />
without the need to re-run "rear mkrescue" with the -D option<br />
or with KEEP_BUILD_DIR=1 explicitly set by the user.</p>
<p>But this way it works in case of an error against what the user had<br />
specified when he runs it without -D or without KEEP_BUILD_DIR=1.</p>
<h4 id="jsmeix_commented_at_2019-08-29_1219"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2218#issuecomment-526159770">2019-08-29 12:19</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-08-29_1219" title="Permanent link">&para;</a></h4>
<p>@pcahyna<br />
more clear messages that help the user to better understand what goes
on<br />
are much appreciated.</p>
<p>By the way:</p>
<p>Another generic improvement could be to make KEEP_BUILD_DIR a ternary
variable<br />
(but that requires changes at all places where KEEP_BUILD_IR is
used)<br />
so that the user gets real final power to enforce "yes" or "no" as he
wants.</p>
<p>Currently KEEP_BUILD_DIR="no" behaves same as KEEP_BUILD_DIR=1<br />
because of the "non-empty means yes" boolean behaviour in ReaR, cf.<br />
<a href="https://github.com/rear/rear/blob/master/usr/share/rear/lib/framework-functions.sh#L124">https://github.com/rear/rear/blob/master/usr/share/rear/lib/framework-functions.sh#L124</a><br />
which is confusing for the user and currently we cannot decide in our
code<br />
if the user actually wants "no" when KEEP_BUILD_DIR is empty.<br />
I.e. currently we cannot distinguish between the default value<br />
and an enforced user setting.</p>
<h4 id="pcahyna_commented_at_2019-08-29_1223"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/2218#issuecomment-526160944">2019-08-29 12:23</a>:<a class="headerlink" href="#pcahyna_commented_at_2019-08-29_1223" title="Permanent link">&para;</a></h4>
<blockquote>
<p>@pcahyna<br />
more clear messages that help the user to better understand what goes
on<br />
are much appreciated.</p>
<p>By the way:</p>
<p>Another generic improvement could be to make KEEP_BUILD_DIR a
ternary variable<br />
(but that requires changes at all places where KEEP_BUILD_IR is
used)<br />
so that the user gets real final power to enforce "yes" or "no" as he
wants.</p>
<p>Currently KEEP_BUILD_DIR="no" behaves same as KEEP_BUILD_DIR=1<br />
because of the "non-empty means yes" boolean behaviour in ReaR, cf.<br />
<a href="https://github.com/rear/rear/blob/master/usr/share/rear/lib/framework-functions.sh#L124">https://github.com/rear/rear/blob/master/usr/share/rear/lib/framework-functions.sh#L124</a><br />
which is confusing for the user and currently we cannot decide in our
code<br />
if the user actually wants "no" when KEEP_BUILD_DIR is empty.<br />
I.e. currently we cannot distinguish between the default value<br />
and an enforced user setting.</p>
</blockquote>
<p>That was my thinking as well. I wanted to use the empty value as meaning
"not set by user", but then I realized that it already means "false".
Unfortunately, switching it to ternary means a compatibility break. By
the way, your reasoning that "non-empty means yes" is confusing for the
user is valid, but applies to most of the variables, because this
boolean (not ternary) semantics is very common in ReaR.</p>
<h4 id="jsmeix_commented_at_2019-08-29_1237"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2218#issuecomment-526165477">2019-08-29 12:37</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-08-29_1237" title="Permanent link">&para;</a></h4>
<p>@pcahyna<br />
I don't think that switching it to ternary means a compatibility break<br />
as long as "empty" means "no" by default/fallback<br />
(and "yes" if the -D option is used).</p>
<p>But an explicit KEEP_BUILD_DIR="no" would enforce<br />
that BUILD_DIR is never kept.</p>
<p>This way we would be able to set KEEP_BUILD_DIR="yes" in a script<br />
but only if it is not already set to "no".</p>
<p>And then we might even still set it in 990_verify_rootfs.sh as
follows<br />
(provided we come to the conclusion it is really a good idea to do that)</p>
<pre><code>if ERROR_CONDITION ; then
    # Keep BUILD_DIR for easier debugging of the error
    # unless the user had explicitly specified he never wants that:
    is_false "$KEEP_BUILD_DIR" || KEEP_BUILD_DIR="yes"
    Error "..."
</code></pre>
<h4 id="pcahyna_commented_at_2019-08-29_1414"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/2218#issuecomment-526204804">2019-08-29 14:14</a>:<a class="headerlink" href="#pcahyna_commented_at_2019-08-29_1414" title="Permanent link">&para;</a></h4>
<p>@jsmeix Indeed, this we do not break compatibility in the usual case,
where the user sets KEEP_BUILD_DIR to a string accepted by <code>is_true</code>
to indicate <code>yes</code>. (Potential problem is, anything that is not false and
is not empty is now treated as true, which would not be compatible with
the change. (A particularly silly case is if the user sets
KEEP_BUILD_DIR to 0 or "no" to mean "yes".))</p>
<p>Still, your snippet does not address the concern that by default,
automated runs of ReaR clutter /tmp on errors. We could do</p>
<pre><code>if ! is_false "$KEEP_BUILD_DIR" &amp;&amp; tty -s; then
   KEEP_BUILD_DIR="yes"
</code></pre>
<p>but it would be not possible to get the previous behaviour (keep the
build dir on error only) - @xjezda00 's concern.</p>
<pre><code>if ! is_false "$KEEP_BUILD_DIR" &amp;&amp;  { tty -s || test "$KEEP_BUILD_DIR" == errors; }; then
   KEEP_BUILD_DIR="yes"
</code></pre>
<p>would do it (there would be a special value "errors" which would
indicate, keep it only on errors).</p>
<h4 id="pcahyna_commented_at_2019-08-29_1530"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/2218#issuecomment-526239286">2019-08-29 15:30</a>:<a class="headerlink" href="#pcahyna_commented_at_2019-08-29_1530" title="Permanent link">&para;</a></h4>
<p>What to do with scripts that check the value of KEEP_BUILD_DIR before
990_verify_rootfs.sh modifies it? Such as
build/OPALPBA/Linux-i386/391_list_executable_dependencies.sh (
<a href="https://github.com/rear/rear/pull/1659/files#diff-94b2089c3ecae157af07001369db4783">https://github.com/rear/rear/pull/1659/files#diff-94b2089c3ecae157af07001369db4783</a>
), which is now maybe the only one, but in the future there may be more
of them.</p>
<h4 id="jsmeix_commented_at_2019-08-30_1715"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2218#issuecomment-526679705">2019-08-30 17:15</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-08-30_1715" title="Permanent link">&para;</a></h4>
<p>@pcahyna<br />
I would assume that users who set KEEP_BUILD_DIR to a strange value<br />
have to expect strange things ;-)<br />
When someone sets it to "no" and now it behaves this way,<br />
I think this change is rather a fix than a regression.<br />
When someone sets it to 'X' that neither <code>is_true</code> nor <code>is_false</code><br />
he wold get the default behaviour which is a minor regression for him.<br />
Of course we would document such a change in the release notes<br />
so the users are informed.<br />
I think we cannot keep 100.0% backward compatibility in any case<br />
when there is a good reason for a change with minimal regressions.<br />
We did several such changes in the past, cf. the various<br />
"backward incompatible changes" parts in our release notes<br />
<a href="https://github.com/rear/rear/blob/master/doc/rear-release-notes.txt">https://github.com/rear/rear/blob/master/doc/rear-release-notes.txt</a></p>
<p>I like variables that have in the end a boolean 'yes/no' meaning<br />
but also support enhanced ways to specify more exactly how things are
meant<br />
so I like it when KEEP_BUILD_DIR="errors" means "yes but only in case
of errors".</p>
<p>I do not see a problem with scripts that check KEEP_BUILD_DIR.<br />
For example <code>if is_true $KEEP_BUILD_DIR; then</code> in<br />
<a href="https://github.com/rear/rear/pull/1659/files#diff-94b2089c3ecae157af07001369db4783">https://github.com/rear/rear/pull/1659/files#diff-94b2089c3ecae157af07001369db4783</a><br />
looks fine to me in particular when KEEP_BUILD_DIR gets ternary
semantics.</p>
<h4 id="pcahyna_commented_at_2019-08-30_1722"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/2218#issuecomment-526681790">2019-08-30 17:22</a>:<a class="headerlink" href="#pcahyna_commented_at_2019-08-30_1722" title="Permanent link">&para;</a></h4>
<blockquote>
<p>I like variables that have in the end a boolean 'yes/no' meaning<br />
but also support enhanced ways to specify more exactly how things are
meant<br />
so I like it when KEEP_BUILD_DIR="errors" means "yes but only in
case of errors".</p>
</blockquote>
<p>Ok, I will update the PR to introduce this semantics instead of
<code>KEEP_BUILD_DIR_ON_ERRORS</code>.</p>
<blockquote>
<p>I do not see a problem with scripts that check KEEP_BUILD_DIR.<br />
For example <code>if is_true $KEEP_BUILD_DIR; then</code> in<br />
<a href="https://github.com/rear/rear/pull/1659/files#diff-94b2089c3ecae157af07001369db4783">https://github.com/rear/rear/pull/1659/files#diff-94b2089c3ecae157af07001369db4783</a><br />
looks fine to me in particular when KEEP_BUILD_DIR gets ternary
semantics.</p>
</blockquote>
<p>The problem is that this script checks the value, then
990_verify_rootfs.sh changes it to something else (it is sourced
after).</p>
<h4 id="jsmeix_commented_at_2019-08-30_1752"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2218#issuecomment-526691325">2019-08-30 17:52</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-08-30_1752" title="Permanent link">&para;</a></h4>
<p>@pcahyna<br />
you are right.</p>
<p>I had thought 990_verify_rootfs.sh sets KEEP_BUILD_DIR=1<br />
only when it errors out.</p>
<p>But now I see there are two cases where 990_verify_rootfs.sh<br />
sets KEEP_BUILD_DIR=1 but does not error out later:</p>
<pre><code>if contains_visible_char "$broken_binaries" ; then
    LogPrintError "There are binaries or libraries in the ReaR recovery system that need additional libraries"
    KEEP_BUILD_DIR=1
    ...
                    LogPrintError "$binary requires additional libraries (specified as non-fatal)"
    ...
            LogPrintError "$binary requires additional libraries"
</code></pre>
<p>In those two cases <code>fatal_missing_library="yes"</code> is not set.<br />
This needs to be corrected because there is no reason<br />
to automatically keep BUILD_DIR when there is no error.</p>
<h4 id="jsmeix_commented_at_2019-08-30_1801"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2218#issuecomment-526694301">2019-08-30 18:01</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-08-30_1801" title="Permanent link">&para;</a></h4>
<p>I mean that in those two cases where <code>fatal_missing_library="yes"</code><br />
is (correctly) not set, it needs to be corrected that
KEEP_BUILD_DIR=1<br />
is set.<br />
E.g. the KEEP_BUILD_DIR=1 at the beginning of the <code>if</code> clause<br />
must be removed and at each place where <code>fatal_missing_library="yes"</code> is
set<br />
also KEEP_BUILD_DIR=1 must be set.<br />
Alternatively KEEP_BUILD_DIR=1 can be set directly before the BugError
and Error calls<br />
at the end of the script.</p>
<h4 id="pcahyna_commented_at_2019-09-02_1227"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/2218#issuecomment-527129489">2019-09-02 12:27</a>:<a class="headerlink" href="#pcahyna_commented_at_2019-09-02_1227" title="Permanent link">&para;</a></h4>
<p>@jsmeix I had something else in mind than the problem you have found.
The issue is that
<code>build/OPALPBA/Linux-i386/391_list_executable_dependencies.sh</code> gets
sourced, <code>KEEP_BUILD_DIR</code> is not true, then <code>990_verify_rootfs.sh</code> gets
sourced and can set <code>KEEP_BUILD_DIR</code> to true. But
<code>build/OPALPBA/Linux-i386/391_list_executable_dependencies.sh</code> behaved
as if it were not true, i.e. the behaviour was inconsistent with the
final value.</p>
<h4 id="pcahyna_commented_at_2019-09-03_1036"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/2218#issuecomment-527403381">2019-09-03 10:36</a>:<a class="headerlink" href="#pcahyna_commented_at_2019-09-03_1036" title="Permanent link">&para;</a></h4>
<p>@jsmeix I pushed a commit to address your last comment.</p>
<h4 id="pcahyna_commented_at_2019-09-03_1221"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/2218#issuecomment-527434333">2019-09-03 12:21</a>:<a class="headerlink" href="#pcahyna_commented_at_2019-09-03_1221" title="Permanent link">&para;</a></h4>
<p>@jsmeix I pushed a commit to implement what I proposed (changes to
default.conf to be done).</p>
<h4 id="jsmeix_commented_at_2019-09-03_1231"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2218#issuecomment-527437472">2019-09-03 12:31</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-09-03_1231" title="Permanent link">&para;</a></h4>
<p>As far as I understand the code in<br />
build/OPALPBA/Linux-i386/391_list_executable_dependencies.sh<br />
the intent is to do that when the user had set KEEP_BUILD_DIR.<br />
@OliverO2 may explain his intent behind here in more detail.</p>
<p>In contrast we set KEEP_BUILD_DIR automatically in<br />
990_verify_rootfs.sh only when it errors out because<br />
here the intent is to make debugging easier for the user.</p>
<p>So I think that both intents are independent of each other<br />
so that the default behaviour does not need to be the same<br />
for different intents.</p>
<p>For me a crucial point is "final power to the user" so that an<br />
explicit user setting KEEP_BUILD_DIR="no" must be obeyed<br />
which means we must not automatically set KEEP_BUILD_DIR=1<br />
i.e. ReaR must not work against what its user has specified.</p>
<h4 id="pcahyna_commented_at_2019-09-03_1253"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/2218#issuecomment-527444958">2019-09-03 12:53</a>:<a class="headerlink" href="#pcahyna_commented_at_2019-09-03_1253" title="Permanent link">&para;</a></h4>
<p>@jsmeix</p>
<blockquote>
<p>For me a crucial point is "final power to the user" so that an<br />
explicit user setting KEEP_BUILD_DIR="no" must be obeyed<br />
which means we must not automatically set KEEP_BUILD_DIR=1<br />
i.e. ReaR must not work against what its user has specified.</p>
</blockquote>
<p>this should be the effect of the last changes. I rebased the last commit
to include updates to the description in default.conf, so it is ready to
be reviewed, and, after testing, merged.</p>
<h4 id="jsmeix_commented_at_2019-09-03_1510"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2218#issuecomment-527502722">2019-09-03 15:10</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-09-03_1510" title="Permanent link">&para;</a></h4>
<p>@rear/contributors<br />
I am still not in the office and will not be for some more weeks<br />
so I cannot actually test anything in ReaR.<br />
Therefore I would appreciate it when one of you<br />
could also review it and merge it if it is o.k.</p>
<h4 id="gdha_commented_at_2019-09-13_0631"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/pull/2218#issuecomment-531116149">2019-09-13 06:31</a>:<a class="headerlink" href="#gdha_commented_at_2019-09-13_0631" title="Permanent link">&para;</a></h4>
<p>@rear/contributors for me it is ok and for you?</p>
<h4 id="rmetrich_commented_at_2019-09-13_0735"><img src="https://avatars.githubusercontent.com/u/1163635?u=36b5e32e1dd55f1ce77cad431a5683fce40a7934&v=4" width="50"><a href="https://github.com/rmetrich">rmetrich</a> commented at <a href="https://github.com/rear/rear/pull/2218#issuecomment-531133186">2019-09-13 07:35</a>:<a class="headerlink" href="#rmetrich_commented_at_2019-09-13_0735" title="Permanent link">&para;</a></h4>
<p>@gdha It's ok for me</p>
<h4 id="jsmeix_commented_at_2019-09-17_1115"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2218#issuecomment-532175986">2019-09-17 11:15</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-09-17_1115" title="Permanent link">&para;</a></h4>
<p>@gdha @rmetrich<br />
thank you for your review.</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2023 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2019-08-22.2218.pr.merged.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
