<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>2019 08 11.2204.issue.closed - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "2019 08 11.2204.issue.closed";
        var mkdocs_page_input_path = "issues/2019-08-11.2204.issue.closed.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/rust.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', '366986045', 'auto');
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a> &raquo;</li>
      <li>2019 08 11.2204.issue.closed</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="2204_issue_closed_failed_to_recover_luks_version_2"><a href="https://github.com/rear/rear/issues/2204">#2204 Issue</a> <code>closed</code>: Failed to recover LUKS version 2<a class="headerlink" href="#2204_issue_closed_failed_to_recover_luks_version_2" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>enhancement</code>, <code>fixed / solved / done</code></p>
<h4 id="adatum_opened_issue_at_2019-08-11_0819"><img src="https://avatars.githubusercontent.com/u/9773655?v=4" width="50"><a href="https://github.com/adatum">adatum</a> opened issue at <a href="https://github.com/rear/rear/issues/2204">2019-08-11 08:19</a>:<a class="headerlink" href="#adatum_opened_issue_at_2019-08-11_0819" title="Permanent link">&para;</a></h4>
<ul>
<li>
<p>ReaR version ("/usr/sbin/rear -V"): 2.4 and 2.5</p>
</li>
<li>
<p>OS version ("cat /etc/rear/os.conf" or "lsb_release -a" or "cat
    /etc/os-release"): Fedora 30</p>
</li>
<li>
<p>ReaR configuration files ("cat /etc/rear/site.conf" and/or "cat
    /etc/rear/local.conf"):</p>
</li>
</ul>
<!-- -->

<pre><code>PROGS=( "${PROGS[@]}" /home/test/Downloads/borg-linux64 )
</code></pre>
<ul>
<li>
<p>Hardware (PC or PowerNV BareMetal or ARM) or virtual machine (KVM
    guest or PoverVM LPAR): Virtualbox VM</p>
</li>
<li>
<p>System architecture (x86 compatible or PPC64/PPC64LE or what exact
    ARM device): x86_64</p>
</li>
<li>
<p>Firmware (BIOS or UEFI or Open Firmware) and bootloader (GRUB or
    ELILO or Petitboot): UEFI</p>
</li>
<li>
<p>Storage (local disk or SSD) and/or SAN (FC or iSCSI or FCoE) and/or
    multipath (DM or NVMe): local SSD</p>
</li>
<li>
<p>Description of the issue (ideally so that others can reproduce
    it):<br />
    The disk layout recreation script fails after printing a message
    asking for the LUKS password, but never giving a chance to enter it.
    I tried rerunning it, but each time it skips to exactly the same
    point asking the options seen in the screenshot.</p>
</li>
</ul>
<p><img alt="rear_luks_fail" src="https://user-images.githubusercontent.com/9773655/62831528-f0ea2c80-bbee-11e9-9f99-5e1d5d997b32.png" /></p>
<h4 id="gozora_commented_at_2019-08-11_0930"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/2204#issuecomment-520213704">2019-08-11 09:30</a>:<a class="headerlink" href="#gozora_commented_at_2019-08-11_0930" title="Permanent link">&para;</a></h4>
<p>Can you please test if you have same behavior with ReaR 2.2 ?</p>
<p>V.</p>
<h4 id="adatum_commented_at_2019-08-11_1745"><img src="https://avatars.githubusercontent.com/u/9773655?v=4" width="50"><a href="https://github.com/adatum">adatum</a> commented at <a href="https://github.com/rear/rear/issues/2204#issuecomment-520246951">2019-08-11 17:45</a>:<a class="headerlink" href="#adatum_commented_at_2019-08-11_1745" title="Permanent link">&para;</a></h4>
<p>Here's the log after it failed with rear-2.2:</p>
<p><img alt="rear_luks_error_log" src="https://user-images.githubusercontent.com/9773655/62837505-397d0680-bc3e-11e9-9346-dae2cab2b116.png" /></p>
<h4 id="gozora_commented_at_2019-08-11_1816"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/2204#issuecomment-520249066">2019-08-11 18:16</a>:<a class="headerlink" href="#gozora_commented_at_2019-08-11_1816" title="Permanent link">&para;</a></h4>
<p>heh, this is even worse ... Never mind it was worth a try ;-).</p>
<p>Could you provide debug log from session executed with your most recent
ReaR (guess it was 2.4)</p>
<p>V.</p>
<h4 id="adatum_commented_at_2019-08-11_1853"><img src="https://avatars.githubusercontent.com/u/9773655?v=4" width="50"><a href="https://github.com/adatum">adatum</a> commented at <a href="https://github.com/rear/rear/issues/2204#issuecomment-520251443">2019-08-11 18:53</a>:<a class="headerlink" href="#adatum_commented_at_2019-08-11_1853" title="Permanent link">&para;</a></h4>
<p>Here is the log file from <code>rear -vD recover</code> with RearR 2.5</p>
<p><a href="https://github.com/rear/rear/files/3490325/rear-localhost.log">rear-localhost.log</a></p>
<p>This time I noticed a couple of message about UserInput. I'm not sure
what they mean:<br />
<img alt="rear_UserInput" src="https://user-images.githubusercontent.com/9773655/62838313-574f6900-bc48-11e9-82eb-eddc886edf14.png" /><br />
Additional notes:</p>
<ul>
<li>
<p>Is it normal to be asked for a login? When ReaR finishes booting, it
    stops at the line in the screenshot with "[OK] Reached target
    Multi-User." Then if I press enter I see "localhost login:", which
    accepts any input (notice I typed "blah"). Is this expected
    behavior? It has been consistent between ReaR 2.2, 2.4, and 2.5.</p>
</li>
<li>
<p>To get <code>rear mkrescue</code> to succeed in creating an ISO, as stated in
    <a href="https://github.com/rear/rear/issues/1996#issuecomment-446389799">another
    issue</a>,
    I must always remove "multiboot" from I believe line 49 of
    <code>/usr/share/rear/lib/uefi-functions.sh</code> for ReaR versions 2.2, 2.4,
    and 2.5, and also "linuxefi" for ReaR 2.2 and 2.4, but not 2.5.</p>
</li>
</ul>
<h4 id="gozora_commented_at_2019-08-11_1909"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/2204#issuecomment-520252480">2019-08-11 19:09</a>:<a class="headerlink" href="#gozora_commented_at_2019-08-11_1909" title="Permanent link">&para;</a></h4>
<p>@adatum<br />
Your problem is on line 3750 of your <em>rear-localhost.log</em>.<br />
Executed code from
<a href="https://github.com/rear/rear/blob/master/usr/share/rear/layout/prepare/GNU/Linux/160_include_luks_code.sh#L57">160_include_luks_code.sh</a>,
in your particular case:
<code>cryptsetup luksFormat --batch-mode --cipher - --key-size --hash --uuid 974b19f8-021a-46b6-a089-a46e06e6e746 --iter-time 2000 --use-random /dev/sda3</code>
does not have any "safety net", meaning if it fails you will get exactly
this behavior (prompt for password will be ignored)</p>
<p>Your command
<code>cryptsetup luksFormat --batch-mode --cipher - --key-size --hash --uuid 974b19f8-021a-46b6-a089-a46e06e6e746 --iter-time 2000 --use-random /dev/sda3</code>
failed most probably due: <code>--hash: invalid numeric value</code>. Why you don't
get <s>correct</s> hash from <em>disklayout.conf</em>, I really don't know.</p>
<p>According change
<a href="https://github.com/rear/rear/commits/master/usr/share/rear/layout/prepare/GNU/Linux/160_include_luks_code.sh">history</a>
of <em>160_include_luks_code.sh</em>, @OliverO2 was the last one doing
changes in this file so he might be the most suitable one to help you
...</p>
<p>V.</p>
<h4 id="adatum_commented_at_2019-08-11_1924"><img src="https://avatars.githubusercontent.com/u/9773655?v=4" width="50"><a href="https://github.com/adatum">adatum</a> commented at <a href="https://github.com/rear/rear/issues/2204#issuecomment-520253578">2019-08-11 19:24</a>:<a class="headerlink" href="#adatum_commented_at_2019-08-11_1924" title="Permanent link">&para;</a></h4>
<p>Thanks for noticing that @gozora If there's anything you'd like me to
try, let me know. Since the system being backed up and recovered is just
a test VM, I can try anything even if it's destructive.</p>
<p>Where is a good place to ask questions about ReaR that aren't
necessarily issues? Besides the two "additional notes" above, I have a
few other questions about ReaR's behavior.</p>
<h4 id="olivero2_commented_at_2019-08-11_1940"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/issues/2204#issuecomment-520254591">2019-08-11 19:40</a>:<a class="headerlink" href="#olivero2_commented_at_2019-08-11_1940" title="Permanent link">&para;</a></h4>
<p>Good evening @adatum, having been notified of this issue I took a short
look. As @gozora noted correctly there is a missing <code>hash</code> parameter
value. The root cause thus seems to be that the hash value is not
properly detected by
<a href="https://github.com/rear/rear/blob/ef074a6041ebb640b258dd36e4f8dbf3bf0e72fe/usr/share/rear/layout/save/GNU/Linux/260_crypt_layout.sh#L41">https://github.com/rear/rear/blob/ef074a6041ebb640b258dd36e4f8dbf3bf0e72fe/usr/share/rear/layout/save/GNU/Linux/260_crypt_layout.sh#L41</a></p>
<p>That code exists since its initial implementation on 2011, so its not
something I was directly involved in. But maybe you could shed some
light on it by running this command on the original system:</p>
<pre><code>sudo cryptsetup luksDump /dev/sda3
</code></pre>
<p>The output is expected to look similar to this, in particular the line
starting with <code>Hash spec:</code>:</p>
<pre><code>LUKS header information for /dev/sda3

Version:        1
Cipher name:    aes
Cipher mode:    xts-plain64
Hash spec:      sha256
Payload offset: 4096
MK bits:        512
[...]
</code></pre>
<h4 id="adatum_commented_at_2019-08-11_1946"><img src="https://avatars.githubusercontent.com/u/9773655?v=4" width="50"><a href="https://github.com/adatum">adatum</a> commented at <a href="https://github.com/rear/rear/issues/2204#issuecomment-520254956">2019-08-11 19:46</a>:<a class="headerlink" href="#adatum_commented_at_2019-08-11_1946" title="Permanent link">&para;</a></h4>
<p>Thank you for the quick reply @OliverO2. Here is the luksDump. The hash
spec is <code>sha256</code> but notice that this is using LUKS version 2, which is
now the default on recent Fedora releases. Could that have anything to
do with the problem?</p>
<pre><code>$ sudo cryptsetup luksDump /dev/sda3
LUKS header information
Version:        2
Epoch:          3
Metadata area:  16384 [bytes]
Keyslots area:  16744448 [bytes]
UUID:           974b19f8-021a-46b6-a089-a46e06e6e746
Label:          (no label)
Subsystem:      (no subsystem)
Flags:          (no flags)

Data segments:
  0: crypt
    offset: 16777216 [bytes]
    length: (whole device)
    cipher: aes-xts-plain64
    sector: 512 [bytes]

Keyslots:
  0: luks2
    Key:        512 bits
    Priority:   normal
    Cipher:     aes-xts-plain64
    Cipher key: 512 bits
    PBKDF:      argon2i
    Time cost:  4
    Memory:     973984
    Threads:    4
    Salt:       af 33 7e 3b 6c bb 55 dc e3 dc 2b 07 c5 9e c3 6d 
                f2 c9 08 be 2f 1d 8b 78 8a 33 65 90 41 e3 05 10 
    AF stripes: 4000
    AF hash:    sha256
    Area offset:32768 [bytes]
    Area length:258048 [bytes]
    Digest ID:  0
Tokens:
Digests:
  0: pbkdf2
    Hash:       sha256
    Iterations: 100361
    Salt:       d9 30 b6 7f 60 d0 e0 19 39 f6 a2 38 ae 22 88 43 
                1e 5c 74 75 e6 b5 dd db a9 e7 29 1a 74 64 9c 0f 
    Digest:     ae 06 29 5f 71 49 bd c8 75 de 53 e8 95 94 d3 38 
                57 43 5f 0e 1e ac 6d 59 fb 34 a3 97 e4 5a 94 0c
</code></pre>
<h4 id="olivero2_commented_at_2019-08-11_2030"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/issues/2204#issuecomment-520257973">2019-08-11 20:30</a>:<a class="headerlink" href="#olivero2_commented_at_2019-08-11_2030" title="Permanent link">&para;</a></h4>
<p>Yes, it seems like LUKS version 2 requires its own port within ReaR: The
output format of <code>cryptsetup luksDump</code> differs significantly between the
two versions, and that might be just the tip of the iceberg. One would
have to analyze the implications of the version changes step by step to
make ReaR save and reproduce a LUKS 2 setup correctly.</p>
<p>Maybe you have the option of just staying with LUKS version 1 for now
until version 2 is more established and someone would come up with a
port for ReaR.</p>
<h4 id="adatum_commented_at_2019-08-11_2107"><img src="https://avatars.githubusercontent.com/u/9773655?v=4" width="50"><a href="https://github.com/adatum">adatum</a> commented at <a href="https://github.com/rear/rear/issues/2204#issuecomment-520260468">2019-08-11 21:07</a>:<a class="headerlink" href="#adatum_commented_at_2019-08-11_2107" title="Permanent link">&para;</a></h4>
<p>Thanks for confirming.</p>
<p>This complicates the situation. Of two systems I want to use with ReaR,
one is using LUKS2.</p>
<p>LUKS2 has been supported on Fedora since 29, and is the <a href="https://fedoraproject.org/wiki/Changes/SwitchCryptsetupDefaultToLUKS2">default since
Fedora
30</a>.</p>
<p>LUKS allows converting between versions 1 and 2 under certain
conditions:<br />
<a href="https://www.saout.de/pipermail/dm-crypt/2017-December/005771.html">https://www.saout.de/pipermail/dm-crypt/2017-December/005771.html</a></p>
<pre><code>* In-place conversion form LUKS1

  To allow easy testing and transition to the new LUKS2 format, there is a new
  convert command that allows in-place conversion from the LUKS1 format and,
  if there are no incompatible options, also conversion back from LUKS2
  to LUKS1 format.

  Note this command can be used only on some LUKS1 devices (some device header
  sizes are not supported).
  This command is dangerous, never run it without header backup!
  If something fails in the middle of conversion (IO error), the header
  is destroyed. (Note that conversion requires move of keyslot data area to
  a different offset.)

  To convert header in-place to LUKS2 format, use
  $ cryptsetup convert &lt;device&gt; --type luks2

  To convert it back to LUKS1 format, use
  $ cryptsetup convert &lt;device&gt; --type luks1

  You can verify LUKS version with luksDump command.
  $ cryptsetup luksDump &lt;device&gt;

  Note that some LUKS2 features will make header incompatible with LUKS1 and
  conversion will be rejected (for example using new Argon2 PBKDF or integrity
  extensions). Some minor attributes can be lost in conversion.
</code></pre>
<p>Unfortunately that last point combined with Fedora's defaults prevents
converting back to LUKS1. Here is the output from my conversion attempt
on the VM with the luksDump from above:</p>
<pre><code>$ sudo cryptsetup convert /dev/sda3 --type luks1

WARNING!
========
This operation will convert /dev/sda3 to LUKS1 format.


Are you sure? (Type uppercase yes): YES
Cannot convert to LUKS1 format - keyslot 0 is not LUKS1 compatible.
</code></pre>
<h4 id="gozora_commented_at_2019-08-11_2120"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/2204#issuecomment-520261442">2019-08-11 21:20</a>:<a class="headerlink" href="#gozora_commented_at_2019-08-11_2120" title="Permanent link">&para;</a></h4>
<p>@OliverO2 thanks for finding culprit!</p>
<p>Since fixing this issue would require some additional work, I'm
assigning <strong>"need sponsorship"</strong> label and changing title of this issue.</p>
<p>If anyone wants to sponsor fix for this issue, please drop message to
this thread to avoid double work.</p>
<p>V.</p>
<h4 id="jsmeix_commented_at_2019-08-12_1253"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2204#issuecomment-520412508">2019-08-12 12:53</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-08-12_1253" title="Permanent link">&para;</a></h4>
<p>I think in general missing support for a newer and incompatible
version<br />
of some software cannot be a bug in ReaR but is an enhancement.</p>
<h4 id="adatum_commented_at_2019-08-18_0631"><img src="https://avatars.githubusercontent.com/u/9773655?v=4" width="50"><a href="https://github.com/adatum">adatum</a> commented at <a href="https://github.com/rear/rear/issues/2204#issuecomment-522295377">2019-08-18 06:31</a>:<a class="headerlink" href="#adatum_commented_at_2019-08-18_0631" title="Permanent link">&para;</a></h4>
<p>In the meantime, a workaround is to convert LUKS2 to LUKS1, which is by
no means guaranteed to succeed, as "it depends" on many factors such as
what features of LUKS2 are being used.</p>
<p>However this worked for me:</p>
<ul>
<li>Boot from an environment other than the LUKS2 volume that is to be
    converted</li>
<li>Do <code>cryptsetup luksConvertKey --pbkdf=pbkdf2 [/device/with/luks2]</code>
    if for example <code>argon2i</code> is used (default on Fedora), which LUKS1
    does not support.</li>
<li>Do <code>cryptsetup convert [/device/with/luks2] --type luks1</code></li>
</ul>
<p><a href="https://unix.stackexchange.com/questions/535077/convert-luks2-back-to-luks-version-1/535081#535081">https://unix.stackexchange.com/questions/535077/convert-luks2-back-to-luks-version-1/535081#535081</a></p>
<h4 id="jsmeix_commented_at_2020-04-27_0837"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2204#issuecomment-619824042">2020-04-27 08:37</a>:<a class="headerlink" href="#jsmeix_commented_at_2020-04-27_0837" title="Permanent link">&para;</a></h4>
<p>With
<a href="https://github.com/rear/rear/pull/2381">https://github.com/rear/rear/pull/2381</a><br />
we detect at least when gathering crypt information<br />
was not successful because LUKS 2 is used<br />
instead of let the code blindly proceed resulting<br />
wrong (incomplete) entries in disklayout.conf<br />
that let later (when it is too late) "rear recover" fail.</p>
<p>The whole LUKS code needs to be overhauled to be more fail safe.<br />
Currently it blindly proceeds basically everywhere, e.g. also<br />
layout/prepare/GNU/Linux/160_include_luks_code.sh<br />
blindly adds <code>cryptsetup_options</code> independent of whether or not<br />
the resulting cryptsetup command is at least syntactically correct.</p>
<p>In<br />
<a href="https://github.com/rear/rear/blob/master/doc/user-guide/06-layout-configuration.adoc">https://github.com/rear/rear/blob/master/doc/user-guide/06-layout-configuration.adoc</a><br />
the <code>LUKS Devices</code> syntax description in disklayout.conf<br />
indicates that most parameters are optional but it seems this is not the
case.</p>
<h4 id="github-actions_commented_at_2020-06-27_0133"><img src="https://avatars.githubusercontent.com/in/15368?v=4" width="50"><a href="https://github.com/apps/github-actions">github-actions</a> commented at <a href="https://github.com/rear/rear/issues/2204#issuecomment-650470472">2020-06-27 01:33</a>:<a class="headerlink" href="#github-actions_commented_at_2020-06-27_0133" title="Permanent link">&para;</a></h4>
<p>Stale issue message</p>
<h4 id="mannp_commented_at_2020-07-04_1145"><img src="https://avatars.githubusercontent.com/u/4335298?u=0cf0e58f6aee4021f1e92cb4a401affd672fd05e&v=4" width="50"><a href="https://github.com/mannp">mannp</a> commented at <a href="https://github.com/rear/rear/issues/2204#issuecomment-653755733">2020-07-04 11:45</a>:<a class="headerlink" href="#mannp_commented_at_2020-07-04_1145" title="Permanent link">&para;</a></h4>
<p>Reading through the numerous updates to the thread, it seems LUKS2 is
not supported, but the issue has been closed?</p>
<p>Is LUKS2 now supported?</p>
<p>Thanks for any clarifications üëç</p>
<h4 id="gdha_commented_at_2020-07-04_1224"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/issues/2204#issuecomment-653759489">2020-07-04 12:24</a>:<a class="headerlink" href="#gdha_commented_at_2020-07-04_1224" title="Permanent link">&para;</a></h4>
<p>@mannp LUKS2 is not (yet) supported so far. Cold issues are getting
automatically closed by GitHub Bot as it makes no sense if nothing
happens (after 90 days) to keep them open. I f you feel it is so
important you cannot live without it then sponsoring an issue is a valid
option to keep it alive. Or, even better preparing a pull request or
adding feedback to the issue which could be useful to get it fixed by
someone.</p>
<h4 id="mannp_commented_at_2020-07-04_1233"><img src="https://avatars.githubusercontent.com/u/4335298?u=0cf0e58f6aee4021f1e92cb4a401affd672fd05e&v=4" width="50"><a href="https://github.com/mannp">mannp</a> commented at <a href="https://github.com/rear/rear/issues/2204#issuecomment-653760387">2020-07-04 12:33</a>:<a class="headerlink" href="#mannp_commented_at_2020-07-04_1233" title="Permanent link">&para;</a></h4>
<blockquote>
<p>@mannp LUKS2 is not (yet) supported so far. Cold issues are getting
automatically closed by GitHub Bot as it makes no sense if nothing
happens (after 90 days) to keep them open. I f you feel it is so
important you cannot live without it then sponsoring an issue is a
valid option to keep it alive. Or, even better preparing a pull
request or adding feedback to the issue which could be useful to get
it fixed by someone.</p>
</blockquote>
<p>Thanks @gdha I assumed as much, but as it had been open for almost a
year I wondered why the bot closed now....updated 12 days ago....</p>
<p>Anyway, I have not been using rear as all my machines are luks2, just
using alternatives :)</p>
<p>All the best.</p>
<h4 id="adatum_commented_at_2020-07-04_1614"><img src="https://avatars.githubusercontent.com/u/9773655?v=4" width="50"><a href="https://github.com/adatum">adatum</a> commented at <a href="https://github.com/rear/rear/issues/2204#issuecomment-653784465">2020-07-04 16:14</a>:<a class="headerlink" href="#adatum_commented_at_2020-07-04_1614" title="Permanent link">&para;</a></h4>
<blockquote>
<p>I have not been using rear as all my machines are luks2, just using
alternatives</p>
</blockquote>
<p>@mannp What alternatives have you found?</p>
<p>One way is to convert LUKS2 to LUKS1
<a href="https://github.com/rear/rear/issues/2204#issuecomment-522295377">https://github.com/rear/rear/issues/2204#issuecomment-522295377</a>
to be able to use ReaR.</p>
<p>I find it unfortunate to close valid issues simply because they haven't
been addressed in X days.</p>
<h4 id="mannp_commented_at_2020-07-04_1954"><img src="https://avatars.githubusercontent.com/u/4335298?u=0cf0e58f6aee4021f1e92cb4a401affd672fd05e&v=4" width="50"><a href="https://github.com/mannp">mannp</a> commented at <a href="https://github.com/rear/rear/issues/2204#issuecomment-653804837">2020-07-04 19:54</a>:<a class="headerlink" href="#mannp_commented_at_2020-07-04_1954" title="Permanent link">&para;</a></h4>
<blockquote>
<blockquote>
<p>I have not been using rear as all my machines are luks2, just using
alternatives</p>
</blockquote>
<p>@mannp What alternatives have you found?</p>
<p>One way is to convert LUKS2 to LUKS1 <a href="https://github.com/rear/rear/issues/2204#issuecomment-522295377">#2204
(comment)</a>
to be able to use ReaR.</p>
<p>I find it unfortunate to close valid issues simply because they
haven't been addressed in X days.</p>
</blockquote>
<p>Hi @adatum, not wanting to take anything away from ReaR, as I think it
is a great idea</p>
<p>I use timeshift [https://github.com/teejee2008/timeshift] which is not
perhaps a direct comparison, but is does support LUKS2 and has bailed me
out on one occasion. Using it with arch it takes care of snapshots in
between pacman updates.</p>
<p>That said I did subscribe to this thread as I would have liked another
backup of my backup and I do use borg backup
[https://github.com/borgbackup/borg] but only for user files, not bare
metal restores.</p>
<p>That's where ReaR would be an great fit being able to use borg.</p>
<p>Hope that helps :)</p>
<h4 id="kalos_commented_at_2020-09-12_1406"><img src="https://avatars.githubusercontent.com/u/3465?u=99049a17eb3b6717eff13b7249e709369d199f00&v=4" width="50"><a href="https://github.com/kalos">kalos</a> commented at <a href="https://github.com/rear/rear/issues/2204#issuecomment-691494336">2020-09-12 14:06</a>:<a class="headerlink" href="#kalos_commented_at_2020-09-12_1406" title="Permanent link">&para;</a></h4>
<p>With the patch
<a href="https://github.com/rear/rear/pull/2381">https://github.com/rear/rear/pull/2381</a>,
I get an error even if I exclude the device with LUKS2.</p>
<p>In this way, if I have mounted an (even external) LUKS2 device, which I
have no intention to backing up, the creation of the layout fails:<br />
ERROR: No hash value for LUKS device 'XXX_crypt' at '/dev/sdb1' (only
LUKS version 1 is supported)</p>
<h4 id="jsmeix_commented_at_2020-09-15_0813"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2204#issuecomment-692547494">2020-09-15 08:13</a>:<a class="headerlink" href="#jsmeix_commented_at_2020-09-15_0813" title="Permanent link">&para;</a></h4>
<p>@kalos<br />
please report your case as a new issue via<br />
<a href="https://github.com/rear/rear/issues/new">https://github.com/rear/rear/issues/new</a><br />
and provide the information we need as asked for there.<br />
In particular I cannot guess what you had specified in<br />
your etc/rear/local.conf to exclude the not needed thing<br />
and how <code>lsblk</code> looks like on your particular system.<br />
Additionally provide your <code>var/lib/rear/layout/disklayout.conf</code><br />
and <code>var/lib/rear/layout/disktodo.conf</code> files.</p>
<h4 id="jsmeix_commented_at_2020-09-15_1024"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2204#issuecomment-692624337">2020-09-15 10:24</a>:<a class="headerlink" href="#jsmeix_commented_at_2020-09-15_1024" title="Permanent link">&para;</a></h4>
<p><a href="https://github.com/rear/rear/issues/2204#issuecomment-691494336">https://github.com/rear/rear/issues/2204#issuecomment-691494336</a><br />
is <code>LUKS2 error even if the device is excluded</code> reported via<br />
<a href="https://github.com/rear/rear/issues/2491">https://github.com/rear/rear/issues/2491</a></p>
<h4 id="jsmeix_commented_at_2020-10-28_1119"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2204#issuecomment-717867391">2020-10-28 11:19</a>:<a class="headerlink" href="#jsmeix_commented_at_2020-10-28_1119" title="Permanent link">&para;</a></h4>
<p>With
<a href="https://github.com/rear/rear/pull/2504">https://github.com/rear/rear/pull/2504</a>
merged<br />
initial LUKS2 support was added tom ReaR.</p>
<p>@vcrhonek<br />
thank you for your valuable contribution to ReaR!</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2022 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2019-08-11.2204.issue.closed.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
