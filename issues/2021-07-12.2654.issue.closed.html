<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#2654 Issue closed: 'export TMPDIR' in etc/rear/...conf does no longer work since #2633 - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#2654 Issue closed: \u0027export TMPDIR\u0027 in etc/rear/...conf does no longer work since #2633";
        var mkdocs_page_input_path = "issues/2021-07-12.2654.issue.closed.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/backup_netfs.html">Example of BACKUP=NETFS</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#2654 Issue closed: 'export TMPDIR' in etc/rear/...conf does no longer work since #2633</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="2654_issue_closed_export_tmpdir_in_etcrearconf_does_no_longer_work_since_2633"><a href="https://github.com/rear/rear/issues/2654">#2654 Issue</a> <code>closed</code>: 'export TMPDIR' in etc/rear/...conf does no longer work since #2633<a class="headerlink" href="#2654_issue_closed_export_tmpdir_in_etcrearconf_does_no_longer_work_since_2633" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>discuss / RFC</code>, <code>fixed / solved / done</code></p>
<h4 id="hpannenb_opened_issue_at_2021-07-12_1136"><img src="https://avatars.githubusercontent.com/u/13567759?u=b037e492e58a5f63f35277b3606d500cd622c8ed&v=4" width="50"><a href="https://github.com/hpannenb">hpannenb</a> opened issue at <a href="https://github.com/rear/rear/issues/2654">2021-07-12 11:36</a>:<a class="headerlink" href="#hpannenb_opened_issue_at_2021-07-12_1136" title="Permanent link">&para;</a></h4>
<ul>
<li>ReaR version ("/usr/sbin/rear -V"): 2.6 (current git version)<br />
<code>2.6 / Git</code></li>
<li>OS version ("cat /etc/os-release" or "lsb_release -a" or "cat
    /etc/rear/os.conf"):<br />
<code>CentOS Linux release 7.9.2009 (Core)</code> and/or <code>RHEL 7.9</code></li>
<li>ReaR configuration files ("cat /etc/rear/site.conf" and/or "cat
    /etc/rear/local.conf"):</li>
</ul>
<!-- -->

<pre><code># ReaR - site.conf

export TMPDIR="/var"

BACKUP=NETFS
BACKUP_URL=iso://backup

OUTPUT=ISO
OUTPUT_URL=null

USE_STATIC_NETWORKING=yes
USE_RESOLV_CONF=no

SSH_ROOT_PASSWORD='root'
</code></pre>
<ul>
<li>Hardware (PC or PowerNV BareMetal or ARM) or virtual machine (KVM
    guest or PoverVM LPAR):<br />
    KVM and/or hardware</li>
<li>System architecture (x86 compatible or PPC64/PPC64LE or what exact
    ARM device):<br />
    x86</li>
<li>Firmware (BIOS or UEFI or Open Firmware) and bootloader (GRUB or
    ELILO or Petitboot):<br />
    BIOS</li>
<li>Storage (local disk or SSD) and/or SAN (FC or iSCSI or FCoE) and/or
    multipath (DM or NVMe):<br />
    local disks</li>
<li>Storage layout ("lsblk -ipo
    NAME,KNAME,PKNAME,TRAN,TYPE,FSTYPE,SIZE,MOUNTPOINT" or "lsblk" as
    makeshift):</li>
</ul>
<!-- -->

<pre><code>NAME                        KNAME     PKNAME    TRAN TYPE FSTYPE       SIZE MOUNTPOINT
/dev/sr0                    /dev/sr0            ata  rom              1024M 
/dev/vda                    /dev/vda                 disk               16G 
|-/dev/vda1                 /dev/vda1 /dev/vda       part xfs          500M /boot
`-/dev/vda2                 /dev/vda2 /dev/vda       part LVM2_member 15,5G 
  |-/dev/mapper/centos-root /dev/dm-0 /dev/vda2      lvm  xfs           15G /
  `-/dev/mapper/centos-swap /dev/dm-1 /dev/vda2      lvm  swap         512M [SWAP]
</code></pre>
<ul>
<li>
<p>Description of the issue (ideally so that others can reproduce
    it):<br />
    Using <code>export TMPDIR="/var"</code> does not work any more in the current
    Git version of ReaR. It was working in 2.6 / 2020-06-17 (on
    RHEL7.9). The mktemp always uses <code>/tmp</code> instead. A later check of
    ReaR in the <code>BUILD_DIR</code> fails due a hardened (noexec) <code>/tmp</code>
    directory or ReaR errors out due to "no space left on device".</p>
</li>
<li>
<p>Workaround, if any:<br />
    If Your login shell is NOT bash than change to <code>bash</code> and type
    `export TMP="/var" before manually executing ReaR in that shell.</p>
</li>
<li>
<p>Attachments, as applicable ("rear -D mkrescue/mkbackup/recover"
    debug log files):<br />
    Pre-req is: Same <code>/etc/rear/site.conf</code>for both tests:</p>
<ul>
<li><a href="https://github.com/rear/rear/files/6801029/rear-RHEL7.log">rear-RHEL7.log with 2.6 /
    Git</a>
    =&gt; not working</li>
<li><a href="https://github.com/rear/rear/files/6801443/rear-RHEL7-with-26.log">rear-RHEL7.log with 2.6 /
    2020-06-17</a>
    ) =&gt; working</li>
</ul>
</li>
</ul>
<h4 id="gdha_commented_at_2021-07-12_1549"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/issues/2654#issuecomment-878390844">2021-07-12 15:49</a>:<a class="headerlink" href="#gdha_commented_at_2021-07-12_1549" title="Permanent link">&para;</a></h4>
<p>@hpannenb
<code>cp: error writing './usr/share/microcode_ctl/ucode_with_caveats/intel/intel-ucode/06-6a-05': No space left on device</code>?<br />
So, what is your base shell then?</p>
<h4 id="hpannenb_commented_at_2021-07-12_1851"><img src="https://avatars.githubusercontent.com/u/13567759?u=b037e492e58a5f63f35277b3606d500cd622c8ed&v=4" width="50"><a href="https://github.com/hpannenb">hpannenb</a> commented at <a href="https://github.com/rear/rear/issues/2654#issuecomment-878512772">2021-07-12 18:51</a>:<a class="headerlink" href="#hpannenb_commented_at_2021-07-12_1851" title="Permanent link">&para;</a></h4>
<p>The base shell after login is <code>bash</code>.</p>
<p>Info:<br />
What I could see from the the source of the main <code>/usr/sbin/rear</code> in
version 2.6 the initialisation of the <strong>build area</strong> took place
<strong>after</strong> the <strong>"# Combine configuration files"</strong> section. So <code>mktemp</code>
could take into account the TMPDIR value from site.conf.</p>
<p>In the current version the order of sections has changed: The <strong>build
area</strong> is executed <strong>first</strong> and <strong>later</strong> the <em>"# Combine
configuration files"</em>* section is executed.</p>
<p>So IMHO no matter what TMPDIR has been configured in site.conf; it will
never be used by <code>mktemp</code>.</p>
<p>This major change was introduced with commit 0022063 .</p>
<h4 id="jsmeix_commented_at_2021-07-13_1420"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2654#issuecomment-879131111">2021-07-13 14:20</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-07-13_1420" title="Permanent link">&para;</a></h4>
<p>@hpannenb<br />
you are right.<br />
<code>export TMPDIR="..."</code> in <code>etc/rear/*.conf</code><br />
does no longer work since<br />
<a href="https://github.com/rear/rear/pull/2633">https://github.com/rear/rear/pull/2633</a><br />
because I had to move in usr/sbin/rear the part with<br />
<code>mktemp -d -t rear.XXXXXXXXXXXXXXX</code><br />
from after <code>read the configurations</code><br />
to before <code>read the configurations</code><br />
so <code>export TMPDIR="..."</code> in <code>etc/rear/*.conf</code><br />
happens now after <code>mktemp -d -t rear.XXXXXXXXXXXXXXX</code><br />
so that <code>export TMPDIR="..."</code> in <code>etc/rear/*.conf</code><br />
has become basically useless.</p>
<p>What works is <code>export TMPDIR="..."</code><br />
on the command line before calling <code>rear</code>.</p>
<p>I will think about if <code>export TMPDIR="..."</code> in <code>etc/rear/*.conf</code><br />
could be made working again but I fear this is not possible<br />
with reasonable effort and with reasonably clean code.</p>
<h4 id="jsmeix_commented_at_2021-07-13_1441"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2654#issuecomment-879148003">2021-07-13 14:41</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-07-13_1441" title="Permanent link">&para;</a></h4>
<p>With<br />
<a href="https://github.com/rear/rear/commit/b422845f14ea59c8b8dd16449df217334569faa7">https://github.com/rear/rear/commit/b422845f14ea59c8b8dd16449df217334569faa7</a><br />
I adapted the documentation in default.conf to match the current
state.<br />
I did this is only to have the current state documented appropriately.<br />
This does not mean the current state cannot be changed or improved.</p>
<h4 id="jsmeix_commented_at_2021-07-13_1447"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2654#issuecomment-879153210">2021-07-13 14:47</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-07-13_1447" title="Permanent link">&para;</a></h4>
<p>I am not a TMPDIR expert but I think calling <code>export TMPDIR="..."</code><br />
before calling whatever program that will use TMPDIR<br />
is perfectly in compliance how TMPDIR is meant to work.</p>
<h4 id="pcahyna_commented_at_2021-07-16_1737"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/2654#issuecomment-881609874">2021-07-16 17:37</a>:<a class="headerlink" href="#pcahyna_commented_at_2021-07-16_1737" title="Permanent link">&para;</a></h4>
<blockquote>
<p>I am not a TMPDIR expert but I think calling <code>export TMPDIR="..."</code><br />
before calling whatever program that will use TMPDIR<br />
is perfectly in compliance how TMPDIR is meant to work.</p>
</blockquote>
<p>Hi @jsmeix , it is my understanding as well, but the problem with this
approach that I am currently encountering is that if the distributor
wants to set distribution-specific default in <code>/etc/rear/os.conf</code> or in
some file under <code>/usr/share/rear/conf</code>, it does not work for <code>TMPDIR</code>.
And wanting to set this default is natural if the distribution in
question has specific requirements for temporary files. Right now I am
facing the issue that <code>/tmp</code> is by default a tmpfs and therefore often
too small.</p>
<p>Why does have the creation of the build area happen before reading the
configuration? (Note that default.conf is still being read before the
creation of the build area, only the OS-specific, site-specific and
user-specific part are read later.)</p>
<h4 id="jsmeix_commented_at_2021-07-19_0759"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2654#issuecomment-882331248">2021-07-19 07:59</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-07-19_0759" title="Permanent link">&para;</a></h4>
<p>The creation of the build area must happen<br />
before <code>Start logging</code> where the following is normally done (unless in
debug modes):</p>
<pre><code>STDOUT_STDERR_FILE="$TMP_DIR/$PROGRAM.$WORKFLOW.stdout_stderr"
</code></pre>
<p>because <code>TMP_DIR=$BUILD_DIR/tmp</code> (i.e. in the build area)<br />
and STDOUT_STDERR_FILE is intentionally in BUILD_DIR<br />
to get it removed in the same way as BUILD_DIR gets removed.</p>
<p>If we moved reading the configuration before <code>Start logging</code><br />
we would have nothing about reading the configuration in the log<br />
which makes it hard to understand what goes on by plain looking at the
log.</p>
<p>An interesting idea is that default.conf is sourced very early<br />
and we won't need to have that in the log because we know our defaults.</p>
<p>So setting <code>TMPDIR</code> can happen in a config file that is sourced very
early<br />
which is meant to specify defaults where we do not need logging.</p>
<p>Because "man rear" reads</p>
<pre><code>CONFIGURATION
To configure Relax-and-Recover you have to edit the configuration files in /etc/rear/.
All *.conf files there are part of the configuration,
but only site.conf and local.conf are intended for the user configuration.
All other configuration files hold defaults for various distributions
and should not be changed.
</code></pre>
<p>in particular /etc/rear/os.conf can be sourced early<br />
e.g. directly after default.conf was sourced<br />
so that setting <code>TMPDIR</code> could be done in /etc/rear/os.conf<br />
by Linux distributors and if needed also by users because in general<br />
users are allowed to change their Linux distributor's defaults as
needed.</p>
<p>@gdha @pcahyna @hpannenb<br />
would it be OK for your use cases when I change usr/sbin/rear to<br />
source /etc/rear/os.conf directly after default.conf was sourced?</p>
<h4 id="pcahyna_commented_at_2021-07-19_1105"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/2654#issuecomment-882457169">2021-07-19 11:05</a>:<a class="headerlink" href="#pcahyna_commented_at_2021-07-19_1105" title="Permanent link">&para;</a></h4>
<p>Hi @jsmeix , yes, and I think that it applies not only to os.conf but
also to the distribution configuration files:
<a href="https://github.com/rear/rear/blob/cbd352d06facbd7d74c609382d7aa4652e9e07b1/usr/sbin/rear#L516">https://github.com/rear/rear/blob/cbd352d06facbd7d74c609382d7aa4652e9e07b1/usr/sbin/rear#L516</a>
and perhaps to <code>$WORKFLOW.conf</code> as well (since all of those are internal
to ReaR).</p>
<h4 id="jsmeix_commented_at_2021-07-19_1250"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2654#issuecomment-882520528">2021-07-19 12:50</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-07-19_1250" title="Permanent link">&para;</a></h4>
<p>Things aren't as easy because<br />
in the <code>Combine configuration files</code>section<br />
SetOSVendorAndVersion() is called<br />
but that function may call e.g. <code>Error</code> but calling Error() requires<br />
<code>source $SHARE_DIR/lib/_input-output-functions.sh</code><br />
which happens after logging is started<br />
so it is all some kind of big chicken and egg dilemma:<br />
The more I move up the more other stuff I have to move even upper.</p>
<h4 id="pcahyna_commented_at_2021-07-20_1501"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/2654#issuecomment-883464914">2021-07-20 15:01</a>:<a class="headerlink" href="#pcahyna_commented_at_2021-07-20_1501" title="Permanent link">&para;</a></h4>
<p>@jsmeix Thinking more about my particular issue with <code>/tmp</code> overflowing
... I believe now that the issue does not need to be set in a
distribution-specific configuration file, not even in <code>os.conf</code>, because
it is not just RHEL that suffers from it. See the Ubuntu manapage that
points out the same problem:
<a href="http://manpages.ubuntu.com/manpages/bionic/en/man7/file-hierarchy.7.html">http://manpages.ubuntu.com/manpages/bionic/en/man7/file-hierarchy.7.html</a></p>
<blockquote>
<p><code>/tmp</code><br />
The place for small temporary files. This directory is usually mounted
as a "tmpfs"<br />
instance, and should hence not be used for larger files. (Use /var/tmp
for larger<br />
files.)</p>
</blockquote>
<p>So, any distribution (at least any distribution using systemd) is prone
to the problem of <code>/tmp</code> being too small for ReaR use, and thus it is
reasonable to set <code>TMPDIR</code> to <code>/var/tmp</code> in <code>default.conf</code> if unset
before. Would you accept this change to <code>default.conf</code>? If we can do
that, I don't need to source <code>os.conf</code> that early (although it still
makes sense to do it, IMO).</p>
<h4 id="jsmeix_commented_at_2021-07-20_1603"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2654#issuecomment-883511729">2021-07-20 16:03</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-07-20_1603" title="Permanent link">&para;</a></h4>
<p>I was also meditating over the generic issue<br />
with /tmp on tmpfs too small in general for ReaR<br />
and how to cleanly get out of that /tmp on tmpfs mess.</p>
<p>I think your proposal to set TMPDIR if unset could be a possible way
out.<br />
I think the crucial point is to only touch TMPDIR if it is unset.</p>
<p>On the other hand unset/empty variables do not indicate the user does
not care<br />
because the user may want to have the default behaviour he only is not
aware<br />
that he depends on a default and if that default changes he may be
upset.</p>
<p>So I suggest to do a bit more to not make users with plenty of space in
/tmp upset<br />
and only set TMPDIR if /tmp seems to have not enought space for ReaR<br />
e.g. some automatism based on what <code>df -B M /tmp</code> shows as "Available"<br />
perhaps even with comparison what <code>df -B M /var/tmp</code> shows as
"Available"<br />
to avoid making things worse if we set TMPDIR to /var/tmp regardless<br />
how likely this may go wrong - I would like to have really fail-safe
behaviour<br />
when we mess around with generic Unix environment variables.</p>
<p>Perhaps even simpler:<br />
Don't mess around with generic Unix environment variables<br />
but test in usr/sbin/rear or in a new usr/share/rear/init/ script<br />
how much availabe space there is in BUILD_DIR<br />
and show a warning message or be bold and error out according to<br />
<a href="https://schlomo.schapiro.org/2015/04/warning-is-waste-of-my-time.html">https://schlomo.schapiro.org/2015/04/warning-is-waste-of-my-time.html</a></p>
<p>I think testing in a new usr/share/rear/init/ script is better<br />
because there we know the final config variables values<br />
so we know e.g. things like MODULES and FIRMWARE_FILES<br />
that make a difference how big the ReaR recovery system will get, cf.<br />
<a href="https://github.com/rear/rear/discussions/2640#discussioncomment-908335">https://github.com/rear/rear/discussions/2640#discussioncomment-908335</a></p>
<p>By the way: In output/default/940_grub_rescue.sh I found</p>
<pre><code>available_space=$(df -Pkl /boot | awk 'END { print $4 * 1024 }')
</code></pre>
<h4 id="pcahyna_commented_at_2021-07-20_1623"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/2654#issuecomment-883525644">2021-07-20 16:23</a>:<a class="headerlink" href="#pcahyna_commented_at_2021-07-20_1623" title="Permanent link">&para;</a></h4>
<p>@jsmeix</p>
<blockquote>
<p>On the other hand unset/empty variables do not indicate the user does
not care<br />
because the user may want to have the default behaviour he only is not
aware<br />
that he depends on a default and if that default changes he may be
upset.</p>
</blockquote>
<p>I believe your proposals are needlessly complicated and thus fragile. As
written in the referenced manpage <code>file-hierarchy(7)</code> (which is not
distribution-specific, Fedora has it, too), "<code>/tmp</code> ... This directory
(...) should hence not be used for larger files." "<code>/var/tmp</code> (...) can
thus accept larger files. (...) If applications find the environment
variable <code>$TMPDIR</code> set, they should prefer using the directory specified
in it over directly referencing <code>/var/tmp/</code>".<br />
My reading of this is that since ReaR can generate pretty large files,
according to this standard, it should use <code>/var/tmp</code> as the default
temporary space, not <code>/tmp</code>. If an user expects that with <code>TMPDIR</code> unset
the default for temporary files is <code>/tmp</code>, then their expectation is
clearly wrong, the default depends on whether the application expects
the files to be large (and other considerations, like persistence across
reboots, that do not apply for us, but are relevant for other
applications that have to make this decision).<br />
This is also confirmed by this recommendation in the RHEL 7 release
notes (quite old already):<br />
<a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/migration_planning_guide/chap-red_hat_enterprise_linux-migration_planning_guide-major_changes_and_migration_considerations#sect-Red_Hat_Enterprise_Linux-Migration_Planning_Guide-File_System_Layout-Temporary_storage_space">https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/migration_planning_guide/chap-red_hat_enterprise_linux-migration_planning_guide-major_changes_and_migration_considerations#sect-Red_Hat_Enterprise_Linux-Migration_Planning_Guide-File_System_Layout-Temporary_storage_space</a></p>
<blockquote>
<p>Processes that store a large amount of data, or require temporary data
to persist across reboots, should use <code>/var/tmp</code>.</p>
</blockquote>
<p>ReaR is certainly a process that can store large amounts of data (build
directory is rather on the large side and I have seen failures due to
this in practice), so it should use <code>/var/tmp</code>.</p>
<p>The last quoted phrase from <code>file-hierarchy(7)</code> means that
user-specified TMPDIR overrides both <code>/tmp</code> and <code>/var/tmp</code>, depending on
which one the application has decided to use as the default. It is not
limited just to <code>/tmp</code>.</p>
<p>If you don't want to mess around with generic Unix environment
variables, let's use the <code>-p</code> argument to the <code>mktemp</code> invocation that
creates the build area (when <code>TMPDIR</code> is unset). (The downside could be
the risk that temporary files will be then scattered both in <code>/tmp</code> and
<code>/var/tmp</code> instead of being found only in one place.)</p>
<h4 id="jsmeix_commented_at_2021-07-20_1638"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2654#issuecomment-883535671">2021-07-20 16:38</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-07-20_1638" title="Permanent link">&para;</a></h4>
<p>Ah!<br />
Seems FHS or some successor was adapted to the /tmp on tmpfs mess.<br />
My knowledge was based on the traditional FHS<br />
that had no size limits for /tmp as far as I can remember.<br />
So let's simply follow latest greatest file-hierarchy(7) recommendations
;-)</p>
<h4 id="pcahyna_commented_at_2021-07-21_1700"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/2654#issuecomment-884344341">2021-07-21 17:00</a>:<a class="headerlink" href="#pcahyna_commented_at_2021-07-21_1700" title="Permanent link">&para;</a></h4>
<p>@jsmeix</p>
<blockquote>
<p>but test in usr/sbin/rear or in a new usr/share/rear/init/ script<br />
how much availabe space there is in BUILD_DIR<br />
and show a warning message or be bold and error out</p>
</blockquote>
<p>checking available space in BUILD_DIR could be an useful feature for
the users, but only if it is done reliably. My concern is that it is
difficult to estimate reliably how much space will be needed - the size
of the rescue image can vary wildly according to which software you
include in it, which in turn depends on the chosen BACKUP setting,
because the client for the given backup tool has to be included. As an
example, I have found that the new Rubrik/CDM backup method leads to
very large images due to (quite likely unneeded) inclusion of many
libraries.<br />
Another concern is the possible fragility of the code that will
implement it.</p>
<h4 id="pcahyna_commented_at_2021-07-30_1508"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/2654#issuecomment-889956509">2021-07-30 15:08</a>:<a class="headerlink" href="#pcahyna_commented_at_2021-07-30_1508" title="Permanent link">&para;</a></h4>
<p>@jsmeix I have another question. If <code>export TMPDIR</code> in <code>local.conf</code> does
not work anymore, this is no longer true:
<a href="https://github.com/rear/rear/blob/3e56fc8d03203ac2a2741ba8365f7d9789e04636/usr/share/rear/rescue/GNU/Linux/600_unset_TMPDIR_in_rescue_conf.sh#L2">https://github.com/rear/rear/blob/3e56fc8d03203ac2a2741ba8365f7d9789e04636/usr/share/rear/rescue/GNU/Linux/600_unset_TMPDIR_in_rescue_conf.sh#L2</a><br />
and <code>unset TMPDIR</code> in <code>rescue.conf</code> probably does not work, either.</p>
<h4 id="jsmeix_commented_at_2021-08-06_0541"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2654#issuecomment-894015334">2021-08-06 05:41</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-08-06_0541" title="Permanent link">&para;</a></h4>
<p>With
<a href="https://github.com/rear/rear/pull/2664">https://github.com/rear/rear/pull/2664</a>
merged<br />
this issue and the whole TMPDIR case should now be finally solved -
hopefully ;-)</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2024 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2021-07-12.2654.issue.closed.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/rear/rear-user-guide" class="fa fa-code-fork" style="color: #fcfcfc"> rear/rear-user-guide</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
