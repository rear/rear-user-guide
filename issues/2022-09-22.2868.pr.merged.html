<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>2022 09 22.2868.pr.merged - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "2022 09 22.2868.pr.merged";
        var mkdocs_page_input_path = "issues/2022-09-22.2868.pr.merged.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/rust.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', '366986045', 'auto');
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a> &raquo;</li>
      <li>2022 09 22.2868.pr.merged</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="2868_pr_merged_in_the_userinput_function_drain_stdin_if_stdin_is_a_terminal"><a href="https://github.com/rear/rear/pull/2868">#2868 PR</a> <code>merged</code>: In the UserInput function drain stdin if stdin is a terminal<a class="headerlink" href="#2868_pr_merged_in_the_userinput_function_drain_stdin_if_stdin_is_a_terminal" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>enhancement</code>, <code>fixed / solved / done</code>, <code>minor bug</code></p>
<h4 id="jsmeix_opened_issue_at_2022-09-22_1429"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> opened issue at <a href="https://github.com/rear/rear/pull/2868">2022-09-22 14:29</a>:<a class="headerlink" href="#jsmeix_opened_issue_at_2022-09-22_1429" title="Permanent link">&para;</a></h4>
<ul>
<li>
<p>Type: <strong>Minor Bug Fix</strong></p>
</li>
<li>
<p>Impact: <strong>Low</strong></p>
</li>
<li>
<p>Reference to related issue (URL):<br />
<a href="https://github.com/rear/rear/issues/2866">https://github.com/rear/rear/issues/2866</a></p>
</li>
<li>
<p>How was this pull request tested?</p>
</li>
</ul>
<p>Works sufficiently well for me<br />
during "rear recover" with MIGRATION_MODE="true"<br />
(where several user dialogs appear).</p>
<ul>
<li>Brief description of the changes in this pull request:</li>
</ul>
<p>In the UserInput function<br />
in lib/_input-output-functions.sh<br />
drain stdin if stdin is a terminal (i.e. in interactive mode).</p>
<h4 id="jsmeix_commented_at_2022-09-23_0945"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2868#issuecomment-1256003225">2022-09-23 09:45</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-09-23_0945" title="Permanent link">&para;</a></h4>
<p>FYI<br />
what "help read" shows on SLES11 SP4 with bash version 3.2.57</p>
<pre><code># help read
read: read [-ers] [-u fd] [-t timeout] [-p prompt] [-a array] [-n nchars] [-d delim] [name ...]
    One line is read from the standard input, or from file descriptor FD if the
    -u option is supplied, and the first word is assigned to the first NAME,
    the second word to the second NAME, and so on, with leftover words assigned
    to the last NAME.  Only the characters found in $IFS are recognized as word
    delimiters.  If no NAMEs are supplied, the line read is stored in the REPLY
    variable.  If the -r option is given, this signifies `raw' input, and
    backslash escaping is disabled.  The -d option causes read to continue
    until the first character of DELIM is read, rather than newline.  If the -p
    option is supplied, the string PROMPT is output without a trailing newline
    before attempting to read.  If -a is supplied, the words read are assigned
    to sequential indices of ARRAY, starting at zero.  If -e is supplied and
    the shell is interactive, readline is used to obtain the line.  If -n is
    supplied with a non-zero NCHARS argument, read returns after NCHARS
    characters have been read.  The -s option causes input coming from a
    terminal to not be echoed.

    The -t option causes read to time out and return failure if a complete line
    of input is not read within TIMEOUT seconds.  If the TMOUT variable is set,
    its value is the default timeout.  The return code is zero, unless end-of-file
    is encountered, read times out, or an invalid file descriptor is supplied as
    the argument to -u.
</code></pre>
<h4 id="jsmeix_commented_at_2022-09-23_1153"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2868#issuecomment-1256115495">2022-09-23 11:53</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-09-23_1153" title="Permanent link">&para;</a></h4>
<p>Via my last<br />
<a href="https://github.com/rear/rear/pull/2868/commits/6ab2c2a2d4a9fede920fd18a726ac41801cd0930">https://github.com/rear/rear/pull/2868/commits/6ab2c2a2d4a9fede920fd18a726ac41801cd0930</a><br />
I simplified it to a single command</p>
<pre><code>test -t 0 &amp;&amp; while read -t 0 ; do read -s ; done
</code></pre>
<h4 id="pcahyna_commented_at_2022-09-23_1212"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/2868#issuecomment-1256133385">2022-09-23 12:12</a>:<a class="headerlink" href="#pcahyna_commented_at_2022-09-23_1212" title="Permanent link">&para;</a></h4>
<p>This does not drain characters not terminated by ENTER, try</p>
<pre><code>sleep 5; while read -t 0 ; do read -s ; done
</code></pre>
<p>and press some keys (without ENTER) during the <code>sleep</code>. You will see
that the characters remain.</p>
<h4 id="jsmeix_commented_at_2022-09-23_1241"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2868#issuecomment-1256160583">2022-09-23 12:41</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-09-23_1241" title="Permanent link">&para;</a></h4>
<p>Yes this is a known drawback of how <code>read -t 0</code> is implemented.<br />
It only looks if there is something in stdin.<br />
It does not look if there is something<br />
in the terminal buffer that is not yet in stdin.<br />
See my comment in my last commit.</p>
<p>I tested it right now and it behaves "good enough" for me.</p>
<p>During my test I typed plain '9' without ENTER<br />
(note the <code>9Marking component...</code> line)<br />
before another UserInput dialog appeared and got<br />
(with MIGRATION_MODE="true" to get those dialogs):</p>
<pre><code>RESCUE localhost:~ # rear -D recover
...
User confirmed disk layout file
9Marking component '/dev/sda' as done in /var/lib/rear/layout/disktodo.conf
Marking component '/dev/sda1' as done in /var/lib/rear/layout/disktodo.conf
...
Running 'layout/recreate' stage ======================
UserInput -I LAYOUT_CODE_CONFIRMATION needed in /usr/share/rear/layout/recreate/default/100_confirm_layout_code.sh line 26
Confirm or edit the disk recreation script
1) Confirm disk recreation script and continue 'rear recover'
2) Edit disk recreation script (/var/lib/rear/layout/diskrestore.sh)
3) View disk recreation script (/var/lib/rear/layout/diskrestore.sh)
4) View original disk space usage (/var/lib/rear/layout/config/df.txt)
5) Use Relax-and-Recover shell and return back to here
6) Abort 'rear recover'
(default '1' timeout 300 seconds)

UserInput: Result is '9'
UserInput -I LAYOUT_CODE_CONFIRMATION needed in /usr/share/rear/layout/recreate/default/100_confirm_layout_code.sh line 26
Confirm or edit the disk recreation script
1) Confirm disk recreation script and continue 'rear recover'
2) Edit disk recreation script (/var/lib/rear/layout/diskrestore.sh)
3) View disk recreation script (/var/lib/rear/layout/diskrestore.sh)
4) View original disk space usage (/var/lib/rear/layout/config/df.txt)
5) Use Relax-and-Recover shell and return back to here
6) Abort 'rear recover'
(default '1' timeout 300 seconds)
</code></pre>
<p>when I hit only ENTER in that dialog<br />
because that dialog got '9' and ENTER at its stdin<br />
when ENTER was hit (which triggers to move the '9'<br />
from the terminal buffer into rear's stdin).</p>
<p>By the way:<br />
I hit ENTER many times between dialogs<br />
and typed lots of stuff during backup restore.<br />
All behaved sufficiently well for me.</p>
<h4 id="pcahyna_commented_at_2022-09-23_1243"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/2868#issuecomment-1256163803">2022-09-23 12:43</a>:<a class="headerlink" href="#pcahyna_commented_at_2022-09-23_1243" title="Permanent link">&para;</a></h4>
<p>I also wonder why <code>-t</code> in the second read is not needed. I would be
afraid that <code>read -s</code> without <code>-t</code> would block forever if there is no
more input at this point, but apparently this does not happen.</p>
<h4 id="pcahyna_commented_at_2022-09-23_1244"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/2868#issuecomment-1256164753">2022-09-23 12:44</a>:<a class="headerlink" href="#pcahyna_commented_at_2022-09-23_1244" title="Permanent link">&para;</a></h4>
<blockquote>
<p>Yes this is a known drawback of how <code>read -t 0</code> is implemented.</p>
</blockquote>
<p>My question is, why not add <code>-n 1000</code> back? It seemed to get rid of this
drawback.</p>
<h4 id="jsmeix_commented_at_2022-09-23_1250"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2868#issuecomment-1256169962">2022-09-23 12:50</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-09-23_1250" title="Permanent link">&para;</a></h4>
<p>I also wondered why <code>-t 1</code> in the second read is not needed.<br />
I also expected it to wait endlessly for input.<br />
I got that from a colleague and tried it and it works for me.<br />
See also the function clear_stdin() in<br />
<a href="https://superuser.com/questions/276531/clear-stdin-before-reading">https://superuser.com/questions/276531/clear-stdin-before-reading</a><br />
where <code>while read none; do :; done</code> seems to work.<br />
When I call this on command line it waits for input.</p>
<h4 id="jsmeix_commented_at_2022-09-23_1253"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2868#issuecomment-1256172709">2022-09-23 12:53</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-09-23_1253" title="Permanent link">&para;</a></h4>
<p>Next week I try out how it behaves with re-added <code>-n 1000</code>.<br />
And perhaps I should add <code>-t 1</code> just as a safety net.</p>
<h4 id="jsmeix_commented_at_2022-09-26_1246"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2868#issuecomment-1257988466">2022-09-26 12:46</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-09-26_1246" title="Permanent link">&para;</a></h4>
<p>Hmpf!<br />
I hate this fragile terminal IO stuff.</p>
<p>I can produce an endless 'read' loop with</p>
<pre><code>while read -t 0 ; do read ... ; done
</code></pre>
<p>on comandline with bash 4.4.23<br />
depending on how the process that does the 'read'<br />
is connected with the process that provides read's input<br />
and additionally depending on some (weird) 'sleep':</p>
<pre><code># ( echo start ; sleep 2 ; echo -en 'foo\nbar' ; sleep 2 ; echo end ) | ( while read -t 0 ; do echo reading ; read -t 1 -n 1000 -d '' ; echo "'$REPLY'" ; sleep 1 ; done )
reading
'start
'
reading
'foo
bar'
reading
'end
'
reading
''
reading
''
...
[continues endlessly]
</code></pre>
<p>versus</p>
<pre><code># ( echo start ; sleep 2 ; echo -en 'foo\nbar' ; sleep 2 ; echo end ) | ( while read -t 0 ; do echo reading ; read -t 1 -n 1000 -d '' ; echo "'$REPLY'" ; done )
bash: echo: write error: Broken pipe
bash: echo: write error: Broken pipe
bash: echo: write error: Broken pipe
</code></pre>
<p>or</p>
<pre><code># { echo start ; sleep 2 ; echo -en 'foo\nbar' ; sleep 2 ; echo end ; } | { while read -t 0 ; do echo reading ; read -t 1 -n 1000 -d '' ; echo "'$REPLY'" ; sleep 1 ; done ; }
bash: echo: write error: Broken pipe
bash: echo: write error: Broken pipe
</code></pre>
<p>Because I cannot know how the user will connect<br />
the process that does the 'read' (usr/sbin/rear)<br />
with the process that provides read's input<br />
(the users's normal terminal or something else<br />
where <code>test -t 0</code> still results zero exit code),<br />
I will not risk any possibility to hang up ReaR<br />
only because to avoid possible bad outcomes when<br />
a user carelessly types things on his keyboard<br />
regardless that he should not type randomly<br />
while a program is running that uses stdin.</p>
<p>So I will not use any kind of unlimited loop.</p>
<p>Meanwhile I think a single</p>
<pre><code>read -s -t 1 -n 1000 -d ''
</code></pre>
<p>is sufficient for what is actually needed here in practice<br />
which is primarily to drain some accidental additional ENTER<br />
which can accidentally happen also to experienced users<br />
(in contrast to random typing things on the keyboard).</p>
<p>Of course it happened to me during the sequence of user input<br />
dialogs during "rear recover" with MIGRATION_MODE="true"<br />
where most dialogs are OK so one gets used to hit ENTER<br />
until the one dialog appears where one needs to select<br />
something specific (instead of the default via ENTER).</p>
<p>How <code>read -s -t 1 -n 1000 -d ''</code> behaves for me:</p>
<p>On SLES10 with bash 3.1.17:</p>
<pre><code># for i in $( seq 10 ) ; do echo $i ; done | ( read -s -t 1 -n 1000 -d '' ; echo "'$REPLY'" | od -a )
0000000   '   1  nl   2  nl   3  nl   4  nl   5  nl   6  nl   7  nl   8
0000020  nl   9  nl   1   0  nl   '  nl

# for i in $( seq 10 ) ; do echo $i ; done | ( read -s -t 1 -n 10 -d '' ; echo "'$REPLY'" | od -a )
0000000   '   1  nl   2  nl   3  nl   4  nl   5  nl   '  nl

# time read -s -t 1 -n 1000 -d ''
real    0m1.002s
user    0m0.000s
sys     0m0.000s
</code></pre>
<p>On openSUSE Leap 15.3 with bash 4.4.23:</p>
<pre><code># for i in $( seq 10 ) ; do echo $i ; done | ( read -s -t 1 -n 1000 -d '' ; echo "'$REPLY'" | od -a )
0000000   '   1  nl   2  nl   3  nl   4  nl   5  nl   6  nl   7  nl   8
0000020  nl   9  nl   1   0  nl   '  nl

# for i in $( seq 10 ) ; do echo $i ; done | ( read -s -t 1 -n 10 -d '' ; echo "'$REPLY'" | od -a )
0000000   '   1  nl   2  nl   3  nl   4  nl   5  nl   '  nl

# time read -s -t 1 -n 1000 -d ''
real    0m1.000s
user    0m0.000s
sys     0m0.000s
</code></pre>
<p>This causes again a one second delay when there is no input<br />
but that should not matter in practice in interactive mode.<br />
This one second delay might even be useful in practice<br />
because this way the user may not too easily get used<br />
to carelessly hit ENTER ENTER ENTER... when there is<br />
a sequence of dialogs.</p>
<p>What matters first and foremost is: "It Has To Work."<br />
RFC 1925 item 1
<a href="https://datatracker.ietf.org/doc/html/rfc1925">https://datatracker.ietf.org/doc/html/rfc1925</a></p>
<p>See also the "Maintain backward compatibility" section<br />
in
<a href="https://github.com/rear/rear/wiki/Coding-Style">https://github.com/rear/rear/wiki/Coding-Style</a></p>
<pre><code>Preferably use simple generic functionality
that works on any Linux system.
Better very simple code than oversophisticated
(possibly fragile) constructs.
</code></pre>
<h4 id="jsmeix_commented_at_2022-09-26_1348"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2868#issuecomment-1258070830">2022-09-26 13:48</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-09-26_1348" title="Permanent link">&para;</a></h4>
<p>I tested my latest commit<br />
<a href="https://github.com/rear/rear/pull/2868/commits/5f28472c018c312f8c6ba2eeee0fa340ceffecaa">https://github.com/rear/rear/pull/2868/commits/5f28472c018c312f8c6ba2eeee0fa340ceffecaa</a><br />
during "rear recover" with MIGRATION_MODE="true"<br />
and it behaves perfectly well for me in practice, cf.<br />
<a href="https://github.com/rear/rear/pull/2868#issuecomment-1257988466">https://github.com/rear/rear/pull/2868#issuecomment-1257988466</a><br />
what it is primarily meant to do in practice.</p>
<h4 id="jsmeix_commented_at_2022-09-26_1349"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2868#issuecomment-1258072934">2022-09-26 13:49</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-09-26_1349" title="Permanent link">&para;</a></h4>
<p>@pcahyna @rear/contributors<br />
if there are no objections I would like to merge it<br />
tomorrow afternoon in its current state.<br />
If later issues appear I will of course fix them.</p>
<h4 id="pcahyna_commented_at_2022-09-26_1651"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/2868#issuecomment-1258338381">2022-09-26 16:51</a>:<a class="headerlink" href="#pcahyna_commented_at_2022-09-26_1651" title="Permanent link">&para;</a></h4>
<p>@jsmeix I agree with the reasoning that simple code covering the most
problematic case is preferred. One question, why have you added <code>-d ''</code>?
That was not in any of the previous attempts and experiments as far as I
could see. According to the manual, "The first character of DELIM is
used to terminate the input line, rather than newline. If DELIM is the
empty string, 'read' will terminate a line when it reads a NUL
character." So, are you counting on the fact that the NUL character
should never appear in the input and therefore this allows the command
to skip multiple ENTERs ?</p>
<h4 id="jsmeix_commented_at_2022-09-27_0709"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2868#issuecomment-1259077998">2022-09-27 07:09</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-09-27_0709" title="Permanent link">&para;</a></h4>
<p>Yes, that's the intent behind <code>-d ''</code>.<br />
I have that from<br />
<a href="https://superuser.com/questions/276531/clear-stdin-before-reading">https://superuser.com/questions/276531/clear-stdin-before-reading</a><br />
which reads (excerpt):</p>
<pre><code>read -d '' -t 0.1 -n 10000

This reads multiple lines of inputs,
if the user inadvertently pressed enter multiple times
</code></pre>
<p>For me <code>-d ''</code> seems to also work with bash 3.x<br />
but neither "man bash" nor "help read" tell about<br />
what 'read' does when the delimiter is the empty string.<br />
This is only described in<br />
<a href="https://www.gnu.org/software/bash/manual/html_node/Bash-Builtins.html">https://www.gnu.org/software/bash/manual/html_node/Bash-Builtins.html</a><br />
which is currtently "for Bash, Version 5.2.", see<br />
<a href="https://www.gnu.org/software/bash/manual/html_node/index.html">https://www.gnu.org/software/bash/manual/html_node/index.html</a></p>
<p>Previously I had tested <code>-d '~'</code> see<br />
<a href="https://github.com/rear/rear/pull/2868#discussion_r978452551">https://github.com/rear/rear/pull/2868#discussion_r978452551</a></p>
<pre><code>What works for me even with bash 3.x is
using an artificial delimiter character
that is sufficiently unlikely
to be accidentally entered by the user:

# echo -e 'One\nTwo\nThree' | ( read -t 1 -d '~' -n 10 D ; read R1 ; read R2 ; echo D "$D" ; echo R1 "$R1" ; echo R2 "$R2" )
D One
Two
Th
R1 ree
R2
</code></pre>
<h4 id="jsmeix_commented_at_2022-09-27_0718"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2868#issuecomment-1259087491">2022-09-27 07:18</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-09-27_0718" title="Permanent link">&para;</a></h4>
<p>I think I can avoid<br />
the one second delay when there is no input<br />
in a simple and fail safe way via</p>
<pre><code>test -t 0 &amp;&amp; read -t 0 &amp;&amp; read -s -t 1 -n 1000 -d ''
</code></pre>
<p>When <code>read -t 0</code> falsely results non zero exit code<br />
but there is someting in stdin, then<br />
draining stdin would be falsely skipped which is no big issue<br />
because then UserInput() falls back to working as before and<br />
normally there should be nothing accidentally pending in stdin.</p>
<p>When <code>read -t 0</code> falsely results zero exit code<br />
but there is nothing in stdin, then<br />
the subsequent <code>rear -t 1</code> times out after one second.</p>
<h4 id="jsmeix_commented_at_2022-09-27_1111"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2868#issuecomment-1259346284">2022-09-27 11:11</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-09-27_1111" title="Permanent link">&para;</a></h4>
<p><code>read -t 0</code> may not work sufficiently reliably<br />
when automated input is provided (here with bash 4.4.23):</p>
<pre><code># for i in $( seq 5 ) ; do echo -n $i ; done | ( read -t 0 &amp;&amp; read -s -t 1 -n 100 -d '' ; echo -n "'$REPLY'" | od -a )
0000000   '   '
0000002

# for i in $( seq 5 ) ; do echo -n $i ; done | ( read -t 0 &amp;&amp; read -s -t 1 -n 100 -d '' ; echo -n "'$REPLY'" | od -a )
0000000   '   '
0000002
bash: echo: write error: Broken pipe
bash: echo: write error: Broken pipe
bash: echo: write error: Broken pipe
bash: echo: write error: Broken pipe
bash: echo: write error: Broken pipe
</code></pre>
<p>I think this happens<br />
when <code>read -t 0</code> is called in the pipe consumer<br />
before the pipe producer made actual output<br />
and the "Broken pipe" happens when the pipe consumer<br />
already finished so the 'echo' in the pipe producer<br />
writes into a "Broken pipe".</p>
<p>With a sleep in the pipe consumer it works:</p>
<pre><code># for i in $( seq 5 ) ; do echo -n $i ; done | ( sleep 1 ; read -t 0 &amp;&amp; read -s -t 1 -n 100 -d '' ; echo -n "'$REPLY'" | od -a )
0000000   '   1   2   3   4   5   '
0000007
</code></pre>
<p>I think in ReaR such a race condition cannot happen<br />
because the stdin producer process<br />
(usually the user's terminal emulation program)<br />
is already running when the usr/sbin/rear process<br />
gets started by the user on his termial.</p>
<p>When usr/sbin/rear is run where stdin is not a terminal<br />
the <code>test -t 0</code> won't let the 'read' calls happen.</p>
<p>When usr/sbin/rear is run by the user in whatever special<br />
way where stdin is a terminal and somehow automated input<br />
is fed with a little delay into usr/sbin/rear, then<br />
the 'read' calls should happen late enough to work OK.</p>
<h4 id="jsmeix_commented_at_2022-09-27_1233"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2868#issuecomment-1259441276">2022-09-27 12:33</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-09-27_1233" title="Permanent link">&para;</a></h4>
<p>I tested my latest commit<br />
<a href="https://github.com/rear/rear/pull/2868/commits/c482b2bdc6cdad5be077026b01ce4e42fd5e2d53">https://github.com/rear/rear/pull/2868/commits/c482b2bdc6cdad5be077026b01ce4e42fd5e2d53</a><br />
during "rear recover" with MIGRATION_MODE="true"<br />
and it behaves perfectly well for me.</p>
<h4 id="jsmeix_commented_at_2022-09-27_1235"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2868#issuecomment-1259442953">2022-09-27 12:35</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-09-27_1235" title="Permanent link">&para;</a></h4>
<p>@pcahyna @rear/contributors<br />
if there are no objections I would like to merge it<br />
tomorrow afternoon in its last state which is</p>
<pre><code>test -t 0 &amp;&amp; read -t 0 &amp;&amp; read -s -t 1 -n 1000 -d ''
</code></pre>
<p>If issues appear later I will of course fix them.</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2022 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2022-09-22.2868.pr.merged.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
