<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#3518 PR merged: Fix duplicate automatic recovery start after merge of PR #3041 and related changes - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#3518 PR merged: Fix duplicate automatic recovery start after merge of PR #3041 and related changes";
        var mkdocs_page_input_path = "issues/2025-09-10.3518.pr.merged.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/backup_netfs.html">Example of BACKUP=NETFS</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/netfs_nas.html">Internal Backup with tar to NFS server</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/netfs_rsync.html">Internal Backup with rsync to NFS server</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/rbme.html">External Backup using RBME</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/restic.html">External Backup using restic</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../development/squash-git-log-commments.html">How to squash git log comments into one line</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear29.html">Release Notes ReaR 2.9</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear28.html">Release Notes ReaR 2.8</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#3518 PR merged: Fix duplicate automatic recovery start after merge of PR #3041 and related changes</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="3518_pr_merged_fix_duplicate_automatic_recovery_start_after_merge_of_pr_3041_and_related_changes"><a href="https://github.com/rear/rear/pull/3518">#3518 PR</a> <code>merged</code>: Fix duplicate automatic recovery start after merge of PR #3041 and related changes<a class="headerlink" href="#3518_pr_merged_fix_duplicate_automatic_recovery_start_after_merge_of_pr_3041_and_related_changes" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>bug</code></p>
<h4 id="pcahyna_opened_issue_at_2025-09-10_1221"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> opened issue at <a href="https://github.com/rear/rear/pull/3518">2025-09-10 12:21</a>:<a class="headerlink" href="#pcahyna_opened_issue_at_2025-09-10_1221" title="Permanent link">&para;</a></h4>
<h5 id="pull_request_details">Pull Request Details:<a class="headerlink" href="#pull_request_details" title="Permanent link">&para;</a></h5>
<ul>
<li>
<p>Type: <strong>Bug Fix</strong></p>
</li>
<li>
<p>Impact: <strong>High</strong></p>
</li>
<li>
<p>Reference to related issue (URL):
    <a href="https://github.com/rear/rear/pull/3041#issuecomment-3210788660">https://github.com/rear/rear/pull/3041#issuecomment-3210788660</a></p>
</li>
<li>
<p>How was this pull request tested?</p>
<ul>
<li>Full backup and unattended recovery, the console shows
    sysinit.service started before ReaR automated recovery
    (automatic-rear.service) begins starting:</li>
</ul>
</li>
</ul>
<!-- -->

<pre><code>Starting         
sysinit.service   
 - Initialize Rescue System...  
[      
  OK     
] Finished         
systemd-udev-trigger.service   
 - udev Coldplug all Devices.  
[      
  OK     
] Found device         
dev-ttyS0.device   
 - /dev/ttyS0.  
[    4.336554] Error: Driver 'pcspkr' is already registered, aborting...

Verifying md5sums of the files in the Relax-and-Recover rescue system 
md5sums are OK

Configuring Relax-and-Recover rescue system

Running 00-functions.sh... 
(...)
Running 99-makedev.sh...

Relax-and-Recover rescue system is ready

[      
  OK     
] Finished         
sysinit.service   
 - Initialize Rescue System.  
[      
  OK     
] Reached target         
network-online.target   
 - Network is Online.  
[      
  OK     
] Reached target         
sysinit.target   
 - System Initialization.  
[      
  OK     
] Listening on         
dbus.socket   
 - D-Bus System Message Bus Socket.  
[      
  OK     
] Listening on         
syslog.socket   
 - Syslog Socket.  
[      
  OK     
] Reached target         
sockets.target   
 - Sockets.  
[      
  OK     
] Reached target         
basic.target   
 - Basic System.  
         Starting         
automatic-rear.service   
 - …overy automatically if requested...  
[      
  OK     
] Started         
systemd-journald.service   
 - Journal Service.  
[   24.895473] systemd-journald[532]: 1 unknown file descriptors passed, closing. 
Launching 'rear recover' automatically in unattended (non-interactive) mode 
Relax-and-Recover 2.9-git.5699.8831a249.fixautomaticrearmismerge.changed / 2025-08-26 
Running rear recover (PID 548 date 2025-09-09 06:33:57)
</code></pre>
<ul>
<li>full backup and unattended recovery with the line
    <code>mv /usr/share/rear/conf/default.conf /usr/share/rear/conf/default.conf.bak</code>
    inserted at the beginning of
    <code>usr/share/rear/skel/default/etc/scripts/system-setup</code> to test
    behavior when it breaks, automated recovery does not start, console
    log then shows:</li>
</ul>
<!-- -->

<pre><code>ERROR: ReaR recovery cannot work without /usr/share/rear/conf/default.conf

[   14.292649] systemd[1]: sysinit.service: Failed with result 'exit-code'. 
[   14.293966] systemd[1]: Failed to start sysinit.service - Initialize Rescue System. 
[        
FAILED   
] Failed to start         
sysinit.service   
 - Initialize Rescue System.  
See 'systemctl status sysinit.service' for details.  
[   14.297570] systemd[1]: Dependency failed for automatic-rear.service - Run Relax-and-Recover recovery automatically if requested. 
[ [0;1;38:5:185mDEPEND   
] Dependency failed for         
automatic-re…   
ecovery automatically if requested.
</code></pre>
<ul>
<li>Description of the changes in this pull request:<ul>
<li>Fix botched merge of #3041 : the code tor automatic ReaR
    startup was left in
    <code>usr/share/rear/skel/default/etc/scripts/system-setup</code> in
    addition to the new copy in
    <code>usr/share/rear/skel/default/etc/scripts/run-automatic-rear</code>, so
    when the unattended command line is present, <code>rear recover</code>
    starts in automatic (but not unattended!) mode even before
    systemd finishes initialization of all services. Moreover, if
    that recovery fails, ReaR executes it again but now with the
    correct mode and order using the automatic-rear.service. Found
    by @lzaoral in
    <a href="https://github.com/rear/rear/pull/3041#issuecomment-3210788660">https://github.com/rear/rear/pull/3041#issuecomment-3210788660</a>.
    Fixed by removing the duplicate original code and carefully
    merging changes done to it since the code was copied into the
    new copy in order to preserve them.</li>
<li>Restore the behavior of automated recovery on errors: before
    #3041, if the script <code>system-setup</code> terminated with an error,
    automated recovery was not executed. After #3041 (this is not
    related to the merge botch), it starts in any case, as it is a
    separate script and service unit. Fix by introducing a hard
    dependency between the units.</li>
<li>Add back a mention of unattended mode when ReaR recovery starts
    unattended. Now it prints
    <code>Launching 'rear recover' automatically in unattended (non-interactive) mode</code>.
    This was lost in fec92e291024ccfd329e51ed02265f18713d28b0 by
    @jsmeix.</li>
<li>Shorten description of automatic-rear.service. Shorter
    description will not be truncated when included in system boot<br />
    messages printed on console, resulting in better readability.<br />
    Message before:
    <code>Starting automatic-rear.service - …overy automatically if requested...</code><br />
    Message after:
    <code>Starting automatic-rear.service - Automatic recovery if requested...</code></li>
</ul>
</li>
</ul>
<h4 id="pcahyna_commented_at_2025-09-10_1223"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/3518#issuecomment-3274715622">2025-09-10 12:23</a>:<a class="headerlink" href="#pcahyna_commented_at_2025-09-10_1223" title="Permanent link">&para;</a></h4>
<p>@jsmeix commit 8831a249e87fe06a136e12914d3c53119eb95802 revers one
change that you did, please have a look if you agree.</p>
<h4 id="pcahyna_commented_at_2025-09-10_1228"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/3518#issuecomment-3274736121">2025-09-10 12:28</a>:<a class="headerlink" href="#pcahyna_commented_at_2025-09-10_1228" title="Permanent link">&para;</a></h4>
<p>Note: Codacy is wrong, one does not need to <code>export</code> variables set in a
shell function in order to be seen outside the function (not marking
them as <code>local</code> is enough) and they can be also used in called functions
/ sourced scripts, as the shell uses dynamic and not lexical scoping of
variables.</p>
<h4 id="jsmeix_commented_at_2025-09-10_1318"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/3518#issuecomment-3274951380">2025-09-10 13:18</a>:<a class="headerlink" href="#jsmeix_commented_at_2025-09-10_1318" title="Permanent link">&para;</a></h4>
<p>@pcahyna<br />
thank you for your fix of my code!<br />
Your<br />
<a href="https://github.com/rear/rear/commit/8831a249e87fe06a136e12914d3c53119eb95802">https://github.com/rear/rear/commit/8831a249e87fe06a136e12914d3c53119eb95802</a><br />
does exactly the right thing because in my<br />
<a href="https://github.com/rear/rear/commit/fec92e291024ccfd329e51ed02265f18713d28b0">https://github.com/rear/rear/commit/fec92e291024ccfd329e51ed02265f18713d28b0</a><br />
I first correctly replaced for <code>automatic_recovery</code> mode</p>
<pre><code>echo -e "\nLaunching 'rear recover' automatically\n"
</code></pre>
<p>by</p>
<pre><code>echo "Launching '$RECOVERY_COMMANDS_LABEL' automatically"
</code></pre>
<p>but subsequently<br />
I falsely replaced for <code>unattended_recovery</code> mode</p>
<pre><code>echo -e "\nLaunching 'rear recover' automatically in unattended (non-interactive) mode\n"
</code></pre>
<p>by the same as above</p>
<pre><code>echo "Launching '$RECOVERY_COMMANDS_LABEL' automatically"
</code></pre>
<p>instead of the correct</p>
<pre><code>echo "Launching '$RECOVERY_COMMANDS_LABEL' automatically in unattended (non-interactive) mode"
</code></pre>
<p>I am sure this happended because I did copy&amp;paste<br />
of my code for the <code>automatic_recovery</code> case<br />
without proper adaptions to the <code>unattended_recovery</code> case.</p>
<h4 id="pcahyna_commented_at_2025-09-10_1422"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/3518#issuecomment-3275213720">2025-09-10 14:22</a>:<a class="headerlink" href="#pcahyna_commented_at_2025-09-10_1422" title="Permanent link">&para;</a></h4>
<p>@jsmeix you are welcome and the change was actually found by @lzaoral,
thanks!</p>
<h4 id="jsmeix_commented_at_2025-09-10_1440"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/3518#issuecomment-3275295135">2025-09-10 14:40</a>:<a class="headerlink" href="#jsmeix_commented_at_2025-09-10_1440" title="Permanent link">&para;</a></h4>
<p>@lzaoral<br />
thank you for your fix of my code!</p>
<h4 id="pcahyna_commented_at_2025-09-11_1304"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/3518#issuecomment-3280556806">2025-09-11 13:04</a>:<a class="headerlink" href="#pcahyna_commented_at_2025-09-11_1304" title="Permanent link">&para;</a></h4>
<p>@jsmeix thanks for checking and the confirmation. I pushed to update the
commit message (avoiding the "perhaps it was<br />
intentional" part), no code changes.</p>
<h4 id="pcahyna_commented_at_2025-09-11_1824"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/3518#issuecomment-3282161344">2025-09-11 18:24</a>:<a class="headerlink" href="#pcahyna_commented_at_2025-09-11_1824" title="Permanent link">&para;</a></h4>
<p>I rebased the branch on top of the current master and added another "by
the way" change: I shortened the description of automatic-rear.service
so that systemd does not truncate it when printing system boot messages
on console.</p>
<h4 id="pcahyna_commented_at_2025-09-12_1652"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/3518#issuecomment-3286058148">2025-09-12 16:52</a>:<a class="headerlink" href="#pcahyna_commented_at_2025-09-12_1652" title="Permanent link">&para;</a></h4>
<p>@rear/contributors I would like to merge it next week.</p>
<h4 id="pcahyna_commented_at_2025-09-17_1407"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/3518#issuecomment-3303179830">2025-09-17 14:07</a>:<a class="headerlink" href="#pcahyna_commented_at_2025-09-17_1407" title="Permanent link">&para;</a></h4>
<p>@rear/contributors If there are no objections, I plan to merge it
tomorrow before noon.</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2025 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2025-09-10.3518.pr.merged.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/rear/rear-user-guide" class="fa fa-code-fork" style="color: #fcfcfc"> rear/rear-user-guide</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
