<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#3107 Issue closed: Debug intermittent backup/recovery CI errors - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#3107 Issue closed: Debug intermittent backup/recovery CI errors";
        var mkdocs_page_input_path = "issues/2023-12-13.3107.issue.closed.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/backup_netfs.html">Example of BACKUP=NETFS</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear28.html">Release Notes ReaR 2.8</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#3107 Issue closed: Debug intermittent backup/recovery CI errors</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="3107_issue_closed_debug_intermittent_backuprecovery_ci_errors"><a href="https://github.com/rear/rear/issues/3107">#3107 Issue</a> <code>closed</code>: Debug intermittent backup/recovery CI errors<a class="headerlink" href="#3107_issue_closed_debug_intermittent_backuprecovery_ci_errors" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>fixed / solved / done</code>, <code>ReaR Project</code></p>
<h4 id="pcahyna_opened_issue_at_2023-12-13_1557"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> opened issue at <a href="https://github.com/rear/rear/issues/3107">2023-12-13 15:57</a>:<a class="headerlink" href="#pcahyna_opened_issue_at_2023-12-13_1557" title="Permanent link">&para;</a></h4>
<p>See the failed <code>testing-farm:centos-stream-8-x86_64</code> test in #3104 :
<a href="https://github.com/rear/rear/pull/3104/checks?check_run_id=19567464768">https://github.com/rear/rear/pull/3104/checks?check_run_id=19567464768</a><br />
As console log in the Testing Farm infrastructure is now enabled, we can
look at the console output:
<a href="https://artifacts.dev.testing-farm.io/a24b1484-7fc1-4e2a-8077-e72f9eea6cca/work-backup-and-restorefmaugnmx/console-68975dbe-0cbe-49ae-aa05-47d8fec8b66f.log">https://artifacts.dev.testing-farm.io/a24b1484-7fc1-4e2a-8077-e72f9eea6cca/work-backup-and-restorefmaugnmx/console-68975dbe-0cbe-49ae-aa05-47d8fec8b66f.log</a>
. It show this error:</p>
<pre><code>Running workflow recover within the ReaR rescue/recovery system
Running PRE_RECOVERY_SCRIPT 'mkdir /tmp/mnt; mount /dev/nvme0n1p1 /tmp/mnt/; modprobe brd rd_nr=1 rd_size=2097152; dd if=/tmp/mnt//var/lib/rear/output/rear-ip-172-31-16-70.iso of=/dev/ram0; umount /tmp/mnt/;'
/etc/scripts/system-setup: line 255:   545 Killed                  rear $rear_options recover
'eval rear $rear_options recover' results exit code 137
'rear recover' failed with exit code 137
1) View Relax-and-Recover log file(s)
2) Login at the rescue system
</code></pre>
<p>It does not tell us what happened, but it at least shows where. I
suspect that the fact that we don't see what happened is due to the
kernel not printing its log messages, which is due to<br />
<a href="https://github.com/rear/rear/blob/b1e9f5e1cbc735ed90526ff7fa54b922fcfa60e7/usr/share/rear/skel/default/etc/scripts/boot#L4">https://github.com/rear/rear/blob/b1e9f5e1cbc735ed90526ff7fa54b922fcfa60e7/usr/share/rear/skel/default/etc/scripts/boot#L4</a><br />
that was added 92d3a15be54137ae0f00f550c5e9e58d68142617 with the commit
message <code>Added dmesg -n1 to rescue system</code> without explaining why.<br />
Having kernel log messages on the console would be helpful for debugging
filesystem-related errors like #2777 (see #3058 for explanation : when
mount fails, the mount commands display only the unhelpful message
<code>wrong fs type, bad option, bad superblock on ..., missing codepage or helper program, or other error</code>,
and the real cause of the error like
<code>XFS (...): logbuf size must be greater than or equal to log stripe size</code>
is printed by the kernel to the message log).</p>
<p>Anyway, since the error happens when loading the ISO into a ramdisk (the
whole ISO gets loaded into a ramdisk in this test procedure), I suspect
that we are out of memory at this point. The failed test shows</p>
<pre><code>Memory: 2052384K/3503836K available
</code></pre>
<p>and a successful test ( CentOS-Stream-9 ) shows</p>
<pre><code>Memory: 2931284K/3942236K available
</code></pre>
<p>so indeed, successful test seems to have run on a machine with more
memory than the failed test.</p>
<p><em>Originally posted by @pcahyna in
<a href="https://github.com/rear/rear/issues/3104#issuecomment-1854191792">https://github.com/rear/rear/issues/3104#issuecomment-1854191792</a></em></p>
<h4 id="jsmeix_commented_at_2023-12-14_0915"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/3107#issuecomment-1855464867">2023-12-14 09:15</a>:<a class="headerlink" href="#jsmeix_commented_at_2023-12-14_0915" title="Permanent link">&para;</a></h4>
<p>An offhanded idea regarding <code>dmesg -n1</code>:</p>
<p>Regardless what the actual reason is for <code>dmesg -n1</code><br />
it seems that at least "under normal circumstances"<br />
kernel log messages on the console are not wanted.</p>
<p>I assume kernel log messages on the console<br />
do not matter when "rear recover" is run<br />
in unattended mode because in unattended mode<br />
there is noone who actively works on the console<br />
so it does not matter which and how many messages<br />
appear on the console.</p>
<p>Therefore <code>dmesg -n1</code> may only be set when<br />
"rear recover" is not run in unattended mode<br />
similar as in [skel/default]/etc/scripts/system-setup<br />
e.g. like (simpler code for this case here)</p>
<pre><code># disable console logging for kernel messages
# when not in unattended mode:
cat /proc/cmdline | grep -qw unattended || dmesg -n1
</code></pre>
<p>By the way:<br />
A simple <code>grep -w WORD</code> may not work sufficiently fail-safe</p>
<pre><code># echo 'foo-unattended' | grep -w unattended &amp;&amp; echo y || echo n
foo-unattended
y

# echo 'foo_unattended' | grep -w unattended &amp;&amp; echo y || echo n
n
</code></pre>
<p>because in grep a word consists of<br />
alphanumeric characters and the underscore<br />
so e.g. '-' is a word separator in grep<br />
in contrast to bash where $IFS are word separators<br />
which is the reason for my more (and hopefully sufficiently)<br />
elaborated code in [skel/default]/etc/scripts/system-setup<br />
by using an artificial bash array.</p>
<h4 id="pcahyna_commented_at_2023-12-14_1013"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/3107#issuecomment-1855560152">2023-12-14 10:13</a>:<a class="headerlink" href="#pcahyna_commented_at_2023-12-14_1013" title="Permanent link">&para;</a></h4>
<p>@jsmeix</p>
<blockquote>
<p>Regardless what the actual reason is for <code>dmesg -n1</code><br />
it seems that at least "under normal circumstances"<br />
kernel log messages on the console are not wanted.</p>
</blockquote>
<p>kernel log messages on the console are useful for diagnostics and thus
wanted when circumstances are not normal anymore. Here is the excerpt
from <code>dmesg -h</code> that explains the log levels (can be used as arguments
to <code>-n</code> ):</p>
<pre><code>Supported log levels (priorities):
   emerg - system is unusable
   alert - action must be taken immediately
    crit - critical conditions
     err - error conditions
    warn - warning conditions
  notice - normal but significant condition
    info - informational
   debug - debug-level messages
</code></pre>
<p>When debugging
<a href="https://github.com/rear/rear/issues/2777">https://github.com/rear/rear/issues/2777</a>
I tested what was needed to make the XFS error appear on the console,
and took notes. It was necessary to set console the log level to at
least 5. For this reason, I would like to raise the log level to at
least 5 even if not in the unattended mode.</p>
<h4 id="pcahyna_commented_at_2023-12-14_1027"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/3107#issuecomment-1855582698">2023-12-14 10:27</a>:<a class="headerlink" href="#pcahyna_commented_at_2023-12-14_1027" title="Permanent link">&para;</a></h4>
<p>I mean, raise from the current setting, the kernel default may be even
higher.</p>
<h4 id="jsmeix_commented_at_2023-12-14_1052"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/3107#issuecomment-1855624103">2023-12-14 10:52</a>:<a class="headerlink" href="#jsmeix_commented_at_2023-12-14_1052" title="Permanent link">&para;</a></h4>
<p>So dmesg log level 4 "err - error conditions" is insufficient<br />
to make the XFS <strong>error</strong> appear on the console and you needed<br />
dmesg log level 5 "warn - warning conditions".<br />
Sigh, see<br />
<a href="https://schlomo.schapiro.org/2015/04/warning-is-waste-of-my-time.html">https://schlomo.schapiro.org/2015/04/warning-is-waste-of-my-time.html</a></p>
<h4 id="pcahyna_commented_at_2023-12-14_1137"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/3107#issuecomment-1855687053">2023-12-14 11:37</a>:<a class="headerlink" href="#pcahyna_commented_at_2023-12-14_1137" title="Permanent link">&para;</a></h4>
<p>Yes, it is clearly an error because the kernel could not do what was
requested. Unfortunately, not much we can do about it.</p>
<h4 id="jsmeix_commented_at_2023-12-14_1204"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/3107#issuecomment-1855727879">2023-12-14 12:04</a>:<a class="headerlink" href="#jsmeix_commented_at_2023-12-14_1204" title="Permanent link">&para;</a></h4>
<p>I like 'dmesg -n 5' very much.<br />
I tested "rear recover" up to 'dmesg -n 7'<br />
see
<a href="https://github.com/rear/rear/pull/3108">https://github.com/rear/rear/pull/3108</a></p>
<p>I think (according to what I get on my test system)<br />
'dmesg -n 5' provides really a very good balance<br />
between helpfulness to be able to diagnose problems<br />
and not disturbing the user with needless information.</p>
<h4 id="jsmeix_commented_at_2023-12-14_1208"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/3107#issuecomment-1855732184">2023-12-14 12:08</a>:<a class="headerlink" href="#jsmeix_commented_at_2023-12-14_1208" title="Permanent link">&para;</a></h4>
<p>I am thinking about to call <code>dmesg -n [4-7]</code> in sbin/rear<br />
depending on verbose and debug modes for ReaR e.g. like<br />
<code>dmesg -n 4</code> as minimum i.e. in non verbose mode<br />
<code>dmesg -n 5</code> in verbose mode (matches the "rear recover" default)<br />
<code>dmesg -n 6</code> in debug mode<br />
<code>dmesg -n 7</code> in debugscript mode<br />
but only inside the recovery system<br />
so no change what kernel messages appear on the console<br />
when ReaR runs on the original system.</p>
<h4 id="pcahyna_commented_at_2023-12-14_1217"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/3107#issuecomment-1855745113">2023-12-14 12:17</a>:<a class="headerlink" href="#pcahyna_commented_at_2023-12-14_1217" title="Permanent link">&para;</a></h4>
<p>verbose mode is set in ReaR, not on boot, though. I believe that the
only appropriate option that you can set on the kernel command line
before booting is <code>debug</code> (and perhaps <code>unattended</code> and
<code>auto_recover</code>/<code>automatic</code> if you want to set the log level according to
these).</p>
<h4 id="pcahyna_commented_at_2023-12-14_1221"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/3107#issuecomment-1855752012">2023-12-14 12:21</a>:<a class="headerlink" href="#pcahyna_commented_at_2023-12-14_1221" title="Permanent link">&para;</a></h4>
<p>Ah, you wrote "in sbin/rear". Then it should be removed from the startup
script to avoid setting the console level at multiple places.</p>
<h4 id="jsmeix_commented_at_2023-12-14_1242"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/3107#issuecomment-1855783591">2023-12-14 12:42</a>:<a class="headerlink" href="#jsmeix_commented_at_2023-12-14_1242" title="Permanent link">&para;</a></h4>
<p>I like 'dmesg -n 5' in [skel/default]/etc/scripts/boot<br />
to get kernel errors and warnings during<br />
ReaR recovery system startup.</p>
<p>With 'dmesg -n 5' in [skel/default]/etc/scripts/boot<br />
I do not get any kernel error or warning message<br />
during ReaR recovery system startup on my test VM<br />
so normally 'dmesg -n 5' is sufficiently quiet.</p>
<p>In contrast without any 'dmesg -n ...' in /etc/scripts/boot<br />
I get far too much kernel messages<br />
during ReaR recovery system startup on my test VM<br />
that disturb the ReaR recovery system startup messages<br />
and in particular those needless kernel messages make<br />
the intended ReaR recovery system startup messages<br />
scroll away out of sight too soon on console.</p>
<p>I guess that this was the reason behind for<br />
the 'dmesg -n1' in /etc/scripts/boot<br />
but I think 'dmesg -n1' is much too hard and<br />
makes the whole kernel messages basically useless<br />
because I think it is not helpful when the user can<br />
only see an emergency message when the system is unusable.</p>
<h4 id="jsmeix_commented_at_2023-12-14_1252"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/3107#issuecomment-1855797222">2023-12-14 12:52</a>:<a class="headerlink" href="#jsmeix_commented_at_2023-12-14_1252" title="Permanent link">&para;</a></h4>
<p>Regarding 'dmesg -n [4-7]' in sbin/rear:</p>
<p>I like that too.</p>
<p>I tested various manual 'dmesg -n [4-7]' before calling "rear
recover"<br />
and got different amounts of kernel messages on the console<br />
in particular during disk layout recreation.</p>
<p>I.e. ReaR recovery system startup was with 'dmesg -n 5' and<br />
then I set a different 'dmesg -n [4-7]' before "rear recover".</p>
<p>I think it is helpful for debugging problems<br />
when debug and debugscript mode for "rear recover"<br />
automatically increases the level of the kernel messages.</p>
<h4 id="jsmeix_commented_at_2023-12-14_1314"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/3107#issuecomment-1855831572">2023-12-14 13:14</a>:<a class="headerlink" href="#jsmeix_commented_at_2023-12-14_1314" title="Permanent link">&para;</a></h4>
<p>For the fun of it:</p>
<p>I tried with 'dmesg -n 8' before "rear recover"<br />
which shows way too many kernel messages - as expected.</p>
<p>In particular many kernel messages during disk layout recreation.<br />
Several screens full of kernel messages so most of it<br />
gets lost out of sight by fast scrolling up on console.<br />
On my test VM I have only one disk with a few partitions.</p>
<p>So 'dmesg -n 8' is over the top for "rear recover".</p>
<p>I wonder what "debug - debug-level messages" in 'dmesg -h' means.<br />
Is dmesg log level 8 meant for debugging the kernel itself<br />
or meant for debugging issues outside of the kernel?</p>
<h4 id="jsmeix_commented_at_2023-12-14_1402"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/3107#issuecomment-1855910249">2023-12-14 14:02</a>:<a class="headerlink" href="#jsmeix_commented_at_2023-12-14_1402" title="Permanent link">&para;</a></h4>
<p>@pcahyna<br />
regarding<br />
<a href="https://github.com/rear/rear/issues/3107#issue-2040010987">https://github.com/rear/rear/issues/3107#issue-2040010987</a></p>
<pre><code>the whole ISO gets loaded into a ramdisk
...
suspect that we are out of memory
...
Memory: 2052384K/3503836K available
</code></pre>
<p>It seems about 2GB of memory are available.</p>
<p>What does this ISO contain?</p>
<p>A usual ReaR recovery system ISO is about 200MB and with</p>
<pre><code>FIRMWARE_FILES=( 'no' )
MODULES=( 'loaded_modules' )
</code></pre>
<p>I get one with about 70MB on my test VM.</p>
<p>Does your ISO perhaps also contain the backup?</p>
<h4 id="pcahyna_commented_at_2023-12-14_1414"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/3107#issuecomment-1855930490">2023-12-14 14:14</a>:<a class="headerlink" href="#pcahyna_commented_at_2023-12-14_1414" title="Permanent link">&para;</a></h4>
<blockquote>
<p>Does your ISO perhaps also contain the backup?</p>
</blockquote>
<p>That's exactly it. There is no other place than RAM to store the backup
so that it survives layout recreation.</p>
<h4 id="pcahyna_commented_at_2023-12-14_1428"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/3107#issuecomment-1855953570">2023-12-14 14:28</a>:<a class="headerlink" href="#pcahyna_commented_at_2023-12-14_1428" title="Permanent link">&para;</a></h4>
<p>In #3108, the test errored again, the VM just froze. I reran it and
there is actually lots of useful output on console:</p>
<pre><code>Running PRE_RECOVERY_SCRIPT 'mkdir /tmp/mnt; mount /dev/nvme0n1p1 /tmp/mnt/; modprobe brd rd_nr=1 rd_size=2097152; dd if=/tmp/mnt//var/lib/rear/output/rear-ip-172-31-27-161.iso of=/dev/ram0; umount /tmp/mnt/;'
[   36.536328] dd invoked oom-killer: gfp_mask=0x6201c0(GFP_USER|__GFP_WRITE), order=0, oom_score_adj=0
[   36.537813] CPU: 0 PID: 1688 Comm: dd Not tainted 4.18.0-527.el8.x86_64 #1
[   36.538915] Hardware name: Amazon EC2 c6a.large/, BIOS 1.0 10/16/2017
[   36.539946] Call Trace:
[   36.540354]  dump_stack+0x41/0x60
[   36.540897]  dump_header+0x4a/0x1df
[   36.541466]  oom_kill_process.cold.33+0xb/0x10
[   36.542183]  out_of_memory+0x1bd/0x4e0
[   36.542792]  __alloc_pages_slowpath+0xbf0/0xcd0
[   36.543523]  __alloc_pages_nodemask+0x2e2/0x330
[   36.544261]  pagecache_get_page+0xce/0x310
[   36.544926]  ? blkdev_direct_IO+0x490/0x490
[   36.545604]  grab_cache_page_write_begin+0x1f/0x40
[   36.546374]  block_write_begin+0x24/0xd0
[   36.547011]  generic_perform_write+0xf2/0x1b0
[   36.547714]  ? file_update_time+0x62/0x130
[   36.548380]  __generic_file_write_iter+0x102/0x1d0
[   36.549149]  blkdev_write_iter+0xb8/0x160
[   36.549797]  ? __indirect_thunk_end+0x1e67de/0x1e67de
[   36.550607]  new_sync_write+0x112/0x160
[   36.551231]  vfs_write+0xa5/0x1b0
[   36.551778]  ksys_write+0x4f/0xb0
[   36.552323]  do_syscall_64+0x5b/0x1b0
[   36.552919]  entry_SYSCALL_64_after_hwframe+0x61/0xc6
[   36.553725] RIP: 0033:0x7fcff7bf4de8
[   36.554307] Code: 89 02 48 c7 c0 ff ff ff ff eb b3 0f 1f 80 00 00 00 00 f3 0f 1e fa 48 8d 05 55 49 2a 00 8b 00 85 c0 75 17 b8 01 00 00 00 0f 05 &lt;48&gt; 3d 00 f0 ff ff 77 58 c3 0f 1f 80 00 00 00 00 41 54 49 89 d4 55
[   36.557238] RSP: 002b:00007fff2fad50c8 EFLAGS: 00000246 ORIG_RAX: 0000000000000001
[   36.558436] RAX: ffffffffffffffda RBX: 0000000000000000 RCX: 00007fcff7bf4de8
[   36.559564] RDX: 0000000000000200 RSI: 0000563f558ca000 RDI: 0000000000000001
[   36.560697] RBP: 0000000000000200 R08: 0000000000000000 R09: 0000563f558ca060
[   36.561824] R10: 0000000000000000 R11: 0000000000000246 R12: 0000563f558ca000
[   36.562950] R13: 0000000000000800 R14: 0000000000000200 R15: 0000563f558c8200
[   36.564101] Mem-Info:
[   36.564556] active_anon:29 inactive_anon:4913 isolated_anon:0
[   36.564556]  active_file:0 inactive_file:0 isolated_file:0
[   36.564556]  unevictable:281131 dirty:0 writeback:0
[   36.564556]  slab_reclaimable:8446 slab_unreclaimable:3122
[   36.564556]  mapped:3080 shmem:2099 pagetables:234 bounce:0
[   36.564556]  free:20552 free_pcp:0 free_cma:0
[   36.569507] Node 0 active_anon:116kB inactive_anon:19652kB active_file:0kB inactive_file:0kB unevictable:1124524kB isolated(anon):0kB isolated(file):0kB mapped:12320kB dirty:0kB writeback:0kB shmem:8396kB shmem_thp: 0kB shmem_pmdmapped: 0kB anon_thp: 0kB writeback_tmp:0kB kernel_stack:1280kB pagetables:936kB all_unreclaimable? yes
[   36.574128] Node 0 DMA free:11060kB min:376kB low:468kB high:560kB active_anon:0kB inactive_anon:0kB active_file:0kB inactive_file:0kB unevictable:0kB writepending:0kB present:15992kB managed:15360kB mlocked:0kB bounce:0kB free_pcp:0kB local_pcp:0kB free_cma:0kB
[   36.577808] lowmem_reserve[]: 0 1809 2671 2671 2671
[   36.578617] Node 0 DMA32 free:49096kB min:45508kB low:56884kB high:68260kB active_anon:116kB inactive_anon:19652kB active_file:0kB inactive_file:0kB unevictable:304596kB writepending:0kB present:2543716kB managed:2433488kB mlocked:0kB bounce:0kB free_pcp:0kB local_pcp:0kB free_cma:0kB
[   36.582586] lowmem_reserve[]: 0 0 862 862 862
[   36.583304] Node 0 Normal free:22052kB min:21692kB low:27112kB high:32532kB active_anon:0kB inactive_anon:0kB active_file:0kB inactive_file:0kB unevictable:819928kB writepending:0kB present:944128kB managed:883200kB mlocked:0kB bounce:0kB free_pcp:0kB local_pcp:0kB free_cma:0kB
[   36.587151] lowmem_reserve[]: 0 0 0 0 0
[   36.587776] Node 0 DMA: 5*4kB (UE) 2*8kB (UE) 1*16kB (E) 2*32kB (UE) 1*64kB (E) 1*128kB (E) 2*256kB (UE) 2*512kB (UE) 1*1024kB (E) 2*2048kB (ME) 1*4096kB (M) = 11060kB
[   36.590146] Node 0 DMA32: 300*4kB (UME) 385*8kB (UME) 241*16kB (UME) 182*32kB (UME) 89*64kB (UME) 34*128kB (ME) 14*256kB (UME) 16*512kB (UME) 5*1024kB (M) 4*2048kB (M) 0*4096kB = 49096kB
[   36.592782] Node 0 Normal: 3*4kB (UE) 3*8kB (UME) 4*16kB (UM) 4*32kB (UME) 3*64kB (UME) 3*128kB (UME) 3*256kB (UME) 2*512kB (ME) 1*1024kB (E) 1*2048kB (E) 4*4096kB (M) = 22052kB
[   36.595286] 283230 total pagecache pages
[   36.595932] 0 pages in swap cache
[   36.596602] Swap cache stats: add 0, delete 0, find 0/0
[   36.597455] Free swap  = 0kB
[   36.597926] Total swap = 0kB
[   36.598419] 875959 pages RAM
[   36.598897] 0 pages HighMem/MovableOnly
[   36.599527] 42947 pages reserved
[   36.600079] 0 pages hwpoisoned
[   36.600627] Out of memory: Killed process 193 (systemd-journal) total-vm:87436kB, anon-rss:836kB, file-rss:6388kB, shmem-rss:872kB, UID:0 pgtables:196kB oom_score_adj:0
[   36.603686] systemd[1]: systemd-journald.service: Main process exited, code=killed, status=9/KILL
[   36.605604] systemd[1]: systemd-journald.service: Failed with result 'signal'.
[   36.643294] dd invoked oom-killer: gfp_mask=0x6201c0(GFP_USER|__GFP_WRITE), order=0, oom_score_adj=0
[   36.644768] CPU: 0 PID: 1688 Comm: dd Not tainted 4.18.0-527.el8.x86_64 #1
[   36.645868] Hardware name: Amazon EC2 c6a.large/, BIOS 1.0 10/16/2017
[   36.646882] Call Trace:
[   36.647305]  dump_stack+0x41/0x60
[   36.647846]  dump_header+0x4a/0x1df
[   36.648417]  oom_kill_process.cold.33+0xb/0x10
[   36.649143]  out_of_memory+0x1bd/0x4e0
[   36.649744]  __alloc_pages_slowpath+0xbf0/0xcd0
[   36.650472]  __alloc_pages_nodemask+0x2e2/0x330
[   36.651214]  pagecache_get_page+0xce/0x310
[   36.651877]  ? blkdev_direct_IO+0x490/0x490
[   36.652569]  grab_cache_page_write_begin+0x1f/0x40
[   36.653346]  block_write_begin+0x24/0xd0
[   36.653974]  generic_perform_write+0xf2/0x1b0
[   36.654669]  ? file_update_time+0x62/0x130
[   36.655344]  __generic_file_write_iter+0x102/0x1d0
[   36.656112]  blkdev_write_iter+0xb8/0x160
[   36.656757]  ? __indirect_thunk_end+0x1e67de/0x1e67de
[   36.657576]  new_sync_write+0x112/0x160
[   36.658194]  vfs_write+0xa5/0x1b0
[   36.658734]  ksys_write+0x4f/0xb0
[   36.659287]  do_syscall_64+0x5b/0x1b0
[   36.659888]  entry_SYSCALL_64_after_hwframe+0x61/0xc6
[   36.660694] RIP: 0033:0x7fcff7bf4de8
[   36.661287] Code: 89 02 48 c7 c0 ff ff ff ff eb b3 0f 1f 80 00 00 00 00 f3 0f 1e fa 48 8d 05 55 49 2a 00 8b 00 85 c0 75 17 b8 01 00 00 00 0f 05 &lt;48&gt; 3d 00 f0 ff ff 77 58 c3 0f 1f 80 00 00 00 00 41 54 49 89 d4 55
[   36.664222] RSP: 002b:00007fff2fad50c8 EFLAGS: 00000246 ORIG_RAX: 0000000000000001
[   36.665425] RAX: ffffffffffffffda RBX: 0000000000000000 RCX: 00007fcff7bf4de8
[   36.666545] RDX: 0000000000000200 RSI: 0000563f558ca000 RDI: 0000000000000001
[   36.667682] RBP: 0000000000000200 R08: 0000000000000000 R09: 0000563f558ca060
[   36.668809] R10: 0000000000000000 R11: 0000000000000246 R12: 0000563f558ca000
[   36.669946] R13: 0000000000000800 R14: 0000000000000200 R15: 0000563f558c8200
[   36.671104] Mem-Info:
[   36.671480] active_anon:29 inactive_anon:4704 isolated_anon:0
[   36.671480]  active_file:1 inactive_file:11 isolated_file:0
[   36.671480]  unevictable:281131 dirty:1 writeback:0
[   36.671480]  slab_reclaimable:8439 slab_unreclaimable:3106
[   36.671480]  mapped:2808 shmem:2099 pagetables:187 bounce:0
[   36.671480]  free:20412 free_pcp:0 free_cma:0
[   36.676395] Node 0 active_anon:116kB inactive_anon:18816kB active_file:4kB inactive_file:44kB unevictable:1124524kB isolated(anon):0kB isolated(file):0kB mapped:11232kB dirty:4kB writeback:0kB shmem:8396kB shmem_thp: 0kB shmem_pmdmapped: 0kB anon_thp: 0kB writeback_tmp:0kB kernel_stack:1264kB pagetables:748kB all_unreclaimable? yes
[   36.680976] Node 0 DMA free:11060kB min:376kB low:468kB high:560kB active_anon:0kB inactive_anon:0kB active_file:0kB inactive_file:0kB unevictable:0kB writepending:0kB present:15992kB managed:15360kB mlocked:0kB bounce:0kB free_pcp:0kB local_pcp:0kB free_cma:0kB
[   36.684616] lowmem_reserve[]: 0 1809 2671 2671 2671
[   36.685422] Node 0 DMA32 free:48924kB min:45508kB low:56884kB high:68260kB active_anon:116kB inactive_anon:18816kB active_file:0kB inactive_file:0kB unevictable:304596kB writepending:0kB present:2543716kB managed:2433488kB mlocked:0kB bounce:0kB free_pcp:0kB local_pcp:0kB free_cma:0kB
[   36.689355] lowmem_reserve[]: 0 0 862 862 862
[   36.690064] Node 0 Normal free:21664kB min:21692kB low:27112kB high:32532kB active_anon:0kB inactive_anon:0kB active_file:4kB inactive_file:44kB unevictable:819928kB writepending:4kB present:944128kB managed:883200kB mlocked:0kB bounce:0kB free_pcp:0kB local_pcp:0kB free_cma:0kB
[   36.693932] lowmem_reserve[]: 0 0 0 0 0
[   36.694563] Node 0 DMA: 5*4kB (UE) 2*8kB (UE) 1*16kB (E) 2*32kB (UE) 1*64kB (E) 1*128kB (E) 2*256kB (UE) 2*512kB (UE) 1*1024kB (E) 2*2048kB (ME) 1*4096kB (M) = 11060kB
[   36.697068] Node 0 DMA32: 328*4kB (UME) 398*8kB (UME) 246*16kB (UME) 187*32kB (UME) 93*64kB (UME) 37*128kB (UME) 13*256kB (ME) 15*512kB (ME) 5*1024kB (M) 4*2048kB (M) 0*4096kB = 49424kB
[   36.699697] Node 0 Normal: 1*4kB (E) 5*8kB (UME) 4*16kB (UM) 3*32kB (UME) 2*64kB (ME) 3*128kB (UME) 2*256kB (ME) 2*512kB (ME) 1*1024kB (E) 1*2048kB (E) 4*4096kB (M) = 21708kB
[   36.702181] 283242 total pagecache pages
[   36.702813] 0 pages in swap cache
[   36.703378] Swap cache stats: add 0, delete 0, find 0/0
[   36.704231] Free swap  = 0kB
[   36.704709] Total swap = 0kB
[   36.705201] 875959 pages RAM
[   36.705669] 0 pages HighMem/MovableOnly
[   36.706307] 42947 pages reserved
[   36.706828] 0 pages hwpoisoned
[   36.707383] Out of memory: Killed process 545 (rear) total-vm:15912kB, anon-rss:4212kB, file-rss:2676kB, shmem-rss:0kB, UID:0 pgtables:72kB oom_score_adj:0
/etc/scripts/system-setup: line 255:   545 Killed                  rear $rear_options recover
'eval rear $rear_options recover' results exit code 137
'rear recover' failed with exit code 137
1) View Relax-and-Recover log file(s)
2) Login at the rescue system
Select what to do [   36.849846] dd invoked oom-killer: gfp_mask=0x6201c0(GFP_USER|__GFP_WRITE), order=0, oom_score_adj=0
[   36.851330] CPU: 1 PID: 1688 Comm: dd Not tainted 4.18.0-527.el8.x86_64 #1
[   36.852424] Hardware name: Amazon EC2 c6a.large/, BIOS 1.0 10/16/2017
[   36.853452] Call Trace:
[   36.853857]  dump_stack+0x41/0x60
[   36.854401]  dump_header+0x4a/0x1df
[   36.854967]  oom_kill_process.cold.33+0xb/0x10
[   36.855682]  out_of_memory+0x1bd/0x4e0
[   36.856298]  __alloc_pages_slowpath+0xbf0/0xcd0
[   36.857029]  __alloc_pages_nodemask+0x2e2/0x330
[   36.857752]  pagecache_get_page+0xce/0x310
[   36.858409]  ? blkdev_direct_IO+0x490/0x490
[   36.859085]  grab_cache_page_write_begin+0x1f/0x40
[   36.859848]  block_write_begin+0x24/0xd0
[   36.860489]  generic_perform_write+0xf2/0x1b0
[   36.861186]  ? generic_update_time+0xba/0xd0
[   36.861871]  ? file_update_time+0xf1/0x130
[   36.862530]  __generic_file_write_iter+0x102/0x1d0
[   36.863295]  blkdev_write_iter+0xb8/0x160
[   36.863943]  ? __indirect_thunk_end+0x1e67de/0x1e67de
[   36.864751]  new_sync_write+0x112/0x160
[   36.865375]  vfs_write+0xa5/0x1b0
[   36.865913]  ksys_write+0x4f/0xb0
[   36.866453]  do_syscall_64+0x5b/0x1b0
[   36.867051]  entry_SYSCALL_64_after_hwframe+0x61/0xc6
[   36.867858] RIP: 0033:0x7fcff7bf4de8
[   36.868437] Code: 89 02 48 c7 c0 ff ff ff ff eb b3 0f 1f 80 00 00 00 00 f3 0f 1e fa 48 8d 05 55 49 2a 00 8b 00 85 c0 75 17 b8 01 00 00 00 0f 05 &lt;48&gt; 3d 00 f0 ff ff 77 58 c3 0f 1f 80 00 00 00 00 41 54 49 89 d4 55
[   36.871358] RSP: 002b:00007fff2fad50c8 EFLAGS: 00000246 ORIG_RAX: 0000000000000001
[   36.872566] RAX: ffffffffffffffda RBX: 0000000000000000 RCX: 00007fcff7bf4de8
[   36.873694] RDX: 0000000000000200 RSI: 0000563f558ca000 RDI: 0000000000000001
[   36.874821] RBP: 0000000000000200 R08: 0000000000000000 R09: 0000563f558ca060
[   36.875958] R10: 0000000000000000 R11: 0000000000000246 R12: 0000563f558ca000
[   36.877084] R13: 0000000000000800 R14: 0000000000000200 R15: 0000563f558c8200
[   36.878222] Mem-Info:
[   36.878600] active_anon:28 inactive_anon:3652 isolated_anon:0
[   36.878600]  active_file:3 inactive_file:0 isolated_file:0
[   36.878600]  unevictable:281131 dirty:1 writeback:1
[   36.878600]  slab_reclaimable:8438 slab_unreclaimable:3104
[   36.878600]  mapped:2779 shmem:2099 pagetables:171 bounce:0
[   36.878600]  free:20396 free_pcp:0 free_cma:0
[   36.883488] Node 0 active_anon:112kB inactive_anon:14608kB active_file:12kB inactive_file:0kB unevictable:1124524kB isolated(anon):0kB isolated(file):0kB mapped:11116kB dirty:4kB writeback:4kB shmem:8396kB shmem_thp: 0kB shmem_pmdmapped: 0kB anon_thp: 0kB writeback_tmp:0kB kernel_stack:1248kB pagetables:684kB all_unreclaimable? yes
[   36.888064] Node 0 DMA free:11060kB min:376kB low:468kB high:560kB active_anon:0kB inactive_anon:0kB active_file:0kB inactive_file:0kB unevictable:0kB writepending:0kB present:15992kB managed:15360kB mlocked:0kB bounce:0kB free_pcp:0kB local_pcp:0kB free_cma:0kB
[   36.891678] lowmem_reserve[]: 0 1809 2671 2671 2671
[   36.892484] Node 0 DMA32 free:48936kB min:45508kB low:56884kB high:68260kB active_anon:112kB inactive_anon:14608kB active_file:12kB inactive_file:0kB unevictable:304596kB writepending:8kB present:2543716kB managed:2433488kB mlocked:0kB bounce:0kB free_pcp:0kB local_pcp:0kB free_cma:0kB
[   36.896411] lowmem_reserve[]: 0 0 862 862 862
[   36.897180] Node 0 Normal free:21588kB min:21692kB low:27112kB high:32532kB active_anon:0kB inactive_anon:0kB active_file:0kB inactive_file:0kB unevictable:819928kB writepending:0kB present:944128kB managed:883200kB mlocked:0kB bounce:0kB free_pcp:0kB local_pcp:0kB free_cma:0kB
[   36.901082] lowmem_reserve[]: 0 0 0 0 0
[   36.901708] Node 0 DMA: 5*4kB (UE) 2*8kB (UE) 1*16kB (E) 2*32kB (UE) 1*64kB (E) 1*128kB (E) 2*256kB (UE) 2*512kB (UE) 1*1024kB (E) 2*2048kB (ME) 1*4096kB (M) = 11060kB
[   36.904108] Node 0 DMA32: 291*4kB (UME) 506*8kB (UME) 342*16kB (UME) 231*32kB (UME) 98*64kB (UME) 36*128kB (UME) 12*256kB (ME) 16*512kB (ME) 5*1024kB (M) 2*2048kB (UM) 0*4096kB = 49436kB
[   36.906759] Node 0 Normal: 2*4kB (UE) 4*8kB (UME) 2*16kB (UM) 3*32kB (UME) 3*64kB (UME) 2*128kB (ME) 2*256kB (ME) 2*512kB (ME) 1*1024kB (E) 1*2048kB (E) 4*4096kB (UM) = 21608kB
[   36.909273] 283232 total pagecache pages
[   36.909904] 0 pages in swap cache
[   36.910472] Swap cache stats: add 0, delete 0, find 0/0
[   36.911318] Free swap  = 0kB
[   36.911789] Total swap = 0kB
[   36.912290] 875959 pages RAM
[   36.912760] 0 pages HighMem/MovableOnly
[   36.913389] 42947 pages reserved
[   36.913912] 0 pages hwpoisoned
[   36.914465] Out of memory: Killed process 197 (system-setup) total-vm:12872kB, anon-rss:1180kB, file-rss:2552kB, shmem-rss:0kB, UID:0 pgtables:76kB oom_score_adj:0
[[0;1;31mFAILED[0m] Failed to start Initialize Rescue System.
See 'systemctl status sysinit.service' for details.
[[0;32m  OK  [0m] Started Getty on tty0.
[[0;32m  OK  [0m] Reached target Login Prompts.
[[0;32m  OK  [0m] Started Serial Getty on ttyS0.
[[0;32m  OK  [0m] Reached target Multi-User.
</code></pre>
<h4 id="pcahyna_commented_at_2023-12-14_1543"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/3107#issuecomment-1856084819">2023-12-14 15:43</a>:<a class="headerlink" href="#pcahyna_commented_at_2023-12-14_1543" title="Permanent link">&para;</a></h4>
<p>@jsmeix ok, I agree that it makes sense to set console log level both in
system setup and <code>rear recover</code>.</p>
<h4 id="jsmeix_commented_at_2023-12-15_0913"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/3107#issuecomment-1857535382">2023-12-15 09:13</a>:<a class="headerlink" href="#jsmeix_commented_at_2023-12-15_0913" title="Permanent link">&para;</a></h4>
<p>I will implement setting the console log level<br />
for /sbin/rear in a separated pull request.</p>
<h4 id="jsmeix_commented_at_2023-12-15_0926"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/3107#issuecomment-1857551585">2023-12-15 09:26</a>:<a class="headerlink" href="#jsmeix_commented_at_2023-12-15_0926" title="Permanent link">&para;</a></h4>
<p>@pcahyna<br />
out of curiosity:<br />
How big are such test backups ?<br />
How much disk space need such test systems (<code>df -h</code>) ?</p>
<p>For comparison:<br />
I installed a rather minimal SLES15-SP5 system<br />
with all in a single ext4 root '/' partition<br />
and got</p>
<pre><code># df -h
Filesystem      Size  Used Avail Use% Mounted on
...
/dev/vda2       8.3G  2.2G  5.7G  28% /

...  74M Dec 15 11:17 rear-localhost.iso
... 868M Dec 15 11:20 backup.tar.gz
</code></pre>
<p>so ISO plus backup below 1GB<br />
in particular with this in local.conf (excerpt):</p>
<pre><code>FIRMWARE_FILES=( 'no' )
MODULES=( 'loaded_modules' )
</code></pre>
<h4 id="pcahyna_commented_at_2023-12-18_1138"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/3107#issuecomment-1860239259">2023-12-18 11:38</a>:<a class="headerlink" href="#pcahyna_commented_at_2023-12-18_1138" title="Permanent link">&para;</a></h4>
<p>Last time the test succeeded seems to be here
<a href="https://github.com/rear/rear/runs/19517989303">https://github.com/rear/rear/runs/19517989303</a>
. I suspect it may be some kernel change, the log at that time shows
4.18.0-526.el8.x86_64.</p>
<h4 id="pcahyna_commented_at_2023-12-18_1145"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/3107#issuecomment-1860254841">2023-12-18 11:45</a>:<a class="headerlink" href="#pcahyna_commented_at_2023-12-18_1145" title="Permanent link">&para;</a></h4>
<blockquote>
<p>@pcahyna out of curiosity: How big are such test backups ? How much
disk space need such test systems (<code>df -h</code>) ?</p>
<p>For comparison: I installed a rather minimal SLES15-SP5 system with
all in a single ext4 root '/' partition and got</p>
<pre><code># df -h
Filesystem      Size  Used Avail Use% Mounted on
...
/dev/vda2       8.3G  2.2G  5.7G  28% /

...  74M Dec 15 11:17 rear-localhost.iso
... 868M Dec 15 11:20 backup.tar.gz
</code></pre>
<p>so ISO plus backup below 1GB.</p>
</blockquote>
<p>@jsmeix good question!</p>
<p>Failed run has this:</p>
<pre><code>Running 'pack' stage ======================
Creating recovery/rescue system initramfs/initrd initrd.cgz with gzip default compression
Created initrd.cgz with gzip default compression (585960054 bytes) in 36 seconds
Running 'backup' stage ======================
Making backup (using backup method NETFS)
Creating tar archive '/var/tmp/rear.TLe4h8iNwow9QvX/tmp/isofs/backup/backup.tar.gz'
Preparing archive operationOK
Archived 1542 MiB in 149 seconds [avg 10597 KiB/sec]
Running 'output' stage ======================
Searching whole /usr for SYSLINUX modules directory (you may specify SYSLINUX_MODULES_DIR)
Making ISO image
Wrote ISO image: /var/lib/rear/output/rear-ip-172-31-28-157.iso (2.1G)
</code></pre>
<p><a href="https://artifacts.dev.testing-farm.io/f6bd055b-71dd-4cb7-9550-89007881c9fa/work-backup-and-restoretizyhdqu/tests/plans/backup-and-restore/execute/data/guest/default-0/make-backup-and-restore-iso-1/output.txt">https://artifacts.dev.testing-farm.io/f6bd055b-71dd-4cb7-9550-89007881c9fa/work-backup-and-restoretizyhdqu/tests/plans/backup-and-restore/execute/data/guest/default-0/make-backup-and-restore-iso-1/output.txt</a>
- hidden in a very deep directory unfortunately.</p>
<p>Successful run had this:</p>
<pre><code>Running 'pack' stage ======================
Creating recovery/rescue system initramfs/initrd initrd.cgz with gzip default compression
Created initrd.cgz with gzip default compression (117249126 bytes) in 7 seconds
Running 'backup' stage ======================
Making backup (using backup method NETFS)
Creating tar archive '/var/tmp/rear.6NxWWL8y4WQkIn9/tmp/isofs/backup/backup.tar.gz'
Preparing archive operationOK
Archived 816 MiB in 108 seconds [avg 7741 KiB/sec]
Running 'output' stage ======================
Searching whole /usr for SYSLINUX modules directory (you may specify SYSLINUX_MODULES_DIR)
Making ISO image
Wrote ISO image: /var/lib/rear/output/rear-ip-172-31-17-145.iso (963M)
</code></pre>
<p><a href="https://artifacts.dev.testing-farm.io/df70fe97-ba51-466e-8472-ba72bead8bd9/">https://artifacts.dev.testing-farm.io/df70fe97-ba51-466e-8472-ba72bead8bd9/</a><br />
so, a huge change both in the initrd size and the whole backup size.</p>
<h4 id="jsmeix_commented_at_2023-12-18_1235"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/3107#issuecomment-1860381479">2023-12-18 12:35</a>:<a class="headerlink" href="#jsmeix_commented_at_2023-12-18_1235" title="Permanent link">&para;</a></h4>
<p>@pcahyna<br />
to find big files and directories you may run<br />
inside those test systems a command like</p>
<pre><code># du -amt123M / 2&gt;/dev/null
</code></pre>
<p>e.g. here to show all files and directories<br />
that need more than 123 MB disk space.</p>
<p>For example on my above rather minimal SLES15-SP5 test VM:</p>
<pre><code># du -amt70M / 2&gt;/dev/null
108     /usr/lib64/libLLVM.so.15
390     /usr/lib64
95      /usr/bin
227     /usr/lib/locale
382     /usr/lib
101     /usr/share/locale
304     /usr/share
1196    /usr
72      /lib/firmware/mrvl/prestera
77      /lib/firmware/mrvl
359     /lib/firmware
78      /lib/modules/5.14.21-150500.53-default/kernel
82      /lib/modules/5.14.21-150500.53-default
82      /lib/modules
440     /lib
74      /root/rear/var/lib/rear/output/rear-localhost.iso
74      /root/rear/var/lib/rear/output
74      /root/rear/var/lib/rear
74      /root/rear/var/lib
77      /root/rear/var
99      /root/rear
99      /root
1846    /
</code></pre>
<h4 id="jsmeix_commented_at_2023-12-18_1239"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/3107#issuecomment-1860392320">2023-12-18 12:39</a>:<a class="headerlink" href="#jsmeix_commented_at_2023-12-18_1239" title="Permanent link">&para;</a></h4>
<p>Regarding "suspect it may be some kernel change":</p>
<p>In this case I think "the usual suspects"<br />
are new and big firmware files or kernel modules<br />
which may make the backup big.</p>
<p>To avoid a needless big ReaR recovery system initrd<br />
(in particular on a VM where firmware is not needed)</p>
<pre><code>FIRMWARE_FILES=( 'no' )
MODULES=( 'loaded_modules' )
</code></pre>
<p>is basically mandatory.</p>
<h4 id="pcahyna_commented_at_2023-12-18_1813"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/3107#issuecomment-1861238116">2023-12-18 18:13</a>:<a class="headerlink" href="#pcahyna_commented_at_2023-12-18_1813" title="Permanent link">&para;</a></h4>
<p>@jsmeix indeed that was it, thank you for the tips:</p>
<pre><code># du -amt70M  /tmp/rear.u4cUxdVyXNiz1qd/rootfs/ 2&gt;/dev/null 
82      /tmp/rear.u4cUxdVyXNiz1qd/rootfs/usr/lib/firmware/mellanox
78      /tmp/rear.u4cUxdVyXNiz1qd/rootfs/usr/lib/firmware/amdgpu
72      /tmp/rear.u4cUxdVyXNiz1qd/rootfs/usr/lib/firmware/mrvl/prestera
81      /tmp/rear.u4cUxdVyXNiz1qd/rootfs/usr/lib/firmware/mrvl
167     /tmp/rear.u4cUxdVyXNiz1qd/rootfs/usr/lib/firmware/qcom
141     /tmp/rear.u4cUxdVyXNiz1qd/rootfs/usr/lib/firmware/netronome
1065    /tmp/rear.u4cUxdVyXNiz1qd/rootfs/usr/lib/firmware
1157    /tmp/rear.u4cUxdVyXNiz1qd/rootfs/usr/lib
1221    /tmp/rear.u4cUxdVyXNiz1qd/rootfs/usr
1278    /tmp/rear.u4cUxdVyXNiz1qd/rootfs/
</code></pre>
<p>The size of the firmware increased a bit, but that should not be the
reason. It seems that the test started to fail and used to pass before
because before there was no linux-firmware package installed on the test
machines and now there is. And the <code>centos-stream-9</code> test passes because
the package is still absent in the testing image. I made an experiment
in
<a href="https://github.com/pcahyna/rear/pull/14">https://github.com/pcahyna/rear/pull/14</a>
and indeed:<br />
<code>centos-stream-8</code> :</p>
<pre><code>::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
::   Is linux-firmware installed?
::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

linux-firmware-20231121-120.git9552083a.el8.noarch
:: [ 15:36:58 ] :: [   PASS   ] :: Checking for the presence of linux-firmware rpm 
:: [ 15:36:58 ] :: [   LOG    ] :: Package versions:
:: [ 15:36:58 ] :: [   LOG    ] ::   linux-firmware-20231121-120.git9552083a.el8.noarch
::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
::   Duration: 0s
::   Assertions: 1 good, 0 bad
::   RESULT: PASS

::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
::   Find huge files in ReaR rootfs
::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

:: [ 15:41:30 ] :: [  BEGIN   ] :: Running 'du -amt70M  /var/tmp/rear.*/rootfs/ 2&gt;/dev/null'
82  /var/tmp/rear.xfXZ7nnhbYX0QU3/rootfs/usr/lib/firmware/mellanox
78  /var/tmp/rear.xfXZ7nnhbYX0QU3/rootfs/usr/lib/firmware/amdgpu
72  /var/tmp/rear.xfXZ7nnhbYX0QU3/rootfs/usr/lib/firmware/mrvl/prestera
81  /var/tmp/rear.xfXZ7nnhbYX0QU3/rootfs/usr/lib/firmware/mrvl
167 /var/tmp/rear.xfXZ7nnhbYX0QU3/rootfs/usr/lib/firmware/qcom
141 /var/tmp/rear.xfXZ7nnhbYX0QU3/rootfs/usr/lib/firmware/netronome
891 /var/tmp/rear.xfXZ7nnhbYX0QU3/rootfs/usr/lib/firmware
983 /var/tmp/rear.xfXZ7nnhbYX0QU3/rootfs/usr/lib
1045    /var/tmp/rear.xfXZ7nnhbYX0QU3/rootfs/usr
1094    /var/tmp/rear.xfXZ7nnhbYX0QU3/rootfs/
:: [ 15:41:30 ] :: [   PASS   ] :: Command 'du -amt70M  /var/tmp/rear.*/rootfs/ 2&gt;/dev/null' (Expected 0, got 0)
</code></pre>
<p><code>centos-stream-9</code> :</p>
<pre><code>:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
::   Is linux-firmware installed?
::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

package linux-firmware is not installed
:: [ 15:31:26 ] :: [   FAIL   ] :: Checking for the presence of linux-firmware rpm 
::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
::   Duration: 0s
::   Assertions: 0 good, 1 bad
::   RESULT: WARN

::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
::   Find huge files in ReaR rootfs
::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

:: [ 15:34:29 ] :: [  BEGIN   ] :: Running 'du -amt70M  /var/tmp/rear.*/rootfs/ 2&gt;/dev/null'
87  /var/tmp/rear.Gh4BPLBzHp7pzvc/rootfs/usr/lib/modules/5.14.0-391.el9.x86_64
87  /var/tmp/rear.Gh4BPLBzHp7pzvc/rootfs/usr/lib/modules
107 /var/tmp/rear.Gh4BPLBzHp7pzvc/rootfs/usr/lib
171 /var/tmp/rear.Gh4BPLBzHp7pzvc/rootfs/usr
223 /var/tmp/rear.Gh4BPLBzHp7pzvc/rootfs/
:: [ 15:34:29 ] :: [   PASS   ] :: Command 'du -amt70M  /var/tmp/rear.*/rootfs/ 2&gt;/dev/null' (Expected 0, got 0)
</code></pre>
<p>I will add <code>FIRMWARE_FILES=( 'no' )</code> to the configuration in the CI
test.</p>
<h4 id="jsmeix_commented_at_2023-12-19_0638"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/3107#issuecomment-1862205013">2023-12-19 06:38</a>:<a class="headerlink" href="#jsmeix_commented_at_2023-12-19_0638" title="Permanent link">&para;</a></h4>
<p>@pcahyna<br />
because in your<br />
<a href="https://github.com/rear/rear/issues/3107#issuecomment-1860254841">https://github.com/rear/rear/issues/3107#issuecomment-1860254841</a><br />
you wrote there is<br />
"a huge change both in the initrd size and the whole backup size"<br />
I think that <code>FIRMWARE_FILES=( 'no' )</code> alone<br />
does not fully solve it because this affects<br />
only the size of the ReaR recovery system initrd<br />
but it does not affect the size of the backup.</p>
<p>So I think that additionally you need to<br />
exclude the firmware files from the backup.</p>
<p>Alternative it should work to not install (or uninstall)<br />
the linux-firmware package because then there should be<br />
no firmware on the original system so that firmware<br />
can neither be in the ReaR recovery system initrd<br />
nor in the backup.</p>
<h4 id="pcahyna_commented_at_2023-12-19_1247"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/3107#issuecomment-1862698661">2023-12-19 12:47</a>:<a class="headerlink" href="#pcahyna_commented_at_2023-12-19_1247" title="Permanent link">&para;</a></h4>
<blockquote>
<p>@pcahyna because in your <a href="https://github.com/rear/rear/issues/3107#issuecomment-1860254841">#3107
(comment)</a>
you wrote there is "a huge change both in the initrd size and the
whole backup size" I think that <code>FIRMWARE_FILES=( 'no' )</code> alone does
not fully solve it because this affects only the size of the ReaR
recovery system initrd but it does not affect the size of the backup.</p>
<p>So I think that additionally you need to exclude the firmware files
from the backup.</p>
<p>Alternative it should work to not install (or uninstall) the
linux-firmware package because then there should be no firmware on the
original system so that firmware can neither be in the ReaR recovery
system initrd nor in the backup.</p>
</blockquote>
<p><code>FIRMWARE_FILES=( no )</code> is enough. Successful run:
<a href="https://github.com/pcahyna/rear/pull/14/checks?check_run_id=19784045747">https://github.com/pcahyna/rear/pull/14/checks?check_run_id=19784045747</a>
.<br />
Without it, the firmware files will appear 2x in the ISO: once in the
bootable initrd and second time in the backup. I also suspect that they
take up space in RAM because of the booted ISO image (used by memdisk to
emulate the CD-ROM for the bootloader - not sure whether this kind of
bootloader memory gets freed by the kernel after boot) and again in the
booted initramfs (running recovery system).<br />
So, <code>FIRMWARE_FILES=( no )</code> saves a lot of space even if the files
remain in the backup inside the ISO.</p>
<h4 id="pcahyna_commented_at_2023-12-19_1614"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/3107#issuecomment-1863068209">2023-12-19 16:14</a>:<a class="headerlink" href="#pcahyna_commented_at_2023-12-19_1614" title="Permanent link">&para;</a></h4>
<p>@jsmeix thanks a lot for the helpful suggestions, the test now passes as
you can see in your latest PR (I retriggered it manually).</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2024 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2023-12-13.3107.issue.closed.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/rear/rear-user-guide" class="fa fa-code-fork" style="color: #fcfcfc"> rear/rear-user-guide</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
