<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#2726 PR merged: Automatically resize active last partition on RAID1 - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#2726 PR merged: Automatically resize active last partition on RAID1";
        var mkdocs_page_input_path = "issues/2021-12-09.2726.pr.merged.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/backup_netfs.html">Example of BACKUP=NETFS</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/netfs_nas.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../development/squash-git-log-commments.html">How to squash git log comments into one line</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear29.html">Release Notes ReaR 2.9</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear28.html">Release Notes ReaR 2.8</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#2726 PR merged: Automatically resize active last partition on RAID1</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="2726_pr_merged_automatically_resize_active_last_partition_on_raid1"><a href="https://github.com/rear/rear/pull/2726">#2726 PR</a> <code>merged</code>: Automatically resize active last partition on RAID1<a class="headerlink" href="#2726_pr_merged_automatically_resize_active_last_partition_on_raid1" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>enhancement</code>, <code>fixed / solved / done</code></p>
<h4 id="jsmeix_opened_issue_at_2021-12-09_1443"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> opened issue at <a href="https://github.com/rear/rear/pull/2726">2021-12-09 14:43</a>:<a class="headerlink" href="#jsmeix_opened_issue_at_2021-12-09_1443" title="Permanent link">&para;</a></h4>
<p>Automatically resize active last partitions<br />
also on RAID1 array component disks</p>
<ul>
<li>
<p>Type: <strong>Enhancement</strong></p>
</li>
<li>
<p>Impact: <strong>High</strong></p>
</li>
<li>
<p>Reference to related issue (URL):<br />
<a href="https://github.com/rear/rear/issues/2696">https://github.com/rear/rear/issues/2696</a></p>
</li>
<li>
<p>How was this pull request tested?<br />
    Works well for me with my simple RAID1 setup,<br />
    see my results in the comments below.</p>
</li>
</ul>
<h4 id="jsmeix_commented_at_2021-12-09_1454"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2726#issuecomment-989926596">2021-12-09 14:54</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-12-09_1454" title="Permanent link">&para;</a></h4>
<p>Original system:</p>
<pre><code># lsblk -ipo NAME,KNAME,PKNAME,TRAN,TYPE,FSTYPE,LABEL,SIZE,MOUNTPOINT
NAME                      KNAME        PKNAME       TRAN TYPE  FSTYPE            LABEL          SIZE MOUNTPOINT
/dev/sda                  /dev/sda                  ata  disk  linux_raid_member any:raid1sdab   12G 
`-/dev/md127              /dev/md127   /dev/sda          raid1                                   12G 
  |-/dev/md127p1          /dev/md127p1 /dev/md127        part                                    10M 
  `-/dev/md127p2          /dev/md127p2 /dev/md127        part  crypto_LUKS                     11.9G 
    `-/dev/mapper/cr_root /dev/dm-0    /dev/md127p2      crypt btrfs                           11.9G /
/dev/sdb                  /dev/sdb                  ata  disk                                     5G 
|-/dev/sdb1               /dev/sdb1    /dev/sdb          part                                     8M 
|-/dev/sdb2               /dev/sdb2    /dev/sdb          part  vfat              REAR-EFI       512M 
|-/dev/sdb3               /dev/sdb3    /dev/sdb          part  ext2              MY-BOOT          1G 
`-/dev/sdb4               /dev/sdb4    /dev/sdb          part  ext3              MY-DATA        3.5G 
/dev/sdc                  /dev/sdc                  ata  disk  linux_raid_member any:raid1sdab   12G 
`-/dev/md127              /dev/md127   /dev/sdc          raid1                                   12G 
  |-/dev/md127p1          /dev/md127p1 /dev/md127        part                                    10M 
  `-/dev/md127p2          /dev/md127p2 /dev/md127        part  crypto_LUKS                     11.9G 
    `-/dev/mapper/cr_root /dev/dm-0    /dev/md127p2      crypt btrfs                           11.9G /
/dev/sdd                  /dev/sdd                  ata  disk                                     1G 
`-/dev/sdd1               /dev/sdd1    /dev/sdd          part  swap                            1023M [SWAP]

# grep -v '^#' etc/rear/local.conf 
OUTPUT=ISO
BACKUP=NETFS
BACKUP_OPTIONS="nfsvers=3,nolock"
BACKUP_URL=nfs://192.168.122.1/nfs
REQUIRED_PROGS+=( snapper chattr )
PROGS+=( lsattr )
COPY_AS_IS+=( /usr/lib/snapper/installation-helper /etc/snapper/config-templates/default )
BACKUP_PROG_INCLUDE=( /boot/grub2/x86_64-efi /home /boot/grub2/i386-pc /root /srv /opt /tmp /usr/local /var )
POST_RECOVERY_SCRIPT=( 'if snapper --no-dbus -r $TARGET_FS_ROOT get-config | grep -q "^QGROUP.*[0-9]/[0-9]" ; then snapper --no-dbus -r $TARGET_FS_ROOT set-config QGROUP= ; snapper --no-dbus -r $TARGET_FS_ROOT setup-quota &amp;&amp; echo snapper setup-quota done || echo snapper setup-quota failed ; else echo snapper setup-quota not used ; fi' )
SSH_ROOT_PASSWORD='rear'
USE_DHCLIENT="yes"
FIRMWARE_FILES=( 'no' )
MODULES=( 'loaded_modules' )
PROGRESS_MODE="plain"
PROGRESS_WAIT_SECONDS="3"
LUKS_CRYPTSETUP_OPTIONS+=" --force-password"
GRUB2_INSTALL_DEVICES="/dev/sda /dev/sdc"
DISKS_TO_BE_WIPED="/dev/sd[a-z]"
WRITE_PROTECTED_IDS+=( fe057b67-8e9f-4b21-a67e-289a83fb3993 )

# grep -v '^#' var/lib/rear/layout/disklayout.conf 
disk /dev/sda 12884901888 gpt
disk /dev/sdc 12884901888 gpt
disk /dev/sdd 1073741824 gpt
part /dev/sdd 1072676352 1048576 rear-noname swap /dev/sdd1
raid /dev/md127 level=raid1 raid-devices=2 devices=/dev/sda,/dev/sdc name=raid1sdab metadata=1.0 uuid=8d05eb84:2de831d1:dfed54b2:ad592118
part /dev/md127 10485760 1048576 rear-noname bios_grub /dev/md127p1
part /dev/md127 12739067392 11534336 rear-noname none /dev/md127p2
fs /dev/mapper/cr_root / btrfs uuid=85406026-0559-4b0d-8f67-ec19d3b556f5 label= options=rw,relatime,space_cache,subvolid=256,subvol=/@
...
swap /dev/sdd1 uuid=9c606f48-92cd-4f98-be22-0f8a75358bed label=
crypt /dev/mapper/cr_root /dev/md127p2 type=luks1 cipher=aes-xts-plain64 key_size=512 hash=sha256 uuid=d0446c00-9e79-4872-abaa-2d464fd71c99
</code></pre>
<p>Replacement system has same disk sizes available<br />
for my first test so no actual resizing is needed:</p>
<pre><code># lsblk -ipo NAME,KNAME,PKNAME,TRAN,TYPE,FSTYPE,LABEL,SIZE,MOUNTPOINT
NAME        KNAME     PKNAME   TRAN TYPE FSTYPE            LABEL                SIZE MOUNTPOINT
/dev/sda    /dev/sda           ata  disk linux_raid_member localhost:raid1sdab   12G 
|-/dev/sda1 /dev/sda1 /dev/sda      part linux_raid_member localhost:raid1sdab   10M 
`-/dev/sda2 /dev/sda2 /dev/sda      part crypto_LUKS       localhost:raid1sdab 11.9G 
/dev/sdb    /dev/sdb           ata  disk linux_raid_member localhost:raid1sdab   12G 
|-/dev/sdb1 /dev/sdb1 /dev/sdb      part linux_raid_member localhost:raid1sdab   10M 
`-/dev/sdb2 /dev/sdb2 /dev/sdb      part crypto_LUKS       localhost:raid1sdab 11.9G 
/dev/sdc    /dev/sdc           ata  disk                                          1G 
`-/dev/sdc1 /dev/sdc1 /dev/sdc      part swap                                  1023M

# rear -D recover
...
Comparing disks
Ambiguous disk layout needs manual configuration (more than one disk with same size used in '/var/lib/rear/layout/disklayout.conf')
Switching to manual disk layout configuration
Using /dev/sda (same name and same size 12884901888) for recreating /dev/sda
Cannot use /dev/sda (same size) for recreating /dev/sdc (/dev/sda already exists as target in /var/lib/rear/layout/disk_mappings)
Using /dev/sdb (same size 12884901888) for recreating /dev/sdc
Using /dev/sdc (same size 1073741824) for recreating /dev/sdd
Current disk mapping table (source =&gt; target):
  /dev/sda =&gt; /dev/sda
  /dev/sdc =&gt; /dev/sdb
  /dev/sdd =&gt; /dev/sdc

UserInput -I LAYOUT_MIGRATION_CONFIRM_MAPPINGS needed in /usr/share/rear/layout/prepare/default/300_map_disks.sh line 315
Confirm or edit the disk mapping
1) Confirm disk mapping and continue 'rear recover'
2) n/a
3) Edit disk mapping (/var/lib/rear/layout/disk_mappings)
4) Use Relax-and-Recover shell and return back to here
5) Abort 'rear recover'
(default '1' timeout 300 seconds)
1
...
UserInput: Valid choice number result 'Confirm disk mapping and continue 'rear recover''
User confirmed disk mapping
Disabling excluded components in /var/lib/rear/layout/disklayout.conf
Applied disk layout mappings to /var/lib/rear/layout/disklayout.conf
Applied disk layout mappings to /var/lib/rear/layout/config/df.txt
Applied disk layout mappings to /etc/rear/rescue.conf
Examining gpt disk /dev/sdc to automatically resize its last active partition
Skipping /dev/sdc (size of new disk same as size of old disk)
Examining gpt disk /dev/md127 to automatically resize its last active partition
ERROR: No '/sys/block/md127' directory for /dev/md127
Some latest log messages since the last called script 420_autoresize_last_partitions.sh:
  2021-12-09 15:32:21.506947921 Entering debugscript mode via 'set -x'.
  2021-12-09 15:32:21.528062250 Examining gpt disk /dev/sdc to automatically resize its last active partition
  1073741824
  2021-12-09 15:32:21.536517412 Skipping /dev/sdc (size of new disk same as size of old disk)
  2021-12-09 15:32:21.555336860 Examining gpt disk /dev/md127 to automatically resize its last active partition
Aborting due to an error, check /var/log/rear/rear-localhost.log for details
</code></pre>
<h4 id="jsmeix_commented_at_2021-12-10_0757"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2726#issuecomment-990712433">2021-12-10 07:57</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-12-10_0757" title="Permanent link">&para;</a></h4>
<p>Now it works at least in my case where the<br />
replacement system has same disk sizes available<br />
for my first test so no actual resizing is needed:</p>
<pre><code># rear -D recover
...
Comparing disks
Ambiguous disk layout needs manual configuration (more than one disk with same size used in '/var/lib/rear/layout/disklayout.conf')
Switching to manual disk layout configuration
Using /dev/sda (same name and same size 12884901888) for recreating /dev/sda
Cannot use /dev/sda (same size) for recreating /dev/sdc (/dev/sda already exists as target in /var/lib/rear/layout/disk_mappings)
Using /dev/sdb (same size 12884901888) for recreating /dev/sdc
Using /dev/sdc (same size 1073741824) for recreating /dev/sdd
Current disk mapping table (source =&gt; target):
  /dev/sda =&gt; /dev/sda
  /dev/sdc =&gt; /dev/sdb
  /dev/sdd =&gt; /dev/sdc

UserInput -I LAYOUT_MIGRATION_CONFIRM_MAPPINGS needed in /usr/share/rear/layout/prepare/default/300_map_disks.sh line 315
Confirm or edit the disk mapping
1) Confirm disk mapping and continue 'rear recover'
2) n/a
3) Edit disk mapping (/var/lib/rear/layout/disk_mappings)
4) Use Relax-and-Recover shell and return back to here
5) Abort 'rear recover'
(default '1' timeout 300 seconds)
1
UserInput: Valid choice number result 'Confirm disk mapping and continue 'rear recover''
User confirmed disk mapping
Disabling excluded components in /var/lib/rear/layout/disklayout.conf
Applied disk layout mappings to /var/lib/rear/layout/disklayout.conf
Applied disk layout mappings to /var/lib/rear/layout/config/df.txt
Applied disk layout mappings to /etc/rear/rescue.conf
Examining gpt disk /dev/sdc to automatically resize its last active partition
Skipping /dev/sdc (size of new disk same as size of old disk)
Examining gpt disk /dev/md127 to automatically resize its last active partition
Skipping /dev/md127 (size of new disk same as size of old disk)
</code></pre>
<h4 id="jsmeix_commented_at_2021-12-10_0930"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2726#issuecomment-990776403">2021-12-10 09:30</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-12-10_0930" title="Permanent link">&para;</a></h4>
<p>Now it works at least in my case when the replacement system has<br />
one smaller disk size and one same disk size for the RAID1 component
devices<br />
which means the last partition on the RAID device must be shrinked<br />
so that it still fits on the smaller component device disk.</p>
<p>On the recovery system I have now:</p>
<pre><code># lsblk -ipo NAME,KNAME,PKNAME,TRAN,TYPE,FSTYPE,LABEL,SIZE,MOUNTPOINT
NAME        KNAME     PKNAME   TRAN TYPE FSTYPE            LABEL                SIZE MOUNTPOINT
/dev/sda    /dev/sda           ata  disk linux_raid_member localhost:raid1sdab   12G 
|-/dev/sda1 /dev/sda1 /dev/sda      part linux_raid_member localhost:raid1sdab   10M 
`-/dev/sda2 /dev/sda2 /dev/sda      part crypto_LUKS       localhost:raid1sdab 11.9G 
/dev/sdb    /dev/sdb           ata  disk                                         11G 
/dev/sdc    /dev/sdc           ata  disk                                          1G 
`-/dev/sdc1 /dev/sdc1 /dev/sdc      part swap                                  1023M
</code></pre>
<p>Because I reduced the /dev/sdb size from 12GiB to 11GiB I need
additionally</p>
<pre><code>AUTOSHRINK_DISK_SIZE_LIMIT_PERCENTAGE=20
</code></pre>
<p>Then "rear recover" works well for me:</p>
<pre><code># rear -D recover
...
Comparing disks
Ambiguous disk layout needs manual configuration (more than one disk with same size used in '/var/lib/rear/layout/disklayout.conf')
Switching to manual disk layout configuration
Using /dev/sda (same name and same size 12884901888) for recreating /dev/sda
Cannot use /dev/sda (same size) for recreating /dev/sdc (/dev/sda already exists as target in /var/lib/rear/layout/disk_mappings)
Could not automap /dev/sdc (no disk with same size 12884901888 found)
Using /dev/sdc (same size 1073741824) for recreating /dev/sdd
Original disk /dev/sdc does not exist (with same size) in the target system
Cannot check write protection by ID for /dev/sdb (no ID found)
Using /dev/sdb (the only available of the disks) for recreating /dev/sdc
Current disk mapping table (source =&gt; target):
  /dev/sda =&gt; /dev/sda
  /dev/sdd =&gt; /dev/sdc
  /dev/sdc =&gt; /dev/sdb

UserInput -I LAYOUT_MIGRATION_CONFIRM_MAPPINGS needed in /usr/share/rear/layout/prepare/default/300_map_disks.sh line 315
Confirm or edit the disk mapping
1) Confirm disk mapping and continue 'rear recover'
2) n/a
3) Edit disk mapping (/var/lib/rear/layout/disk_mappings)
4) Use Relax-and-Recover shell and return back to here
5) Abort 'rear recover'
(default '1' timeout 300 seconds)

UserInput: No real user input (empty or only spaces) - using default input
UserInput: Valid choice number result 'Confirm disk mapping and continue 'rear recover''
User confirmed disk mapping
Disabling excluded components in /var/lib/rear/layout/disklayout.conf
Applied disk layout mappings to /var/lib/rear/layout/disklayout.conf
Applied disk layout mappings to /var/lib/rear/layout/config/df.txt
Applied disk layout mappings to /etc/rear/rescue.conf
Trying to automatically resize last partition when disk size changed
Examining gpt device /dev/sdc to automatically resize its last active partition
Skipping /dev/sdc (size of new device same as size of old device)
Examining gpt device /dev/md127 to automatically resize its last active partition
Checking /dev/md127p1 if it is the last partition on /dev/md127
Checking /dev/md127p2 if it is the last partition on /dev/md127
Found 'rear-noname' partition /dev/md127p2 as last partition on /dev/md127
Determining if last partition /dev/md127p2 is resizeable
Determining new size for last partition /dev/md127p2
Determining if last partition /dev/md127p2 actually needs to be increased or shrinked
New /dev/md127 is 1073741824 bytes smaller than old device
Last partition /dev/md127p2 must be shrinked by 940490240 bytes to still fit on device
Shrinking last partition /dev/md127p2 to end of device (new device at most 20% smaller)
Changed last partition /dev/md127p2 size from 12739067392 to 11798577152 bytes
...
Start system layout restoration.
Disk '/dev/sdc': creating 'gpt' partition table
Disk '/dev/sdc': creating partition number 1 with name ''sdc1''
Creating software RAID /dev/md127
Disk '/dev/md127': creating 'gpt' partition table
Disk '/dev/md127': creating partition number 1 with name ''md127p1''
Disk '/dev/md127': creating partition number 2 with name ''md127p2''
Creating swap on /dev/sdc1
Creating LUKS volume cr_root on /dev/md127p2
Set the password for LUKS volume cr_root (for 'cryptsetup luksFormat' on /dev/md127p2):
Enter passphrase for /dev/md127p2: 
Enter the password for LUKS volume cr_root (for 'cryptsetup luksOpen' on /dev/md127p2):
Enter passphrase for /dev/md127p2: 
Creating filesystem of type btrfs with mount point / on /dev/mapper/cr_root.
Mounting filesystem /
Disk layout created.
...
Finished 'recover'. The target system is mounted at '/mnt/local'.

# lsblk -ipo NAME,KNAME,PKNAME,TRAN,TYPE,FSTYPE,LABEL,SIZE,MOUNTPOINT
NAME                      KNAME        PKNAME       TRAN TYPE  FSTYPE            LABEL                SIZE MOUNTPOINT
/dev/sda                  /dev/sda                  ata  disk  linux_raid_member localhost:raid1sdab   12G 
|-/dev/sda1               /dev/sda1    /dev/sda          part  linux_raid_member localhost:raid1sdab   10M 
|-/dev/sda2               /dev/sda2    /dev/sda          part  crypto_LUKS       localhost:raid1sdab   11G 
`-/dev/md127              /dev/md127   /dev/sda          raid1                                         11G 
  |-/dev/md127p1          /dev/md127p1 /dev/md127        part                                          10M 
  `-/dev/md127p2          /dev/md127p2 /dev/md127        part  crypto_LUKS                             11G 
    `-/dev/mapper/cr_root /dev/dm-0    /dev/md127p2      crypt btrfs                                   11G /mnt/local
/dev/sdb                  /dev/sdb                  ata  disk  linux_raid_member localhost:raid1sdab   11G 
|-/dev/sdb1               /dev/sdb1    /dev/sdb          part  linux_raid_member localhost:raid1sdab   10M 
|-/dev/sdb2               /dev/sdb2    /dev/sdb          part  crypto_LUKS       localhost:raid1sdab   11G 
`-/dev/md127              /dev/md127   /dev/sdb          raid1                                         11G 
  |-/dev/md127p1          /dev/md127p1 /dev/md127        part                                          10M 
  `-/dev/md127p2          /dev/md127p2 /dev/md127        part  crypto_LUKS                             11G 
    `-/dev/mapper/cr_root /dev/dm-0    /dev/md127p2      crypt btrfs                                   11G /mnt/local
/dev/sdc                  /dev/sdc                  ata  disk                                           1G 
`-/dev/sdc1               /dev/sdc1    /dev/sdc          part  swap                                  1023M
</code></pre>
<p>and after reboot (here with size values as bytes):</p>
<pre><code># lsblk -bipo NAME,KNAME,PKNAME,TRAN,TYPE,FSTYPE,LABEL,SIZE,MOUNTPOINT
NAME                      KNAME        PKNAME       TRAN TYPE  FSTYPE            LABEL                      SIZE MOUNTPOINT
/dev/sda                  /dev/sda                  ata  disk  linux_raid_member localhost:raid1sdab 12884901888 
`-/dev/md127              /dev/md127   /dev/sda          raid1                                       11811028992 
  |-/dev/md127p1          /dev/md127p1 /dev/md127        part                                           10485760 
  `-/dev/md127p2          /dev/md127p2 /dev/md127        part  crypto_LUKS                           11798577152 
    `-/dev/mapper/cr_root /dev/dm-0    /dev/md127p2      crypt btrfs                                 11796480000 /
/dev/sdb                  /dev/sdb                  ata  disk  linux_raid_member localhost:raid1sdab 11811160064 
`-/dev/md127              /dev/md127   /dev/sdb          raid1                                       11811028992 
  |-/dev/md127p1          /dev/md127p1 /dev/md127        part                                           10485760 
  `-/dev/md127p2          /dev/md127p2 /dev/md127        part  crypto_LUKS                           11798577152 
    `-/dev/mapper/cr_root /dev/dm-0    /dev/md127p2      crypt btrfs                                 11796480000 /
/dev/sdc                  /dev/sdc                  ata  disk                                         1073741824 
`-/dev/sdc1               /dev/sdc1    /dev/sdc          part  swap                                   1072676352 [SWAP]
/dev/sr0                  /dev/sr0                  ata  rom   iso9660           REAR-ISO               74227712
</code></pre>
<p>The relevant change in disklayout.conf regarding the shrinked partition
is</p>
<pre><code>-part /dev/md127 12739067392 11534336 rear-noname none /dev/md127p2
+part /dev/md127 11798577152 11534336 rear-noname none /dev/md127p2
</code></pre>
<h4 id="jsmeix_commented_at_2021-12-10_1038"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2726#issuecomment-990837884">2021-12-10 10:38</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-12-10_1038" title="Permanent link">&para;</a></h4>
<p>Another test with<br />
sda shrinked from 12GiB to 10 GiB<br />
sdb shrinked from 12GiB to 11 GiB<br />
sdc enlarged from 1GiB to 2GiB<br />
so I have now on the replacement VM</p>
<pre><code># lsblk -ipo NAME,KNAME,PKNAME,TRAN,TYPE,FSTYPE,LABEL,SIZE,MOUNTPOINT
NAME        KNAME     PKNAME   TRAN TYPE FSTYPE            LABEL               SIZE MOUNTPOINT
/dev/sda    /dev/sda           ata  disk                                        10G 
/dev/sdb    /dev/sdb           ata  disk linux_raid_member localhost:raid1sdab  11G 
|-/dev/sdb1 /dev/sdb1 /dev/sdb      part linux_raid_member localhost:raid1sdab  10M 
`-/dev/sdb2 /dev/sdb2 /dev/sdb      part crypto_LUKS       localhost:raid1sdab  11G 
/dev/sdc    /dev/sdc           ata  disk                                         2G

# rear -D recover
...
Comparing disks
Ambiguous disk layout needs manual configuration (more than one disk with same size used in '/var/lib/rear/layout/disklayout.conf')
Switching to manual disk layout configuration
Could not automap /dev/sda (no disk with same size 12884901888 found)
Could not automap /dev/sdc (no disk with same size 12884901888 found)
Could not automap /dev/sdd (no disk with same size 1073741824 found)
Original disk /dev/sda does not exist (with same size) in the target system
Cannot check write protection by ID for /dev/sda (no ID found)
Cannot check write protection by ID for /dev/sdc (no ID found)
UserInput -I LAYOUT_MIGRATION_REPLACEMENT_SDA needed in /usr/share/rear/layout/prepare/default/300_map_disks.sh line 278
Choose an appropriate replacement for /dev/sda
1) /dev/sda
2) /dev/sdb
3) /dev/sdc
4) Do not map /dev/sda
5) Use Relax-and-Recover shell and return back to here
(default '1' timeout 300 seconds)
1
UserInput: Valid choice number result '/dev/sda'
Using /dev/sda (chosen by user) for recreating /dev/sda
Original disk /dev/sdc does not exist (with same size) in the target system
Cannot check write protection by ID for /dev/sdc (no ID found)
UserInput -I LAYOUT_MIGRATION_REPLACEMENT_SDC needed in /usr/share/rear/layout/prepare/default/300_map_disks.sh line 278
Choose an appropriate replacement for /dev/sdc
1) /dev/sdb
2) /dev/sdc
3) Do not map /dev/sdc
4) Use Relax-and-Recover shell and return back to here
(default '1' timeout 300 seconds)
1
UserInput: Valid choice number result '/dev/sdb'
Using /dev/sdb (chosen by user) for recreating /dev/sdc
Original disk /dev/sdd does not exist (with same size) in the target system
Cannot check write protection by ID for /dev/sdc (no ID found)
Using /dev/sdc (the only available of the disks) for recreating /dev/sdd
Current disk mapping table (source =&gt; target):
  /dev/sda =&gt; /dev/sda
  /dev/sdc =&gt; /dev/sdb
  /dev/sdd =&gt; /dev/sdc

UserInput -I LAYOUT_MIGRATION_CONFIRM_MAPPINGS needed in /usr/share/rear/layout/prepare/default/300_map_disks.sh line 315
Confirm or edit the disk mapping
1) Confirm disk mapping and continue 'rear recover'
2) n/a
3) Edit disk mapping (/var/lib/rear/layout/disk_mappings)
4) Use Relax-and-Recover shell and return back to here
5) Abort 'rear recover'
(default '1' timeout 300 seconds)
1
UserInput: Valid choice number result 'Confirm disk mapping and continue 'rear recover''
User confirmed disk mapping
Disabling excluded components in /var/lib/rear/layout/disklayout.conf
Applied disk layout mappings to /var/lib/rear/layout/disklayout.conf
Applied disk layout mappings to /var/lib/rear/layout/config/df.txt
Applied disk layout mappings to /etc/rear/rescue.conf
Trying to automatically resize last partition when disk size changed
Examining gpt device /dev/sdc to automatically resize its last active partition
Checking /dev/sdc1 if it is the last partition on /dev/sdc
Found 'rear-noname' partition /dev/sdc1 as last partition on /dev/sdc
Determining if last partition /dev/sdc1 is resizeable
Last partition /dev/sdc1 not resizeable (used as swap partition)
Determining new size for last partition /dev/sdc1
Determining if last partition /dev/sdc1 actually needs to be increased or shrinked
New /dev/sdc is 1073741824 bytes bigger than old device
Skip increasing last partition /dev/sdc1 (not resizeable)
Examining gpt device /dev/md127 to automatically resize its last active partition
Checking /dev/md127p1 if it is the last partition on /dev/md127
Checking /dev/md127p2 if it is the last partition on /dev/md127
Found 'rear-noname' partition /dev/md127p2 as last partition on /dev/md127
Determining if last partition /dev/md127p2 is resizeable
Determining new size for last partition /dev/md127p2
Determining if last partition /dev/md127p2 actually needs to be increased or shrinked
New /dev/md127 is 2147483648 bytes smaller than old device
Last partition /dev/md127p2 must be shrinked by 2014232064 bytes to still fit on device
Shrinking last partition /dev/md127p2 to end of device (new device at most 20% smaller)
Changed last partition /dev/md127p2 size from 12739067392 to 10724835328 bytes
</code></pre>
<p>A side note about specifying the LUKS password<br />
(i.e. how "rear recover" behaves when one fails to type it in
correctly):</p>
<p>I must have mistyped the LUKS password at the<br />
<code>for 'cryptsetup luksFormat' on /dev/md127p2</code> password input prompt<br />
because then my password did not work at the subsequent<br />
<code>'cryptsetup luksOpen' on /dev/md127p2</code> password input prompt.<br />
So I typed [Ctrl]+[C] at the 'cryptsetup luksOpen' input prompt<br />
which aborts 'cryptsetup luksOpen'<br />
which lets diskrestore.sh fail<br />
which results the possibility to rerun diskrestore.sh<br />
which nicely detected what was already created<br />
and resumes at the 'cryptsetup luksFormat' password prompt:</p>
<pre><code>Start system layout restoration.
Disk '/dev/sdc': creating 'gpt' partition table
Disk '/dev/sdc': creating partition number 1 with name ''sdc1''
Creating software RAID /dev/md127
Disk '/dev/md127': creating 'gpt' partition table
Disk '/dev/md127': creating partition number 1 with name ''md127p1''
Disk '/dev/md127': creating partition number 2 with name ''md127p2''
Creating swap on /dev/sdc1
Creating LUKS volume cr_root on /dev/md127p2
Set the password for LUKS volume cr_root (for 'cryptsetup luksFormat' on /dev/md127p2):
Enter passphrase for /dev/md127p2: 
Enter the password for LUKS volume cr_root (for 'cryptsetup luksOpen' on /dev/md127p2):
Enter passphrase for /dev/md127p2: 
Enter passphrase for /dev/md127p2: 
Enter passphrase for /dev/md127p2: UserInput -I LAYOUT_CODE_RUN needed in /usr/share/rear/layout/recreate/default/200_run_layout_code.sh line 127
The disk layout recreation script failed
1) Rerun disk recreation script (/var/lib/rear/layout/diskrestore.sh)
2) View 'rear recover' log file (/var/log/rear/rear-localhost.log)
3) Edit disk recreation script (/var/lib/rear/layout/diskrestore.sh)
4) View original disk space usage (/var/lib/rear/layout/config/df.txt)
5) Use Relax-and-Recover shell and return back to here
6) Abort 'rear recover'
(default '1' timeout 300 seconds)
1
UserInput: Valid choice number result 'Rerun disk recreation script (/var/lib/rear/layout/diskrestore.sh)'
User reruns disk recreation script
Start system layout restoration.
Skipping /dev/sda (disk) as it has already been created.
Skipping /dev/sdb (disk) as it has already been created.
Skipping /dev/sdc (disk) as it has already been created.
Skipping /dev/sdc1 (part) as it has already been created.
Skipping /dev/md127 (raid) as it has already been created.
Skipping /dev/md127p1 (part) as it has already been created.
Skipping /dev/md127p2 (part) as it has already been created.
Skipping swap:/dev/sdc1 (swap) as it has already been created.
Creating LUKS volume cr_root on /dev/md127p2
Set the password for LUKS volume cr_root (for 'cryptsetup luksFormat' on /dev/md127p2):
Enter passphrase for /dev/md127p2: 
Enter the password for LUKS volume cr_root (for 'cryptsetup luksOpen' on /dev/md127p2):
Enter passphrase for /dev/md127p2: 
Creating filesystem of type btrfs with mount point / on /dev/mapper/cr_root.
Mounting filesystem /
Disk layout created.
</code></pre>
<p>and all went fine then.</p>
<p>After reboot I have now</p>
<pre><code># lsblk -ipo NAME,KNAME,PKNAME,TRAN,TYPE,FSTYPE,LABEL,SIZE,MOUNTPOINT
NAME                      KNAME        PKNAME       TRAN TYPE  FSTYPE            LABEL                SIZE MOUNTPOINT
/dev/sda                  /dev/sda                  ata  disk  linux_raid_member localhost:raid1sdab   10G 
`-/dev/md127              /dev/md127   /dev/sda          raid1                                         10G 
  |-/dev/md127p1          /dev/md127p1 /dev/md127        part                                          10M 
  `-/dev/md127p2          /dev/md127p2 /dev/md127        part  crypto_LUKS                             10G 
    `-/dev/mapper/cr_root /dev/dm-0    /dev/md127p2      crypt btrfs                                   10G /
/dev/sdb                  /dev/sdb                  ata  disk  linux_raid_member localhost:raid1sdab   11G 
`-/dev/md127              /dev/md127   /dev/sdb          raid1                                         10G 
  |-/dev/md127p1          /dev/md127p1 /dev/md127        part                                          10M 
  `-/dev/md127p2          /dev/md127p2 /dev/md127        part  crypto_LUKS                             10G 
    `-/dev/mapper/cr_root /dev/dm-0    /dev/md127p2      crypt btrfs                                   10G /
/dev/sdc                  /dev/sdc                  ata  disk                                           2G 
`-/dev/sdc1               /dev/sdc1    /dev/sdc          part  swap                                  1023M [SWAP]
/dev/sr0                  /dev/sr0                  ata  rom   iso9660           REAR-ISO            70.8M
</code></pre>
<h4 id="jsmeix_commented_at_2021-12-10_1419"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2726#issuecomment-991012091">2021-12-10 14:19</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-12-10_1419" title="Permanent link">&para;</a></h4>
<p>With
<a href="https://github.com/rear/rear/pull/2726/commits/8ff57127be0ac673b9ae23c65ed2fdda037b8e2c">https://github.com/rear/rear/pull/2726/commits/8ff57127be0ac673b9ae23c65ed2fdda037b8e2c</a><br />
I added user info about old and new disks and their sizes in case of
MIGRATION_MODE<br />
to make it easier to answer the questions to which new disks old disk
should be mapped<br />
so now that part of "rear recover" looks like</p>
<pre><code># rear -D recover
...
Comparing disks
Ambiguous disk layout needs manual configuration (more than one disk with same size used in '/var/lib/rear/layout/disklayout.conf')
Switching to manual disk layout configuration
/dev/sda had size 12884901888 (12 GiB) but is now 10737418240 (10 GiB)
/dev/sdc had size 12884901888 (12 GiB) but is now 2147483648 (2 GiB)
/dev/sdd with size 1073741824 (1 GiB) does no longer exist
/dev/sdb with size 11811160064 (11 GiB) did not exist on the original system
Could not automap /dev/sda (no disk with same size 12884901888 found)
Could not automap /dev/sdc (no disk with same size 12884901888 found)
Could not automap /dev/sdd (no disk with same size 1073741824 found)
Original disk /dev/sda does not exist (with same size) in the target system
UserInput -I LAYOUT_MIGRATION_REPLACEMENT_SDA needed in /usr/share/rear/layout/prepare/default/300_map_disks.sh line 278
Choose an appropriate replacement for /dev/sda
1) /dev/sda
2) /dev/sdb
3) /dev/sdc
4) Do not map /dev/sda
5) Use Relax-and-Recover shell and return back to here
(default '1' timeout 300 seconds)
1
UserInput: Valid choice number result '/dev/sda'
Using /dev/sda (chosen by user) for recreating /dev/sda
Original disk /dev/sdc does not exist (with same size) in the target system
UserInput -I LAYOUT_MIGRATION_REPLACEMENT_SDC needed in /usr/share/rear/layout/prepare/default/300_map_disks.sh line 278
Choose an appropriate replacement for /dev/sdc
1) /dev/sdb
2) /dev/sdc
3) Do not map /dev/sdc
4) Use Relax-and-Recover shell and return back to here
(default '1' timeout 300 seconds)
1
UserInput: Valid choice number result '/dev/sdb'
Using /dev/sdb (chosen by user) for recreating /dev/sdc
Original disk /dev/sdd does not exist (with same size) in the target system
Using /dev/sdc (the only available of the disks) for recreating /dev/sdd
Current disk mapping table (source =&gt; target):
  /dev/sda =&gt; /dev/sda
  /dev/sdc =&gt; /dev/sdb
  /dev/sdd =&gt; /dev/sdc

UserInput -I LAYOUT_MIGRATION_CONFIRM_MAPPINGS needed in /usr/share/rear/layout/prepare/default/300_map_disks.sh line 315
Confirm or edit the disk mapping
1) Confirm disk mapping and continue 'rear recover'
2) n/a
3) Edit disk mapping (/var/lib/rear/layout/disk_mappings)
4) Use Relax-and-Recover shell and return back to here
5) Abort 'rear recover'
(default '1' timeout 300 seconds)
</code></pre>
<p>I think I will improve those messages to</p>
<pre><code>/dev/sda had size 12884901888 (12 GiB) but is now 10737418240 (10 GiB)
/dev/sdc had size 12884901888 (12 GiB) but is now 2147483648 (2 GiB)
/dev/sdd had size 1073741824 (1 GiB) but does no longer exist
/dev/sdb was not used on the original system and has now 11811160064 (11 GiB)
</code></pre>
<p>to have a consistent odering of the information in each line as</p>
<pre><code>device    info what was before    info what is now
</code></pre>
<p>In particular <code>/dev/sdb ... did not exist on the original system</code> is
wrong<br />
because it existed on the original system (cf. above)</p>
<pre><code>/dev/sdb                  /dev/sdb                  ata  disk                                     5G 
|-/dev/sdb1               /dev/sdb1    /dev/sdb          part                                     8M 
|-/dev/sdb2               /dev/sdb2    /dev/sdb          part  vfat              REAR-EFI       512M 
|-/dev/sdb3               /dev/sdb3    /dev/sdb          part  ext2              MY-BOOT          1G 
`-/dev/sdb4               /dev/sdb4    /dev/sdb          part  ext3              MY-DATA        3.5G
</code></pre>
<p>but was not used (mounted) there<br />
excerpt from "rear -D mkbackup"</p>
<pre><code>Creating disk layout
Overwriting existing disk layout file /root/rear.github.master.issue2696/var/lib/rear/layout/disklayout.conf
Automatically excluding disk /dev/sdb (not used by any mounted filesystem)
Marking component '/dev/sdb' as done in /root/rear.github.master.issue2696/var/lib/rear/layout/disktodo.conf
Dependant component /dev/sdb1 is a child of component /dev/sdb
Marking component '/dev/sdb1' as done in /root/rear.github.master.issue2696/var/lib/rear/layout/disktodo.conf
Dependant component /dev/sdb2 is a child of component /dev/sdb
Marking component '/dev/sdb2' as done in /root/rear.github.master.issue2696/var/lib/rear/layout/disktodo.conf
Dependant component /dev/sdb3 is a child of component /dev/sdb
Marking component '/dev/sdb3' as done in /root/rear.github.master.issue2696/var/lib/rear/layout/disktodo.conf
Dependant component /dev/sdb4 is a child of component /dev/sdb
Marking component '/dev/sdb4' as done in /root/rear.github.master.issue2696/var/lib/rear/layout/disktodo.conf
Disabling excluded components in /root/rear.github.master.issue2696/var/lib/rear/layout/disklayout.conf
Disabling component 'disk /dev/sdb' in /root/rear.github.master.issue2696/var/lib/rear/layout/disklayout.conf
Disabling component 'part /dev/sdb' in /root/rear.github.master.issue2696/var/lib/rear/layout/disklayout.conf
Component 'part /dev/sdb' is disabled in /root/rear.github.master.issue2696/var/lib/rear/layout/disklayout.conf
Component 'part /dev/sdb' is disabled in /root/rear.github.master.issue2696/var/lib/rear/layout/disklayout.conf
Component 'part /dev/sdb' is disabled in /root/rear.github.master.issue2696/var/lib/rear/layout/disklayout.conf
</code></pre>
<h4 id="jsmeix_commented_at_2021-12-13_1151"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2726#issuecomment-992392210">2021-12-13 11:51</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-12-13_1151" title="Permanent link">&para;</a></h4>
<p>With latest commit<br />
<a href="https://github.com/rear/rear/pull/2726/commits/0b7666096dc7865e45611ef299d2ed6041840322">https://github.com/rear/rear/pull/2726/commits/0b7666096dc7865e45611ef299d2ed6041840322</a><br />
it looks like this</p>
<pre><code># rear -D recover
...
Comparing disks
Ambiguous disk layout needs manual configuration (more than one disk with same size used in '/var/lib/rear/layout/disklayout.conf')
Switching to manual disk layout configuration (GiB sizes rounded down to integer)
/dev/sda had size 12884901888 (12 GiB) but is now 10737418240 (10 GiB)
/dev/sdc had size 12884901888 (12 GiB) but is now 2147483648 (2 GiB)
/dev/sdd had size 1073741824 (1 GiB) but it does no longer exist
/dev/sdb had size 5368709120 (5 GiB) but is now 11811160064 (11 GiB)
Could not automap /dev/sda (no disk with same size 12884901888 found)
Could not automap /dev/sdc (no disk with same size 12884901888 found)
Could not automap /dev/sdd (no disk with same size 1073741824 found)
Original disk /dev/sda does not exist (with same size) in the target system
UserInput -I LAYOUT_MIGRATION_REPLACEMENT_SDA needed in /usr/share/rear/layout/prepare/default/300_map_disks.sh line 278
Choose an appropriate replacement for /dev/sda
1) /dev/sda
2) /dev/sdb
3) /dev/sdc
4) Do not map /dev/sda
5) Use Relax-and-Recover shell and return back to here
(default '1' timeout 300 seconds)
</code></pre>
<h4 id="jsmeix_commented_at_2021-12-13_1355"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2726#issuecomment-992498497">2021-12-13 13:55</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-12-13_1355" title="Permanent link">&para;</a></h4>
<p>Verified that things still work OK on non-RAID systems:</p>
<p>Original VM:</p>
<pre><code># lsblk -ipo NAME,KNAME,PKNAME,TRAN,TYPE,FSTYPE,LABEL,SIZE,MOUNTPOINT,UUID
NAME        KNAME     PKNAME   TRAN TYPE FSTYPE LABEL  SIZE MOUNTPOINT UUID
/dev/sda    /dev/sda           ata  disk                10G            
|-/dev/sda1 /dev/sda1 /dev/sda      part                 8M            
`-/dev/sda2 /dev/sda2 /dev/sda      part ext4           10G /          d4d518c3-48f5-4806-b659-32a33f5bd1b5
/dev/sdb    /dev/sdb           ata  disk                 8G            
`-/dev/sdb1 /dev/sdb1 /dev/sdb      part ext4            8G /home      f21e8e44-2f7e-427a-90c8-a0d637e37968
/dev/sr0    /dev/sr0           ata  rom               1024M

 # grep -v '^#' var/lib/rear/layout/disklayout.conf 
disk /dev/sda 10737418240 gpt
part /dev/sda 8388608 1048576 rear-noname bios_grub /dev/sda1
part /dev/sda 10727964160 9437184 rear-noname legacy_boot /dev/sda2
disk /dev/sdb 8589934592 gpt
part /dev/sdb 8588869120 1048576 rear-noname none /dev/sdb1
fs /dev/sda2 / ext4 uuid=d4d518c3-48f5-4806-b659-32a33f5bd1b5 label= blocksize=4096 reserved_blocks=4% max_mounts=-1 check_interval=0d bytes_per_inode=16369 default_mount_options=user_xattr,acl options=rw,relatime
fs /dev/sdb1 /home ext4 uuid=f21e8e44-2f7e-427a-90c8-a0d637e37968 label= blocksize=4096 reserved_blocks=4% max_mounts=-1 check_interval=0d bytes_per_inode=16381 default_mount_options=user_xattr,acl options=rw,relatime,data=ordered
</code></pre>
<p>Replacement VM:</p>
<pre><code>RESCUE localhost:~ # lsblk -ipo NAME,KNAME,PKNAME,TRAN,TYPE,FSTYPE,LABEL,SIZE,MOUNTPOINT,UUID
NAME     KNAME    PKNAME TRAN TYPE FSTYPE  LABEL    SIZE MOUNTPOINT UUID
/dev/sda /dev/sda        ata  disk                    7G            
/dev/sdb /dev/sdb        ata  disk                    5G            
/dev/sr0 /dev/sr0        ata  rom  iso9660 REAR-ISO  69M            2021-12-13-14-28-21-33

RESCUE localhost:~ # rear -D recover
...
Comparing disks
Cannot check write protection by ID for /dev/sda (no ID found)
Cannot check write protection by ID for /dev/sdb (no ID found)
Device sda has size 7516192768 bytes but 10737418240 bytes is expected (needs manual configuration)
Device sdb has size 5368709120 bytes but 8589934592 bytes is expected (needs manual configuration)
Switching to manual disk layout configuration (GiB sizes rounded down to integer)
/dev/sda had size 10737418240 (10 GiB) but is now 7516192768 (7 GiB)
/dev/sdb had size 8589934592 (8 GiB) but is now 5368709120 (5 GiB)
/dev/sr0 was not used on the original system and has now 72333312 (0 GiB)
Could not automap /dev/sda (no disk with same size 10737418240 found)
Could not automap /dev/sdb (no disk with same size 8589934592 found)
Original disk /dev/sda does not exist (with same size) in the target system
Cannot check write protection by ID for /dev/sda (no ID found)
Cannot check write protection by ID for /dev/sdb (no ID found)
UserInput -I LAYOUT_MIGRATION_REPLACEMENT_SDA needed in /usr/share/rear/layout/prepare/default/300_map_disks.sh line 278
Choose an appropriate replacement for /dev/sda
1) /dev/sda
2) /dev/sdb
3) Do not map /dev/sda
4) Use Relax-and-Recover shell and return back to here
(default '1' timeout 300 seconds)
1
UserInput: Valid choice number result '/dev/sda'
Using /dev/sda (chosen by user) for recreating /dev/sda
Original disk /dev/sdb does not exist (with same size) in the target system
Cannot check write protection by ID for /dev/sdb (no ID found)
Using /dev/sdb (the only available of the disks) for recreating /dev/sdb
Current disk mapping table (source =&gt; target):
  /dev/sda =&gt; /dev/sda
  /dev/sdb =&gt; /dev/sdb

UserInput -I LAYOUT_MIGRATION_CONFIRM_MAPPINGS needed in /usr/share/rear/layout/prepare/default/300_map_disks.sh line 315
Confirm or edit the disk mapping
1) Confirm disk mapping and continue 'rear recover'
2) Confirm identical disk mapping and proceed without manual configuration
3) Edit disk mapping (/var/lib/rear/layout/disk_mappings)
4) Use Relax-and-Recover shell and return back to here
5) Abort 'rear recover'
(default '1' timeout 300 seconds)
</code></pre>
<p>"rear recover" works well for me<br />
but of course I needed things like</p>
<pre><code>AUTOSHRINK_DISK_SIZE_LIMIT_PERCENTAGE=50
AUTORESIZE_PARTITIONS=( /dev/sda2 /dev/sdb1 )
</code></pre>
<p>to enforce autoresizing in this case, cf. default.conf about<br />
<code>Resizing partitions in MIGRATION_MODE during "rear recover"</code></p>
<h4 id="jsmeix_commented_at_2021-12-13_1357"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2726#issuecomment-992502042">2021-12-13 13:57</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-12-13_1357" title="Permanent link">&para;</a></h4>
<p>@rear/contributors<br />
things work sufficiently well for me<br />
so I would like to merge it tomorrow afternoon<br />
provided there are no objections.</p>
<h4 id="jsmeix_commented_at_2021-12-14_1025"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2726#issuecomment-993395062">2021-12-14 10:25</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-12-14_1025" title="Permanent link">&para;</a></h4>
<p>With the last three commits things work better:<br />
Now <code>AUTORESIZE_EXCLUDE_PARTITIONS=()</code> can be set by the user:</p>
<pre><code># grep -v '^#' etc/rear/local.conf 
OUTPUT=ISO
BACKUP=NETFS
BACKUP_OPTIONS="nfsvers=3,nolock"
BACKUP_URL=nfs://192.168.122.1/nfs
SSH_ROOT_PASSWORD='rear'
USE_DHCLIENT="yes"
FIRMWARE_FILES=( 'no' )
MODULES=( 'loaded_modules' )
PROGRESS_MODE="plain"
PROGRESS_WAIT_SECONDS="3"
DISKS_TO_BE_WIPED="/dev/sd[a-z]"
AUTOSHRINK_DISK_SIZE_LIMIT_PERCENTAGE=50
AUTORESIZE_EXCLUDE_PARTITIONS=()
</code></pre>
<p>And things look better during "rear recover":<br />
Now CDROM devices are no longer listed as disks:</p>
<pre><code>RESCUE localhost:~ # lsblk -ipo NAME,KNAME,PKNAME,TRAN,TYPE,FSTYPE,LABEL,SIZE,MOUNTPOINT,UUID
NAME        KNAME     PKNAME   TRAN TYPE FSTYPE  LABEL    SIZE MOUNTPOINT UUID
/dev/sda    /dev/sda           ata  disk                    7G            
|-/dev/sda1 /dev/sda1 /dev/sda      part                    8M            
`-/dev/sda2 /dev/sda2 /dev/sda      part ext4               7G            d4d518c3-48f5-4806-b659-32a33f5bd1b5
/dev/sdb    /dev/sdb           ata  disk                    5G            
`-/dev/sdb1 /dev/sdb1 /dev/sdb      part ext4               5G            f21e8e44-2f7e-427a-90c8-a0d637e37968
/dev/sr0    /dev/sr0           ata  rom  iso9660 REAR-ISO  69M            2021-12-14-10-35-14-96

RESCUE localhost:~ # rear -D recover
...
Comparing disks
Device sda has size 7516192768 bytes but 10737418240 bytes is expected (needs manual configuration)
Device sdb has size 5368709120 bytes but 8589934592 bytes is expected (needs manual configuration)
Switching to manual disk layout configuration (GiB sizes rounded down to integer)
/dev/sda had size 10737418240 (10 GiB) but is now 7516192768 (7 GiB)
/dev/sdb had size 8589934592 (8 GiB) but is now 5368709120 (5 GiB)
Could not automap /dev/sda (no disk with same size 10737418240 found)
Could not automap /dev/sdb (no disk with same size 8589934592 found)
Original disk /dev/sda does not exist (with same size) in the target system
UserInput -I LAYOUT_MIGRATION_REPLACEMENT_SDA needed in /usr/share/rear/layout/prepare/default/300_map_disks.sh line 281
Choose an appropriate replacement for /dev/sda
1) /dev/sda
2) /dev/sdb
3) Do not map /dev/sda
4) Use Relax-and-Recover shell and return back to here
(default '1' timeout 300 seconds)
1
UserInput: Valid choice number result '/dev/sda'
Using /dev/sda (chosen by user) for recreating /dev/sda
Original disk /dev/sdb does not exist (with same size) in the target system
Using /dev/sdb (the only available of the disks) for recreating /dev/sdb
Current disk mapping table (source =&gt; target):
  /dev/sda =&gt; /dev/sda
  /dev/sdb =&gt; /dev/sdb
</code></pre>
<h4 id="jsmeix_commented_at_2021-12-14_1317"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2726#issuecomment-993529741">2021-12-14 13:17</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-12-14_1317" title="Permanent link">&para;</a></h4>
<p>For completeness how it looks on my RAID1 VMs from above:</p>
<p>On the original system I have a USB disk that I do not use<br />
because I use OUTPUT=ISO<br />
so on the replacement system I have a CDROM drive.</p>
<pre><code># lsblk -ipo NAME,KNAME,PKNAME,TRAN,TYPE,FSTYPE,LABEL,SIZE,MOUNTPOINT
NAME                      KNAME        PKNAME       TRAN TYPE  FSTYPE            LABEL          SIZE MOUNTPOINT
/dev/sda                  /dev/sda                  ata  disk  linux_raid_member any:raid1sdab   12G 
`-/dev/md127              /dev/md127   /dev/sda          raid1                                   12G 
  |-/dev/md127p1          /dev/md127p1 /dev/md127        part                                    10M 
  `-/dev/md127p2          /dev/md127p2 /dev/md127        part  crypto_LUKS                     11.9G 
    `-/dev/mapper/cr_root /dev/dm-0    /dev/md127p2      crypt btrfs                           11.9G /
/dev/sdb                  /dev/sdb                  ata  disk                                     5G 
|-/dev/sdb1               /dev/sdb1    /dev/sdb          part                                     8M 
|-/dev/sdb2               /dev/sdb2    /dev/sdb          part  vfat              REAR-EFI       512M 
|-/dev/sdb3               /dev/sdb3    /dev/sdb          part  ext2              MY-BOOT          1G 
`-/dev/sdb4               /dev/sdb4    /dev/sdb          part  ext3              MY-DATA        3.5G 
/dev/sdc                  /dev/sdc                  ata  disk  linux_raid_member any:raid1sdab   12G 
`-/dev/md127              /dev/md127   /dev/sdc          raid1                                   12G 
  |-/dev/md127p1          /dev/md127p1 /dev/md127        part                                    10M 
  `-/dev/md127p2          /dev/md127p2 /dev/md127        part  crypto_LUKS                     11.9G 
    `-/dev/mapper/cr_root /dev/dm-0    /dev/md127p2      crypt btrfs                           11.9G /
/dev/sdd                  /dev/sdd                  ata  disk                                     1G 
`-/dev/sdd1               /dev/sdd1    /dev/sdd          part  swap                            1023M [SWAP]

# grep -v '^#' etc/rear/local.conf 
OUTPUT=ISO
BACKUP=NETFS
BACKUP_OPTIONS="nfsvers=3,nolock"
BACKUP_URL=nfs://192.168.122.1/nfs
REQUIRED_PROGS+=( snapper chattr )
PROGS+=( lsattr )
COPY_AS_IS+=( /usr/lib/snapper/installation-helper /etc/snapper/config-templates/default )
BACKUP_PROG_INCLUDE=( /boot/grub2/x86_64-efi /home /boot/grub2/i386-pc /root /srv /opt /tmp /usr/local /var )
POST_RECOVERY_SCRIPT=( 'if snapper --no-dbus -r $TARGET_FS_ROOT get-config | grep -q "^QGROUP.*[0-9]/[0-9]" ; then snapper --no-dbus -r $TARGET_FS_ROOT set-config QGROUP= ; snapper --no-dbus -r $TARGET_FS_ROOT setup-quota &amp;&amp; echo snapper setup-quota done || echo snapper setup-quota failed ; else echo snapper setup-quota not used ; fi' )
SSH_ROOT_PASSWORD='rear'
USE_DHCLIENT="yes"
FIRMWARE_FILES=( 'no' )
MODULES=( 'loaded_modules' )
PROGRESS_MODE="plain"
PROGRESS_WAIT_SECONDS="3"
LUKS_CRYPTSETUP_OPTIONS+=" --force-password"
GRUB2_INSTALL_DEVICES="/dev/sda /dev/sdc"
DISKS_TO_BE_WIPED="/dev/sd[a-z]"
WRITE_PROTECTED_IDS+=( fe057b67-8e9f-4b21-a67e-289a83fb3993 )
AUTOSHRINK_DISK_SIZE_LIMIT_PERCENTAGE=20

# usr/sbin/rear -D mkbackup
...
Creating disk layout
Overwriting existing disk layout file /root/rear.github.master.issue2696/var/lib/rear/layout/disklayout.conf
Automatically excluding disk /dev/sdb (not used by any mounted filesystem)
Marking component '/dev/sdb' as done in /root/rear.github.master.issue2696/var/lib/rear/layout/disktodo.conf
Dependant component /dev/sdb1 is a child of component /dev/sdb
Marking component '/dev/sdb1' as done in /root/rear.github.master.issue2696/var/lib/rear/layout/disktodo.conf
Dependant component /dev/sdb2 is a child of component /dev/sdb
Marking component '/dev/sdb2' as done in /root/rear.github.master.issue2696/var/lib/rear/layout/disktodo.conf
Dependant component /dev/sdb3 is a child of component /dev/sdb
Marking component '/dev/sdb3' as done in /root/rear.github.master.issue2696/var/lib/rear/layout/disktodo.conf
Dependant component /dev/sdb4 is a child of component /dev/sdb
Marking component '/dev/sdb4' as done in /root/rear.github.master.issue2696/var/lib/rear/layout/disktodo.conf
Disabling excluded components in /root/rear.github.master.issue2696/var/lib/rear/layout/disklayout.conf
Disabling component 'disk /dev/sdb' in /root/rear.github.master.issue2696/var/lib/rear/layout/disklayout.conf
Disabling component 'part /dev/sdb' in /root/rear.github.master.issue2696/var/lib/rear/layout/disklayout.conf
Component 'part /dev/sdb' is disabled in /root/rear.github.master.issue2696/var/lib/rear/layout/disklayout.conf
Component 'part /dev/sdb' is disabled in /root/rear.github.master.issue2696/var/lib/rear/layout/disklayout.conf
Component 'part /dev/sdb' is disabled in /root/rear.github.master.issue2696/var/lib/rear/layout/disklayout.conf
Using sysconfig bootloader 'grub2' for 'rear recover'
Verifying that the entries in /root/rear.github.master.issue2696/var/lib/rear/layout/disklayout.conf are correct
Created disk layout (check the results in /root/rear.github.master.issue2696/var/lib/rear/layout/disklayout.conf)
...

# grep -v '^#' var/lib/rear/layout/disklayout.conf 
disk /dev/sda 12884901888 gpt
disk /dev/sdc 12884901888 gpt
disk /dev/sdd 1073741824 gpt
part /dev/sdd 1072676352 1048576 rear-noname swap /dev/sdd1
raid /dev/md127 level=raid1 raid-devices=2 devices=/dev/sda,/dev/sdc name=raid1sdab metadata=1.0 uuid=8d05eb84:2de831d1:dfed54b2:ad592118
part /dev/md127 10485760 1048576 rear-noname bios_grub /dev/md127p1
part /dev/md127 12739067392 11534336 rear-noname none /dev/md127p2
fs /dev/mapper/cr_root / btrfs uuid=85406026-0559-4b0d-8f67-ec19d3b556f5 label= options=rw,relatime,space_cache,subvolid=256,subvol=/@
...
swap /dev/sdd1 uuid=9c606f48-92cd-4f98-be22-0f8a75358bed label=
crypt /dev/mapper/cr_root /dev/md127p2 type=luks1 cipher=aes-xts-plain64 key_size=512 hash=sha256 uuid=d0446c00-9e79-4872-abaa-2d464fd71c99

RESCUE localhost:~ # rear -D recover
...
Comparing disks
Ambiguous disk layout needs manual configuration (more than one disk with same size used in '/var/lib/rear/layout/disklayout.conf')
Switching to manual disk layout configuration (GiB sizes rounded down to integer)
/dev/sda had size 12884901888 (12 GiB) but is now 10737418240 (10 GiB)
/dev/sdc had size 12884901888 (12 GiB) but is now 2147483648 (2 GiB)
/dev/sdd had size 1073741824 (1 GiB) but it does no longer exist
/dev/sdb had size 5368709120 (5 GiB) but is now 11811160064 (11 GiB)
Could not automap /dev/sda (no disk with same size 12884901888 found)
Could not automap /dev/sdc (no disk with same size 12884901888 found)
Could not automap /dev/sdd (no disk with same size 1073741824 found)
Original disk /dev/sda does not exist (with same size) in the target system
UserInput -I LAYOUT_MIGRATION_REPLACEMENT_SDA needed in /usr/share/rear/layout/prepare/default/300_map_disks.sh line 285
Choose an appropriate replacement for /dev/sda
1) /dev/sda
2) /dev/sdb
3) /dev/sdc
4) Do not map /dev/sda
5) Use Relax-and-Recover shell and return back to here
(default '1' timeout 300 seconds)
1
UserInput: Valid choice number result '/dev/sda'
Using /dev/sda (chosen by user) for recreating /dev/sda
Original disk /dev/sdc does not exist (with same size) in the target system
UserInput -I LAYOUT_MIGRATION_REPLACEMENT_SDC needed in /usr/share/rear/layout/prepare/default/300_map_disks.sh line 285
Choose an appropriate replacement for /dev/sdc
1) /dev/sdb
2) /dev/sdc
3) Do not map /dev/sdc
4) Use Relax-and-Recover shell and return back to here
(default '1' timeout 300 seconds)
1
UserInput: Valid choice number result '/dev/sdb'
Using /dev/sdb (chosen by user) for recreating /dev/sdc
Original disk /dev/sdd does not exist (with same size) in the target system
Using /dev/sdc (the only available of the disks) for recreating /dev/sdd
Current disk mapping table (source =&gt; target):
  /dev/sda =&gt; /dev/sda
  /dev/sdc =&gt; /dev/sdb
  /dev/sdd =&gt; /dev/sdc
</code></pre>
<p>and after rebbot of the recreated system</p>
<pre><code># lsblk -ipo NAME,KNAME,PKNAME,TRAN,TYPE,FSTYPE,LABEL,SIZE,MOUNTPOINT,UUID
NAME                      KNAME        PKNAME       TRAN TYPE  FSTYPE          LABEL                SIZE MOUNTPOINT UUID
/dev/sda                  /dev/sda                  ata  disk  linux_raid_memb localhost:raid1sdab   10G            8d05eb84-2de8-31d1-dfed-54b2ad592118
`-/dev/md127              /dev/md127   /dev/sda          raid1                                       10G            
  |-/dev/md127p1          /dev/md127p1 /dev/md127        part                                        10M            
  `-/dev/md127p2          /dev/md127p2 /dev/md127        part  crypto_LUKS                           10G            d0446c00-9e79-4872-abaa-2d464fd71c99
    `-/dev/mapper/cr_root /dev/dm-0    /dev/md127p2      crypt btrfs                                 10G /          85406026-0559-4b0d-8f67-ec19d3b556f5
/dev/sdb                  /dev/sdb                  ata  disk  linux_raid_memb localhost:raid1sdab   11G            8d05eb84-2de8-31d1-dfed-54b2ad592118
`-/dev/md127              /dev/md127   /dev/sdb          raid1                                       10G            
  |-/dev/md127p1          /dev/md127p1 /dev/md127        part                                        10M            
  `-/dev/md127p2          /dev/md127p2 /dev/md127        part  crypto_LUKS                           10G            d0446c00-9e79-4872-abaa-2d464fd71c99
    `-/dev/mapper/cr_root /dev/dm-0    /dev/md127p2      crypt btrfs                                 10G /          85406026-0559-4b0d-8f67-ec19d3b556f5
/dev/sdc                  /dev/sdc                  ata  disk                                         2G            
`-/dev/sdc1               /dev/sdc1    /dev/sdc          part  swap                                1023M [SWAP]     9c606f48-92cd-4f98-be22-0f8a75358bed
/dev/sr0                  /dev/sr0                  ata  rom   iso9660         REAR-ISO            70.8M            2021-12-14-13-54-00-22
</code></pre>
<h4 id="jsmeix_commented_at_2021-12-17_1355"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2726#issuecomment-996740826">2021-12-17 13:55</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-12-17_1355" title="Permanent link">&para;</a></h4>
<p>The code here only works for automatically resizing<br />
on RAID1 devices that consist only of whole disks.<br />
It does not work for RAID1 devices that consist of partitions.<br />
Code to make it (hopefully) work for RAID1 devices that consist of
partitions<br />
is provided in
<a href="https://github.com/rear/rear/pull/2730/files">https://github.com/rear/rear/pull/2730/files</a><br />
which is like the code for RAID0 that consist of whole disks and
partitions<br />
but nothing wast tested with RAID1 up to now.</p>
<h4 id="jsmeix_commented_at_2021-12-21_1406"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2726#issuecomment-998807463">2021-12-21 14:06</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-12-21_1406" title="Permanent link">&para;</a></h4>
<p>A test with the changes in
<a href="https://github.com/rear/rear/pull/2730">https://github.com/rear/rear/pull/2730</a><br />
for a RAID1 device that consists of a partition /dev/sda3<br />
and a whole disk /dev/sdb.</p>
<p>Original VM:</p>
<pre><code># lsblk -ipo NAME,KNAME,PKNAME,TRAN,TYPE,FSTYPE,SIZE,MOUNTPOINT
NAME                        KNAME        PKNAME       TRAN TYPE  FSTYPE             SIZE MOUNTPOINT
/dev/sda                    /dev/sda                  ata  disk                       6G 
|-/dev/sda1                 /dev/sda1    /dev/sda          part                       8M 
|-/dev/sda2                 /dev/sda2    /dev/sda          part  swap                 1G [SWAP]
`-/dev/sda3                 /dev/sda3    /dev/sda          part  linux_raid_member    4G 
  `-/dev/md127              /dev/md127   /dev/sda3         raid1                      4G 
    |-/dev/md127p1          /dev/md127p1 /dev/md127        part  ext4               3.5G /
    `-/dev/md127p2          /dev/md127p2 /dev/md127        part  crypto_LUKS        400M 
      `-/dev/mapper/cr_home /dev/dm-0    /dev/md127p2      crypt ext4               398M /home
/dev/sdb                    /dev/sdb                  ata  disk  linux_raid_member    5G 
`-/dev/md127                /dev/md127   /dev/sdb          raid1                      4G 
  |-/dev/md127p1            /dev/md127p1 /dev/md127        part  ext4               3.5G /
  `-/dev/md127p2            /dev/md127p2 /dev/md127        part  crypto_LUKS        400M 
    `-/dev/mapper/cr_home   /dev/dm-0    /dev/md127p2      crypt ext4               398M /home
/dev/sr0                    /dev/sr0                  ata  rom   iso9660           11.4G

# grep -v '^#' etc/rear/local.conf 
OUTPUT=ISO
BACKUP=NETFS
BACKUP_OPTIONS="nfsvers=3,nolock"
BACKUP_URL=nfs://192.168.122.1/nfs
SSH_ROOT_PASSWORD='rear'
USE_DHCLIENT="yes"
FIRMWARE_FILES=( 'no' )
MODULES=( 'loaded_modules' )
PROGRESS_MODE="plain"
PROGRESS_WAIT_SECONDS="5"
LUKS_CRYPTSETUP_OPTIONS+=" --force-password"
DISKS_TO_BE_WIPED="/dev/sd[a-z]"
AUTOSHRINK_DISK_SIZE_LIMIT_PERCENTAGE=50
AUTORESIZE_EXCLUDE_PARTITIONS=()

# usr/sbin/rear -D mkbackup
...
Creating disk layout
Overwriting existing disk layout file /root/rear.github.master.pull2730raid1/var/lib/rear/layout/disklayout.conf
Disabling excluded components in /root/rear.github.master.pull2730raid1/var/lib/rear/layout/disklayout.conf
Using sysconfig bootloader 'grub2' for 'rear recover'
Verifying that the entries in /root/rear.github.master.pull2730raid1/var/lib/rear/layout/disklayout.conf are correct
Created disk layout (check the results in /root/rear.github.master.pull2730raid1/var/lib/rear/layout/disklayout.conf)
...

# grep -v '^#' var/lib/rear/layout/disklayout.conf 
disk /dev/sda 6442450944 gpt
part /dev/sda 8388608 1048576 rear-noname bios_grub /dev/sda1
part /dev/sda 1073741824 9437184 rear-noname swap /dev/sda2
part /dev/sda 4294967296 1083179008 rear-noname raid,legacy_boot /dev/sda3
disk /dev/sdb 5368709120 gpt
raid /dev/md127 level=raid1 raid-devices=2 devices=/dev/sda3,/dev/sdb name=raidsda3sdb metadata=1.0 uuid=a82e1697:4be879aa:6f2071d4:1a58219b
raiddisk /dev/md127 4294901760 gpt
part /dev/md127 3758096384 1048576 rear-noname none /dev/md127p1
part /dev/md127 419430400 3759144960 rear-noname none /dev/md127p2
fs /dev/mapper/cr_home /home ext4 uuid=ffe7a283-6007-4a30-b1ac-aadd65d1f7cc label= blocksize=1024 reserved_blocks=4% max_mounts=-1 check_interval=0d bytes_per_inode=4091 default_mount_options=user_xattr,acl options=rw,relatime,data=ordered
fs /dev/md127p1 / ext4 uuid=73553933-21f1-4aeb-848a-1dfe09516f39 label= blocksize=4096 reserved_blocks=4% max_mounts=-1 check_interval=0d bytes_per_inode=16384 default_mount_options=user_xattr,acl options=rw,relatime
swap /dev/sda2 uuid=3214aa3f-5ceb-4207-8f3d-08bbaee3014f label=
crypt /dev/mapper/cr_home /dev/md127p2 type=luks1 cipher=aes-xts-plain64 key_size=512 hash=sha256 uuid=6154a400-970e-4d09-8da5-8cb079fa5f20
</code></pre>
<p>Replacement VM:</p>
<pre><code>RESCUE localhost:~ # lsblk -ipo NAME,KNAME,PKNAME,TRAN,TYPE,FSTYPE,SIZE,MOUNTPOINT
NAME     KNAME    PKNAME TRAN TYPE FSTYPE   SIZE MOUNTPOINT
/dev/sda /dev/sda        ata  disk            5G 
/dev/sdb /dev/sdb        ata  disk          3.8G 
/dev/sr0 /dev/sr0        ata  rom  iso9660 69.6M

RESCUE localhost:~ # rear -D recover
...
Comparing disks
Device sda has size 5368709120 bytes but 6442450944 bytes is expected (needs manual configuration)
Device sdb has size 4080219136 bytes but 5368709120 bytes is expected (needs manual configuration)
Switching to manual disk layout configuration (GiB sizes rounded down to integer)
/dev/sda had size 6442450944 (6 GiB) but is now 5368709120 (5 GiB)
/dev/sdb had size 5368709120 (5 GiB) but is now 4080219136 (3 GiB)
Could not automap /dev/sda (no disk with same size 6442450944 found)
Using /dev/sda (same size 5368709120) for recreating /dev/sdb
Original disk /dev/sda does not exist (with same size) in the target system
Using /dev/sdb (the only available of the disks) for recreating /dev/sda
Current disk mapping table (source =&gt; target):
  /dev/sdb =&gt; /dev/sda
  /dev/sda =&gt; /dev/sdb
UserInput -I LAYOUT_MIGRATION_CONFIRM_MAPPINGS needed in /usr/share/rear/layout/prepare/default/300_map_disks.sh line 322
Confirm or edit the disk mapping
1) Confirm disk mapping and continue 'rear recover'
2) n/a
3) Edit disk mapping (/var/lib/rear/layout/disk_mappings)
4) Use Relax-and-Recover shell and return back to here
5) Abort 'rear recover'
(default '1' timeout 300 seconds)
3
...
/dev/sda /dev/sda
/dev/sdb /dev/sdb
"rear.github.master.pull2730raid1/var/lib/rear/layout/disk_mappings" 2 lines, 36 characters written
Current disk mapping table (source =&gt; target):
  /dev/sda =&gt; /dev/sda
  /dev/sdb =&gt; /dev/sdb

UserInput -I LAYOUT_MIGRATION_CONFIRM_MAPPINGS needed in /usr/share/rear/layout/prepare/default/300_map_disks.sh line 322
Confirm or edit the disk mapping
1) Confirm disk mapping and continue 'rear recover'
2) Confirm identical disk mapping and proceed without manual configuration
3) Edit disk mapping (/var/lib/rear/layout/disk_mappings)
4) Use Relax-and-Recover shell and return back to here
5) Abort 'rear recover'
(default '1' timeout 300 seconds)
1
UserInput: Valid choice number result 'Confirm disk mapping and continue 'rear recover''
User confirmed disk mapping
Disabling excluded components in /var/lib/rear/layout/disklayout.conf
Applied disk layout mappings to /var/lib/rear/layout/disklayout.conf
Applied disk layout mappings to /var/lib/rear/layout/config/df.txt
Applied disk layout mappings to /etc/rear/rescue.conf
Trying to automatically resize last partition when disk size changed
Examining gpt device /dev/sda to automatically resize its last active partition
New /dev/sda is 1073741824 bytes smaller than old device
Checking /dev/sda1 if it is the last partition on /dev/sda
Checking /dev/sda2 if it is the last partition on /dev/sda
Checking /dev/sda3 if it is the last partition on /dev/sda
Found 'rear-noname' partition /dev/sda3 as last partition on /dev/sda
Determining if last partition /dev/sda3 is resizeable
Determining new size for last partition /dev/sda3
Determining if last partition /dev/sda3 actually needs to be increased or shrinked
Last partition /dev/sda3 must be shrinked by 10485760 bytes to still fit on device
Shrinking last partition /dev/sda3 to end of device (new device at most 50% smaller)
Changed last partition /dev/sda3 size from 4294967296 to 4284481536 bytes
Examining gpt device /dev/md127 to automatically resize its last active partition
New /dev/md127 is 1288489984 bytes smaller than old device
Checking /dev/md127p1 if it is the last partition on /dev/md127
Checking /dev/md127p2 if it is the last partition on /dev/md127
Found 'rear-noname' partition /dev/md127p2 as last partition on /dev/md127
Determining if last partition /dev/md127p2 is resizeable
Determining new size for last partition /dev/md127p2
Determining if last partition /dev/md127p2 actually needs to be increased or shrinked
Last partition /dev/md127p2 must be shrinked by 98566144 bytes to still fit on device
Shrinking last partition /dev/md127p2 to end of device (new device at most 50% smaller)
Changed last partition /dev/md127p2 size from 419430400 to 320864256 bytes
UserInput -I LAYOUT_FILE_CONFIRMATION needed in /usr/share/rear/layout/prepare/default/500_confirm_layout_file.sh line 26
Confirm or edit the disk layout file
1) Confirm disk layout and continue 'rear recover'
2) Edit disk layout (/var/lib/rear/layout/disklayout.conf)
3) View disk layout (/var/lib/rear/layout/disklayout.conf)
4) View original disk space usage (/var/lib/rear/layout/config/df.txt)
5) Use Relax-and-Recover shell and return back to here
6) Abort 'rear recover'
(default '1' timeout 300 seconds)

UserInput: No real user input (empty or only spaces) - using default input
UserInput: Valid choice number result 'Confirm disk layout and continue 'rear recover''
User confirmed disk layout file
...
User confirmed disk recreation script
Determining disks to be wiped ...
Cannot check write protection by ID for /dev/sda (no ID found)
Cannot check write protection by ID for /dev/sdb (no ID found)
UserInput -I WIPE_DISKS_CONFIRMATION needed in /usr/share/rear/layout/recreate/default/120_confirm_wipedisk_disks.sh line 157
Disks to be wiped: /dev/sda /dev/sdb 
1) Confirm disks to be completely overwritten and continue 'rear recover'
2) Use Relax-and-Recover shell and return back to here
3) Abort 'rear recover'
(default '1' timeout 300 seconds)

UserInput: No real user input (empty or only spaces) - using default input
UserInput: Valid choice number result 'Confirm disks to be completely overwritten and continue 'rear recover''
User confirmed disks to be wiped
Wiping child devices of /dev/sda in reverse ordering: /dev/sda 
Wiped first 16777216 bytes of /dev/sda
Wiped last 16777216 bytes of /dev/sda
Wiping child devices of /dev/sdb in reverse ordering: /dev/sdb 
Wiped first 16777216 bytes of /dev/sdb
Wiped last 16777216 bytes of /dev/sdb
Start system layout restoration.
Disk '/dev/sda': creating 'gpt' partition table
Disk '/dev/sda': creating partition number 1 with name ''sda1''
Disk '/dev/sda': creating partition number 2 with name ''sda2''
Disk '/dev/sda': creating partition number 3 with name ''sda3''
Creating software RAID /dev/md127
Disk '/dev/md127': creating 'gpt' partition table
Disk '/dev/md127': creating partition number 1 with name ''md127p1''
Disk '/dev/md127': creating partition number 2 with name ''md127p2''
Creating filesystem of type ext4 with mount point / on /dev/md127p1.
Mounting filesystem /
Creating swap on /dev/sda2
Creating LUKS volume cr_home on /dev/md127p2
Set the password for LUKS volume cr_home (for 'cryptsetup luksFormat' on /dev/md127p2):
Enter passphrase for /dev/md127p2: 
Enter the password for LUKS volume cr_home (for 'cryptsetup luksOpen' on /dev/md127p2):
Enter passphrase for /dev/md127p2: 
Creating filesystem of type ext4 with mount point /home on /dev/mapper/cr_home.
Mounting filesystem /home
Disk layout created.
...
User confirmed restored files
Running mkinitrd...
Recreated initrd (/sbin/mkinitrd).
Installing GRUB2 boot loader...
Determining where to install GRUB2 (no GRUB2_INSTALL_DEVICES specified)
Found possible boot disk /dev/sda - installing GRUB2 there
Found possible boot disk /dev/sdb
/dev/sda - installing GRUB2 there
Failed to install GRUB2 on possible boot disk /dev/sdb
/dev/sda
Running 'wrapup' stage ======================
Finished 'recover'. The target system is mounted at '/mnt/local'.

RESCUE localhost:~ # lsblk -ipo NAME,KNAME,PKNAME,TRAN,TYPE,FSTYPE,SIZE,MOUNTPOINT
NAME                        KNAME        PKNAME       TRAN TYPE  FSTYPE             SIZE MOUNTPOINT
/dev/sda                    /dev/sda                  ata  disk                       5G 
|-/dev/sda1                 /dev/sda1    /dev/sda          part                       8M 
|-/dev/sda2                 /dev/sda2    /dev/sda          part  swap                 1G 
`-/dev/sda3                 /dev/sda3    /dev/sda          part  linux_raid_member    4G 
  `-/dev/md127              /dev/md127   /dev/sda3         raid1                    3.8G 
    |-/dev/md127p1          /dev/md127p1 /dev/md127        part  ext4               3.5G /mnt/local
    `-/dev/md127p2          /dev/md127p2 /dev/md127        part  crypto_LUKS        306M 
      `-/dev/mapper/cr_home /dev/dm-0    /dev/md127p2      crypt ext4               304M /mnt/local/home
/dev/sdb                    /dev/sdb                  ata  disk  linux_raid_member  3.8G 
`-/dev/md127                /dev/md127   /dev/sdb          raid1                    3.8G 
  |-/dev/md127p1            /dev/md127p1 /dev/md127        part  ext4               3.5G /mnt/local
  `-/dev/md127p2            /dev/md127p2 /dev/md127        part  crypto_LUKS        306M 
    `-/dev/mapper/cr_home   /dev/dm-0    /dev/md127p2      crypt ext4               304M /mnt/local/home
/dev/sr0                    /dev/sr0                  ata  rom   iso9660           69.6M
</code></pre>
<p>Regardless of the "Failed to install GRUB2 on possible boot disk
/dev/sdb..." message<br />
the recreated system boots well (from /dev/sda) and seems to work OK<br />
so automated resizing or RAID1 that consist of whole disks and
partitions<br />
should now also work when
<a href="https://github.com/rear/rear/pull/2730">https://github.com/rear/rear/pull/2730</a>
is merged.</p>
<p>Note what the automated disk mapping did (excerpt from above)</p>
<pre><code>Comparing disks
Device sda has size 5368709120 bytes but 6442450944 bytes is expected (needs manual configuration)
Device sdb has size 4080219136 bytes but 5368709120 bytes is expected (needs manual configuration)
Switching to manual disk layout configuration (GiB sizes rounded down to integer)
/dev/sda had size 6442450944 (6 GiB) but is now 5368709120 (5 GiB)
/dev/sdb had size 5368709120 (5 GiB) but is now 4080219136 (3 GiB)
Could not automap /dev/sda (no disk with same size 6442450944 found)
Using /dev/sda (same size 5368709120) for recreating /dev/sdb
Original disk /dev/sda does not exist (with same size) in the target system
Using /dev/sdb (the only available of the disks) for recreating /dev/sda
Current disk mapping table (source =&gt; target):
  /dev/sdb =&gt; /dev/sda
  /dev/sda =&gt; /dev/sdb
</code></pre>
<p>Because sda changed from 6 GiB to 5 GiB<br />
and sdb changed from 5 GiB to 4 GiB<br />
the new sda size is same as the old sdb size<br />
so the new sda was automatically chosen as sdb replacement<br />
and then only the new sdb was left as replacement for the old sda<br />
so that automated disk mapping results that<br />
the old 5 GiB sdb is replaced by the new 5 GiB sda and<br />
the old 6 GiB sda is replaced by the new 4 GiB sdb<br />
which is not what I wanted so I selected<br />
"3) Edit disk mapping (/var/lib/rear/layout/disk_mappings)"<br />
and specified my intended mapping that<br />
the old 6 GiB sda is replaced by the new 5 GiB sda and<br />
the old 5 GiB sda is replaced by the new 4 GiB sdb.</p>
<p>"rear recover" fails when I accept the automated disk mapping that<br />
the old 5 GiB sdb is replaced by the new 5 GiB sda and<br />
the old 6 GiB sda is replaced by the new 4 GiB sdb:</p>
<pre><code>RESCUE localhost:~ # rear -D recover
...
Comparing disks
Device sda has size 5368709120 bytes but 6442450944 bytes is expected (needs manual configuration)
Device sdb has size 4080219136 bytes but 5368709120 bytes is expected (needs manual configuration)
Switching to manual disk layout configuration (GiB sizes rounded down to integer)
/dev/sda had size 6442450944 (6 GiB) but is now 5368709120 (5 GiB)
/dev/sdb had size 5368709120 (5 GiB) but is now 4080219136 (3 GiB)
Could not automap /dev/sda (no disk with same size 6442450944 found)
Using /dev/sda (same size 5368709120) for recreating /dev/sdb
Original disk /dev/sda does not exist (with same size) in the target system
Using /dev/sdb (the only available of the disks) for recreating /dev/sda
Current disk mapping table (source =&gt; target):
  /dev/sdb =&gt; /dev/sda
  /dev/sda =&gt; /dev/sdb

UserInput -I LAYOUT_MIGRATION_CONFIRM_MAPPINGS needed in /usr/share/rear/layout/prepare/default/300_map_disks.sh line 322
Confirm or edit the disk mapping
1) Confirm disk mapping and continue 'rear recover'
2) n/a
3) Edit disk mapping (/var/lib/rear/layout/disk_mappings)
4) Use Relax-and-Recover shell and return back to here
5) Abort 'rear recover'
(default '1' timeout 300 seconds)

UserInput: No real user input (empty or only spaces) - using default input
UserInput: Valid choice number result 'Confirm disk mapping and continue 'rear recover''
User confirmed disk mapping
Disabling excluded components in /var/lib/rear/layout/disklayout.conf
Applied disk layout mappings to /var/lib/rear/layout/disklayout.conf
Applied disk layout mappings to /var/lib/rear/layout/config/df.txt
Applied disk layout mappings to /etc/rear/rescue.conf
Trying to automatically resize last partition when disk size changed
Examining gpt device /dev/sdb to automatically resize its last active partition
New /dev/sdb is 2362231808 bytes smaller than old device
Checking /dev/sdb1 if it is the last partition on /dev/sdb
Checking /dev/sdb2 if it is the last partition on /dev/sdb
Checking /dev/sdb3 if it is the last partition on /dev/sdb
Found 'rear-noname' partition /dev/sdb3 as last partition on /dev/sdb
Determining if last partition /dev/sdb3 is resizeable
Determining new size for last partition /dev/sdb3
Determining if last partition /dev/sdb3 actually needs to be increased or shrinked
Last partition /dev/sdb3 must be shrinked by 1298137088 bytes to still fit on device
Shrinking last partition /dev/sdb3 to end of device (new device at most 50% smaller)
Changed last partition /dev/sdb3 size from 4294967296 to 2996830208 bytes
Examining gpt device /dev/md127 to automatically resize its last active partition
New /dev/md127 is 1288489984 bytes smaller than old device
Checking /dev/md127p1 if it is the last partition on /dev/md127
Checking /dev/md127p2 if it is the last partition on /dev/md127
Found 'rear-noname' partition /dev/md127p2 as last partition on /dev/md127
Determining if last partition /dev/md127p2 is resizeable
Determining new size for last partition /dev/md127p2
Determining if last partition /dev/md127p2 actually needs to be increased or shrinked
Last partition /dev/md127p2 must be shrinked by 98566144 bytes to still fit on device
Shrinking last partition /dev/md127p2 to end of device (new device at most 50% smaller)
Changed last partition /dev/md127p2 size from 419430400 to 320864256 bytes
UserInput -I LAYOUT_FILE_CONFIRMATION needed in /usr/share/rear/layout/prepare/default/500_confirm_layout_file.sh line 26
Confirm or edit the disk layout file
1) Confirm disk layout and continue 'rear recover'
2) Edit disk layout (/var/lib/rear/layout/disklayout.conf)
3) View disk layout (/var/lib/rear/layout/disklayout.conf)
4) View original disk space usage (/var/lib/rear/layout/config/df.txt)
5) Use Relax-and-Recover shell and return back to here
6) Abort 'rear recover'
(default '1' timeout 300 seconds)

UserInput: No real user input (empty or only spaces) - using default input
UserInput: Valid choice number result 'Confirm disk layout and continue 'rear recover''
User confirmed disk layout file
Marking component '/dev/sdb' as done in /var/lib/rear/layout/disktodo.conf
Marking component '/dev/sdb1' as done in /var/lib/rear/layout/disktodo.conf
Marking component '/dev/sdb2' as done in /var/lib/rear/layout/disktodo.conf
Marking component '/dev/sdb3' as done in /var/lib/rear/layout/disktodo.conf
Marking component '/dev/sda' as done in /var/lib/rear/layout/disktodo.conf
Marking component '/dev/md127' as done in /var/lib/rear/layout/disktodo.conf
Marking component '/dev/md127p1' as done in /var/lib/rear/layout/disktodo.conf
Marking component '/dev/md127p2' as done in /var/lib/rear/layout/disktodo.conf
Marking component 'fs:/' as done in /var/lib/rear/layout/disktodo.conf
Marking component 'swap:/dev/sdb2' as done in /var/lib/rear/layout/disktodo.conf
Marking component '/dev/mapper/cr_home' as done in /var/lib/rear/layout/disktodo.conf
Marking component 'fs:/home' as done in /var/lib/rear/layout/disktodo.conf
Running 'layout/recreate' stage ======================
UserInput -I LAYOUT_CODE_CONFIRMATION needed in /usr/share/rear/layout/recreate/default/100_confirm_layout_code.sh line 26
Confirm or edit the disk recreation script
1) Confirm disk recreation script and continue 'rear recover'
2) Edit disk recreation script (/var/lib/rear/layout/diskrestore.sh)
3) View disk recreation script (/var/lib/rear/layout/diskrestore.sh)
4) View original disk space usage (/var/lib/rear/layout/config/df.txt)
5) Use Relax-and-Recover shell and return back to here
6) Abort 'rear recover'
(default '1' timeout 300 seconds)

UserInput: No real user input (empty or only spaces) - using default input
UserInput: Valid choice number result 'Confirm disk recreation script and continue 'rear recover''
User confirmed disk recreation script
Determining disks to be wiped ...
UserInput -I WIPE_DISKS_CONFIRMATION needed in /usr/share/rear/layout/recreate/default/120_confirm_wipedisk_disks.sh line 157
Disks to be wiped: /dev/sda /dev/sdb 
1) Confirm disks to be completely overwritten and continue 'rear recover'
2) Use Relax-and-Recover shell and return back to here
3) Abort 'rear recover'
(default '1' timeout 300 seconds)

UserInput: No real user input (empty or only spaces) - using default input
UserInput: Valid choice number result 'Confirm disks to be completely overwritten and continue 'rear recover''
User confirmed disks to be wiped
Wiping child devices of /dev/sda in reverse ordering: /dev/sda3 /dev/sda2 /dev/sda1 /dev/sda 
Wiped first 16777216 bytes of /dev/sda3
Wiped last 16777216 bytes of /dev/sda3
Wiped first 16777216 bytes of /dev/sda2
Wiped last 16777216 bytes of /dev/sda2
Wiped first 8388608 bytes of /dev/sda1
Skip wiping at the end of /dev/sda1 (dvice size 8388608 not greater than the bytes that were wiped)
Wiped first 16777216 bytes of /dev/sda
Wiped last 16777216 bytes of /dev/sda
Wiping child devices of /dev/sdb in reverse ordering: /dev/sdb2 /dev/sdb1 /dev/sdb 
Wiped first 16777216 bytes of /dev/sdb2
Wiped last 16777216 bytes of /dev/sdb2
Wiped first 16777216 bytes of /dev/sdb1
Wiped last 16777216 bytes of /dev/sdb1
Wiped first 16777216 bytes of /dev/sdb
Wiped last 16777216 bytes of /dev/sdb
Start system layout restoration.
Disk '/dev/sdb': creating 'gpt' partition table
Disk '/dev/sdb': creating partition number 1 with name ''sdb1''
Disk '/dev/sdb': creating partition number 2 with name ''sdb2''
Disk '/dev/sdb': creating partition number 3 with name ''sdb3''
Creating software RAID /dev/md127
Disk '/dev/md127': creating 'gpt' partition table
Disk '/dev/md127': creating partition number 1 with name ''md127p1''
UserInput -I LAYOUT_CODE_RUN needed in /usr/share/rear/layout/recreate/default/200_run_layout_code.sh line 127
The disk layout recreation script failed
1) Rerun disk recreation script (/var/lib/rear/layout/diskrestore.sh)
2) View 'rear recover' log file (/var/log/rear/rear-localhost.log)
3) Edit disk recreation script (/var/lib/rear/layout/diskrestore.sh)
4) View original disk space usage (/var/lib/rear/layout/config/df.txt)
5) Use Relax-and-Recover shell and return back to here
6) Abort 'rear recover'
(default '1' timeout 300 seconds)
6
UserInput: Valid choice number result 'Abort 'rear recover''
ERROR: User chose to abort 'rear recover' in /usr/share/rear/layout/recreate/default/200_run_layout_code.sh
Some latest log messages since the last called script 200_run_layout_code.sh:
  2021-12-22 12:58:02.059379910 4) View original disk space usage (/var/lib/rear/layout/config/df.txt)
  2021-12-22 12:58:02.065484158 5) Use Relax-and-Recover shell and return back to here
  2021-12-22 12:58:02.070543219 6) Abort 'rear recover'
  2021-12-22 12:58:02.076606002 (default '1' timeout 300 seconds)
  2021-12-22 12:58:10.928296948 UserInput: 'read' got as user input '6'
  2021-12-22 12:58:10.936017614 UserInput: Valid choice number result 'Abort 'rear recover''
  2021-12-22 12:58:10.942074559 Error detected during restore.
  2021-12-22 12:58:10.947084880 Restoring saved original /var/lib/rear/layout/disklayout.conf
Aborting due to an error, check /var/log/rear/rear-localhost.log for details
...

RESCUE localhost:~ # less /var/log/rear/rear-localhost.log 
...
+++ Print 'Disk '\''/dev/md127'\'': creating partition number 1 with name '\'''\''md127p1'\'''\'''
+++ [[ ! -n 3759144959 ]]
+++ parted -s /dev/md127 mkpart ''\''md127p1'\''' 1048576B 3759144959B
Error: The location 3759144959B is outside of the device /dev/md127.

RESCUE localhost:~ # parted -s /dev/sdb unit B print
Model: ATA QEMU HARDDISK (scsi)
Disk /dev/sdb: 4080219136B
Sector size (logical/physical): 512B/512B
Partition Table: gpt
Disk Flags: 
Number  Start        End          Size         File system  Name  Flags
 1      1048576B     9437183B     8388608B                  sdb1  bios_grub
 2      9437184B     1083179007B  1073741824B               sdb2  swap
 3      1083179008B  4080009215B  2996830208B               sdb3  raid, legacy_boot

RESCUE localhost:~ # lsblk -ipo NAME,KNAME,PKNAME,TRAN,TYPE,FSTYPE,SIZE,MOUNTPOINT
NAME           KNAME      PKNAME    TRAN TYPE  FSTYPE             SIZE MOUNTPOINT
/dev/sda       /dev/sda             ata  disk                       5G 
`-/dev/md127   /dev/md127 /dev/sda       raid1                    2.8G 
/dev/sdb       /dev/sdb             ata  disk                     3.8G 
|-/dev/sdb1    /dev/sdb1  /dev/sdb       part                       8M 
|-/dev/sdb2    /dev/sdb2  /dev/sdb       part                       1G 
`-/dev/sdb3    /dev/sdb3  /dev/sdb       part  linux_raid_member  2.8G 
  `-/dev/md127 /dev/md127 /dev/sdb3      raid1                    2.8G 
/dev/sr0       /dev/sr0             ata  rom   iso9660           69.6M

RESCUE localhost:~ # lsblk -bipo NAME,KNAME,PKNAME,TRAN,TYPE,FSTYPE,SIZE,MOUNTPOINT
NAME           KNAME      PKNAME    TRAN TYPE  FSTYPE                  SIZE MOUNTPOINT
/dev/sda       /dev/sda             ata  disk                    5368709120 
`-/dev/md127   /dev/md127 /dev/sda       raid1                   2996764672 
/dev/sdb       /dev/sdb             ata  disk                    4080219136 
|-/dev/sdb1    /dev/sdb1  /dev/sdb       part                       8388608 
|-/dev/sdb2    /dev/sdb2  /dev/sdb       part                    1073741824 
`-/dev/sdb3    /dev/sdb3  /dev/sdb       part  linux_raid_member 2996830208 
  `-/dev/md127 /dev/md127 /dev/sdb3      raid1                   2996764672 
/dev/sr0       /dev/sr0             ata  rom   iso9660             72943616
</code></pre>
<p>So something is still not right in the autoresizing code in<br />
layout/prepare/default/420_autoresize_last_partitions.sh<br />
because it should not happen that diskrestore.sh contains<br />
impossible commands that let diskrestore.sh fail.<br />
Instead the autoresizing code in 420_autoresize_last_partitions.sh<br />
should error out when resizing is impossible.</p>
<h4 id="jsmeix_commented_at_2021-12-22_1237"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2726#issuecomment-999546292">2021-12-22 12:37</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-12-22_1237" title="Permanent link">&para;</a></h4>
<p>As far as I see currently<br />
the autoresizing code in 420_autoresize_last_partitions.sh<br />
fails in this extreme (impossible) case where before the original RAID1
was</p>
<pre><code>`-/dev/md127              /dev/md127   /dev/sdb     raid1               4G 
  |-/dev/md127p1          /dev/md127p1 /dev/md127   part  ext4        3.5G /
  `-/dev/md127p2          /dev/md127p2 /dev/md127   part  crypto_LUKS 400M 
    `-/dev/mapper/cr_home /dev/dm-0    /dev/md127p2 crypt ext4        398M /home
</code></pre>
<p>which should be automatically shrinked to</p>
<pre><code>`-/dev/md127 /dev/md127 /dev/sdb3 raid1 2.8G
</code></pre>
<p>so it must be shrinked by 1.2 GiB<br />
but the original last partition /dev/md127p2 is only 400 MiB big<br />
so it is impossible to shrink this last partition by 1.2 GiB.</p>
<p>But the "rear -D recover" output contains</p>
<pre><code>Last partition /dev/md127p2 must be shrinked by 98566144 bytes to still fit on device
...
Changed last partition /dev/md127p2 size from 419430400 to 320864256 bytes
</code></pre>
<p>which is shrinking by 94 MiB from 400 MiB to 306 MiB.<br />
This is wrong because actually it woud need to be shrinked by 1.2 GiB<br />
because the "rear -D recover" output contains</p>
<pre><code>New /dev/md127 is 1288489984 bytes smaller than old device
</code></pre>
<p>which is 1.1999998 GiB smaller so this value looks right.</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2025 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2021-12-09.2726.pr.merged.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/rear/rear-user-guide" class="fa fa-code-fork" style="color: #fcfcfc"> rear/rear-user-guide</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
