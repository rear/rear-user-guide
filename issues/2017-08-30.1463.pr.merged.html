<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#1463 PR merged: Activate btrfs filesystem creation with original uuid - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#1463 PR merged: Activate btrfs filesystem creation with original uuid";
        var mkdocs_page_input_path = "issues/2017-08-30.1463.pr.merged.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/backup_netfs.html">Example of BACKUP=NETFS</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/netfs_nas.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../development/squash-git-log-commments.html">How to squash git log comments into one line</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear29.html">Release Notes ReaR 2.9</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear28.html">Release Notes ReaR 2.8</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#1463 PR merged: Activate btrfs filesystem creation with original uuid</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="1463_pr_merged_activate_btrfs_filesystem_creation_with_original_uuid"><a href="https://github.com/rear/rear/pull/1463">#1463 PR</a> <code>merged</code>: Activate btrfs filesystem creation with original uuid<a class="headerlink" href="#1463_pr_merged_activate_btrfs_filesystem_creation_with_original_uuid" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>enhancement</code>, <code>fixed / solved / done</code></p>
<h4 id="schabrolles_opened_issue_at_2017-08-30_1849"><img src="https://avatars.githubusercontent.com/u/19491077?u=0021b16ab426902cbe676f6831f41607bbe4d441&v=4" width="50"><a href="https://github.com/schabrolles">schabrolles</a> opened issue at <a href="https://github.com/rear/rear/pull/1463">2017-08-30 18:49</a>:<a class="headerlink" href="#schabrolles_opened_issue_at_2017-08-30_1849" title="Permanent link">&para;</a></h4>
<p>Recent btrfs version finally add the <code>--uuid</code> (or <code>-U</code>) option<br />
to create a btrfs fs with a specifique UUID.<br />
It avoids changing UUID of btrfs each time we recover a system<br />
(which is useless and can potentially bring recovery issue<br />
when using a data backup older than the recovery image<br />
(point-in-time restore)).</p>
<h4 id="jsmeix_commented_at_2017-08-31_0911"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1463#issuecomment-326237942">2017-08-31 09:11</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-08-31_0911" title="Permanent link">&para;</a></h4>
<p>@schabrolles<br />
many thanks for this enhancement!</p>
<p>I think your current code works<br />
but I also think it works in a somewhat indirect<br />
and unexpected way - in other words: I think<br />
it should be coded more clearly what is intended.</p>
<p>First thing where I stumble when looking at the code is<br />
that "mkfs -U $uuid" is called even if $uuid is empty<br />
(i.e. outside of the "if [ -n "$uuid" ]" test below)<br />
but "fortunately" it works because of the<br />
subsequent "|| mkfs" call without "-U $uuid".</p>
<p>Second thing where I stumble when looking at the code is<br />
that the "# Set the UUID:" part is callled even if<br />
the "mkfs -U $uuid" before had worked which looks<br />
as if the UUID is set twice but "fortunately"<br />
the "# Set the UUID:" part does not harm<br />
because it only does something when "$uuid" != "$new_uuid"<br />
but when the "mkfs -U $uuid" before had worked then<br />
"$uuid" = "$new_uuid" so that in the end it is o.k.<br />
(hopefully - if I did not overlook an exceptional case).</p>
<p>We have this try "mkfs -U $uuid" and if that fails<br />
fall back to the old behaviour already for the ext*<br />
and xfs filesystems.</p>
<p>Have a look how it is implemented there.</p>
<p>Personally I like the implementation for ext* most.</p>
<p>There you can - by the way - also see how one can<br />
output multiple lines into a file and keep the indentation<br />
in the code that outputs the multiple lines i.e. via<br />
a sub-shell that output each line via 'echo'.</p>
<p>In general regarding the generated code in $LAYOUT_CODE:</p>
<p>The $LAYOUT_CODE (i.e. diskrestore.sh)<br />
is run with "set -e" so that one must be extra-careful<br />
to ensure that every command succeeds<br />
(except an intended error exit).</p>
<p>For example (on commandline) what does not work</p>
<pre>
# ( set -e ; var=$( grep foo /etc/fstab ) ; echo do something )
[no output]
</pre>

<p>versus how to make that work with 'set -e'</p>
<pre>
# ( set -e ; var=$( grep foo /etc/fstab || true ) ; echo do something )
do something
</pre>

<h4 id="schabrolles_commented_at_2017-08-31_1107"><img src="https://avatars.githubusercontent.com/u/19491077?u=0021b16ab426902cbe676f6831f41607bbe4d441&v=4" width="50"><a href="https://github.com/schabrolles">schabrolles</a> commented at <a href="https://github.com/rear/rear/pull/1463#issuecomment-326263747">2017-08-31 11:07</a>:<a class="headerlink" href="#schabrolles_commented_at_2017-08-31_1107" title="Permanent link">&para;</a></h4>
<p>@jsmeix I re-write the btrfs section. Tell me if you prefer this
version.</p>
<h4 id="jsmeix_commented_at_2017-08-31_1344"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1463#issuecomment-326299497">2017-08-31 13:44</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-08-31_1344" title="Permanent link">&para;</a></h4>
<p>I still see 'echo' with double quotes inside like</p>
<pre>
echo "          if ! grep -q "${uuid}" "$FS_UUID_MAP" ; then"
echo "              echo "$uuid \$new_uuid $device" >> $FS_UUID_MAP"
...
echo "              SED_SCRIPT=";/${uuid}/s/\${old_uuid}/\${new_uuid}/g""
echo "              sed -i "\$SED_SCRIPT" "$FS_UUID_MAP""
</pre>

<h4 id="schabrolles_commented_at_2017-08-31_1435"><img src="https://avatars.githubusercontent.com/u/19491077?u=0021b16ab426902cbe676f6831f41607bbe4d441&v=4" width="50"><a href="https://github.com/schabrolles">schabrolles</a> commented at <a href="https://github.com/rear/rear/pull/1463#issuecomment-326315023">2017-08-31 14:35</a>:<a class="headerlink" href="#schabrolles_commented_at_2017-08-31_1435" title="Permanent link">&para;</a></h4>
<p>@jsmeix should be better now.<br />
tested with sles12</p>
<h4 id="schabrolles_commented_at_2017-08-31_1509"><img src="https://avatars.githubusercontent.com/u/19491077?u=0021b16ab426902cbe676f6831f41607bbe4d441&v=4" width="50"><a href="https://github.com/schabrolles">schabrolles</a> commented at <a href="https://github.com/rear/rear/pull/1463#issuecomment-326325887">2017-08-31 15:09</a>:<a class="headerlink" href="#schabrolles_commented_at_2017-08-31_1509" title="Permanent link">&para;</a></h4>
<p>@jsmeix You're welcome. thanks for your careful review.<br />
I'm gonna wait for tomorrow to merge this one.</p>
<h4 id="schabrolles_commented_at_2017-09-01_0858"><img src="https://avatars.githubusercontent.com/u/19491077?u=0021b16ab426902cbe676f6831f41607bbe4d441&v=4" width="50"><a href="https://github.com/schabrolles">schabrolles</a> commented at <a href="https://github.com/rear/rear/pull/1463#issuecomment-326528664">2017-09-01 08:58</a>:<a class="headerlink" href="#schabrolles_commented_at_2017-09-01_0858" title="Permanent link">&para;</a></h4>
<p>@schlomo The use of <code>echo</code> was requested by @jsmeix (except if I
misunderstood).</p>
<blockquote>
<p>Personally I like the implementation for ext* most.</p>
<p>There you can - by the way - also see how one can<br />
output multiple lines into a file and keep the indentation<br />
in the code that outputs the multiple lines i.e. via<br />
a sub-shell that output each line via 'echo'.</p>
</blockquote>
<p>From my point of view, both have pro and cons.... I decided to apply
what @jsmeix suggested to bring more "unity" or "constancy" in the code
as <code>ext</code> filesystem part is using it.</p>
<p>Just let me know which one you prefer.</p>
<h4 id="schlomo_commented_at_2017-09-01_0950"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/1463#issuecomment-326539676">2017-09-01 09:50</a>:<a class="headerlink" href="#schlomo_commented_at_2017-09-01_0950" title="Permanent link">&para;</a></h4>
<p>I see. I'll let you guys decide what to do as I don't have time to work
on that part in any case. This is a typical question where we pay the
price later when we need to visit this code again.</p>
<p>IMHO better indentation is much less worth than having clean code that
can be pasted into another shell to try out. With the double quoting
introduced by the line-by-line echo this becomes impossible. It also
adds a lot of potential sources for errors due to this double quoting. I
personally would therefore resort to double quoting only if no other
option works.</p>
<p>FWIW, I had the idea about dumping functions only yesterday, otherwise I
would have suggested that earlier. I also haven't tried that out in a
bigger context and therefore can't tell you the problems it will cause.
Most likely it works well as long as all variable parameters will be
passed into the function as command line arguments and not via global
shell variables.</p>
<h4 id="jsmeix_commented_at_2017-09-01_0956"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1463#issuecomment-326541078">2017-09-01 09:56</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-09-01_0956" title="Permanent link">&para;</a></h4>
<p>@schlomo @schabrolles<br />
for me the reason for things like</p>
<pre>
    (   echo "    if CONDITION ; then"
        echo "        do_something"
        echo "    fi"
    ) >> "$LAYOUT_CODE"
</pre>

<p>is that this way I can reliably keep the indentation<br />
in the code that outputs the code lines<br />
plus the indentation in the output code lines<br />
by using spaces which is "the only right character" ;-)<br />
for indentations (see below).</p>
<p>In contrast for here documents with &lt;&lt;-EOF<br />
indentation with tabs can easily get wrong<br />
as soon as someone or something replaces tabs by spaces<br />
because he wants to get rich with spaces for indentations<br />
or a tool does it automatically (see below).</p>
<p>And it is really hard to distinguish by plain looking at the code<br />
between the tabs indentation in the code that outputs<br />
the code lines and the indentation with spaces in the<br />
output code lines itself - for example as in</p>
<pre>
#!/bin/bash
if true ; then
    cat >> /tmp/heredoctestout.sh &lt;&lt;-EOF
        #!/bin/bash
        if true ; then
            echo Hello
        fi
        exit 0
        EOF
fi
echo wrote /tmp/heredoctestout.sh
</pre>

<p>Furthermore this way it is harder to distinguish<br />
between the code that outputs the code lines<br />
and the output code lines itself because both<br />
look very similar (one has to carefully recognize<br />
where the output code lines itself start and the 'EOF')<br />
otherwise by "just looking" at the code it may look<br />
as if the 'echo Hello' is run directly.</p>
<p>Note that here it already happened that my tabs<br />
were automatically replaced by spaces when I<br />
copy&amp;pasted my original code (with tabs) hereto.</p>
<p>My original code is:</p>
<pre>
#!/bin/bash
if true ; then
    cat >> /tmp/heredoctestout <<-EOF
__tab__>#!/bin/bash
__tab__>if true ; then
__tab__>    echo Hello
__tab__>fi
__tab__>exit 0
__tab__>EOF
fi
echo wrote /tmp/heredoctestout
</pre>

<p>where '__tab__&gt;' denotes a tab.</p>
<p>So when someone also copy&amp;pastes the above code<br />
from here he will not get my original code (with tabs)<br />
but the automatically replaced stuff with all spaces.</p>
<p>Simply put:<br />
Tabs for indentation just do not work reliably in practice<br />
which is - from my point of view - the reason behind<br />
why tabs for indentation are not in compliance with<br />
<a href="https://github.com/rear/rear/wiki/Coding-Style">https://github.com/rear/rear/wiki/Coding-Style</a></p>
<p>Furthermore:<br />
Tabs for indentation prohibit we ever coud get rich:<br />
<a href="https://stackoverflow.blog/2017/06/15/developers-use-spaces-make-money-use-tabs/">https://stackoverflow.blog/2017/06/15/developers-use-spaces-make-money-use-tabs/</a></p>
<p>Regarding &lt;&lt;'EOF':<br />
In this case I think &lt;&lt;'EOF' to prevent<br />
variable replacements in here documents<br />
cannot be used because we need both:<br />
Some variables need to be evaluated (e.g. $fstype $uuid $device)<br />
but others must not be evaluated (e.g. \$new_uuid \$SED_SCRIPT).</p>
<h4 id="schlomo_commented_at_2017-09-01_1032"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/1463#issuecomment-326548150">2017-09-01 10:32</a>:<a class="headerlink" href="#schlomo_commented_at_2017-09-01_1032" title="Permanent link">&para;</a></h4>
<p>@jsmeix yes, I am actually very upset about Bash only supporting TABs
for <code>&lt;&lt;-EOF</code>, I think that this is a very very outdated approach.</p>
<p>However, this still doesn't convince me that indentation is more
important than keeping it simple and avoiding double quoting which I
find extremely error prone.</p>
<p>The need to have some variables replaced now while writing the script
fragment while protecting (quoting) other variables shows to me that
this code doesn't have a good separation of concerns. Hence my
suggestion to use functions and passing all required variables as
arguments to the functions. This approach provides a very good
separation of concerns and makes it very simple to test the code that is
generated.</p>
<p>But again, please you guys decide. I don't have time to rework this code
now so that those who write also decide.</p>
<h4 id="jsmeix_commented_at_2017-09-01_1033"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1463#issuecomment-326548234">2017-09-01 10:33</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-09-01_1033" title="Permanent link">&para;</a></h4>
<p>@schlomo<br />
I agree that the double quoting hell with</p>
<pre>
  echo "...\"...\"..."
</pre>

<p>is ugly and bad but I also find here documents ugly and bad<br />
so that there is a dilemma.</p>
<h4 id="jsmeix_commented_at_2017-09-01_1046"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1463#issuecomment-326550411">2017-09-01 10:46</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-09-01_1046" title="Permanent link">&para;</a></h4>
<p>@schlomo<br />
"since ever" I have a very general question about<br />
the generated code in $LAYOUT_CODE (i.e. diskrestore.sh):</p>
<p>Do you know the reason behind why "rear recover"<br />
has this "another level of indirection" (cf. RFC 1925 item 6a)<br />
by doing the disk layout recreation indirectly<br />
via generating diskrestore.sh that is then run.</p>
<p>That indirection via generating diskrestore.sh<br />
has often caused some confusion in my mind<br />
and I always need to think complicated when<br />
implementing code for disk layout recreation.</p>
<p>Why is the disk layout recreation not done<br />
as anything else during "rear recover"<br />
by directly running the commands (e.g. parted, mkfs, mount)<br />
from ReaR scripts - e.g. in the same way as the bootloader<br />
is directly reinstalled via a 620_install_grub2.sh script ?</p>
<h4 id="schlomo_commented_at_2017-09-01_1049"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/1463#issuecomment-326551059">2017-09-01 10:49</a>:<a class="headerlink" href="#schlomo_commented_at_2017-09-01_1049" title="Permanent link">&para;</a></h4>
<p>I would order the different values like this:</p>
<ul>
<li>readability in the sense of seeing at a glance what is going on.
    This is mostly about using forward logic, self explanatory variable
    names, no complex nested expressions or nested quoting, relative
    indentation</li>
<li>testability - it should be easy to copy &amp; paste a piece of code into
    a (ReaR) shell to try it out</li>
<li>testability - it should be easy to write a unit test for a piece of
    code, this is mostly about good separation of concerns</li>
<li>readability in the sense of beauty</li>
</ul>
<p>That is why for me a here document is the lesser evil. It creates a
complete block of code that might have a different indentation. If you
want you can also indent the code within the here document as it fits
the surrounding code. The only downside is that the generated code is
more indented than needed. Again, I find both to be the lesser evil as
long as the <strong>relative</strong> indentation within a code block is correct. If
different code blocks (e.g. before here document, the here document,
after the here document) have different indentations then I accept that
as a shortcoming of Bash.</p>
<p>BTW,
<a href="https://stackoverflow.com/a/41154835">https://stackoverflow.com/a/41154835</a>
shows a nice hack how to pretty-print Bash code. It is similar to my
suggestion to declare functions instead of here documents.</p>
<p>So, can you please let us know why you dislike here documents? Is this
mostly personal taste or do you also have other arguments against here
documents?</p>
<h4 id="schlomo_commented_at_2017-09-01_1101"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/1463#issuecomment-326552957">2017-09-01 11:01</a>:<a class="headerlink" href="#schlomo_commented_at_2017-09-01_1101" title="Permanent link">&para;</a></h4>
<p>@jsmeix ðŸ˜ƒ you ask the right question and in the end only @dagwieers and
@jhoekx can answer that. You should know the history: We had a <em>static</em>
version of that stuff before (which I wrote) which was becoming more and
more impossible to extend with new feature wishes. It was very obvious
back then that we won't be able to accommodate all required features
with that static approach.</p>
<p>I never particularly liked the code as it is but I am <strong>extremely</strong>
thankful to the authors for bringing ReaR to the next level through this
code. IIRC the main objective of this design was to be <strong>very flexible</strong>
and to give the user a <strong>review</strong> before doing the job.</p>
<p>I'll be very happy if we can evolve the code to be better to read and
better to maintain. Maybe an approach could be to create a function for
every type of line in the <code>disklayout.conf</code> and then to reduce the
<code>diskrestore.sh</code> to be a list of function calls with arguments.</p>
<h4 id="jsmeix_commented_at_2017-09-01_1120"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1463#issuecomment-326556143">2017-09-01 11:20</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-09-01_1120" title="Permanent link">&para;</a></h4>
<p>@schlomo<br />
no - I do not really know the history of that time - because<br />
at that time I was not yet involved in upstream ReaR development.<br />
I only know the old 'dr' workflow was replaced by the new 'layout'<br />
workflow but I do not know what reasons behind had led to the<br />
new 'layout' workflow design.</p>
<h4 id="schlomo_commented_at_2017-09-01_1220"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/1463#issuecomment-326566146">2017-09-01 12:20</a>:<a class="headerlink" href="#schlomo_commented_at_2017-09-01_1220" title="Permanent link">&para;</a></h4>
<p>The new layout workflows were introduced to solve the requirements that
@dagwieers and @jhoekx were hired to solve.</p>
<p>What do you think about the idea to introduce functions that encapsulate
a topic instead of generating scripts?</p>
<h4 id="jsmeix_commented_at_2017-09-01_1231"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1463#issuecomment-326568138">2017-09-01 12:31</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-09-01_1231" title="Permanent link">&para;</a></h4>
<p>@schlomo<br />
currently I do not yet know if functions instead of<br />
directly output code is better:<br />
On first glance I fear introducing functions to encapsulate<br />
something could be "another level of indirection".<br />
On the other hand introducing functions is helpful to avoid<br />
multiple code places that implement the same thing.<br />
Furthermore if diskrestore.sh would be a list of function calls<br />
with arguments it could make its intent that the user can<br />
directly edit the commands in diskrestore.sh more<br />
complicated for the user (because of the indirection<br />
via functions instead of the pure commands).<br />
I think I have to meditate on it... ;-)</p>
<h4 id="schlomo_commented_at_2017-09-01_1234"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/1463#issuecomment-326568635">2017-09-01 12:34</a>:<a class="headerlink" href="#schlomo_commented_at_2017-09-01_1234" title="Permanent link">&para;</a></h4>
<p>@jsmeix the indirection of functions comes to <strong>replace</strong> the
indirection caused by the script generation (either as here document or
as lots of echo lines with double quoting).</p>
<p>If the functions are properly tested then I would hope that nobody would
have to change the implementation of a function during disaster
recovery. Showing only the abstraction of the function calls will
actually enable much more people to change stuff that seems wrong
without fearing to mess up everything. For example remove a UUID
parameter or something like this.</p>
<h4 id="jsmeix_commented_at_2017-09-01_1331"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1463#issuecomment-326580648">2017-09-01 13:31</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-09-01_1331" title="Permanent link">&para;</a></h4>
<p>@schlomo<br />
but shouldn't the disklayout.conf file already provide<br />
such an abstraction of the low level details?<br />
I mean:<br />
Wouldn't then those functions in diskrestore.sh<br />
basically contain the values from disklayout.conf<br />
as function parameters?</p>
<p>If yes, then diskrestore.sh would contain basically<br />
the same information as disklayout.conf<br />
so that diskrestore.sh would have no longer<br />
an actual purpose.</p>
<p>In the end instead of the indirection via functions in diskrestore.sh<br />
those reliably working functions (where nobody would have<br />
to change their implementation during a disaster recovery)<br />
could as well be called directly by scripts that run<br />
during "rear recover".</p>
<p>Simply put:<br />
Why an editable diskrestore.sh if all what the user is meant<br />
to change during a disaster recovery are values like the<br />
ones that are currently in disklayout.conf?</p>
<p>Or in other words:<br />
I would much more prefer to enhance the syntax<br />
of the disklayout.conf entries to make it much more obvious<br />
and easier for the user to change that instead of the<br />
low level code in diskrestore.sh.</p>
<p>Then a disaster recovery with issues that need to be solved<br />
could happen like</p>
<pre>
# rear recover
Error foo

# vi disklayout.conf

# rear recover
Error bar

# vi disklayout.conf

# rear recover
[success]
</pre>

<h4 id="schlomo_commented_at_2017-09-01_1334"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/1463#issuecomment-326581251">2017-09-01 13:34</a>:<a class="headerlink" href="#schlomo_commented_at_2017-09-01_1334" title="Permanent link">&para;</a></h4>
<p>Yes, I agree with you. Maybe it is just a question of improving the
quality to remove the need for manually adjusting the diskrestore.sh.
Seems like a worthwhile goal.</p>
<h4 id="jsmeix_commented_at_2017-09-01_1334"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1463#issuecomment-326581293">2017-09-01 13:34</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-09-01_1334" title="Permanent link">&para;</a></h4>
<p>@schabrolles<br />
just ignore @schlomo and @jsmeix conversation here<br />
(we terribly misuse your pull request here)<br />
and just merge it to have a nice weekend!</p>
<h4 id="jsmeix_commented_at_2017-09-01_1344"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1463#issuecomment-326583746">2017-09-01 13:44</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-09-01_1344" title="Permanent link">&para;</a></h4>
<p>@schlomo<br />
I think I have a plan how we can move<br />
towards that goal step by step:</p>
<p>We can keep the diskrestore.sh code generation<br />
in all its ugliness as is (provided it works).</p>
<p>We only need to to enhance the syntax of disklayout.conf<br />
to make it much more obvious and easier for the user<br />
to change that - plus:</p>
<p>We need to ensure that "rear recover" also works<br />
on an already partially recovered system<br />
(i.e. after a previous "rear recover" had failed).</p>
<p>For the latter I hope adding an early "cleanupdisk" script<br />
<a href="https://github.com/rear/rear/issues/799">https://github.com/rear/rear/issues/799</a><br />
is all what is needed because when such a "cleanupdisk" script<br />
completely wipes the disk a second "rear recover" gets again<br />
the same clean empty disk as the first "rear recover" had.</p>
<h4 id="schlomo_commented_at_2017-09-01_1346"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/1463#issuecomment-326584076">2017-09-01 13:46</a>:<a class="headerlink" href="#schlomo_commented_at_2017-09-01_1346" title="Permanent link">&para;</a></h4>
<p>Yes, that sounds good. In any case, we can start from converting a
single topic to a function and see how that behaves. No need to change
everything at once. Dumped functions and generated bash code are
compatible ðŸ˜„</p>
<h4 id="jsmeix_commented_at_2017-09-01_1359"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1463#issuecomment-326587649">2017-09-01 13:59</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-09-01_1359" title="Permanent link">&para;</a></h4>
<p>@schlomo<br />
"since ages" I have the plan to enhance the disklayout.conf<br />
entries for disks and partitions to that not only byte values<br />
but also MiB or GiB units are supported and perhaps<br />
even more advanced units like e.g. '8MiB' as currently<br />
in USB_PARTITION_ALIGN_BLOCK_SIZE.<br />
By the way:<br />
Because older parted on SLE11 does not support MiB or GiB<br />
(only MB and GB according to "man parted) I would convert<br />
any values from disklayout.conf into byte values for the pated calls<br />
in diskrestore.sh to be on the safe side (which nicely shows<br />
that the low-level stuff may even have to be kept ugly).</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2025 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2017-08-30.1463.pr.merged.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/rear/rear-user-guide" class="fa fa-code-fork" style="color: #fcfcfc"> rear/rear-user-guide</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
