<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>2021 06 05.2626.pr.merged - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "2021 06 05.2626.pr.merged";
        var mkdocs_page_input_path = "issues/2021-06-05.2626.pr.merged.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/rust.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', '366986045', 'auto');
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a> &raquo;</li>
      <li>2021 06 05.2626.pr.merged</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="2626_pr_merged_stop_rear_from_overwriting_its_own_disk_and_backup_drives"><a href="https://github.com/rear/rear/pull/2626">#2626 PR</a> <code>merged</code>: Stop ReaR from overwriting its own disk and backup drives<a class="headerlink" href="#2626_pr_merged_stop_rear_from_overwriting_its_own_disk_and_backup_drives" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>enhancement</code>, <code>fixed / solved / done</code>,
<code>critical / security / legal</code>, <code>severe improvement</code></p>
<h4 id="olivero2_opened_issue_at_2021-06-05_1254"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> opened issue at <a href="https://github.com/rear/rear/pull/2626">2021-06-05 12:54</a>:<a class="headerlink" href="#olivero2_opened_issue_at_2021-06-05_1254" title="Permanent link">&para;</a></h4>
<h3 id="use_cases">Use Cases<a class="headerlink" href="#use_cases" title="Permanent link">&para;</a></h3>
<ol>
<li>
<p>I start <code>rear recover</code> on a virtual machine. The original system has
    three drives (<code>sda</code>, <code>sdb</code>, <code>sdc</code>), the recovery VM has two drives
    (<code>vda</code>, <code>vdb</code>), plus the recovery partition on another drive
    (<code>vdc</code>). The intention is to leave <code>sdc</code> unmapped. ReaR asks
    remapping questions for <code>sda</code> and <code>sdb</code>. Then it decides to map
    <code>sdc</code> to <code>vdc</code> without even asking. Continuing would overwrite the
    recovery system. I have to edit <code>/var/lib/rear/layout/disk_mappings</code>
    manually.</p>
</li>
<li>
<p>I start <code>rear recover</code> on a virtual machine, with a USB backup drive
    connected as <code>/dev/sda</code>. The original system's boot drive was also
    <code>/dev/sda</code>. ReaR asks remapping questions, but I do not notice that
    the <code>/dev/sdaX</code> partitions on the VM are actually those of the
    backup drive, while the VM boot drive would have been <code>/dev/vdaX</code>.
    ReaR happily overwrites the backup drive. This should never be
    possible.</p>
</li>
</ol>
<h3 id="background">Background<a class="headerlink" href="#background" title="Permanent link">&para;</a></h3>
<ul>
<li>Overwriting a ReaR rescue system partition is currently possible if
    it resides on a writable disk device (physical or virtual). This
    applies to the <code>RAWDISK</code> and <code>USB</code> output methods.</li>
<li>Accidentally overwriting backup devices is currently possible in any
    ReaR configuration.</li>
<li>Related issue: #1271.</li>
</ul>
<h3 id="solution">Solution<a class="headerlink" href="#solution" title="Permanent link">&para;</a></h3>
<ul>
<li>This PR protects against accidentally overwriting a rescue system
    partition by keeping track of its partition ID. The capability is
    automatically enabled for the <code>RAWDISK</code> and <code>USB</code> output methods. No
    configuration is necessary.</li>
<li>
<p>To allow for additional user-configurable protection of devices,
    this PR introduces the following configuration section:
        ##
        # Designate target disk devices or partitions as write-protected to avoid being accidentally overwritten during
        # "rear recover"
        #
        # List of partition table UUIDs, which designate write-protected disk devices. ReaR's own disk device will be
        # automatically added to this list if necessary.
        # Example: WRITE_PROTECTED_PARTITION_TABLE_UUIDS+=("ecacbce4-e05e-4eb9-835c-ade0c3ed0fea")
        WRITE_PROTECTED_PARTITION_TABLE_UUIDS=()
        # List of (shell glob) patterns, which designate matching file system labels as write-protected partitions.
        # Entries may be quoted and contain blanks, but they may not contain single quotes themselves.
        # Example: WRITE_PROTECTED_FILE_SYSTEM_LABEL_PATTERNS+=("Backup *")
        WRITE_PROTECTED_FILE_SYSTEM_LABEL_PATTERNS=()</p>
</li>
<li>
<p>Disks designated as write protected or containing a partition
    designated as write protected will not be used as recovery targets
    by ReaR, whether in <code>MIGRATION_MODE</code> or not.</p>
</li>
</ul>
<h3 id="testing">Testing<a class="headerlink" href="#testing" title="Permanent link">&para;</a></h3>
<ul>
<li>I have tested complete <code>rear mkrescue</code> and <code>rear recover</code> cycles for
    <code>RAWDISK</code> output in various configurations on Ubuntu 20.04.</li>
<li>I have not tested <code>USB</code> output, as I find it too baroque to use.
    However, the added code for <code>USB</code> is simple and should just work.</li>
</ul>
<h3 id="compatibility">Compatibility<a class="headerlink" href="#compatibility" title="Permanent link">&para;</a></h3>
<p>This PR uses command invocations and options which are present in
existing ReaR code with the following exception:</p>
<ul>
<li><code>RAWDISK</code> output invokes <code>sgdisk</code> with the <code>--disk-guid</code> option.
    This has been present in <code>sgdisk</code> <a href="https://github.com/samangh/gptfdisk/blame/81c8bbee46ad6ebacf72eae70ba5147f376205a4/gptcl.cc">since release 0.8.0
    (September 2011) at
    least</a>.</li>
</ul>
<h3 id="note">Note<a class="headerlink" href="#note" title="Permanent link">&para;</a></h3>
<p>In migration mode, ReaR asks to remap disks until there is only one
left. Then it maps the last drive without asking. The comment states:</p>
<blockquote>
<p>Automatically map when only one appropriate current block device is
found where to it could be mapped. At the end the mapping file is
shown and the user can edit it if he does not like an automated
mapping</p>
</blockquote>
<p>Here, ReaR takes away control from the user (or at least makes it more
complicated that it needs to be). I think this should change (but
separately from this PR) as it does not conform to ReaR's principle.</p>
<h4 id="jsmeix_commented_at_2021-06-08_1157"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2626#issuecomment-856700823">2021-06-08 11:57</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-06-08_1157" title="Permanent link">&para;</a></h4>
<p>E.g. <code>lsblk --output PTUUID --noheadings --nodeps /dev/sda</code><br />
works with <code>lsblk</code> in util-linux 2.33.2 in SLES12<br />
but not with <code>lsblk</code> in util-linux 2.19.1 in SLES11<br />
The available columns for <code>lsblk</code> in util-linux 2.19.1 in SLES11:</p>
<pre><code># lsblk --help

Usage:
 lsblk [options] [&lt;device&gt; ...]

Options:
 -a, --all            print all devices
 -b, --bytes          print SIZE in bytes rather than in human readable format
 -d, --nodeps         don't print slaves or holders
 -e, --exclude &lt;list&gt; exclude devices by major number (default: RAM disks)
 -f, --fs             output info about filesystems
 -h, --help           usage information (this)
 -i, --ascii          use ascii characters only
 -m, --perms          output info about permissions
 -l, --list           use list format ouput
 -n, --noheadings     don't print headings
 -o, --output &lt;list&gt;  output columns
 -r, --raw            use raw format output
 -t, --topology       output info about topology

Available columns:
       NAME  device name
      KNAME  internel kernel device name
    MAJ:MIN  major:minor device number
     FSTYPE  filesystem type
 MOUNTPOINT  where the device is mounted
      LABEL  filesystem LABEL
       UUID  filesystem UUID
         RO  read-only device
         RM  removable device
      MODEL  device identifier
       SIZE  size of the device
      OWNER  user name
      GROUP  group name
       MODE  device node permissions
  ALIGNMENT  alignment offset
     MIN-IO  minimum I/O size
     OPT-IO  optimal I/O size
    PHY-SEC  physical sector size
    LOG-SEC  logical sector size
       ROTA  rotational device
      SCHED  I/O scheduler name
</code></pre>
<p>SLES10 seems to have no <code>lsblk</code> at all.</p>
<h4 id="jsmeix_commented_at_2021-06-08_1218"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2626#issuecomment-856715447">2021-06-08 12:18</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-06-08_1218" title="Permanent link">&para;</a></h4>
<p>@OliverO2<br />
you wrote</p>
<pre><code>ReaR takes away control from the user ...
I think this should change ... as it does not conform to ReaR's principle.
</code></pre>
<p>Huh?</p>
<p>Since I know ReaR it does take away control from the user at so many
places<br />
so basically it is ReaR's normal behaviour to take away control from the
user<br />
and do things automatically and silently.<br />
I tried to improve things according to my "final power to the user"
principle<br />
at several places where I was most hit by ReaR's silent automatisms<br />
but overall ReaR still takes away control from the user at many places.</p>
<h4 id="jsmeix_commented_at_2021-06-08_1223"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2626#issuecomment-856719420">2021-06-08 12:23</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-06-08_1223" title="Permanent link">&para;</a></h4>
<p>@OliverO2<br />
thank you so much for that enhancement to avoid severe loss of data!</p>
<p>I try to have a closer look as time permits but possibly it gets delayed
until next week.</p>
<p>@gdha @rmetrich @pcahyna and all @rear/contributors<br />
I would much appreciate it if you find some time and have a look here.<br />
Perhaps you could spot this or that issue by plain looking at the code?</p>
<h4 id="olivero2_commented_at_2021-06-08_1245"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/pull/2626#issuecomment-856734533">2021-06-08 12:45</a>:<a class="headerlink" href="#olivero2_commented_at_2021-06-08_1245" title="Permanent link">&para;</a></h4>
<p>@jsmeix You wrote:</p>
<blockquote>
<p>but overall ReaR still takes away control from the user at many
places.</p>
</blockquote>
<p>You think it's a good idea here?</p>
<h4 id="gdha_commented_at_2021-06-11_0728"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/pull/2626#issuecomment-859348674">2021-06-11 07:28</a>:<a class="headerlink" href="#gdha_commented_at_2021-06-11_0728" title="Permanent link">&para;</a></h4>
<p>@OliverO2 @jsmeix A side note about control to the end-user: most
end-users maybe read the man page, and probably don't look at the
default.conf file. Do you think end-users look at the log files? The
answer is probably most don't.<br />
It is normal that ReaR with all its plug-ins becomes a bit complex to
maintain and do good for everybody. Perhaps we should perform a grand
cleanup and remove unused ones?<br />
My point of view is - only a recover exercise is the most useful one and
like most end-users don't look at the log files ;-) anymore as I know it
just works for my use-cases.<br />
PS: we have a log-file scraper to find errors and which reports it (for
the many systems we maintain).</p>
<h4 id="gdha_commented_at_2021-08-20_1438"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/pull/2626#issuecomment-902738795">2021-08-20 14:38</a>:<a class="headerlink" href="#gdha_commented_at_2021-08-20_1438" title="Permanent link">&para;</a></h4>
<p>@jsmeix This PR is still worthwhile to merge into our master code, no?</p>
<h4 id="jsmeix_commented_at_2021-08-31_1220"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2626#issuecomment-909185275">2021-08-31 12:20</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-08-31_1220" title="Permanent link">&para;</a></h4>
<p>My
<a href="https://github.com/rear/rear/pull/2626#issuecomment-856719420">https://github.com/rear/rear/pull/2626#issuecomment-856719420</a><br />
was very overoptimistic :-(</p>
<p>I will have a closer look as time permits<br />
but I did not find sufficient time for a closer look<br />
and because I am back from vacation right now<br />
I probably don't find sufficient time for a closer look soon...</p>
<h4 id="jsmeix_commented_at_2021-10-22_0735"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2626#issuecomment-949366653">2021-10-22 07:35</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-10-22_0735" title="Permanent link">&para;</a></h4>
<p>We should not release ReaR 2.7 without having this included.</p>
<h4 id="jsmeix_commented_at_2021-10-22_0739"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2626#issuecomment-949369428">2021-10-22 07:39</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-10-22_0739" title="Permanent link">&para;</a></h4>
<p>I think (more precisely "I hope") after end of October (i.e. in
November)<br />
I will have time to have a closer look here - in particular to test it.</p>
<h4 id="jsmeix_commented_at_2021-10-25_1333"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2626#issuecomment-950935246">2021-10-25 13:33</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-10-25_1333" title="Permanent link">&para;</a></h4>
<p>I tested it on two VMs with those GPT disks</p>
<pre><code>original system            replacement system
sda 8 GiB system disk      sda the 8 GiB ReaR "USB" disk from the original system
sdb 8 GiB ReaR "USB" disk  sdb 9 GiB replacement system disk
</code></pre>
<p>I use this etc/rear/local.conf</p>
<pre><code>FIRMWARE_FILES=( 'no' )
MODULES=( 'loaded_modules' )
PROGRESS_MODE="plain"
PROGRESS_WAIT_SECONDS="3"
SSH_ROOT_PASSWORD="rear"
OUTPUT=USB
USB_DEVICE_FILESYSTEM_PERCENTAGE=90
USB_DEVICE_FILESYSTEM_LABEL="MY-DATA"
USB_BOOT_PART_SIZE=1024
USB_BOOTLOADER="grub"
USB_DEVICE_BOOT_LABEL="MY-BOOT"
OUTPUT_URL=usb:///dev/disk/by-label/MY-BOOT
USB_DEVICE_PARTED_LABEL=gpt
BACKUP=NETFS
BACKUP_URL=usb:///dev/disk/by-label/MY-DATA
</code></pre>
<p>Making ReaR "USB" disk:</p>
<pre><code># usr/sbin/rear -D format /dev/sdb
...
Repartitioning /dev/sdb
Creating partition table of type gpt on /dev/sdb
Creating BIOS boot partition /dev/sdb1
Setting 'bios_grub' flag on BIOS boot partition /dev/sdb1
Creating boot partition /dev/sdb2 with size 1024 MiB aligned at 8 MiB
Setting 'legacy_boot' flag on boot partition /dev/sdb2
Creating ReaR data partition /dev/sdb3 up to 90% of /dev/sdb
Creating ext2 filesystem with label 'MY-BOOT' on boot partition /dev/sdb2
Creating ext3 filesystem with label 'MY-DATA' on ReaR data partition /dev/sdb3
Adjusting filesystem parameters on ReaR data partition /dev/sdb3
Exiting rear format (PID 1554) and its descendant processes ...
</code></pre>
<p>The disks on the original system</p>
<pre><code># lsblk -bipo NAME,TRAN,TYPE,FSTYPE,SIZE,LABEL,MOUNTPOINT
NAME        TRAN TYPE FSTYPE       SIZE LABEL   MOUNTPOINT
/dev/sda    ata  disk        8589934592         
|-/dev/sda1      part           8388608         
`-/dev/sda2      part ext4   8580480512         /
/dev/sdb    ata  disk        8589934592         
|-/dev/sdb1      part           8364032         
|-/dev/sdb2      part ext2   1073741824 MY-BOOT 
`-/dev/sdb3      part ext3   6649020416 MY-DATA 
/dev/sr0    ata  rom         1073741312
</code></pre>
<p>"rear -D mkbackup"</p>
<pre><code># usr/sbin/rear -D mkbackup
...
Using build area: /var/tmp/rear.2ixQyBC3meCS35r
...

# grep WRITE_PROTECTED_ /var/tmp/rear.2ixQyBC3meCS35r/rootfs/etc/rear/rescue.conf
WRITE_PROTECTED_PARTITION_TABLE_UUIDS=( efee5e95-40a0-4a8e-bbe1-1cad7c0d255d )
WRITE_PROTECTED_FILE_SYSTEM_LABEL_PATTERNS=( )

# egrep -i 'write_protect|PTUUID' var/log/rear/rear-localhost.log
2021-10-25 14:17:43.434571282 Including prep/USB/default/480_initialize_write_protect_settings.sh
+ source /root/rear.github.OliverO2.stop-overwriting-backups/usr/share/rear/prep/USB/default/480_initialize_write_protect_settings.sh
++ WRITE_PROTECTED_PARTITION_TABLE_UUIDS+=($(lsblk --output PTUUID --noheadings --nodeps "$USB_DEVICE"))
+++ lsblk --output PTUUID --noheadings --nodeps /dev/disk/by-label/MY-DATA
2021-10-25 14:17:43.455119727 Including prep/default/490_store_write_protect_settings.sh
+ source /root/rear.github.OliverO2.stop-overwriting-backups/usr/share/rear/prep/default/490_store_write_protect_settings.sh
++ echo '# The following lines were added by 490_store_write_protect_settings.sh'
++ echo 'WRITE_PROTECTED_PARTITION_TABLE_UUIDS=( efee5e95-40a0-4a8e-bbe1-1cad7c0d255d )'
++ echo -n 'WRITE_PROTECTED_FILE_SYSTEM_LABEL_PATTERNS=('

# lsblk --output NAME,LABEL,UUID,PTUUID,PARTUUID,PARTLABEL /dev/sdb
NAME   LABEL   UUID                                 PTUUID                               PARTUUID                             PARTLABEL
sdb                                                 efee5e95-40a0-4a8e-bbe1-1cad7c0d255d                                      
├─sdb1                                              efee5e95-40a0-4a8e-bbe1-1cad7c0d255d aa3d3f8b-3adb-4ef8-a4c0-0e44cdadfff6 primary
├─sdb2 MY-BOOT ff15e0f1-b4bb-4a02-bb10-1502ec2fe0be efee5e95-40a0-4a8e-bbe1-1cad7c0d255d 281246c5-d29f-4ed2-8cfb-c7404eca010d primary
└─sdb3 MY-DATA 8bd9f9e8-9043-4a80-84e1-64d417244529 efee5e95-40a0-4a8e-bbe1-1cad7c0d255d e38c933c-d18f-4821-92c9-c99673738660 primary
</code></pre>
<p>"rear -D recover"<br />
All user dialogs were accepted with the default (i.e. just proceed):</p>
<pre><code># rear -D recover
...
Comparing disks
Device sda is designated as write-protected (needs manual configuration)
Switching to manual disk layout configuration
Cannot use /dev/sda (same name and same size) for recreating /dev/sda (/dev/sda is write-protected)
Cannot use /dev/sda (same size) for recreating /dev/sda (/dev/sda is write-protected)
Could not automap /dev/sda (no disk with same size 8589934592 found)
Original disk /dev/sda does not exist (with same size) in the target system
Using /dev/sdb (the only appropriate) for recreating /dev/sda
Current disk mapping table (source =&gt; target):
  /dev/sda =&gt; /dev/sdb
...
Start system layout restoration.
Disk '/dev/sdb': creating 'gpt' partition table
Disk '/dev/sdb': creating partition number 1 with name ''sdb1''
Disk '/dev/sdb': creating partition number 2 with name ''sdb2''
Creating filesystem of type ext4 with mount point / on /dev/sdb2.
Mounting filesystem /
Disk layout created.
...
Backup restore program 'tar' started in subshell (PID=3483)
Restored 155 MiB [avg. 53170 KiB/sec] 
...
Restored 2482 MiB [avg. 28249 KiB/sec] 
OK
...
Running mkinitrd...
Recreated initrd (/sbin/mkinitrd).
Installing GRUB2 boot loader...
Determining where to install GRUB2 (no GRUB2_INSTALL_DEVICES specified)
Found possible boot disk /dev/sdb - installing GRUB2 there
</code></pre>
<p>After "rear recover" the disks in the still running Rear recovery
system:</p>
<pre><code># lsblk --output NAME,LABEL,UUID,PTUUID,PARTUUID,PARTLABEL /dev/sda
NAME   LABEL   UUID                                 PTUUID                               PARTUUID                             PARTLABEL
sda                                                 efee5e95-40a0-4a8e-bbe1-1cad7c0d255d                                      
|-sda1                                              efee5e95-40a0-4a8e-bbe1-1cad7c0d255d aa3d3f8b-3adb-4ef8-a4c0-0e44cdadfff6 primary
|-sda2 MY-BOOT ff15e0f1-b4bb-4a02-bb10-1502ec2fe0be efee5e95-40a0-4a8e-bbe1-1cad7c0d255d 281246c5-d29f-4ed2-8cfb-c7404eca010d primary
`-sda3 MY-DATA 8bd9f9e8-9043-4a80-84e1-64d417244529 efee5e95-40a0-4a8e-bbe1-1cad7c0d255d e38c933c-d18f-4821-92c9-c99673738660 primary

# lsblk --output NAME,LABEL,UUID,PTUUID,PARTUUID,PARTLABEL /dev/sdb
NAME   LABEL UUID                                 PTUUID                               PARTUUID                             PARTLABEL
sdb                                               258d559c-1206-43f9-871f-c9e2176c2fa6                                      
|-sdb1                                            258d559c-1206-43f9-871f-c9e2176c2fa6 5c9604e7-f0c6-43f2-bee0-96810abb6b79 sdb1
`-sdb2       83a3f413-6e7d-4591-bd60-c87803613166 258d559c-1206-43f9-871f-c9e2176c2fa6 01dd5ee2-1f33-4f04-8e15-1cefead42437 sdb2
</code></pre>
<p>The recreated system boots well from sdb and seems to work OK.</p>
<h4 id="jsmeix_commented_at_2021-10-25_1336"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2626#issuecomment-950937462">2021-10-25 13:36</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-10-25_1336" title="Permanent link">&para;</a></h4>
<p>@rear/contributors<br />
I would like to merge it tomorrow afternoon as is<br />
unless there are objections.</p>
<h4 id="jsmeix_commented_at_2021-10-25_1354"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2626#issuecomment-950953826">2021-10-25 13:54</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-10-25_1354" title="Permanent link">&para;</a></h4>
<p>I am thinking about to enhance it after it was merged so that<br />
the 480_initialize_write_protect_settings.sh scripts also
initialize<br />
WRITE_PROTECTED_FILE_SYSTEM_LABEL_PATTERNS.</p>
<p>Additionally I am thinking about to rename the specific<br />
WRITE_PROTECTED_PARTITION_TABLE_UUIDS<br />
into a generic WRITE_PROTECTED_UUIDS<br />
and let in particular
USB/default/480_initialize_write_protect_settings.sh<br />
add all UUIDs that exist on $USB_DEVICE to WRITE_PROTECTED_UUIDS</p>
<p>I think it cannot cause harm to remember too many UUIDs<br />
from a disk that must be sacrosanct during "rear recover"<br />
because UUIDs are sufficiently universally/globally unique<br />
so that collisions are so unlikely that they can be ignored.<br />
And even if a collision happens the user can edit his<br />
WRITE_PROTECTED_UUIDS in etc/rear/rescue.conf</p>
<p>The reason behind why I like to not only rely on partition table UUIDs
is that<br />
<a href="https://unix.stackexchange.com/questions/375548/what-is-uuid-partuuid-and-ptuuid">https://unix.stackexchange.com/questions/375548/what-is-uuid-partuuid-and-ptuuid</a><br />
reads (excerpt)</p>
<pre><code>UUID is a filesystem-level UUID, which is retrieved
from the filesystem metadata inside the partition.
It can only be read if the filesystem type is known and readable.

PARTUUID is a partition-table-level UUID for the partition,
a standard feature for all partitions on GPT-partitioned disks.
Since it is retrieved from the partition table, it is accessible
without making any assumptions at all about the actual
contents of the partition. If the partition is encrypted
using some unknown encryption method, this might be
the only accessible unique identifier for that particular partition.

PTUUID is the UUID of the partition table itself,
a unique identifier for the entire disk assigned
at the time the disk was partitioned. It is the equivalent
of the disk signature on MBR-partitioned disks but with more bits
and a standardized procedure for its generation.

On MBR-partitioned disks, there are no UUIDs in the partition table.
The 32-bit disk signature is used in place of a PTUUID,
and PARTUUIDs are created by adding a dash and a
two-digit partition number to the end of the disk signature.
</code></pre>
<p>So PTUUID may only be available on GPT partitioned disks and<br />
I don't know if on all Linux systems the 32-bit MBR disk signature<br />
is used in place of a PTUUID.</p>
<h4 id="jsmeix_commented_at_2021-11-10_1246"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2626#issuecomment-965098754">2021-11-10 12:46</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-11-10_1246" title="Permanent link">&para;</a></h4>
<p>With
<a href="https://github.com/rear/rear/pull/2703">https://github.com/rear/rear/pull/2703</a>
merged</p>
<ul>
<li>WRITE_PROTECTED_FILE_SYSTEM_LABEL_PATTERNS<br />
    is shortened to WRITE_PROTECTED_FS_LABEL_PATTERNS</li>
<li>The specific WRITE_PROTECTED_PARTITION_TABLE_UUIDS<br />
    is replaced by WRITE_PROTECTED_IDS with generic functionality,<br />
    cf.
    <a href="https://github.com/rear/rear/pull/2626#issuecomment-950953826">https://github.com/rear/rear/pull/2626#issuecomment-950953826</a><br />
    together with the new WRITE_PROTECTED_ID_TYPES which<br />
    defaults to UUID PTUUID PARTUUID WWN so that the user can<br />
    specify different lsblk columns as needed in his particular
    environment<br />
    cf.
    <a href="https://github.com/rear/rear/pull/2703#issuecomment-962418441">https://github.com/rear/rear/pull/2703#issuecomment-962418441</a></li>
</ul>
<p>In etc/rear/local.conf <code>WRITE_PROTECTED_ID_TYPES="PTUUID"</code><br />
results basically the same behaviour as before this pull request<br />
where only PTUUID was used as ID,<br />
cf.
<a href="https://github.com/rear/rear/pull/2703#issuecomment-965088175">https://github.com/rear/rear/pull/2703#issuecomment-965088175</a></p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2022 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2021-06-05.2626.pr.merged.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
