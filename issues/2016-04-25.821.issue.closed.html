<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#821 Issue closed: ReaR + TSM: btrfs subvolumes excluded by default from restore - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#821 Issue closed: ReaR + TSM: btrfs subvolumes excluded by default from restore";
        var mkdocs_page_input_path = "issues/2016-04-25.821.issue.closed.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/backup_netfs.html">Example of BACKUP=NETFS</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear29.html">Release Notes ReaR 2.9</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear28.html">Release Notes ReaR 2.8</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#821 Issue closed: ReaR + TSM: btrfs subvolumes excluded by default from restore</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="821_issue_closed_rear_tsm_btrfs_subvolumes_excluded_by_default_from_restore"><a href="https://github.com/rear/rear/issues/821">#821 Issue</a> <code>closed</code>: ReaR + TSM: btrfs subvolumes excluded by default from restore<a class="headerlink" href="#821_issue_closed_rear_tsm_btrfs_subvolumes_excluded_by_default_from_restore" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>bug</code>, <code>documentation</code>, <code>fixed / solved / done</code></p>
<h4 id="pavoldomin_opened_issue_at_2016-04-25_1306"><img src="https://avatars.githubusercontent.com/u/1576908?v=4" width="50"><a href="https://github.com/pavoldomin">pavoldomin</a> opened issue at <a href="https://github.com/rear/rear/issues/821">2016-04-25 13:06</a>:<a class="headerlink" href="#pavoldomin_opened_issue_at_2016-04-25_1306" title="Permanent link">&para;</a></h4>
<ul>
<li>rear version (/usr/sbin/rear -V): 1.18</li>
<li>OS version (cat /etc/rear/os.conf or lsb_release -a): SLES11SP3</li>
<li>rear configuration files (cat /etc/rear/site.conf or cat
    /etc/rear/local.conf):</li>
</ul>
<!-- -->

<pre><code>OUTPUT=ISO
BACKUP=TSM
COPY_AS_IS_TSM=( /etc/adsm/TSM.PWD /opt/tivoli/tsm/client /usr/local/ibm/gsk8* )
COPY_AS_IS_EXCLUDE_TSM=( )
PROGS_TSM=( dsmc tput )
# where to copy the resulting files to and save them with TSM
TSM_RESULT_FILE_PATH=/opt/tivoli/tsm/rear
TSM_DSMC_RESTORE_OPTIONS=( )
TSM_RESTORE_PIT_DATE=
TSM_RESTORE_PIT_TIME=
# Should the result from mkrecover/backup saved via TSM
TSM_RESULT_SAVE=y

OUTPUT_PREFIX="backup"
BACKUP_OPTIONS="nfsvers=3,nolock"
BACKUP_URL=nfs://nfs_server/rear/tsm/$HOSTNAME
NETFS_KEEP_OLD_BACKUP_COPY=yes
BACKUP_PROG_INCLUDE=( '/var/lib/*' '/var/spool/*' '/var/log/*' '/var/run/*' '/srv/*' '/boot/grub2/x86_64-efi/*' '/opt/*' '/var/*' '/boot/grub2/i386-pc/*' '/boot/* /boot/efi/*' )
EXCLUDE_RECREATE=( "${EXCLUDE_RECREATE[@]}" "fs:/.snapshots" "fs:/var/crash" "fs:/var/run" "fs:/osbackup" "fs:/hana/osbackup" "fs:/origin" "fs:/origin_tmp" "fs:/backup"
...
</code></pre>
<ul>
<li>Brief description of the issue: TSM is not including automatically
    for btrfs subvolumes as those are excluded from the recreation, to
    prevent creating them as normal btrfs volumes (see 548965e).</li>
<li>Work-around: We need to manually include the auto-excluded
    subvolumes to the restore list, like</li>
</ul>
<!-- -->

<pre><code>The TSM Server reports the following for this node:
                  #     Last Incr Date          Type    File Space Name
                --------------------------------------------------------------------------------
                  1     23-04-2016 04:59:41     BTRFS   /
                  2     00-00-0   00:00:00     XFS     /backuptest
                  3     23-04-2016 04:59:42     EXT3    /boot
                  4     23-04-2016 04:59:42     VFAT    /boot/efi
...
                 17     23-04-2016 04:59:55     BTRFS   /var
Please enter the numbers of the filespaces we should restore.
Pay attention to enter the filesystems in the correct order
(like restore / before /var/log) !
(default: 1 3 4 5 6 7 11 12 13 15 16): [30 secs] 1 3 4 5 6 7 10 11 12 13 15 16 17
</code></pre>
<p>I do not have any smart suggestion how this can be 'fixed'. I just found
that <code>/var</code> was not restored by default by TSM on btrfs system. This may
well be also a TSM support for BTRFS is not perfect.</p>
<h4 id="gdha_commented_at_2016-04-26_0813"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/issues/821#issuecomment-214663416">2016-04-26 08:13</a>:<a class="headerlink" href="#gdha_commented_at_2016-04-26_0813" title="Permanent link">&para;</a></h4>
<p>@jsmeix Any idea how we can fore-come this (auto-excluding btrfs /var
subvolume)</p>
<h4 id="jsmeix_commented_at_2016-04-26_1203"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/821#issuecomment-214718138">2016-04-26 12:03</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-04-26_1203" title="Permanent link">&para;</a></h4>
<p>There is nothing at all what I could do regarding<br />
issues with third-party backup tools.</p>
<p>When the issue also hapens with 'tar'<br />
I will have a look.</p>
<p>@pavoldomin<br />
does the issue also happen with 'tar'?</p>
<p>As far as I understand the comments in default.conf<br />
and as far as I remember how it works with 'tar'<br />
items in EXCLUDE_RECREATE are added to EXCLUDE_BACKUP<br />
but items in BACKUP_PROG_INCLUDE take precedence over<br />
items in EXCLUDE_BACKUP so that in the end what is specified<br />
in BACKUP_PROG_INCLUDE gets included in the backup<br />
regardless of what is set in EXCLUDE_RECREATE.</p>
<h4 id="jsmeix_commented_at_2016-04-26_1350"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/821#issuecomment-214751329">2016-04-26 13:50</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-04-26_1350" title="Permanent link">&para;</a></h4>
<p>The issue (or at least a similar issue with same result)<br />
also happens with 'tar'.</p>
<p>With</p>
<pre>
BACKUP_PROG_INCLUDE=( '/var/spool/*' )
EXCLUDE_RECREATE=( "${EXCLUDE_RECREATE[@]}" 'fs:/var/spool' )
</pre>

<p>one gets the whole content of /var/spool/* in the backup.tar.gz<br />
(during "rear mkbackup")<br />
but<br />
one does not get the content of /var/spool/* restored<br />
(during "rear recover").</p>
<p>In 61_exclude_from_restore.sh the entries<br />
in EXCLUDE_RECREATE become added<br />
to the restore-exclude-list.txt file<br />
that is used for the 'tar' restore<br />
as --exclude-from=...restore-exclude-list.txt<br />
so that entries in BACKUP_PROG_INCLUDE<br />
do not get restored.</p>
<p>The fix with newer rear versions is easy:</p>
<p>With newer rear versions theer is no longer the need<br />
for entries in /etc/rear/local.conf like</p>
<pre>
EXCLUDE_RECREATE=( ... 'fs:/var/spool' ... )
</pre>

<p>to exclude them during component recreation.</p>
<p>Reason:</p>
<p>With newer rear versions btrfs subvolumes are not<br />
listed in disklayout.conf as</p>
<pre>
fs ...
</pre>

<p>components (as it was during my initial btrfs support implementation)<br />
but now via well separated components as</p>
<pre>
btrfsdefaultsubvol ...
btrfssnapshotsubvol ...
btrfsnormalsubvol ...
btrfsmountedsubvol ...
btrfsnocopyonwrite ...
</pre>

<p>so that in /etc/rear/local.conf entries like</p>
<pre>
EXCLUDE_RECREATE=( ... 'fs:/var/spool' ... )
</pre>

<p>do not match anything during component recreation<br />
but still match during backup restore.</p>
<p>I tested on SLES12-SP1 with default btrfs subvolumes<br />
that without entries in /etc/rear/local.conf like</p>
<pre>
EXCLUDE_RECREATE=( ... 'fs:/var/spool' ... )
</pre>

<p>I do get the whole content of /var/spool/* restored<br />
from the backup.</p>
<p>@pavoldomin<br />
please test if it also works for you this way with TSM.</p>
<h4 id="jsmeix_commented_at_2016-04-26_1352"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/821#issuecomment-214752081">2016-04-26 13:52</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-04-26_1352" title="Permanent link">&para;</a></h4>
<p>I need to update the btrfs example config files<br />
/usr/share/rear/conf/examples/SLE12-btrfs-example.conf<br />
/usr/share/rear/conf/examples/SLE12-SP1-btrfs-example.conf</p>
<h4 id="jsmeix_commented_at_2016-04-26_1406"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/821#issuecomment-214756509">2016-04-26 14:06</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-04-26_1406" title="Permanent link">&para;</a></h4>
<p>And this whole automagic transitive excluding<br />
needs to be much better described in default.conf</p>
<p>I will do a pull request after feedback from @pavoldomin</p>
<h4 id="pavoldomin_commented_at_2016-04-26_1421"><img src="https://avatars.githubusercontent.com/u/1576908?v=4" width="50"><a href="https://github.com/pavoldomin">pavoldomin</a> commented at <a href="https://github.com/rear/rear/issues/821#issuecomment-214761409">2016-04-26 14:21</a>:<a class="headerlink" href="#pavoldomin_commented_at_2016-04-26_1421" title="Permanent link">&para;</a></h4>
<p>Sorry for late response, our exchange decided to move rear emails to
junk folder, how rude.</p>
<p>Thanks @jsmeix. I'll test this tomorrow. For <code>NETFS</code> backup I still
should keep subvols in <code>BACKUP_PROG_INCLUDE</code>, right? Just remove them
from <code>EXCLUDE_RECREATE</code></p>
<h4 id="jsmeix_commented_at_2016-04-26_1430"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/821#issuecomment-214764218">2016-04-26 14:30</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-04-26_1430" title="Permanent link">&para;</a></h4>
<p>@pavoldomin<br />
yes,<br />
you must list those btrfs subvolumes in BACKUP_PROG_INCLUDE<br />
that you want to have in backup.tar.gz during "rear mkbackup"<br />
but you do not need any btrfs subvolumes in EXCLUDE_RECREATE</p>
<h4 id="jsmeix_commented_at_2016-04-27_1247"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/821#issuecomment-215071027">2016-04-27 12:47</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-04-27_1247" title="Permanent link">&para;</a></h4>
<p>Ha!</p>
<p>Now I even know why it had worked<br />
with my initial btrfs support implementation<br />
with entries in /etc/rear/local.conf like</p>
<pre>
EXCLUDE_RECREATE=( ... 'fs:/var/spool' ... )
</pre>

<p>to get the whole content of /var/spool/* restored<br />
from the backup.</p>
<p>I was sure that I had tested it at that time<br />
and that it had worked without missing<br />
stuff during backup restore.</p>
<p>My initial btrfs support implementation<br />
was never sent to rear upstream<br />
because it was a bad first-attempt hack<br />
that only works for SLES12-GA.</p>
<p>My initial btrfs support implementation<br />
was only implemented for SLES12-GA as a<br />
patch "adaptions_for_btrfs_for_SLE12.diff" for<br />
rear version 1.16 in our SLES12 RPM package "rear116".</p>
<p>The "rear116" RPM package changelog shows<br />
in particular this entry:</p>
<pre>
Fri Jul  4 12:42:49 CEST 2014 - jsmeix@suse.de
- Enhanced adaptions_for_btrfs_for_SLE12.diff so that it skips
  filesystem components from being automatically added to
  restore-exclude-list.txt when the files are explicitly
  listed to be included in the backup via BACKUP_PROG_INCLUDE
  to avoid that files in btrfs subvolumes get automatically
  exclued from being restored from the backup (bnc#885698).
- SLE12-btrfs-example.conf is a working example for SLE12
  with default btrfs subvolume that gets installed
  as /usr/share/rear/conf/SLE12-btrfs-example.conf
</pre>

<p>The adaptions_for_btrfs_for_SLE12.diff changes<br />
in particular 61_exclude_from_restore.sh<br />
to skip filesystem components in EXCLUDE_RECREATE<br />
that have a matching entry in BACKUP_PROG_INCLUDE<br />
from being automatically added to restore-exclude-list.txt</p>
<p>The "automatically added" is the crucial point here.</p>
<p>What the user has specified in EXCLUDE_RESTORE<br />
is still added to restore-exclude-list.txt<br />
so that with e.g. the following in local.conf</p>
<pre>
BACKUP_PROG_INCLUDE=( '/var/spool/*' '/var/log/*' )
EXCLUDE_RECREATE=( "${EXCLUDE_RECREATE[@]}" 'fs:/var/spool' )
EXCLUDE_RESTORE=( '/var/log/*' )
</pre>

<p>the whole content in /var/spool/ and /var/log/ will be<br />
saved in backup.tar.gz during "rear mkbackup"<br />
and during "rear recover" /var/spool/* will no longer<br />
be automatically added to restore-exclude-list.txt<br />
but /var/log/* will still be added to restore-exclude-list.txt<br />
so that whole content of /var/spool/ will be restored<br />
but not the content of /var/log/.</p>
<p>In contrast my more generic btrfs support implementation<br />
(that should also work on Red Hat and Fedora) which<br />
was included in rear upstream did no longer have that<br />
change of 61_exclude_from_restore.sh because it does<br />
not need that change because in my rear upstream btrfs<br />
support implementation there is no longer the need<br />
to specify btrfs subvolumes in EXCLUDE_RECREATE.</p>
<p>All what I missed to do was to remove the outdated<br />
and leftover EXCLUDE_RECREATE stuff from<br />
the btrfs example config files<br />
/usr/share/rear/conf/examples/SLE12-btrfs-example.conf<br />
/usr/share/rear/conf/examples/SLE12-SP1-btrfs-example.conf</p>
<h4 id="pavoldomin_commented_at_2016-04-28_0942"><img src="https://avatars.githubusercontent.com/u/1576908?v=4" width="50"><a href="https://github.com/pavoldomin">pavoldomin</a> commented at <a href="https://github.com/rear/rear/issues/821#issuecomment-215369140">2016-04-28 09:42</a>:<a class="headerlink" href="#pavoldomin_commented_at_2016-04-28_0942" title="Permanent link">&para;</a></h4>
<p>Hi,</p>
<p>I've tested it and it is not working with TSM.<br />
I also found a reason: in <code>verify/TSM/default/40_verify_tsm.sh</code> the
default filesystems included in TSM restore plan are taken from
<code>disklayout.conf</code> by</p>
<pre><code># Use the included_mountpoints array derived from the disklayout.conf to determine the default
# TSM filespaces to include in a restore.
included_mountpoints=( $(grep ^fs $VAR_DIR/layout/disklayout.conf  | awk '{print $3}') )
</code></pre>
<p>This wont match btrfs subvolumes - as those are listed as</p>
<pre><code>...
btrfsnormalsubvol /dev/sda2 / 262 @/var
...
</code></pre>
<p>I am afraid decision which BTRFS volumes are included in restore by
default requires bit of redesign of the code.</p>
<p>In any case, I am happy with my workaround, just need to place the
missing filespaces to the offered list within 30 seconds. We are using
workarounds with the TSM backup already - as the used version does not
seem to work with BTRFS subvols properly. Without them, the critical
filesystems like '/var' are not even backed up.</p>
<h4 id="jsmeix_commented_at_2016-04-28_1250"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/821#issuecomment-215413223">2016-04-28 12:50</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-04-28_1250" title="Permanent link">&para;</a></h4>
<p>@pavoldomin<br />
have you also tested it with 'tar' (i.e. NETFS backup).<br />
If yes, does it work for you with tar/NETFS ?</p>
<p>Regarding TSM:</p>
<p>First a general question about TSM:</p>
<p>Can TSM operate only on filesystems (i.e. mountpoints)<br />
or can TSM operate also on any directories (like 'tar')?<br />
In other words:<br />
Does TSM save avd restore whole filesystems (like 'dd')<br />
or does TSM save and restore files and directories?</p>
<p>Do I understand it correctly that content of btrfs subvolumes<br />
get saved in the TSM backup during "rear mkbackup"<br />
but does not get restored during "rear recover"?</p>
<p>In general I think backup restore based on 'fs' components<br />
in disklayout.conf at least looks strange from my point of view<br />
(and I would have never ever expected such a dependency).</p>
<p>In general I think what is saved in the backup and<br />
what is restored should be handled well separated from<br />
what storage components are saved and recreated.</p>
<p>For example I would expect that it "just works" to recreate<br />
only the root filesystem component and restore all files<br />
from the backup in there regardless from how many<br />
different filesystems or whatever other kind of storage<br />
components (like btrfs subvolumes) the files in the backup<br />
had been saved.</p>
<p>In general I would prefer to keep separated things separated.</p>
<p>In particular:<br />
I can maintain the plain btrfs support in rear<br />
but I cannot also maintain any kind of "hidden"<br />
interdependent stuff - especially I cannot do anything<br />
for third-party backup tools that I do not have on my<br />
systems (i.e. where I cannot test anything).</p>
<p>In particular see
<a href="https://github.com/rear/rear/issues/769#issuecomment-183282736">https://github.com/rear/rear/issues/769#issuecomment-183282736</a>
(excerpt):</p>
<pre>
IMHO we would be better off to extract the backup
functionality from ReaR into a separate Open Source
project which deals only with backup and restore.
That way we can stay true to ReaRs goal of doing
the "bare metal" part while also delivering value with
a new backup solution that can focus only on that part.
</pre>

<p>In general I think there are too many interdependant<br />
automatisms that try to make "usual things just work"<br />
but result unexpected obscure failures in other cases<br />
(like this one).</p>
<h4 id="jsmeix_commented_at_2016-04-28_1301"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/821#issuecomment-215415850">2016-04-28 13:01</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-04-28_1301" title="Permanent link">&para;</a></h4>
<p>In verify/TSM/default/40_verify_tsm.sh</p>
<pre>
# Use the included_mountpoints array derived from the disklayout.conf to determine the default
# TSM filespaces to include in a restore. 
</pre>

<p>is perfectly o.k. to have a reasonable default behaviour.</p>
<p>But I fail to find where the user can specify what he wants to have<br />
if the default behaviour is not the right one for his needs.</p>
<p>From my current (total TSM noob) point of view<br />
the whole TSM issue could be that it is missing<br />
how the user can specify what TSM should restore<br />
(and perhaps also what TSM should save in its backup).</p>
<h4 id="jsmeix_commented_at_2016-04-28_1344"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/821#issuecomment-215427677">2016-04-28 13:44</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-04-28_1344" title="Permanent link">&para;</a></h4>
<p>Right now I noticed in
<a href="https://github.com/rear/rear/issues/821#issuecomment-215369140">https://github.com/rear/rear/issues/821#issuecomment-215369140</a></p>
<pre>
We are using workarounds with the TSM backup already
...
Without them, the critical filesystems like '/var'
are not even backed up.
</pre>

<p>This means TSM does not support things like</p>
<pre>
BACKUP_PROG_INCLUDE=( '/var/spool/*' '/var/log/*' )
</pre>

<p>in /etc/rear/local.conf which is no big surprise<br />
because default.conf reads:</p>
<pre>
# These settings apply to all cases of internal Relax-and-Recover backup
...
BACKUP_PROG_INCLUDE=( )
</pre>

<p>But I wonder what the right way is how the user can specify<br />
what to include in the TSM backup if the default behaviour<br />
is not what he actually needs?</p>
<h4 id="pavoldomin_commented_at_2016-04-28_1359"><img src="https://avatars.githubusercontent.com/u/1576908?v=4" width="50"><a href="https://github.com/pavoldomin">pavoldomin</a> commented at <a href="https://github.com/rear/rear/issues/821#issuecomment-215432223">2016-04-28 13:59</a>:<a class="headerlink" href="#pavoldomin_commented_at_2016-04-28_1359" title="Permanent link">&para;</a></h4>
<p>That the case, from what I understand. TSM takes everything it
includes/excludes simply from ^fs entry in the disklayout and ignores
whatever backup options we define (I defined them, because I wont to
have more or less same config everywhere).</p>
<p>Thats why I assumed that TSM code needs some redesign.</p>
<p>NETFS restore is working fine when I cut subvols from
<code>EXCLUDE_RECREATE</code>.</p>
<h4 id="jsmeix_commented_at_2016-04-28_1431"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/821#issuecomment-215444895">2016-04-28 14:31</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-04-28_1431" title="Permanent link">&para;</a></h4>
<p>@pavoldomin<br />
many thanks for your testing that it works with tar/NETFS.</p>
<p>I will do a pull request that fixes my btrfs example config files.</p>
<p>Regarding the TSM issue I submitted a new separated<br />
issue
<a href="https://github.com/rear/rear/issues/823">https://github.com/rear/rear/issues/823</a>
to<br />
"enhance TSM support to specify what to backup and restore"</p>
<h4 id="jsmeix_commented_at_2016-04-29_0909"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/821#issuecomment-215664803">2016-04-29 09:09</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-04-29_0909" title="Permanent link">&para;</a></h4>
<p>With
<a href="https://github.com/rear/rear/pull/824">https://github.com/rear/rear/pull/824</a>
this issue here is solved<br />
at least for the tar/NETFS backup method.</p>
<p>Regarding TSM there is
<a href="https://github.com/rear/rear/issues/823">https://github.com/rear/rear/issues/823</a></p>
<h4 id="jsmeix_commented_at_2016-05-12_1156"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/821#issuecomment-218735851">2016-05-12 11:56</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-05-12_1156" title="Permanent link">&para;</a></h4>
<p><a href="https://github.com/rear/rear/pull/833">https://github.com/rear/rear/pull/833</a>
mitigates the problem where the btrfs subvlums are not restored by
default via TSM.</p>
<p>Now by default both 'fs' and 'btrfsmountedsubvol' entries<br />
in disklayout.conf are used to generate the default TSM<br />
filespaces to include in a restore.</p>
<p>This mitigates this issue here because now a better default is<br />
used but this does not yet implement
<a href="https://github.com/rear/rear/issues/823">https://github.com/rear/rear/issues/823</a><br />
because the user still cannot explicitly specify what to backup<br />
and restore with TSM when the default behaviour is not<br />
what he actually needs.</p>
<p>@pavoldomin<br />
I would appreciate it very much if you could test<br />
whether or not the new default behaviour<br />
with
<a href="https://github.com/rear/rear/pull/833">https://github.com/rear/rear/pull/833</a>
is already<br />
sufficient for your needs.</p>
<h4 id="pavoldomin_commented_at_2016-05-12_1224"><img src="https://avatars.githubusercontent.com/u/1576908?v=4" width="50"><a href="https://github.com/pavoldomin">pavoldomin</a> commented at <a href="https://github.com/rear/rear/issues/821#issuecomment-218741291">2016-05-12 12:24</a>:<a class="headerlink" href="#pavoldomin_commented_at_2016-05-12_1224" title="Permanent link">&para;</a></h4>
<p>Hi Johannes</p>
<p>I should have another opportunity to test soon (within couple of weeks I
hope). Of course I'll inform you when done.</p>
<p>Thanks for this commit!</p>
<p>Kind regards</p>
<p>Pavol</p>
<h4 id="jsmeix_commented_at_2016-05-12_1334"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/821#issuecomment-218758427">2016-05-12 13:34</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-05-12_1334" title="Permanent link">&para;</a></h4>
<p>For clarification:</p>
<p>It was @Joeri-MS who did the work in
<a href="https://github.com/rear/rear/pull/833">https://github.com/rear/rear/pull/833</a></p>
<p>I only merged his pull request.</p>
<h4 id="jsmeix_commented_at_2016-05-13_0815"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/821#issuecomment-218979864">2016-05-13 08:15</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-05-13_0815" title="Permanent link">&para;</a></h4>
<p>Regarding btrfs snapshot subvolumes:</p>
<p>Note that in
<a href="https://github.com/rear/rear/pull/833/commits/0f622cadcf61df6b4f947a237b23751b55e9e5f8">https://github.com/rear/rear/pull/833/commits/0f622cadcf61df6b4f947a237b23751b55e9e5f8</a><br />
btrfs snapshot subvolumes are excluded<br />
from the default TSM filespaces<br />
in a SUSE-specific way via</p>
<pre>
... | grep -v "/.snapshots"
</pre>

<p>to exclude from disklayout.conf entries like</p>
<pre>
btrfsmountedsubvol /dev/sda2 /.snapshots rw,relatime,space_cache,subvolid=258,subvol=/@/.snapshots @/.snapshots
</pre>

<p>where "/.snapshots" is the SUSE default mountpoint<br />
for all the SUSE default btrfs snapshot subvolumes<br />
(i.e. what SUSE's "snapper" tool does).</p>
<p>This does not work on systems that have<br />
btrfs snapshot subvolumes elsewhere.</p>
<p>Perhaps how the default TSM filespaces are created<br />
could be further enhanced regarding exclusion of<br />
any btrfs snapshot subvolumes by using the<br />
"btrfssnapshotsubvol" entries in disklayout.conf:</p>
<pre>
# There is no recovery of btrfs snapshot subvolumes.
# Format: btrfssnapshotsubvol &lt;device&gt; &lt;mountpoint&gt; &lt;btrfs_subvolume_ID&gt; &lt;btrfs_subvolume_path&gt;
#btrfssnapshotsubvol /dev/sda2 / 259 @/.snapshots/1/snapshot
#btrfssnapshotsubvol /dev/sda2 / 281 @/.snapshots/2/snapshot
</pre>

<p>but therein the &lt;mountpoint&gt; is always '/'<br />
(i.e. not the mountpoint directory as is looks<br />
from within SUSE's mounted btrfs structure)<br />
which is shown in the "btrfsmountedsubvol"<br />
entries in disklayout.conf:</p>
<pre>
# All mounted btrfs subvolumes (including mounted btrfs default subvolumes and mounted btrfs snapshot subvolumes).
# Determined by the findmnt command that shows the mounted btrfs_subvolume_path.
# Format: btrfsmountedsubvol &lt;device&gt; &lt;subvolume_mountpoint&gt; &lt;mount_options&gt; &lt;btrfs_subvolume_path&gt;
btrfsmountedsubvol /dev/sda2 / rw,relatime,space_cache,subvolid=259,subvol=/@/.snapshots/1/snapshot @/.snapshots/1/snapshot
btrfsmountedsubvol /dev/sda2 /.snapshots rw,relatime,space_cache,subvolid=258,subvol=/@/.snapshots @/.snapshots
</pre>

<h4 id="jsmeix_commented_at_2016-05-13_0821"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/821#issuecomment-218981039">2016-05-13 08:21</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-05-13_0821" title="Permanent link">&para;</a></h4>
<p>I got confused<br />
(as usual when I deal with SUSE's default btrfs structure):</p>
<p>What is mounted at the directory "/.snapshots"<br />
is not a btrfs snapshot subvolume<br />
but a "normal" btrfs subvolume,<br />
see disklayout.conf</p>
<pre>
# Btrfs normal subvolumes for /dev/sda2 at /
# Format: btrfsnormalsubvol &lt;device&gt; &lt;mountpoint&gt; &lt;btrfs_subvolume_ID&gt; &lt;btrfs_subvolume_path&gt;
btrfsnormalsubvol /dev/sda2 / 257 @
btrfsnormalsubvol /dev/sda2 / 258 @/.snapshots
</pre>

<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2025 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2016-04-25.821.issue.closed.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/rear/rear-user-guide" class="fa fa-code-fork" style="color: #fcfcfc"> rear/rear-user-guide</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
