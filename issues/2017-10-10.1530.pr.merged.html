<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#1530 PR merged: Empower the user to specify what ssh files get included in his recovery system… - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#1530 PR merged: Empower the user to specify what ssh files get included in his recovery system\u2026";
        var mkdocs_page_input_path = "issues/2017-10-10.1530.pr.merged.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/backup_netfs.html">Example of BACKUP=NETFS</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear29.html">Release Notes ReaR 2.9</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear28.html">Release Notes ReaR 2.8</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#1530 PR merged: Empower the user to specify what ssh files get included in his recovery system…</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="1530_pr_merged_empower_the_user_to_specify_what_ssh_files_get_included_in_his_recovery_system"><a href="https://github.com/rear/rear/pull/1530">#1530 PR</a> <code>merged</code>: Empower the user to specify what ssh files get included in his recovery system…<a class="headerlink" href="#1530_pr_merged_empower_the_user_to_specify_what_ssh_files_get_included_in_his_recovery_system" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>enhancement</code>, <code>cleanup</code>, <code>fixed / solved / done</code>,
<code>critical / security / legal</code></p>
<h4 id="jsmeix_opened_issue_at_2017-10-10_1347"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> opened issue at <a href="https://github.com/rear/rear/pull/1530">2017-10-10 13:47</a>:<a class="headerlink" href="#jsmeix_opened_issue_at_2017-10-10_1347" title="Permanent link">&para;</a></h4>
<p>This is my very first non-expert attempt to deal with<br />
<a href="https://github.com/rear/rear/issues/1512">https://github.com/rear/rear/issues/1512</a></p>
<p>I tried to implement what @OliverO2 suggested in<br />
<a href="https://github.com/rear/rear/issues/1512#issuecomment-331638066">https://github.com/rear/rear/issues/1512#issuecomment-331638066</a></p>
<p>The new config variable SSH_FILES is intentionally<br />
not yet documented in default.conf because currently<br />
anything can change here.</p>
<p>FWIW:<br />
At least for my minimal use case - I only use<br />
SSH_ROOT_PASSWORD="rear"<br />
things still work for me.</p>
<p>Without SSH_FILES set I get now by default in the<br />
recovery system (from a SLES12 original system):</p>
<pre>
# find /tmp/rear.gCCTXDuhnUTeiFD/rootfs/ | grep 'ssh/'       
/tmp/rear.gCCTXDuhnUTeiFD/rootfs/etc/ssh/ssh_host_rsa_key
/tmp/rear.gCCTXDuhnUTeiFD/rootfs/etc/ssh/ssh_host_dsa_key.pub
/tmp/rear.gCCTXDuhnUTeiFD/rootfs/etc/ssh/moduli
/tmp/rear.gCCTXDuhnUTeiFD/rootfs/etc/ssh/ssh_host_ecdsa_key
/tmp/rear.gCCTXDuhnUTeiFD/rootfs/etc/ssh/ssh_config
/tmp/rear.gCCTXDuhnUTeiFD/rootfs/etc/ssh/ssh_host_dsa_key
/tmp/rear.gCCTXDuhnUTeiFD/rootfs/etc/ssh/ssh_host_ecdsa_key.pub
/tmp/rear.gCCTXDuhnUTeiFD/rootfs/etc/ssh/sshd_config
/tmp/rear.gCCTXDuhnUTeiFD/rootfs/etc/ssh/ssh_host_ed25519_key.pub
/tmp/rear.gCCTXDuhnUTeiFD/rootfs/etc/ssh/ssh_host_rsa_key.pub
/tmp/rear.gCCTXDuhnUTeiFD/rootfs/etc/ssh/ssh_host_ed25519_key
/tmp/rear.gCCTXDuhnUTeiFD/rootfs/root/.ssh/known_hosts
</pre>

<p>and this is what I have on the original SLES12 system:</p>
<pre>
# find /etc/ssh /root/.ssh
/etc/ssh
/etc/ssh/ssh_host_rsa_key
/etc/ssh/ssh_host_dsa_key.pub
/etc/ssh/moduli
/etc/ssh/ssh_host_ecdsa_key
/etc/ssh/ssh_host_key
/etc/ssh/ldap.conf
/etc/ssh/ssh_config
/etc/ssh/ssh_host_dsa_key
/etc/ssh/ssh_host_key.pub
/etc/ssh/ssh_host_ecdsa_key.pub
/etc/ssh/sshd_config
/etc/ssh/ssh_host_ed25519_key.pub
/etc/ssh/ssh_host_rsa_key.pub
/etc/ssh/ssh_host_ed25519_key
/root/.ssh
/root/.ssh/known_hosts
</pre>

<p>The crucial point is that with empty SSH_FILES<br />
the SSH key files in the recovery system<br />
were re-generated anew (i.e. they are<br />
not the ones from the original system).<br />
In contrast with SSH_FILES="yes" the SSH key files<br />
in the recovery system are the ones from the original system.</p>
<h4 id="jsmeix_commented_at_2017-10-11_1204"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1530#issuecomment-335787683">2017-10-11 12:04</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-10-11_1204" title="Permanent link">&para;</a></h4>
<p>@OliverO2<br />
could you have again a look if it is better now.</p>
<p>For me plain<br />
SSH_ROOT_PASSWORD="rear"<br />
without any additional SSH_* config variable settings still works.<br />
Now with the more secure defaults I get those</p>
<pre>
WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!
...
Offending ECDSA key in /home/user/.ssh/known_hosts:123
</pre>

<p>and</p>
<pre>
Are you sure you want to continue connecting (yes/no)?
</pre>

<p>as expected when I do 'ssh' to the recovery system.</p>
<p>Using<br />
SSH_ROOT_PASSWORD="rear"<br />
SSH_FILES="yes"<br />
results for me the backward compatible behaviour<br />
where 'ssh' to the recovery system "just works".</p>
<h4 id="jsmeix_commented_at_2017-10-11_1215"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1530#issuecomment-335790096">2017-10-11 12:15</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-10-11_1215" title="Permanent link">&para;</a></h4>
<p>@gdha<br />
now I made clear in default.conf that with SSH_FILES=no<br />
there is no SSH setup in particular no sshd in the recovery system.</p>
<p>But I don't know in what file I could make clear right now<br />
that the default behavior will change with these new variables.<br />
Of course I will emphasize this clearly in the release notes<br />
of ReaR v2.3 when we make those release notes.</p>
<h4 id="jsmeix_commented_at_2017-10-11_1333"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1530#issuecomment-335810846">2017-10-11 13:33</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-10-11_1333" title="Permanent link">&para;</a></h4>
<p>@OliverO2<br />
a general security question when generating SSH host keys:<br />
Currently I run as usual commands with $v</p>
<pre>
ssh-keygen $v ...
</pre>

<p>which results in the log file things like</p>
<pre>
Generating public/private rsa key pair.
Your identification has been saved in /tmp/rear.YI2aUkgvEOG9pUj/rootfs/etc/ssh/ssh_host_rsa_key.
Your public key has been saved in /tmp/rear.YI2aUkgvEOG9pUj/rootfs/etc/ssh/ssh_host_rsa_key.pub.
The key fingerprint is:
SHA256:7XXBiLFmOrg/L39G0SvabGA+7xL2t7mEGAPnaLZKqZw root@e205
The key's randomart image is:
+---[RSA 2048]----+
|          .      |
|           + o   |
|        . * ..o  |
|       . X  . .. |
|      . S = .... |
|       = +==oo.  |
|      + .+oO...  |
|   . + oo = B... |
|    E . .=oOo.+o |
+----[SHA256]-----+
</pre>

<p>Does that somehow contain confidential information<br />
which appears now in a possibly not very securely<br />
stored ReaR log file?</p>
<p>E.g. in build/default/501_check_ssh_keys.sh there is</p>
<pre>
... ssh-keygen -q ...
</pre>

<p>but without a comment why that '-q' is there.</p>
<h4 id="jsmeix_commented_at_2017-10-12_1101"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1530#issuecomment-336094769">2017-10-12 11:01</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-10-12_1101" title="Permanent link">&para;</a></h4>
<p>Now things seem to work reasonably well for me<br />
so that I like to merge it if there are no strict objections.<br />
I.e. I like to merge it when it is at least a reasonable<br />
first step in the right direction so that (if needed) it could be<br />
further adapted and enhanced (without a complete rewrite).</p>
<h4 id="olivero2_commented_at_2017-10-12_1144"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/pull/1530#issuecomment-336102950">2017-10-12 11:44</a>:<a class="headerlink" href="#olivero2_commented_at_2017-10-12_1144" title="Permanent link">&para;</a></h4>
<p>@jsmeix I'll look into it and respond to your questions later today or
tomorrow.</p>
<h4 id="jsmeix_commented_at_2017-10-12_1229"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1530#issuecomment-336116891">2017-10-12 12:29</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-10-12_1229" title="Permanent link">&para;</a></h4>
<p>@OliverO2<br />
many thanks in advance for having a look!</p>
<p>I have another question regarding our current<br />
checking for unprotected SSH key files:</p>
<p>By default /root/.ssh/authorized_key gets included in the<br />
recovery system but build/default/501_check_ssh_keys.sh<br />
does not check if /root/.ssh/authorized_key is protected<br />
nor does it check any keys in /etc/ssh - it only checks<br />
some identity files in /root/.ssh/ - is that o.k.?</p>
<h4 id="olivero2_commented_at_2017-10-13_0947"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/pull/1530#issuecomment-336405425">2017-10-13 09:47</a>:<a class="headerlink" href="#olivero2_commented_at_2017-10-13_0947" title="Permanent link">&para;</a></h4>
<p>@jsmeix</p>
<p>Regarding
<a href="https://github.com/rear/rear/pull/1530#issuecomment-335810846">https://github.com/rear/rear/pull/1530#issuecomment-335810846</a>:</p>
<blockquote>
<p>@OliverO2<br />
a general security question when generating SSH host keys:<br />
Currently I run as usual commands with $v</p>
<p>ssh-keygen $v ...<br />
which results in the log file things like<br />
[...]<br />
Does that somehow contain confidential information<br />
which appears now in a possibly not very securely<br />
stored ReaR log file?</p>
</blockquote>
<p>No, this is all public information. <code>ssh-keygen</code> generates a private key
(which must be kept secret) and a public key (which can be, well, widely
published). The information in the log file (fingerprint, ASCII art) is
all about the public host key. It could be published on a website, where
it would allow ssh users to convince themselves that the host they are
connecting to via ssh is actually the right one (and not a fake).</p>
<blockquote>
<p>E.g. in build/default/501_check_ssh_keys.sh there is</p>
<p>... ssh-keygen -q ...<br />
but without a comment why that '-q' is there.</p>
</blockquote>
<p>The <code>-q</code> is there because this <code>ssh-keygen</code> invocation is actually a
no-op, just used to check if the key is unprotected. So it is used like
a shell test expression <code>[ -f /path/to/file ]</code>. See the adjacent
comment:</p>
<pre><code># We therefore try to change the passphrase from empty to empty and if that succeeds then it is unprotected
</code></pre>
<p>As the output of <code>ssh-keygen -q ...</code> is suppressed anyway the <code>-q</code> could
even be removed, I guess (but check first in case it uses <code>/dev/tty</code>
directly).</p>
<h4 id="olivero2_commented_at_2017-10-13_0956"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/pull/1530#issuecomment-336407592">2017-10-13 09:56</a>:<a class="headerlink" href="#olivero2_commented_at_2017-10-13_0956" title="Permanent link">&para;</a></h4>
<p>@jsmeix<br />
Regarding
<a href="https://github.com/rear/rear/pull/1530#issuecomment-336094769">https://github.com/rear/rear/pull/1530#issuecomment-336094769</a>:</p>
<blockquote>
<p>By default /root/.ssh/authorized_key gets included in the<br />
recovery system but build/default/501_check_ssh_keys.sh<br />
does not check if /root/.ssh/authorized_key is protected<br />
nor does it check any keys in /etc/ssh - it only checks<br />
some identity files in /root/.ssh/ - is that o.k.?</p>
</blockquote>
<p>An <code>authorized_keys</code> file contains public keys only. Public keys cannot
be protected.</p>
<p><code>authorized_keys</code> files copied to a rescue system would allow access to
the rescue system in the same way that they allow access to the original
system. So if the original system trusts certain accounts on certain
hosts, the rescue system would do the same. If the original system's
trust relationships were safe, so will be the rescue system's. It's all
OK.</p>
<h4 id="olivero2_commented_at_2017-10-13_1717"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/pull/1530#issuecomment-336513903">2017-10-13 17:17</a>:<a class="headerlink" href="#olivero2_commented_at_2017-10-13_1717" title="Permanent link">&para;</a></h4>
<p>After performing some tests, I have these observations and suggestions:</p>
<ol>
<li>The <code>COPY_AS_IS_EXCLUDE</code> example from <code>default.conf</code> seems incorrect
    (quoted globbing patterns, keys in <code>/root/.ssh/</code> are named <code>id_*</code>,
    not <code>*key*</code>)<ul>
<li>Correction:
    <code>COPY_AS_IS_EXCLUDE=( "${COPY_AS_IS_EXCLUDE[@]}" /etc/ssh/ssh_host_* /root/.ssh/id_* )</code></li>
</ul>
</li>
<li><code>COPY_AS_IS_EXCLUDE</code> does not prevent keys from being re-generated.
    For details, see below.</li>
<li><code>SSH_UNPROTECTED_PRIVATE_KEYS="no"</code> does not prevent unprotected
    <strong>host keys</strong> from being copied. If
    <code>SSH_FILES=( /etc/ssh /root/.ssh )</code> is used,
    <code>build/default/501_check_ssh_keys.sh</code> will still check for
    unprotected user keys in <code>/root/.ssh</code>, but not the (always
    unprotected) host keys in <code>/etc/ssh</code>.</li>
</ol>
<p><strong>Regarding observation number 2:</strong></p>
<p>What doesn't work currently is</p>
<ul>
<li>having a rescue medium completely free of SSH keys, and</li>
<li>having the RSA host key pair <code>/etc/ssh/ssh_host_rsa_key*</code> generated
    during rescue system boot.</li>
</ul>
<p>The reason is that <code>build/default/500_ssh_setup.sh</code></p>
<ol>
<li>always re-regenerates host keys existing on the original system
    (rendering <code>COPY_AS_IS_EXCLUDE</code> ineffective here), and</li>
<li>will generate an RSA host key even if no keys existed on the
    original system.</li>
</ol>
<p>To solve this problem, I added a variable to the configuration:</p>
<pre><code>SSH_GENERATE_PRIVATE_KEYS="no"
</code></pre>
<p>and this line in <code>build/default/500_ssh_setup.sh</code>:</p>
<pre><code>is_false "$SSH_GENERATE_PRIVATE_KEYS" &amp;&amp; return
</code></pre>
<p>just before this comment:</p>
<pre><code># Generate new SSH host key in the recovery system when no SSH host key file
# had been copied into the the recovery system in rescue/default/500_ssh.sh
</code></pre>
<p>With this correction, everything worked as expected. The missing RSA key
was generated during the rescue system boot and an SSH login was
successful.</p>
<h4 id="olivero2_commented_at_2017-10-13_1735"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/pull/1530#issuecomment-336518990">2017-10-13 17:35</a>:<a class="headerlink" href="#olivero2_commented_at_2017-10-13_1735" title="Permanent link">&para;</a></h4>
<p>@jsmeix Last not least: Thank you for all the hard work and effort you
are putting into these issues.</p>
<h4 id="jsmeix_commented_at_2017-10-14_1014"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1530#issuecomment-336625333">2017-10-14 10:14</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-10-14_1014" title="Permanent link">&para;</a></h4>
<p>@OliverO2<br />
many thanks for your careful and helpful review.<br />
I do appreciate that very much.</p>
<p>I already know about issue number 2 in<br />
<a href="https://github.com/rear/rear/pull/1530#issuecomment-336513903">https://github.com/rear/rear/pull/1530#issuecomment-336513903</a></p>
<p>My reasoning was that whenever SSH_FILES is not a 'false' value<br />
then sshd is meant to be run and then the needed keys must be
generated<br />
because without the needed keys a running sshd does not make sense<br />
and then also SSH_FILES not 'false' would not make sense.</p>
<p>Since<br />
<a href="https://github.com/rear/rear/pull/1530#issuecomment-336513903">https://github.com/rear/rear/pull/1530#issuecomment-336513903</a><br />
I know a use-case where SSH_FILES is not 'false' even without<br />
any of the needed sshd keys in the recovery system.</p>
<p>Regarding issue number 3 in<br />
<a href="https://github.com/rear/rear/pull/1530#issuecomment-336513903">https://github.com/rear/rear/pull/1530#issuecomment-336513903</a></p>
<p>This is what I had also asked about (a bit hidden) in<br />
<a href="https://github.com/rear/rear/pull/1530#issuecomment-336116891">https://github.com/rear/rear/pull/1530#issuecomment-336116891</a><br />
"nor does it check any keys in /etc/ssh"</p>
<p>I am thinking about to enhance the SSH_UNPROTECTED_PRIVATE_KEYS<br />
functionality from a plain boolean setting into a possible array where<br />
the user can specify where ReaR will search for unproteded keys<br />
(similar how SSH_FILES already works).</p>
<h4 id="olivero2_commented_at_2017-10-14_1406"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/pull/1530#issuecomment-336636983">2017-10-14 14:06</a>:<a class="headerlink" href="#olivero2_commented_at_2017-10-14_1406" title="Permanent link">&para;</a></h4>
<p>@jsmeix</p>
<blockquote>
<p>I already know about issue number 2 in<br />
#1530 (comment)</p>
<p>My reasoning was that whenever SSH_FILES is not a 'false' value<br />
then sshd is meant to be run and then the needed keys must be
generated<br />
because without the needed keys a running sshd does not make sense<br />
and then also SSH_FILES not 'false' would not make sense.</p>
</blockquote>
<p>True, but since that time you have added the feature to generate an RSA
host key at boot time. Now we don't need any host keys on the recsue
medium and sshd still works.</p>
<blockquote>
<p>I am thinking about to enhance the SSH_UNPROTECTED_PRIVATE_KEYS<br />
functionality from a plain boolean setting into a possible array
where<br />
the user can specify where ReaR will search for unproteded keys<br />
(similar how SSH_FILES already works).</p>
</blockquote>
<p>I'd advise against further complicating configuration options:</p>
<ul>
<li>Since private <strong>host keys</strong> are never protected and their names are
    standardized, the best option in my view would be to remove them if
    SSH_UNPROTECTED_PRIVATE_KEYS is false.</li>
<li>I wouldn't even generate new host keys for the rescue medium as this
    can be done more securely at boot time.</li>
<li>I'd give the user basically three simple options, which are<ol>
<li>have an entirely secret-free rescue medium (no user keys, no
    host keys, not even newly generated keys), or</li>
<li>have a rescue medium which contains only protected secrets (so
    no unprotected user keys, no host keys here), or</li>
<li>have a rescue medium which contains secrets.</li>
</ol>
</li>
</ul>
<p>Having a rescue medium with (some) unprotected keys actually means
having an insecure rescue medium. The difference will just be the type
of possible attacks. The question is: Can we really expect users to
acquire all the knowledge needed to decide whether it is safe to allow
certain types of attacks?</p>
<p>Hope this helps to clarify things. Have a great weekend!</p>
<h4 id="jsmeix_commented_at_2017-10-16_1258"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1530#issuecomment-336878712">2017-10-16 12:58</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-10-16_1258" title="Permanent link">&para;</a></h4>
<p>With<br />
<a href="https://github.com/rear/rear/pull/1530/commits/93f17aedb8da8ab82b08c8c0e9f3428dfe8a353b">https://github.com/rear/rear/pull/1530/commits/93f17aedb8da8ab82b08c8c0e9f3428dfe8a353b</a><br />
I tried to implement corrections according to<br />
<a href="https://github.com/rear/rear/pull/1530#issuecomment-336636983">https://github.com/rear/rear/pull/1530#issuecomment-336636983</a><br />
but I need to test them a bit more...</p>
<h4 id="jsmeix_commented_at_2017-10-17_1232"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1530#issuecomment-337216386">2017-10-17 12:32</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-10-17_1232" title="Permanent link">&para;</a></h4>
<p>@OliverO2<br />
regardless that you "advise against further complicating"<br />
I found a use case where I needed to enhance the<br />
SSH_UNPROTECTED_PRIVATE_KEYS<br />
functionality from a plain boolean setting into a string<br />
or an array where the user can specify where ReaR<br />
will search for unprotected keys.</p>
<p>For my testing I had done</p>
<pre>
# cp -a /etc/ssh /etc/ssh.save
</pre>

<p>and I got all keys in /etc/ssh.save in the recovery system<br />
regardless of<br />
SSH_UNPROTECTED_PRIVATE_KEYS='no'.</p>
<p>Now with an array like</p>
<pre>
SSH_UNPROTECTED_PRIVATE_KEYS=( '/etc/ssh*/ssh_host_*' '/root/.ssh/id_*' )
</pre>

<p>and also simpler with a string</p>
<pre>
SSH_UNPROTECTED_PRIVATE_KEYS='/etc/ssh*/ssh_host_* /root/.ssh/id_*'
</pre>

<p>I can get all those unprotected keys removed.</p>
<p>Currently this enhanced SSH_UNPROTECTED_PRIVATE_KEYS<br />
functionality is not officially documented in default.conf.</p>
<h4 id="jsmeix_commented_at_2017-10-17_1347"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1530#issuecomment-337236807">2017-10-17 13:47</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-10-17_1347" title="Permanent link">&para;</a></h4>
<p>I will merge it so that others can test it in the<br />
ReaR master code.<br />
If something is still missing or<br />
when there are bugs I will fix it.</p>
<h4 id="olivero2_commented_at_2017-10-17_2031"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/pull/1530#issuecomment-337361175">2017-10-17 20:31</a>:<a class="headerlink" href="#olivero2_commented_at_2017-10-17_2031" title="Permanent link">&para;</a></h4>
<p>@jsmeix<br />
Regarding
<a href="https://github.com/rear/rear/pull/1530#issuecomment-337216386">https://github.com/rear/rear/pull/1530#issuecomment-337216386</a>:</p>
<blockquote>
<p>For my testing I had done</p>
<p># cp -a /etc/ssh /etc/ssh.save<br />
and I got all keys in /etc/ssh.save in the recovery system<br />
regardless of</p>
</blockquote>
<p>I wonder why ReaR would copy <code>/etc/ssh.save</code> at all? I haven't yet
looked into this but I was under the impression that ReaR is normally
pretty selective when deciding what to copy onto the rescue medium.
Otherwise ReaR could in theory copy lots of secrets from <code>/etc</code>
directories belonging to software it doesn't even know about.</p>
<p>Anyway, I'll take a look at your latest commits and I'll test things as
soon as I can. Might take until the end of this week, though, but
hopefully I'm quicker than that.</p>
<p>Thanks again for tackling the issues!</p>
<h4 id="jsmeix_commented_at_2017-10-18_0802"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1530#issuecomment-337493807">2017-10-18 08:02</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-10-18_0802" title="Permanent link">&para;</a></h4>
<p>ReaR does tons of inexplicable stuff simply because<br />
it is not explained by meaningful comments in the code.</p>
<p>In such cases all I can do is to keep inexplicable code as is<br />
because I have no chance to understand it with reasonable effort<br />
where "reasonable effort" primarily means "within a reasonable<br />
amount of time" (I will not reverse-engineer inexplicable code).</p>
<p>Often all I can do to move forward is to delete inexplicable code<br />
and replace it with my own code according to how I understand<br />
what is meant that the code should do so that I can maintain it<br />
in the future.<br />
Of course there is the risk that I might destroy whatever<br />
sophisticated support for whatever obscure special cases<br />
but then I could easily re-add such support to code that<br />
I can maintain (if bugs ever appear because of that because<br />
usually such special cases are long obsolete nowadays).</p>
<p>In this particular case run</p>
<pre>
git log -p --follow usr/share/rear/rescue/default/500_ssh.sh | less
</pre>

<p>and look for '/etc/ssh*' which is there since ever.<br />
In my current code it is</p>
<pre>
copy_as_is_ssh_files=( /etc/ssh* ...
</pre>

<p>which I used as is from its former form</p>
<pre>
COPY_AS_IS=( "${COPY_AS_IS[@]}" /etc/ssh* ...
</pre>

<p>that is there since the beginning of the Git history.<br />
The first entry in Git history is</p>
<pre>
# assume that we have openssh with configs in /etc/ssh
COPY_AS_IS=( "${COPY_AS_IS[@]}" /etc/ssh* ...
</pre>

<p>where the comment may or may not contradict the implementation.<br />
If the comment means "assume that we have openssh with configs in
/etc/ssh/" the implementation contradicts the comment.<br />
If the comment means "assume that we have openssh with configs in<br />
/etc/ssh*" the implementation matches the comment.<br />
Because I cannot prove "with reasonable effort" (cf. above)<br />
that the latter case is false, I must assume there could be systems<br />
where directories like /etc/ssh.conf or /etc/ssh.d are used<br />
so that /etc/ssh* would be the right thing.</p>
<h4 id="schlomo_commented_at_2017-10-18_0806"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/1530#issuecomment-337495150">2017-10-18 08:06</a>:<a class="headerlink" href="#schlomo_commented_at_2017-10-18_0806" title="Permanent link">&para;</a></h4>
<p>About the <code>/etc/ssh*</code> I can only suspect that back then we had old
systems that put all the SSH configs and keys in <code>/etc/</code> instead of
<code>/etc/ssh/</code> so that this catches all possibilities. However, I don't
remember the details of those past days and I can imagine that all
systems where ReaR is now supported use a sub directory.</p>
<h4 id="jsmeix_commented_at_2017-10-18_0810"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1530#issuecomment-337496183">2017-10-18 08:10</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-10-18_0810" title="Permanent link">&para;</a></h4>
<p>FYI<br />
how it looks on my SLES10 SP4 test system where I keep<br />
the SLES10 SP4 default installation unchanged:</p>
<pre>
# find /etc | grep ssh
/etc/init.d/rc3.d/S11sshd
/etc/init.d/rc3.d/K11sshd
/etc/init.d/rc5.d/S11sshd
/etc/init.d/rc5.d/K11sshd
/etc/init.d/sshd
/etc/profile.d/csh.ssh
/etc/profile.d/sh.ssh
/etc/sysconfig/ssh
/etc/pam.d/sshd
/etc/slp.reg.d/ssh.reg
/etc/ssh
/etc/ssh/ssh_config
/etc/ssh/moduli
/etc/ssh/ssh_host_key
/etc/ssh/sshd_config
/etc/ssh/ssh_host_key.pub
/etc/ssh/ssh_host_dsa_key
/etc/ssh/ssh_host_dsa_key.pub
/etc/ssh/ssh_host_rsa_key
/etc/ssh/ssh_host_rsa_key.pub

# rpm -qa | grep -i ssh
openssh-5.1p1-41.8.20
openssh-askpass-5.1p1-41.8.20
</pre>

<h4 id="olivero2_commented_at_2017-10-18_0939"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/pull/1530#issuecomment-337526810">2017-10-18 09:39</a>:<a class="headerlink" href="#olivero2_commented_at_2017-10-18_0939" title="Permanent link">&para;</a></h4>
<p>The <a href="https://www.openssh.com/releasenotes.html">OpenSSH Release Notes</a>
state for version 3.1/3.1p1 (2004-04-09):</p>
<blockquote>
<p>/etc/ssh/ now default directory for keys and configuration files</p>
</blockquote>
<p>So maybe it's reasonable to drop support for OpenSSH &lt; 3.1 and refer
the user to use <code>COPY_AS_IS</code> for files outside of <code>/etc/ssh</code>?</p>
<h4 id="jsmeix_commented_at_2017-10-18_1131"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1530#issuecomment-337561334">2017-10-18 11:31</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-10-18_1131" title="Permanent link">&para;</a></h4>
<p>The following change seems to fix it for me:</p>
<pre>
# git diff usr/share/rear/rescue/default/500_ssh.sh | cat 
diff --git a/usr/share/rear/rescue/default/500_ssh.sh b/usr/share/rear/rescue/default/500_ssh.sh
index a7831b6..a0d6332 100644
--- a/usr/share/rear/rescue/default/500_ssh.sh
+++ b/usr/share/rear/rescue/default/500_ssh.sh
@@ -13,14 +13,16 @@ if is_false "$SSH_FILES" ; then
     return
 fi

-# Assume that we have openssh with configs in /etc/ssh
+# Assume that we have OpenSSH >= 3.1 where /etc/ssh/ is the default directory for keys and configuration files
+# according to the OpenSSH release notes for version 3.1/3.1p1 at https://www.openssh.com/releasenotes.html
+# cf. https://github.com/rear/rear/pull/1530#issuecomment-337526810
 local copy_as_is_ssh_files=()
 # The funny [] around a letter makes 'shopt -s nullglob' remove this file from the list if it does not exist.
 if is_true "$SSH_FILES" ; then
     # Copy all the "usual SSH files" (including SSH private host keys) to make things "just work"
     # (provided SSH_UNPROTECTED_PRIVATE_KEYS is not false - otherwise unprotected keys get removed)
     # into the recovery system, cf. https://github.com/rear/rear/issues/1512
-    copy_as_is_ssh_files=( /etc/ssh* /etc/openssh* /etc/centrifydc/ssh* /root/.s[s]h /root/.shos[t]s )
+    copy_as_is_ssh_files=( /etc/ssh /etc/openssh* /etc/centrifydc/ssh* /root/.s[s]h /root/.shos[t]s )
 else
     # Use a reasonably secure fallback if SSH_FILES is not set or empty:
     test "$SSH_FILES" || SSH_FILES="avoid_sensitive_files"
</pre>

<p>I still wonder about</p>
<pre>
/etc/openssh* /etc/centrifydc/ssh*
</pre>

<p>in copy_as_is_ssh_files<br />
On none of my machines I have either of them<br />
so that I cannot say anything about them.</p>
<h4 id="jsmeix_commented_at_2017-10-18_1226"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1530#issuecomment-337573696">2017-10-18 12:26</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-10-18_1226" title="Permanent link">&para;</a></h4>
<p>/etc/openssh* and /etc/centrifydc/ssh* were added recently via<br />
<a href="https://github.com/rear/rear/commit/5b2aca92c69a4f38556d2c6bc51c920e54cbd0ec">https://github.com/rear/rear/commit/5b2aca92c69a4f38556d2c6bc51c920e54cbd0ec</a><br />
but currently I cannot see a reason why.</p>
<h4 id="schlomo_commented_at_2017-10-18_1255"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/1530#issuecomment-337580966">2017-10-18 12:55</a>:<a class="headerlink" href="#schlomo_commented_at_2017-10-18_1255" title="Permanent link">&para;</a></h4>
<p>The original change for centrify was #836 on request of a user, about
the openssh path I also don't remember.</p>
<h4 id="jsmeix_commented_at_2017-10-18_1427"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1530#issuecomment-337609631">2017-10-18 14:27</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-10-18_1427" title="Permanent link">&para;</a></h4>
<p>@schlomo<br />
thanks for the information about the reason<br />
why /etc/centrifydc/ssh* was added.</p>
<p>I think in our new "sufficiently secure by default" implementation<br />
both /etc/openssh* and /etc/centrifydc/ssh* should be removed<br />
again to ensure we are really "sufficiently secure by default".</p>
<p>If the user needs something in addition to our default<br />
it is described in default.conf at the SSH_* variables<br />
how he can do that i.e. via COPY_AS_IS and if needed<br />
additionally via COPY_AS_IS_EXCLUDE.</p>
<p>(Right now I noticed another inconsistency in that<br />
description in default.conf ...)</p>
<h4 id="jsmeix_commented_at_2017-10-19_1056"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1530#issuecomment-337873166">2017-10-19 10:56</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-10-19_1056" title="Permanent link">&para;</a></h4>
<p><a href="https://github.com/rear/rear/pull/1538">https://github.com/rear/rear/pull/1538</a><br />
intends to implement what is described in the above<br />
<a href="https://github.com/rear/rear/pull/1530#issuecomment-337526810">https://github.com/rear/rear/pull/1530#issuecomment-337526810</a><br />
and subsequent comments.</p>
<h4 id="jsmeix_commented_at_2017-10-19_1431"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1530#issuecomment-337926527">2017-10-19 14:31</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-10-19_1431" title="Permanent link">&para;</a></h4>
<p>With
<a href="https://github.com/rear/rear/pull/1538">https://github.com/rear/rear/pull/1538</a>
merged there is now<br />
only support for OpenSSH 3.1 and later with its default directory<br />
/etc/ssh/ for keys and config files and its default sshd config file<br />
/etc/ssh/sshd_config for the SSH setup of the recovery system.<br />
I removed support for non-standard directories<br />
like /etc/openssh or non-standard sshd config files<br />
like /etc/sshd_config or /etc/openssh/sshd_config.<br />
I documented in the SSH_* section in default.conf<br />
how to manually set up ReaR with a secure shell<br />
software other than OpenSSH &gt;= 3.1.</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2025 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2017-10-10.1530.pr.merged.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/rear/rear-user-guide" class="fa fa-code-fork" style="color: #fcfcfc"> rear/rear-user-guide</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
