<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#1283 Issue closed: With NETFS_RESTORE_CAPABILITIES=yes 'getcap -r /' runs too long on big systems - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#1283 Issue closed: With NETFS_RESTORE_CAPABILITIES=yes \u0027getcap -r /\u0027 runs too long on big systems";
        var mkdocs_page_input_path = "issues/2017-04-10.1283.issue.closed.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/backup_netfs.html">Example of BACKUP=NETFS</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear28.html">Release Notes ReaR 2.8</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#1283 Issue closed: With NETFS_RESTORE_CAPABILITIES=yes 'getcap -r /' runs too long on big systems</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="1283_issue_closed_with_netfs_restore_capabilitiesyes_getcap_-r_runs_too_long_on_big_systems"><a href="https://github.com/rear/rear/issues/1283">#1283 Issue</a> <code>closed</code>: With NETFS_RESTORE_CAPABILITIES=yes 'getcap -r /' runs too long on big systems<a class="headerlink" href="#1283_issue_closed_with_netfs_restore_capabilitiesyes_getcap_-r_runs_too_long_on_big_systems" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>enhancement</code>, <code>documentation</code>, <code>fixed / solved / done</code>,
<code>external tool</code></p>
<h4 id="tcerna_opened_issue_at_2017-04-10_1648"><img src="https://avatars.githubusercontent.com/u/17880584?u=6b03fa3ad0e06b52aa12a38c04e4d31e92686106&v=4" width="50"><a href="https://github.com/tcerna">tcerna</a> opened issue at <a href="https://github.com/rear/rear/issues/1283">2017-04-10 16:48</a>:<a class="headerlink" href="#tcerna_opened_issue_at_2017-04-10_1648" title="Permanent link">&para;</a></h4>
<p>Rear doesn't create backup when big file systems are mounted. It tries
to copy files from network filesystems which are often very big and
slow. Backup creation of mounted NFS is not task which should clients
do. This should be backed up from server side.</p>
<p>Problem appears when variable NETFS_RESTORE_CAPABILITIES is set to
yes. It goes through whole system by command 'getcap -r /' including
NFS.</p>
<p>Current result:<br />
Rear does a copy of large mounted NFS and it can last indefinitely. I
waited for 8 hours and it was still working.</p>
<p>Expected result:<br />
It will not do a copy of mounted NFS.</p>
<pre><code># rpm -q rear
rear-2.00-1.el7.x86_64
</code></pre>
<p>Reproducer:</p>
<pre><code># cat /etc/rear/local.conf 
OUTPUT=ISO
BACKUP=NETFS
BACKUP_URL=nfs://$IPADDR/mnt/rear/
GRUB_RESCUE=1

# cat /usr/share/rear/conf/default.conf | grep CAPABILITIES
NETFS_RESTORE_CAPABILITIES=y

# rear -v mkbackup
Relax-and-Recover 2.00 / Git
Using log file: /var/log/rear/rear-sweetpig-5.log
Using backup archive '/tmp/rear.gGE7FlLGrEl5541/tmp/isofs/backup/backup.tar.gz'
Creating disk layout
Creating root filesystem layout
^C
</code></pre>
<p>See in rear log:</p>
<pre><code>...
2017-03-24 07:46:18 Including rescue/GNU/Linux/550_copy_ldconfig.sh
2017-03-24 07:46:18 Including rescue/default/550_vagrant.sh
2017-03-24 07:46:18 Including rescue/NETFS/default/600_store_NETFS_variables.sh
2017-03-24 07:46:18 Including rescue/GNU/Linux/600_unset_TMPDIR_in_rescue_conf.sh
2017-03-24 07:46:19 Including rescue/NETFS/default/610_save_capabilities.sh
2017-03-24 08:02:23 Running exit tasks.
2017-03-24 08:02:23 Finished in 973 seconds
2017-03-24 08:02:23 Removing build area /tmp/rear.YHBqaWCbzOjGzt0
removed directory: '/tmp/rear.YHBqaWCbzOjGzt0'
2017-03-24 08:02:23 End of program reached
</code></pre>
<p>During running backup creation:</p>
<pre><code># pstree -p
    ├─sshd(1043)─┬─sshd(4117)───bash(4700)───rear(16856)─┬─getcap(17941)
    │            │                                       └─grep(17942)

# cat /proc/17941/cmdline 
getcap-r/
</code></pre>
<h4 id="gozora_commented_at_2017-04-11_0610"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/1283#issuecomment-293160403">2017-04-11 06:10</a>:<a class="headerlink" href="#gozora_commented_at_2017-04-11_0610" title="Permanent link">&para;</a></h4>
<p>Indeed.</p>
<pre><code>getcap -r / 2&gt;/dev/null | grep -v $ISO_DIR &gt; $VAR_DIR/recovery/capabilities || Log "Error while saving capabilities to file."
</code></pre>
<p>Is certainly not way to go, as root (/) can contain lots of files ...</p>
<p>@gdha, @jsmeix<br />
Maybe</p>
<pre><code>getcap -r $(cat $TMP_DIR/backup-include.txt) 2&gt;/dev/null | grep -v $ISO_DIR &gt; $VAR_DIR/recovery/capabilities || Log "Error while saving capabilities to file."
</code></pre>
<p>Would be better?</p>
<p>V.</p>
<h4 id="tcerna_commented_at_2017-04-11_0723"><img src="https://avatars.githubusercontent.com/u/17880584?u=6b03fa3ad0e06b52aa12a38c04e4d31e92686106&v=4" width="50"><a href="https://github.com/tcerna">tcerna</a> commented at <a href="https://github.com/rear/rear/issues/1283#issuecomment-293173682">2017-04-11 07:23</a>:<a class="headerlink" href="#tcerna_commented_at_2017-04-11_0723" title="Permanent link">&para;</a></h4>
<p>One good news: step <code>Creating root filesystem layout</code> and whole process
of <code>rear -v mkbackup</code> ended.<br />
But there is problem with capabilities again. It was not saved.</p>
<pre><code># cat /var/lib/rear/recovery/capabilities 
#
</code></pre>
<p>See in /var/log/rear/rear-seetpig-1.log:</p>
<pre><code>...
2017-04-11 03:13:39 Including rescue/NETFS/default/610_save_capabilities.sh
cat: /tmp/rear.mdzBvGEIXrxaihO/tmp/backup-include.txt: No such file or directory
2017-04-11 03:13:39 Error while saving capabilities to file.
...
</code></pre>
<h4 id="gdha_commented_at_2017-04-11_0725"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/issues/1283#issuecomment-293174124">2017-04-11 07:25</a>:<a class="headerlink" href="#gdha_commented_at_2017-04-11_0725" title="Permanent link">&para;</a></h4>
<p>@mattihautameki Your commit
<a href="https://github.com/rear/rear/commit/463a2651af982723f843beccdf33f71a0352fa53">https://github.com/rear/rear/commit/463a2651af982723f843beccdf33f71a0352fa53</a>
need some modifications - see above. Any comments?<br />
Also, this issue is related to #1175 - if only <code>tar</code> could handle
correctly <code>--acls</code> and <code>--xattr</code> then this hack would not be necessary.</p>
<h4 id="gdha_commented_at_2017-04-11_0728"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/issues/1283#issuecomment-293174751">2017-04-11 07:28</a>:<a class="headerlink" href="#gdha_commented_at_2017-04-11_0728" title="Permanent link">&para;</a></h4>
<p>@tcerna @gozora The error
<code>/tmp/rear.mdzBvGEIXrxaihO/tmp/backup-include.txt: No such file or directory</code>
is normal as <code>./rescue/NETFS/default/610_save_capabilities.sh</code> is
executed before <code>./backup/NETFS/default/500_make_backup.sh</code>. To be
precise script
<code>./backup/NETFS/default/400_create_include_exclude_files.sh</code> creates the
<em>backup-include.txt</em> file.<br />
Try to use the command <code>rear -s mkbackup</code> to get an overview of <strong>all</strong>
scripts (and in the order these are executed)</p>
<h4 id="tcerna_commented_at_2017-04-11_0740"><img src="https://avatars.githubusercontent.com/u/17880584?u=6b03fa3ad0e06b52aa12a38c04e4d31e92686106&v=4" width="50"><a href="https://github.com/tcerna">tcerna</a> commented at <a href="https://github.com/rear/rear/issues/1283#issuecomment-293177186">2017-04-11 07:40</a>:<a class="headerlink" href="#tcerna_commented_at_2017-04-11_0740" title="Permanent link">&para;</a></h4>
<p>I see that <code>610_save_capabilities.sh</code> are run before other scripts. File
<code>backup-include.txt</code> can't exist, so it is not possible to use it in
this script.</p>
<pre><code># rear -s mkbackup
...
Source rescue/NETFS/default/610_save_capabilities.sh
...
Source backup/NETFS/default/500_make_backup.sh
Source backup/NETFS/GNU/Linux/600_start_selinux.sh
...
</code></pre>
<h4 id="gozora_commented_at_2017-04-11_0747"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/1283#issuecomment-293178769">2017-04-11 07:47</a>:<a class="headerlink" href="#gozora_commented_at_2017-04-11_0747" title="Permanent link">&para;</a></h4>
<p>@tcerna, @gdha<br />
Sorry it was just a guess ;-)</p>
<h4 id="gozora_commented_at_2017-04-11_0751"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/1283#issuecomment-293179538">2017-04-11 07:51</a>:<a class="headerlink" href="#gozora_commented_at_2017-04-11_0751" title="Permanent link">&para;</a></h4>
<p>I'll try to take a closer look later today (unless someone else will
solve this ;-)).</p>
<h4 id="jsmeix_commented_at_2017-04-11_0754"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1283#issuecomment-293180273">2017-04-11 07:54</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-04-11_0754" title="Permanent link">&para;</a></h4>
<p>First and foremost:<br />
When the root cause is that 'tar' has a bug that is does no longer<br />
handle --acls and --xattr corectly then this hack is just a band aid<br />
and not meant to be a solution. But band aid hacks must be<br />
propoerly documented as described at "Dirty hacks welcome"<br />
in
<a href="https://github.com/rear/rear/wiki/Coding-Style">https://github.com/rear/rear/wiki/Coding-Style</a>
because<br />
otherwise we get bug reports about ReaR like this one<br />
that are actually no bugs in ReaR.</p>
<p>According to<br />
<a href="https://github.com/rear/rear/issues/1175#issuecomment-282334872">https://github.com/rear/rear/issues/1175#issuecomment-282334872</a><br />
the bug is in 'tar' and must be fixed there.</p>
<p>Regarding the dirty NETFS_RESTORE_CAPABILITIES hack:<br />
I would only properly document it but leave it as is.<br />
ReaR is not responsible to fix broken backup tools.</p>
<p>If someone likes to enhance NETFS_RESTORE_CAPABILITIES<br />
to make it better usable I would recommend to make<br />
NETFS_RESTORE_CAPABILITIES an array of directories<br />
that is used for 'getcap -r directory' calls.<br />
By default NETFS_RESTORE_CAPABILITIES could be<br />
empty which means the hack is not done.</p>
<p>When 'tar' does not work as documented it is up to the user<br />
to either get a fixed 'tar' or to manually specify the right<br />
directories in his particular case to work around his broken 'tar'.</p>
<h4 id="jsmeix_commented_at_2017-04-11_0758"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1283#issuecomment-293181107">2017-04-11 07:58</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-04-11_0758" title="Permanent link">&para;</a></h4>
<p>Currently I have other work to do - but later as time permits<br />
I may try to enhance NETFS_RESTORE_CAPABILITIES.</p>
<p>@tcerna<br />
what about a fix for 'tar' in Red Hat?</p>
<h4 id="gozora_commented_at_2017-04-11_0802"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/1283#issuecomment-293182044">2017-04-11 08:02</a>:<a class="headerlink" href="#gozora_commented_at_2017-04-11_0802" title="Permanent link">&para;</a></h4>
<p>@jsmeix</p>
<blockquote>
<p>NETFS_RESTORE_CAPABILITIES an array of directories<br />
that is used for 'getcap -r directory' calls.<br />
By default NETFS_RESTORE_CAPABILITIES could be<br />
empty which menas the hack is not done.</p>
</blockquote>
<p>This would lead back to problem we have currently, considering that user
would not search manually for files/file systems containing capabilities
and fallback to "/" (root) which would again search all net shares even
if excluded from backup ...</p>
<p>V.</p>
<h4 id="gozora_commented_at_2017-04-11_0809"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/1283#issuecomment-293183550">2017-04-11 08:09</a>:<a class="headerlink" href="#gozora_commented_at_2017-04-11_0809" title="Permanent link">&para;</a></h4>
<p>@tcerna can you please provide version of RHEL you are using?</p>
<h4 id="jsmeix_commented_at_2017-04-11_0817"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1283#issuecomment-293185307">2017-04-11 08:17</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-04-11_0817" title="Permanent link">&para;</a></h4>
<p>See what I also wrote:</p>
<pre>
When 'tar' does not work as documented
it is up to the user to either get a fixed 'tar'
or to manually ... work around his broken 'tar'.
</pre>

<p>ReaR upstream is not there to fix bugs in other tools.</p>
<p>Any user can adapt and enhance our ReaR usptream scripts<br />
according to his particular needs when he must work around<br />
issues in his particular environment.</p>
<p>ReaR may even provide some kind of "template functionality"<br />
to work around issues that is disabled by default<br />
(like NETFS_RESTORE_CAPABILITIES).</p>
<p>But ReaR should not try to automatically work around issues<br />
because when ReaR does something automatically then users<br />
also "automatically" expect that ReaR does everything right.<br />
But that fails more often than not for workarounds.<br />
Any workaround has unwanted side effects.</p>
<p>Strictly speaking nothing at all should be done in ReaR<br />
when a bug is not in ReaR because regardless what<br />
sophisticated workarounds we try to implement in ReaR<br />
we will then get subsequent reports that demand<br />
"ReaR has a bug that needs to be fixed in ReaR".</p>
<h4 id="jsmeix_commented_at_2017-04-11_0828"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1283#issuecomment-293187890">2017-04-11 08:28</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-04-11_0828" title="Permanent link">&para;</a></h4>
<p>FYI regarding<br />
<a href="https://github.com/rear/rear/issues/1283#issuecomment-293177186">https://github.com/rear/rear/issues/1283#issuecomment-293177186</a><br />
that 'rescue' stage is run before 'backup' stage:</p>
<p>It is a general problem in lib/mkbackup-workflow.sh<br />
that 'backup' stage is usually run last<br />
but sometimes not (i.e. for backup in the ISO image), cf.<br />
<a href="https://github.com/rear/rear/issues/1281#issuecomment-292534810">https://github.com/rear/rear/issues/1281#issuecomment-292534810</a></p>
<p>I am already thinking about if another ordering might be better<br />
where 'backup' is not last so that one could do things<br />
even after 'backup', for example things like<br />
<a href="https://github.com/rear/rear/issues/1283#issuecomment-293160403">https://github.com/rear/rear/issues/1283#issuecomment-293160403</a></p>
<p>At least there should be one same ordering in any case<br />
to avoid unexpected behaviour is some cases as in<br />
<a href="https://github.com/rear/rear/issues/1281#issuecomment-292534810">https://github.com/rear/rear/issues/1281#issuecomment-292534810</a></p>
<h4 id="gozora_commented_at_2017-04-11_0829"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/1283#issuecomment-293188072">2017-04-11 08:29</a>:<a class="headerlink" href="#gozora_commented_at_2017-04-11_0829" title="Permanent link">&para;</a></h4>
<p>I'm fully share your opinion @jsmeix.<br />
But we already have code for save/restore capabilities
<em>610_save_capabilities.sh</em> in ReaR present, and once it was merged it
should work.<br />
I personally think that scanning capabilities on "/" is simply not OK.<br />
I'll try to fix this somehow and we can discuss my approach of solving
this under PR, like always ;-).</p>
<p>V.</p>
<h4 id="tcerna_commented_at_2017-04-11_0831"><img src="https://avatars.githubusercontent.com/u/17880584?u=6b03fa3ad0e06b52aa12a38c04e4d31e92686106&v=4" width="50"><a href="https://github.com/tcerna">tcerna</a> commented at <a href="https://github.com/rear/rear/issues/1283#issuecomment-293188454">2017-04-11 08:31</a>:<a class="headerlink" href="#tcerna_commented_at_2017-04-11_0831" title="Permanent link">&para;</a></h4>
<p>@gozora I'm using <code>Red Hat Enterprise Linux Server release 7.3 (Maipo)</code></p>
<h4 id="gozora_commented_at_2017-04-11_0833"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/1283#issuecomment-293188907">2017-04-11 08:33</a>:<a class="headerlink" href="#gozora_commented_at_2017-04-11_0833" title="Permanent link">&para;</a></h4>
<p>@tcerna I guess Centos 7 is close enough for testing ;-)</p>
<h4 id="jsmeix_commented_at_2017-04-11_0834"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1283#issuecomment-293189292">2017-04-11 08:34</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-04-11_0834" title="Permanent link">&para;</a></h4>
<p>@gozora<br />
because I fully agree with you that code that there is in ReaR<br />
should work sufficiently well I wrote that I will try to enhance<br />
the NETFS_RESTORE_CAPABILITIES implementation.<br />
But currently I have no good idea how to make that code<br />
"just work" out of the box - therefore I used my usual fallback<br />
to let the user manually specify what ReaR should do<br />
so that the user knows what he has set up and<br />
ReaR upstream is not "guilty by default".</p>
<h4 id="jsmeix_commented_at_2017-04-11_0933"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1283#issuecomment-293204015">2017-04-11 09:33</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-04-11_0933" title="Permanent link">&para;</a></h4>
<p>@tcerna<br />
have a look at my proposal in<br />
<a href="https://github.com/rear/rear/pull/1284">https://github.com/rear/rear/pull/1284</a><br />
whether or not this way you can better work around<br />
the issue in 'tar'?</p>
<h4 id="jsmeix_commented_at_2017-04-11_934"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1283#issuecomment-293204158">2017-04-11 09:33</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-04-11_934" title="Permanent link">&para;</a></h4>
<p>Now I really need to do my other work...</p>
<h4 id="gdha_commented_at_2017-04-11_0937"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/issues/1283#issuecomment-293205009">2017-04-11 09:37</a>:<a class="headerlink" href="#gdha_commented_at_2017-04-11_0937" title="Permanent link">&para;</a></h4>
<p>@gozora @jsmeix with the sentence "<em>scanning capabilities on "/" is
simply not OK</em>" I full agree. I think we could fix this by moving the
rescue script to the backup workflow, no? We only need the capabilities
file during the restore phase anyway. So, why bother during the rescue
phase?<br />
@jsmeix there is a reason why the output workflow is before the backup
workflow and that is OBDR (however, is anyone still using that?) - I
guess HPE ;-)</p>
<h4 id="jsmeix_commented_at_2017-04-11_0941"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1283#issuecomment-293206167">2017-04-11 09:41</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-04-11_0941" title="Permanent link">&para;</a></h4>
<p>@gdha<br />
many thanks for the reason why the 'output' stage<br />
is usually before the 'backup' stage!</p>
<h4 id="jsmeix_commented_at_2017-04-11_0946"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1283#issuecomment-293207445">2017-04-11 09:46</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-04-11_0946" title="Permanent link">&para;</a></h4>
<p>@gdha<br />
I think we cannot move rescue/NETFS/default/610_save_capabilities.sh<br />
to the backup stage because the 'output' stage (and the 'build' stage)<br />
is usually before the 'backup' stage which means<br />
/var/lib/rear/recovery/capabilities will not get included in the<br />
output (i.e. it will be missing in the ReaR recovery system).</p>
<h4 id="jsmeix_commented_at_2017-04-11_0956"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1283#issuecomment-293209833">2017-04-11 09:56</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-04-11_0956" title="Permanent link">&para;</a></h4>
<p>@gozora<br />
we cannot use your proposal</p>
<pre>
getcap -r $(cat $TMP_DIR/backup-include.txt) ...
</pre>

<p>because on my SLES12 test system I get</p>
<pre>
# cat /tmp/rear.Kg1fzf8DAe2o37x/tmp/backup-include.txt
/
</pre>

<p>i.e. $( cat $TMP_DIR/backup-include.txt ) evaluates to '/'.<br />
I have nothing specified in local.conf what exactly should<br />
be in the backup - i.e. I use the ReaR default.</p>
<h4 id="gozora_commented_at_2017-04-11_1045"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/1283#issuecomment-293220439">2017-04-11 10:45</a>:<a class="headerlink" href="#gozora_commented_at_2017-04-11_1045" title="Permanent link">&para;</a></h4>
<p>@jsmeix this could work if we use <code>getcap</code> instead of <code>getcap -r</code><br />
-r should use recursion and collect all files inside "/" (this obviously
means everything).<br />
But if we remove <code>-r</code> getcap will stay inside specified file system
boundaries so every other mount point should be skipped.</p>
<p>V.</p>
<h4 id="gozora_commented_at_2017-04-11_1101"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/1283#issuecomment-293223584">2017-04-11 11:01</a>:<a class="headerlink" href="#gozora_commented_at_2017-04-11_1101" title="Permanent link">&para;</a></h4>
<p>Something like this worked fine for me, to search only "/" (without
crossing mount points)</p>
<pre><code># getcap /* 2&gt;/dev/null  
/ping = cap_net_raw+ep
</code></pre>
<p>V.</p>
<h4 id="jsmeix_commented_at_2017-04-11_1218"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1283#issuecomment-293242163">2017-04-11 12:18</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-04-11_1218" title="Permanent link">&para;</a></h4>
<p>For me that does not work:</p>
<pre>
# getcap -r / 2>/dev/null
/usr/lib/gstreamer-1.0/gst-ptp-helper = cap_net_bind_service+ep
/usr/bin/ping6 = cap_net_raw+ep
/usr/bin/ping = cap_net_raw+ep

# getcap /* 2>/dev/null
[no output] 
</pre>

<h4 id="gozora_commented_at_2017-04-11_1220"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/1283#issuecomment-293242908">2017-04-11 12:20</a>:<a class="headerlink" href="#gozora_commented_at_2017-04-11_1220" title="Permanent link">&para;</a></h4>
<p>@jsmeix<br />
Don't you have <em>/usr</em> as separate mount point?<br />
If so</p>
<pre><code>getcap /usr/* 2&gt;/dev/null
</code></pre>
<p>Should be right thing to do ...</p>
<p>V.</p>
<h4 id="jsmeix_commented_at_2017-04-11_1450"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1283#issuecomment-293288228">2017-04-11 14:50</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-04-11_1450" title="Permanent link">&para;</a></h4>
<p>No, I have a single ext4 file system.</p>
<p>Even 'getcap /usr/* 2&gt;/dev/null' does not work for me:</p>
<pre>
# getcap /usr/* 2>/dev/null
[no output]
</pre>

<p>in contrast to 'getcap -r /usr' which works</p>
<pre>
# getcap -r /usr 2>/dev/null
/usr/lib/gstreamer-1.0/gst-ptp-helper = cap_net_bind_service+ep
/usr/bin/ping6 = cap_net_raw+ep
/usr/bin/ping = cap_net_raw+ep
</pre>

<h4 id="jsmeix_commented_at_2017-04-11_1452"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1283#issuecomment-293288699">2017-04-11 14:52</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-04-11_1452" title="Permanent link">&para;</a></h4>
<p>With
<a href="https://github.com/rear/rear/pull/1284">https://github.com/rear/rear/pull/1284</a>
merged<br />
NETFS_RESTORE_CAPABILITIES is more flexible to be used.<br />
See default.conf how it can be used.<br />
In particular on systems with zillions of files the user can<br />
now explicitly specify on what directories 'getcap -r'<br />
should be run to avoid that 'getcap -r /' runs too long.</p>
<h4 id="jsmeix_commented_at_2017-04-12_1411"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1283#issuecomment-293589360">2017-04-12 14:11</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-04-12_1411" title="Permanent link">&para;</a></h4>
<p>@tcerna<br />
out of curiosity I am interested to learn why<br />
on your particular system with NFS mounts<br />
'getcap -r /' needs more than 8 hours.</p>
<p>On my test sytem without NFS mounts<br />
I have all regular files in one ext4 filesystem</p>
<pre>
# find / -xdev | wc -l
125546

# time getcap -r / &>/dev/null
real    0m4.427s
user    0m0.126s
sys     0m2.246s
</pre>

<p>Now I mounted for testing a whole /usr/ from<br />
another machine (107780 files) via NFS</p>
<pre>
# mount -v -t nfs -o nfsvers=3,nolock 10.160.4.244:/usr /tmp/mp

# time getcap -r / &>/dev/null
real    0m13.357s
user    0m0.285s
sys     0m8.564s

# find /tmp/mp -xdev | wc -l
107780
</pre>

<p>For me 107780 additional files mounted via NFS<br />
make 'getcap -r /' somewhat slower but still<br />
it completes within seconds.</p>
<p>Now I mount the same NFS share two additional times</p>
<pre>
# mount -v -t nfs -o nfsvers=3,nolock 10.160.4.244:/usr /tmp/mp2

# mount -v -t nfs -o nfsvers=3,nolock 10.160.4.244:/usr /tmp/mp3

# time getcap -r / &>/dev/null
real    0m18.393s
user    0m0.440s
sys     0m10.964s
</pre>

<p>I wonder what goes on on your system with NFS mounts<br />
that could make 'getcap -r /' running for hours?</p>
<p>From my above tests it seems the current default<br />
to run 'getcap -r /' is usually sufficiently fast.</p>
<p>For exceptional cases the user can now<br />
do appropriate exceptional setup in ReaR.</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2024 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2017-04-10.1283.issue.closed.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/rear/rear-user-guide" class="fa fa-code-fork" style="color: #fcfcfc"> rear/rear-user-guide</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
