<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#1500 PR closed: Avoid leaking unprotected SSH private key files onto rescue medium - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#1500 PR closed: Avoid leaking unprotected SSH private key files onto rescue medium";
        var mkdocs_page_input_path = "issues/2017-09-18.1500.pr.closed.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#1500 PR closed: Avoid leaking unprotected SSH private key files onto rescue medium</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="1500_pr_closed_avoid_leaking_unprotected_ssh_private_key_files_onto_rescue_medium"><a href="https://github.com/rear/rear/pull/1500">#1500 PR</a> <code>closed</code>: Avoid leaking unprotected SSH private key files onto rescue medium<a class="headerlink" href="#1500_pr_closed_avoid_leaking_unprotected_ssh_private_key_files_onto_rescue_medium" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>won't fix / can't fix / obsolete</code></p>
<h4 id="olivero2_opened_issue_at_2017-09-18_1732"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> opened issue at <a href="https://github.com/rear/rear/pull/1500">2017-09-18 17:32</a>:<a class="headerlink" href="#olivero2_opened_issue_at_2017-09-18_1732" title="Permanent link">&para;</a></h4>
<p><strong>Note:</strong> This is not about logging into the rescue system via SSH
(incoming access). It is about accessing <em>other systems</em> from a running
rescue system via SSH private keys stored on the rescue medium (outgoing
access).</p>
<h4 id="problem">Problem<a class="headerlink" href="#problem" title="Permanent link">&para;</a></h4>
<p>The 'root' account on the original system may contain SSH private key
files without passphrase protection. Such unprotected private key files
are typically used to access other systems during unattended operations
(e.g. automatic backup to a network server). This kind of access can be
useful during restore, too.</p>
<p>Security then depends entirely on keeping such private keys secret,
which might be compromised if unprotected private key files leak onto an
unencrypted rescue medium. Anyone with physical access to the rescue
medium would be allowed unauthenticated access to each account on the
network authorizing one of those private keys.</p>
<h4 id="solution">Solution<a class="headerlink" href="#solution" title="Permanent link">&para;</a></h4>
<p>Avoid leaking SSH private key files onto the rescue medium in
unprotected form:</p>
<p>This PR enables ReaR to copy the SSH client configuration for 'root'
with the option of passphrase-protecting otherwise unprotected private
keys. The user can choose between</p>
<ul>
<li>copying previously unprotected private keys with added
    passphrase-protection,</li>
<li>copying previously unprotected private keys as-is (with a proper
    warning),</li>
<li>not copying unprotected private keys at all.</li>
</ul>
<p>Private key files which already contain a passphrase are assumed to be
sufficiently secure and are copied as-is.</p>
<p>The PR also aims to optimize usability during 'rear recover' by asking
the user just once for any required SSH passphrase (using ssh-agent).</p>
<p>Tested on Ubuntu 16.04.3 LTS.</p>
<h4 id="olivero2_commented_at_2017-09-19_0859"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/pull/1500#issuecomment-330475887">2017-09-19 08:59</a>:<a class="headerlink" href="#olivero2_commented_at_2017-09-19_0859" title="Permanent link">&para;</a></h4>
<p>@schlomo @jsmeix<br />
Lots of thanks to both of you for reviews and suggestions.</p>
<p>Before investing any further effort in <code>UserInput</code> let me just address
the latest comments. Hopefully, we can really keep <code>rear mkrescue</code>
non-interactive without compromising security. I might have a viable
idea, so just stay tuned.</p>
<h4 id="jsmeix_commented_at_2017-09-19_1209"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1500#issuecomment-330518949">2017-09-19 12:09</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-09-19_1209" title="Permanent link">&para;</a></h4>
<p>Via
<a href="https://github.com/rear/rear/pull/1501">https://github.com/rear/rear/pull/1501</a><br />
there is a new confidential mode (via '-C')<br />
for the UserInput function that does not log<br />
possibly confidential data.</p>
<h4 id="jsmeix_commented_at_2017-09-19_1331"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1500#issuecomment-330539753">2017-09-19 13:31</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-09-19_1331" title="Permanent link">&para;</a></h4>
<p>I did not follow all the details here only a side note<br />
regarding the comment from @schlomo<br />
<a href="https://github.com/rear/rear/pull/1500#discussion_r139680488">https://github.com/rear/rear/pull/1500#discussion_r139680488</a></p>
<pre>
not copying unprotected SSH keys unless
specifically configured to do so
</pre>

<p>@OliverO2<br />
in general no confidential stuff should be copied<br />
into the ReaR recovery system unless the user<br />
specifically configured ReaR to do so, cf.<br />
<a href="https://github.com/rear/rear/pull/1472#issuecomment-328459748">https://github.com/rear/rear/pull/1472#issuecomment-328459748</a></p>
<h4 id="jsmeix_commented_at_2017-09-20_1001"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1500#issuecomment-330805988">2017-09-20 10:01</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-09-20_1001" title="Permanent link">&para;</a></h4>
<p>Via
<a href="https://github.com/rear/rear/pull/1505">https://github.com/rear/rear/pull/1505</a>
plus the fix in<br />
<a href="https://github.com/rear/rear/commit/0f5220ec76dd68a061b55d30cccde5f8aa8505bb">https://github.com/rear/rear/commit/0f5220ec76dd68a061b55d30cccde5f8aa8505bb</a><br />
the UserInput function supports now the 'read' options<br />
'-r' for raw input and<br />
'-s' to not echo input from a terminal on that terminal<br />
plus a better description how to use the confidential UserInput mode<br />
in particular an example how to let the user enter a password<br />
that is (hopefully - unless I forgot something) now really quiet</p>
<pre>
{ password="$( UserInput -I PASSWORD -C -r -s -p 'Enter the pasword' )" ; } 2>/dev/null
</pre>

<p>where also in debugscripts mode nothing appears in the log,<br />
at least as it seems for me:<br />
I (mis)use for such tests
init/default/030_update_recovery_system.sh<br />
because that is an 'init' script that is always and early run.</p>
<pre>
e205:~/rear.master # head usr/share/rear/init/default/030_update_recovery_system.sh

{ password="$( UserInput -I PASSWORD -C -r -s -p 'Enter the pasword' )" ; } 2>/dev/null
echo -En "$password" | od -a 1>&7

UserInput -I WAIT -t 0

Error "test exit"

# Updating the currently running system.

e205:~/rear.master # export USER_INPUT_PASSWORD='my \t password'

e205:~/rear.master # usr/sbin/rear -d -D mkrescue
Relax-and-Recover 2.2 / Git
Using log file: /root/rear.master/var/log/rear/rear-e205.log
UserInput -I PASSWORD needed in /root/rear.master/usr/share/rear/init/default/030_update_recovery_system.sh line 2
Enter the pasword
(timeout 300 seconds)
UserInput: Will use predefined input in USER_INPUT_PASSWORD
Hit any key to interrupt the automated input (timeout 5 seconds)
0000000   m   y  sp   \   t  sp   p   a   s   s   w   o   r   d
0000016
UserInput -I WAIT needed in /root/rear.master/usr/share/rear/init/default/030_update_recovery_system.sh line 5
enter your input

UserInput: Neither real user input nor real default input (both empty or only spaces) results ''
ERROR: test exit
Aborting due to an error, check /root/rear.master/var/log/rear/rear-e205.log for details
Terminated

e205:~/rear.master # less /root/rear.master/var/log/rear/rear-e205.log
...
+ source /root/rear.master/usr/share/rear/init/default/030_update_recovery_system.sh
++ od -a
++ echo -En 'my \t password'
++ UserInput -I WAIT -t 0
...
</pre>

<h4 id="olivero2_commented_at_2017-09-20_1325"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/pull/1500#issuecomment-330850413">2017-09-20 13:25</a>:<a class="headerlink" href="#olivero2_commented_at_2017-09-20_1325" title="Permanent link">&para;</a></h4>
<p>@schlomo</p>
<p>Sorry, it seems we have reached a point where I am not going to pursue
this PR any further. Let me just clarify:</p>
<ol>
<li>
<p>We seem to have completely different philosophies regarding how to
    deal with security vulnerabilities and how to avoid them:</p>
<ul>
<li>While ReaR normally cherry-picks every bit that should go into
    the recovery system, you now argue that the potentially
    vulnerable <code>/root/.ssh</code> directory contents should go there
    completely by default.</li>
<li>I think it's not safe to assume that administrators, when
    changing stuff in <code>/root/.ssh</code>, are fully aware of the
    consequences in conjunction with ReaR or that they even think
    about this once ReaR was set up.</li>
<li>I think it's not safe to assume that administrators have other
    protection measures in place. Secrets allowing complete access
    to sensitive information will end up on unencrypted USB sticks
    ready for anyone to pick up - an attacker's paradise.</li>
<li>So I argue that secrets and other potentially vulnerable
    configuration files should not be transferred by default.
    Administrators should decide individually after assessing their
    specific situation (and probably after thorough consultation
    with security experts).</li>
<li>I simply don't have the time and the necessary in-depth
    qualification to assess the security implications of every
    conceivable ssh configuration option, so I'd rather not seduce
    anyone by providing risky options. I like to play safe and stick
    to a reasonable minimum with (hopefully) well known
    consequences.</li>
</ul>
</li>
<li>
<p>In my view, we are losing focus and wasting time. Examples (all in
    <code>500_ssh.sh</code> unless otherwise stated):</p>
<ul>
<li>I had changed the introductory <code>if</code> into
    <code>has_binary ssh || has_binary sshd || return</code> on your request.
    This was unrelated to the PR's objective, changed indentation
    everywhere, and the situation got worse after merging a
    conflicting commit into master.</li>
<li>Issues are being discussed which are unrelated to the code
    actually changed by this PR:<ul>
<li><code>CLONE_USERS</code></li>
<li>splitting it up into prep and build stage (the file
    contained code writing to <code>$ROOTFS_DIR</code> before)</li>
</ul>
</li>
<li>Issues are being discussed which are of too little value to
    spend time on <em>now</em>, for example:<ul>
<li>When there is <code>ISO_RECOVER_MODE</code>, <code>PXE_RECOVER_MODE</code> and
    <code>LANG_RECOVER</code>, <code>SSH_PRIVATE_KEYS_RECOVER_PASSPHRASE</code> (named
    after the phase where it is used) should be just OK.</li>
<li>The <code>strings</code> call in <code>005_ssh_agent_start.sh</code> might not be
    strictly required, but makes sense when you don't want to
    research <code>grep</code>'s implementation details (it's meant to be a
    text-line-based tool) and the extra call doesn't hurt at
    all.</li>
<li>Using <code>cat</code> instead of <code>$(&lt; file)</code>, escpecially when it's
    meant to deliver an empty string if the file doesn't exist,
    just works. It was just an example in a comment, after all.
    And opinions on whether <code>$(&lt; file)</code> is actually immediately
    understood by non-bash-experts looking at the configuration
    seems questionable.</li>
</ul>
</li>
<li>I don't say that these things couldn't be discussed but
    extensive discussions of questionable value are not what I'd
    call contributor-friendly. I just value my time more than what I
    think we're getting out of it. And while I'm happy to improve
    some other details on-the-fly, I did not intend to do a complete
    overhaul of <code>500_ssh.sh</code>.</li>
</ul>
</li>
</ol>
<p>So if you have very specific ideas of what the code should look like,
that's absolutely fine. I'd say just take my ideas and research from
this PR and implement it the way you like.</p>
<p>And finally, thanks to you, to the other contributors for creating ReaR,
and especially to @jsmeix for being so helpful.</p>
<h4 id="olivero2_commented_at_2017-09-22_1911"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/pull/1500#issuecomment-331535631">2017-09-22 19:11</a>:<a class="headerlink" href="#olivero2_commented_at_2017-09-22_1911" title="Permanent link">&para;</a></h4>
<p>Topic now tracked in issue #1511.</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2024 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2017-09-18.1500.pr.closed.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/rear/rear-user-guide" class="fa fa-code-fork" style="color: #fcfcfc"> rear/rear-user-guide</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
