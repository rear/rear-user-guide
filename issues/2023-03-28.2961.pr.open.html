<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>2023 03 28.2961.pr.open - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "2023 03 28.2961.pr.open";
        var mkdocs_page_input_path = "issues/2023-03-28.2961.pr.open.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/rust.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', '366986045', 'auto');
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a> &raquo;</li>
      <li>2023 03 28.2961.pr.open</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="2961_pr_open_copy_the_console_kernel_arguments_from_the_original_system"><a href="https://github.com/rear/rear/pull/2961">#2961 PR</a> <code>open</code>: Copy the console= kernel arguments from the original system<a class="headerlink" href="#2961_pr_open_copy_the_console_kernel_arguments_from_the_original_system" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>cleanup</code>, <code>minor bug</code></p>
<h4 id="jsmeix_opened_issue_at_2023-03-28_1219"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> opened issue at <a href="https://github.com/rear/rear/pull/2961">2023-03-28 12:19</a>:<a class="headerlink" href="#jsmeix_opened_issue_at_2023-03-28_1219" title="Permanent link">&para;</a></h4>
<ul>
<li>
<p>Type: <strong>Bug Fix</strong> / <strong>Cleanup</strong></p>
</li>
<li>
<p>Impact: <strong>Normal</strong></p>
</li>
<li>
<p>Reference to related issue (URL):<br />
<a href="https://github.com/rear/rear/pull/2749#issuecomment-1196650631">https://github.com/rear/rear/pull/2749#issuecomment-1196650631</a><br />
<a href="https://github.com/rear/rear/issues/2843">https://github.com/rear/rear/issues/2843</a><br />
<a href="https://github.com/rear/rear/pull/2844#issuecomment-1202307444">https://github.com/rear/rear/pull/2844#issuecomment-1202307444</a></p>
</li>
<li>
<p>How was this pull request tested?<br />
    It is not yet tested because<br />
    currently this is work in progress.</p>
</li>
<li>
<p>Brief description of the changes in this pull request:</p>
</li>
</ul>
<p>Overhauled the whole automated serial console setup<br />
for the recovery system in particular<br />
prep/GNU/Linux/200_include_serial_console.sh<br />
and lib/serial-functions.sh which results that<br />
rescue/GNU/Linux/400_use_serial_console.sh is obsolete, see<br />
<a href="https://github.com/rear/rear/pull/2749#issuecomment-1196650631">https://github.com/rear/rear/pull/2749#issuecomment-1196650631</a></p>
<h4 id="jsmeix_commented_at_2023-03-28_1230"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2961#issuecomment-1486800692">2023-03-28 12:30</a>:<a class="headerlink" href="#jsmeix_commented_at_2023-03-28_1230" title="Permanent link">&para;</a></h4>
<p>Tomorrow I will do some initial testing.</p>
<h4 id="jsmeix_commented_at_2023-03-29_1019"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2961#issuecomment-1488329126">2023-03-29 10:19</a>:<a class="headerlink" href="#jsmeix_commented_at_2023-03-29_1019" title="Permanent link">&para;</a></h4>
<p>My first test result of the new default behaviour<br />
(i.e. when no SERIAL_CONSOLE config variables are specified):</p>
<p>I booted the original system (a QEMU/KVM virtual machine)<br />
with artificial (I do not have serial port hardware)<br />
additional kernel 'console' command line options:</p>
<pre><code>... console=ttyS1,9600n8 ... console=ttyS3 ... console=tty0 ...
</code></pre>
<p>and got</p>
<pre><code># dmesg | grep console
[    0.000000] Command line: BOOT_IMAGE=/boot/vmlinuz-5.3.18-57-default root=/dev/mapper/system-root console=ttyS1,9600n8 resume=/dev/system/swap console=ttyS3 crashkernel=203M,high console=tty0 mitigations=off
[    0.122561] Kernel command line: BOOT_IMAGE=/boot/vmlinuz-5.3.18-57-default root=/dev/mapper/system-root console=ttyS1,9600n8 resume=/dev/system/swap console=ttyS3 crashkernel=203M,high console=tty0 mitigations=off
[    0.146431] printk: console [tty0] enabled
[    0.219572] printk: console [ttyS1] enabled
[    5.980855] qxl 0000:00:02.0: vgaarb: deactivate vga console

# ls -l /dev/ttyS[0-9]
crw-rw---- 1 root dialout 4, 64 Mar 29 11:10 /dev/ttyS0
crw-rw---- 1 root dialout 4, 65 Mar 29 11:10 /dev/ttyS1
crw-rw---- 1 root dialout 4, 66 Mar 29 11:10 /dev/ttyS2
crw-rw---- 1 root dialout 4, 67 Mar 29 11:10 /dev/ttyS3
crw-rw---- 1 root dialout 4, 68 Mar 29 11:10 /dev/ttyS4
crw-rw---- 1 root dialout 4, 69 Mar 29 11:10 /dev/ttyS5
crw-rw---- 1 root dialout 4, 70 Mar 29 11:10 /dev/ttyS6
crw-rw---- 1 root dialout 4, 71 Mar 29 11:10 /dev/ttyS7
crw-rw---- 1 root dialout 4, 72 Mar 29 11:10 /dev/ttyS8
crw-rw---- 1 root dialout 4, 73 Mar 29 11:10 /dev/ttyS9

# uname -a
Linux localhost 5.3.18-57-default #1 SMP Wed Apr 28 10:54:41 UTC 2021 (ba3c2e9) x86_64 x86_64 x86_64 GNU/Linux
</code></pre>
<p>That there is first <code>console [tty0] enabled</code><br />
and then <code>console [ttyS1] enabled</code><br />
but no 'console [ttyS3] enabled' matches what<br />
<a href="https://www.kernel.org/doc/html/v5.3/admin-guide/serial-console.html">https://www.kernel.org/doc/html/v5.3/admin-guide/serial-console.html</a><br />
reads (excerpts)</p>
<pre><code>So, for example:

console=ttyS1,9600 console=tty0

defines that opening /dev/console will get you the
current foreground virtual console, and kernel messages
will appear on both the VGA console and
the 2nd serial port (ttyS1 or COM2) at 9600 baud.

Note that you can only define one console
per device type (serial, video).

If no console device is specified, the first device found
capable of acting as a system console will be used.
At this time, the system first looks for a VGA card and
then for a serial port.
So if you don't have a VGA card in your system
the first serial port will automatically become the console.
</code></pre>
<p>ReaR on the original system (which runs SLES15 SP3):</p>
<pre><code># egrep -v '^#|^$' etc/rear/local.conf
FIRMWARE_FILES=( 'no' )
MODULES=( 'loaded_modules' )
PROGRESS_MODE="plain"
PROGRESS_WAIT_SECONDS="5"
OUTPUT=ISO
BACKUP=NETFS
BACKUP_OPTIONS="nfsvers=3,nolock"
BACKUP_URL=nfs://192.168.122.1/nfs
REQUIRED_PROGS+=( snapper chattr )
PROGS+=( lsattr )
COPY_AS_IS+=( /usr/lib/snapper/installation-helper /etc/snapper/config-templates/default )
BACKUP_PROG_INCLUDE=( /boot/grub2/x86_64-efi /boot/grub2/i386-pc /opt /srv /usr/local /root /tmp /var ) 
POST_RECOVERY_SCRIPT=( 'if snapper --no-dbus -r $TARGET_FS_ROOT get-config | grep -q "^QGROUP.*[0-9]/[0-9]" ; then snapper --no-dbus -r $TARGET_FS_ROOT set-config QGROUP= ; snapper --no-dbus -r $TARGET_FS_ROOT setup-quota &amp;&amp; echo snapper setup-quota done || echo snapper setup-quota failed ; else echo snapper setup-quota not used ; fi' )
SSH_ROOT_PASSWORD='rear'
USE_DHCLIENT="yes"

# usr/sbin/rear -D mkrescue
...
Using build area: /var/tmp/rear.9suWIs5VRXA4OhL
...
Running 'rescue' stage ======================
Creating recovery system root filesystem skeleton layout
Adding 'console=ttyS1,9600n8' to KERNEL_CMDLINE
Adding 'console=ttyS3' to KERNEL_CMDLINE
Adding 'console=tty0' to KERNEL_CMDLINE
Handling network interface 'eth0'
eth0 is a physical device
Handled network interface 'eth0'
Skipping 'lo': not bound to any physical interface.
skipping usr/share/rear/rescue/GNU/Linux/400_use_serial_console.sh
...

# find /var/tmp/rear.9suWIs5VRXA4OhL -xdev -type f | xargs grep 'console=ttyS1,9600n8'
...
/var/tmp/rear.9suWIs5VRXA4OhL/tmp/isofs/isolinux/isolinux.cfg:
append initrd=initrd.cgz root=/dev/ram0 vga=normal rw  selinux=0 console=ttyS1,9600n8 console=ttyS3 console=tty0
/var/tmp/rear.9suWIs5VRXA4OhL/tmp/isofs/isolinux/isolinux.cfg:
append initrd=initrd.cgz root=/dev/ram0 vga=normal rw  selinux=0 console=ttyS1,9600n8 console=ttyS3 console=tty0 auto_recover
</code></pre>
<p>Excerpt from the ReaR log file:</p>
<pre><code>+ source /root/rear.github.master/usr/share/rear/prep/GNU/Linux/200_include_serial_console.sh
...
+++ cat /proc/cmdline
++ for kernel_option in $( cat /proc/cmdline )
++ test BOOT_IMAGE = console
++ for kernel_option in $( cat /proc/cmdline )
++ test root = console
++ for kernel_option in $( cat /proc/cmdline )
++ test console = console
++ USE_SERIAL_CONSOLE=yes
++ COPY_KERNEL_PARAMETERS+=(console)
++ break
+ source_return_code=0
</code></pre>
<p>ReaR recovery system on replacement hardware/VM:</p>
<pre><code>RESCUE localhost:~ # dmesg | grep console
[    0.000000] Command line: initrd=initrd.cgz root=/dev/ram0 vga=normal rw  selinux=0 console=ttyS1,9600n8 console=ttyS3 console=tty0 debug BOOT_IMAGE=kernel 
[    0.147923] Kernel command line: initrd=initrd.cgz root=/dev/ram0 vga=normal rw  selinux=0 console=ttyS1,9600n8 console=ttyS3 console=tty0 debug BOOT_IMAGE=kernel 
[    0.278021] printk: console [tty0] enabled
[    0.398808] printk: console [ttyS1] enabled
[    5.186534] qxl 0000:00:02.0: vgaarb: deactivate vga console
</code></pre>
<p>All recovery system startup messages appear for me<br />
so the new default behaviour seems in particular to fix<br />
<a href="https://github.com/rear/rear/issues/2843">https://github.com/rear/rear/issues/2843</a></p>
<p>I will verify this in a second test where I do not use<br />
any kernel 'console' command line options...</p>
<h4 id="jsmeix_commented_at_2023-03-29_1126"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2961#issuecomment-1488420876">2023-03-29 11:26</a>:<a class="headerlink" href="#jsmeix_commented_at_2023-03-29_1126" title="Permanent link">&para;</a></h4>
<p>Second test where I do not use<br />
any kernel 'console' command line options<br />
on the original system:</p>
<pre><code># dmesg | egrep 'Kernel command line|console'
[    0.149486] Kernel command line: BOOT_IMAGE=/boot/vmlinuz-5.3.18-57-default root=/dev/mapper/system-root resume=/dev/system/swap crashkernel=203M,high mitigations=off
[    0.173618] printk: console [tty0] enabled
[    5.807052] qxl 0000:00:02.0: vgaarb: deactivate vga console

# usr/sbin/rear -D mkrescue
...
Using build area: /var/tmp/rear.Vdrk58sZjJRSsc9
...

# grep 'root=' /var/tmp/rear.Vdrk58sZjJRSsc9/tmp/isofs/isolinux/isolinux.cfg
append initrd=initrd.cgz root=/dev/ram0 vga=normal rw  selinux=0
append initrd=initrd.cgz root=/dev/ram0 vga=normal rw  selinux=0 auto_recover
</code></pre>
<p>so there is also no kernel 'console' command line option set<br />
for the ReaR recovery system.</p>
<p>Excerpt from the ReaR log file:</p>
<pre><code>+ source /root/rear.github.master/usr/share/rear/prep/GNU/Linux/200_include_serial_console.sh
...
+++ cat /proc/cmdline
++ for kernel_option in $( cat /proc/cmdline )
++ test BOOT_IMAGE = console
++ for kernel_option in $( cat /proc/cmdline )
++ test root = console
++ for kernel_option in $( cat /proc/cmdline )
++ test resume = console
++ for kernel_option in $( cat /proc/cmdline )
++ test crashkernel = console
++ for kernel_option in $( cat /proc/cmdline )
++ test mitigations = console
+ source_return_code=0
</code></pre>
<p>ReaR recovery system on replacement hardware/VM:</p>
<pre><code>RESCUE localhost:~ # dmesg | egrep 'Kernel command line|console'
[    0.132793] Kernel command line: initrd=initrd.cgz root=/dev/ram0 vga=normal rw  selinux=0 BOOT_IMAGE=kernel 
[    0.216293] printk: console [tty0] enabled
[    4.087957] qxl 0000:00:02.0: vgaarb: deactivate vga console
</code></pre>
<p>All recovery system startup messages appear for me<br />
so the new default behaviour fixes<br />
<a href="https://github.com/rear/rear/issues/2843">https://github.com/rear/rear/issues/2843</a><br />
in particular when no kernel 'console' command line options<br />
are used on the original system.</p>
<h4 id="jsmeix_commented_at_2023-04-24_0557"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2961#issuecomment-1519423651">2023-04-24 05:57</a>:<a class="headerlink" href="#jsmeix_commented_at_2023-04-24_0557" title="Permanent link">&para;</a></h4>
<p>This pull request is currently in a not yet finished sate.<br />
I was interrupted to work on this one by other things.<br />
I will continue here as time permits.</p>
<h4 id="schlomo_commented_at_2023-04-24_0700"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/2961#issuecomment-1519494732">2023-04-24 07:00</a>:<a class="headerlink" href="#schlomo_commented_at_2023-04-24_0700" title="Permanent link">&para;</a></h4>
<p>Ah, sorry. Please kindly set it to <a href="https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/proposing-changes-to-your-work-with-pull-requests/changing-the-stage-of-a-pull-request">draft
mode</a>
for everybody to see the not-yet-ready state right away.</p>
<h4 id="jsmeix_commented_at_2023-04-24_0729"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2961#issuecomment-1519533932">2023-04-24 07:29</a>:<a class="headerlink" href="#jsmeix_commented_at_2023-04-24_0729" title="Permanent link">&para;</a></h4>
<p>@schlomo<br />
thank you for the link to the matching GitHub documentation!<br />
(I had noticed that "convert to draft" button since some time<br />
but never found time to find out what that actually means.)</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2022 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2023-03-28.2961.pr.open.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
