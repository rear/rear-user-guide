<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#2504 PR merged: Add initial LUKS2 support - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#2504 PR merged: Add initial LUKS2 support";
        var mkdocs_page_input_path = "issues/2020-10-20.2504.pr.merged.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/backup_netfs.html">Example of BACKUP=NETFS</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear28.html">Release Notes ReaR 2.8</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#2504 PR merged: Add initial LUKS2 support</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="2504_pr_merged_add_initial_luks2_support"><a href="https://github.com/rear/rear/pull/2504">#2504 PR</a> <code>merged</code>: Add initial LUKS2 support<a class="headerlink" href="#2504_pr_merged_add_initial_luks2_support" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>enhancement</code>, <code>fixed / solved / done</code></p>
<h4 id="vcrhonek_opened_issue_at_2020-10-20_1215"><img src="https://avatars.githubusercontent.com/u/3899106?v=4" width="50"><a href="https://github.com/vcrhonek">vcrhonek</a> opened issue at <a href="https://github.com/rear/rear/pull/2504">2020-10-20 12:15</a>:<a class="headerlink" href="#vcrhonek_opened_issue_at_2020-10-20_1215" title="Permanent link">&para;</a></h4>
<h4 id="relax-and-recover_rear_pull_request_template">Relax-and-Recover (ReaR) Pull Request Template<a class="headerlink" href="#relax-and-recover_rear_pull_request_template" title="Permanent link">&para;</a></h4>
<p>Please fill in the following items before submitting a new pull request:</p>
<h5 id="pull_request_details">Pull Request Details:<a class="headerlink" href="#pull_request_details" title="Permanent link">&para;</a></h5>
<ul>
<li>
<p>Type: <strong>Bug Fix</strong> / <strong>New Feature</strong> / <strong>Enhancement</strong> / <strong>Other?</strong><br />
    Enhancement.</p>
</li>
<li>
<p>Impact: <strong>Low</strong> / <strong>Normal</strong> / <strong>High</strong> / <strong>Critical</strong> /
    <strong>Urgent</strong><br />
    Normal.</p>
</li>
<li>
<p>Reference to related issue (URL):<br />
<a href="https://github.com/rear/rear/issues/2204">https://github.com/rear/rear/issues/2204</a></p>
</li>
<li>
<p>How was this pull request tested?<br />
    Quite thoroughly. I've run many backup followed by recover tests on
    Fedora 32, RHEL 8.2 and Fedora 25 (because there is LUKS1 by default
    on f25). I didn't notice any issues when I used default encryption
    during install of the system. I've also tried various
    ciphers/key-sizes/hash variants to ensure that values given by
    luksDump parsing on LUKS2 are meaningful and to recreating LUKS1 on
    system where LUKS2 is default and vice versa.</p>
</li>
<li>
<p>Brief description of the changes in this pull request:<br />
    a) it adds new parameter 'type' to 'crypt' keyword used in
    disklayout.conf. Using this parameter allows to recreate the same
    version of LUKS that was on the system<br />
    b) it adds LUKS version detection, parsing depending on version and
    usage of 'type' parameter have been added to<br />
    /usr/share/rear/layout/save/GNU/Linux/260_crypt_layout.sh</p>
</li>
</ul>
<p>I'm aware that this is useful mainly for basic LUKS2 setup (let's say
similar to LUKS1), but I believe that even so it could be sufficient for
many users.</p>
<p>And I wonder... wouldn't be better to backup and restore complete LUKS
header instead of taking values from luksDump and creating new one? That
would simplify things a lot and, for example, users won't lose keys from
additional keyslots, ...</p>
<h4 id="jsmeix_commented_at_2020-10-20_1234"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2504#issuecomment-712816599">2020-10-20 12:34</a>:<a class="headerlink" href="#jsmeix_commented_at_2020-10-20_1234" title="Permanent link">&para;</a></h4>
<p>@vcrhonek<br />
wow! Thank you!<br />
We will have a look...</p>
<h4 id="gdha_commented_at_2020-10-21_0827"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/pull/2504#issuecomment-713401115">2020-10-21 08:27</a>:<a class="headerlink" href="#gdha_commented_at_2020-10-21_0827" title="Permanent link">&para;</a></h4>
<p>@vcrhonek @jsmeix Do not bother with RHEL/CentOS 6 as it is End-of-Life
(EOL) anyhow. In Rear 2.7 we will mark it that way.</p>
<h4 id="jsmeix_commented_at_2020-10-23_1309"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2504#issuecomment-715330581">2020-10-23 13:09</a>:<a class="headerlink" href="#jsmeix_commented_at_2020-10-23_1309" title="Permanent link">&para;</a></h4>
<p>@gdha<br />
please could you add a new initial <code>release-notes-2-7.md</code> to<br />
<a href="https://github.com/rear/rear.github.com/tree/master/documentation">https://github.com/rear/rear.github.com/tree/master/documentation</a><br />
so that I could adapt the "Supported and Unsupported Operating Systems"
section<br />
for ReaR 2.7 right now?</p>
<h4 id="jsmeix_commented_at_2020-10-23_1310"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2504#issuecomment-715331235">2020-10-23 13:10</a>:<a class="headerlink" href="#jsmeix_commented_at_2020-10-23_1310" title="Permanent link">&para;</a></h4>
<p>@vcrhonek<br />
I committed some fixes to your code that hopefully do what I intend.<br />
Could you please test if things still work OK for you with my changes?</p>
<h4 id="vcrhonek_commented_at_2020-10-26_0753"><img src="https://avatars.githubusercontent.com/u/3899106?v=4" width="50"><a href="https://github.com/vcrhonek">vcrhonek</a> commented at <a href="https://github.com/rear/rear/pull/2504#issuecomment-716376702">2020-10-26 07:53</a>:<a class="headerlink" href="#vcrhonek_commented_at_2020-10-26_0753" title="Permanent link">&para;</a></h4>
<p>@jsmeix<br />
Thank you for improvement of the code, it looks good. Sure, I'll do some
tests and let you know.</p>
<h4 id="vcrhonek_commented_at_2020-10-26_1259"><img src="https://avatars.githubusercontent.com/u/3899106?v=4" width="50"><a href="https://github.com/vcrhonek">vcrhonek</a> commented at <a href="https://github.com/rear/rear/pull/2504#issuecomment-716529445">2020-10-26 12:59</a>:<a class="headerlink" href="#vcrhonek_commented_at_2020-10-26_1259" title="Permanent link">&para;</a></h4>
<p>I've tested and your changes and it works fine, no problem there. But
I've found different issue that emerged when multiple keys were defined
in LUKS header (this is not done by system installer by default, that's
main reason why I've missed it before). I fixed that with additional
commit.</p>
<h4 id="jsmeix_commented_at_2020-10-26_1303"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2504#issuecomment-716531837">2020-10-26 13:03</a>:<a class="headerlink" href="#jsmeix_commented_at_2020-10-26_1303" title="Permanent link">&para;</a></h4>
<p>@vcrhonek<br />
thank you for testing it!</p>
<h4 id="jsmeix_commented_at_2020-10-26_1305"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2504#issuecomment-716533004">2020-10-26 13:05</a>:<a class="headerlink" href="#jsmeix_commented_at_2020-10-26_1305" title="Permanent link">&para;</a></h4>
<p>@rear/contributors<br />
if there are no objections I would like to merge it tomorrow afternoon<br />
so that users who use our current GitHub master code could test it<br />
and provide early feedback if issues appear for them.</p>
<h4 id="jsmeix_commented_at_2020-10-28_0859"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2504#issuecomment-717793693">2020-10-28 08:59</a>:<a class="headerlink" href="#jsmeix_commented_at_2020-10-28_0859" title="Permanent link">&para;</a></h4>
<p>Yesterday I found no time to merge is so I will merge it today
afternoon.</p>
<h4 id="jsmeix_commented_at_2020-10-28_1137"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2504#issuecomment-717876462">2020-10-28 11:37</a>:<a class="headerlink" href="#jsmeix_commented_at_2020-10-28_1137" title="Permanent link">&para;</a></h4>
<p>@vcrhonek<br />
thank you for adding initial LUKS2 support to ReaR!</p>
<p>Regarding your question in your initial entry (excerpts)</p>
<pre><code>backup and restore complete LUKS header
users won't lose keys from additional keyslots
</code></pre>
<p>In general the ReaR recovery system must be free of secrets<br />
except the user has explicitly configured something different,<br />
cf. the reasoning about SSH_UNPROTECTED_PRIVATE_KEYS in
default.conf<br />
<a href="https://github.com/rear/rear/blob/master/usr/share/rear/conf/default.conf#L1523">https://github.com/rear/rear/blob/master/usr/share/rear/conf/default.conf#L1523</a></p>
<p>I don't know about LUKS internals so I don't know if complete LUKS
headers<br />
in the ReaR recovery system could contain secrets or could be used<br />
by someone to extract keys relatively easily (e.g. like getting
/etc/shadow<br />
from a host so one could do long running cracking attempts to get
passwords).</p>
<h4 id="vcrhonek_commented_at_2020-10-29_0802"><img src="https://avatars.githubusercontent.com/u/3899106?v=4" width="50"><a href="https://github.com/vcrhonek">vcrhonek</a> commented at <a href="https://github.com/rear/rear/pull/2504#issuecomment-718453591">2020-10-29 08:02</a>:<a class="headerlink" href="#vcrhonek_commented_at_2020-10-29_0802" title="Permanent link">&para;</a></h4>
<p>@jsmeix<br />
You're welcome, thank you for your review and improvements!</p>
<p>I see. I don't know much about LUKS internals either. Most of the header
is encrypted, but I'm afraid that if someone has copy of it, keys from
the header could be used to access the data even if these keys are no
longer valid (were removed in more recent version of header). I can ask
LUKS experts.</p>
<p>I was thinking to introduce LUKS_HEADER_RESTORE variable that would
(when explicitly configured by user) cause usage of
luksHeaderBackup/Restore instead of calling luksFormat. I did few tests
and it seems to work fine. Please let me know if you think that it would
be beneficial, I can contribute the code.</p>
<h4 id="jsmeix_commented_at_2020-10-29_1217"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2504#issuecomment-718715253">2020-10-29 12:17</a>:<a class="headerlink" href="#jsmeix_commented_at_2020-10-29_1217" title="Permanent link">&para;</a></h4>
<p>Regarding <code>cryptsetup luksHeaderBackup</code> and
<code>cryptsetup luksHeaderRestore</code><br />
the cryptsetup man page (from cryptsetup-2.0.6 in my case) describes it
perfectly:</p>
<pre><code>luksHeaderBackup &lt;device&gt; --header-backup-file &lt;file&gt;

Stores a binary backup of the LUKS header and keyslot area.
Note: Using '-' as filename writes the header backup to a file named '-'.
WARNING:
This backup file and a passphrase valid at the time of backup
allows decryption of the LUKS data area, even if the passphrase
was later changed or removed from the LUKS device.
Also note that with a header backup you lose the ability to securely
wipe the LUKS device by just overwriting the header and key-slots.
You either need to securely erase all header backups in addition
or overwrite the encrypted data area as well. The second option
is less secure, as some sectors can survive, e.g. due to defect
management.
</code></pre>
<p>I appreciate to introduce a new LUKS_HEADER_RESTORE config variable<br />
that is well described in default.conf (including the information about
possible<br />
security issues with header backup files in ReaR recovery system ISOs or
media)<br />
and which of course must not be enabled by default.</p>
<p>So I look forward to your subsequent pull requests to further improve
LUKS support in ReaR.</p>
<h4 id="jsmeix_commented_at_2020-10-29_1246"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2504#issuecomment-718729198">2020-10-29 12:46</a>:<a class="headerlink" href="#jsmeix_commented_at_2020-10-29_1246" title="Permanent link">&para;</a></h4>
<p>@vcrhonek<br />
it seems for me the current LUKS2 support does not work as intended.<br />
Currently I use cryptsetup version 2.0.6 on openSUSE Leap 15.1.<br />
For my LUKS2 volume <code>cryptsetup luksDump /dev/sda8</code> shows</p>
<pre><code>LUKS header information
Version:        2
Epoch:          3
Metadata area:  12288 bytes
UUID:           3e874a28-7415-4f8c-9757-b3f28a96c4d2
Label:          (no label)
Subsystem:      (no subsystem)
Flags:          (no flags)

Data segments:
  0: crypt
        offset: 4194304 [bytes]
        length: (whole device)
        cipher: aes-xts-plain64
        sector: 512 [bytes]

Keyslots:
  0: luks2
        Key:        256 bits
        Priority:   normal
        Cipher:     aes-xts-plain64
        PBKDF:      argon2i
        Time cost:  4
        Memory:     1048576
        Threads:    4
        Salt:       49 ea e2 52 22 bd 24 72 2f 88 cf 5f 2a e4 03 76 
                    e1 56 1f d9 dc 0c 41 f8 56 7c c4 26 95 63 4b 86 
        AF stripes: 4000
        Area offset:32768 [bytes]
        Area length:131072 [bytes]
        Digest ID:  0
Tokens:
Digests:
  0: pbkdf2
        Hash:       sha256
        Iterations: 130290
        Salt:       9d 14 ba 51 40 ea ee 79 1d 19 32 0a ee a3 dc 41 
                    2d 1e 50 e3 52 17 ef 1b 2f b5 97 8c 1d 77 ae c6 
        Digest:     fd a5 8f f0 7e d4 77 86 06 b9 db e1 3c 09 73 87 
                    4c 06 6f b4 8c 4e 9a 2a 29 05 2e 4b 0f aa f7 53
</code></pre>
<p>where the currect code cannot determine the <code>key_size</code> value<br />
because nothing matches <code>grep -m 1 "Cipher key"</code><br />
and therefore I get in my disklayout.conf</p>
<pre><code>crypt /dev/mapper/luks2test /dev/sda8 type=luks2 cipher=aes-xts-plain64 key_size= hash=sha256 uuid=3e874a28-7415-4f8c-9757-b3f28a96c4d2
</code></pre>
<p>I think in my case the right command would be</p>
<pre><code># cryptsetup luksDump /dev/sda8 | grep -m 1 "Key:" | sed -r 's/^.+:\s*(.+) bits$/\1/'
256
</code></pre>
<p>The actual problem with the current code is not that it fails<br />
to parse particular kind of <code>cryptsetup luksDump</code> output.</p>
<p>The actual problem with the current code is that it does not care<br />
when it failed to parse the <code>cryptsetup luksDump</code> output.</p>
<p>This is a general problem with so much code in ReaR<br />
(in particular almost all older code in ReaR is made this way)<br />
that it more or less carelessly and blindly proceeds and does not care<br />
about possible errors, cf. "Try hard to care about possible errors" in<br />
<a href="https://github.com/rear/rear/wiki/Coding-Style">https://github.com/rear/rear/wiki/Coding-Style</a></p>
<p>In this particular case one would have to check what option values<br />
of the <code>crypt</code> entries in disklayout.conf are needed and for those<br />
there must be basic tests that check whether or not the values<br />
are at least of basically right syntax - e.g. the <code>key_size</code> value<br />
should be a positive integer (that is a multiple of 8),<br />
cf. "man cryptsetup"</p>
<pre><code>--key-size, -s &lt;bits&gt;
Sets key size in bits. The argument has to be a multiple of 8.
The possible key-sizes are limited by the cipher and mode used.
See /proc/crypto for more information.
Note that key-size in /proc/crypto is stated in bytes.
</code></pre>
<p>I think it is over the top to verify the <code>key_size</code> value with
/proc/crypto<br />
and even a test that it is a multiple of 8 is probably not really
needed<br />
to check if the <code>key_size</code> value seems to be OK.</p>
<p>But I think at least something like</p>
<pre><code>is_positive_integer $key_size || Error "..."
</code></pre>
<p>should really be added to avoid bad surprises for the user.</p>
<p>This is all based on the assumption that with the code in<br />
usr/share/rear/layout/prepare/GNU/Linux/160_include_luks_code.sh</p>
<pre><code>        case "$key" in
...
            key_size)
                cryptsetup_options+=" --key-size $value"
                ;;
</code></pre>
<p>a command like <code>cryptsetup ... --key-size --hash ...</code> with empty
key-size value<br />
would let disaster recovery with ReaR fail for the user during "rear
recover".</p>
<h4 id="vcrhonek_commented_at_2020-10-29_1306"><img src="https://avatars.githubusercontent.com/u/3899106?v=4" width="50"><a href="https://github.com/vcrhonek">vcrhonek</a> commented at <a href="https://github.com/rear/rear/pull/2504#issuecomment-718740063">2020-10-29 13:06</a>:<a class="headerlink" href="#vcrhonek_commented_at_2020-10-29_1306" title="Permanent link">&para;</a></h4>
<p>@jsmeix<br />
For my LUKS2 volume it shows:</p>
<pre><code>LUKS header information
Version:        2
Epoch:          3
Metadata area:  16384 [bytes]
Keyslots area:  16744448 [bytes]
UUID:           d3b16848-f4db-4488-9613-19796246175b
Label:          (no label)
Subsystem:      (no subsystem)
Flags:          (no flags)

Data segments:
  0: crypt
        offset: 16777216 [bytes]
        length: (whole device)
        cipher: aes-xts-plain64
        sector: 512 [bytes]

Keyslots:
  0: luks2
        Key:        512 bits
        Priority:   normal
        Cipher:     aes-xts-plain64
        Cipher key: 512 bits
        PBKDF:      argon2i
        Time cost:  4
        Memory:     1013640
        Threads:    2
        Salt:       74 ab 9e 54 e8 5d 1e 80 a2 02 27 eb c9 f1 d3 7c 
                    0d 97 bf 1b ff 4f ea ce ea ca 49 79 26 89 6a 9f 
        AF stripes: 4000
        AF hash:    sha256
        Area offset:32768 [bytes]
        Area length:258048 [bytes]
        Digest ID:  0
Tokens:
Digests:
  0: pbkdf2
        Hash:       sha256
        Iterations: 132129
        Salt:       1d c8 23 71 e3 7c 92 69 3a 55 61 13 b4 99 6a 4a 
                    19 a5 ca 40 a5 d4 d5 ed fd e4 9c cd 2b 94 b8 44 
        Digest:     54 1e 22 95 9c 58 57 cd b8 90 60 6d 54 a9 37 52 
                    e8 57 32 46 4a 5a e7 46 60 a3 59 fd e7 40 b3 76
</code></pre>
<p>I get both 'Key' and 'Cipher key' in header with identical values no
matter what I pass to luksFormat. I wasn't able to find good description
of the fields so I've chosen the second one. It seems your command is
better choice.</p>
<p>Yes, I agree with you, adding checks for correctness of parameters is
really needed.</p>
<h4 id="jsmeix_commented_at_2020-10-29_1445"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2504#issuecomment-718801166">2020-10-29 14:45</a>:<a class="headerlink" href="#jsmeix_commented_at_2020-10-29_1445" title="Permanent link">&para;</a></h4>
<p>@vcrhonek<br />
thank you so much for all your improvement work<br />
that make this old code better and more fail-safe.</p>
<h4 id="jsmeix_commented_at_2020-10-29_1447"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2504#issuecomment-718802499">2020-10-29 14:47</a>:<a class="headerlink" href="#jsmeix_commented_at_2020-10-29_1447" title="Permanent link">&para;</a></h4>
<p>And this example is a good reason why
<code>cryptsetup luksHeaderBackup / luksHeaderRestore</code><br />
has advantages (for the price of being possibly less secure depending on
the user's environment).</p>
<h4 id="jsmeix_commented_at_2020-10-30_1044"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2504#issuecomment-719479724">2020-10-30 10:44</a>:<a class="headerlink" href="#jsmeix_commented_at_2020-10-30_1044" title="Permanent link">&para;</a></h4>
<p>I verified that things fail for me as I described above in<br />
<a href="https://github.com/rear/rear/pull/2504#issuecomment-718729198">https://github.com/rear/rear/pull/2504#issuecomment-718729198</a></p>
<p>With current GitHub master code I get<br />
for <code>rear -D recover</code> this terminal output (excerpts)</p>
<pre><code>Please enter the password for LUKS device luks2test (/dev/sdb2):
...
The disk layout recreation script failed
</code></pre>
<p>This is the matching excerpt from the log file<br />
about the actual failure in /var/lib/rear/layout/diskrestore.sh<br />
(long lines shown wrapped here):</p>
<pre><code>+++ Print 'Please enter the password for LUKS device luks2test (/dev/sdb2):'
+++ cryptsetup luksFormat --batch-mode --type luks2 --cipher aes-xts-plain64
 --key-size --hash sha256 --uuid 30376f43-60fd-4fc7-af0c-fad8063d5a1a
 --iter-time 2000 --use-random --force-password /dev/sdb2
Usage: cryptsetup [-?vyrq] [-?|--help] [--usage] [--version] [-v|--verbose]
        [--debug] [-c|--cipher=STRING] [-h|--hash=STRING]
        [-y|--verify-passphrase] [-d|--key-file=STRING]
        [--master-key-file=STRING] [--dump-master-key] [-s|--key-size=BITS]
        [-l|--keyfile-size=bytes] [--keyfile-offset=bytes]
        [--new-keyfile-size=bytes] [--new-keyfile-offset=bytes]
        [-S|--key-slot=INT] [-b|--size=SECTORS] [-o|--offset=SECTORS]
        [-p|--skip=SECTORS] [-r|--readonly] [-q|--batch-mode]
        [-t|--timeout=secs] [--progress-frequency=secs] [-T|--tries=INT]
        [--align-payload=SECTORS] [--header-backup-file=STRING]
        [--use-random] [--use-urandom] [--shared] [--uuid=STRING]
        [--allow-discards] [--header=STRING] [--test-passphrase]
        [--tcrypt-hidden] [--tcrypt-system] [--tcrypt-backup] [--veracrypt]
        [--veracrypt-pim=INT] [--veracrypt-query-pim] [-M|--type=STRING]
        [--force-password] [--perf-same_cpu_crypt]
        [--perf-submit_from_crypt_cpus] [--deferred] [-i|--iter-time=msecs]
        [--pbkdf=STRING] [--pbkdf-memory=kilobytes]
        [--pbkdf-parallel=threads] [--pbkdf-force-iterations=LONG]
        [--priority=STRING] [--disable-locks] [--disable-keyring]
        [-I|--integrity=STRING] [--integrity-no-journal]
        [--integrity-no-wipe] [--token-only] [--token-id=INT]
        [--key-description=STRING] [--sector-size=INT] [--persistent]
        [--label=STRING] [--subsystem=STRING] [--unbound]
        [--json-file=STRING] [OPTION...] &lt;action&gt; &lt;action-specific&gt;
--hash: invalid numeric value
</code></pre>
<p>I have <code>LUKS_CRYPTSETUP_OPTIONS+=" --force-password"</code> in my
etc/rear/local.conf<br />
(for the reason see the LUKS_CRYPTSETUP_OPTIONS comments in
default.conf).</p>
<p>/var/lib/rear/layout/diskrestore.sh runs with <code>set -e</code> - cf. the log
(excerpts)</p>
<pre><code>+ source /usr/share/rear/layout/recreate/default/200_run_layout_code.sh
...
++ source /var/lib/rear/layout/diskrestore.sh
+++ LogPrint 'Start system layout restoration.'
...
+++ set -e
+++ set -x
</code></pre>
<p>so any non-zero exit code in diskrestore.sh results<br />
that <code>The disk layout recreation script failed</code>.</p>
<p>/var/lib/rear/layout/diskrestore.sh is generated only during
<code>rear recover</code> by this script:<br />
<a href="https://github.com/rear/rear/blob/master/usr/share/rear/layout/prepare/default/540_generate_device_code.sh">https://github.com/rear/rear/blob/master/usr/share/rear/layout/prepare/default/540_generate_device_code.sh</a></p>
<h4 id="jsmeix_commented_at_2020-10-30_1052"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2504#issuecomment-719483077">2020-10-30 10:52</a>:<a class="headerlink" href="#jsmeix_commented_at_2020-10-30_1052" title="Permanent link">&para;</a></h4>
<p>With
<a href="https://github.com/rear/rear/commit/b49a4fc88eeb5a2f065c1109c9219d2fcf76e749">https://github.com/rear/rear/commit/b49a4fc88eeb5a2f065c1109c9219d2fcf76e749</a><br />
LUKS2 support does now also work with cryptsetup version 2.0.6<br />
(at least it works now for me on openSUSE Leap 15.1).</p>
<p>According to<br />
<a href="https://github.com/rear/rear/pull/2504#issuecomment-718740063">https://github.com/rear/rear/pull/2504#issuecomment-718740063</a><br />
it should still work for the systems that @vcrhonek has.</p>
<p>@vcrhonek<br />
please verify that current GitHub master code still works for your
systems.<br />
Cf. "Testing current ReaR upstream GitHub master code" in<br />
<a href="https://en.opensuse.org/SDB:Disaster_Recovery">https://en.opensuse.org/SDB:Disaster_Recovery</a></p>
<h4 id="jsmeix_commented_at_2020-10-30_1133"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2504#issuecomment-719501370">2020-10-30 11:33</a>:<a class="headerlink" href="#jsmeix_commented_at_2020-10-30_1133" title="Permanent link">&para;</a></h4>
<p>@mannp @adatum<br />
I would appreciate it when you could test if our LUKS2 support<br />
in our current GitHub master code also works on your systems<br />
cf. "Testing current ReaR upstream GitHub master code" in<br />
<a href="https://en.opensuse.org/SDB:Disaster_Recovery">https://en.opensuse.org/SDB:Disaster_Recovery</a><br />
and provide feedback here whether or not things work for you.</p>
<h4 id="mannp_commented_at_2020-10-30_1159"><img src="https://avatars.githubusercontent.com/u/4335298?u=0cf0e58f6aee4021f1e92cb4a401affd672fd05e&v=4" width="50"><a href="https://github.com/mannp">mannp</a> commented at <a href="https://github.com/rear/rear/pull/2504#issuecomment-719511846">2020-10-30 11:59</a>:<a class="headerlink" href="#mannp_commented_at_2020-10-30_1159" title="Permanent link">&para;</a></h4>
<blockquote>
<p>@mannp @adatum<br />
I would appreciate it when you could test if our LUKS2 support<br />
in our current GitHub master code also works on your systems<br />
cf. "Testing current ReaR upstream GitHub master code" in<br />
<a href="https://en.opensuse.org/SDB:Disaster_Recovery">https://en.opensuse.org/SDB:Disaster_Recovery</a><br />
and provide feedback here whether or not things work for you.</p>
</blockquote>
<p>@jsmeix I was very happy to see the merge for LUKS2 support and
installed the git version of rear to give it a try yesterday.</p>
<p>Got sidetracked, but will set aside some time to give it a try :)</p>
<h4 id="jsmeix_commented_at_2020-10-30_1235"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2504#issuecomment-719526968">2020-10-30 12:35</a>:<a class="headerlink" href="#jsmeix_commented_at_2020-10-30_1235" title="Permanent link">&para;</a></h4>
<p>@mannp<br />
depending on what cryptsetup version you run you may need<br />
<a href="https://github.com/rear/rear/commit/b49a4fc88eeb5a2f065c1109c9219d2fcf76e749">https://github.com/rear/rear/commit/b49a4fc88eeb5a2f065c1109c9219d2fcf76e749</a><br />
which is in the GitHub master code of today.</p>
<p>So I would recommend to better update again to our current GitHub master
code.</p>
<p>Perhaps you even use a cryptsetup version where my<br />
<a href="https://github.com/rear/rear/commit/b49a4fc88eeb5a2f065c1109c9219d2fcf76e749">https://github.com/rear/rear/commit/b49a4fc88eeb5a2f065c1109c9219d2fcf76e749</a><br />
does not work and then we would like to know such issues better sooner
than later<br />
so that we could make LUKS2 support working with all usual cryptsetup
versions.</p>
<h4 id="jsmeix_commented_at_2020-10-30_1433"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2504#issuecomment-719588026">2020-10-30 14:33</a>:<a class="headerlink" href="#jsmeix_commented_at_2020-10-30_1433" title="Permanent link">&para;</a></h4>
<p>With<br />
<a href="https://github.com/rear/rear/commit/d25a1a09dddcbffda802081ea3553c70f9a49c23">https://github.com/rear/rear/commit/d25a1a09dddcbffda802081ea3553c70f9a49c23</a><br />
I added basic checks to layout/save/GNU/Linux/260_crypt_layout.sh<br />
that the <code>cipher</code> <code>key_size</code> <code>hash</code> <code>uuid</code> values exist.</p>
<p>For me things still work well with that checks.</p>
<p>With artificial causing such errors via</p>
<pre><code>    fi

    key_size=""
    uuid="  "

    if ! test $cipher ; then
</code></pre>
<p>in usr/share/rear/layout/save/GNU/Linux/260_crypt_layout.sh<br />
"rear -D mkrescue" fails for me with this terminal output:</p>
<pre><code># usr/sbin/rear -D mkrescue
...
Creating disk layout
Overwriting existing disk layout file /root/rear.github.master/var/lib/rear/layout/disklayout.conf
Error: No 'key_size' value for LUKS volume cr_ata-TOSHIBA_MQ01ABF050_Y2PLP02CT-part3 in /dev/sda3
Error: No 'uuid' value for LUKS volume cr_ata-TOSHIBA_MQ01ABF050_Y2PLP02CT-part3 in /dev/sda3
Error: No 'key_size' value for LUKS volume luks1test in /dev/sda7
Error: No 'uuid' value for LUKS volume luks1test in /dev/sda7
Error: No 'key_size' value for LUKS volume cr_ata-TOSHIBA_MQ01ABF050_Y2PLP02CT-part2 in /dev/sda2
Error: No 'uuid' value for LUKS volume cr_ata-TOSHIBA_MQ01ABF050_Y2PLP02CT-part2 in /dev/sda2
Error: No 'key_size' value for LUKS volume luks2test in /dev/sda8
Error: No 'uuid' value for LUKS volume luks2test in /dev/sda8
ERROR: Missing LUKS cryptsetup option value in /root/rear.github.master/var/lib/rear/layout/disklayout.conf
Some latest log messages since the last called script 260_crypt_layout.sh:
  2020-10-30 15:27:24.633752720 Error: No 'key_size' value for LUKS volume cr_ata-TOSHIBA_MQ01ABF050_Y2PLP02CT-part3 in /dev/sda3
  2020-10-30 15:27:24.635879887 Error: No 'uuid' value for LUKS volume cr_ata-TOSHIBA_MQ01ABF050_Y2PLP02CT-part3 in /dev/sda3
  2020-10-30 15:27:24.715283297 Error: No 'key_size' value for LUKS volume luks1test in /dev/sda7
  2020-10-30 15:27:24.718042920 Error: No 'uuid' value for LUKS volume luks1test in /dev/sda7
  2020-10-30 15:27:24.800718783 Error: No 'key_size' value for LUKS volume cr_ata-TOSHIBA_MQ01ABF050_Y2PLP02CT-part2 in /dev/sda2
  2020-10-30 15:27:24.804179315 Error: No 'uuid' value for LUKS volume cr_ata-TOSHIBA_MQ01ABF050_Y2PLP02CT-part2 in /dev/sda2
  2020-10-30 15:27:24.877678147 Error: No 'key_size' value for LUKS volume luks2test in /dev/sda8
  2020-10-30 15:27:24.880293752 Error: No 'uuid' value for LUKS volume luks2test in /dev/sda8
Aborting due to an error, check /root/rear.github.master/var/log/rear/rear-linux-h9wr.log for details
</code></pre>
<h4 id="jsmeix_commented_at_2020-10-30_1447"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2504#issuecomment-719596345">2020-10-30 14:47</a>:<a class="headerlink" href="#jsmeix_commented_at_2020-10-30_1447" title="Permanent link">&para;</a></h4>
<p>And on top of that via<br />
<a href="https://github.com/rear/rear/commit/d3e5d15a81536bdfbac43d166a17792d57f7a88b">https://github.com/rear/rear/commit/d3e5d15a81536bdfbac43d166a17792d57f7a88b</a><br />
I made nicer error message texts that contain the LUKS version (i.e.
'LUKS1' or 'LUKS2').<br />
Why not provide info to the user when it is there in ReaR.<br />
It can help him to better distinguish possibly various LUKS volumes that
he may have.</p>
<p>With that my above artificial causing such errors lets "rear -D
mkrescue" fail<br />
with the following messages on the terminal:</p>
<pre><code>Error: No 'key_size' value for LUKS1 volume cr_ata-TOSHIBA_MQ01ABF050_Y2PLP02CT-part3 in /dev/sda3
Error: No 'uuid' value for LUKS1 volume cr_ata-TOSHIBA_MQ01ABF050_Y2PLP02CT-part3 in /dev/sda3
Error: No 'key_size' value for LUKS1 volume luks1test in /dev/sda7
Error: No 'uuid' value for LUKS1 volume luks1test in /dev/sda7
Error: No 'key_size' value for LUKS1 volume cr_ata-TOSHIBA_MQ01ABF050_Y2PLP02CT-part2 in /dev/sda2
Error: No 'uuid' value for LUKS1 volume cr_ata-TOSHIBA_MQ01ABF050_Y2PLP02CT-part2 in /dev/sda2
Error: No 'key_size' value for LUKS2 volume luks2test in /dev/sda8
Error: No 'uuid' value for LUKS2 volume luks2test in /dev/sda8
ERROR: Missing LUKS cryptsetup option value(s) in /root/rear.github.master/var/lib/rear/layout/disklayout.conf
</code></pre>
<h4 id="mannp_commented_at_2020-10-30_1613"><img src="https://avatars.githubusercontent.com/u/4335298?u=0cf0e58f6aee4021f1e92cb4a401affd672fd05e&v=4" width="50"><a href="https://github.com/mannp">mannp</a> commented at <a href="https://github.com/rear/rear/pull/2504#issuecomment-719647500">2020-10-30 16:13</a>:<a class="headerlink" href="#mannp_commented_at_2020-10-30_1613" title="Permanent link">&para;</a></h4>
<p>@jsmeix I have not been using rear for a long time so need to configure
and test on a spare machine, so it will take me some time to get
together :)</p>
<p>I previously was using this on my main machines -&gt;
<a href="https://aur.archlinux.org/packages/relax-and-recover-git/">https://aur.archlinux.org/packages/relax-and-recover-git/</a><br />
<code>Relax-and-Recover 2.6 / Git</code><br />
Not sure if this pulls in your changes.</p>
<h4 id="vcrhonek_commented_at_2020-11-02_0909"><img src="https://avatars.githubusercontent.com/u/3899106?v=4" width="50"><a href="https://github.com/vcrhonek">vcrhonek</a> commented at <a href="https://github.com/rear/rear/pull/2504#issuecomment-720341023">2020-11-02 09:09</a>:<a class="headerlink" href="#vcrhonek_commented_at_2020-11-02_0909" title="Permanent link">&para;</a></h4>
<p>@jsmeix I've looked on recent updates and it looks good and works fine
on my test machines, thanks!</p>
<p>Have you considered omitting missing values instead of reporting error?
Because luksFormat doesn't require any of {cipher, key-size, hash} and
if omitted default value is used. Maybe it could omit missing option
value and print warning? I'm not saying that I think it would be better,
I guess that depends on situation and user preferences.</p>
<p>I was also thinking about 'Key:'/'Cipher key:" issue for second time. If
only 'Cipher key:' was present in luksDump, parsing would fail again. I
have no idea whether that can happen, to be honest. If that happens, we
can match both and use first found like
<code>grep -m1 -i "key:"  | sed -r 's/^.+:\s*(.+) bits$/\1/'</code>.</p>
<p>But overall, it looks good to me now and I'm looking forward to see
results on other setups and distributions.</p>
<h4 id="jsmeix_commented_at_2020-11-02_1111"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2504#issuecomment-720406065">2020-11-02 11:11</a>:<a class="headerlink" href="#jsmeix_commented_at_2020-11-02_1111" title="Permanent link">&para;</a></h4>
<p>@mannp<br />
to test the current GitHub master code on your system see<br />
"Testing current ReaR upstream GitHub master code" in<br />
<a href="https://en.opensuse.org/SDB:Disaster_Recovery">https://en.opensuse.org/SDB:Disaster_Recovery</a></p>
<p>That's what I do myself.</p>
<p>I don't know about whatever third-party ReaR packages.<br />
You would have to ask the third-party what their package provides.</p>
<h4 id="jsmeix_commented_at_2020-11-02_1130"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2504#issuecomment-720415813">2020-11-02 11:30</a>:<a class="headerlink" href="#jsmeix_commented_at_2020-11-02_1130" title="Permanent link">&para;</a></h4>
<p>@vcrhonek<br />
thank you for your sugestions how to further improve the LUKS code in
ReaR!</p>
<p>Currently LUKS support (both LUKS1 and LUKS2) is under step by step
enhancement<br />
i.e. none of my changes is meant to be an ultimate final state.</p>
<p>I just proceed little step by little step where each little step should
keep things working<br />
i.e. I try to not introduce regressions that let things fail that had
somehow worked before.</p>
<p>Because at any time a more important issue (e.g. a severe security issue
with SUSE<br />
software that I maintain) could appear that gets in my way to move
forward with ReaR<br />
so that I can enhance ReaR only little setp by little step where I can
pause at any time.</p>
<p>E.g. as long as the LUKS recreation code in
usr/share/rear/layout/prepare/<br />
and usr/share/rear/layout/recreate/ depends on cryptsetup option
values<br />
we must error out when the usr/share/rear/layout/save/ code fails to get
such values.</p>
<p>When the LUKS recreation code in layout/prepare/ was enhanced as a
precondition<br />
that it does no longer fail when certain optional cryptsetup option
values are missing<br />
then we could no longer error out when the layout/save/ code fails to
get such values.</p>
<p>Currently I have time to enhance the LUKS code so I will do some more
enhancements<br />
based on your suggestions (but again: only little step by little step).</p>
<h4 id="jsmeix_commented_at_2020-11-02_1239"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2504#issuecomment-720447297">2020-11-02 12:39</a>:<a class="headerlink" href="#jsmeix_commented_at_2020-11-02_1239" title="Permanent link">&para;</a></h4>
<p>Right now I see the documentation in<br />
<a href="https://github.com/rear/rear/blob/master/doc/user-guide/06-layout-configuration.adoc">https://github.com/rear/rear/blob/master/doc/user-guide/06-layout-configuration.adoc</a><br />
in the section about "Disk layout file syntax" the "LUKS Devices" part
is plain wrong<br />
(excerpts - long lines wrapped here):</p>
<pre><code>Square brackets "[" and "]" indicate an optional parameter.
They can be excluded when hand-crafting a layout file line.
...
LUKS Devices

crypt /dev/mapper/&lt;name&gt; &lt;device&gt; [type=&lt;type&gt;]
 [cipher=&lt;cipher&gt;] [key_size=&lt;key size&gt;] [hash=&lt;hash function&gt;]
 [uuid=&lt;uuid&gt;] [keyfile=&lt;keyfile&gt;] [password=&lt;password&gt;]
</code></pre>
<p>Actually with the current LUKS recreation code in<br />
layout/prepare/GNU/Linux/160_include_luks_code.sh<br />
only <code>keyfile=&lt;keyfile&gt;</code> and <code>password=&lt;password&gt;</code> are optional.</p>
<p>Fortunately nobody reads documenation so such errors are<br />
totally unimportant in real world practice out there ;-)</p>
<h4 id="jsmeix_commented_at_2020-11-02_1338"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2504#issuecomment-720477169">2020-11-02 13:38</a>:<a class="headerlink" href="#jsmeix_commented_at_2020-11-02_1338" title="Permanent link">&para;</a></h4>
<p><a href="https://github.com/rear/rear/pull/2506">https://github.com/rear/rear/pull/2506</a><br />
is my first initial currently untested attempt towards making<br />
recreating LUKS volumes work with optional cryptsetup options</p>
<h4 id="jsmeix_commented_at_2020-11-03_1332"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2504#issuecomment-721117530">2020-11-03 13:32</a>:<a class="headerlink" href="#jsmeix_commented_at_2020-11-03_1332" title="Permanent link">&para;</a></h4>
<p>@vcrhonek<br />
regarding your
<a href="https://github.com/rear/rear/pull/2504#issuecomment-720341023">https://github.com/rear/rear/pull/2504#issuecomment-720341023</a><br />
therein (excerpt)</p>
<pre><code>luksFormat doesn't require any of {cipher, key-size, hash}
and if omitted default value is used
</code></pre>
<p>Accordingly currently in
<a href="https://github.com/rear/rear/pull/2506">https://github.com/rear/rear/pull/2506</a><br />
the cryptsetup options <code>type=&lt;type&gt;</code> and <code>uuid=&lt;uuid&gt;</code><br />
are still mandatory but I wonder if that is really needed.</p>
<p>How I did set up a LUKS2 volume on a test VM was using plain</p>
<pre><code>cryptsetup luksFormat --type luks2 --force-password /dev/sdb2

cryptsetup luksOpen /dev/sdb2 luks2test

mkfs.ext4 /dev/mapper/luks2test

mkdir /luks2test

mount /dev/mapper/luks2test /luks2test
</code></pre>
<p>I need <code>--force-password</code> only because I use weak test passwords.</p>
<p>According to "man cryptsetup"</p>
<pre><code>    luksFormat &lt;device&gt; [&lt;key file&gt;]
</code></pre>
<p>the <code>&lt;device&gt;</code> is the only mandatory parameter for
<code>cryptseup luksFormat</code>.</p>
<p>So I think we should handle all options optionally in <code>crypt</code> entries in
disklayout.conf<br />
except <code>/dev/mapper/&lt;name&gt;</code> and <code>&lt;device&gt;</code><br />
because <code>&lt;device&gt;</code> is mandatory for <code>cryptsetup</code><br />
and <code>/dev/mapper/&lt;name&gt;</code> is mandatory for <code>mkfs</code>.</p>
<h4 id="vcrhonek_commented_at_2020-11-03_1400"><img src="https://avatars.githubusercontent.com/u/3899106?v=4" width="50"><a href="https://github.com/vcrhonek">vcrhonek</a> commented at <a href="https://github.com/rear/rear/pull/2504#issuecomment-721133232">2020-11-03 14:00</a>:<a class="headerlink" href="#vcrhonek_commented_at_2020-11-03_1400" title="Permanent link">&para;</a></h4>
<p>@jsmeix Yes, I agree that <code>type</code> can be optional (still, we probably
want to pass it to <code>crypt</code> as we<br />
should be able to get it in layout/save and lately with <code>rear recover</code>
we want to recreate the same version of LUKS<br />
that actually was on the machine). But from the point of <code>crypt</code> and
<code>cryptsetup luksFormat</code> it is optional.</p>
<p>I'm not sure about <code>uuid</code> though. I didn't try to omit it. It's true
that it's not needed by <code>cryptestup luksFormat</code> itself,<br />
but I really don't know ReaR code enough to be sure that it's not needed
because of something else (for example, this particular<br />
uuid is referred somewhere else, in some config file or something...).
I'm sure you know better:)</p>
<p>I did try to edit disklayout.conf just before I ran <code>rear recover</code>
yesterday and replaced<br />
<code>crypt /dev/mapper/luks-d3...5b /dev/vda2 type=luks2 cipher=aes-xts-plain64 key_size=512 hash=sha256 uuid=d3..5b</code><br />
with <code>crypt /dev/mapper/luks-d3...5b /dev/vda2 uuid=d3...5b</code> (using
original code in layout/prepare, without your latest changes applied).
The system recovered as expected.</p>
<p>I'll try to save some time tomorrow and look at your recent updates.</p>
<h4 id="jsmeix_commented_at_2020-11-03_1419"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2504#issuecomment-721144079">2020-11-03 14:19</a>:<a class="headerlink" href="#jsmeix_commented_at_2020-11-03_1419" title="Permanent link">&para;</a></h4>
<p>In
<a href="https://github.com/rear/rear/pull/2506">https://github.com/rear/rear/pull/2506</a><br />
I will change the code so that <code>type</code>and <code>uuid</code> are optional<br />
and try out how things behave for me without any of the optional
options.</p>
<p>My primary intent behind is not that "all will just work well"<br />
even without any of the optional options, in particular I think<br />
to recreate a system as if was before all those options should be there.</p>
<p>My primary intent is to not let "rear recover" needlessly fail<br />
if it could have somehow succeed to set up things with default/fallback
values.<br />
I think such a "graceful degradation" behaviour could help the user<br />
in case of an emergency disaster recovery more in real world practice.</p>
<h4 id="vcrhonek_commented_at_2020-11-03_1428"><img src="https://avatars.githubusercontent.com/u/3899106?v=4" width="50"><a href="https://github.com/vcrhonek">vcrhonek</a> commented at <a href="https://github.com/rear/rear/pull/2504#issuecomment-721148855">2020-11-03 14:28</a>:<a class="headerlink" href="#vcrhonek_commented_at_2020-11-03_1428" title="Permanent link">&para;</a></h4>
<blockquote>
<p>In #2506</p>
<p>My primary intent is to not let "rear recover" needlessly fail<br />
if it could have somehow succeed to set up things with
default/fallback values.<br />
I think such a "graceful degradation" behaviour could help the user<br />
in case of an emergency disaster recovery more in real world practice.</p>
</blockquote>
<p>I absolutely agree with that and I had it on mind in first part of
<a href="https://github.com/rear/rear/pull/2504#issuecomment-720341023">https://github.com/rear/rear/pull/2504#issuecomment-720341023</a></p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2024 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2020-10-20.2504.pr.merged.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/rear/rear-user-guide" class="fa fa-code-fork" style="color: #fcfcfc"> rear/rear-user-guide</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
