<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#2611 Issue closed: ReaR configured with netfs backup can delete other/old folders on NFS at failure - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#2611 Issue closed: ReaR configured with netfs backup can delete other/old folders on NFS at failure";
        var mkdocs_page_input_path = "issues/2021-05-05.2611.issue.closed.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/backup_netfs.html">Example of BACKUP=NETFS</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../development/squash-git-log-commments.html">How to squash git log comments into one line</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear29.html">Release Notes ReaR 2.9</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear28.html">Release Notes ReaR 2.8</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#2611 Issue closed: ReaR configured with netfs backup can delete other/old folders on NFS at failure</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="2611_issue_closed_rear_configured_with_netfs_backup_can_delete_otherold_folders_on_nfs_at_failure"><a href="https://github.com/rear/rear/issues/2611">#2611 Issue</a> <code>closed</code>: ReaR configured with netfs backup can delete other/old folders on NFS at failure<a class="headerlink" href="#2611_issue_closed_rear_configured_with_netfs_backup_can_delete_otherold_folders_on_nfs_at_failure" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>cleanup</code>, <code>fixed / solved / done</code>,
<code>critical / security / legal</code></p>
<h4 id="pcahyna_opened_issue_at_2021-05-05_1950"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> opened issue at <a href="https://github.com/rear/rear/issues/2611">2021-05-05 19:50</a>:<a class="headerlink" href="#pcahyna_opened_issue_at_2021-05-05_1950" title="Permanent link">&para;</a></h4>
<h4 id="relax-and-recover_rear_issue_template">Relax-and-Recover (ReaR) Issue Template<a class="headerlink" href="#relax-and-recover_rear_issue_template" title="Permanent link">&para;</a></h4>
<p>Fill in the following items before submitting a new issue<br />
(quick response is not guaranteed with free support):</p>
<ul>
<li>
<p>ReaR version ("/usr/sbin/rear -V"): Relax-and-Recover 2.4 / Git,
    according to code also current master and older versions since 1.18</p>
</li>
<li>
<p>OS version ("cat /etc/os-release" or "lsb_release -a" or "cat
    /etc/rear/os.conf"): CentOS Linux 7 (Core)</p>
</li>
<li>
<p>ReaR configuration files ("cat /etc/rear/site.conf" and/or "cat
    /etc/rear/local.conf"):</p>
</li>
</ul>
<!-- -->

<pre><code>BACKUP_URL=nfs://192.168.122.145/export/backup
BACKUP=NETFS
ISO_RECOVER_MODE=unattended
ISO_DEFAULT=automatic
NETFS_KEEP_OLD_BACKUP_COPY=yes
</code></pre>
<ul>
<li>
<p>Hardware (PC or PowerNV BareMetal or ARM) or virtual machine (KVM
    guest or PoverVM LPAR): KVM guest</p>
</li>
<li>
<p>System architecture (x86 compatible or PPC64/PPC64LE or what exact
    ARM device): x86</p>
</li>
<li>
<p>Firmware (BIOS or UEFI or Open Firmware) and bootloader (GRUB or
    ELILO or Petitboot): BIOS/GRUB</p>
</li>
<li>
<p>Storage (local disk or SSD) and/or SAN (FC or iSCSI or FCoE) and/or
    multipath (DM or NVMe): local disk</p>
</li>
<li>
<p>Storage layout ("lsblk -ipo
    NAME,KNAME,PKNAME,TRAN,TYPE,FSTYPE,SIZE,MOUNTPOINT" or "lsblk" as
    makeshift): trivial</p>
</li>
<li>
<p>Description of the issue (ideally so that others can reproduce
    it):<br />
    In case of <code>NETFS_KEEP_OLD_BACKUP_COPY</code> ReaR can remove old backup
    (*.old) if interrupted during the <code>output</code> stage. If for any reason
    unmounting the NFS directory mounted at <code>outputfs</code> fails (for
    example, there is a process using this filesystem), ReaR proceeds to
    <code>rm -Rf -v /.../outputfs</code> as part of the exit tasks. This removes
    the old backup directory.<br />
    It will also destroy the backup directories for other machines, if
    multiple machines are configured to use the same NFS directory. A
    similar problem was reported as #465 and after being fixed it was
    reintroduced in a misguided "fix" (PR #782,
    4e9c2a1b05f87762fb06355cf959b24eacc21f62) in ReaR 1.18.<br />
    There are multiple different copies of the exist task to cleanup the
    output directory in case of failure: those in the <code>prep</code> and
    <code>backup</code> stages look mostly safe (it would be still safer to use
    <code>rmdir</code> instead of <code>rm -Rf</code> though) and the only problematic one is
    in the <code>output</code> stage
    (usr/share/rear/output/default/100_mount_output_path.sh)</p>
</li>
<li>
<p>Workaround, if any:<br />
    Probably configuring an <code>OUTPUT_URL</code> different from <code>BACKUP_URL</code> and
    not sharing the NFS directory among multiple machines would limit
    the damage (one would not lose backup data if using NETFS, only the
    output ISO).</p>
</li>
<li>
<p>Attachments, as applicable ("rear -D mkrescue/mkbackup/recover"
    debug log files):</p>
</li>
</ul>
<!-- -->

<pre><code>+++ Print 'Running exit tasks'
+++ test 1
+++ echo -e 'Running exit tasks'
+++ local exit_task=
+++ for exit_task in '"${EXIT_TASKS[@]}"'
+++ Debug 'Exit task '\''umount -f -v '\''/tmp/rear.uUNE07AQyw2ey0S/outputfs'\'' &gt;&amp;2'\'''
+++ test 1
+++ Log 'Exit task '\''umount -f -v '\''/tmp/rear.uUNE07AQyw2ey0S/outputfs'\'' &gt;&amp;2'\'''
++++ date '+%Y-%m-%d %H:%M:%S.%N '
+++ local 'timestamp=2021-05-05 13:01:00.404599344 '
+++ test 1 -gt 0
+++ echo '2021-05-05 13:01:00.404599344 Exit task '\''umount -f -v '\''/tmp/rear.uUNE07AQyw2ey0S/outputfs'\'' &gt;&amp;2'\'''
2021-05-05 13:01:00.404599344 Exit task 'umount -f -v '/tmp/rear.uUNE07AQyw2ey0S/outputfs' &gt;&amp;2'
+++ eval 'umount -f -v '\''/tmp/rear.uUNE07AQyw2ey0S/outputfs'\'' &gt;&amp;2'
++++ umount -f -v /tmp/rear.uUNE07AQyw2ey0S/outputfs
umount.nfs4: /tmp/rear.uUNE07AQyw2ey0S/outputfs: device is busy
/tmp/rear.uUNE07AQyw2ey0S/outputfs: nfs4 mount point detected
/tmp/rear.uUNE07AQyw2ey0S/outputfs: umount failed
+++ for exit_task in '"${EXIT_TASKS[@]}"'
+++ Debug 'Exit task '\''rm -Rf -v /tmp/rear.uUNE07AQyw2ey0S/outputfs &gt;&amp;2'\'''
+++ test 1
+++ Log 'Exit task '\''rm -Rf -v /tmp/rear.uUNE07AQyw2ey0S/outputfs &gt;&amp;2'\'''
++++ date '+%Y-%m-%d %H:%M:%S.%N '
+++ local 'timestamp=2021-05-05 13:01:00.413623168 '
+++ test 1 -gt 0
+++ echo '2021-05-05 13:01:00.413623168 Exit task '\''rm -Rf -v /tmp/rear.uUNE07AQyw2ey0S/outputfs &gt;&amp;2'\'''
2021-05-05 13:01:00.413623168 Exit task 'rm -Rf -v /tmp/rear.uUNE07AQyw2ey0S/outputfs &gt;&amp;2'
+++ eval 'rm -Rf -v /tmp/rear.uUNE07AQyw2ey0S/outputfs &gt;&amp;2'
++++ rm -Rf -v /tmp/rear.uUNE07AQyw2ey0S/outputfs
removed '/tmp/rear.uUNE07AQyw2ey0S/outputfs/localhost.old/rear-localhost.iso'
removed '/tmp/rear.uUNE07AQyw2ey0S/outputfs/localhost.old/VERSION'
removed '/tmp/rear.uUNE07AQyw2ey0S/outputfs/localhost.old/README'
removed '/tmp/rear.uUNE07AQyw2ey0S/outputfs/localhost.old/rear-localhost.log'
removed '/tmp/rear.uUNE07AQyw2ey0S/outputfs/localhost.old/backup.tar.gz'
removed directory: '/tmp/rear.uUNE07AQyw2ey0S/outputfs/localhost.old'
removed '/tmp/rear.uUNE07AQyw2ey0S/outputfs/localhost/.lockfile'
removed directory: '/tmp/rear.uUNE07AQyw2ey0S/outputfs/localhost'
rm: cannot remove '/tmp/rear.uUNE07AQyw2ey0S/outputfs': Device or resource busy
+++ for exit_task in '"${EXIT_TASKS[@]}"'
+++ Debug 'Exit task '\''cleanup_build_area_and_end_program'\'''
+++ test 1
+++ Log 'Exit task '\''cleanup_build_area_and_end_program'\'''
++++ date '+%Y-%m-%d %H:%M:%S.%N '
+++ local 'timestamp=2021-05-05 13:01:00.439437963 '
+++ test 1 -gt 0
+++ echo '2021-05-05 13:01:00.439437963 Exit task '\''cleanup_build_area_and_end_program'\'''
2021-05-05 13:01:00.439437963 Exit task 'cleanup_build_area_and_end_program'
+++ eval cleanup_build_area_and_end_program
++++ cleanup_build_area_and_end_program
++++ Log 'Finished in 72 seconds'
+++++ date '+%Y-%m-%d %H:%M:%S.%N '
++++ local 'timestamp=2021-05-05 13:01:00.442303240 '
++++ test 1 -gt 0
++++ echo '2021-05-05 13:01:00.442303240 Finished in 72 seconds'
2021-05-05 13:01:00.442303240 Finished in 72 seconds
++++ test 1
++++ LogPrint 'You should also rm -Rf /tmp/rear.uUNE07AQyw2ey0S'
++++ Log 'You should also rm -Rf /tmp/rear.uUNE07AQyw2ey0S'
</code></pre>
<p>(The log message above also needs updating. If we are telling the user
what to do, we should not instruct them to use a command that will
destroy data. <code>rm -Rf --one-file-system</code> could help.)</p>
<h4 id="jsmeix_commented_at_2021-05-06_0748"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2611#issuecomment-833309583">2021-05-06 07:48</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-05-06_0748" title="Permanent link">&para;</a></h4>
<p>Sigh!<br />
In general: We have rather many <code>rm -Rf</code> or <code>rm -rf</code> in the code.<br />
I would be surprised if I don't find some more places where it is used
carelessly...</p>
<h4 id="pcahyna_commented_at_2021-05-06_0800"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/2611#issuecomment-833317414">2021-05-06 08:00</a>:<a class="headerlink" href="#pcahyna_commented_at_2021-05-06_0800" title="Permanent link">&para;</a></h4>
<p>@jsmeix would it work to omit those exit tasks that unmount and remove
the outputfs and leave the only one -
<code>cleanup_build_area_and_end_program</code>? You can see in the log above that
Exit task 'umount -f -v '/tmp/rear.uUNE07AQyw2ey0S/outputfs' gets
called, then the problematic Exit task 'rm -Rf -v
/tmp/rear.uUNE07AQyw2ey0S/outputfs &gt;&amp;2' gets called, and finally Exit
task 'cleanup_build_area_and_end_program' gets called. The last one
would be enough to do the needed job. Of course, relying on it would
make the code less local
(usr/share/rear/output/default/100_mount_output_path.sh would need to
rely on someone else cleaning up after it), but now the code is
duplicated, or rather multiplicated.</p>
<h4 id="pcahyna_commented_at_2021-05-06_0811"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/2611#issuecomment-833325102">2021-05-06 08:11</a>:<a class="headerlink" href="#pcahyna_commented_at_2021-05-06_0811" title="Permanent link">&para;</a></h4>
<p>Or, if it is desirable to keep the code structured as it is (each stage
of the code taking care of cleaning up after itself in the case of
failure, with the cleanup possibly running multiple times), it would be
helpful to factor out the cleanup into a function that could then be
called multiple times.<br />
(The same function could be called both in exit tasks and in regular
cleanups at the end of stages that need it.)</p>
<h4 id="jsmeix_commented_at_2021-05-06_0816"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2611#issuecomment-833329139">2021-05-06 08:16</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-05-06_0816" title="Permanent link">&para;</a></h4>
<p>@pcahyna<br />
I have no experience with the code parts that are involved here<br />
so from my point of view feel free to do it as you think it is best,
cf.<br />
<a href="https://github.com/rear/rear/pull/782#issuecomment-806585351">https://github.com/rear/rear/pull/782#issuecomment-806585351</a></p>
<p>Perhaps @gdha has some experience with the code parts that are involved
here<br />
so he could suggest what the best solution could be here?</p>
<h4 id="pcahyna_commented_at_2021-05-12_1015"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/2611#issuecomment-839653377">2021-05-12 10:15</a>:<a class="headerlink" href="#pcahyna_commented_at_2021-05-12_1015" title="Permanent link">&para;</a></h4>
<p>@jsmeix I think you can assign the issue to me, if nobody else has
started working on it.</p>
<p>@gdha would it be acceptable to entirely remove the problematic ExitTask
and keep just the global one <code>cleanup_build_area_and_end_program</code> ?</p>
<h4 id="jsmeix_commented_at_2021-05-12_1021"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2611#issuecomment-839657705">2021-05-12 10:21</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-05-12_1021" title="Permanent link">&para;</a></h4>
<p>@pcahyna<br />
thank you in advance for working on yet another "messy" part of ReaR!</p>
<h4 id="jsmeix_commented_at_2021-05-12_1030"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2611#issuecomment-839662970">2021-05-12 10:30</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-05-12_1030" title="Permanent link">&para;</a></h4>
<p>Only FYI my general opinion:<br />
I think if some <code>rm -rf</code> is missing it is a normal bug or even just an
enhancement.<br />
But when <code>rm -rf</code> happens that should not have been done it is a
critical bug.<br />
So in case of doubt better less <code>rm -rf</code> than too much.</p>
<h4 id="pcahyna_commented_at_2021-05-12_1041"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/2611#issuecomment-839668931">2021-05-12 10:41</a>:<a class="headerlink" href="#pcahyna_commented_at_2021-05-12_1041" title="Permanent link">&para;</a></h4>
<p>One thing I want to do is to add <code>--one-file-system</code> to all <code>rm -rf</code>
instances that remove the build area or parts of it (that will remain
after the intended cleanup).</p>
<h4 id="jsmeix_commented_at_2021-05-12_1117"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2611#issuecomment-839690135">2021-05-12 11:17</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-05-12_1117" title="Permanent link">&para;</a></h4>
<p>@pcahyna<br />
the <code>rm</code> option <code>--one-file-system</code> is not available on older versions
of <code>rm</code><br />
so check how far it is supported on older RHEL versions.</p>
<p>For example not for <code>rm</code> in coreutils-5.93<br />
that I have on my SLES10-SP4 test system<br />
ReaR does no longer support SLES10 - I use it here only as an example<br />
because SLES10 is the oldest test system that I currently have.<br />
I will check SLES11 soon...</p>
<p>When <code>--one-file-system</code> is specified <code>rm</code> (on SLES10) shows</p>
<pre><code>rm: unrecognized option '--one-file-system'
</code></pre>
<p>and does not remove anything.</p>
<h4 id="jsmeix_commented_at_2021-05-12_1144"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2611#issuecomment-839704913">2021-05-12 11:44</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-05-12_1144" title="Permanent link">&para;</a></h4>
<p><code>rm</code> in coreutils-8.12 that I have on SLES11 supports the
<code>--one-file-system</code> option.</p>
<h4 id="pcahyna_commented_at_2021-05-12_1215"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/2611#issuecomment-839722789">2021-05-12 12:15</a>:<a class="headerlink" href="#pcahyna_commented_at_2021-05-12_1215" title="Permanent link">&para;</a></h4>
<p>I did an investigation and reported here:
<a href="https://github.com/rear/rear/pull/782#issuecomment-806577614">https://github.com/rear/rear/pull/782#issuecomment-806577614</a></p>
<h4 id="pcahyna_commented_at_2021-05-12_1216"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/2611#issuecomment-839723305">2021-05-12 12:16</a>:<a class="headerlink" href="#pcahyna_commented_at_2021-05-12_1216" title="Permanent link">&para;</a></h4>
<p>Thanks for checking SLES, I think it was the only supported distribution
missing from my investigation.</p>
<h4 id="jsmeix_commented_at_2021-05-12_1233"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2611#issuecomment-839733608">2021-05-12 12:33</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-05-12_1233" title="Permanent link">&para;</a></h4>
<p>We may even stay backward compatible for the old unsupported
distributions<br />
by conditional setting a <code>rm_one_file_system</code> variable e.g. with code
like</p>
<pre><code># rm --one-file-system --help &amp;&gt;/dev/null &amp;&amp; rm_one_file_system='--one-file-system' || rm_one_file_system=''

# rm $rm_one_file_system ...
</code></pre>
<p>which is perhaps better than to let things "just fail" on old
distributions?</p>
<h4 id="pcahyna_commented_at_2021-05-12_1242"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/2611#issuecomment-839740086">2021-05-12 12:42</a>:<a class="headerlink" href="#pcahyna_commented_at_2021-05-12_1242" title="Permanent link">&para;</a></h4>
<p>@jsmeix I would prefer to not complicate the code only for the benefit
of distributions that are unsupported anyway according to
<a href="https://github.com/rear/rear.github.com/blob/master/documentation/release-notes-2-6.md#supported-and-unsupported-operating-systems">https://github.com/rear/rear.github.com/blob/master/documentation/release-notes-2-6.md#supported-and-unsupported-operating-systems</a></p>
<h4 id="jsmeix_commented_at_2021-05-12_1255"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2611#issuecomment-839749197">2021-05-12 12:55</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-05-12_1255" title="Permanent link">&para;</a></h4>
<p>@pcahyna<br />
when you do the actual work it is you who decides how to do it<br />
and in
<a href="https://github.com/rear/rear/pull/782#issuecomment-806585351">https://github.com/rear/rear/pull/782#issuecomment-806585351</a><br />
I wrote (excerpt)</p>
<pre><code>feel free and be brave and merciless and try to clean up the mess
</code></pre>
<p>so feel free to mercilessly clean up things!</p>
<p>By the way:<br />
Today is logical Friday for me<br />
because tomorrow is public holiday in Germany<br />
<a href="https://en.wikipedia.org/wiki/Feast_of_the_Ascension">https://en.wikipedia.org/wiki/Feast_of_the_Ascension</a><br />
and the day after tomorrow is vacation for me<br />
so I wish you a relaxed and recovering weekend!</p>
<h4 id="pcahyna_commented_at_2021-05-12_1615"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/2611#issuecomment-839910647">2021-05-12 16:15</a>:<a class="headerlink" href="#pcahyna_commented_at_2021-05-12_1615" title="Permanent link">&para;</a></h4>
<p>@jsmeix may you ascend successfully!</p>
<h4 id="jsmeix_commented_at_2021-05-17_1153"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2611#issuecomment-842262695">2021-05-17 11:53</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-05-17_1153" title="Permanent link">&para;</a></h4>
<p>It didn't work for me - I am still on earth ;-)</p>
<h4 id="pcahyna_commented_at_2021-05-28_0922"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/2611#issuecomment-850281133">2021-05-28 09:22</a>:<a class="headerlink" href="#pcahyna_commented_at_2021-05-28_0922" title="Permanent link">&para;</a></h4>
<p>Hi @jsmeix , here is my branch to fix these problems together with many
cleanups in related areas. Please have a look:
<a href="https://github.com/pcahyna/rear/tree/fix-backup-removal-in-exit-task">https://github.com/pcahyna/rear/tree/fix-backup-removal-in-exit-task</a></p>
<p>It is not tested yet, so I am not yet opening a PR. Please take a quick
look if you can to check whether you see something obviously wrong or
changes that you don't like for style reasons. I will try to test it in
the meantime (it touches many output methods so testing will take some
time).</p>
<p>It also addresses the problem found in
<a href="https://github.com/rear/rear/commit/20359a987662cc0c3fcfa52d62d1feac7cd55850#r51319634">https://github.com/rear/rear/commit/20359a987662cc0c3fcfa52d62d1feac7cd55850#r51319634</a>
.</p>
<h4 id="jsmeix_commented_at_2021-05-28_1127"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2611#issuecomment-850351606">2021-05-28 11:27</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-05-28_1127" title="Permanent link">&para;</a></h4>
<p>@pcahyna<br />
while reading through your canges in<br />
<a href="https://github.com/pcahyna/rear/tree/fix-backup-removal-in-exit-task">https://github.com/pcahyna/rear/tree/fix-backup-removal-in-exit-task</a><br />
I noticed another issue that I like to mention here FYI:</p>
<p>Summary:<br />
Code like</p>
<pre><code>umount_url ... || Error "..."
</code></pre>
<p>can be problematic in scripts that are run during "rear recover"<br />
after the backup was restored.</p>
<p>Reason:<br />
We do not want to error out after the backup was restored<br />
unless the error is so serious that it is impossible to continue.</p>
<p>But some failed <code>umount</code> in the ReaR recovery system<br />
that will be rebooted anyway is likely no really serious error.</p>
<p>For comparison what stages are sourced during "rear mkbackup" versus
"rear recover":</p>
<pre><code># usr/sbin/rear -s mkbackup | grep -o 'Source [^/]*' | uniq
Source conf
Source init
Source prep
Source layout
Source rescue
Source build
Source pack
Source output
Source backup

# usr/sbin/rear -s recover | grep -o 'Source [^/]*' | uniq
Source conf
Source init
Source setup
Source verify
Source layout
Source restore
Source finalize
Source wrapup
</code></pre>
<p>What scripts (including symlinks to scripts) call <code>umount_url</code><br />
in the current GitHub master code:</p>
<pre><code># find -L usr/share/rear -type f | xargs grep -l 'umount_url' | grep -v global-functions.sh
usr/share/rear/output/default/980_umount_output_dir.sh
usr/share/rear/output/PXE/default/810_create_pxelinux_cfg.sh
usr/share/rear/output/PXE/default/800_copy_to_tftp.sh
usr/share/rear/restore/YUM/default/980_umount_YUM_dir.sh
usr/share/rear/restore/BLOCKCLONE/default/980_umount_NETFS_dir.sh
usr/share/rear/restore/NETFS/default/980_umount_NETFS_dir.sh
usr/share/rear/restore/DUPLICITY/default/980_unmount_duplicity_path.sh
usr/share/rear/restore/RBME/default/980_umount_NETFS_dir.sh
usr/share/rear/restore/BORG/default/900_umount_usb.sh
usr/share/rear/verify/YUM/default/980_umount_YUM_dir.sh
usr/share/rear/verify/BLOCKCLONE/default/980_umount_NETFS_dir.sh
usr/share/rear/verify/NETFS/default/980_umount_NETFS_dir.sh
usr/share/rear/verify/DUPLICITY/default/980_unmount_duplicity_path.sh
usr/share/rear/backup/BLOCKCLONE/default/980_umount_NETFS_dir.sh
usr/share/rear/backup/NETFS/default/980_umount_NETFS_dir.sh
usr/share/rear/backup/DUPLICITY/default/980_unmount_duplicity_path.sh
usr/share/rear/backup/BORG/default/900_umount_usb.sh
usr/share/rear/prep/BLOCKCLONE/default/980_umount_NETFS_dir.sh
usr/share/rear/prep/NETFS/default/980_umount_NETFS_dir.sh
</code></pre>
<p>So the scripts or symlinks to scripts that call <code>umount_url</code><br />
during "rear recover" after the backup was restored are</p>
<pre><code>usr/share/rear/restore/YUM/default/980_umount_YUM_dir.sh
usr/share/rear/restore/BLOCKCLONE/default/980_umount_NETFS_dir.sh
usr/share/rear/restore/NETFS/default/980_umount_NETFS_dir.sh
usr/share/rear/restore/DUPLICITY/default/980_unmount_duplicity_path.sh
usr/share/rear/restore/RBME/default/980_umount_NETFS_dir.sh
usr/share/rear/restore/BORG/default/900_umount_usb.sh
</code></pre>
<p>Furthermore there are usr/share/rear/restore scripts (or symlinks)<br />
that do other <code>umount</code> calls in the current GitHub master code:</p>
<pre><code>usr/share/rear/restore/YUM/default/410_restore_backup.sh:
                umount "$BUILD_DIR/outputfs"

usr/share/rear/restore/BLOCKCLONE/default/400_restore_clone.sh:
        umount_mountpoint $mp

usr/share/rear/restore/NETFS/default/400_restore_backup.sh:
                umount "$BUILD_DIR/outputfs"
</code></pre>
<p>As far as I see those plain <code>umount "$BUILD_DIR/outputfs"</code> are also in
your<br />
<a href="https://github.com/pcahyna/rear/tree/fix-backup-removal-in-exit-task">https://github.com/pcahyna/rear/tree/fix-backup-removal-in-exit-task</a></p>
<h4 id="pcahyna_commented_at_2021-05-28_1136"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/2611#issuecomment-850356346">2021-05-28 11:36</a>:<a class="headerlink" href="#pcahyna_commented_at_2021-05-28_1136" title="Permanent link">&para;</a></h4>
<blockquote>
<p>Code like</p>
<pre><code>umount_url ... || Error "..."
</code></pre>
<p>can be problematic in scripts that are run during "rear recover"<br />
after the backup was restored.</p>
</blockquote>
<p>Sure, but I don't see any <code>umount_url ... || Error "..."</code> in my changes.
There is only</p>
<pre><code>perform_umount_url $url $mountpoint || Error "Unmounting '$mountpoint' failed."
</code></pre>
<p>in <code>umount_url()</code>, i.e. the check is performed inside <code>umount_url()</code>,
not in the callers. The original code was</p>
<pre><code>           Log "Unmounting with '$umount_cmd'"
           $umount_cmd
           StopIfError "Unmounting failed."
</code></pre>
<p>which is essentially equivalent. So you have a point, but my change does
not seem to introduce any substantial change, the problem has existed
before.</p>
<h4 id="pcahyna_commented_at_2021-05-28_1141"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/2611#issuecomment-850358666">2021-05-28 11:41</a>:<a class="headerlink" href="#pcahyna_commented_at_2021-05-28_1141" title="Permanent link">&para;</a></h4>
<p>@jsmeix if you think that those changes present a good opportunity to
fix this problem that you have noticed, I can do that.</p>
<h4 id="jsmeix_commented_at_2021-05-28_1143"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2611#issuecomment-850360156">2021-05-28 11:43</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-05-28_1143" title="Permanent link">&para;</a></h4>
<p>In your
<a href="https://github.com/pcahyna/rear/tree/fix-backup-removal-in-exit-task">https://github.com/pcahyna/rear/tree/fix-backup-removal-in-exit-task</a><br />
in usr/share/rear/lib/global-functions.sh there is (excerpts):</p>
<pre><code>        (var)
            ### The mount command is given by variable in the url host
            local var=$(url_host $url)
            mount_cmd="${!var} $mountpoint"
            ;;
...
        (var)
            local var
            var=$(url_host $url)
            Log "Unmounting with '${!var} $mountpoint'"
            # lazy unmount not supported with custom umount command
            ${!var} $mountpoint
            ;;
</code></pre>
<p>The usage of the scheme name <code>var</code> also for the variable name drives me
nuts.<br />
I just fail to understand it.<br />
From reading the code <code>var=$(url_host $url)</code><br />
the <code>var</code> variable contains a URL host part so it should be named
<code>host</code><br />
but the comment tells the <code>var</code> variable actually contains a "mount
command"<br />
so it should be named <code>mount_command</code> or my understanding is totally
confused<br />
and actually the <code>var</code> variable contains the name of another variable<br />
because it is then used as <code>${!var}</code> or actually the <code>var</code> variable
means<br />
the scheme name <code>var</code>?<br />
Therefore I would like to ask you if you could clean up that naming
mess<br />
so that it is more clear what that code actually is about.<br />
I also do not understand what the scheme name <code>var</code> actually means.</p>
<h4 id="jsmeix_commented_at_2021-05-28_1149"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2611#issuecomment-850362735">2021-05-28 11:49</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-05-28_1149" title="Permanent link">&para;</a></h4>
<p>@pcahyna<br />
yes the <code>umount_url ... || Error "..."</code> issue existed before.<br />
I only spotted it now and I reported it here primarily so that it is not
forgotten.</p>
<p>I don't have a simple straightforward idea how to get that new issue
solved<br />
i.e. how to distinguish if we are "after the backup was restored"<br />
so I think you should not try to solve that additional issue now.<br />
Things worked as is since years so there in no pressure to enhance it
now.</p>
<h4 id="pcahyna_commented_at_2021-05-28_1151"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/2611#issuecomment-850363779">2021-05-28 11:51</a>:<a class="headerlink" href="#pcahyna_commented_at_2021-05-28_1151" title="Permanent link">&para;</a></h4>
<blockquote>
<p>From reading the code <code>var=$(url_host $url)</code><br />
the <code>var</code> variable contains a URL host part so it should be named
<code>host</code><br />
but the comment tells the <code>var</code> variable actually contains a "mount
command"<br />
so it should be named <code>mount_command</code> or my understanding is totally
confused<br />
and actuall the <code>var</code> variable actually contains the name of another
variable<br />
because it is then used as <code>${!var}</code> or actually the <code>var</code> variable
means<br />
the scheme name <code>var</code>.</p>
</blockquote>
<p>There is an indirection: <code>${var}</code> is not a mount command, but the name
of another variable which contains the mount command. It is used in the
<code>var:</code> scheme and confusingly it is named identically tho that scheme.</p>
<h4 id="pcahyna_commented_at_2021-05-28_1153"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/2611#issuecomment-850364945">2021-05-28 11:53</a>:<a class="headerlink" href="#pcahyna_commented_at_2021-05-28_1153" title="Permanent link">&para;</a></h4>
<p><code>var://</code> is an internal scheme to implement the <code>*_{U,}MOUNTCMD</code>
functionality. It needs to be changed a bit because as it is currently
it will not handle errors very well. (<code>mount_url()</code> needs to know the
<code>_UMOUNTCMD</code> in order to use it in the exit task, but it is not known at
the point where <code>mount_url()</code> gets called.)</p>
<h4 id="pcahyna_commented_at_2021-05-28_1155"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/2611#issuecomment-850365814">2021-05-28 11:55</a>:<a class="headerlink" href="#pcahyna_commented_at_2021-05-28_1155" title="Permanent link">&para;</a></h4>
<blockquote>
<p>@pcahyna<br />
yes the <code>umount_url ... || Error "..."</code> issue existed before.<br />
I only spotted it now and I reported it here primarily so that it is
not forgotten.</p>
<p>I don't have a simple straightforward idea how to get that new issue
solved<br />
i.e. how to distinguish if we are "after the backup was restored"<br />
so I think you should not try to solve that additional issue now.<br />
Things worked as is since years so there in no pressure to enhance it
now.</p>
</blockquote>
<p>Wouldn't it be enough to make the Error conditional on
<code>"recover" != "$WORKFLOW"</code> ?</p>
<h4 id="jsmeix_commented_at_2021-05-28_1202"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2611#issuecomment-850369607">2021-05-28 12:02</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-05-28_1202" title="Permanent link">&para;</a></h4>
<p>Backup restore also happens in "restoreonly" workflow that runs those
stages:</p>
<pre><code># usr/sbin/rear -s restoreonly | grep -o 'Source [^/]*' | uniq
Source conf
Source init
Source setup
Source verify
Source restore
Source wrapup
</code></pre>
<p>And during "recover" workflow we should error our as usual<br />
before the backup was restored i.e. during the usr/share/rear/verify
stage.</p>
<p>E.g. one same 980_umount_NETFS_dir.sh exists as script or symlinks<br />
where during "rear mkbackup" it is called as those</p>
<pre><code>usr/share/rear/prep/NETFS/default/980_umount_NETFS_dir.sh
usr/share/rear/backup/NETFS/default/980_umount_NETFS_dir.sh
</code></pre>
<p>versus during "rear recover" it is called as those</p>
<pre><code>usr/share/rear/verify/NETFS/default/980_umount_NETFS_dir.sh
usr/share/rear/restore/NETFS/default/980_umount_NETFS_dir.sh
</code></pre>
<h4 id="jsmeix_commented_at_2021-05-28_1215"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2611#issuecomment-850376673">2021-05-28 12:15</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-05-28_1215" title="Permanent link">&para;</a></h4>
<p>When <code>var</code> is an internal scheme to implement the <code>*_{U,}MOUNTCMD</code>
functionality<br />
then that scheme should be renamed accordingly to <code>mountcmd</code>.</p>
<p>The <code>var</code> named variable (a variable named <code>var</code> how explanatory! -
shudder! ;-)<br />
should be renamed to something that explains what that thingy is about<br />
e.g. something like <code>mount_command_variable_name</code> or
<code>mnt_cmd_var_name</code><br />
or <code>mountcmd_var_name</code> - the latter contains the matching scheme name<br />
so <code>grep -i mountcmd</code> over the whole code "just finds" all related
places,<br />
cf. "Code must be easy to read" in<br />
<a href="https://github.com/rear/rear/wiki/Coding-Style">https://github.com/rear/rear/wiki/Coding-Style</a></p>
<h4 id="pcahyna_commented_at_2021-05-28_1221"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/2611#issuecomment-850379841">2021-05-28 12:21</a>:<a class="headerlink" href="#pcahyna_commented_at_2021-05-28_1221" title="Permanent link">&para;</a></h4>
<p>It is not named <code>var</code> because it is a variable, but because its value is
a variable :-) which is in some (EDIT: perverse) sense explanatory.</p>
<h4 id="pcahyna_commented_at_2021-05-28_1223"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/2611#issuecomment-850381162">2021-05-28 12:23</a>:<a class="headerlink" href="#pcahyna_commented_at_2021-05-28_1223" title="Permanent link">&para;</a></h4>
<blockquote>
<p>Backup restore also happens in "restoreonly" workflow that runs those
stages:</p>
</blockquote>
<p>What about making it conditional on stage instead of workflow, would
this work?</p>
<h4 id="pcahyna_commented_at_2021-05-28_1227"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/2611#issuecomment-850382832">2021-05-28 12:27</a>:<a class="headerlink" href="#pcahyna_commented_at_2021-05-28_1227" title="Permanent link">&para;</a></h4>
<blockquote>
<p>usr/share/rear/restore scripts (or symlinks)<br />
that do other <code>umount</code> calls in the current GitHub master code:</p>
<pre><code>usr/share/rear/restore/YUM/default/410_restore_backup.sh:
                umount "$BUILD_DIR/outputfs"

usr/share/rear/restore/BLOCKCLONE/default/400_restore_clone.sh:
        umount_mountpoint $mp

usr/share/rear/restore/NETFS/default/400_restore_backup.sh:
                umount "$BUILD_DIR/outputfs"
</code></pre>
</blockquote>
<p>Those <code>umount</code>s are in the code that implements split archive support.
This code umounts the CD-ROM, lets the user insert another CD-ROM, and
mounts it, possibly several times. Does not sound like a problem. The
<code>umount_url()</code> at the end will see the last CD-ROM and unmount it,
although it is not the same CD-ROM that <code>mount_url()</code> started with.</p>
<h4 id="jsmeix_commented_at_2021-05-28_1228"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2611#issuecomment-850383457">2021-05-28 12:28</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-05-28_1228" title="Permanent link">&para;</a></h4>
<p>In your
<a href="https://github.com/pcahyna/rear/tree/fix-backup-removal-in-exit-task">https://github.com/pcahyna/rear/tree/fix-backup-removal-in-exit-task</a><br />
in usr/share/rear/lib/global-functions.s there is</p>
<pre><code>function remove_temporary_mountpoint() {
    rmdir $v "$1" &gt;&amp;2
}
</code></pre>
<p>Usually you should no longer need to do something special with stdout
and stderr,<br />
see
<a href="https://github.com/rear/rear/issues/2416">https://github.com/rear/rear/issues/2416</a></p>
<h4 id="pcahyna_commented_at_2021-05-28_1230"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/2611#issuecomment-850384709">2021-05-28 12:30</a>:<a class="headerlink" href="#pcahyna_commented_at_2021-05-28_1230" title="Permanent link">&para;</a></h4>
<p>In <code>restore/BLOCKCLONE/default/400_restore_clone.sh</code> the unmount is
there for the target device, which is an independent case from
mount/umount_url(), so this should not be a problem.</p>
<h4 id="pcahyna_commented_at_2021-05-28_1235"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/2611#issuecomment-850387663">2021-05-28 12:35</a>:<a class="headerlink" href="#pcahyna_commented_at_2021-05-28_1235" title="Permanent link">&para;</a></h4>
<blockquote>
<p>In your
<a href="https://github.com/pcahyna/rear/tree/fix-backup-removal-in-exit-task">https://github.com/pcahyna/rear/tree/fix-backup-removal-in-exit-task</a><br />
in usr/share/rear/lib/global-functions.s there is</p>
<pre><code>function remove_temporary_mountpoint() {
    rmdir $v "$1" &gt;&amp;2
}
</code></pre>
<p>Usually you should no longer need to do something special with stdout
and stderr,</p>
</blockquote>
<p>This function replaces the numerous uses of <code>rmdir</code> and <code>rm -Rf</code> that
had been there before. All of them use this redirection, so I preserved
it. If it is not needed anymore, I can drop it in a separate commit.
(This is the purpose of having it in a function, even if tiny - one can
do such changes on one place instead of many.)</p>
<h4 id="jsmeix_commented_at_2021-05-28_1236"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2611#issuecomment-850388271">2021-05-28 12:36</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-05-28_1236" title="Permanent link">&para;</a></h4>
<p>In your
<a href="https://github.com/pcahyna/rear/tree/fix-backup-removal-in-exit-task">https://github.com/pcahyna/rear/tree/fix-backup-removal-in-exit-task</a><br />
in usr/share/rear/output/default/950_copy_result_files.sh there is</p>
<pre><code># XXX should we check for empty $OUTPUT_URL here? Most likely plenty of things got broken before reaching this point if it is empty
</code></pre>
<p>Usually we use <code>TODO</code> and <code>FIXME</code> in comments for such cases.</p>
<h4 id="pcahyna_commented_at_2021-05-28_1307"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/2611#issuecomment-850406227">2021-05-28 13:07</a>:<a class="headerlink" href="#pcahyna_commented_at_2021-05-28_1307" title="Permanent link">&para;</a></h4>
<blockquote>
<p>Usually we use <code>TODO</code> and <code>FIXME</code> in comments for such cases.</p>
</blockquote>
<p>Changed now</p>
<h4 id="jsmeix_commented_at_2021-05-28_1311"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2611#issuecomment-850408838">2021-05-28 13:11</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-05-28_1311" title="Permanent link">&para;</a></h4>
<p>So I had now a rather quick look over the changes in<br />
<a href="https://github.com/pcahyna/rear/tree/fix-backup-removal-in-exit-task">https://github.com/pcahyna/rear/tree/fix-backup-removal-in-exit-task</a><br />
and all looks really good to me from plain looking at the code.</p>
<p>In particular I do appreciate the various major cleanups therein.<br />
Even if those cleanups might break some unexpected special cases<br />
I prefer to have them and fix those unexpected special cases later as
needed.</p>
<p>@pcahyna<br />
thank you so much for all your work here!</p>
<h4 id="pcahyna_commented_at_2021-05-28_1313"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/2611#issuecomment-850410228">2021-05-28 13:13</a>:<a class="headerlink" href="#pcahyna_commented_at_2021-05-28_1313" title="Permanent link">&para;</a></h4>
<p>@jsmeix thanks a lot for the review. I have found during the cleanups
that many unexpected special cases are already broken in one way or
another. I will add a list of these findings to the PR when I open it.</p>
<h4 id="jsmeix_commented_at_2021-05-28_1319"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2611#issuecomment-850413661">2021-05-28 13:19</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-05-28_1319" title="Permanent link">&para;</a></h4>
<p>@pcahyna<br />
I wish you a relaxed and recovering weekend!</p>
<h4 id="pcahyna_commented_at_2021-05-31_1005"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/2611#issuecomment-851379268">2021-05-31 10:05</a>:<a class="headerlink" href="#pcahyna_commented_at_2021-05-31_1005" title="Permanent link">&para;</a></h4>
<p>@jsmeix thanks, hope you had a relaxing and recovering weekend as well.</p>
<p>Concerning</p>
<blockquote>
<blockquote>
<p>Backup restore also happens in "restoreonly" workflow that runs
those stages:</p>
</blockquote>
<p>What about making it conditional on stage instead of workflow, would
this work?</p>
</blockquote>
<p>I realized that there is apparently no way to test what stage we are in,
unlike for workflow. Would it work to introduce a global variable
<code>STAGE</code> and set it in <code>SourceStage</code> to the name of the current stage,
then test if <code>$STAGE != "restore</code> before erroring out in <code>umount_url()</code>
to address your initial concerns that we should not abort the recovery
just because the umount of the backup directory has failed?</p>
<h4 id="jsmeix_commented_at_2021-05-31_1226"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2611#issuecomment-851456423">2021-05-31 12:26</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-05-31_1226" title="Permanent link">&para;</a></h4>
<p>I also have the "use a global variable" idea in my mind<br />
but currently my mind is not yet finished with thinking about it.</p>
<p>My current idea is a more direct variable like <code>BACKUP_RESTORED</code><br />
that could have <code>is_true</code>/<code>is_false</code> values for 'success' versus
'failure'<br />
(neither <code>is_true</code> nor <code>is_false</code> means 'unknown' backup restore
state)<br />
and the <code>Error</code> function checks that and does not error out<br />
<code>if is_true $BACKUP_RESTORED</code><br />
to get something which works in general in all scripts.<br />
But for a generic solution a variable like <code>BACKUP_RESTORED</code><br />
is too specific because the actual intent is to not error out<br />
so a more explicit variable name could be <code>NO_ERROR_EXIT</code><br />
or positively named <code>ERROR_PROCEED</code> or something like that.</p>
<h4 id="pcahyna_commented_at_2021-06-04_1817"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/2611#issuecomment-854916232">2021-06-04 18:17</a>:<a class="headerlink" href="#pcahyna_commented_at_2021-06-04_1817" title="Permanent link">&para;</a></h4>
<p>I found that the issue is actually more serious than what I wrote
initially. I wrote:</p>
<blockquote>
<p>if interrupted during the output stage. If for any reason unmounting
the NFS directory mounted at outputfs fails (for example, there is a
process using this filesystem), ReaR proceeds to
<code>rm -Rf -v /.../outputfs</code> as part of the exit tasks.</p>
</blockquote>
<p>but actually the <code>if interrupted during the output stage</code> part is not
necessary. If there is anything that blocks umount or it fails for any
other reason, the <code>umount_url()</code> function checks the error from <code>umount</code>
and aborts ReaR itself, thus invoking the problematic <code>rm -Rf</code> exit
task, leading to a certain data loss.</p>
<p>I also found that similar problems exist for the filesystem mounted at
<code>$BUILD_DIR/tftpbootfs</code> in the case of <code>OUTPUT=PXE</code>:
<a href="https://github.com/rear/rear/blob/2433c72f614af5b22547d6bd873ff4d224901a2c/usr/share/rear/output/PXE/default/800_copy_to_tftp.sh#L14">https://github.com/rear/rear/blob/2433c72f614af5b22547d6bd873ff4d224901a2c/usr/share/rear/output/PXE/default/800_copy_to_tftp.sh#L14</a>
and
<a href="https://github.com/rear/rear/blob/2433c72f614af5b22547d6bd873ff4d224901a2c/usr/share/rear/output/PXE/default/810_create_pxelinux_cfg.sh#L17">https://github.com/rear/rear/blob/2433c72f614af5b22547d6bd873ff4d224901a2c/usr/share/rear/output/PXE/default/810_create_pxelinux_cfg.sh#L17</a>.
The directory could contain data for other machines that would thus be
lost.</p>
<h4 id="jsmeix_commented_at_2021-06-18_1304"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2611#issuecomment-864022984">2021-06-18 13:04</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-06-18_1304" title="Permanent link">&para;</a></h4>
<p>With
<a href="https://github.com/rear/rear/pull/2625">https://github.com/rear/rear/pull/2625</a>
merged<br />
this issue should be avoided.</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2025 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2021-05-05.2611.issue.closed.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/rear/rear-user-guide" class="fa fa-code-fork" style="color: #fcfcfc"> rear/rear-user-guide</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
