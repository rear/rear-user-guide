<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#1274 Issue closed: Fail to acquire DHCP IP in 58-start-dhclient.sh - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#1274 Issue closed: Fail to acquire DHCP IP in 58-start-dhclient.sh";
        var mkdocs_page_input_path = "issues/2017-03-30.1274.issue.closed.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#1274 Issue closed: Fail to acquire DHCP IP in 58-start-dhclient.sh</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="1274_issue_closed_fail_to_acquire_dhcp_ip_in_58-start-dhclientsh"><a href="https://github.com/rear/rear/issues/1274">#1274 Issue</a> <code>closed</code>: Fail to acquire DHCP IP in 58-start-dhclient.sh<a class="headerlink" href="#1274_issue_closed_fail_to_acquire_dhcp_ip_in_58-start-dhclientsh" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>enhancement</code>, <code>support / question</code>, <code>fixed / solved / done</code></p>
<h4 id="styerd_opened_issue_at_2017-03-30_1422"><img src="https://avatars.githubusercontent.com/u/20077410?v=4" width="50"><a href="https://github.com/styerd">styerd</a> opened issue at <a href="https://github.com/rear/rear/issues/1274">2017-03-30 14:22</a>:<a class="headerlink" href="#styerd_opened_issue_at_2017-03-30_1422" title="Permanent link">&para;</a></h4>
<h4 id="relax-and-recover_rear_issue_template">Relax-and-Recover (ReaR) Issue Template<a class="headerlink" href="#relax-and-recover_rear_issue_template" title="Permanent link">&para;</a></h4>
<p>Fill in the following items before submitting a new issue<br />
(quick response is not guaranteed with free support):</p>
<ul>
<li>rear version (/usr/sbin/rear -V): Relax-and-Recover 1.17.2</li>
<li>OS version (cat /etc/rear/os.conf or lsb_release -a): RHEL 7.2</li>
<li>rear configuration files (cat /etc/rear/site.conf or cat
    /etc/rear/local.conf):<br />
    OUTPUT=PXE<br />
    OUTPUT_URL=nfs://172.17.5.2/var/lib/tftpboot/rear<br />
    BACKUP=NETFS<br />
    BACKUP_URL=nfs://172.17.5.2/var/lib/tftpboot/rear<br />
    BACKUP_PROG_EXCLUDE=("${BACKUP_PROG_EXCLUDE[@]}" '/var/tmp'
    '/var/crash'<br />
    '/erambr.log*' '/backup_restore.ksh.log*'<br />
    '/etc/sysconfig/network-scripts/ifcfg-et*'<br />
    '/etc/sysconfig/network-scripts/ifcfg-en*')</li>
<li>Are you using legacy BIOS or UEFI boot? UEFI</li>
<li>Brief description of the issue: Processor fails to acquire DHCP IP
    address</li>
<li>Work-around, if any: mods to "58-start-dhclient.sh"</li>
</ul>
<p>On occasion our HP Proliant ML30 Gen9 reorders the interfaces as shown
by "ip addr show" and the NFS mount fails with "network unreachable". In
that case no network interfaces are configured which prompted a closer
look. In "58-start-dhclient.sh" the following behavior was noted:</p>
<p>Press ENTER to run 58-start-dhclient.sh</p>
<ul>
<li>source /etc/scripts/system-setup.d/58-start-dhclient.sh<br />
    ++ dhclient -lf /var/lib/dhclient/dhclient.leases.eno1 -pf
    /var/run/dhclient.pid -cf /etc/dhclient.conf eno1<br />
    ++ dhclient -lf /var/lib/dhclient/dhclient.leases.eno1 -pf
    /var/run/dhclient.pid -cf /etc/dhclient.conf eno1<br />
    dhclient(519) is already running - exiting.<br />
    ++ dhclient -lf /var/lib/dhclient/dhclient.leases.eno1 -pf
    /var/run/dhclient.pid -cf /etc/dhclient.conf eno1<br />
    dhclient(519) is already running - exiting.<br />
    ++ dhclient -lf /var/lib/dhclient/dhclient.leases.eno1 -pf
    /var/run/dhclient.pid -cf /etc/dhclient.conf eno1<br />
    dhclient(519) is already running - exiting.<br />
    ++ dhclient -lf /var/lib/dhclient/dhclient.leases.eno1 -pf
    /var/run/dhclient.pid -cf /etc/dhclient.conf eno1<br />
    dhclient(519) is already running - exiting.<br />
    ++ dhclient -lf /var/lib/dhclient/dhclient.leases.eno1 -pf
    /var/run/dhclient.pid -cf /etc/dhclient.conf eno1<br />
    dhclient(519) is already running - exiting.</li>
</ul>
<p>This actually is the functioning case since eno1 did in fact acquire an
IP address and that interface is up. In the failure case ens2f0 is
listed first and so replaces all instances of "eno1" above but there is
no server available there and no cable attached. It appears that perhaps
this code was intended to start dhclient on each interface which likely
would work if the device changed for each invocation and also the '-pf'
parameter was changed to avoid the "already running" complaint. As coded
'$DEVICE' never changes.</p>
<p>A simple work around was to replace all this with a simple "dhclient"
invocation which without parameters tries to acquire IPs on all
interfaces. Perhaps we should specify "USE_DHCIENT=y" but the existing
configuration was working for us most of the time.</p>
<h4 id="jsmeix_commented_at_2017-03-31_0750"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1274#issuecomment-290642303">2017-03-31 07:50</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-03-31_0750" title="Permanent link">&para;</a></h4>
<p>@styerd<br />
only a hint what you can use in newer ReaR versions,<br />
see NETWORKING_PREPARATION_COMMANDS<br />
in the current usr/share/rear/conf/default.conf<br />
<a href="https://raw.githubusercontent.com/rear/rear/master/usr/share/rear/conf/default.conf">https://raw.githubusercontent.com/rear/rear/master/usr/share/rear/conf/default.conf</a></p>
<p>There have been some adaptions and enhancements<br />
regarding network devices setup in the rescue/recovery system<br />
since Relax-and-Recover 1.17.2 see the current release notes<br />
<a href="https://raw.githubusercontent.com/rear/rear/master/doc/rear-release-notes.txt">https://raw.githubusercontent.com/rear/rear/master/doc/rear-release-notes.txt</a></p>
<p>Regarding specifically ReaR 1.17.2 on RHEL 7.2<br />
you may better ask the Red Hat support people.</p>
<h4 id="styerd_commented_at_2017-03-31_1227"><img src="https://avatars.githubusercontent.com/u/20077410?v=4" width="50"><a href="https://github.com/styerd">styerd</a> commented at <a href="https://github.com/rear/rear/issues/1274#issuecomment-290698633">2017-03-31 12:27</a>:<a class="headerlink" href="#styerd_commented_at_2017-03-31_1227" title="Permanent link">&para;</a></h4>
<p>We had briefly tried with "USE_DHCLIENT" but that didn't work either
and we haven't debugged in that path. In this path we find that clearing
"DEVICE, DEVICETYPE, and REALDEVICE inside the "for dev in
<code>get_device_by_hwaddr</code>" and making the pid file parameter unique in
58-start-dhclient.sh results in starting dhclient on each interface
which seems to be the intention of this code. Timeouts on the uncabled
ports costs about 5 minutes so our simplest/fastest solution is to
simply replace the "58-start-dhclient.sh" code with a single "dhclient"
command with no device parameter which at least on RHEL7 tries DHCP on
each network interface and works equally as well as starting "dhclient"
on each interface.</p>
<h4 id="gdha_commented_at_2017-04-06_1326"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/issues/1274#issuecomment-292173921">2017-04-06 13:26</a>:<a class="headerlink" href="#gdha_commented_at_2017-04-06_1326" title="Permanent link">&para;</a></h4>
<p>@styerd Could you explain a bit more in detail what you mean with
clearing "DEVICE, DEVICETYPE, and REALDEVICE inside the "for dev in
get_device_by_hwaddr" and making the pid file parameter unique in
58-start-dhclient.sh results in starting dhclient on each interface
which seems to be the intention of this code. I see what you mean with
the pid file...<br />
The time-outs on the un-cabled interface - we could introduce a timeout
call to reduce the amount of time</p>
<h4 id="kyle-walker_commented_at_2017-04-10_1455"><img src="https://avatars.githubusercontent.com/u/4229993?v=4" width="50"><a href="https://github.com/kyle-walker">kyle-walker</a> commented at <a href="https://github.com/rear/rear/issues/1274#issuecomment-292974755">2017-04-10 14:55</a>:<a class="headerlink" href="#kyle-walker_commented_at_2017-04-10_1455" title="Permanent link">&para;</a></h4>
<p>@gdha<br />
I believe the code snippet that @styerd is referring to is:</p>
<p>/usr/share/rear/skel/default/etc/scripts/system-setup.d/58-start-dhclient.sh</p>
<pre><code>    # IPv4 DHCP clients
    case $DHCLIENT_BIN in
            (dhclient)
                    dhclient -lf /var/lib/dhclient/dhclient.leases.${DEVICE} -pf /var/run/dhclient.pid -cf /etc/dhclient.conf ${DEVICE}
            ;;
            (dhcpcd)
                    dhcpcd ${DEVICE}
            ;;
    esac
</code></pre>
<p>The needed change to keep dhclient from failing is:</p>
<pre><code>    # IPv4 DHCP clients
    case $DHCLIENT_BIN in
            (dhclient)
                    dhclient -lf /var/lib/dhclient/dhclient.leases.${DEVICE} -pf /var/run/dhclient.${DEVICE}.pid -cf /etc/dhclient.conf ${DEVICE}
            ;;
            (dhcpcd)
                    dhcpcd ${DEVICE}
            ;;
    esac
</code></pre>
<p>@styerd Is that correct?</p>
<h4 id="styerd_commented_at_2017-04-10_1505"><img src="https://avatars.githubusercontent.com/u/20077410?v=4" width="50"><a href="https://github.com/styerd">styerd</a> commented at <a href="https://github.com/rear/rear/issues/1274#issuecomment-292977837">2017-04-10 15:05</a>:<a class="headerlink" href="#styerd_commented_at_2017-04-10_1505" title="Permanent link">&para;</a></h4>
<p>This is only part of the problem. As coded “$DEVICE” never changes in
the loop.<br />
I wonder if invoking “dhclient” with no DEVICE parameter wouldn’t do
what is intended which seems to be to initiate DHCP on every
interface.<br />
That in fact is our current work around, to remove the loop.</p>
<h4 id="jsmeix_commented_at_2017-12-01_1342"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1274#issuecomment-348497609">2017-12-01 13:42</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-12-01_1342" title="Permanent link">&para;</a></h4>
<p>Probably nothing that needs to be done for ReaR 2.3<br />
so that I set the milestone to ReaR 2.4.</p>
<h4 id="gdha_commented_at_2018-05-10_0835"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/issues/1274#issuecomment-387990330">2018-05-10 08:35</a>:<a class="headerlink" href="#gdha_commented_at_2018-05-10_0835" title="Permanent link">&para;</a></h4>
<p>Changed label 'minor bug' to 'enhancement' as it is not really a bug (it
doesn't break the rescue system). Not urgent to fix so change milestone
'2.4' to 'future'</p>
<h4 id="gerhard-tinned_commented_at_2019-02-13_1336"><img src="https://avatars.githubusercontent.com/u/1536065?u=8500ab477775d25785a756bf03380295a5925651&v=4" width="50"><a href="https://github.com/gerhard-tinned">gerhard-tinned</a> commented at <a href="https://github.com/rear/rear/issues/1274#issuecomment-463201454">2019-02-13 13:36</a>:<a class="headerlink" href="#gerhard-tinned_commented_at_2019-02-13_1336" title="Permanent link">&para;</a></h4>
<p>Having the same issue when trying to perform a restore from a from a
machine with multiple interfaces (all dhcp). The first call to
"dhclient" seems to work and the interface is receiving an IP. All
following calls to dlclient fail. I believe the missing "${DEVICE}" in
the pid-file name is causing the dhclient to exit with the "already
running" error.</p>
<p>Ensuring a seperat pid-file for each dhclinet instance should fix this
issue.</p>
<h4 id="gdha_commented_at_2019-02-26_1033"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/issues/1274#issuecomment-467386363">2019-02-26 10:33</a>:<a class="headerlink" href="#gdha_commented_at_2019-02-26_1033" title="Permanent link">&para;</a></h4>
<p>With the committed PRs this issue can be closed</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2024 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2017-03-30.1274.issue.closed.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/rear/rear-user-guide" class="fa fa-code-fork" style="color: #fcfcfc"> rear/rear-user-guide</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
