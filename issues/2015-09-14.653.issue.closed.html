<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>2015 09 14.653.issue.closed - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "2015 09 14.653.issue.closed";
        var mkdocs_page_input_path = "issues/2015-09-14.653.issue.closed.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/rust.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', '366986045', 'auto');
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a> &raquo;</li>
      <li>2015 09 14.653.issue.closed</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="653_issue_closed_nsr_checklayout_and_backup_expiration"><a href="https://github.com/rear/rear/issues/653">#653 Issue</a> <code>closed</code>: NSR checklayout and backup expiration<a class="headerlink" href="#653_issue_closed_nsr_checklayout_and_backup_expiration" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>enhancement</code>, <code>support / question</code>, <code>fixed / solved / done</code></p>
<h4 id="tomglx_opened_issue_at_2015-09-14_0937"><img src="https://avatars.githubusercontent.com/u/14212818?v=4" width="50"><a href="https://github.com/tomglx">tomglx</a> opened issue at <a href="https://github.com/rear/rear/issues/653">2015-09-14 09:37</a>:<a class="headerlink" href="#tomglx_opened_issue_at_2015-09-14_0937" title="Permanent link">&para;</a></h4>
<p>rear checklayout detects if the prepared iso image is obsolete. But it
doesn't check if all of the available<br />
NSR backups have expired. So how does one prevent this from happening?</p>
<p>I would prefer that checklayout detects this and so a new mkrescue and
backup would be done.<br />
By the standard cron job. What could be the correct way to integrate
this in the checklayout workflow?</p>
<h4 id="gdha_commented_at_2015-09-14_1132"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/issues/653#issuecomment-140045286">2015-09-14 11:32</a>:<a class="headerlink" href="#gdha_commented_at_2015-09-14_1132" title="Permanent link">&para;</a></h4>
<p>@tomglx Indeed that makes sense. How would you include this test? You
are always welcome to prepare a pull request...thx</p>
<h4 id="tomglx_commented_at_2015-09-15_0605"><img src="https://avatars.githubusercontent.com/u/14212818?v=4" width="50"><a href="https://github.com/tomglx">tomglx</a> commented at <a href="https://github.com/rear/rear/issues/653#issuecomment-140290001">2015-09-15 06:05</a>:<a class="headerlink" href="#tomglx_commented_at_2015-09-15_0605" title="Permanent link">&para;</a></h4>
<p>Well, I'm proposing two possible solutions.<br />
#1. Implement a media (backup) dependent script template for checking
the availability and consistency of the made ISO backups. This may also
be handy to check if the iso image is still available on remote targets
like http servers or remote rsync directories.<br />
#2. Introduce a new optional parameter for a refresh interval. If the
age of the last created ISO is older than now - refesh interval, then
checklayout should fail. I would then set this equal to the
NSR_RETENTION_TIME. Problem solved. This solution is media independant
and would help to prevent that none of the other checks detect
inconsistent iso content.</p>
<p>Even if I would knew enough about git to prepare a pull request, I also
would have to know enough<br />
about rear code to implement any of these changes.</p>
<h4 id="gdha_commented_at_2015-09-19_0953"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/issues/653#issuecomment-141642427">2015-09-19 09:53</a>:<a class="headerlink" href="#gdha_commented_at_2015-09-19_0953" title="Permanent link">&para;</a></h4>
<p>I guess a script could be created to do this job, e.g. under
<code>layout/save/NSR/default/65_check_iso_retention_time.sh</code><br />
see (via <code>rear -s checklayout</code>):</p>
<pre><code>Source layout/save/default/40_check_backup_special_files.sh
Source layout/save/default/45_check_bootloader_files.sh
Source layout/save/default/45_check_network_files.sh
Source layout/save/GNU/Linux/50_extract_vgcfg.sh
Source layout/save/GNU/Linux/51_current_disk_usage.sh
Source layout/save/default/60_snapshot_files.sh
</code></pre>
<p>However, the content of the script is for me a bit difficult as I have
no mean to test whatsoever.</p>
<h4 id="tomglx_commented_at_2015-09-19_1514"><img src="https://avatars.githubusercontent.com/u/14212818?v=4" width="50"><a href="https://github.com/tomglx">tomglx</a> commented at <a href="https://github.com/rear/rear/issues/653#issuecomment-141678893">2015-09-19 15:14</a>:<a class="headerlink" href="#tomglx_commented_at_2015-09-19_1514" title="Permanent link">&para;</a></h4>
<p>Here is a draft for such a script. I'm not sure why the content of the
EXIT_CODE variable is ignored.<br />
Leaving by just executing exit 1 does work, but would that be the
correct way?</p>
<pre><code>NSRSERVER=$(cat $VAR_DIR/recovery/nsr_server )
CLIENTNAME=$(hostname)

nsrinfo -s ${NSRSERVER} -N ${ISO_DIR}/${ISO_PREFIX}.iso ${CLIENTNAME} | \
   awk '/objects found/ { if ($1 == 0) exit 1; }'
EXIT_CODE=$?
</code></pre>
<h4 id="gdha_commented_at_2015-09-21_1139"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/issues/653#issuecomment-141948891">2015-09-21 11:39</a>:<a class="headerlink" href="#gdha_commented_at_2015-09-21_1139" title="Permanent link">&para;</a></h4>
<p>@tomglx is the output of <code>nsrinfo | awk ...</code> 1 when ISO is missing when
you run it interactively? If the answer is yes, perhaps you could
replace it with:</p>
<pre><code>EXIT_CODE=$( nsrinfo -s ${NSRSERVER} -N ${ISO_DIR}/${ISO_PREFIX}.iso ${CLIENTNAME} | awk '/objects found/ { if ($1 == 0) exit 1; }' )
</code></pre>
<h4 id="tomglx_commented_at_2015-09-21_1826"><img src="https://avatars.githubusercontent.com/u/14212818?v=4" width="50"><a href="https://github.com/tomglx">tomglx</a> commented at <a href="https://github.com/rear/rear/issues/653#issuecomment-142067801">2015-09-21 18:26</a>:<a class="headerlink" href="#tomglx_commented_at_2015-09-21_1826" title="Permanent link">&para;</a></h4>
<p>@gdha I've included set -xv in the script. Here's the output. Although
EXIT_CODE=1, rear -v checklayout finds no difference.</p>
<pre><code>2015-09-21 20:22:36 Including layout/save/NSR/default/65_check_iso_recoverable.sh
NSRSERVER=$(cat $VAR_DIR/recovery/nsr_server )
cat $VAR_DIR/recovery/nsr_server )
cat $VAR_DIR/recovery/nsr_server 
+++ cat /var/lib/rear/recovery/nsr_server
++ NSRSERVER=cvk001.cvk.de
CLIENTNAME=$(hostname)
hostname)
hostname
+++ hostname
++ CLIENTNAME=cvk017.cvk.de

nsrinfo -s ${NSRSERVER} -N ${ISO_DIR}/${ISO_PREFIX}.isox ${CLIENTNAME} | \
   awk '/objects found/ { if ($1 == 0) exit 1; }'
++ nsrinfo -s cvk001.cvk.de -N /var/lib/rear/output/rear-cvk017.isox cvk017.cvk.de
++ awk '/objects found/ { if ($1 == 0) exit 1; }'
EXIT_CODE=$?
++ EXIT_CODE=1
+ test ''
+ [[ -n '' ]]
+ Log 'Finished running '\''layout/save'\'' stage in 2 seconds'
+ test 1 -gt 0
Stamp)$*"
Stamp)$*
Stamp
++ Stamp
++ date '+%Y-%m-%d %H:%M:%S '
+ echo '2015-09-21 20:22:38 Finished running '\''layout/save'\'' stage in 2 seconds'
2015-09-21 20:22:38 Finished running 'layout/save' stage in 2 seconds
+ SourceStage layout/compare
+ stage=layout/compare
+ shift
+ STARTSTAGE=2
+ Log 'Running '\''layout/compare'\'' stage'
</code></pre>
<h4 id="gdha_commented_at_2015-09-21_1844"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/issues/653#issuecomment-142072201">2015-09-21 18:44</a>:<a class="headerlink" href="#gdha_commented_at_2015-09-21_1844" title="Permanent link">&para;</a></h4>
<p>@tomglx please move your script from layout/save/NSR/default to
layout/compare/NSR/default<br />
My mistake!</p>
<h4 id="tomglx_commented_at_2015-09-21_1939"><img src="https://avatars.githubusercontent.com/u/14212818?v=4" width="50"><a href="https://github.com/tomglx">tomglx</a> commented at <a href="https://github.com/rear/rear/issues/653#issuecomment-142087700">2015-09-21 19:39</a>:<a class="headerlink" href="#tomglx_commented_at_2015-09-21_1939" title="Permanent link">&para;</a></h4>
<p>@gdha it wasn't the location. My fault. I didn't expected that the
message "Disk layout is identical" wouldn't be printed if my test
fails.<br />
Now I've tested further and adapted my script to make it more verbose.
It works.</p>
<pre><code>NSRSERVER=$(cat $VAR_DIR/recovery/nsr_server )
CLIENTNAME=$(hostname)

OBJECTS=$( nsrinfo -s ${NSRSERVER} -N ${ISO_DIR}/${ISO_PREFIX}.iso ${CLIENTNAME} | \
           awk '/objects found/ { print $1; }' )
if [ ${OBJECTS} -eq 0 ]
then
   LogPrint "No Networker ISO Backups found."
   EXIT_CODE=1
else
   LogPrint "${OBJECTS} Networker ISO Backups found."
fi
</code></pre>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2022 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2015-09-14.653.issue.closed.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
