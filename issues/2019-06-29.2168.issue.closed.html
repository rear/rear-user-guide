<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#2168 Issue closed: BORG: Unable to exclude swapfile from backup - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#2168 Issue closed: BORG: Unable to exclude swapfile from backup";
        var mkdocs_page_input_path = "issues/2019-06-29.2168.issue.closed.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a> &raquo;</li>
      <li class="breadcrumb-item active">#2168 Issue closed: BORG: Unable to exclude swapfile from backup</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="2168_issue_closed_borg_unable_to_exclude_swapfile_from_backup"><a href="https://github.com/rear/rear/issues/2168">#2168 Issue</a> <code>closed</code>: BORG: Unable to exclude swapfile from backup<a class="headerlink" href="#2168_issue_closed_borg_unable_to_exclude_swapfile_from_backup" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>support / question</code>, <code>fixed / solved / done</code></p>
<h4 id="gaia_opened_issue_at_2019-06-29_1936"><img src="https://avatars.githubusercontent.com/u/87547?u=97296ad68855cad6e025c97d022ea4ccc44658c3&v=4" width="50"><a href="https://github.com/gaia">gaia</a> opened issue at <a href="https://github.com/rear/rear/issues/2168">2019-06-29 19:36</a>:<a class="headerlink" href="#gaia_opened_issue_at_2019-06-29_1936" title="Permanent link">&para;</a></h4>
<p>Relax-and-Recover 2.5 / 2019-05-10<br />
Debian GNU/Linux 9.9 (stretch)<br />
cat /etc/rear/local.conf: see below<br />
Intel X86_64 bare metal<br />
UEFI with Grub2<br />
Storage (local disk or SSD) and/or SAN (FC or iSCSI or FCoE) and/or
multipath (DM or NVMe): see below</p>
<ul>
<li>Issue</li>
</ul>
<p>I cannot exclude the swapfile from the backup. I've tried different ways
of setting the exclude (single/double quotes, exclude by
mountpoint/components/device, relative/absolute path).</p>
<p>Swap is mounted as /mnt/storage/swapfile on
/dev/mapper/lvmt_storage1-lvmt_storage1. The USB disk where the
backups are stored is /dev/sdc on /mnt/usb/. I've tried to run ReaR with
the drive mounted and unmounted.</p>
<p>The only item I want to backup is the root partition to the USB drive,
with no mountpoints and some standard exclusions. The only item I would
want to restore is also the root partition, leaving the other
filesystems intact. I feel this is a good strategy of backup size vs
safety, as the contents of /zfs_containers2 are on RAID 1 and will be
backed up to /dev/mapper/lvmt_storage1-lvmt_storage1 (also RAID 1) and
the contents of /dev/mapper/lvmt_containers1-lvmt_containers1 are also
backed up to /dev/mapper/lvmt_storage1-lvmt_storage1.</p>
<p>What do I need to do to exclude the swapfile? I am under the impression
that nothing is actually being excluded, as
/dev/mapper/lvmt_storage1-lvmt_storage1 and /zfs_containers2 are
still empty. The only reason I know the swapfile is being included is
because it takes a minute to compress the 32GB before backing it up.</p>
<ul>
<li>
<p>Workaround, if any: None that I am aware of</p>
</li>
<li>
<p>Attachments, as applicable ("rear -D mkrescue/mkbackup/recover"
    debug log files):</p>
</li>
</ul>
<!-- -->

<pre><code># cat local.conf

USB_DEVICE_PARTED_LABEL=gpt
USB_DEVICE_FILESYSTEM=ext4
USING_UEFI_BOOTLOADER=1

OUTPUT=USB
BACKUP=BORG
USB_DEVICE=/dev/disk/by-label/REAR-000
BORGBACKUP_REPO="backups"
BORGBACKUP_UMASK="0002"
BORGBACKUP_PRUNE_DAILY=7
BORGBACKUP_ENC_TYPE="keyfile"
BORGBACKUP_COMPRESSION="lz4"
BORGBACKUP_SHOW_PROGRESS="yes"
BORGBACKUP_SHOW_STATS="yes"
PROGS_BORG=( )
export BORG_PASSPHRASE="xxxxxxx"

export BORG_RELOCATED_REPO_ACCESS_IS_OK="yes"
export BORG_UNKNOWN_UNENCRYPTED_REPO_ACCESS_IS_OK="yes"

# EXCLUDE_COMPONENTS=( swap:mnt/storage/swapfile )
EXCLUDE_MOUNTPOINTS=( /zfs_containers2 )
EXCLUDE_MD=( /dev/md1 /dev/md1p1 )
EXCLUDE_VG=( /dev/mapper/lvmt_containers1-lvmt_containers1 /dev/mapper/lvmt_storage1-lvmt_storage1 /dev/disk/by-label/REAR-000 )

# Tried all of the following
COPY_AS_IS_EXCLUDE=( "${COPY_AS_IS_EXCLUDE[@]}" "home/*/.cache/*" "var/cache/*" "var/tmp/*" "dev/*" "media/*" "proc/*" "sys/*" "tmp/*" "var/run/*" "var/lock/*" "mnt/storage/swapfile" )
#COPY_AS_IS_EXCLUDE=( "${COPY_AS_IS_EXCLUDE[@]}" 'home/*/.cache/*' 'var/cache/*' 'var/tmp/*' 'dev/*' 'media/*' 'proc/*' 'sys/*' 'tmp/*' 'var/run/*' 'var/lock/*' 'mnt/storage/swapfile' )
#COPY_AS_IS_EXCLUDE=( "${COPY_AS_IS_EXCLUDE[@]}"  '/mnt/storage/*' '/mnt/containers/*' '/mnt/usb/*' '/mnt/bindmounts/*' '/zfs_containers2/*')

COPY_AS_IS_BORG=( )

SSH_UNPROTECTED_PRIVATE_KEYS="yes"
SSH_FILES="yes"

# cat /var/lib/rear/layout/disklayout.conf

disk /dev/nvme0n1 2048408248320 unknown

disk /dev/sda 2000398934016 gpt

part /dev/sda 510656512 1048576 rear-noname boot,esp /dev/sda1
part /dev/sda 53687091200 511705088 rear-noname none /dev/sda2
part /dev/sda 161061273600 54198796288 Linux%20filesystem none /dev/sda3
part /dev/sda 1785138847232 215260069888 Linux%20RAID raid /dev/sda4

disk /dev/sdb 2000398934016 gpt
part /dev/sdb 510656512 1048576 rear-noname boot,esp /dev/sdb1
part /dev/sdb 53687091200 511705088 rear-noname raid /dev/sdb2
part /dev/sdb 161061273600 54198796288 Linux%20filesystem none /dev/sdb3
part /dev/sdb 1785138847232 215260069888 Linux%20RAID raid /dev/sdb4

raid /dev/md1 metadata=1.2 level=raid1 raid-devices=2 uuid=38538483:ffefcbb8:3cca39c8:811c0d15 name=1 devices=/dev/sda4,/dev/sdb4
part /dev/md1 1785003556352 1048576 rear-noname none /dev/md1p1
raid /dev/md0 metadata=1.2 level=raid1 raid-devices=2 uuid=ba8a642c:2deff1d1:2d4392b6:9afc60b1 name=0 devices=/dev/sda2,/dev/sdb2

lvmdev /dev/lvmt_storage1 /dev/md1p1 mWXwl0-CmLf-EbXw-2dS0-OrW2-R1Gs-50DRVa 3486335071
lvmdev /dev/lvmt_containers1 /dev/nvme0n1 VF2lWK-uLZ0-qQdt-NLXk-gdsj-Cc9E-umRtCj 4000797360

lvmgrp /dev/lvmt_storage1 4096 425577 1743163392
lvmgrp /dev/lvmt_containers1 4096 488378 2000396288

lvmvol /dev/lvmt_containers1 lvmt_containers1 2048154140672b thin,pool chunksize:1048576b
lvmvol /dev/lvmt_storage1 lvmt_storage1 1784781209600b thin,pool chunksize:1048576b

fs /dev/mapper/lvmt_containers1-lvmt_containers1 /mnt/containers ext4 uuid=b3dc563a-08ca-4cfd-9a18-3d82d6518306 label= blocksize=4096 reserved_blocks=4% max_mounts=-1 check_interval=0d bytes_per_inode=16383 default_mount_options=user_xattr,acl options=rw,relatime,stripe=256,data=ordered
fs /dev/mapper/lvmt_storage1-lvmt_storage1 /mnt/storage ext4 uuid=0f924dc4-4c1f-4722-aaed-8d48c3fc0651 label= blocksize=4096 reserved_blocks=5% max_mounts=-1 check_interval=0d bytes_per_inode=16383 default_mount_options=user_xattr,acl options=rw,relatime,stripe=256,data=ordered
fs /dev/md0 / ext4 uuid=fe3e3b7f-e8fd-4a9e-ba7b-5f8947e62488 label= blocksize=4096 reserved_blocks=4% max_mounts=-1 check_interval=0d bytes_per_inode=16373 default_mount_options=user_xattr,acl options=rw,relatime,errors=remount-ro,data=ordered
fs /dev/sda1 /boot/efi vfat uuid=FE89-3DF9 label= options=rw,relatime,fmask=0077,dmask=0077,codepage=437,iocharset=iso8859-1,shortname=mixed,errors=remount-ro

# cat /etc/fstab

UUID=fe3e3b7f-e8fd-4a9e-ba7b-5f8947e62488 /               ext4    errors=remount-ro 0       1
UUID=FE89-3DF9  /boot/efi       vfat    umask=0077      0       1

# NVME SSD: LVM thin for containers
/dev/mapper/lvmt_containers1-lvmt_containers1 /mnt/containers ext4 defaults,nofail 0 0
#/dev/nvme0n1p1 auto mounts to /zfs_containers

# WD Red RAID 1: LVM thin for backups
/dev/mapper/lvmt_storage1-lvmt_storage1 /mnt/storage ext4 defaults,nofail 0 0

# Swapfile
/mnt/storage/swapfile swap swap defaults 0 0


# cat /proc/mounts

sysfs /sys sysfs rw,nosuid,nodev,noexec,relatime 0 0
proc /proc proc rw,nosuid,nodev,noexec,relatime 0 0
udev /dev devtmpfs rw,nosuid,relatime,size=16400444k,nr_inodes=4100111,mode=755 0 0
devpts /dev/pts devpts rw,nosuid,noexec,relatime,gid=5,mode=620,ptmxmode=000 0 0
tmpfs /run tmpfs rw,nosuid,noexec,relatime,size=3284084k,mode=755 0 0
/dev/md0 / ext4 rw,relatime,errors=remount-ro,data=ordered 0 0
securityfs /sys/kernel/security securityfs rw,nosuid,nodev,noexec,relatime 0 0
tmpfs /dev/shm tmpfs rw,nosuid,nodev 0 0
tmpfs /run/lock tmpfs rw,nosuid,nodev,noexec,relatime,size=5120k 0 0
tmpfs /sys/fs/cgroup tmpfs ro,nosuid,nodev,noexec,mode=755 0 0
cgroup /sys/fs/cgroup/systemd cgroup rw,nosuid,nodev,noexec,relatime,xattr,release_agent=/lib/systemd/systemd-cgroups-agent,name=systemd 0 0
pstore /sys/fs/pstore pstore rw,nosuid,nodev,noexec,relatime 0 0
efivarfs /sys/firmware/efi/efivars efivarfs rw,nosuid,nodev,noexec,relatime 0 0
cgroup /sys/fs/cgroup/pids cgroup rw,nosuid,nodev,noexec,relatime,pids 0 0
cgroup /sys/fs/cgroup/devices cgroup rw,nosuid,nodev,noexec,relatime,devices 0 0
cgroup /sys/fs/cgroup/memory cgroup rw,nosuid,nodev,noexec,relatime,memory 0 0
cgroup /sys/fs/cgroup/cpu,cpuacct cgroup rw,nosuid,nodev,noexec,relatime,cpu,cpuacct 0 0
cgroup /sys/fs/cgroup/hugetlb cgroup rw,nosuid,nodev,noexec,relatime,hugetlb 0 0
cgroup /sys/fs/cgroup/freezer cgroup rw,nosuid,nodev,noexec,relatime,freezer 0 0
cgroup /sys/fs/cgroup/rdma cgroup rw,nosuid,nodev,noexec,relatime,rdma 0 0
cgroup /sys/fs/cgroup/cpuset cgroup rw,nosuid,nodev,noexec,relatime,cpuset 0 0
cgroup /sys/fs/cgroup/net_cls,net_prio cgroup rw,nosuid,nodev,noexec,relatime,net_cls,net_prio 0 0
cgroup /sys/fs/cgroup/perf_event cgroup rw,nosuid,nodev,noexec,relatime,perf_event 0 0
cgroup /sys/fs/cgroup/blkio cgroup rw,nosuid,nodev,noexec,relatime,blkio 0 0
systemd-1 /proc/sys/fs/binfmt_misc autofs rw,relatime,fd=33,pgrp=1,timeout=0,minproto=5,maxproto=5,direct,pipe_ino=17913 0 0
hugetlbfs /dev/hugepages hugetlbfs rw,relatime,pagesize=2M 0 0
mqueue /dev/mqueue mqueue rw,relatime 0 0
debugfs /sys/kernel/debug debugfs rw,relatime 0 0
sunrpc /run/rpc_pipefs rpc_pipefs rw,relatime 0 0
configfs /sys/kernel/config configfs rw,relatime 0 0
fusectl /sys/fs/fuse/connections fusectl rw,relatime 0 0
/dev/mapper/lvmt_containers1-lvmt_containers1 /mnt/containers ext4 rw,relatime,stripe=256,data=ordered 0 0
/dev/mapper/lvmt_storage1-lvmt_storage1 /mnt/storage ext4 rw,relatime,stripe=256,data=ordered 0 0
/dev/sda1 /boot/efi vfat rw,relatime,fmask=0077,dmask=0077,codepage=437,iocharset=iso8859-1,shortname=mixed,errors=remount-ro 0 0
zfs_containers2 /zfs_containers2 zfs rw,xattr,noacl 0 0
lxcfs /var/lib/lxcfs fuse.lxcfs rw,nosuid,nodev,relatime,user_id=0,group_id=0,allow_other 0 0
/dev/fuse /etc/pve fuse rw,nosuid,nodev,relatime,user_id=0,group_id=0,default_permissions,allow_other 0 0
tmpfs /run/user/1000 tmpfs rw,nosuid,nodev,relatime,size=3284080k,mode=700,uid=1000,gid=1000 0 0
</code></pre>
<h4 id="gozora_commented_at_2019-06-29_2016"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/2168#issuecomment-506984363">2019-06-29 20:16</a>:<a class="headerlink" href="#gozora_commented_at_2019-06-29_2016" title="Permanent link">&para;</a></h4>
<p>Since Borg is using same exclude mechanism as e.g. NETFS, can you try
some of
<a href="https://github.com/rear/rear/blob/master/usr/share/rear/conf/default.conf#L2387">https://github.com/rear/rear/blob/master/usr/share/rear/conf/default.conf#L2387</a>,
especially <code>EXCLUDE_BACKUP</code> can be usefull.</p>
<p>V.</p>
<h4 id="gaia_commented_at_2019-06-30_1930"><img src="https://avatars.githubusercontent.com/u/87547?u=97296ad68855cad6e025c97d022ea4ccc44658c3&v=4" width="50"><a href="https://github.com/gaia">gaia</a> commented at <a href="https://github.com/rear/rear/issues/2168#issuecomment-507061166">2019-06-30 19:30</a>:<a class="headerlink" href="#gaia_commented_at_2019-06-30_1930" title="Permanent link">&para;</a></h4>
<p>thanks.</p>
<p>what is the syntax for EXCLUDE_BACKUP ?</p>
<p>should I use only EXCLUDE_BACKUP instead of all the below variables?<br />
EXCLUDE_MOUNTPOINTS<br />
EXCLUDE_VG<br />
EXCLUDE_WD<br />
COPY_AS_IS_EXCLUDE</p>
<h4 id="gaia_commented_at_2019-07-01_0032"><img src="https://avatars.githubusercontent.com/u/87547?u=97296ad68855cad6e025c97d022ea4ccc44658c3&v=4" width="50"><a href="https://github.com/gaia">gaia</a> commented at <a href="https://github.com/rear/rear/issues/2168#issuecomment-507080721">2019-07-01 00:32</a>:<a class="headerlink" href="#gaia_commented_at_2019-07-01_0032" title="Permanent link">&para;</a></h4>
<p>tried</p>
<p><code>EXCLUDE_BACKUP=( ${EXCLUDE_BACKUP[@]} fs:/home/*/.cache/* fs:/var/cache/* fs:/var/tmp/* fs:/dev/* fs:/media/* fs:/proc/* fs:/sys/* fs:/tmp/* fs:/var/run/* fs:/var/lock/* fs:/mnt/storage/swapfile )</code></p>
<p>and</p>
<p><code>EXCLUDE_BACKUP=( ${EXCLUDE_BACKUP[@]} fs:/mnt/storage/swapfile )</code></p>
<p>still backed up swapfile</p>
<h4 id="jsmeix_commented_at_2019-07-01_1225"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2168#issuecomment-507243012">2019-07-01 12:25</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-07-01_1225" title="Permanent link">&para;</a></h4>
<p>@gaia<br />
I do not use Borg backup but as far as I see in<br />
usr/share/rear/backup/BORG/default/500_make_backup.sh<br />
it uses the same $TMP_DIR/backup-include.txt mechanism via<br />
usr/share/rear/backup/BORG/default/400_create_include_exclude_files.sh<br />
that is a symlink to<br />
usr/share/rear/backup/NETFS/default/400_create_include_exclude_files.sh<br />
and therein is</p>
<pre><code># Implicitly also backup all local filesystems as defined in mountpoint_device
...
        # Add the mountpoints that will be recovered to the backup include list
        # unless a mountpoint is excluded:
        while read mountpoint device junk ; do
            if ! IsInArray "$mountpoint" "${EXCLUDE_MOUNTPOINTS[@]}" ; then
                echo "$mountpoint"
            fi
        done &lt;"$VAR_DIR/recovery/mountpoint_device" &gt;&gt; $TMP_DIR/backup-include.txt
</code></pre>
<p>I think you should run "rear -D mkbackup" in debug mode<br />
and inspect the log file what exactly hapens in your case<br />
how $TMP_DIR/backup-include.txt is filled up.</p>
<p>Additionally you may use <code>KEEP_BUILD_DIR</code> so that you can see what<br />
in $TMP_DIR/backup-include.txt actually is in your particular case.<br />
That file is located in <code>/tmp/rear.XXX/tmp/backup-include.txt</code>.<br />
See the <code>KEEP_BUILD_DIR</code> description in default.conf e.g. online at<br />
<a href="https://github.com/rear/rear/blob/master/usr/share/rear/conf/default.conf#L128">https://github.com/rear/rear/blob/master/usr/share/rear/conf/default.conf#L128</a></p>
<p>I guess you may need <code>BACKUP_ONLY_INCLUDE</code> to switch off<br />
that automatism, see its description in default.conf e.g. online at<br />
<a href="https://github.com/rear/rear/blob/master/usr/share/rear/conf/default.conf#L976">https://github.com/rear/rear/blob/master/usr/share/rear/conf/default.conf#L976</a><br />
but then you must explicitly specify all you want to have in your
backup.</p>
<h4 id="gaia_commented_at_2019-07-03_2115"><img src="https://avatars.githubusercontent.com/u/87547?u=97296ad68855cad6e025c97d022ea4ccc44658c3&v=4" width="50"><a href="https://github.com/gaia">gaia</a> commented at <a href="https://github.com/rear/rear/issues/2168#issuecomment-508257706">2019-07-03 21:15</a>:<a class="headerlink" href="#gaia_commented_at_2019-07-03_2115" title="Permanent link">&para;</a></h4>
<p>Thank you, I used -d to keep the tmp dir.</p>
<p>I assumed the swapfile is being backed up because I see
<code>13.85 GB O 54.40 MB C 65.95 kB D 0 N mnt/storage/swapfile</code> during the
backup process (and it goes up to 32GB, size of swap). But
<code>ll /tmp/rear*/rootfs/mnt/</code> shows only <code>cdrom local</code>, and none of the
other folders in /mnt. if the swap is not being backed up, why does the
backup process spend most of its time on compressing the swapfile? just
curious, as I've given up. Let the swapfile be included.</p>
<p>What I can't give up on is /home and other dirs (although some not
important) not being included in the backup:</p>
<p><img alt="image" src="https://user-images.githubusercontent.com/87547/60625387-826ab100-9d9c-11e9-9b64-20286abf61fb.png" /></p>
<p>lsblk:</p>
<p><img alt="image" src="https://user-images.githubusercontent.com/87547/60625556-01f88000-9d9d-11e9-856f-59086fb7a7b3.png" /></p>
<p>PS: I can't use INCLUDE_ONLY at all. this is a recipe for disaster when
you are trying to backup a root partition. the only possibility would be
using borg directly to backup the root FS and having rear backup only
the resulting borg repo.</p>
<p>here's the current local.conf:</p>
<pre><code>BACKUP=BORG
OUTPUT=USB
USB_DEVICE=/dev/disk/by-label/REAR-000
BACKUP_URL=usb:///dev/disk/by-label/REAR-000
###
USB_DEVICE_PARTED_LABEL=gpt
USB_DEVICE_FILESYSTEM=ext4
USING_UEFI_BOOTLOADER=1
###
SSH_UNPROTECTED_PRIVATE_KEYS="yes"
SSH_FILES="yes"
###
EXCLUDE_MOUNTPOINTS=( 'zfs_containers2' 'mnt/storage' 'mnt/containers' 'mnt/usb' 'mnt/bindmounts' 'mnt/storage/swapfile' )
EXCLUDE_MD=( /dev/md1 )
EXCLUDE_VG=( /dev/mapper/lvmt_containers1-lvmt_containers1 /dev/mapper/lvm_storage1-lvm_storage1 )
###
BORGBACKUP_REPO="/node2_borg"
BORGBACKUP_UMASK="0002"
BORGBACKUP_PRUNE_DAILY=7
BORGBACKUP_ENC_TYPE="keyfile"
BORGBACKUP_COMPRESSION="lz4"
BORGBACKUP_SHOW_PROGRESS="yes"
BORGBACKUP_SHOW_STATS="yes"
BORGBACKUP_REPO="/node2_borg_backup"
export BORG_PASSPHRASE="xxxxxxxxxxxxxx"
export BORG_RELOCATED_REPO_ACCESS_IS_OK="yes"
export BORG_UNKNOWN_UNENCRYPTED_REPO_ACCESS_IS_OK="yes"
###
PROGS_BORG=( )
COPY_AS_IS_EXCLUDE=( "${COPY_AS_IS_EXCLUDE[@]}" 'home/*/.cache/*' 'var/cache/*' 'var/tmp/*' 'dev/*' 'media/*' 'proc/*' 'sys/*' 'tmp/*' 'var/run/*' 'var/lock/*' '/mnt/storage/swapfile' )
COPY_AS_IS_BORG=(  )
COPY_AS_IS_BORG=( "${COPY_AS_IS[@]}" "/usr/src/linux-headers-4.15.18-16-pve" "/usr/share/file/magic" )
</code></pre>
<p>backup-include.txt (why are the first two included?)</p>
<pre><code>/mnt/storage
/mnt/containers
/
/boot/efi
</code></pre>
<p>backup-exclude.txt:</p>
<pre><code>/tmp/*
/dev/shm/*
/var/lib/rear/output/*
/tmp/rear.8zBQExtwAOKXB07
zfs_containers2/
mnt/storage/
mnt/containers/
mnt/usb/
mnt/bindmounts/
mnt/storage/swapfile/
</code></pre>
<h4 id="jsmeix_commented_at_2019-07-04_1227"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2168#issuecomment-508464761">2019-07-04 12:27</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-07-04_1227" title="Permanent link">&para;</a></h4>
<p>usr/share/rear/layout/save/default/340_generate_mountpoint_device.sh<br />
generates<br />
/tmp/rear.XXX/rootfs/...var/lib/rear/recovery/mountpoint_device<br />
which is used by<br />
usr/share/rear/backup/BORG/default/400_create_include_exclude_files.sh<br />
that is a symlink to<br />
usr/share/rear/backup/NETFS/default/400_create_include_exclude_files.sh<br />
to generate<br />
/tmp/rear.XXX/tmp/backup-include.txt<br />
and<br />
/tmp/rear.XXX/tmp/backup-exclude.txt<br />
which are used for 'tar' by<br />
usr/share/rear/backup/NETFS/default/500_make_backup.sh<br />
and for Borg by<br />
usr/share/rear/backup/BORG/default/500_make_backup.sh<br />
to actually make the backup.</p>
<p>I do not use Borg but plain 'tar'<br />
and for me BACKUP_ONLY_INCLUDE "just works".</p>
<p>I compared in etc/rear/local.conf<br />
the default behaviour without BACKUP_ONLY_INCLUDE and
BACKUP_PROG_INCLUDE<br />
with BACKUP_ONLY_INCLUDE and an explicit BACKUP_PROG_INCLUDE listing</p>
<pre><code>BACKUP_ONLY_INCLUDE="yes"
BACKUP_PROG_INCLUDE=( / /boot/efi )
</code></pre>
<p>and I got exactly the same files in my backup in both cases.</p>
<p>I have those real disk filesystems mounted</p>
<pre><code># mount | grep dev/sd
/dev/sda2 on / type ext4 ...
/dev/sda1 on /boot/efi type vfat ...
</code></pre>
<p>accordingly I need to specify <code>/</code> and <code>/boot/efi</code> in
BACKUP_PROG_INCLUDE.</p>
<p>I got a /tmp/rear.XXX/tmp/backup-include.txt file that contains</p>
<pre><code>/
/boot/efi
</code></pre>
<p>All what BACKUP_ONLY_INCLUDE requires for me with 'tar'<br />
is explicit listing of those mounted real disk filesystems<br />
that should be included in the backup in BACKUP_PROG_INCLUDE.</p>
<p>This is because 'tar' is called in<br />
usr/share/rear/backup/NETFS/default/500_make_backup.sh<br />
and 'borg create' is called in<br />
usr/share/rear/backup/BORG/default/500_make_backup.sh<br />
both with the '--one-file-system' option<br />
so from plain loooking at the code it looks to me as if<br />
BACKUP_ONLY_INCLUDE work same for Borg and 'tar'.</p>
<p>But I don't know if things may actually behave different with Borg<br />
because I do not use Borg.</p>
<h4 id="gaia_commented_at_2019-07-04_1628"><img src="https://avatars.githubusercontent.com/u/87547?u=97296ad68855cad6e025c97d022ea4ccc44658c3&v=4" width="50"><a href="https://github.com/gaia">gaia</a> commented at <a href="https://github.com/rear/rear/issues/2168#issuecomment-508533560">2019-07-04 16:28</a>:<a class="headerlink" href="#gaia_commented_at_2019-07-04_1628" title="Permanent link">&para;</a></h4>
<p>thanks. I tried with</p>
<pre><code>BACKUP_ONLY_INCLUDE="yes"
BACKUP_PROG_INCLUDE=( / /boot/efi )
</code></pre>
<p>with no exclusions. it still did not include /home (and others)</p>
<p>could i use borg separately, and use rear to backup only the borg backup
to the USB? I'd imagine I'd first restore with rear a minimal system,
then restore the actual system with borg on a 2nd pass.</p>
<h4 id="adatum_commented_at_2019-08-10_1937"><img src="https://avatars.githubusercontent.com/u/9773655?v=4" width="50"><a href="https://github.com/adatum">adatum</a> commented at <a href="https://github.com/rear/rear/issues/2168#issuecomment-520174392">2019-08-10 19:37</a>:<a class="headerlink" href="#adatum_commented_at_2019-08-10_1937" title="Permanent link">&para;</a></h4>
<p>@gaia What about using only <code>rear mkrescue</code> and including the <code>borg</code>
executable in the available programs? Use <code>rear</code> to recover the system
layout and then handle backup restore in the usual ways with <code>borg</code>,
hopefully all from the rescue environment.</p>
<h4 id="gaia_commented_at_2019-08-11_1455"><img src="https://avatars.githubusercontent.com/u/87547?u=97296ad68855cad6e025c97d022ea4ccc44658c3&v=4" width="50"><a href="https://github.com/gaia">gaia</a> commented at <a href="https://github.com/rear/rear/issues/2168#issuecomment-520234604">2019-08-11 14:55</a>:<a class="headerlink" href="#gaia_commented_at_2019-08-11_1455" title="Permanent link">&para;</a></h4>
<p>@adatum that's what I ended up doing. thanks.</p>
<h4 id="jsmeix_commented_at_2019-08-12_1317"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2168#issuecomment-520420650">2019-08-12 13:17</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-08-12_1317" title="Permanent link">&para;</a></h4>
<p>@gaia<br />
and addedum FYI:</p>
<p>When you use</p>
<pre><code>BACKUP_ONLY_INCLUDE="yes"
BACKUP_PROG_INCLUDE=( / /boot/efi )
</code></pre>
<p>the whole point of BACKUP_ONLY_INCLUDE="yes" is<br />
that only / and /boot/efi are in the backup (and not including /home and
others)<br />
so to get also e.g. /home in the backup you would have to use</p>
<pre><code>BACKUP_ONLY_INCLUDE="yes"
BACKUP_PROG_INCLUDE=( / /boot/efi /home )
</code></pre>
<p>when /home is mounted separately or behaves this way.</p>
<p>Strange - it seems in your case /home in not mounted separately.<br />
Could it be that in your case /home is not just a normal directory in
the<br />
root filesystem but something special so that Borg backup treats it<br />
as if it is not on the same '--one-file-system' as / is?<br />
E.g. btrfs subvolumes behave this way.</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2023 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2019-06-29.2168.issue.closed.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
