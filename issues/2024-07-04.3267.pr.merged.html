<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#3267 PR merged: improve device recognition when creating efibootmgr entry - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#3267 PR merged: improve device recognition when creating efibootmgr entry";
        var mkdocs_page_input_path = "issues/2024-07-04.3267.pr.merged.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#3267 PR merged: improve device recognition when creating efibootmgr entry</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="3267_pr_merged_improve_device_recognition_when_creating_efibootmgr_entry"><a href="https://github.com/rear/rear/pull/3267">#3267 PR</a> <code>merged</code>: improve device recognition when creating efibootmgr entry<a class="headerlink" href="#3267_pr_merged_improve_device_recognition_when_creating_efibootmgr_entry" title="Permanent link">&para;</a></h1>
<h4 id="damm620_opened_issue_at_2024-07-04_1312"><img src="https://avatars.githubusercontent.com/u/170947477?v=4" width="50"><a href="https://github.com/damm620">damm620</a> opened issue at <a href="https://github.com/rear/rear/pull/3267">2024-07-04 13:12</a>:<a class="headerlink" href="#damm620_opened_issue_at_2024-07-04_1312" title="Permanent link">&para;</a></h4>
<h5 id="pull_request_details">Pull Request Details:<a class="headerlink" href="#pull_request_details" title="Permanent link">&para;</a></h5>
<ul>
<li>
<p>Type: <strong>Bug Fix</strong></p>
</li>
<li>
<p>Impact: <strong>Critical</strong></p>
</li>
<li>
<p>Reference to related issue (URL):<br />
    fixes
    <a href="https://github.com/rear/rear/issues/3265">https://github.com/rear/rear/issues/3265</a></p>
</li>
<li>
<p>How was this pull request tested?<br />
    on own servers</p>
</li>
<li>
<p>Description of the changes in this pull request:<br />
    the devices and partition numbers used to create an entry in
    efibootmgr were not properly crafted when having multipath devices
    (mpd_boot_1p1). this is fixed by this PR</p>
</li>
</ul>
<h4 id="gdha_commented_at_2024-07-08_0937"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/pull/3267#issuecomment-2213529557">2024-07-08 09:37</a>:<a class="headerlink" href="#gdha_commented_at_2024-07-08_0937" title="Permanent link">&para;</a></h4>
<p>@rear/contributors Would like to merge this PR on Friday 12 July 2024 if
there are no objections from the ReaR contributors?</p>
<h4 id="damm620_commented_at_2024-07-11_1442"><img src="https://avatars.githubusercontent.com/u/170947477?v=4" width="50"><a href="https://github.com/damm620">damm620</a> commented at <a href="https://github.com/rear/rear/pull/3267#issuecomment-2223121510">2024-07-11 14:42</a>:<a class="headerlink" href="#damm620_commented_at_2024-07-11_1442" title="Permanent link">&para;</a></h4>
<p>@schlomo</p>
<blockquote>
<p>Can't test, LGTM in principle.</p>
<p>I find this code (both the old and new version) very hard to read &amp;
understand because it re-uses variables with different content and it
is not really self-explanatory.</p>
<p>May I therefore suggest to expand it a little bit, to use different
variable names for different steps of the process, and to maybe add a
comment that illustrates the data coming in and going out of this code
block? To help understand how the input and output look like.</p>
<p>Especially for special cases like multipath it will help future
developers to understand the code if there are examples of typical
input and output in the comments.</p>
</blockquote>
<p>I did hopefully clearify the code a bit. Do you have any additional
suggestions?</p>
<h4 id="damm620_commented_at_2024-07-11_1501"><img src="https://avatars.githubusercontent.com/u/170947477?v=4" width="50"><a href="https://github.com/damm620">damm620</a> commented at <a href="https://github.com/rear/rear/pull/3267#issuecomment-2223169133">2024-07-11 15:01</a>:<a class="headerlink" href="#damm620_commented_at_2024-07-11_1501" title="Permanent link">&para;</a></h4>
<blockquote>
<p>Ahh. now I understand the code.</p>
<p>I guess you could do this instead:</p>
<pre><code>read pkname kname mountpoint too_many_results &lt;&lt;&lt;$(lsblk -nrpo PKNAME,KNAME,MOUNTPOINT | grep '/boot/efi'|sort -u)
test "$pkname" -a -z "$too_many_results" || LogPrintError "cannot determine /boot/efi disk and partition devices:$LF$pkname $kname $mountpoint $too_many_results"
efi_disk=$(get_device_name $pkname)
efi_part=$(get_device_name $kname)
</code></pre>
<p>I personally would find that easier to read but that again is also a
lot of personal opinion.</p>
</blockquote>
<p>Your example confuses me more than clearifies. Everybodys taste is a bit
different I guess, but I am glad we find a solution here :)</p>
<blockquote>
<p>Could you test that the recovered system can boot from the <em>other</em>
multipath device, e.g. if you recover, shutdown, remove the first link
to the multipath device, and boot again?</p>
</blockquote>
<p>I our systems we use multipath to have different path to the same
storage lun. So in the end you are writing data to the same lun,
regardless with (multi-)path you are using. Or did I misunterstood you
question?</p>
<h4 id="schlomo_commented_at_2024-07-11_1505"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/3267#issuecomment-2223179850">2024-07-11 15:05</a>:<a class="headerlink" href="#schlomo_commented_at_2024-07-11_1505" title="Permanent link">&para;</a></h4>
<blockquote>
<blockquote>
<p>Could you test that the recovered system can boot from the <em>other</em>
multipath device, e.g. if you recover, shutdown, remove the first
link to the multipath device, and boot again?</p>
</blockquote>
<p>I our systems we use multipath to have different path to the same
storage lun. So in the end you are writing data to the same lun,
regardless with (multi-)path you are using. Or did I misunterstood you
question?</p>
</blockquote>
<p>With multipath I would always check that the system can boot from the
secondary path. The problem is maybe not the boot code on disk but the
UEFI boot entry that only points to the primary path and not the
secondary path as a fallback.</p>
<p>When I read the issue description I thought that for multipath devices
you would actually create multie EFI boot entries, one per path, to
facilitate booting off the secondary paths.</p>
<h4 id="damm620_commented_at_2024-07-12_0727"><img src="https://avatars.githubusercontent.com/u/170947477?v=4" width="50"><a href="https://github.com/damm620">damm620</a> commented at <a href="https://github.com/rear/rear/pull/3267#issuecomment-2224988668">2024-07-12 07:27</a>:<a class="headerlink" href="#damm620_commented_at_2024-07-12_0727" title="Permanent link">&para;</a></h4>
<blockquote>
<blockquote>
<blockquote>
<p>Could you test that the recovered system can boot from the <em>other</em>
multipath device, e.g. if you recover, shutdown, remove the first
link to the multipath device, and boot again?</p>
</blockquote>
<p>I our systems we use multipath to have different path to the same
storage lun. So in the end you are writing data to the same lun,
regardless with (multi-)path you are using. Or did I misunterstood
you question?</p>
</blockquote>
<p>With multipath I would always check that the system can boot from the
secondary path. The problem is maybe not the boot code on disk but the
UEFI boot entry that only points to the primary path and not the
secondary path as a fallback.</p>
<p>When I read the issue description I thought that for multipath devices
you would actually create multie EFI boot entries, one per path, to
facilitate booting off the secondary paths.</p>
</blockquote>
<p>Maybe I do not understand the concept of EFI correctly, but I our case
we do have the /boot/efi and /boot as two partitions on the same disk.
So when the system finds the EFI partition, it should also find the
kernel to load the linux.</p>
<p>Should I do anything now regarding this PR?</p>
<h4 id="schlomo_commented_at_2024-07-12_0743"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/3267#issuecomment-2225013724">2024-07-12 07:43</a>:<a class="headerlink" href="#schlomo_commented_at_2024-07-12_0743" title="Permanent link">&para;</a></h4>
<p>I'll merge it now and we see how it goes.</p>
<p>I'd really appreciate it if you could do the test I mentioned, to be
sure that a recovered system will boot also from the other / secondary
multipath devices.</p>
<p>Please ensure to wipe the EFI boot records on the recovery system before
the test to be sure that there is no "leftover" old configuration.</p>
<p>For illustration: On my home PC the EFI boot entries look like this:</p>
<pre><code>$ sudo efibootmgr -v
BootCurrent: 0001
Timeout: 5 seconds
BootOrder: 0001,0002
Boot0001* ubuntu    HD(1,GPT,ef2a7e35-5378-4d76-8d7c-024c8f67de08,0x800,0x100000)/File(\EFI\UBUNTU\GRUBX64.EFI)..BO
Boot0002* UEFI OS   HD(1,GPT,ef2a7e35-5378-4d76-8d7c-024c8f67de08,0x800,0x100000)/File(\EFI\BOOT\BOOTX64.EFI)..BO
</code></pre>
<p>I must confess to the fact that I also don't know the details of the EFI
boot entries, and I don't know if a secondary multipath device will look
the same as the primary device to the UEFI firmware. Hence the idea to
test.</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2024 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2024-07-04.3267.pr.merged.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/rear/rear-user-guide" class="fa fa-code-fork" style="color: #fcfcfc"> rear/rear-user-guide</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
