<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#3027 PR merged: Make sure rescue contains all COPY_AS_IS files - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#3027 PR merged: Make sure rescue contains all COPY_AS_IS files";
        var mkdocs_page_input_path = "issues/2023-07-19.3027.pr.merged.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/backup_netfs.html">Example of BACKUP=NETFS</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../development/squash-git-log-commments.html">How to squash git log comments into one line</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear29.html">Release Notes ReaR 2.9</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear28.html">Release Notes ReaR 2.8</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#3027 PR merged: Make sure rescue contains all COPY_AS_IS files</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="3027_pr_merged_make_sure_rescue_contains_all_copy_as_is_files"><a href="https://github.com/rear/rear/pull/3027">#3027 PR</a> <code>merged</code>: Make sure rescue contains all COPY_AS_IS files<a class="headerlink" href="#3027_pr_merged_make_sure_rescue_contains_all_copy_as_is_files" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>bug</code>, <code>fixed / solved / done</code></p>
<h4 id="rmetrich_opened_issue_at_2023-07-19_0818"><img src="https://avatars.githubusercontent.com/u/1163635?u=36b5e32e1dd55f1ce77cad431a5683fce40a7934&v=4" width="50"><a href="https://github.com/rmetrich">rmetrich</a> opened issue at <a href="https://github.com/rear/rear/pull/3027">2023-07-19 08:18</a>:<a class="headerlink" href="#rmetrich_opened_issue_at_2023-07-19_0818" title="Permanent link">&para;</a></h4>
<h4 id="relax-and-recover_rear_pull_request_template">Relax-and-Recover (ReaR) Pull Request Template<a class="headerlink" href="#relax-and-recover_rear_pull_request_template" title="Permanent link">&para;</a></h4>
<p>Please fill in the following items before submitting a new pull request:</p>
<h5 id="pull_request_details">Pull Request Details:<a class="headerlink" href="#pull_request_details" title="Permanent link">&para;</a></h5>
<ul>
<li>
<p>Type: <strong>Bug Fix</strong></p>
</li>
<li>
<p>Impact: <strong>Normal</strong></p>
</li>
<li>
<p>Reference to related issue (URL): N/A</p>
</li>
<li>
<p>How was this pull request tested?</p>
</li>
</ul>
<p>Using an automated reproducer implemented using <em>systemtap</em></p>
<ol>
<li>
<p>Create a file in <code>/dev</code> which will be embedded in the rescue
    environment</p>
<pre><code># dd if=/dev/urandom of=/dev/shrinking bs=10K count=3
3+0 records in
3+0 records out
30720 bytes (31 kB, 30 KiB) copied, 0.000689566 s, 44.5 MB/s
</code></pre>
</li>
<li>
<p>Execute the systemtap script in charge of shrinking the file while
    being copied</p>
<pre><code># stap -v -g ./shrinking.stp
[...]
Pass 5: starting run.
</code></pre>
</li>
<li>
<p>Execute <code>rear mkrescue</code> from another terminal</p>
</li>
<li>
<p>Brief description of the changes in this pull request:</p>
</li>
</ol>
<p>The files copied as-is in the rescue are copied using a
<code>tar -c | tar -x</code> command.<br />
It may happen that inodes are shrinking during the copy (e.g.
<code>/dev/mqueue/nnsc</code> (HPE device)), which can cause the <code>tar -x</code> command
to stop extracting the next files, due to the padding zeros inserted in
the shrank inode.<br />
This leads to an error when checking the integrity of the rescue
environment.</p>
<p>The solution is to add <code>-i</code> option when extracting, to continue the
processing.</p>
<h4 id="rmetrich_commented_at_2023-07-19_0821"><img src="https://avatars.githubusercontent.com/u/1163635?u=36b5e32e1dd55f1ce77cad431a5683fce40a7934&v=4" width="50"><a href="https://github.com/rmetrich">rmetrich</a> commented at <a href="https://github.com/rear/rear/pull/3027#issuecomment-1641643084">2023-07-19 08:21</a>:<a class="headerlink" href="#rmetrich_commented_at_2023-07-19_0821" title="Permanent link">&para;</a></h4>
<p>Without the fix:</p>
<pre><code>ERROR: ReaR recovery system in '/var/tmp/rear.tpfZyNy6ayS53wP/rootfs' not usable (required libraries are missing)
Some latest log messages since the last called script 990_verify_rootfs.sh:
  wipefs is /bin/wipefs
  mkfs is /bin/mkfs
  mkfs.xfs is /bin/mkfs.xfs
  xfs_admin is /bin/xfs_admin
  mkswap is /bin/mkswap
  cryptsetup is /bin/cryptsetup
  dmsetup is /bin/dmsetup
  ldconfig is /bin/ldconfig
</code></pre>
<p>The reason is everything after <code>/dev/shrinking</code> is not copied, because
<code>tar -x</code> stopped silently (without error, believing the end of the
archive was reached):</p>
<pre><code># grep -A 2 shrinking /var/tmp/rear.tpfZyNy6ayS53wP/tmp/copy-as-is-filelist 
/dev/shrinking
tar: /dev/shrinking: File shrank by 5120 bytes; padding with zeros
/dev/vcsa6
/dev/vcs6

# ls -l /var/tmp/rear.tpfZyNy6ayS53wP/rootfs/dev/shrinking /var/tmp/rear.tpfZyNy6ayS53wP/rootfs/dev/vcsa6
ls: cannot access '/var/tmp/rear.tpfZyNy6ayS53wP/rootfs/dev/vcsa6': No such file or directory
-rw-r--r--. 1 root root 30720 Jul 19 10:12 /var/tmp/rear.tpfZyNy6ayS53wP/rootfs/dev/shrinking
</code></pre>
<h4 id="rmetrich_commented_at_2023-07-19_0822"><img src="https://avatars.githubusercontent.com/u/1163635?u=36b5e32e1dd55f1ce77cad431a5683fce40a7934&v=4" width="50"><a href="https://github.com/rmetrich">rmetrich</a> commented at <a href="https://github.com/rear/rear/pull/3027#issuecomment-1641645382">2023-07-19 08:22</a>:<a class="headerlink" href="#rmetrich_commented_at_2023-07-19_0822" title="Permanent link">&para;</a></h4>
<p>systemtap <code>shrinking.stp</code> script:</p>
<pre><code>global openat
global to_catch
global shrinking_fd
global nread

probe syscall.openat {
    if (execname() != "tar") next
    if (filename_unquoted != "shrinking") next
    to_catch[tid()] = 1
    openat[tid()] = 1
}

probe syscall.openat.return {
    if (! openat[tid()]) next
    delete openat[tid()]
    shrinking_fd = retval
    nread = 0
    printf("FD is %ld\n", retval)
}

probe syscall.close {
    if (! to_catch[tid()]) next
    if (fd != shrinking_fd) next
    delete to_catch[tid()]
}

probe syscall.read {
    if (! to_catch[tid()]) next
    if (fd != shrinking_fd) next
    nread++
    if (nread &lt; 3) next
    printf("Truncating the file\n")
    system("truncate -s 25K /dev/shrinking")
    mdelay(2000)
    exit()
}
</code></pre>
<h4 id="gdha_commented_at_2023-07-19_0833"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/pull/3027#issuecomment-1641660730">2023-07-19 08:33</a>:<a class="headerlink" href="#gdha_commented_at_2023-07-19_0833" title="Permanent link">&para;</a></h4>
<p>@rmetrich Hi - is this related to Message Queue brokers? Could you say
something about the background of this issue? I also saw from time to
time that <code>dd</code> seems to hang, but this could be the same issue as I saw
it on kubernetes nodes with RabbitMQ pods...</p>
<h4 id="rmetrich_commented_at_2023-07-19_0847"><img src="https://avatars.githubusercontent.com/u/1163635?u=36b5e32e1dd55f1ce77cad431a5683fce40a7934&v=4" width="50"><a href="https://github.com/rmetrich">rmetrich</a> commented at <a href="https://github.com/rear/rear/pull/3027#issuecomment-1641682056">2023-07-19 08:47</a>:<a class="headerlink" href="#rmetrich_commented_at_2023-07-19_0847" title="Permanent link">&para;</a></h4>
<blockquote>
<p>@rmetrich Hi - is this related to Message Queue brokers? Could you say
something about the background of this issue? I also saw from time to
time that <code>dd</code> seems to hang, but this could be the same issue as I
saw it on kubernetes nodes with RabbitMQ pods...</p>
</blockquote>
<p>Yes this was seen with <code>/dev/mqueue/nnsc</code> device node, something shipped
by HPE apparently. One of my customer constantly hits the issue when
building the ISO.</p>
<h4 id="pcahyna_commented_at_2023-07-19_0900"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/3027#issuecomment-1641702832">2023-07-19 09:00</a>:<a class="headerlink" href="#pcahyna_commented_at_2023-07-19_0900" title="Permanent link">&para;</a></h4>
<p>Is <code>/dev/mqueue/nnsc</code> really a device node, or a regular file? I think
the content of device special files should not be copied - only the
inode (metadata) ...</p>
<h4 id="rmetrich_commented_at_2023-07-19_0944"><img src="https://avatars.githubusercontent.com/u/1163635?u=36b5e32e1dd55f1ce77cad431a5683fce40a7934&v=4" width="50"><a href="https://github.com/rmetrich">rmetrich</a> commented at <a href="https://github.com/rear/rear/pull/3027#issuecomment-1641769188">2023-07-19 09:44</a>:<a class="headerlink" href="#rmetrich_commented_at_2023-07-19_0944" title="Permanent link">&para;</a></h4>
<blockquote>
<p>Is <code>/dev/mqueue/nnsc</code> really a device node, or a regular file? I think
the content of device special files should not be copied - only the
inode (metadata) ...</p>
</blockquote>
<p>It seems to be a regular file:</p>
<pre><code>/dev/mqueue:
total 0
drwxrwxrwt.  2 0 0   60 Jun 17 20:04 .
drwxr-xr-x. 23 0 0 5740 Jun 18 19:30 ..
---x--x--T.  1 0 0   80 Jun 21 13:30 nnsc
</code></pre>
<p>But none of this really matters, all we must take care of is archives
with zero padding can be extracted properly.</p>
<h4 id="jsmeix_commented_at_2023-07-19_1138"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/3027#issuecomment-1641923272">2023-07-19 11:38</a>:<a class="headerlink" href="#jsmeix_commented_at_2023-07-19_1138" title="Permanent link">&para;</a></h4>
<p>@rmetrich<br />
thank you for your prompt explanatory comment!</p>
<h4 id="jsmeix_commented_at_2023-07-19_1139"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/3027#issuecomment-1641924205">2023-07-19 11:38</a>:<a class="headerlink" href="#jsmeix_commented_at_2023-07-19_1139" title="Permanent link">&para;</a></h4>
<p>@rear/contributors<br />
I would like to merge it tomorrow afternoon<br />
unless there are objections</p>
<h4 id="jsmeix_commented_at_2023-07-19_1150"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/3027#issuecomment-1641940634">2023-07-19 11:50</a>:<a class="headerlink" href="#jsmeix_commented_at_2023-07-19_1150" title="Permanent link">&para;</a></h4>
<p>Only for the log (for completeness):</p>
<p>I will never fully understand how 'tar' works.<br />
Neither the old GNU tar version 1.15.1 man page (see above)<br />
nor the newer GNU tar version 1.34 man page (in openSUSE Leap 15.4)</p>
<pre><code>-i, --ignore-zeros
Ignore zeroed blocks in archive.
Normally two consecutive 512-blocks filled with zeroes mean EOF
and tar stops reading after encountering them.
This option instructs it to read further and
is useful when reading archives created with the -A option.
</code></pre>
<p>explain why "blocks filled with zeroes mean EOF" in 'tar'.<br />
At least for me this is unexpected behaviour of a program<br />
when reading a sequence of zero bytes means EOF<br />
so "sequence of zero bytes" == "end of file" ?</p>
<h4 id="rmetrich_commented_at_2023-07-19_1151"><img src="https://avatars.githubusercontent.com/u/1163635?u=36b5e32e1dd55f1ce77cad431a5683fce40a7934&v=4" width="50"><a href="https://github.com/rmetrich">rmetrich</a> commented at <a href="https://github.com/rear/rear/pull/3027#issuecomment-1641941973">2023-07-19 11:51</a>:<a class="headerlink" href="#rmetrich_commented_at_2023-07-19_1151" title="Permanent link">&para;</a></h4>
<blockquote>
<p>@rmetrich nice find and thanks for making ReaR more robust in general.</p>
<p>Beyond that, does the rescue system actually need those mqueue files?
If not then I'd suggest to also exclude them from the rescue image, as
it will debloat or unclutter the rescue image.</p>
<p>If this is a common thing then we can also add it to the default
exclude list, IMHO.</p>
</blockquote>
<p>It's probably not useful, as most of the devices in <code>/dev</code> are (knowing
that all is supposed to be generated, on RHEL at least).</p>
<h4 id="jsmeix_commented_at_2023-07-19_1200"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/3027#issuecomment-1641955414">2023-07-19 12:00</a>:<a class="headerlink" href="#jsmeix_commented_at_2023-07-19_1200" title="Permanent link">&para;</a></h4>
<p>Related to this pull request<br />
but not actually belonging to this pull request:</p>
<p>We copy by default all in /dev/ into the recovery system</p>
<pre><code># find /dev | wc -l
732

# usr/sbin/rear -D mkrescue
...

# find /var/tmp/rear.nSzlPYGQ1Nk9v9w/rootfs/dev | wc -l
728
</code></pre>
<p>because of</p>
<pre><code>COPY_AS_IS+=( /dev ...
</code></pre>
<p>in usr/share/rear/conf/GNU/Linux.conf<br />
<a href="https://github.com/rear/rear/blob/master/usr/share/rear/conf/GNU/Linux.conf#L231">https://github.com/rear/rear/blob/master/usr/share/rear/conf/GNU/Linux.conf#L231</a><br />
which is there since the beginning according to</p>
<pre><code># git log --follow -p usr/share/rear/conf/GNU/Linux.conf
</code></pre>
<p>I made a separated issue<br />
<a href="https://github.com/rear/rear/issues/3028">https://github.com/rear/rear/issues/3028</a></p>
<h4 id="jsmeix_commented_at_2023-07-20_1316"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/3027#issuecomment-1643909277">2023-07-20 13:16</a>:<a class="headerlink" href="#jsmeix_commented_at_2023-07-20_1316" title="Permanent link">&para;</a></h4>
<p>@rmetrich<br />
thank you for your problem analysis and your fix!</p>
<p>It is much appreciated to get ReaR working<br />
more fail-safe even in corner cases like this one.</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2025 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2023-07-19.3027.pr.merged.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/rear/rear-user-guide" class="fa fa-code-fork" style="color: #fcfcfc"> rear/rear-user-guide</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
