<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#36 Issue closed: Copy complains 'are the same file' during mkbackup - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#36 Issue closed: Copy complains \u0027are the same file\u0027 during mkbackup";
        var mkdocs_page_input_path = "issues/2012-03-29.36.issue.closed.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/backup_netfs.html">Example of BACKUP=NETFS</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../development/squash-git-log-commments.html">How to squash git log comments into one line</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear29.html">Release Notes ReaR 2.9</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear28.html">Release Notes ReaR 2.8</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#36 Issue closed: Copy complains 'are the same file' during mkbackup</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="36_issue_closed_copy_complains_are_the_same_file_during_mkbackup"><a href="https://github.com/rear/rear/issues/36">#36 Issue</a> <code>closed</code>: Copy complains 'are the same file' during mkbackup<a class="headerlink" href="#36_issue_closed_copy_complains_are_the_same_file_during_mkbackup" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>bug</code></p>
<h4 id="dagwieers_opened_issue_at_2012-03-29_0906"><img src="https://avatars.githubusercontent.com/u/388198?u=0732dee3fe5002278cfbf40359ec431bdcf5f06c&v=4" width="50"><a href="https://github.com/dagwieers">dagwieers</a> opened issue at <a href="https://github.com/rear/rear/issues/36">2012-03-29 09:06</a>:<a class="headerlink" href="#dagwieers_opened_issue_at_2012-03-29_0906" title="Permanent link">&para;</a></h4>
<p>Reported by retvog at
SF#<a href="https://sourceforge.net/tracker/?func=detail&amp;aid=3485728&amp;group_id=171835&amp;atid=859452">3485728</a>
on 2012-02-08 05:20:11 PST</p>
<h2 id="original_report">Original report<a class="headerlink" href="#original_report" title="Permanent link">&para;</a></h2>
<p>I just tried to make the ISO of an RHEL x64 6.2 Installation with ReaR
version 1.12. But during the execution of <code>rear mkbackup</code> I always get
the following error:</p>
<pre><code>[root@ws11 tmp]# rear -d mkbackup
2012-02-08 14:08:38.970702426 Using \'blkid\' for vol_id
Relax and Recover 1.12.0 / 2011-11-22 10:21:35 +0100
Creating disk layout
Creating root FS layout
WARNING: To login as root via ssh you need to setup an authorized_keys file in /root/.ssh
Copy files and directories
Copy program files &amp; libraries
ERROR: [LibCopyTo] Could not copy \'/usr/local/ibm/gsk8/lib/libgsk8cms.so\' to \'/tmp/rear.euxhvPZ676LzJGh/rootfs/lib\'
Aborting due to an error, check /tmp/rear-ws11.log for details
Finished in 3 seconds
You should also rm -Rf /tmp/rear.euxhvPZ676LzJGh
Terminated
[root@ws11 tmp]#
</code></pre>
<p>The same procedure with version 1.11 does work. We use IBM Tivoli as
Backup solution.</p>
<p>The error log reports a file duplication ...:</p>
<p>... (list of binaries and libraries ommited)</p>
<pre><code>cp: `/usr/local/ibm/gsk8/lib/libgsk8cms.so\' and `/tmp/rear.ySBEWR3uxIv22as/rootfs/lib/libgsk8cms.so\' are the same file
Trace: 122 StopIfError /usr/share/rear/lib/_input-output-functions.sh
Trace: 134 LibCopyTo /usr/share/rear/lib/linux-functions.sh
Trace: 61 source /usr/share/rear/build/GNU/Linux/39_copy_binaries_libraries.sh
Trace: 40 Source /usr/share/rear/lib/framework-functions.sh
Trace: 79 SourceStage /usr/share/rear/lib/framework-functions.sh
Trace: 24 WORKFLOW_mkbackup /usr/share/rear/lib/mkbackup-workflow.sh
Trace: 242 main /usr/sbin/rear
2012-02-08 14:12:55 ERROR: [LibCopyTo] Could not copy \'/usr/local/ibm/gsk8/lib/libgsk8cms.so\' to \'/tmp/rear.ySBEWR3uxIv22as/rootfs/lib\'
2012-02-08 14:12:55 Running exit tasks.
2012-02-08 14:12:55 Finished in 3 seconds
2012-02-08 14:12:55 Removing build area /tmp/rear.ySBEWR3uxIv22as
2012-02-08 14:12:55 End of program reached
</code></pre>
<p>What could be the problem here?</p>
<h4 id="dagwieers_commented_at_2012-03-29_0906"><img src="https://avatars.githubusercontent.com/u/388198?u=0732dee3fe5002278cfbf40359ec431bdcf5f06c&v=4" width="50"><a href="https://github.com/dagwieers">dagwieers</a> commented at <a href="https://github.com/rear/rear/issues/36#issuecomment-4800308">2012-03-29 09:06</a>:<a class="headerlink" href="#dagwieers_commented_at_2012-03-29_0906" title="Permanent link">&para;</a></h4>
<p>The original report on Sourceforge at
SF#<a href="https://sourceforge.net/tracker/?func=detail&amp;aid=3485728&amp;group_id=171835&amp;atid=859452">3485728</a>
contains a lot more details.</p>
<h4 id="dagwieers_commented_at_2012-03-29_1126"><img src="https://avatars.githubusercontent.com/u/388198?u=0732dee3fe5002278cfbf40359ec431bdcf5f06c&v=4" width="50"><a href="https://github.com/dagwieers">dagwieers</a> commented at <a href="https://github.com/rear/rear/issues/36#issuecomment-4809333">2012-03-29 11:26</a>:<a class="headerlink" href="#dagwieers_commented_at_2012-03-29_1126" title="Permanent link">&para;</a></h4>
<p>What is happening here is this:</p>
<pre><code>[dag@moria test]$ vim a.txt
[dag@moria test]$ ln -sf a.txt b.txt
[dag@moria test]$ cp -a a.txt b.txt
cp: `a.txt' and `b.txt' are the same file
</code></pre>
<p>The reason this is happening is because both file's device and inode are
the same (the device and inode of the symlink are those of the file):</p>
<pre><code>[dag@moria test]$ stat --printf '%n %D %i\n' a.txt
a.txt fd02 1705409
[dag@moria test]$ stat --printf '%n %D %i\n' b.txt
b.txt fd02 1705408
[dag@moria test]$ stat -L --printf '%n %D %i\n' b.txt
b.txt fd02 1705409
</code></pre>
<p>Which means that cp is dereferencing TARGET.</p>
<p>Why the symlink already exists, that is the real question, I thought the
list of files to copy would be sort'd/uniq'd. Either we prevent the same
file to be copied twice, or we check if the file already exists (and
points to the same file). If not, error out...</p>
<h4 id="dagwieers_commented_at_2012-03-29_1129"><img src="https://avatars.githubusercontent.com/u/388198?u=0732dee3fe5002278cfbf40359ec431bdcf5f06c&v=4" width="50"><a href="https://github.com/dagwieers">dagwieers</a> commented at <a href="https://github.com/rear/rear/issues/36#issuecomment-4809575">2012-03-29 11:29</a>:<a class="headerlink" href="#dagwieers_commented_at_2012-03-29_1129" title="Permanent link">&para;</a></h4>
<p>Or we could simply use:</p>
<pre><code>cp -a --remove-destination a.txt b.txt
</code></pre>
<p>or</p>
<pre><code>cp -au a.txt b.txt
</code></pre>
<h4 id="dagwieers_commented_at_2012-03-29_1207"><img src="https://avatars.githubusercontent.com/u/388198?u=0732dee3fe5002278cfbf40359ec431bdcf5f06c&v=4" width="50"><a href="https://github.com/dagwieers">dagwieers</a> commented at <a href="https://github.com/rear/rear/issues/36#issuecomment-4811978">2012-03-29 12:07</a>:<a class="headerlink" href="#dagwieers_commented_at_2012-03-29_1207" title="Permanent link">&para;</a></h4>
<p>OK, after talking this through with Jeroen, we understand what is
happening and the cause of the issue is that /usr/bin is a symlink to
/bin. Let me explain:</p>
<ul>
<li>If a binary file in /opt is symlinked to both /bin and /usr/bin, our
    copying will first copy the symlink in /bin and then the symlink in
    /usr/bin, since /usr/bin is a symlink to bin we are replacing two
    identical symlinks (and we are dereferencing both SOURCE and
    TARGET), <strong>BOOM</strong> same file</li>
<li>Imagine a binary file in /bin that is symlinked to /usr/bin, our
    copying will first copy the original file to /bin, and then the
    symlink in /usr/bin, since /usr/bin is a symlink to /bin we are
    trying to replace the real file with a symlink (to itself). <strong>BOOM</strong>
    same file</li>
</ul>
<p>The exact same thing happens for /lib and /usr/lib, which is what we
believe are seeing here. Which means that none of the proposed solutions
would actually help:</p>
<ul>
<li>we cannot remove the destination, because we might replace a binary
    with a symlink to itself</li>
<li>we cannot update the file (if newer) because the original could be
    the symlink, not the real file</li>
<li>we cannot harmonize (sort -u) the complete list of files, because
    those files look unique but are not because of the
    /bin-and-/usr/bin-symlink</li>
</ul>
<p>Which brings us to the heart of the matter: <strong>Why are we symlinking
/usr/bin to /bin and /usr/lib to /lib ?</strong></p>
<p>Maybe we should leave the merge of /bin, /lib and /usr up to the
distribution and is it better to leave everything as it is working on
the system ?</p>
<h4 id="schlomo_commented_at_2012-03-29_1355"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/issues/36#issuecomment-4819444">2012-03-29 13:55</a>:<a class="headerlink" href="#schlomo_commented_at_2012-03-29_1355" title="Permanent link">&para;</a></h4>
<p>Hi,</p>
<p>as the one who originally decided upon the file structure in the
rescue<br />
system I can try to shed some light on the history...</p>
<p>On 29 March 2012 14:07, Dag Wieërs &lt;<br />
<a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#114;&#101;&#112;&#108;&#121;&#64;&#114;&#101;&#112;&#108;&#121;&#46;&#103;&#105;&#116;&#104;&#117;&#98;&#46;&#99;&#111;&#109;">&#114;&#101;&#112;&#108;&#121;&#64;&#114;&#101;&#112;&#108;&#121;&#46;&#103;&#105;&#116;&#104;&#117;&#98;&#46;&#99;&#111;&#109;</a></p>
<blockquote>
<p>wrote:</p>
<p>OK, after talking this through with Jeroen, we understand what is<br />
happening and the cause of the issue is that /usr/bin is a symlink to
/bin.<br />
Let me explain:</p>
<ul>
<li>If a binary file in /opt is symlinked to both /bin and /usr/bin,
    our<br />
    copying will first copy the symlink in /bin and then the symlink
    in<br />
    /usr/bin, since /usr/bin is a symlink to bin we are replacing two
    identical<br />
    symlinks (and we are dereferencing both SOURCE and TARGET),
    <strong>BOOM</strong> same<br />
    file</li>
<li>Imagine a binary file in /bin that is symlinked to /usr/bin, our<br />
    copying will first copy the original file to /bin, and then the
    symlink in<br />
    /usr/bin, since /usr/bin is a smlink to bin we are trying to
    replace the<br />
    real file with a symlink (to itself). <em>BOOM</em> same file</li>
</ul>
</blockquote>
<p>Thanks for analyzing this, I concur that this sound like the likely
root<br />
cause.</p>
<blockquote>
<p>The exact same thing happens for /lib and /usr/lib, which is what we<br />
believe are seeing here. Which brings us to the heart of the matter:
<em>Why<br />
are we symlinking /usr/bin to /bin and /usr/lib to /lib ?</em></p>
<p>Maybe we should leave the merge of /bin, /lib and /usr up to the<br />
distribution and is it better to leave it as it is working on the
system ?</p>
</blockquote>
<p>Back then we found that different distros spread the binaries a little
bit<br />
differntly through /bin and /usr/bin. Instead of faithfully copying that
I<br />
decided to unify everything into /bin and /lib and symlink all other<br />
locations to support software that uses hard-coded paths. Back then
this<br />
decision significantly simplified the code.</p>
<p>Maybe we should revisit this decision and think about faithfully
cloning<br />
the source OS. Maybe it is enough to simply not fail ReaR if cp meets
the<br />
same file and rely on cp to dereference symlinks. That way we could
keep<br />
our simplified rescue root.</p>
<p>I would say that the final decision is up to those who write the code
and<br />
validate it...</p>
<p>Regards,<br />
Schlomo</p>
<h4 id="dagwieers_commented_at_2012-03-29_1405"><img src="https://avatars.githubusercontent.com/u/388198?u=0732dee3fe5002278cfbf40359ec431bdcf5f06c&v=4" width="50"><a href="https://github.com/dagwieers">dagwieers</a> commented at <a href="https://github.com/rear/rear/issues/36#issuecomment-4820107">2012-03-29 14:05</a>:<a class="headerlink" href="#dagwieers_commented_at_2012-03-29_1405" title="Permanent link">&para;</a></h4>
<p>We have moved this issue to Rear v1.15 milestone since it has worked for
so long without any issues. Since a change to the core of Rear is
something that needs to be well tested, we will wait until we have the
automated testing infrastructure (Rear v1.14) in place so we can see
what the effect is of our changes on the various supported and tested
distributions.</p>
<p>So while I would like to see this fixed asap, let's make sure we get our
priorities right.</p>
<h4 id="gdha_commented_at_2012-05-10_1021"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/issues/36#issuecomment-5621946">2012-05-10 10:21</a>:<a class="headerlink" href="#gdha_commented_at_2012-05-10_1021" title="Permanent link">&para;</a></h4>
<p>Be aware that in Fedora 17 /bin is a symlink to /usr/bin (so fedora
reversed the logic). In rear we keep the symlink to /bin and create
other directories if required. That piece of code has already been
changed (especially for F17)</p>
<h4 id="dagwieers_commented_at_2012-06-03_0016"><img src="https://avatars.githubusercontent.com/u/388198?u=0732dee3fe5002278cfbf40359ec431bdcf5f06c&v=4" width="50"><a href="https://github.com/dagwieers">dagwieers</a> commented at <a href="https://github.com/rear/rear/issues/36#issuecomment-6081793">2012-06-03 00:16</a>:<a class="headerlink" href="#dagwieers_commented_at_2012-06-03_0016" title="Permanent link">&para;</a></h4>
<p>Fixed by Upstart expert @jhoekx in commit
c1ef53238ee009d726d8a2da8ad4b8526393ca88 :-)</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2025 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2012-03-29.36.issue.closed.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/rear/rear-user-guide" class="fa fa-code-fork" style="color: #fcfcfc"> rear/rear-user-guide</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
