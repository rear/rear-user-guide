<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#2705 PR merged: minimal changes needed for hybrid boot (bios+uefi) - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#2705 PR merged: minimal changes needed for hybrid boot (bios+uefi)";
        var mkdocs_page_input_path = "issues/2021-10-29.2705.pr.merged.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/backup_netfs.html">Example of BACKUP=NETFS</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/netfs_nas.html">Internal Backup with tar to NFS server</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/rbme.html">External Backup using RBME</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/restic.html">External Backup using restic</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../development/squash-git-log-commments.html">How to squash git log comments into one line</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear29.html">Release Notes ReaR 2.9</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear28.html">Release Notes ReaR 2.8</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#2705 PR merged: minimal changes needed for hybrid boot (bios+uefi)</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="2705_pr_merged_minimal_changes_needed_for_hybrid_boot_biosuefi"><a href="https://github.com/rear/rear/pull/2705">#2705 PR</a> <code>merged</code>: minimal changes needed for hybrid boot (bios+uefi)<a class="headerlink" href="#2705_pr_merged_minimal_changes_needed_for_hybrid_boot_biosuefi" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>enhancement</code>, <code>cleanup</code>, <code>fixed / solved / done</code>,
<code>hacktoberfest-accepted</code></p>
<h4 id="devil0000_opened_issue_at_2021-10-29_1635"><img src="https://avatars.githubusercontent.com/u/3344302?v=4" width="50"><a href="https://github.com/DEvil0000">DEvil0000</a> opened issue at <a href="https://github.com/rear/rear/pull/2705">2021-10-29 16:35</a>:<a class="headerlink" href="#devil0000_opened_issue_at_2021-10-29_1635" title="Permanent link">&para;</a></h4>
<ul>
<li>Type: <strong>New Feature</strong> / <strong>Enhancement</strong></li>
<li>Impact: <strong>Normal</strong></li>
<li>Reference to related issue (URL): #2698</li>
<li>How was this pull request tested?<br />
    created with the following config on a BIOS machine:</li>
</ul>
<!-- -->

<pre><code>OUTPUT=USB
BACKUP=BORG
USB_DEVICE=/dev/disk/by-label/REAR-000
USB_DEVICE_FILESYSTEM_LABEL=REAR-000
USB_DEVICE_PARTED_LABEL=gpt
USB_DEVICE_FILESYSTEM=ext4
USB_UEFI_PART_SIZE="512"
CLONE_USERS=(root)
CLONE_GROUPS=(root)
CLONE_ALL_USERS_GROUPS="false"
BORGBACKUP_REPO="/borg"
BORGBACKUP_UMASK="0002"
BORGBACKUP_ENC_TYPE="repokey"
export BORG_RELOCATED_REPO_ACCESS_IS_OK="yes"
export BORG_UNKNOWN_UNENCRYPTED_REPO_ACCESS_IS_OK="yes"
export TMPDIR="/wsp_var/tmp/"
USE_RESOLV_CONF="no"
USE_DHCLIENT=no
USE_STATIC_NETWORKING=1
USE_SERIAL_CONSOLE=y
COPY_KERNEL_PARAMETERS=( 'net.ifnames' 'biosdevname', 'console' )
REAR_INITRD_COMPRESSION="fast"
USING_UEFI_BOOTLOADER=1
OUTPUT_URL=usb:///dev/disk/by-label/REARBOOT
USB_BOOTLOADER=grub
GRUB2_DEFAULT_BOOT="1"
USB_BOOT_PART_SIZE="2048"
MODULES=( 'no_modules' )
FIRMWARE_FILES=( 'no' )
EXCLUDE_RUNTIME_LOGFILE="yes"
SERIAL_CONSOLE_DEVICES="/dev/ttyS0"
</code></pre>
<p>tested boot on PCEngines APU2 (BIOS) and HP gen9 UEFI.</p>
<ul>
<li>
<p>Brief description of the changes in this pull request:<br />
    As discussed in #2698 this is a startingpoint for implementing a
    hybrid boot supporting BIOS and UEFI from the same media.</p>
</li>
<li>
<p>prerequisit:<br />
    For this to work you must have the following packages installed:
    <code>grub-efi-amd64-bin</code> and <code>grub-pc-bin</code>. They will install the grub
    binaries needed for efi and bios boot installation. Don't confuse
    those packages with <code>grub-efi</code>, <code>grub-efi-amd64</code> and <code>grub-pc</code> which
    configure the systems primary boot option and they conflict the
    other one for a reason I don't quite get. (this is on ubuntu 20.04)</p>
</li>
<li>
<p>format command change<br />
    In addition to the --efi format switch I added a --bios switch. If
    none is given it will do a hybrid installation.</p>
</li>
<li>
<p>more details:<br />
    This is more like a minimal changeset and prrof of concept but not a
    full featured or super clean PR.<br />
    Since realizing how this is done in <code>RAWDISK</code> (basically a complete
    rewrite bypassing lib code and features) and that <code>RAWDISK</code> does use
    syslinux but not grub (with which I am more familiar) I decided to
    ignore the <code>RAWDISK</code> for the moment.<br />
    I mostly rearanged the code in 300_format_usb_disk.sh without
    changing much beside checking the --efi/--bios switches. There are
    however two fixes to mention: 1) setting esp with parted for EFI to
    have the correct partition type set. 2) using partprobe more offten
    to make sure data gets written to the correct locations. I think
    this code change is very clean.<br />
    The code change in 850_save_sysfs_uefi_vars.sh is a bit more
    hacky and you may want to do this differently.<br />
    I did not change output/USB/Linux-i386/300_create_grub.sh for the
    moment since it was not strictly needed but it may be better to
    install the grub efi binary with
    <code>grub-install --efi-directory=&lt;path&gt; --target=x86_64-efi --recheck &lt;device&gt;</code>
    instead of the way done in 850_save_sysfs_uefi_vars.sh and such.</p>
</li>
<li>
<p>future work:</p>
</li>
<li>
<p>while working on this I realized once more that the same basic stuff
    like partitioning, formatting, writing bootloaders and boot config
    is written multiple times in the code base and basically every
    workflow and output method has its own rewrites instead of using
    some common lib code for those things. I think a major cleanup of
    those things would make perfect sense. Maybe starting with the
    partitioning code - moving in a library script and creating
    functions out of it.</p>
</li>
<li>Also testing is very time consuming and a bit of a pain due to all
    those options and combinations. Maybe it would be a good idea to use
    some build/test server. For example by adding travis jobs or such.</li>
<li>Since I only did the work for <code>output=USB</code> and <code>GRUB</code> it may make
    sense to add this feature to all variants or deprecate some of
    those. Also keep in mind that GRUB could mount a ISO image and boot
    from there (stored on boot partition / where the kernel and initrd
    is stored).</li>
<li>When using Serial tty and non Serial tty machines the grub config is
    at the moment not flexible enough to provide both options. One with
    ttyS0 and one entry with just tty. This issue may occur everywhere a
    tty is used in some sort. So thats also some feature or more
    flexibiliy to consider adding.</li>
</ul>
<p>Of course I would like to see a merge and the hacktoberfest-accepted
label ;)<br />
I am aware that this PR is not touching all config variants and is maybe
not super clean. A complete integration on all configuration variants
would however mean a quite big change.</p>
<p>edit: please note that there is no 32bit grub efi I know of but it may
exist</p>
<h4 id="jsmeix_commented_at_2021-11-02_0811"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2705#issuecomment-957187997">2021-11-02 08:11</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-11-02_0811" title="Permanent link">&para;</a></h4>
<p>@DEvil0000<br />
thank you for your enhancement and cleanup work.<br />
It is much appreciated!</p>
<p>I will test it soon...</p>
<h4 id="jsmeix_commented_at_2021-11-02_0854"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2705#issuecomment-957233707">2021-11-02 08:54</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-11-02_0854" title="Permanent link">&para;</a></h4>
<p>I think the reason why in ReaR same functionality is implemented<br />
several times in separated code instead of using common library
functions<br />
is that contributions happen this way.</p>
<p>I think this is because for an individual contributor it is simpler<br />
and more straightforward to implement what he specifically needs<br />
in his own separated code than to adapt and enhance already existing
code<br />
because the latter may cause regressions in special cases of the
existing code<br />
or in areas of the existing code where the current contributor has no
good knowledge<br />
in particular when the existing code is not well documented so the
current contributor<br />
cannot fully understand why existing code is as is so he better does not
touch it,<br />
cf.
<a href="https://github.com/rear/rear/wiki/Coding-Style">https://github.com/rear/rear/wiki/Coding-Style</a></p>
<p>Also we ReaR uspream maintainers usually don't have sufficient
knowledge<br />
in all those various different areas what ReaR is about (we are not
better<br />
than any other contributor) to be able to make generic common
functions<br />
from various code pieces that do not have regressions or shortcomings.<br />
In particular we can not at all test all the possible cases of existing
code<br />
so in general we don't touch existing code unless we must.<br />
Simply put: There is no "master mind" who could clean it all up.</p>
<p>I think in the end we must accept that in practice<br />
ReaR's code as a whole cannot be clean,<br />
cf. "Dirty hacks welcome" in<br />
<a href="https://github.com/rear/rear/wiki/Coding-Style">https://github.com/rear/rear/wiki/Coding-Style</a></p>
<p>This does not mean that certain parts of ReaR's code cannot be cleaned
up.<br />
It is only meant to explain why ReaR's code is not clean by default.<br />
It is a lot of laborious work to make code clean.</p>
<p>Here a quotation from a colleague at SUSE<br />
where I do 100% agree:</p>
<pre><code>If you look at things from an evolutionary point of view
the solution that works good enough while consuming
least amount of resources wins.
It does not have to be perfect, or even good,
just as good or better than alternatives.
And here I think is the biggest strength of Linux, the pragmatism,
we try out things and keep these that work well enough.
In that sense Linux is full of ugly hacks that, in the end,
resemble how biological systems are structured.
Sure it's hell to maintain, it's complex, we are unable to
build an abstract model the system and reason about it,
but in the end it does the job.
Sometimes I wonder if this is unevitable property
of the universe we live in.
Maybe you can't have nice and clean system
that is efficient enough.
</code></pre>
<h4 id="devil0000_commented_at_2021-11-02_1059"><img src="https://avatars.githubusercontent.com/u/3344302?v=4" width="50"><a href="https://github.com/DEvil0000">DEvil0000</a> commented at <a href="https://github.com/rear/rear/pull/2705#issuecomment-957332917">2021-11-02 10:59</a>:<a class="headerlink" href="#devil0000_commented_at_2021-11-02_1059" title="Permanent link">&para;</a></h4>
<p>@jsmeix I was not asking why it is like it is but more pointing out
arear where things can or should improve. Maybe it is a good iead to
track such things in tickets and assign a milestone. Maybe lable them as
"help welcome" or such.</p>
<h4 id="jsmeix_commented_at_2021-11-02_1312"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2705#issuecomment-957540065">2021-11-02 13:12</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-11-02_1312" title="Permanent link">&para;</a></h4>
<p>I tested it as far as I currently use a USB disk:</p>
<p>On my homeoffice laptop<br />
with UEFI in legacy BIOS mode<br />
and a USB disk as /dev/sdb<br />
with this etc/rear/local.conf</p>
<pre><code>FIRMWARE_FILES=( 'no' )
MODULES=( 'loaded_modules' )
PROGRESS_MODE="plain"
PROGRESS_WAIT_SECONDS="3"
SSH_ROOT_PASSWORD="rear"
OUTPUT=USB
USB_DEVICE_FILESYSTEM_PERCENTAGE=10
USB_DEVICE_FILESYSTEM_LABEL='MY-DATA'
USB_BOOT_PART_SIZE=1024
USB_BOOTLOADER="grub"
USB_DEVICE_BOOT_LABEL=MY-BOOT
OUTPUT_URL=usb:///dev/disk/by-label/MY-BOOT
USB_DEVICE_PARTED_LABEL=gpt
BACKUP=NETFS
BACKUP_URL=usb:///dev/disk/by-label/MY-DATA
</code></pre>
<p>I get</p>
<pre><code># usr/sbin/rear -D format /dev/sdb
Relax-and-Recover 2.6 / Git
Running rear format (PID 819 date 2021-11-02 13:06:27)
Command line options: usr/sbin/rear -D format /dev/sdb
Using log file: /root/rear.wingcon-feature_hybrid_boot/var/log/rear/rear-linux-h9wr.log
Using build area: /var/tmp/rear.b3dmAzJw333oeKE
Running 'init' stage ======================
Running workflow format on the normal/original system
Running 'format' stage ======================
USB or disk device /dev/sdb is not formatted with ext2/3/4 or btrfs filesystem
Formatting /dev/sdb will remove all currently existing data on that whole device
UserInput -I USB_DEVICE_CONFIRM_FORMAT needed in /root/rear.wingcon-feature_hybrid_boot/usr/share/rear/format/USB/default/200_check_usb_layout.sh line 62
Type exactly 'Yes' to format /dev/sdb with ext3 filesystem
(default 'No' timeout 300 seconds)
Yes
UserInput: No choices - result is 'Yes'
Repartitioning /dev/sdb
Creating partition table of type gpt on /dev/sdb
The --bios toggle was used with format - making an BIOS bootable device /dev/sdb
Creating BIOS boot partition /dev/sdb1
Setting 'bios_grub' flag on BIOS boot partition /dev/sdb1
The --efi toggle was used with format - making an EFI bootable device /dev/sdb
Creating EFI system partition /dev/sdb2 with size 512 MiB aligned at 8 MiB
Setting 'esp' flag on EFI partition /dev/sdb2
Creating boot partition /dev/sdb3 with size 1024 MiB aligned at 8 MiB
Setting 'legacy_boot' flag on boot partition /dev/sdb3
Creating ReaR data partition /dev/sdb4 up to 10% of /dev/sdb
Creating vfat filesystem on EFI system partition on /dev/sdb2
Creating ext2 filesystem with label 'MY-BOOT' on boot partition /dev/sdb3
Creating ext3 filesystem with label 'MY-DATA' on ReaR data partition /dev/sdb4
Adjusting filesystem parameters on ReaR data partition /dev/sdb4
Exiting rear format (PID 819) and its descendant processes ...
</code></pre>
<p>which results this /dev/sdb</p>
<pre><code># parted -s /dev/sdb unit MiB print
Model: TOSHIBA External USB 3.0 (scsi)
Disk /dev/sdb: 476940MiB
Sector size (logical/physical): 512B/512B
Partition Table: gpt
Disk Flags: 
Number  Start    End       Size      File system  Name     Flags
 1      0.02MiB  8.00MiB   7.98MiB                primary  bios_grub
 2      8.00MiB  520MiB    512MiB    fat32        primary  boot, esp
 3      520MiB   1544MiB   1024MiB   ext2         primary  legacy_boot
 4      1544MiB  47694MiB  46150MiB  ext3         primary

# lsblk -ipo NAME,KNAME,LABEL,UUID,PTUUID,PARTUUID /dev/sdb
NAME        KNAME     LABEL    UUID                                 PTUUID                               PARTUUID
/dev/sdb    /dev/sdb                                                9b0a1287-b816-4a56-958d-8842d9eb9d65 
|-/dev/sdb1 /dev/sdb1                                               9b0a1287-b816-4a56-958d-8842d9eb9d65 06d5168b-3135-4492-8881-9f0ecaa0d56f
|-/dev/sdb2 /dev/sdb2 REAR-EFI 9F73-4885                            9b0a1287-b816-4a56-958d-8842d9eb9d65 cdb9a83a-233f-4cd7-bd88-59f89512ac89
|-/dev/sdb3 /dev/sdb3 MY-BOOT  fb10f97d-d189-439b-910c-669da4d05214 9b0a1287-b816-4a56-958d-8842d9eb9d65 d4edc850-a5e9-4925-8cbf-86677f551eec
`-/dev/sdb4 /dev/sdb4 MY-DATA  8472ff6f-8a30-4d94-b065-66595eb9052f 9b0a1287-b816-4a56-958d-8842d9eb9d65 584151c2-7ada-4ffb-bfa3-38dc4b3e98a4
</code></pre>
<p>For comparison what <code>rear -D format /dev/sdb</code> had resulted before</p>
<pre><code># parted -s /dev/sdb unit MiB print
Model: TOSHIBA External USB 3.0 (scsi)
Disk /dev/sdb: 476940MiB
Sector size (logical/physical): 512B/512B
Partition Table: gpt
Disk Flags: 
Number  Start    End       Size      File system  Name     Flags
 1      0.02MiB  8.00MiB   7.98MiB                primary  bios_grub
 2      8.00MiB  1032MiB   1024MiB   ext2         primary  legacy_boot
 3      1032MiB  47694MiB  46662MiB  ext3         primary

# lsblk -ipo NAME,KNAME,LABEL,UUID,PTUUID,PARTUUID /dev/sdb
NAME        KNAME     LABEL   UUID                                 PTUUID                               PARTUUID
/dev/sdb    /dev/sdb                                               546e029a-9ee2-4a33-a747-aa14bfface75 
|-/dev/sdb1 /dev/sdb1                                              546e029a-9ee2-4a33-a747-aa14bfface75 2733c621-ac3a-4a98-af0f-d02da15dec36
|-/dev/sdb2 /dev/sdb2 MY-BOOT 16d6cce4-cef4-4d1a-8fe8-e2f6af0f535a 546e029a-9ee2-4a33-a747-aa14bfface75 ff41080b-6262-4cab-b82d-7c9a0a213dce
`-/dev/sdb3 /dev/sdb3 MY-DATA bbc17933-7a79-46bb-9756-d173a7e9d481 546e029a-9ee2-4a33-a747-aa14bfface75 4bdfeea3-1b96-4832-b63f-820b91a3880a
</code></pre>
<p>cf.
<a href="https://github.com/rear/rear/pull/2662#issuecomment-888310850">https://github.com/rear/rear/pull/2662#issuecomment-888310850</a></p>
<p>After <code>rear mkbackup</code> I got that on my /dev/sdb</p>
<pre><code># find /tmp/sdb3
/tmp/sdb3
/tmp/sdb3/rear
/tmp/sdb3/rear/linux-h9wr
/tmp/sdb3/rear/linux-h9wr/20211102.1312
/tmp/sdb3/rear/linux-h9wr/20211102.1312/rear-linux-h9wr.log
/tmp/sdb3/rear/linux-h9wr/20211102.1312/initrd.cgz
/tmp/sdb3/rear/linux-h9wr/20211102.1312/kernel
/tmp/sdb3/lost+found
/tmp/sdb3/boot
/tmp/sdb3/boot/grub2
/tmp/sdb3/boot/grub2/i386-pc
/tmp/sdb3/boot/grub2/i386-pc/biosdisk.mod
/tmp/sdb3/boot/grub2/i386-pc/cmdline_cat_test.mod
...
/tmp/sdb3/boot/grub2/i386-pc/zfsinfo.mod
/tmp/sdb3/boot/grub2/fonts
/tmp/sdb3/boot/grub2/fonts/unicode.pf2
/tmp/sdb3/boot/grub2/grub.cfg
/tmp/sdb3/boot/grub2/grubenv
/tmp/sdb3/linux-h9wr

# find /tmp/sdb4
/tmp/sdb4
/tmp/sdb4/lost+found
/tmp/sdb4/rear
/tmp/sdb4/rear/linux-h9wr
/tmp/sdb4/rear/linux-h9wr/20211102.1312
/tmp/sdb4/rear/linux-h9wr/20211102.1312/backup.log
/tmp/sdb4/rear/linux-h9wr/20211102.1312/backup.tar.gz
</code></pre>
<p>Booting from that USB disk works well for me<br />
on my other older x86_64 laptop with traditional BIOS<br />
both booting the ReaR recovery system and<br />
chainloading its bootloader on its built-in harddisk<br />
to boot its original system.</p>
<h4 id="jsmeix_commented_at_2021-11-02_1315"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2705#issuecomment-957546254">2021-11-02 13:15</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-11-02_1315" title="Permanent link">&para;</a></h4>
<p>@rear/contributors<br />
could you have a look here if you find time for it.</p>
<p>I would like to merge it tomorrow afternoon unless there are objections.</p>
<h4 id="jsmeix_commented_at_2021-11-03_1123"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2705#issuecomment-958939669">2021-11-03 11:23</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-11-03_1123" title="Permanent link">&para;</a></h4>
<p>Tested "rear format" and "rear mkbackup" plus "rear recover"<br />
on the same two VMs as in<br />
<a href="https://github.com/rear/rear/pull/2703#issuecomment-952888484">https://github.com/rear/rear/pull/2703#issuecomment-952888484</a></p>
<pre><code>original system            replacement system
sda 8 GiB system disk      sda the 8 GiB ReaR "USB" disk from the original system
sdb 8 GiB ReaR "USB" disk  sdb 9 GiB replacement system disk
</code></pre>
<p>etc/rear/local.conf</p>
<pre><code>DISKS_TO_BE_WIPED=''
FIRMWARE_FILES=( 'no' )
MODULES=( 'loaded_modules' )
PROGRESS_MODE="plain"
PROGRESS_WAIT_SECONDS="3"
SSH_ROOT_PASSWORD="rear"
OUTPUT=USB
USB_DEVICE_FILESYSTEM_PERCENTAGE=90
USB_DEVICE_FILESYSTEM_LABEL="MY-DATA"
USB_BOOT_PART_SIZE=1024
USB_BOOTLOADER="grub"
USB_DEVICE_BOOT_LABEL="MY-BOOT"
OUTPUT_URL=usb:///dev/disk/by-label/MY-BOOT
USB_DEVICE_PARTED_LABEL=gpt
BACKUP=NETFS
BACKUP_URL=usb:///dev/disk/by-label/MY-DATA
</code></pre>
<p>Excerpts:</p>
<pre><code># usr/sbin/rear -D format /dev/sdb
Relax-and-Recover 2.6 / Git
Running rear format (PID 1355 date 2021-11-03 11:20:57)
Command line options: usr/sbin/rear -D format /dev/sdb
Using log file: /root/rear.wingcon-feature_hybrid_boot/var/log/rear/rear-localhost.log
Using build area: /var/tmp/rear.K0IoksPaoVt9sZD
Running 'init' stage ======================
Running workflow format on the normal/original system
Running 'format' stage ======================
USB or disk device /dev/sdb is not formatted with ext2/3/4 or btrfs filesystem
Formatting /dev/sdb will remove all currently existing data on that whole device
UserInput -I USB_DEVICE_CONFIRM_FORMAT needed in /root/rear.wingcon-feature_hybrid_boot/usr/share/rear/format/USB/default/200_check_usb_layout.sh line 62
Type exactly 'Yes' to format /dev/sdb with ext3 filesystem
(default 'No' timeout 300 seconds)
Yes
UserInput: No choices - result is 'Yes'
Repartitioning /dev/sdb
Creating partition table of type gpt on /dev/sdb
Making a BIOS bootable device /dev/sdb
Creating BIOS boot partition /dev/sdb1
Setting 'bios_grub' flag on BIOS boot partition /dev/sdb1
Making an EFI bootable device /dev/sdb
Creating EFI system partition /dev/sdb2 with size 512 MiB aligned at 8 MiB
Setting 'esp' flag on EFI partition /dev/sdb2
Creating boot partition /dev/sdb3 with size 1024 MiB aligned at 8 MiB
Setting 'legacy_boot' flag on boot partition /dev/sdb3
Creating ReaR data partition /dev/sdb4 up to 90% of /dev/sdb
Creating vfat filesystem on EFI system partition on /dev/sdb2
Creating ext2 filesystem with label 'MY-BOOT' on boot partition /dev/sdb3
Creating ext3 filesystem with label 'MY-DATA' on ReaR data partition /dev/sdb4
Adjusting filesystem parameters on ReaR data partition /dev/sdb4
Exiting rear format (PID 1355) and its descendant processes ...

# parted -s /dev/sdb unit MiB print
Model: ATA QEMU HARDDISK (scsi)
Disk /dev/sdb: 8192MiB
Sector size (logical/physical): 512B/512B
Partition Table: gpt
Disk Flags: 
Number  Start    End      Size     File system  Name     Flags
 1      0.02MiB  8.00MiB  7.98MiB               primary  bios_grub
 2      8.00MiB  520MiB   512MiB   fat32        primary  boot, esp
 3      520MiB   1544MiB  1024MiB  ext2         primary  legacy_boot
 4      1544MiB  7373MiB  5829MiB  ext3         primary

# lsblk -ipo NAME,KNAME,LABEL,SIZE /dev/sdb
NAME        KNAME     LABEL     SIZE
/dev/sdb    /dev/sdb              8G
|-/dev/sdb1 /dev/sdb1             8M
|-/dev/sdb2 /dev/sdb2 REAR-EFI  512M
|-/dev/sdb3 /dev/sdb3 MY-BOOT     1G
`-/dev/sdb4 /dev/sdb4 MY-DATA   5.7G
</code></pre>
<p>"rear mkbackup" on the original system and<br />
then booting the replacement system from that disk<br />
plus "rear recover" worked well for me.</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2025 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2021-10-29.2705.pr.merged.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/rear/rear-user-guide" class="fa fa-code-fork" style="color: #fcfcfc"> rear/rear-user-guide</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
