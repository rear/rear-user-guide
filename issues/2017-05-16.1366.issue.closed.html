<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#1366 Issue closed: Avoid 'sit-and-wait predator' and timeout bash 'select' lists with a default/fallback value - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#1366 Issue closed: Avoid \u0027sit-and-wait predator\u0027 and timeout bash \u0027select\u0027 lists with a default/fallback value";
        var mkdocs_page_input_path = "issues/2017-05-16.1366.issue.closed.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#1366 Issue closed: Avoid 'sit-and-wait predator' and timeout bash 'select' lists with a default/fallback value</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="1366_issue_closed_avoid_sit-and-wait_predator_and_timeout_bash_select_lists_with_a_defaultfallback_value"><a href="https://github.com/rear/rear/issues/1366">#1366 Issue</a> <code>closed</code>: Avoid 'sit-and-wait predator' and timeout bash 'select' lists with a default/fallback value<a class="headerlink" href="#1366_issue_closed_avoid_sit-and-wait_predator_and_timeout_bash_select_lists_with_a_defaultfallback_value" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>enhancement</code>, <code>fixed / solved / done</code></p>
<h4 id="jsmeix_opened_issue_at_2017-05-16_1118"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> opened issue at <a href="https://github.com/rear/rear/issues/1366">2017-05-16 11:18</a>:<a class="headerlink" href="#jsmeix_opened_issue_at_2017-05-16_1118" title="Permanent link">&para;</a></h4>
<p>During ReaR recovery system startup I get from<br />
etc/scripts/system-setup.d/55-migrate-network-devices.sh</p>
<pre>
The original network device eth0 12:34... is not available.
Please select another device:
1) eth0 56:78...
2) Skip replacing the network device
Choose the network device to use:
</pre>

<p>and there it behaves like a 'sit-and-wait predator'<br />
(cf.
<a href="https://en.wikipedia.org/wiki/Ambush_predator">https://en.wikipedia.org/wiki/Ambush_predator</a>
)<br />
and waits endlessly for my input.</p>
<p>For my use-case it is only a minor annoyance but<br />
I think this could become a major hindrance<br />
for any kind of automated "rear recover" run.</p>
<p>Hereby I propose to enhace it with an appropriate timeout<br />
so that it automactially proceeds with a default/fallback value<br />
when there is no user input.</p>
<p>In particular in cases like the above when there is only one<br />
actual choice it could usually safely automactially proceed.<br />
What else except the one actual choice could the user do<br />
in practice - I mean in practice the user wants to proceed.</p>
<p>The implementation problem is that bash 'select'<br />
has no timeout but bash 'read' has one so that<br />
I must probably replace 'select' by 'read -t'.</p>
<h4 id="schlomo_commented_at_2017-05-16_1205"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/issues/1366#issuecomment-301761177">2017-05-16 12:05</a>:<a class="headerlink" href="#schlomo_commented_at_2017-05-16_1205" title="Permanent link">&para;</a></h4>
<p>👍 I was also already annoyed by the two question for disklayout.conf and
diskrestore.sh which I would like to default to "5" (continue) at least
during an automated recovery.</p>
<p>If you rebuild <code>select</code> with <code>read</code> then please kindly do so in a
function. Maybe something that allows easily to convert a
<code>select ... done</code> clause into a <code>case ... esac</code> clause with similar
content.</p>
<h4 id="jsmeix_commented_at_2017-05-16_1218"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1366#issuecomment-301764081">2017-05-16 12:18</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-05-16_1218" title="Permanent link">&para;</a></h4>
<p>@schlomo<br />
in this case even I agree to provide such general useful<br />
functionality in a global function.</p>
<p>Furthermore with 'read' one can - as needed - avoid<br />
the additional [Enter] key, just typing a single character<br />
and off it goes like</p>
<pre>
REPLY=x ; read -t 3 -n 1 -p 'type a char (timeout 3 sec) ' ; echo ; echo using $REPLY
</pre>

<h4 id="schlomo_commented_at_2017-05-16_1220"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/issues/1366#issuecomment-301764677">2017-05-16 12:20</a>:<a class="headerlink" href="#schlomo_commented_at_2017-05-16_1220" title="Permanent link">&para;</a></h4>
<p>The disadvantage of single character input is that the user has no
chance to fix an error, e.g. you meant 1 but hit 2 and off it goes. With
the Enter key the user can think if he really wanted to give that input.</p>
<p>Hence I would prefer to wait for Enter and actually time out with a
sensible default or abort where appropriate.</p>
<h4 id="jsmeix_commented_at_2017-05-16_1231"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1366#issuecomment-301767290">2017-05-16 12:31</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-05-16_1231" title="Permanent link">&para;</a></h4>
<p>I meant the 'read -n 1' behaviour only optionally.<br />
With 'read' we could do that, with 'select' it is impossible.<br />
By default [Enter] is required.</p>
<p>Right now I tried an automated recovery and<br />
at the end I get a 'select' dialog that waits forever</p>
<pre>
'rear recover' finished successfully

1) View Relax-and-Recover log file(s)
2) Go to Relax-and-Recover shell
3) Reboot
Select what to do 
</pre>

<p>I would prefer an automated reboot<br />
(provided "rear recover" results zero exit code)<br />
after some timeout.</p>
<h4 id="gdha_commented_at_2017-05-16_1359"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/issues/1366#issuecomment-301791136">2017-05-16 13:59</a>:<a class="headerlink" href="#gdha_commented_at_2017-05-16_1359" title="Permanent link">&para;</a></h4>
<p>@jsmeix @schlomo Have you ever used the <code>MIGRATION_MODE</code> variable? That
is switched off when I run in <strong>unattended</strong> recovery mode. I also use 2
variables <code>PXE_RECOVER_MODE</code> or <code>ISO_RECOVER_MODE</code> to trigger the
behaviour.</p>
<h4 id="schlomo_commented_at_2017-05-16_1408"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/issues/1366#issuecomment-301793824">2017-05-16 14:08</a>:<a class="headerlink" href="#schlomo_commented_at_2017-05-16_1408" title="Permanent link">&para;</a></h4>
<p>The rear-workshop stuff auto-enables <code>MIGRATION_MODE</code> because it
recovers to a different hard disk. So yes.</p>
<h4 id="jsmeix_commented_at_2017-05-17_1245"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1366#issuecomment-302078762">2017-05-17 12:45</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-05-17_1245" title="Permanent link">&para;</a></h4>
<p>@gdha<br />
I cannot find usage of MIGRATION_MODE in anything<br />
except scripts in usr/share/rear/layout</p>
<pre>
$ find usr/sbin/rear usr/share/rear/ | xargs grep -l 'MIGRATION_MODE'

usr/share/rear/layout/prepare/GNU/Linux/100_include_partition_code.sh
usr/share/rear/layout/prepare/GNU/Linux/110_include_lvm_code.sh
usr/share/rear/layout/prepare/default/010_prepare_files.sh
usr/share/rear/layout/prepare/default/250_compare_disks.sh
usr/share/rear/layout/prepare/default/300_map_disks.sh
usr/share/rear/layout/prepare/default/320_apply_mappings.sh
usr/share/rear/layout/prepare/default/400_autoresize_disks.sh
usr/share/rear/layout/prepare/default/500_confirm_layout.sh
usr/share/rear/layout/prepare/default/270_overrule_migration_mode.sh
usr/share/rear/layout/recreate/default/100_ask_confirmation.sh
</pre>

<p>but here we talk in particular also about user input that is<br />
requested during revovery system startup i.e. in the<br />
usr/share/rear/skel/default/etc/scripts/system-setup*<br />
scripts.</p>
<p>I think we should not mix up MIGRATION_MODE functionality<br />
with new functionality how user input requests behave.</p>
<p>I think the latter should be implemented separated e.g.<br />
via a new config variable like USER_INPUT_TIMEOUT<br />
or USER_INPUT_WAIT_SECONDS.</p>
<h4 id="jsmeix_commented_at_2017-05-17_1449"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1366#issuecomment-302115012">2017-05-17 14:49</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-05-17_1449" title="Permanent link">&para;</a></h4>
<p>Currently I am playing around with a function<br />
that replaces 'select' by 'read'.<br />
In principle I got something working but the<br />
signature (i.e. its arguments and its output)<br />
of my current function is ugly.</p>
<p>My basic problem is that I would have liked to<br />
have an array of choices as first function argument<br />
and after that have optional other arguments to specify<br />
things like timeout (if not the default timeout should be used)<br />
like</p>
<pre>
choices=( 'foo and bar' 'this and that' 'something else' )
timeout=30
choice="$( selectread "${choices[@]}" $timeout )"
case "$choice" in
    ...
esac
</pre>

<p>Because one cannot pass an array as one function argument<br />
cf.
<a href="http://stackoverflow.com/questions/16461656/bash-how-to-pass-array-as-an-argument-to-a-function">http://stackoverflow.com/questions/16461656/bash-how-to-pass-array-as-an-argument-to-a-function</a><br />
the choices must be the last function arguments<br />
an all possibly optional arguments must be first<br />
always specified as positional parameters like</p>
<pre>
choices=( 'foo and bar' 'this and that' 'something else' )
prompt="select something"
default="${choices[2]}"
timeout=30
choice="$( selectread "$prompt" "$default" $timeout "${choices[@]}" )"
case "$choice" in
    ...
esac
</pre>

<h4 id="schlomo_commented_at_2017-05-17_1502"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/issues/1366#issuecomment-302118954">2017-05-17 15:02</a>:<a class="headerlink" href="#schlomo_commented_at_2017-05-17_1502" title="Permanent link">&para;</a></h4>
<p>Why not simply use <code>getopts</code> and named arguments? Something like this</p>
<pre><code>selectread -t 60 -p "Please choose one" "${choices[@]}"
</code></pre>
<p>IMHO a much cleaner interface and you can have default values for
arguments not specified.</p>
<h4 id="jsmeix_commented_at_2017-05-18_0740"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1366#issuecomment-302326379">2017-05-18 07:40</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-05-18_0740" title="Permanent link">&para;</a></h4>
<p>@schlomo<br />
many thanks - that helps!<br />
Sometimes I do not see the forest for the trees.</p>
<h4 id="jsmeix_commented_at_2017-05-19_1207"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1366#issuecomment-302685618">2017-05-19 12:07</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-05-19_1207" title="Permanent link">&para;</a></h4>
<p>I have something that seems to work not too bad for me<br />
but I did not yet test it very much.</p>
<p>Currently it is a stand-alone file choose.sh<br />
that uses no ReaR functions therefore for now<br />
there are things like plain "echo ... 1&gt;&amp;2"<br />
that will be later replaced by appropriate<br />
ReaR functions (e.g. Log).</p>
<p>During development I use "set -e -u -o pipefail"<br />
which shows very nicely "too optimistic code"<br />
(at least for me).</p>
<p>I use non-zero return codes according to<br />
<a href="https://github.com/rear/rear/issues/1134">https://github.com/rear/rear/issues/1134</a></p>
<p>Simple example how it could be used:</p>
<pre>
# ( source choose.sh ; choices=( 'foo and bar' 'this and that' 'something else' ) ; choose "${choices[@]}" )

1) foo and bar
2) this and that
3) something else
Your input (default 1 timeout 60) 2
User chose 'this and that'
this and that
</pre>

<p>More complicated example:</p>
<pre>
# ( source choose.sh ; choices=( 'foo and bar' 'this and that' 'something else' ) ; choose -a myarr -d q "${choices[@]}" || true ; for e in "${myarr[@]}" ; do echo "'$e'" ; done )

1) foo and bar
2) this and that
3) something else
Your input (default 1 timeout 60) 3 foo bar bazq
User chose 'something else'
something else
'3'
'foo'
'bar'
'baz'
</pre>

<p>Finally the whole script choose.sh</p>
<pre>
#!/bin/bash

USER_INPUT_TIMEOUT=60
USER_INPUT_PROMPT="Your input"
USER_INPUT_MAX_CHARS=1000

function choose () {
    set -e -u -o pipefail
    # Set defaults or fallback values:
    local timeout=60
    # Avoid stderr if USER_INPUT_TIMEOUT is not set or empty and ignore wrong USER_INPUT_TIMEOUT:
    test "$USER_INPUT_TIMEOUT" -ge 0 2>/dev/null && timeout=$USER_INPUT_TIMEOUT
    local prompt="enter a choice number"
    # Avoid stderr if USER_INPUT_PROMPT is not set or empty:
    test "$USER_INPUT_PROMPT" 2>/dev/null && prompt="$USER_INPUT_PROMPT"
    local output_array=""
    local input_max_chars=1000
    # Avoid stderr if USER_INPUT_MAX_CHARS is not set or empty and ignore wrong USER_INPUT_MAX_CHARS:
    test "$USER_INPUT_MAX_CHARS" -ge 0 2>/dev/null && input_max_chars=$USER_INPUT_MAX_CHARS
    local input_delimiter=""
    local default_choice_index=0
    # Get the options and their arguments:
    local option=""
    while getopts ":t:p:a:n:d:D:" option ; do
        case $option in
            (t)
                test "$OPTARG" -ge 0 && timeout=$OPTARG || echo "Invalid -$option argument '$OPTARG' using fallback '$timeout'" 1>&2
                ;;
            (p)
                prompt="$OPTARG"
                ;;
            (a)
                output_array="$OPTARG" 
                ;;
            (n)
                test "$OPTARG" -ge 0 && input_max_chars=$OPTARG || echo "Invalid -$option argument '$OPTARG' using fallback '$input_max_chars'" 1>&2
                ;;
            (d)
                input_delimiter="$OPTARG"
                ;;
            (D)
                test "$OPTARG" -ge 0 && default_choice_index=$OPTARG || echo "Invalid -$option argument '$OPTARG' using fallback '$default_choice_index'" 1>&2
                ;;
            (\?)
                echo "Invalid option: -$OPTARG" 1>&2
                ;;
            (:)
                echo "Option -$OPTARG requires an argument." 1>&2
                ;;
        esac
    done
    # Shift away the options and arguments:
    shift "$(( OPTIND - 1 ))"
    # Everything that is now left in "$@" is neither an option nor an option argument
    # so that now "$@" contains the trailing mass-arguments (POSIX calls them operands):
    local choices=( "$@" )
    test "$choices" || echo "No choices" 1>&2
    test "${choices[$default_choice_index]}" || echo "No default choice" 1>&2
    # When an empty prompt was specified (via -p '') do not change that:
    test "$prompt" && prompt="$prompt (default $(( default_choice_index + 1 )) timeout $timeout) "
    # The actual work:
    # Show the choices with leading choice numbers 1) 2) 3) ... as in 'select' (i.e. starting at 1):
    local choice_number=1
    for choice in "${choices[@]}" ; do
        echo "$choice_number) $choice" 1>&2
        (( choice_number += 1 ))
    done
    # Prepare the 'read' call:
    local read_options_and_arguments=""
    # When a zero timeout was specified (via -t 0) do not use it:
    test "$timeout" -ge 1 && read_options_and_arguments="$read_options_and_arguments -t $timeout"
    # When no output_array was specified (via -a myarr) do not use it:
    test "$output_array" && read_options_and_arguments="$read_options_and_arguments -a $output_array"
    # When zero input_max_chars was specified (via -n 0) do not use it:
    test "$input_max_chars" -ge 1 && read_options_and_arguments="$read_options_and_arguments -n $input_max_chars"
    # When no input_delimiter was specified (via -d x) do not use it:
    test "$input_delimiter" && read_options_and_arguments="$read_options_and_arguments -d $input_delimiter"
    # Let the default user input match the default choice:
    local user_input=$(( default_choice_index + 1 ))
    # Read the user input:
    if ! read $read_options_and_arguments -p "$prompt" user_input ; then
        # Continue in any case because in case of errors the default choice is used:
        echo -e "\n'read' finished with non-zero exit code" 1>&2
        # In particular continue after a timeout that lets 'read' exit with non-zero exit code:
        test "$timeout" -ge 1 && echo "probably 'read' timed out" 1>&2
    fi
    # When an output_array was specified it contains all user input words but we use only the first word:
    test "$output_array" && user_input="${!output_array}"
    # Use default choice for wrong user input:
    if ! test "$user_input" -ge 1 ; then
        echo "Wrong user input '$user_input' using fallback '${choices[$default_choice_index]}'" 1>&2
        echo "${choices[$default_choice_index]}"
        return 101
    fi
    local choice_index=$(( user_input - 1 ))
    # Use default choice when there is no choice for the user input
    # and avoid "bash: choices[$choice_index]: unbound variable":
    if ! test "${choices[$choice_index]:-}" ; then
        echo "No choice for '$user_input' using fallback '${choices[$default_choice_index]}'" 1>&2
        echo "${choices[$default_choice_index]}"
        return 102
    fi
    # Success:
    echo "User chose '${choices[$choice_index]}'" 1>&2
    echo "${choices[$choice_index]}"
    return 0
}
</pre>

<h4 id="jsmeix_commented_at_2017-05-19_1232"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1366#issuecomment-302690504">2017-05-19 12:32</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-05-19_1232" title="Permanent link">&para;</a></h4>
<p>I already found some more issues (one needs to reset OPTIND), cf<br />
<a href="http://mywiki.wooledge.org/BashFAQ/035#Complex_nonstandard_add-on_utilities">http://mywiki.wooledge.org/BashFAQ/035#Complex_nonstandard_add-on_utilities</a><br />
but now even automated retries until the user has explicitly<br />
entered a valid choice work for me:</p>
<pre>
# ( source choose.sh ; choices=( 'foo and bar' 'this and that' 'something else' ) ; until choose -t 10 -D 99 "${choices[@]}" ; do echo "try again" ; done )

No default choice
1) foo and bar
2) this and that
3) something else
Your input (default 100 timeout 10) 
'read' finished with non-zero exit code
probably 'read' timed out
No choice for '100' using fallback ''

try again
No default choice
1) foo and bar
2) this and that
3) something else
Your input (default 100 timeout 10) fubar
-bash: test: fubar: integer expression expected
Wrong user input 'fubar' using fallback ''

try again
No default choice
1) foo and bar
2) this and that
3) something else
Your input (default 100 timeout 10) 7
No choice for '7' using fallback ''

try again
No default choice
1) foo and bar
2) this and that
3) something else
Your input (default 100 timeout 10) 2
User chose 'this and that'
this and that
</pre>

<p>I think after some more fine-tuning it should be o.k.<br />
to be provided as a global function in ReaR.</p>
<p>Then I can step by step replace existing 'read' and<br />
'select' calls in ReaR by that new general function.</p>
<p>But that will happen after the ReaR 2.1 release.</p>
<h4 id="jsmeix_commented_at_2017-06-22_0757"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1366#issuecomment-310305449">2017-06-22 07:57</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-06-22_0757" title="Permanent link">&para;</a></h4>
<p>This one is a precondition for<br />
<a href="https://github.com/rear/rear/issues/885">https://github.com/rear/rear/issues/885</a><br />
cf.<br />
<a href="https://github.com/rear/rear/issues/885#issuecomment-310305249">https://github.com/rear/rear/issues/885#issuecomment-310305249</a><br />
and the comments before.</p>
<h4 id="jsmeix_commented_at_2017-06-22_1426"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1366#issuecomment-310396435">2017-06-22 14:26</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-06-22_1426" title="Permanent link">&para;</a></h4>
<p>Via
<a href="https://github.com/rear/rear/pull/1391">https://github.com/rear/rear/pull/1391</a><br />
I added new generic UserInput and UserOutput<br />
plus LogUserOutput functions that are intended<br />
to replace current user input functionality that<br />
calls select or read directly.</p>
<h4 id="jsmeix_commented_at_2017-06-30_1129"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1366#issuecomment-312243960">2017-06-30 11:29</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-06-30_1129" title="Permanent link">&para;</a></h4>
<p>With
<a href="https://github.com/rear/rear/pull/1396">https://github.com/rear/rear/pull/1396</a>
merged<br />
a first step is done to get this issue fixed.</p>
<h4 id="jsmeix_commented_at_2017-07-14_0948"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1366#issuecomment-315319382">2017-07-14 09:48</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-07-14_0948" title="Permanent link">&para;</a></h4>
<p>With
<a href="https://github.com/rear/rear/pull/1408">https://github.com/rear/rear/pull/1408</a>
merged<br />
the UserInput function should be feature-complete<br />
now (at least from my current point of view).</p>
<p>Then for ReaR v 2.3 I could replace the existing 'read'<br />
and 'select' calls that get user input by the UserInput function.</p>
<p>This should make ReaR prepared for running unattended<br />
via predefined automated user input values as<br />
USER_INPUT_VALUES[user_input_ID] array members.</p>
<p>Of course this does not help when interactive tools<br />
are called in ReaR like special (external / third-party)<br />
backup and restore software that cannot run unattended.</p>
<h4 id="jsmeix_commented_at_2017-11-28_1103"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1366#issuecomment-347489144">2017-11-28 11:03</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-11-28_1103" title="Permanent link">&para;</a></h4>
<p>Sufficiently done for ReaR 2.3.</p>
<p>Remaining things can be fixed for ReaR 2.4 or later<br />
as time permits and as users ask for it.</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2023 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2017-05-16.1366.issue.closed.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
