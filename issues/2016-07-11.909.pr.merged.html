<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#909 PR merged: always load modules in /etc/modules (issue905 and others) - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#909 PR merged: always load modules in /etc/modules (issue905 and others)";
        var mkdocs_page_input_path = "issues/2016-07-11.909.pr.merged.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/backup_netfs.html">Example of BACKUP=NETFS</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#909 PR merged: always load modules in /etc/modules (issue905 and others)</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="909_pr_merged_always_load_modules_in_etcmodules_issue905_and_others"><a href="https://github.com/rear/rear/pull/909">#909 PR</a> <code>merged</code>: always load modules in /etc/modules (issue905 and others)<a class="headerlink" href="#909_pr_merged_always_load_modules_in_etcmodules_issue905_and_others" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>bug</code>, <code>fixed / solved / done</code></p>
<h4 id="jsmeix_opened_issue_at_2016-07-11_1238"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> opened issue at <a href="https://github.com/rear/rear/pull/909">2016-07-11 12:38</a>:<a class="headerlink" href="#jsmeix_opened_issue_at_2016-07-11_1238" title="Permanent link">&para;</a></h4>
<p>Tries to fix
<a href="https://github.com/rear/rear/commit/0ec871676b7cdc52461574200c8a54867d0cfb37">https://github.com/rear/rear/commit/0ec871676b7cdc52461574200c8a54867d0cfb37</a><br />
by changing 40-start-udev-or-load-modules.sh<br />
so taht the code that always loads modules<br />
in /etc/modules is always run.</p>
<h4 id="jsmeix_commented_at_2016-07-11_1252"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/909#issuecomment-231725328">2016-07-11 12:52</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-07-11_1252" title="Permanent link">&para;</a></h4>
<p>Now it works well for me.</p>
<p>In particulat I verified with the additional "debug" kernel<br />
command line parameter for the rear recovery system that<br />
now 40-start-udev-or-load-modules.sh runs the code<br />
that loads all modules in /etc/moidules.</p>
<p>I just merge it because I think it is now at least<br />
somewhat better than before (even if it is perhaps<br />
not yet fully perfect).</p>
<h4 id="jsmeix_commented_at_2016-07-12_1501"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/909#issuecomment-232075645">2016-07-12 15:01</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-07-12_1501" title="Permanent link">&para;</a></h4>
<p>There is a small thing left where I don't know<br />
how it is actually meant to work:</p>
<p>At the end of 40-start-udev-or-load-modules.sh<br />
I left the "modprobe -q dm-mod" call as is<br />
which means this modprobe call is now also always<br />
done because it does no longer simply "return" in<br />
the "systemd-udevd case" but now it runs through<br />
to the end of the whole script:</p>
<pre>
RESCUE f121:~ # lsmod | grep dm
dm_mod                110780  0 
</pre>

<p>I only assume this modprobe call was also meant<br />
to be always done but I don't know.</p>
<h4 id="jsmeix_commented_at_2016-07-13_1008"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/909#issuecomment-232313554">2016-07-13 10:08</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-07-13_1008" title="Permanent link">&para;</a></h4>
<p>git forensic via</p>
<pre>
git log -p usr/share/rear/skel/default/etc/scripts/system-setup.d/40-start-udev-or-load-modules.sh
</pre>

<p>shows that the unconditioned "modprobe -q dm-mod" call is there<br />
at the very end since 40-start-udev-or-load-modules.sh<br />
was created (i.e. before the "systemd-udevd case" was<br />
added on top of it) which indicates that the "modprobe -q dm-mod"<br />
call is really meant to be done in any case (I assume when<br />
the "systemd-udevd case" was added on top of it it was<br />
forgotten to deal with the "modprobe -q dm-mod" call).</p>
<p>FYI:</p>
<pre>
git blame -w usr/share/rear/skel/default/etc/scripts/system-setup.d/40-start-udev-or-load-modules.sh
</pre>

<p>shows it was this git commit: 844d50b75ac4b7722f4fee7a5ee3350b93f3adb7</p>
<h4 id="jsmeix_commented_at_2017-06-20_0912"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/909#issuecomment-309693663">2017-06-20 09:12</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-06-20_0912" title="Permanent link">&para;</a></h4>
<p>@schlomo<br />
many thanks for your question!</p>
<p>I think now I understand the reason for my confusion in<br />
<a href="https://github.com/rear/rear/issues/626#issuecomment-125125263">https://github.com/rear/rear/issues/626#issuecomment-125125263</a><br />
(excerpt)</p>
<pre>
In gereral I noticed at that time that in the rear recovery system
I had more than 100 kernel modules loaded while in my original
system I had something about 40 kernel modules loaded.
From my point of view this indicates that there is something
wrong in general in the rear recovery system that it has much
more kernel modules loaded than in the original system...
</pre>

<p>I don't know a mandatory reason why the explicitly specified modules<br />
must be loaded after the udev automatism.<br />
My change was only meant to get the explicitly specified modules<br />
loaded at all.<br />
I did not intend to change the odering of what happens when in<br />
skel/default/etc/scripts/system-setup.d/40-start-udev-or-load-modules.sh<br />
so that I simply added loading modules from /etc/modules<br />
below the already existing udev loading code.</p>
<p>But I could imagine a reason why the explicitly specified modules<br />
may sometimes have to be loaded after the udev automatism:</p>
<p>If the explicitly specified modules were loaded before the<br />
automated udev loading, the explicitly specified modules list<br />
(i.e. the MODULES_LOAD array) may have to be<br />
"somewhat complete" which means it may need to specify<br />
all needed modules from the very beginning in the right ordering.</p>
<p>In contrast when the udev automatism runs first<br />
the basic stuff should be automatically loaded so that<br />
the MODULES_LOAD array could contain only<br />
additionally needed modules.</p>
<p>I think in theory the module dependencies should<br />
always automatically load all needed modules from the<br />
very beginning in the right ordering<br />
but perhaps in practice some module dependencies<br />
are implemented only via udev rules nowadays?</p>
<p>Currently usr/share/rear/conf/default.conf<br />
is very terse about how MODULES_LOAD is meant:</p>
<pre>
# Enforce to load these modules in the given order in the rescue/recovery system:
MODULES_LOAD=()
</pre>

<p>Currently it only means that MODULES_LOAD=( foo bar )<br />
will load first 'foo' and then 'bar' but it does not tell<br />
if that also means that 'foo' will be the very first module<br />
that gets loaded in the rescue/recovery system.</p>
<p>I think to make MODULES_LOAD really powerful<br />
its meaning should be that the modules that are<br />
specified therein will be the very first modules<br />
that get loaded in the rescue/recovery system.</p>
<p>Furthermore I would like to have a switch so that the<br />
user can - if needed - skip the automated udev module<br />
loading for example via a special module name like</p>
<pre>
MODULES_LOAD=( 'foo' 'bar' 'skip_automated_udev_module_loading' )
</pre>

<p>but this makes implementation a bit awkward because I<br />
would have to check everywhere for that special value.<br />
Perhaps I prefer a separated config variable to<br />
skip the automated udev module loading.</p>
<p>Because I think I know now the root cause why the loaded<br />
modules in the recovery system do not match the ones<br />
in the original system, I will fix it and clean it up and<br />
enhance it so that - if needed - the user has the final<br />
power to specify exactly what modules will be loaded<br />
in what ordering in the recovery system.</p>
<h4 id="schlomo_commented_at_2017-06-20_0934"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/909#issuecomment-309699378">2017-06-20 09:34</a>:<a class="headerlink" href="#schlomo_commented_at_2017-06-20_0934" title="Permanent link">&para;</a></h4>
<p>@jsmeix please wait with your effort till I am done with my changes in
<a href="https://github.com/rear/rear/tree/schlomo-2017-06">https://github.com/rear/rear/tree/schlomo-2017-06</a>
(and feel free to look there and comment). Maybe you don't need to do
anything at all.</p>
<p>I already took out one sort which should fix the ordering.</p>
<p>In my experience modules auto-load their dependencies without problems.
In this example I had <code>mptspi</code> in the <code>MODULES_LOAD</code> array and it
auto-loaded all the other SCSI and MPT modules.</p>
<p>I would really prefer to keep things simple here. That means that we use
<code>MODULES_LOAD</code> to really mean <strong>load these modules before anything else
in this order</strong> which is my current implementation. This also most
closely reflects what the distros do with the modules inside their
initrd. They are also loaded before the main system comes up and loads
udev or systemd-udev. Therefore I don't see any need to make
<code>MODULES_LOAD</code> contain some magic before and after. And I for sure
wouldn't build that without a specific use case where our current code
does not work.</p>
<p>I am actually much more worried about us supporting
<a href="https://www.freedesktop.org/software/systemd/man/systemd-modules-load.service.html">systemd-modules-load.service</a>
properly. Do we start that? Does systemd start it when we copy it into
the rescue system? Unfortunately a quick look did not enlighten me on
these questions, our boot process is already too complex.</p>
<p>FYI, on my Ubuntu 17.04 <code>/etc/modules</code> is also loaded by
<code>systemd-modules-load</code> via a symlink:</p>
<pre><code>$ ll /etc/modules-load.d/
total 8
drwxr-xr-x 1 root root   58 Jun 15 17:48 ./
drwxr-xr-x 1 root root 4558 Jun 20 10:25 ../
-rw-r--r-- 1 root root  119 Mär 21 19:36 cups-filters.conf
lrwxrwxrwx 1 root root   10 Apr 13 19:10 modules.conf -&gt; ../modules
</code></pre>
<h4 id="jsmeix_commented_at_2017-06-20_0949"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/909#issuecomment-309703093">2017-06-20 09:49</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-06-20_0949" title="Permanent link">&para;</a></h4>
<p>I am afraid I know basically nothing at all about<br />
systemd related things in the recovery system.</p>
<p>I fully agree to load the MODULES_LOAD modules<br />
before anything else in this order.</p>
<p>I watch your changes in<br />
<a href="https://github.com/rear/rear/compare/schlomo-2017-06">https://github.com/rear/rear/compare/schlomo-2017-06</a><br />
and I am in particular happy how loading the specified<br />
modules first in any case makes the code simpler<br />
(no longer duplicated code) and better!</p>
<h4 id="jsmeix_commented_at_2017-06-20_0958"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/909#issuecomment-309705461">2017-06-20 09:58</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-06-20_0958" title="Permanent link">&para;</a></h4>
<p>@schlomo<br />
I think in your<br />
usr/share/rear/build/GNU/Linux/400_copy_modules.sh</p>
<pre>
if ! grep -q $module_to_be_loaded $recovery_system_etc_modules ; then
</pre>

<p>should be more specific to avoid that substrings match,<br />
e.g. think about module names like 'parport' and 'parport_pc'.<br />
When 'parport_pc' is already in $recovery_system_etc_modules<br />
no 'parport' would be added because the substring 'parport'<br />
matches 'parport_pc'.</p>
<h4 id="schlomo_commented_at_2017-06-20_1005"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/909#issuecomment-309707142">2017-06-20 10:05</a>:<a class="headerlink" href="#schlomo_commented_at_2017-06-20_1005" title="Permanent link">&para;</a></h4>
<p>excellent catch - thanks a lot! (please ignore the last commit there, it
was wrong and I pulled it back).</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2024 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2016-07-11.909.pr.merged.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/rear/rear-user-guide" class="fa fa-code-fork" style="color: #fcfcfc"> rear/rear-user-guide</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
