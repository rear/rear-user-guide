<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#2750 PR merged: multipath: fix exclusion of still wanted devices - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#2750 PR merged: multipath: fix exclusion of still wanted devices";
        var mkdocs_page_input_path = "issues/2022-02-01.2750.pr.merged.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#2750 PR merged: multipath: fix exclusion of still wanted devices</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="2750_pr_merged_multipath_fix_exclusion_of_still_wanted_devices"><a href="https://github.com/rear/rear/pull/2750">#2750 PR</a> <code>merged</code>: multipath: fix exclusion of still wanted devices<a class="headerlink" href="#2750_pr_merged_multipath_fix_exclusion_of_still_wanted_devices" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>bug</code>, <code>fixed / solved / done</code></p>
<h4 id="rmetrich_opened_issue_at_2022-02-01_1421"><img src="https://avatars.githubusercontent.com/u/1163635?u=36b5e32e1dd55f1ce77cad431a5683fce40a7934&v=4" width="50"><a href="https://github.com/rmetrich">rmetrich</a> opened issue at <a href="https://github.com/rear/rear/pull/2750">2022-02-01 14:21</a>:<a class="headerlink" href="#rmetrich_opened_issue_at_2022-02-01_1421" title="Permanent link">&para;</a></h4>
<h4 id="relax-and-recover_rear_pull_request_template">Relax-and-Recover (ReaR) Pull Request Template<a class="headerlink" href="#relax-and-recover_rear_pull_request_template" title="Permanent link">&para;</a></h4>
<p>Please fill in the following items before submitting a new pull request:</p>
<h5 id="pull_request_details">Pull Request Details:<a class="headerlink" href="#pull_request_details" title="Permanent link">&para;</a></h5>
<ul>
<li>
<p>Type: <strong>Bug Fix</strong></p>
</li>
<li>
<p>Impact: <strong>High</strong></p>
</li>
<li>
<p>How was this pull request tested? On RHEL8 with Upstream ReaR</p>
</li>
<li>
<p>Brief description of the changes in this pull request:</p>
</li>
</ul>
<p>The current code excluding multipath devices is broken when a device
being excluded matches other devices.<br />
This leads to excluding wanted devices.<br />
This happens when having custom alias for multipath devices <em>or</em> there
are more than 26 multipath devices and 'mpatha' is getting excluded,
which leads to excluding all 'mpathaX' devices are well.</p>
<p>See example below:</p>
<ul>
<li>have /boot on a dedicated multipath device 'mpathba'</li>
<li>have / on a dedicated multipath device 'mpatha' and LVM vg 'rhel'</li>
<li>have a dedicated multipath device 'mpathb' and LVM vg 'data'</li>
<li>tell ReaR to only include 'rhel' VG (and not 'data' VG)</li>
<li>tell ReaR to not auto-exclude multipath devices (otherwise
    everything<br />
    gets commented out)</li>
</ul>
<!-- -->

<pre><code>$ lsblk
NAME            MAJ:MIN RM  SIZE RO TYPE  MOUNTPOINT
sda               8:0    0    5G  0 disk
└─mpathba       253:1    0    5G  0 mpath
  └─mpathba1    253:2    0    1G  0 part  /boot
sdb               8:16   0    5G  0 disk
└─mpathba       253:1    0    5G  0 mpath
  └─mpathba1    253:2    0    1G  0 part  /boot
sdc               8:32   0   20G  0 disk
└─mpatha        253:0    0   20G  0 mpath
  ├─mpatha1     253:3    0    1G  0 part
  └─mpatha2     253:4    0   19G  0 part
    ├─rhel-root 253:5    0   10G  0 lvm   /
    └─rhel-swap 253:6    0    2G  0 lvm   [SWAP]
sdd               8:48   0   20G  0 disk
└─mpatha        253:0    0   20G  0 mpath
  ├─mpatha1     253:3    0    1G  0 part
  └─mpatha2     253:4    0   19G  0 part
    ├─rhel-root 253:5    0   10G  0 lvm   /
    └─rhel-swap 253:6    0    2G  0 lvm   [SWAP]
sde               8:64   0    2G  0 disk
└─mpathb        253:7    0    2G  0 mpath
sdf               8:80   0    2G  0 disk
└─mpathb        253:7    0    2G  0 mpath
sr0              11:0    1 1024M  0 rom

$ vgs
  VG   #PV #LV #SN Attr   VSize   VFree
  data   1   0   0 wz--n-  &lt;2.00g &lt;2.00g
  rhel   1   2   0 wz--n- &lt;19.00g &lt;7.00g

$ cat /etc/rear/local.conf
ONLY_INCLUDE_VG=("rhel")
AUTOEXCLUDE_MULTIPATH=n
</code></pre>
<p>With original code:</p>
<pre><code>$ rear mkrescue
$ grep -v ^# /var/lib/rear/layout/disklayout.conf | grep "mpathba"
--&gt; device excluded even though it hosts /boot
</code></pre>
<p>With the fix:</p>
<pre><code>$ rear mkrescue
$ grep -v ^# /var/lib/rear/layout/disklayout.conf | grep "mpathba"
fs /dev/mapper/mpathba1 /boot xfs ...
multipath /dev/mapper/mpathba 5368709120 msdos /dev/sda,/dev/sdb
part /dev/mapper/mpathba 1073741824 1048576 primary none /dev/mapper/mpathba1
</code></pre>
<p>The root cause behind this is ReaR excludes 'mpathb' (hosting the
'data'<br />
VG) through using a non-word matching <em>grep</em> command, which causes<br />
'mpathba' (hosting /boot) to be excluded as well.</p>
<h4 id="pcahyna_commented_at_2022-02-01_1530"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/2750#issuecomment-1026973045">2022-02-01 15:30</a>:<a class="headerlink" href="#pcahyna_commented_at_2022-02-01_1530" title="Permanent link">&para;</a></h4>
<p>looks good, <code>grep -w</code> is already being used at other places, so it
should be safe. I am actually wondering how many other places do not use
<code>-w</code> when they should, given that grep is fairly widespread in layout
code.</p>
<h4 id="jsmeix_commented_at_2022-02-02_0722"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2750#issuecomment-1027653394">2022-02-02 07:22</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-02-02_0722" title="Permanent link">&para;</a></h4>
<p>@pcahyna<br />
personally I do not use <code>grep -w</code> when I grep in disklayout.conf<br />
because the word separator characters in <code>grep -w</code> are different<br />
than the word separator characters in bash (i.e. $IFS)<br />
according to how I understand "man grep"</p>
<pre><code>-w, --word-regexp
  Select only those lines containing matches that form whole words.
  The test is that the matching substring must
  either be at the beginning of the line,
  or preceded by a non-word constituent character.
  Similarly, it must be either at the end of the line
  or followed  by a non-word constituent character.
  Word-constituent characters are letters, digits, and the underscore.
</code></pre>
<p>therein in particular the last line so word separator characters in
<code>grep -w</code><br />
are all characters except letters, digits, and the underscore.</p>
<p>To grep for a keyword of an active line in disklayout.conf I use</p>
<pre><code>grep '^keyword '
</code></pre>
<p>with a trailing space character.<br />
To grep for a value in the middle of a line in disklayout.conf I use</p>
<pre><code>grep ' value '
</code></pre>
<p>with a leading and a trailing space character.<br />
Preferably I get one whole line into a bash array<br />
and pick the intended array element like</p>
<pre><code># disk_device="/dev/sda"
# disk_entry=( $( grep "^disk $disk_device " $LAYOUT_FILE ) )
# disk_size=${disk_entry[2]}
</code></pre>
<p>because this works same as</p>
<pre><code># disk_device="/dev/sda"
# read keyword disk_device disk_size disk_label &lt; &lt;( grep "^disk $disk_device " $LAYOUT_FILE )
</code></pre>
<p>which is the usual method when we iterate over several entries in
disklayout.conf</p>
<p>Accordingly there are some more issues in<br />
layout/save/default/335_remove_excluded_multipath_vgs.sh</p>
<pre><code>done &lt; &lt;(grep "^#lvmdev" $LAYOUT_FILE)
...
done &lt; &lt;(grep "^multipath" $LAYOUT_FILE)
</code></pre>
<p>should be</p>
<pre><code>done &lt; &lt;(grep "^#lvmdev " $LAYOUT_FILE)
...
done &lt; &lt;(grep "^multipath " $LAYOUT_FILE)
</code></pre>
<p>i.e. each with a trailing space.</p>
<p>In</p>
<pre><code>    # ... - an entry looks like:
    # #lvmdev /dev/h50l050vg00 /dev/mapper/360060e8007e2e3000030e2e30000449f2 Nn3ew5-Wkve-FpSY-mgng-3T0l-rSz1-EEvPrE 502288384
    # We need to 'cut -c1-45' (third arg) to grab the full multipath device and not only a partition
    # Remember, multipath devices from a volume group that is "excluded" should be 'commented out'
    device=$(echo $mpdev | cut -c1-45)
</code></pre>
<p>there is no check that $mpdev has the form <code>/dev/mapper/...</code><br />
so any <code>&lt;device&gt;</code> of any commented <code>#lvmdev</code> line in disklayout.conf<br />
will be used regardless if that <code>&lt;device&gt;</code> has the expected form
<code>/dev/mapper/...</code><br />
cf. "Physical Volumes" in "Disk layout file syntax" in<br />
<a href="https://github.com/rear/rear/blob/master/doc/user-guide/06-layout-configuration.adoc">https://github.com/rear/rear/blob/master/doc/user-guide/06-layout-configuration.adoc</a></p>
<p>FYI:<br />
layout/save/default/335_remove_excluded_multipath_vgs.sh<br />
was added because of<br />
<a href="https://github.com/rear/rear/issues/1211">https://github.com/rear/rear/issues/1211</a></p>
<h4 id="jsmeix_commented_at_2022-02-02_0729"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2750#issuecomment-1027657340">2022-02-02 07:29</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-02-02_0729" title="Permanent link">&para;</a></h4>
<p>@pcahyna<br />
I dared to assign it to you.<br />
Feel free to merge it when it is OK for you.</p>
<h4 id="jsmeix_commented_at_2022-02-02_0732"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2750#issuecomment-1027658762">2022-02-02 07:32</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-02-02_0732" title="Permanent link">&para;</a></h4>
<p>@rmetrich<br />
thank you for your continuous contributions to ReaR!</p>
<h4 id="pcahyna_commented_at_2022-02-02_0821"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/2750#issuecomment-1027688935">2022-02-02 08:21</a>:<a class="headerlink" href="#pcahyna_commented_at_2022-02-02_0821" title="Permanent link">&para;</a></h4>
<p>@jsmeix</p>
<blockquote>
<p>... are all characters except letters, digits, and the underscore.</p>
</blockquote>
<p>thanks for noticing that, indeed that does not sound good. It is easy to
imagine that someone would use a dash in a device name, for example.</p>
<blockquote>
<p>To grep for a keyword of an active line in disklayout.conf I use</p>
<pre><code>grep '^keyword '
</code></pre>
<p>with a trailing space character.<br />
Accordingly there are some more issues in
layout/save/default/335_remove_excluded_multipath_vgs.sh</p>
<pre><code>done &lt; &lt;(grep "^#lvmdev" $LAYOUT_FILE)
...
done &lt; &lt;(grep "^multipath" $LAYOUT_FILE)
</code></pre>
<p>should be</p>
<pre><code>done &lt; &lt;(grep "^#lvmdev " $LAYOUT_FILE)
...
done &lt; &lt;(grep "^multipath " $LAYOUT_FILE)
</code></pre>
<p>i.e. each with a trailing space.</p>
</blockquote>
<p>I think that keywords are fairly safe, because they come from a
well-known set of possibilities, unlike values, which can be virtually
anything. Unless someone introduces two keywords where one is a
substring of the other, like "lvm" and "lvmdev" or "multipath" and
"multipathcomponent", hmmm.</p>
<h4 id="rmetrich_commented_at_2022-02-02_0838"><img src="https://avatars.githubusercontent.com/u/1163635?u=36b5e32e1dd55f1ce77cad431a5683fce40a7934&v=4" width="50"><a href="https://github.com/rmetrich">rmetrich</a> commented at <a href="https://github.com/rear/rear/pull/2750#issuecomment-1027701403">2022-02-02 08:38</a>:<a class="headerlink" href="#rmetrich_commented_at_2022-02-02_0838" title="Permanent link">&para;</a></h4>
<blockquote>
<p>@jsmeix</p>
<blockquote>
<p>... are all characters except letters, digits, and the underscore.</p>
</blockquote>
<p>thanks for noticing that, indeed that does not sound good. It is easy
to imagine that someone would use a dash in a device name, for
example.</p>
</blockquote>
<p>Right, not good enough then. Let me confirm this doesn't work with
custom aliases even with the fix.</p>
<h4 id="jsmeix_commented_at_2022-02-02_0847"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2750#issuecomment-1027707436">2022-02-02 08:47</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-02-02_0847" title="Permanent link">&para;</a></h4>
<p>I think usually <code>grep -w "$value"</code> is good enough because:</p>
<pre><code>echo "beginfoo foo-bar foo_baz foo1.2 fooend" | grep -w 'foo'
beginfoo foo-bar foo_baz foo1.2 fooend
         ^^^
</code></pre>
<p>finds only the "foo" in "foo-bar"<br />
but usually one does not search for a substring of a value but for a
whole value so</p>
<pre><code># for v in beginfoo foo-bar foo_baz foo1.2 fooend ; do echo "beginfoo foo-bar foo_baz foo1.2 fooend" | grep -w "$v" ; done
beginfoo foo-bar foo_baz foo1.2 fooend
^^^^^^^^
beginfoo foo-bar foo_baz foo1.2 fooend
         ^^^^^^^
beginfoo foo-bar foo_baz foo1.2 fooend
                 ^^^^^^^
beginfoo foo-bar foo_baz foo1.2 fooend
                         ^^^^^^
beginfoo foo-bar foo_baz foo1.2 fooend
                                ^^^^^^
</code></pre>
<p>finds each specific value at its exact place.</p>
<h4 id="jsmeix_commented_at_2022-02-02_0855"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2750#issuecomment-1027714280">2022-02-02 08:55</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-02-02_0855" title="Permanent link">&para;</a></h4>
<p>Regarding grep for keyword without trailing space:</p>
<p>Currently we have <code>disk</code> and <code>opaldisk</code> officially documented in<br />
<a href="https://github.com/rear/rear/blob/master/doc/user-guide/06-layout-configuration.adoc">https://github.com/rear/rear/blob/master/doc/user-guide/06-layout-configuration.adoc</a></p>
<p>But since my<br />
<a href="https://github.com/rear/rear/commit/7a944cf059135a044940408bbdc9c0c77c299322">https://github.com/rear/rear/commit/7a944cf059135a044940408bbdc9c0c77c299322</a><br />
we also have <code>raid</code> and the new <code>raiddisk</code> which is not yet officially
documented<br />
because I am not yet finished with the RAID autoresize code so I like to
be able<br />
to rename the new <code>raiddisk</code> if I need.<br />
So <code>grep ^raid $LAYOUT_FILE</code> would find <code>raid</code> and the new <code>raiddisk</code>.<br />
I checked the RAID code that it is safe.<br />
I cannot rename <code>raid</code> to <code>raidarray</code> because the user could use his<br />
specific $CONFIG_DIR/disklayout.conf see<br />
layout/prepare/default/010_prepare_files.sh<br />
so we must keep things backward compatible in disklayout.conf<br />
On the other hand we did change things in disklayout.conf<br />
so we should document that $CONFIG_DIR/disklayout.conf<br />
must be adapted by the user when he updates/upgraded ReaR<br />
and then I could rename <code>raid</code> to <code>raidarray</code>.</p>
<h4 id="rmetrich_commented_at_2022-02-02_0935"><img src="https://avatars.githubusercontent.com/u/1163635?u=36b5e32e1dd55f1ce77cad431a5683fce40a7934&v=4" width="50"><a href="https://github.com/rmetrich">rmetrich</a> commented at <a href="https://github.com/rear/rear/pull/2750#issuecomment-1027746887">2022-02-02 09:35</a>:<a class="headerlink" href="#rmetrich_commented_at_2022-02-02_0935" title="Permanent link">&para;</a></h4>
<p><code>grep -w</code> isn't safe indeed, tested with <code>/boot</code> on
<code>/dev/mapper/custom-boot</code> device and data VG on <code>/dev/mapper/custom</code>
device: <code>/boot</code> was getting excluded as well.</p>
<h4 id="jsmeix_commented_at_2022-02-02_0944"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2750#issuecomment-1027754418">2022-02-02 09:44</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-02-02_0944" title="Permanent link">&para;</a></h4>
<p>Ah! Yes - it fails when the whole value1 in <code>grep -w value1</code><br />
is a substring of another value2<br />
where value2 contains value1 as a word for <code>grep -w</code></p>
<h4 id="jsmeix_commented_at_2022-02-03_1413"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2750#issuecomment-1029030809">2022-02-03 14:13</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-02-03_1413" title="Permanent link">&para;</a></h4>
<p>To make it officially documented what the de-facto syntax in
disklayout.conf is<br />
I added in doc/user-guide/06-layout-configuration.adoc<br />
in the "Disk layout file syntax" section that in disklayout.conf<br />
keyword and the values are separated by single space characters via<br />
<a href="https://github.com/rear/rear/commit/b1ccb948bdfd83dc904937a74ae4d3d13ecb8963">https://github.com/rear/rear/commit/b1ccb948bdfd83dc904937a74ae4d3d13ecb8963</a></p>
<p>This is needed because we depend on it at many places in the code<br />
that keyword and values are separated by space characters.</p>
<h4 id="pcahyna_commented_at_2022-02-09_2237"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/2750#issuecomment-1034269556">2022-02-09 22:37</a>:<a class="headerlink" href="#pcahyna_commented_at_2022-02-09_2237" title="Permanent link">&para;</a></h4>
<p>I prefer spaces over <code>\s</code>, for three reasons:</p>
<ul>
<li><code>\s</code> is hard to read, as @jsmeix has pointed out</li>
<li>spaces are consistent with the current style (and if we weant to
    change the style and eventually change the current occurrences, the
    code will become even harder to read)</li>
<li><code>\s</code> is unneeded: the format of the file is under our control, we
    make sure that there spaces and not tabs.</li>
</ul>
<h4 id="rmetrich_commented_at_2022-02-10_0815"><img src="https://avatars.githubusercontent.com/u/1163635?u=36b5e32e1dd55f1ce77cad431a5683fce40a7934&v=4" width="50"><a href="https://github.com/rmetrich">rmetrich</a> commented at <a href="https://github.com/rear/rear/pull/2750#issuecomment-1034613938">2022-02-10 08:15</a>:<a class="headerlink" href="#rmetrich_commented_at_2022-02-10_0815" title="Permanent link">&para;</a></h4>
<p>OK fixed, thanks for confirming.<br />
I'd go with stashing the commits, no need for complete history here :-)</p>
<h4 id="pcahyna_commented_at_2022-02-13_2259"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/2750#issuecomment-1038465427">2022-02-13 22:59</a>:<a class="headerlink" href="#pcahyna_commented_at_2022-02-13_2259" title="Permanent link">&para;</a></h4>
<p>ITYM squashing, not stashing, and I agree.</p>
<h4 id="pcahyna_commented_at_2022-02-14_1049"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/2750#issuecomment-1038935604">2022-02-14 10:49</a>:<a class="headerlink" href="#pcahyna_commented_at_2022-02-14_1049" title="Permanent link">&para;</a></h4>
<p>I tested the original change (fails) and the latest change (succeeds)
with / being on <code>mpatha-a</code> and excluded LV being on <code>mpatha</code>.<br />
Reproducer:</p>
<pre><code># lsblk
NAME          MAJ:MIN RM SIZE RO TYPE  MOUNTPOINT
sda             8:0    0  40G  0 disk  
└─mpatha-a    253:0    0  40G  0 mpath 
  ├─mpatha-a1 253:2    0   4M  0 part  
  ├─mpatha-a2 253:3    0   1G  0 part  /boot
  ├─mpatha-a3 253:4    0   4G  0 part  [SWAP]
  ├─mpatha-a4 253:5    0   1K  0 part  
  └─mpatha-a5 253:6    0  35G  0 part  /
sdb             8:16   0   5G  0 disk  
└─mpatha-b    253:1    0   5G  0 mpath 
sdc             8:32   0   5G  0 disk  
└─mpatha-c    253:7    0   5G  0 mpath 
sdd             8:48   0   5G  0 disk  
└─mpatha-d    253:8    0   5G  0 mpath 
sde             8:64   0   5G  0 disk  
└─mpatha-e    253:9    0   5G  0 mpath 
# multipath -f mpatha-c
# sed -i.orig 's/mpatha-c /mpatha /' /etc/multipath/bindings
# systemctl restart multipathd
# lsblk
NAME          MAJ:MIN RM SIZE RO TYPE  MOUNTPOINT
sda             8:0    0  40G  0 disk  
└─mpatha-a    253:0    0  40G  0 mpath 
  ├─mpatha-a1 253:2    0   4M  0 part  
  ├─mpatha-a2 253:3    0   1G  0 part  /boot
  ├─mpatha-a3 253:4    0   4G  0 part  [SWAP]
  ├─mpatha-a4 253:5    0   1K  0 part  
  └─mpatha-a5 253:6    0  35G  0 part  /
sdb             8:16   0   5G  0 disk  
└─mpatha-b    253:1    0   5G  0 mpath 
sdc             8:32   0   5G  0 disk  
└─mpatha      253:7    0   5G  0 mpath 
sdd             8:48   0   5G  0 disk  
└─mpatha-d    253:8    0   5G  0 mpath 
sde             8:64   0   5G  0 disk  
└─mpatha-e    253:9    0   5G  0 mpath 
# yum -y install lvm2
# echo AUTOEXCLUDE_MULTIPATH=n &gt;&gt; /etc/rear/local.conf
# pvcreate /dev/mapper/mpatha
# vgcreate unused /dev/mapper/mpatha
# echo 'EXCLUDE_VG=("unused")' &gt;&gt; /etc/rear/local.conf
# rear savelayout
# grep -v '^#' /var/lib/rear/layout/disklayout.conf
</code></pre>
<p>The system was installed with <code>mpatha-</code> as the original multipath
prefix.<br />
This can be achieved using <code>alias_prefix mpatha-</code> in
<code>/etc/multipath.conf</code> when installing<br />
(use</p>
<pre><code>sed -i.orig -e '/user_friendly_names/a\\
alias_prefix mpatha-' /etc/multipath.conf
systemctl restart multipathd
</code></pre>
<p>in kickstart <code>%pre</code>)</p>
<h4 id="pcahyna_commented_at_2022-02-14_1111"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/2750#issuecomment-1038956502">2022-02-14 11:11</a>:<a class="headerlink" href="#pcahyna_commented_at_2022-02-14_1111" title="Permanent link">&para;</a></h4>
<p>Note that the code still looks fragile. Is it guaranteed that
<code>/dev/mapper/...</code> can appear only in a disklayout field where we expect
it, and not in some other field? And will <code>cut -c1-45</code> always work? But
let's worry about it later.</p>
<h4 id="pcahyna_commented_at_2022-02-14_1207"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/2750#issuecomment-1039009753">2022-02-14 12:07</a>:<a class="headerlink" href="#pcahyna_commented_at_2022-02-14_1207" title="Permanent link">&para;</a></h4>
<p>@rmetrich is the PR ready to be merged? Looks so now.</p>
<h4 id="rmetrich_commented_at_2022-02-14_1227"><img src="https://avatars.githubusercontent.com/u/1163635?u=36b5e32e1dd55f1ce77cad431a5683fce40a7934&v=4" width="50"><a href="https://github.com/rmetrich">rmetrich</a> commented at <a href="https://github.com/rear/rear/pull/2750#issuecomment-1039029342">2022-02-14 12:27</a>:<a class="headerlink" href="#rmetrich_commented_at_2022-02-14_1227" title="Permanent link">&para;</a></h4>
<p>It is, thanks!</p>
<h4 id="jsmeix_commented_at_2022-02-14_1235"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2750#issuecomment-1039036563">2022-02-14 12:35</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-02-14_1235" title="Permanent link">&para;</a></h4>
<p>@rmetrich @pcahyna<br />
thank you for the fix and your verification tests!</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2023 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2022-02-01.2750.pr.merged.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
