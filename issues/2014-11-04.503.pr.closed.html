<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#503 PR closed: add custom script support besides PRE_RECOVERY_SCRIPT and PORT_RECOVERY_... - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#503 PR closed: add custom script support besides PRE_RECOVERY_SCRIPT and PORT_RECOVERY_...";
        var mkdocs_page_input_path = "issues/2014-11-04.503.pr.closed.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a> &raquo;</li>
      <li class="breadcrumb-item active">#503 PR closed: add custom script support besides PRE_RECOVERY_SCRIPT and PORT_RECOVERY_...</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="503_pr_closed_add_custom_script_support_besides_pre_recovery_script_and_port_recovery_"><a href="https://github.com/rear/rear/pull/503">#503 PR</a> <code>closed</code>: add custom script support besides PRE_RECOVERY_SCRIPT and PORT_RECOVERY_...<a class="headerlink" href="#503_pr_closed_add_custom_script_support_besides_pre_recovery_script_and_port_recovery_" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>enhancement</code></p>
<h4 id="tbsky_opened_issue_at_2014-11-04_0642"><img src="https://avatars.githubusercontent.com/u/9283275?v=4" width="50"><a href="https://github.com/tbsky">tbsky</a> opened issue at <a href="https://github.com/rear/rear/pull/503">2014-11-04 06:42</a>:<a class="headerlink" href="#tbsky_opened_issue_at_2014-11-04_0642" title="Permanent link">&para;</a></h4>
<p>hi:<br />
this is a patch for adding custom script support. this feature works
like PRE_RECOVERY_SCRIPT and POST_RECOVERY_SCRIPT , but add that
ability to other stages by hooking every script at all stages.
definition at config file like below:</p>
<p>PRE_BACKUP_97_SCRIPT=(/usr/local/bin/rear-drbd_vm_backup)<br />
POST_RESTORE_98_SCRIPT=(/usr/local/bin/rear-drbd_vm_restore)</p>
<p>the patch is made by suggestion/hint from schlomo:</p>
<ol>
<li>working at function "Source", not "SourceStage". but I did change
    one line at fucntion "SourceStage". this can be prevented by add
    more lines at function "Source", so it is a coding choice. I found
    function "Source" seems only be called by "SourceStage", but maybe
    that is just a coincidence. please comment which coding style is
    preferred.</li>
<li>the format of script name is "PRE_$stage_$priority_SCRIPT" and
    "POST_$stage_$priority_SCRIPT"</li>
<li>the processing of script is the same as PRE_RECOVERY_SCRIPT and
    POST_RECOVERY_SCRIPT.</li>
</ol>
<h4 id="schlomo_commented_at_2014-11-04_1045"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/503#issuecomment-61622101">2014-11-04 10:45</a>:<a class="headerlink" href="#schlomo_commented_at_2014-11-04_1045" title="Permanent link">&para;</a></h4>
<p>Hi @tbsky,</p>
<p>thanks - this looks already much better.</p>
<p>I was wondering, maybe we can simplify things by leaving out the
numbers? So instead of having a PRE_BACKUP_97_SCRIPT just having a
PRE_BACKUP_SCRIPT that runs before any other script from the backup
stage? Won't that be enough for your purpose?</p>
<p>That way you could simplify the patch to actually be in SourceStage()
only and to generalize what happens now with the POST_RECOVERY_SCRIPT
variable (see
<a href="https://github.com/rear/rear/blob/master/usr/share/rear/wrapup/default/50_post_recovery_script.sh">https://github.com/rear/rear/blob/master/usr/share/rear/wrapup/default/50_post_recovery_script.sh</a>).</p>
<p>We would then add a new Eval() function that would do the same
step-by-step and simulate stuff as found in Source() but to actually
eval the arguments.</p>
<p>While looking at the code I realized that the following does not work:</p>
<pre><code>POST_RECOVERY_SCRIPT=(date "+%Y %M")
eval "${POST_RECOVERY_SCRIPT[@]}"
</code></pre>
<p>(and [*] also does not help either)</p>
<p>I actually really would like to see a solution that would be more robust
and allow arbitrary content.</p>
<p>BTW, ReaR uses Bash so bashism are actually favoured over calling
external tools. For example:</p>
<pre><code>set -- /foo/76_bar.sh foo
script_file_name=${1##*/}
script_number=${script_file_name:0:2}
script_stage=${2^^}
echo $script_file_name $script_number $script_stage
</code></pre>
<p>@gdha, @dagwieers, @jhoekx: What do you think about this feature and how
it should be implemented?</p>
<h4 id="tbsky_commented_at_2014-11-04_1231"><img src="https://avatars.githubusercontent.com/u/9283275?v=4" width="50"><a href="https://github.com/tbsky">tbsky</a> commented at <a href="https://github.com/rear/rear/pull/503#issuecomment-61632778">2014-11-04 12:31</a>:<a class="headerlink" href="#tbsky_commented_at_2014-11-04_1231" title="Permanent link">&para;</a></h4>
<p>hi schlomo:<br />
when making patches, I like to do minimal changes to make maximum
flexibility and maintain compatibility. so in fact, I prefer my first
patch, and this second patch is ok for me too. but "PRE_BACKUP_SCRIPT"
is not enough for me. since my custom script needs to run after rear
mount the backup point, and before rear umount the backup point.</p>
<p>about eval custom scripts, I don't really understand why rear use this
design, maybe to maintain consistency for other parameters? since many
rear parameters use array content.</p>
<p>I don't quite understand the need to put arbitrary content to script
array. to me 'date "+%Y %M' is code and can be put to script file or
bash function. so I would do below in config file:</p>
<pre><code>funtion my_function {
date "+%Y %M"
}
POST_RECOVERY_SCRIPT=(my_function)
</code></pre>
<p>rear use eval "${POST_RECOVERY_SCRIPT[@]}". so I can still use
function in local.conf. (I love that..)<br />
but others who want to separate code and configuration can put the code
to script files. I think it is a win-win situation.</p>
<p>about bashism, it is hard for me since I don't know what feature comes
with what bash version. so I prevent use advanced bash feature unless
necessary. since linux coreutils is a very old tool so I think it is
safer to maintain compatibility. I saw codes in rear specifically made
for RHEL4, so I try to maintain that compatibility. for example, code
'script_stage=${2^^}' seems only valid for bash 4.x. and RHEL4 only
have bash 3.x. I think it is a coding choice. so either way is ok for
me.</p>
<h4 id="schlomo_commented_at_2014-11-04_1304"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/503#issuecomment-61636284">2014-11-04 13:04</a>:<a class="headerlink" href="#schlomo_commented_at_2014-11-04_1304" title="Permanent link">&para;</a></h4>
<p>Hi @tbsky,</p>
<p>very good point about RHEL3, I checked the Bash 3.2 man page
(<a href="http://git.savannah.gnu.org/cgit/bash.git/plain/doc/bashref.html?id=28089d04354f1834f109bcb4730c9200234861bc">http://git.savannah.gnu.org/cgit/bash.git/plain/doc/bashref.html?id=28089d04354f1834f109bcb4730c9200234861bc</a>)
and it indeed does not support ^^ :-(</p>
<p>I also like your idea about putting complex stuff into a function before
calling it as a POST_RECOVERY_SCRIPT. In fact, I like it so much that
I would consider to change the documentation (but not the code) to
recommend using POST_RECOVERY_SCRIPT (and the others you suggest) as
scalars instead to prevent users from assuming that something like
<code>( date "+%y %M" )</code> would work.</p>
<p>Seeing that I start to see that this patch is a reasonable compromise.
Let me ask you a question: What do you think is more complexity: Putting
your extra scripts into /usr/share/rear/* to fit into ReaR or to add
your suggested code to Source() and SourceStage()?</p>
<p>Another question: Why do we need this PRE_* and POST_* stuff when it
basically would be enough to have an INTERNAL_SCRIPT_BACKUP_87= in
order to add something at position 87 in the backup stage? I would then
add these scripts (with <code>${!INTERNAL_SCRIPT_BACKUP_*}</code>) to the sorting
in SourceStage() and sort real scripts and internal scripts together
like this.</p>
<p>I also would like to hear the opinion of the other maintainers.</p>
<h4 id="tbsky_commented_at_2014-11-04_1415"><img src="https://avatars.githubusercontent.com/u/9283275?v=4" width="50"><a href="https://github.com/tbsky">tbsky</a> commented at <a href="https://github.com/rear/rear/pull/503#issuecomment-61644816">2014-11-04 14:15</a>:<a class="headerlink" href="#tbsky_commented_at_2014-11-04_1415" title="Permanent link">&para;</a></h4>
<p>hi schlomo:</p>
<p>thanks for your kindly support :) but I don't quite understand your
first question. do you mean which way is more complexity when adding
custom stuff for me? put custom stuff directly into /usr/share/rear is
simple at first, but it is easier to maintain when doing custom stuff at
configuration files. and once you figure out how to do it, I think it is
much simpler than putting things to /usr/share/rear.</p>
<p>about your second question, indeed we don't need these "PRE" and "POST"
stuff, if we can have a script variable name
"INTERNAL_SCRIPT_BACKUP_87". I totally support this idea. it is much
simpler,direct and easier to understand than "custom function" or "PRE"
&amp; "POST" stuff.</p>
<h4 id="schlomo_commented_at_2014-11-04_1542"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/503#issuecomment-61659105">2014-11-04 15:42</a>:<a class="headerlink" href="#schlomo_commented_at_2014-11-04_1542" title="Permanent link">&para;</a></h4>
<p>I mean this:</p>
<p>Putting files into /usr/share/rear adds a (IMHO very small) amount of
complexity to the <em>deployment and configuration management</em> process.</p>
<p>Extending the ReaR framework to inject internal calls at arbitrary
places adds a (IMHO medium) amount of complexity to the framework, since
then one has to contend with the fact that the workflow actually changes
much more with the configuration as it does at the moment. ATM the
output of <code>rear -s</code> will always be the same for the same OUTPUT and
BACKUP configuration. With this change that no longer holds true.</p>
<p>My interpretation of what you tell us is that it is more convenient for
you to put this extra code into local.conf instead of extra ReaR
scriptlets because you actually don't have any deployment and
configuration management in place. For other people, who have that in
place, it might be actually easier to deploy some extra scripts into the
right place within ReaR.</p>
<p>So that is why I ask the question about the complexity. For me it is a
decision about where to put this extra complexity: In ReaR as part of
the framework or in the deployment/configuration management of the user.</p>
<h4 id="tbsky_commented_at_2014-11-04_1650"><img src="https://avatars.githubusercontent.com/u/9283275?v=4" width="50"><a href="https://github.com/tbsky">tbsky</a> commented at <a href="https://github.com/rear/rear/pull/503#issuecomment-61672096">2014-11-04 16:50</a>:<a class="headerlink" href="#tbsky_commented_at_2014-11-04_1650" title="Permanent link">&para;</a></h4>
<p>hi schlomo:</p>
<p>ok. now i understand your question. in my opinion it is often better
when you can do more things without sacrificing other features. so if
you like to do things as usual (put custom scripts to /usr/share/rear).
you can just do it and ignore the patch. if you want to put your code to
other places or inside configuration files, you can have your choices
with this kind of patch. I can see your view is stand at higher point:
if you maintain many rear systems you may want a single way to implement
things, so there won't be too much surprise when you met one rear system
which is not configured by you. but a few observations:</p>
<ol>
<li>we already have PRE_RECOVERY_SCRIPT and PORT_RECOVERY_SCRIPT.
    these two are not absolutely necessary. you can just plug your
    scripts into /usr/share/rear and take the same affect. so there is
    already a door opened for end users. with these two parameter you
    won't have consistent "rear -s" with the same files at
    /usr/share/rear when recover. if you already open a door, why not
    open<br />
    other windows.</li>
<li>the modular rear design already let user to plugin codes easily. so
    the difference with or without the patch is just "where" to plugin
    the codes. in my opinion it seems not a very big issue. in fact if
    you plugin your custom scripts into /usr/share/rear directly,
    although you have consistent "rear -s" every time, but it is now
    harder to find out what is the custom scripts, since under "rear -s"
    every script name looks like similar. but if you plugin your code
    via script parameter at local.conf, things are clear.<br />
    that's why I prefer put changes into configuration file and take
    "usr/share/rear" as "official" place. I must again use "Freepbx"
    design as example, when you "ls -la *custom.conf" at Freepbx
    system, you immediately figure out the extra custom configuration.
    you won't forget things you had done or miss the configuration made
    by other admins.</li>
</ol>
<h4 id="schlomo_commented_at_2014-11-04_2010"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/503#issuecomment-61705678">2014-11-04 20:10</a>:<a class="headerlink" href="#schlomo_commented_at_2014-11-04_2010" title="Permanent link">&para;</a></h4>
<p>Argument 1 was my reason to suggest to generalize that.</p>
<p>Argument 2 tells me that in our mission to make users happy we should
leave<br />
the choice to them.</p>
<p>So I will be happy to help you with a suitable patch, I would also be
happy<br />
if it would not do the PRE_ / POST_ stuff but more something like<br />
INTERNAL_SCRIPT_$stage_$number_optional_text.</p>
<p>Want to give it another shot? I think that this patch is already very
close<br />
to that idea.</p>
<p>Please bear with me, I tend to be very careful about changes to the<br />
framework itself :-)</p>
<p>On 4 November 2014 17:50, tbsky <a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#110;&#111;&#116;&#105;&#102;&#105;&#99;&#97;&#116;&#105;&#111;&#110;&#115;&#64;&#103;&#105;&#116;&#104;&#117;&#98;&#46;&#99;&#111;&#109;">&#110;&#111;&#116;&#105;&#102;&#105;&#99;&#97;&#116;&#105;&#111;&#110;&#115;&#64;&#103;&#105;&#116;&#104;&#117;&#98;&#46;&#99;&#111;&#109;</a> wrote:</p>
<blockquote>
<p>hi schlomo:</p>
<p>ok. now i understand your question. in my opinion it is often better
when you can do more things without sacrificing other features. so if
you like to do things as usual (put custom scripts to
/usr/share/rear). you can just do it and ignore the patch. if you want
to put your code to other places or inside configuration files, you
can have your choices with this kind of patch. I can see your view is
stand at higher point: if you maintain many rear systems you may want
a single way to implement things, so there won't be too much surprise
when you met one rear system which is not configured by you. but a few
observations:</p>
<ol>
<li></li>
</ol>
<p>we already have PRE_RECOVER_SCRIPT and PORT_RECOVER_SCRIPT. these
two<br />
are not absolutely necessary. you can just plug your scripts into<br />
/usr/share/rear and take the same affect. so there is already a door
opened<br />
for end users. with these two parameter you won't have consistent
"rear -s"<br />
with the same files at /usr/share/rear when recover. if you already
open a<br />
door, why not open<br />
other windows.<br />
2.</p>
<p>the modular rear design already let user to plugin codes easily. so<br />
the difference with or without the patch is just "where" to plugin
the<br />
codes. in my opinion it seems not a very big issue. in fact if you
plugin<br />
your custom scripts into /usr/share/rear directly, although you have<br />
consistent "rear -s" every time, but it is now harder to find out what
is<br />
the custom scripts, since under "rear -s" every script name looks
like<br />
similar. but if you plugin your code via script parameter at
local.conf,<br />
things are clear.<br />
that's why I prefer put changes into configuration file and take<br />
"usr/share/rear" as "official" place. I must again use "Freepbx"
design as<br />
example, when you "ls -la *custom.conf" at Freepbx system, you
immediately<br />
figure out the extra custom configuration. you won't forget things you
do<br />
or miss the configuration made by other admins.</p>
<p>—<br />
Reply to this email directly or view it on GitHub<br />
<a href="https://github.com/rear/rear/pull/503#issuecomment-61672096">https://github.com/rear/rear/pull/503#issuecomment-61672096</a>.</p>
</blockquote>
<h4 id="tbsky_commented_at_2014-11-05_0306"><img src="https://avatars.githubusercontent.com/u/9283275?v=4" width="50"><a href="https://github.com/tbsky">tbsky</a> commented at <a href="https://github.com/rear/rear/pull/503#issuecomment-61753341">2014-11-05 03:06</a>:<a class="headerlink" href="#tbsky_commented_at_2014-11-05_0306" title="Permanent link">&para;</a></h4>
<p>hi schlomo:<br />
I totally support your idea. I think
"INTERNAL_SCRIPT_$stage_$number_optional_text." is better than
custom function or PRE/POST stuff. I will try to do another patch with
the idea.</p>
<p>I want to make sure what is the best naming convention of the script
variable? we have PRE_RECOVERY_SCRIPT now, so to make consistency, the
"_SCRIPT" seems at last word. we may have some choices:</p>
<pre><code>INTERNAL_SCRIPT_BACKUP_87_CUSTOM
INTERNAL_SCRIPT_BACKUP_87_myscript
INTERNAL_SCRIPT_BACKUP_87
INTERNAL_BACKUP_87_SCRIPT
</code></pre>
<p>other suggestions?</p>
<h4 id="schlomo_commented_at_2014-11-05_0643"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/503#issuecomment-61766303">2014-11-05 06:43</a>:<a class="headerlink" href="#schlomo_commented_at_2014-11-05_0643" title="Permanent link">&para;</a></h4>
<pre><code>$ INTERNAL_BACKUP_87_foo_SCRIPT=1
$ echo ${!INTERNAL*SCRIPT}
bash: ${!INTERNAL*SCRIPT}: bad substitution
$ echo ${!INTERNAL*}
INTERNAL_BACKUP_87_foo_SCRIPT
</code></pre>
<p>Based on that I would suggest to do INTERNAL_SCRIPT_$stage_$number as
the mandatory part so that we can match with the beginning. The variable
names could be longer though and numbers can be used more than once.
Just like with the shell script snippets.</p>
<p>Correct names would thus be</p>
<pre><code>INTERNAL_SCRIPT_BACKUP_87
INTERNAL_SCRIPT_BACKUP_87_schlomo
INTERNAL_SCRIPT_BACKUP_87_I_dont_know_what_to_put_here
...
</code></pre>
<p>Maybe coding it will impose further requirements, like that there always
be something after the number or some other constraints.</p>
<h4 id="pavoldomin_commented_at_2014-11-05_0801"><img src="https://avatars.githubusercontent.com/u/1576908?v=4" width="50"><a href="https://github.com/pavoldomin">pavoldomin</a> commented at <a href="https://github.com/rear/rear/pull/503#issuecomment-61771881">2014-11-05 08:01</a>:<a class="headerlink" href="#pavoldomin_commented_at_2014-11-05_0801" title="Permanent link">&para;</a></h4>
<p>Hi,</p>
<p>Let me enter this discussion. While I understand the need to insert user
code to the rear workflow, the introduction of the new set of the
configuration variables does not seem very nice: there is too many
configuration variables already. Honestly, it is not nice to read
<code>conf/default.conf</code> already now.</p>
<p>Wouldn't it make better sense, if ReaR supports two roots for stage
scripts: the "package-shipped" <code>/usr/share/rear/</code> and the
"sysadmin-shipped" (e.g. <code>/etc/rear/share/</code>) and ReaR would <em>merge</em> them
when creating the workflow? This way we don't need any new config
variable, while we permit admin to have the full control of the ReaR
code, without touching the package scripts content.</p>
<h4 id="schlomo_commented_at_2014-11-05_0815"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/503#issuecomment-61773016">2014-11-05 08:15</a>:<a class="headerlink" href="#schlomo_commented_at_2014-11-05_0815" title="Permanent link">&para;</a></h4>
<p>Hi @pavoldomin, thanks for entering.</p>
<p>I like your idea as it would greatly simplify the framework compared to
the internal script variable solution.</p>
<p>However, @tbsky specifically wanted to keep code in configuration.
@tbsky, would this new idea help you also?</p>
<p>BTW, that change could be as simple as adding 2-3 lines in
SourceStage()!</p>
<h4 id="tbsky_commented_at_2014-11-05_0849"><img src="https://avatars.githubusercontent.com/u/9283275?v=4" width="50"><a href="https://github.com/tbsky">tbsky</a> commented at <a href="https://github.com/rear/rear/pull/503#issuecomment-61776229">2014-11-05 08:49</a>:<a class="headerlink" href="#tbsky_commented_at_2014-11-05_0849" title="Permanent link">&para;</a></h4>
<p>hi schlomo &amp;pavoldomin:</p>
<p>that would be ok for me. although I prefer maintain only 1 configuration
file, but that is not really necessary.</p>
<p>I want to mention one thing about this custom script. when I do my first
patch, I emulate the behavior of rear official scripts, so when custom
script failed, the rear process stopped. when I do my second patch, I
emulate the behavior of PRE_RECOVERY_SCRIPT. so when custom script
failed, the rear process continue. I think maybe there should be
consistent behavior of custom scripts. I think about parameters to
control the behavior. but as you guys mentioned, there are already too
many parameters :)</p>
<h4 id="schlomo_commented_at_2014-11-05_0956"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/503#issuecomment-61783631">2014-11-05 09:56</a>:<a class="headerlink" href="#schlomo_commented_at_2014-11-05_0956" title="Permanent link">&para;</a></h4>
<p>I also think we should make it consistent with the general ReaR
framework meaning we should fail if a custom script fails.</p>
<p>To make it simple for users I would like to add a deprecation warning to
the PRE_RECOVERY_SCRIPT and POST_RECOVERY_SCRIPT features.</p>
<p>I did not try it out but I would start coding from something like this
in Source():</p>
<pre><code>    scripts=(
        $(
        cd $SHARE_DIR/$stage ;
        # We always source scripts in the same subdirectory structure. The {..,..,..} way of writing
        # it is just a shell shortcut that expands as intended.
        ls -d   
            "$CONFIG_DIR/workflow/$stage"/*.sh \
{default,"$ARCH","$OS","$OS_MASTER_VENDOR","$OS_MASTER_VENDOR_ARCH","$OS_MASTER_VENDOR_VERSION","$OS_VENDOR","$OS_VENDOR_ARCH","$OS_VENDOR_VERSION"}/*.sh \
            "$BACKUP"/{default,"$ARCH","$OS","$OS_MASTER_VENDOR","$OS_MASTER_VENDOR_ARCH","$OS_MASTER_VENDOR_VERSION","$OS_VENDOR","$OS_VENDOR_ARCH","$OS_VENDOR_VERSION"}/*.sh \
            "$OUTPUT"/{default,"$ARCH","$OS","$OS_MASTER_VENDOR","$OS_MASTER_VENDOR_ARCH","$OS_MASTER_VENDOR_VERSION","$OS_VENDOR","$OS_VENDOR_ARCH","$OS_VENDOR_VERSION"}/*.sh \
            "$OUTPUT"/"$BACKUP"/{default,"$ARCH","$OS","$OS_MASTER_VENDOR","$OS_MASTER_VENDOR_ARCH","$OS_MASTER_VENDOR_VERSION","$OS_VENDOR","$OS_VENDOR_ARCH","$OS_VENDOR_VERSION"}/*.sh \
        | sed -e 's#/\([0-9][0-9]\)_#/!\1!_#g' | sort -t \! -k 2 | tr -d \!
        )
        # This sed hack is neccessary to sort the scripts by their 2-digit number INSIDE indepentand of the
        # directory depth of the script. Basicall sed inserts a ! before and after the number which makes the
        # number always field nr. 2 when dividing lines into fields by !. The following tr removes the ! to
        # restore the original script name. But now the scripts are already in the correct order.
        )
</code></pre>
<p>Maybe that is all that we need to change.</p>
<h4 id="tbsky_commented_at_2014-11-12_1109"><img src="https://avatars.githubusercontent.com/u/9283275?v=4" width="50"><a href="https://github.com/tbsky">tbsky</a> commented at <a href="https://github.com/rear/rear/pull/503#issuecomment-62702950">2014-11-12 11:09</a>:<a class="headerlink" href="#tbsky_commented_at_2014-11-12_1109" title="Permanent link">&para;</a></h4>
<p>hi gdha:<br />
because the "Source" function need to know what stage it is in. in can
find out that itself, just need more lines of codes, with more codes in
"Source" function you don't need to add the parameters.</p>
<p>BTW, I think the patch is abandoned. schlomo would write a better one to
fit rear framework.</p>
<h4 id="gdha_commented_at_2014-11-12_1207"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/pull/503#issuecomment-62708862">2014-11-12 12:07</a>:<a class="headerlink" href="#gdha_commented_at_2014-11-12_1207" title="Permanent link">&para;</a></h4>
<p>@schlomo is it true you are working on an improved version of the
pre/post_recovery_scripts?</p>
<h4 id="schlomo_commented_at_2014-11-12_1212"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/503#issuecomment-62709361">2014-11-12 12:12</a>:<a class="headerlink" href="#schlomo_commented_at_2014-11-12_1212" title="Permanent link">&para;</a></h4>
<p>@gdha Yes and No. As indicated above I would prefer an approach of
including <code>"$CONFIG_DIR/workflow/$stage"/*.sh</code> style scripts in the
SourceStage() function.</p>
<p>My understanding of this discussion here was that providing another
location for admin-supplied script fragments would be an acceptable
alternative to creating custom functions.</p>
<p>My personal opinion is that this approach would be much better aligned
with how the ReaR framework works and thinks internally and it would
avoid the extra complexity of mixing functions and scriptles.</p>
<p>I was actually hoping that @tbsky would try out this approach and I can
commit to help polishing a patch that he would submit along this idea.</p>
<h4 id="tbsky_commented_at_2014-11-12_1332"><img src="https://avatars.githubusercontent.com/u/9283275?v=4" width="50"><a href="https://github.com/tbsky">tbsky</a> commented at <a href="https://github.com/rear/rear/pull/503#issuecomment-62717640">2014-11-12 13:32</a>:<a class="headerlink" href="#tbsky_commented_at_2014-11-12_1332" title="Permanent link">&para;</a></h4>
<p>hi:<br />
my real interest was using local.conf to manage all the custom stuff.
but as I said that's is not absolutely necessary. so now I use rpm to
deploy the custom scripts skeleton as schlomo suggested before. and
these skeletons would call real custom function defined in my
local.conf.</p>
<p>as schlomo said, the error handling of custom scripts should be the same
as official script, and current PRE_RECOVERY_SCRIPT is not acting that
way, mabye that function will be depreciated.<br />
so I think the whole design/decision is better made by core developers.</p>
<h4 id="gdha_commented_at_2014-11-18_1910"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/pull/503#issuecomment-63526664">2014-11-18 19:10</a>:<a class="headerlink" href="#gdha_commented_at_2014-11-18_1910" title="Permanent link">&para;</a></h4>
<p>@schlomo will you try to add this? I would like to concentrate on some
other parts (like btrfs and systemd/f21)</p>
<h4 id="schlomo_commented_at_2014-11-19_1108"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/503#issuecomment-63624355">2014-11-19 11:08</a>:<a class="headerlink" href="#schlomo_commented_at_2014-11-19_1108" title="Permanent link">&para;</a></h4>
<p>@gdha I'll stay on this topic. It for sure falls into my main interest
area</p>
<h4 id="gdha_commented_at_2015-01-25_1552"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/pull/503#issuecomment-71378287">2015-01-25 15:52</a>:<a class="headerlink" href="#gdha_commented_at_2015-01-25_1552" title="Permanent link">&para;</a></h4>
<p>Don't we better post-pone this to next release rear-1.18?</p>
<h4 id="schlomo_commented_at_2015-01-25_1809"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/503#issuecomment-71383914">2015-01-25 18:09</a>:<a class="headerlink" href="#schlomo_commented_at_2015-01-25_1809" title="Permanent link">&para;</a></h4>
<p>Well, why not simply add <code>"$CONFIG_DIR/workflow/$stage"/*.sh</code> as
described above and add a deprecation warning to the POST_* and
PRE_* script variables?</p>
<p>@gdha, @dagwieers, @jhoekx please tell me what you think about this
approach?</p>
<h4 id="gdha_commented_at_2015-01-25_1937"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/pull/503#issuecomment-71388100">2015-01-25 19:37</a>:<a class="headerlink" href="#gdha_commented_at_2015-01-25_1937" title="Permanent link">&para;</a></h4>
<p>@schlomo I don't mind as long everybody agrees on the way forward. So +1</p>
<h4 id="pavoldomin_commented_at_2015-01-27_0901"><img src="https://avatars.githubusercontent.com/u/1576908?v=4" width="50"><a href="https://github.com/pavoldomin">pavoldomin</a> commented at <a href="https://github.com/rear/rear/pull/503#issuecomment-71611976">2015-01-27 09:01</a>:<a class="headerlink" href="#pavoldomin_commented_at_2015-01-27_0901" title="Permanent link">&para;</a></h4>
<p>Hi, looks fine to me. But, if I get it right, the suggestion:</p>
<pre><code>   scripts=(
   ...
        ls -d   
            "$CONFIG_DIR/workflow/$stage"/*.sh \
        ...
</code></pre>
<p>means, we add our custom scripts to the ones shipped by ReaR. It is not
exactly what @tbsky originally aimed for I think: we call our workflow
scripts <strong>added</strong> to the ReaR ones, but would be more flexible if we
<strong>replace</strong> the ReaR script with our one, if the script with same name
exists in ReaR's own workflow path.</p>
<p>But perhaps I speculate too much here.</p>
<h4 id="schlomo_commented_at_2015-01-27_1128"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/503#issuecomment-71632043">2015-01-27 11:28</a>:<a class="headerlink" href="#schlomo_commented_at_2015-01-27_1128" title="Permanent link">&para;</a></h4>
<p>I see what you mean.</p>
<p>Do we now have an actual requirement to <em>overlay</em> ReaR scripts?</p>
<p>@tbsky, can you please let us know if <em>adding</em> scripts would be enough
for<br />
your current need.</p>
<p>IMHO adding the option to overlay or disable ReaR scripts is a very<br />
dangerous feature as many scripts depend on each other. If users need to
be<br />
able to disable some feature or behaviour then we should include
variables<br />
for that.</p>
<p>On 27 January 2015 at 10:01, pavoldomin <a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#110;&#111;&#116;&#105;&#102;&#105;&#99;&#97;&#116;&#105;&#111;&#110;&#115;&#64;&#103;&#105;&#116;&#104;&#117;&#98;&#46;&#99;&#111;&#109;">&#110;&#111;&#116;&#105;&#102;&#105;&#99;&#97;&#116;&#105;&#111;&#110;&#115;&#64;&#103;&#105;&#116;&#104;&#117;&#98;&#46;&#99;&#111;&#109;</a>
wrote:</p>
<blockquote>
<p>Hi, looks fine to me. But, if I get it right, the suggestion:</p>
<p>scripts=(<br />
...<br />
ls -d<br />
"$CONFIG_DIR/workflow/$stage"/*.sh <br />
...</p>
<p>means, we add our custom scripts to the ones shipped by ReaR. It is
not<br />
exactly what @tbsky
<a href="https://github.com/tbsky">https://github.com/tbsky</a> originally aimed
for I<br />
think: we call our workflow scripts <em>added</em> to the ReaR ones, but
would<br />
be more flexible if we <em>replace</em> the ReaR script with our one, if
the<br />
script with same name exists in ReaR's own workflow path.</p>
<p>But perhaps I speculate too much here.</p>
<p>—<br />
Reply to this email directly or view it on GitHub<br />
<a href="https://github.com/rear/rear/pull/503#issuecomment-71611976">https://github.com/rear/rear/pull/503#issuecomment-71611976</a>.</p>
</blockquote>
<h4 id="tbsky_commented_at_2015-01-27_1245"><img src="https://avatars.githubusercontent.com/u/9283275?v=4" width="50"><a href="https://github.com/tbsky">tbsky</a> commented at <a href="https://github.com/rear/rear/pull/503#issuecomment-71642287">2015-01-27 12:45</a>:<a class="headerlink" href="#tbsky_commented_at_2015-01-27_1245" title="Permanent link">&para;</a></h4>
<p>@schlomo</p>
<p>I think it is good to separate rear official scripts and custom scripts.
for my need, I already use rpm to deploy custom scripts to call my
custom functions, so I can manage all the configurations in one config
file. that's enough for me.</p>
<h4 id="schlomo_commented_at_2015-01-27_1343"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/503#issuecomment-71649061">2015-01-27 13:43</a>:<a class="headerlink" href="#schlomo_commented_at_2015-01-27_1343" title="Permanent link">&para;</a></h4>
<p>@tbsky, does that mean that we can close this issue and do nothing?</p>
<p>Or would it help you if I implement the addition I suggested above?</p>
<p>On 27 January 2015 at 13:45, tbsky <a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#110;&#111;&#116;&#105;&#102;&#105;&#99;&#97;&#116;&#105;&#111;&#110;&#115;&#64;&#103;&#105;&#116;&#104;&#117;&#98;&#46;&#99;&#111;&#109;">&#110;&#111;&#116;&#105;&#102;&#105;&#99;&#97;&#116;&#105;&#111;&#110;&#115;&#64;&#103;&#105;&#116;&#104;&#117;&#98;&#46;&#99;&#111;&#109;</a> wrote:</p>
<blockquote>
<p>@schlomo <a href="https://github.com/schlomo">https://github.com/schlomo</a></p>
<p>I think it is good to separate rear official scripts and custom
scripts. for me need, I already use rpm to deploy custom scripts to
call my custom functions, so I can manage all the configurations in
one config file. that's enough for me.</p>
<p>—<br />
Reply to this email directly or view it on GitHub<br />
<a href="https://github.com/rear/rear/pull/503#issuecomment-71642287">https://github.com/rear/rear/pull/503#issuecomment-71642287</a>.</p>
</blockquote>
<h4 id="tbsky_commented_at_2015-01-28_0209"><img src="https://avatars.githubusercontent.com/u/9283275?v=4" width="50"><a href="https://github.com/tbsky">tbsky</a> commented at <a href="https://github.com/rear/rear/pull/503#issuecomment-71768840">2015-01-28 02:09</a>:<a class="headerlink" href="#tbsky_commented_at_2015-01-28_0209" title="Permanent link">&para;</a></h4>
<p>@schlomo</p>
<p>yes we can close it since it is not really a problem, just an
enhancement. but as you said, I think implement a infrastructure for
user-defined custom scripts is a good thing.</p>
<h4 id="gdha_commented_at_2015-11-24_1728"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/pull/503#issuecomment-159348731">2015-11-24 17:28</a>:<a class="headerlink" href="#gdha_commented_at_2015-11-24_1728" title="Permanent link">&para;</a></h4>
<p>@schlomo Shall we silently close this pull request as there is no
general demand for it. Rear is more then complex enough.</p>
<h4 id="schlomo_commented_at_2015-11-24_1847"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/503#issuecomment-159369506">2015-11-24 18:47</a>:<a class="headerlink" href="#schlomo_commented_at_2015-11-24_1847" title="Permanent link">&para;</a></h4>
<p>@gdha yes, in favour. I prefer users to plug scripts into the ReaR tree
and I would ask them to accept that this is how we want them to extend
ReaR.</p>
<h4 id="jsmeix_commented_at_2015-11-25_0952"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/503#issuecomment-159553449">2015-11-25 09:52</a>:<a class="headerlink" href="#jsmeix_commented_at_2015-11-25_0952" title="Permanent link">&para;</a></h4>
<p>A note only FYI:</p>
<p>I appreciate everything that reduces complexity in Rear.</p>
<p>Keep It Simple and Straightforward cf. RFC 1925 (6a)<br />
and<br />
Keep Separated Issues Separated cf. RFC 1925 (5)</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2023 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2014-11-04.503.pr.closed.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
