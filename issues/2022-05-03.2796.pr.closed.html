<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#2796 PR closed: Overhauled layout/compare/default/510_compare_files.sh - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#2796 PR closed: Overhauled layout/compare/default/510_compare_files.sh";
        var mkdocs_page_input_path = "issues/2022-05-03.2796.pr.closed.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/backup_netfs.html">Example of BACKUP=NETFS</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/netfs_nas.html">Internal Backup with tar to NFS server</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/netfs_rsync.html">Internal Backup with rsync to NFS server</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/rsync.html">Internal Backup using BACKUP=RSYNC method</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/rbme.html">External Backup using RBME</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/restic.html">External Backup using restic</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../development/squash-git-log-commments.html">How to squash git log comments into one line</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear29.html">Release Notes ReaR 2.9</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear28.html">Release Notes ReaR 2.8</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#2796 PR closed: Overhauled layout/compare/default/510_compare_files.sh</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="2796_pr_closed_overhauled_layoutcomparedefault510_compare_filessh"><a href="https://github.com/rear/rear/pull/2796">#2796 PR</a> <code>closed</code>: Overhauled layout/compare/default/510_compare_files.sh<a class="headerlink" href="#2796_pr_closed_overhauled_layoutcomparedefault510_compare_filessh" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>enhancement</code>, <code>cleanup</code>, <code>won't fix / can't fix / obsolete</code></p>
<h4 id="jsmeix_opened_issue_at_2022-05-03_1253"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> opened issue at <a href="https://github.com/rear/rear/pull/2796">2022-05-03 12:53</a>:<a class="headerlink" href="#jsmeix_opened_issue_at_2022-05-03_1253" title="Permanent link">&para;</a></h4>
<p>Completely overhauled<br />
layout/compare/default/510_compare_files.sh<br />
according to<br />
<a href="https://github.com/rear/rear/pull/2795#issuecomment-1116010676">https://github.com/rear/rear/pull/2795#issuecomment-1116010676</a><br />
and<br />
<a href="https://github.com/rear/rear/pull/2796#issuecomment-1116126796">https://github.com/rear/rear/pull/2796#issuecomment-1116126796</a></p>
<h4 id="jsmeix_commented_at_2022-05-03_1254"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2796#issuecomment-1116065324">2022-05-03 12:54</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-05-03_1254" title="Permanent link">&para;</a></h4>
<p>@pcahyna<br />
this pull request is only meant as a proposal<br />
so you could have a look<br />
how things might be done according to<br />
<a href="https://github.com/rear/rear/pull/2795#issuecomment-1116010676">https://github.com/rear/rear/pull/2795#issuecomment-1116010676</a></p>
<p>Currently it is totally untested code so there could be stupid bugs.<br />
It is only meant to show some basic ideas.</p>
<h4 id="jsmeix_commented_at_2022-05-03_1348"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2796#issuecomment-1116121609">2022-05-03 13:48</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-05-03_1348" title="Permanent link">&para;</a></h4>
<p>I think<br />
<a href="https://github.com/rear/rear/pull/2796/commits/4d4230b435b6ad4693a77b15578910a14f4676e0">https://github.com/rear/rear/pull/2796/commits/4d4230b435b6ad4693a77b15578910a14f4676e0</a><br />
can be fixed by first regenerating what FILES_TO_PATCH_PATTERNS
evaluates to<br />
and then appending what CHECK_CONFIG_FILES evaluates to<br />
as it is done in layout/save/default/600_snapshot_files.sh<br />
in
<a href="https://github.com/rear/rear/pull/2795">https://github.com/rear/rear/pull/2795</a></p>
<h4 id="jsmeix_commented_at_2022-05-03_1352"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2796#issuecomment-1116126796">2022-05-03 13:52</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-05-03_1352" title="Permanent link">&para;</a></h4>
<p>I wonder why there is no symlink handling for what CHECK_CONFIG_FILES
evaluates to.</p>
<p>I think that whole stuff needs to be overhauled and cleanly<br />
(i.e. more simple and straightforward) implemented like:</p>
<ol>
<li>
<p>Evaluate CHECK_CONFIG_FILES and FILES_TO_PATCH_PATTERNS<br />
    to a local array of plain files and symlinks.</p>
</li>
<li>
<p>Do symlink handling for the plain files and symlinks in that aray.</p>
</li>
<li>
<p>Run "md5sum" for the results.</p>
</li>
</ol>
<h4 id="jsmeix_commented_at_2022-05-04_0907"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2796#issuecomment-1117085109">2022-05-04 09:07</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-05-04_0907" title="Permanent link">&para;</a></h4>
<p>My recent<br />
<a href="https://github.com/rear/rear/pull/2796/commits/3d816d982e2133e8a84385178ecbf5c3d61583ff">https://github.com/rear/rear/pull/2796/commits/3d816d982e2133e8a84385178ecbf5c3d61583ff</a><br />
has almost duplicated code (except log messages and absolute path
handling)<br />
which could be further unified but for now I leave it as is<br />
and test if that works...</p>
<h4 id="pcahyna_commented_at_2022-05-04_0922"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/2796#issuecomment-1117098190">2022-05-04 09:22</a>:<a class="headerlink" href="#pcahyna_commented_at_2022-05-04_0922" title="Permanent link">&para;</a></h4>
<p>Do we need any symlink checks for <code>CHECK_CONFIG_FILES</code>? Those files are
specified explicitly, so shouldn't we respect what was put there and
avoid any post-processing (except expanding directories)?</p>
<h4 id="jsmeix_commented_at_2022-05-04_1000"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2796#issuecomment-1117133276">2022-05-04 10:00</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-05-04_1000" title="Permanent link">&para;</a></h4>
<p>With my latest commit (i.e. with DebugPrint) I get for</p>
<pre><code>CHECK_CONFIG_FILES=( '/etc/fstab' '/etc/crypttab' '/etc/mtab' '/etc/issue' '/etc/QQQ' )
FILES_TO_PATCH_PATTERNS="[e]tc/fstab [e]tc/mtab [e]tc/issue /home/johannes/testdir_symlink QQQQ"
</code></pre>
<p>with</p>
<pre><code># find /home/johannes/testdir* -ls

... drwxr-xr-x ... /home/johannes/testdir
... lrwxrwxrwx ... /home/johannes/testdir/etc_mtab_symlink -&gt; /etc/mtab
... lrwxrwxrwx ... /home/johannes/testdir/broken_symlink -&gt; broken
... -rw-r--r-- ... /home/johannes/testdir/file
... lrwxrwxrwx ... /home/johannes/testdir/file_symlink -&gt; file
... lrwxrwxrwx ... /home/johannes/testdir/etc_issue_symlink -&gt; /etc/issue
... lrwxrwxrwx ... /home/johannes/testdir_symlink -&gt; testdir
</code></pre>
<p>after a "rear savelayout"</p>
<pre><code># usr/sbin/rear -D checklayout
...
Running 'layout/compare' stage ======================
Disk layout has changed
Skip /etc/mtab from CHECK_CONFIG_FILES (symlink with target /proc/28235/mounts in /proc/ /sys/ /dev/ /run/)
Skip /etc/issue from CHECK_CONFIG_FILES (symlink with target /run/issue in /proc/ /sys/ /dev/ /run/)
Skip /etc/QQQ in CHECK_CONFIG_FILES (no regular file matches)
Skip /etc/grub.cfg in CHECK_CONFIG_FILES (no regular file matches)
Skip /etc/grub2.cfg in CHECK_CONFIG_FILES (no regular file matches)
Skip /boot/grub2/grub2.cfg in CHECK_CONFIG_FILES (no regular file matches)
Skip /boot/grub/grub.cfg in CHECK_CONFIG_FILES (no regular file matches)
Skip /etc/mtab from FILES_TO_PATCH_PATTERNS (symlink with target /proc/28289/mounts in /proc/ /sys/ /dev/ /run/)
Skip /etc/issue from FILES_TO_PATCH_PATTERNS (symlink with target /run/issue in /proc/ /sys/ /dev/ /run/)
Skip //home/johannes/testdir_symlink/etc_mtab_symlink from FILES_TO_PATCH_PATTERNS (symlink with target /proc/28307/mounts in /proc/ /sys/ /dev/ /run/)
Skip //home/johannes/testdir_symlink/etc_issue_symlink from FILES_TO_PATCH_PATTERNS (symlink with target /run/issue in /proc/ /sys/ /dev/ /run/)
Skip QQQQ in FILES_TO_PATCH_PATTERNS (no regular file matches)
There are changes related to configuration files and files to be patched
The current md5sum file is /root/rear.github.master/var/lib/rear/layout/config/files.md5sum.checklayout
The old md5sum file is kept as /root/rear.github.master/var/lib/rear/layout/config/files.md5sum.outdated
Saving /root/rear.github.master/var/log/rear/rear-linux-h9wr.log.lockless as /root/rear.github.master/var/log/rear/rear-linux-h9wr.log
Exiting rear checklayout (PID 26051) and its descendant processes ...
</code></pre>
<h4 id="jsmeix_commented_at_2022-05-04_1002"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2796#issuecomment-1117135413">2022-05-04 10:02</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-05-04_1002" title="Permanent link">&para;</a></h4>
<p>I think we need symlink checks also for CHECK_CONFIG_FILES<br />
because the user may have specified directories which<br />
contain symlinks with targets in /proc/ /sys/ /dev/ /run/</p>
<p>If a user really wants to check things in /proc/ /sys/ /dev/ /run/<br />
I think he could specify the targets in /proc/ /sys/ /dev/ /run/</p>
<h4 id="jsmeix_commented_at_2022-05-04_1007"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2796#issuecomment-1117139448">2022-05-04 10:07</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-05-04_1007" title="Permanent link">&para;</a></h4>
<p>For the fun of it:</p>
<pre><code># ls -l /dev/lp0
crw-rw---- 1 root lp 6, 0 May  4 09:11 /dev/lp0

# md5sum /dev/lp0
md5sum: /dev/lp0: No such device or address

# time md5sum /dev/sda8
ac480c812f27dcdeeae89fdb3db3be29  /dev/sda8

real    0m19.408s
user    0m2.486s
sys     0m0.361s
</code></pre>
<p>/dev/sda8 is a 1.07GB "playground" partition on my disk.</p>
<h4 id="jsmeix_commented_at_2022-05-04_1012"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2796#issuecomment-1117143261">2022-05-04 10:12</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-05-04_1012" title="Permanent link">&para;</a></h4>
<p>For me <code>CHECK_CONFIG_FILES=( ... '/dev/lp0' '/proc/cmdline' )</code><br />
seems to work as expected - I get in
var/lib/rear/layout/config/files.md5sum</p>
<pre><code>f8805aa1625aa28d41adbe422a94ebb2  /proc/cmdline
</code></pre>
<p>and on the screen there is</p>
<pre><code>Skip /dev/lp0 in CHECK_CONFIG_FILES (no regular file matches)
</code></pre>
<h4 id="jsmeix_commented_at_2022-05-04_1019"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2796#issuecomment-1117149143">2022-05-04 10:19</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-05-04_1019" title="Permanent link">&para;</a></h4>
<p>With <code>CHECK_CONFIG_FILES=( ... '/dev/sda8' )</code><br />
I get a longer delay during "rear savelayout"<br />
because it computes the md5sum for /dev/sda8<br />
but during "rear -D checklayout" I get on the terminal</p>
<pre><code>Skip /dev/sda8 in CHECK_CONFIG_FILES (no regular file matches)
</code></pre>
<p>so I think we should exclude non regular files hardcoded in general<br />
at least for now because I assume md5sum comparison<br />
does not make sense in such cases.<br />
If a user reports a special case where that is really needed<br />
we could adapt and enhance things accordingly.</p>
<h4 id="jsmeix_commented_at_2022-05-04_1048"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2796#issuecomment-1117171070">2022-05-04 10:48</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-05-04_1048" title="Permanent link">&para;</a></h4>
<p>The messages</p>
<pre><code>Skip /etc/grub.cfg in CHECK_CONFIG_FILES (no regular file matches)
Skip /etc/grub2.cfg in CHECK_CONFIG_FILES (no regular file matches)
Skip /boot/grub2/grub2.cfg in CHECK_CONFIG_FILES (no regular file matches)
Skip /boot/grub/grub.cfg in CHECK_CONFIG_FILES (no regular file matches)
</code></pre>
<p>are caused by this</p>
<pre><code># find usr/sbin/rear usr/share/rear -type f | xargs grep 'CHECK_CONFIG_FILES+=' | grep grub

usr/share/rear/layout/save/default/450_check_bootloader_files.sh:        CHECK_CONFIG_FILES+=( /boot/efi/EFI/*/grub*.cfg )
usr/share/rear/layout/save/default/450_check_bootloader_files.sh:        CHECK_CONFIG_FILES+=( /etc/grub.cfg /etc/grub2.cfg /boot/grub2/grub2.cfg /bootgrub/grub.cfg )
usr/share/rear/layout/save/default/450_check_bootloader_files.sh:        CHECK_CONFIG_FILES+=( /etc/lilo.conf /etc/yaboot.conf /etc/grub.cfg /etc/grub2.cfg /boot/grub2/grub2.cfg /boot/grub/grub.cfg)
</code></pre>
<p>because the patterns in CHECK_CONFIG_FILES must contain bash globbing
characters<br />
like a [] around the first letter to ensure that 'shopt -s nullglob'
removes this file from the listing.</p>
<p>I will fix that right now because it is a bug in any case.</p>
<h4 id="jsmeix_commented_at_2022-05-04_1124"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2796#issuecomment-1117198760">2022-05-04 11:24</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-05-04_1124" title="Permanent link">&para;</a></h4>
<p>Because<br />
<a href="https://github.com/rear/rear/pull/2795#issuecomment-1117093699">https://github.com/rear/rear/pull/2795#issuecomment-1117093699</a><br />
is important here so I quote the matching excerpt:</p>
<pre><code>I don't think that any modification of
layout/compare/default/510_compare_files.sh
(except for replacing the diff -u by a better comparison like cmp
 and using sort to avoid false warnings when the set of files is unchanged,
 but the order is changed) is needed.
layout/save/default/600_snapshot_files.sh
appends to the variable CHECK_CONFIG_FILES,
so layout/compare/default/510_compare_files.sh will inherit it
( layout/save is executed before layout/compare ).
</code></pre>
<h4 id="pcahyna_commented_at_2022-05-04_1155"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/2796#issuecomment-1117223731">2022-05-04 11:55</a>:<a class="headerlink" href="#pcahyna_commented_at_2022-05-04_1155" title="Permanent link">&para;</a></h4>
<blockquote>
<p>because the patterns in CHECK_CONFIG_FILES must contain bash
globbing characters<br />
like a [] around the first letter to ensure that 'shopt -s nullglob'
removes this file from the listing.</p>
</blockquote>
<p>I don't think <code>CHECK_CONFIG_FILES</code> is expected to contain any patterns
that the shell would expand or remove. I believe that when adding to the
variable, one may use shell patterns if one needs to ensure that
nonexistent files are not added, and perhaps one should do it (I don't
see why it is necessary though, the original code skips nonexistent
files silently, so it is not a bug to specify a nonexistent file), but
the variable itself should not contain shell patterns (the pattern
should get expanded already when adding to the variable, not when
expanding the variable itself).</p>
<h4 id="pcahyna_commented_at_2022-05-04_1200"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/2796#issuecomment-1117229033">2022-05-04 12:00</a>:<a class="headerlink" href="#pcahyna_commented_at_2022-05-04_1200" title="Permanent link">&para;</a></h4>
<p>@jsmeix thanks for the investigation of the details of file checking
here - I am not sure what should be the strategy with respect to #2795.
On one hand, I am afraid that the original issue is snowballing into
something much bigger. We have a real-world complaint about the lack of
checking after restore, but no-one has complained about the lack of
symlink handling in <code>checklayout</code> and even the wrong use of <code>diff -u</code>
does not seem to have negative consequences in practice. For this
reason, I would like to merge #2795 soon and worry about the other
stuff later. OTOH, the discussion may make #2795 entirely obsolete,
because we may find that we need an entirely different strategy.</p>
<h4 id="jsmeix_commented_at_2022-05-04_1202"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2796#issuecomment-1117230628">2022-05-04 12:02</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-05-04_1202" title="Permanent link">&para;</a></h4>
<p>That patterns get expanded before adding to CHECK_CONFIG_FILES<br />
is what I implemented in my recent<br />
<a href="https://github.com/rear/rear/commit/17ee5f87d742a57f82960b08795b07896969ac8b">https://github.com/rear/rear/commit/17ee5f87d742a57f82960b08795b07896969ac8b</a><br />
and<br />
<a href="https://github.com/rear/rear/commit/8c847f7b17d905d769acdf44dcb6d914cbe49c4a">https://github.com/rear/rear/commit/8c847f7b17d905d769acdf44dcb6d914cbe49c4a</a></p>
<h4 id="jsmeix_commented_at_2022-05-04_1213"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2796#issuecomment-1117240301">2022-05-04 12:13</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-05-04_1213" title="Permanent link">&para;</a></h4>
<p>No,
<a href="https://github.com/rear/rear/pull/2795">https://github.com/rear/rear/pull/2795</a>
is not obsolete.<br />
The strategy you developed there looks exactly right and I like it.</p>
<p>All I intended with this pull request here is a proposal how<br />
layout/save/default/600_snapshot_files.sh<br />
in
<a href="https://github.com/rear/rear/pull/2795">https://github.com/rear/rear/pull/2795</a><br />
might be improved regarding what it results in CHECK_CONFIG_FILES.</p>
<p>My idea is that basically CHECK_CONFIG_FILES should contain<br />
what <code>files_for_md5sum</code> contains in 510_compare_files.sh<br />
in this proposal here.</p>
<p>Then 510_compare_files.sh could just run md5sum<br />
for the elements "as is" in CHECK_CONFIG_FILES<br />
without any further evaluation or checks because<br />
all that was already done in 600_snapshot_files.sh</p>
<h4 id="jsmeix_commented_at_2022-05-04_1256"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2796#issuecomment-1117281303">2022-05-04 12:56</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-05-04_1256" title="Permanent link">&para;</a></h4>
<p>An addendum to<br />
<a href="https://github.com/rear/rear/pull/2796#issuecomment-1117223731">https://github.com/rear/rear/pull/2796#issuecomment-1117223731</a></p>
<p>In general I consider it as good coding style<br />
to not add nonexistent things to a variable.</p>
<p>To some extent this belongs to<br />
"Try hard to care about possible errors" in<br />
<a href="https://github.com/rear/rear/wiki/Coding-Style">https://github.com/rear/rear/wiki/Coding-Style</a><br />
because it avoids possible errors in subsequent code<br />
when variables do not contain nonsense values<br />
than to just rely on that all subsequent code<br />
(including all future added or changed subsequent code)<br />
will be sufficiently robust against nonsense values.<br />
Of course all code should be sufficiently robust<br />
but my point is to not just rely on that.</p>
<p>Furthermore when variables do not contain nonsense values<br />
it makes debugging easier because nonsense values may<br />
lead to false assumptions about the cause of an issue.</p>
<h4 id="pcahyna_commented_at_2022-05-05_0805"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/2796#issuecomment-1118279210">2022-05-05 08:05</a>:<a class="headerlink" href="#pcahyna_commented_at_2022-05-05_0805" title="Permanent link">&para;</a></h4>
<p>While it is "nice" to not supply nonexistent filenames to other parts of
the code, the code is designed to cope with that, so I would not worry
too much about it.<br />
I have thought more about the issue and came to the conclusion that
<code>CHECK_CONFIG_FILES</code> needs to contain all the file names that one has
specified, even if they do not exist. Remember that we need to
eventually fix the current gap in #2795 :
<a href="https://github.com/rear/rear/pull/2795#issuecomment-1116010676">https://github.com/rear/rear/pull/2795#issuecomment-1116010676</a>
"When CHECK_CONFIG_FILES and FILES_TO_PATCH_PATTERNS evaluate to
different files this is a change that must be detected.". Presumably, we
are going to do it by recording the full content of <code>CHECK_CONFIG_FILES</code>
during <code>layout/save</code> (including nonexistent files) and checking this
list during <code>finalize</code> at the end of recovery.<br />
If nonexistent files are simply omitted from <code>CHECK_CONFIG_FILES</code> during
<code>layout/save</code>, how will we detect that they have appeared at <code>finalize</code>
time? We can regenerate the content of <code>CHECK_CONFIG_FILES</code> again at
<code>finalize</code> time (that's how I will solve the issue for
<code>FILES_TO_PATCH_PATTERNS</code> - see "You are right that if I move to
something else than md5sum -c in finalize, the same code needs to be run
there (finalize/default/060_compare_files.sh) to regenerate
CHECK_CONFIG_FILES" in
<a href="https://github.com/rear/rear/pull/2795#issuecomment-1117093699">https://github.com/rear/rear/pull/2795#issuecomment-1117093699</a>
) but to cover all the places where <code>CHECK_CONFIG_FILES</code> is appended to
in <code>layout/save</code>, one would need to rerun them or reimplement in
<code>finalize</code>. This means running all the
<code>layout/save/default/4*_check_*.sh</code> again during <code>finalize</code> to recreate
an equivalent <code>CHECK_CONFIG_FILES</code>, and I am not sure if the scripts are
ready for that.<br />
(The problem already exists due to the presence of wildcards in some of
the <code>layout/save/default/4*_check_*.sh</code> scripts, sigh.)</p>
<h4 id="jsmeix_commented_at_2022-05-05_0839"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2796#issuecomment-1118307582">2022-05-05 08:39</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-05-05_0839" title="Permanent link">&para;</a></h4>
<p>The <code>CHECK_CONFIG_FILES+=( ... )</code> in some 'layout/save' scripts<br />
is a general problem because it modifies a user config variable<br />
which means what there is specified for CHECK_CONFIG_FILES<br />
in 'default.conf' and 'local.conf' is not authoritative for what<br />
is acually used later.<br />
So in workflows that run 'layout/save' we use a different<br />
CHECK_CONFIG_FILES (different than what the user specified)<br />
compared to workflows that do not run 'layout/save'.</p>
<p>My basic idea is to fully re-evaluate during "rear recover"<br />
CHECK_CONFIG_FILES and FILES_TO_PATCH_PATTERNS<br />
and regenerate md5sums and then compare the md5sum results.</p>
<p>After you merged
<a href="https://github.com/rear/rear/pull/2795">https://github.com/rear/rear/pull/2795</a><br />
I will have a look how it behaves with it and then I will<br />
think about how to completely clean up the current<br />
md5sum comparison mess.</p>
<p>I think correct md5sum comparison is crucial for users<br />
because users should be able to rely on our<br />
md5sum comparison to behave consistently.</p>
<p>Issues like<br />
<a href="https://github.com/rear/rear/issues/2785">https://github.com/rear/rear/issues/2785</a><br />
is really bad user experience because it shows we do not<br />
"Try hard to care about possible errors" in this specific area,<br />
cf.
<a href="https://github.com/rear/rear/wiki/Coding-Style">https://github.com/rear/rear/wiki/Coding-Style</a></p>
<p>ReaR can detect when restored basic system files<br />
do not match the recreated system.<br />
It only needs to do it correctly.</p>
<p>I think with
<a href="https://github.com/rear/rear/pull/2795">https://github.com/rear/rear/pull/2795</a><br />
all needed code will be basically there.<br />
It only needs to be run in a more consistent way.</p>
<p>FYI<br />
what workflows run 'layout/save' (in current master code):<br />
The workflows are from what "rear -v help" shows<br />
('-v' is needed to let it show really all workflows).</p>
<pre><code># workflows="checklayout dump finalizeonly format layoutonly mkbackup mkbackuponly mkopalpba mkrescue mountonly opaladmin recover restoreonly savelayout shell udev validate"

# for w in $workflows ; do usr/sbin/rear -s $w | grep -q 'layout/save/' &amp;&amp; echo $w ; done
checklayout
mkbackup
mkbackuponly
mkrescue
savelayout
</code></pre>
<h4 id="pcahyna_commented_at_2022-05-05_0911"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/2796#issuecomment-1118336914">2022-05-05 09:11</a>:<a class="headerlink" href="#pcahyna_commented_at_2022-05-05_0911" title="Permanent link">&para;</a></h4>
<blockquote>
<p>My basic idea is to fully re-evaluate during "rear recover"<br />
CHECK_CONFIG_FILES and FILES_TO_PATCH_PATTERNS<br />
and regenerate md5sums and then compare the md5sum results.</p>
</blockquote>
<p>That's one way to do it for sure, but I am afraid that doing a full
re-evaluation will be difficult. So my proposal is to short-circuit it
by saving the full <code>CHECK_CONFIG_FILES</code> list (except the addition
resulting from FILES_TO_PATCH_PATTERNS, but including files that did
not exist at the time) into layout and then use it during finalize. But
for this, the list must be static (no wildcard expansions, since they
can result into less than what will be there during finalize).</p>
<h4 id="pcahyna_commented_at_2022-05-05_0913"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/2796#issuecomment-1118339035">2022-05-05 09:13</a>:<a class="headerlink" href="#pcahyna_commented_at_2022-05-05_0913" title="Permanent link">&para;</a></h4>
<blockquote>
<p>but I am afraid that doing a full re-evaluation will be difficult.</p>
</blockquote>
<p>.. because that essentially means running the whole <code>layout/save</code> stage
before <code>finalize</code>, in the mounted restored system, and I suspect there
will be problems with that.</p>
<h4 id="jsmeix_commented_at_2022-05-05_0930"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2796#issuecomment-1118353507">2022-05-05 09:30</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-05-05_0930" title="Permanent link">&para;</a></h4>
<p>I won't run the whole layout/save stage before finalize.</p>
<p>I will try to solve the problem with<br />
CHECK_CONFIG_FILES+=( ... ) in some 'layout/save' scripts<br />
differently.</p>
<p>My immediate idea is to have all CHECK_CONFIG_FILES+=( ... )<br />
that exists in scripts directly in default.conf because it does not
matter<br />
to specify more in CHECK_CONFIG_FILES than what actually exists<br />
in particular not when bash globbing patterns are used to ignore<br />
nonexistent things via 'shopt -s nullglob'.</p>
<p>This does not affect the user who can specify mandatory things<br />
for his specific CHECK_CONFIG_FILES in local.conf<br />
without bash globbing patterns.</p>
<p>I do not understand what is wrong with bash globbing patterns in<br />
CHECK_CONFIG_FILES because files that do not exists<br />
cannot be used for md5sum so files that do not exists<br />
should be skipped in any case from the md5sum call to avoid<br />
<code>md5sum: ...: No such file or directory</code> stderr messages.</p>
<p>I wonder what the difference is between skipping nonexistsnt files<br />
implicitly via globbing patterns with 'shopt -s nullglob'<br />
versus skipping them by some explicit test in the code.</p>
<p>I think the difference is that skipping via globbing happens silently<br />
while skipping by explicit test in the code could show messages<br />
to the user when something that is specified is not there.</p>
<h4 id="pcahyna_commented_at_2022-05-05_0941"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/2796#issuecomment-1118362478">2022-05-05 09:41</a>:<a class="headerlink" href="#pcahyna_commented_at_2022-05-05_0941" title="Permanent link">&para;</a></h4>
<blockquote>
<p>I wonder what the difference is between skipping nonexistsnt files<br />
implicitly via globbing patterns with 'shopt -s nullglob'<br />
versus skipping them by some explicit test in the code.</p>
</blockquote>
<p>This depends on the intended way of solving this mess.<br />
The solution that I had in mind was this pseudocode:</p>
<ol>
<li>assemble <code>CHECK_CONFIG_FILES</code> during <code>layout/save</code></li>
<li>save it somewhere under layout</li>
<li>calculate md5sums</li>
<li>in <code>finalize</code> load <code>CHECK_CONFIG_FILES</code> saved in 2.</li>
<li>calculate md5sums</li>
<li>compare md5sums calculated in 3. and 5.</li>
</ol>
<p>In this scheme, it matters a lot whether you skip nonexistent files
during step 1. (presumably using glob patterns and nullglob) vs. in step
3. immediately before calculating hashes (presumably using an explicit
test), because it affects what gets saved in step 2.</p>
<p>If you choose another approach, then it does not matter. Your approach
"to have all <code>CHECK_CONFIG_FILES+=( ... )</code> that exists in scripts
directly in default.conf" will be correct, I am just afraid it might be
a bit restrictive (there are conditionals in
<code>layout/save/default/4*_check_*.sh</code>).</p>
<h4 id="jsmeix_commented_at_2022-05-05_0956"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2796#issuecomment-1118374363">2022-05-05 09:56</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-05-05_0956" title="Permanent link">&para;</a></h4>
<p>Please just merge
<a href="https://github.com/rear/rear/pull/2795">https://github.com/rear/rear/pull/2795</a><br />
so we have a good starting point for further development<br />
(which can be also tested by users how far that works for them)<br />
then let's see how far I can get from there.</p>
<h4 id="jsmeix_commented_at_2022-05-05_1012"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2796#issuecomment-1118387393">2022-05-05 10:12</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-05-05_1012" title="Permanent link">&para;</a></h4>
<p>As far as I see on first glance the conditionals in<br />
layout/save/default/450_check_bootloader_files.sh and<br />
layout/save/default/450_check_network_files.sh<br />
are not really mutually exclusive so having all of them<br />
in CHECK_CONFIG_FILES via globbing patterns<br />
should "just ignore" what was done before with conditionals.</p>
<p>By the way:<br />
Globbing patterns do help when used well:<br />
Currently at SUSE we have /boot/grub2/grub.cfg<br />
(at least on my openSUSE Leap 15.3 system)<br />
but nothing in 450_check_bootloader_files.sh matches<br />
while <code>/[b]oot/*/grub*.cfg</code> would have matched.</p>
<p>So only the conditionals in<br />
layout/save/default/400_check_backup_special_files.sh<br />
are left.<br />
Offhandedly one may think even such special things could be<br />
"simply added with appropriate globbing patters".<br />
But when someone has TSM and/or FDR/Upstream installed<br />
but does not use BACKUP=TSM or BACKUP=FDRUPSTREAM<br />
for ReaR, then he would get things for TSM and/or FDR/Upstream<br />
in CHECK_CONFIG_FILES that is not wanted to be checked<br />
when actually another backup method is used for ReaR.<br />
I guess I can move 400_check_backup_special_files.sh<br />
to a stage that is run in any case - e.g. the <code>init</code> stage<br />
that is run in any case directly by usr/sbin/rear<br />
via <code>SourceStage "init"</code><br />
because the <code>init</code> stage looks right to do such special<br />
config variable adjustments.</p>
<h4 id="pcahyna_commented_at_2022-05-05_1019"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/2796#issuecomment-1118392659">2022-05-05 10:19</a>:<a class="headerlink" href="#pcahyna_commented_at_2022-05-05_1019" title="Permanent link">&para;</a></h4>
<p>I think that moving the conditionals that are really needed to <code>init</code>
would work, yes. Preferably they should not depend on the content of the
system, but only on other configuration variables (like <code>BACKUP</code>).</p>
<h4 id="jsmeix_commented_at_2022-05-05_1046"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2796#issuecomment-1118412169">2022-05-05 10:46</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-05-05_1046" title="Permanent link">&para;</a></h4>
<p>With
<a href="https://github.com/rear/rear/pull/2795">https://github.com/rear/rear/pull/2795</a>
merged<br />
this pull request is outdated or obsoleted so I close it.</p>
<p>I keep the branch of this pull request for now as reference<br />
<a href="https://github.com/rear/rear/tree/jsmeix-overhauled-510_compare_files">https://github.com/rear/rear/tree/jsmeix-overhauled-510_compare_files</a></p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2025 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2022-05-03.2796.pr.closed.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/rear/rear-user-guide" class="fa fa-code-fork" style="color: #fcfcfc"> rear/rear-user-guide</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
