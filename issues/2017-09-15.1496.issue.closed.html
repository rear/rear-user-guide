<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#1496 Issue closed: Error during layout recreation with btrfs and docker - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#1496 Issue closed: Error during layout recreation with btrfs and docker";
        var mkdocs_page_input_path = "issues/2017-09-15.1496.issue.closed.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a> &raquo;</li>
      <li class="breadcrumb-item active">#1496 Issue closed: Error during layout recreation with btrfs and docker</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="1496_issue_closed_error_during_layout_recreation_with_btrfs_and_docker"><a href="https://github.com/rear/rear/issues/1496">#1496 Issue</a> <code>closed</code>: Error during layout recreation with btrfs and docker<a class="headerlink" href="#1496_issue_closed_error_during_layout_recreation_with_btrfs_and_docker" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>enhancement</code>, <code>fixed / solved / done</code></p>
<h4 id="olivero2_opened_issue_at_2017-09-15_1208"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> opened issue at <a href="https://github.com/rear/rear/issues/1496">2017-09-15 12:08</a>:<a class="headerlink" href="#olivero2_opened_issue_at_2017-09-15_1208" title="Permanent link">&para;</a></h4>
<h4 id="basis">Basis<a class="headerlink" href="#basis" title="Permanent link">&para;</a></h4>
<ul>
<li>rear version (/usr/sbin/rear -V): Relax-and-Recover 2.2 / Git</li>
<li>OS version (cat /etc/rear/os.conf or lsb_release -a): Ubuntu
    16.04.3 LTS</li>
<li>rear configuration files (cat /etc/rear/site.conf or cat
    /etc/rear/local.conf): see below</li>
</ul>
<h4 id="problem">Problem<a class="headerlink" href="#problem" title="Permanent link">&para;</a></h4>
<p>Using <code>rear mkrescue</code> on a system with <strong>docker</strong> running on a <strong>btrfs</strong>
file system makes a subsequent <code>rear recover</code> stop with the following
error messages:</p>
<pre><code>Mounting filesystem /
[  169.768852] BTRFS error (device sda2): '@/var/lib/docker/btrfs' is not a valid subvolume
An error occurred during layout recreation.
</code></pre>
<h4 id="workaround">Workaround<a class="headerlink" href="#workaround" title="Permanent link">&para;</a></h4>
<p>Use <code>systemctl stop docker.service</code> before running <code>rear mkrescue</code>.</p>
<h4 id="probable_root_cause">Probable root cause<a class="headerlink" href="#probable_root_cause" title="Permanent link">&para;</a></h4>
<p>Docker somehow manages to put a seemingly impossible entry in the
kernel's notion of mounted file systems (<code>proc/self/mounts</code>):</p>
<pre><code># mount | grep docker
/dev/sda2 on /var/lib/docker/btrfs type btrfs (rw,noatime,nodiratime,ssd,space_cache,subvolid=257,subvol=/@/var/lib/docker/btrfs)
</code></pre>
<p>The option <code>subvol=/@/var/lib/docker/btrfs</code> breaks it. Btrfs subvolumes
can be mounted by <code>subvolid=</code> or subvolume path (<code>subvol=</code>). In this
example, <code>subvolid</code> 257 is the root subvolume and there is no such
subvolume with a path of <code>@/var/lib/docker/btrfs</code> or
<code>/@/var/lib/docker/btrfs</code>. Trying to mount such a beast manually fails:</p>
<pre><code># mount -t btrfs -o rw,noatime,nodiratime,ssd,space_cache,subvolid=257,subvol=/@/var/lib/docker/btrfs /dev/sda2 M
BTRFS error (device sda2): '/@/var/lib/docker/btrfs' is not a valid subvolume
# mount -t btrfs -o rw,noatime,nodiratime,ssd,space_cache,subvolid=257,subvol=@/var/lib/docker/btrfs /dev/sda2 M
BTRFS error (device sda2): '@/var/lib/docker/btrfs' is not a valid subvolume
</code></pre>
<p>This is the current list of relevant btrfs subvolumes (excluding volume
snapshots named <code>.@*</code>):</p>
<pre><code># btrfs subvolume list -a / | grep -v '&lt;FS_TREE&gt;/.@'
ID 257 gen 105922 top level 5 path &lt;FS_TREE&gt;/@
ID 258 gen 105922 top level 5 path &lt;FS_TREE&gt;/@home
ID 5125 gen 27216 top level 257 path @/var/lib/docker/btrfs/subvolumes/8bfcbb9c775e910d504ac7d0f091e9668d700fffcc4c10e71118330ddad47b80
ID 5126 gen 27217 top level 257 path @/var/lib/docker/btrfs/subvolumes/4209efbc4922061100d9922741e2b5135d396a1586d1111f72d1beb9ea1cc513
ID 5127 gen 27218 top level 257 path @/var/lib/docker/btrfs/subvolumes/e44faf88d5e4a25366e7e0eb2882f40b1c0d2b5fef1142f06b0dad3cd4e1ee4f
ID 5128 gen 27219 top level 257 path @/var/lib/docker/btrfs/subvolumes/268b6c560568411d38215d3d87c08ddc0fb373bb02b4d1a114c589c790a69101
ID 5129 gen 28716 top level 257 path @/var/lib/docker/btrfs/subvolumes/4c48e4299061b98be208013f5be89f05107f075fea4c4e659f117fa55225971b
ID 5134 gen 80934 top level 257 path @/var/lib/docker/btrfs/subvolumes/e18c9690831dd193f37d5dadf0e0ff0f9cac75e6bba09e5b471b7a16538e639b
ID 5137 gen 80934 top level 257 path @/var/lib/docker/btrfs/subvolumes/813f7476ee473d6a1e64b4e08877b0fd76ce0e6a472dfea8ca4f44711e545946
ID 5149 gen 80934 top level 257 path @/var/lib/docker/btrfs/subvolumes/1f45e82870cc392d533d0976f2e1a732b8fab8b85f322ae77533c8cfd676dbff
ID 5311 gen 80934 top level 257 path @/var/lib/docker/btrfs/subvolumes/86c787fc596f7f11931fdc6403ad713014d36b958464012d73b8940460cd2664-init
ID 5312 gen 80934 top level 257 path @/var/lib/docker/btrfs/subvolumes/86c787fc596f7f11931fdc6403ad713014d36b958464012d73b8940460cd2664
</code></pre>
<h4 id="what_to_do">What to do<a class="headerlink" href="#what_to_do" title="Permanent link">&para;</a></h4>
<p>I have no idea why the docker folks did this, but since this stuff is
out in the wild, I'd like to convince ReaR to just ignore anything that
looks like a docker-generated subvolume (snapshot or not). AFAIK, these
btrfs docker-trees cannot be safely restored anyway in a consistent
fashion.</p>
<p>I've tried to use
<code>EXCLUDE_RECREATE=("${EXCLUDE_RECREATE[@]}" "fs:@/var/lib/docker/btrfs")</code>
but apparently this doesn't match. Is there any overview documentation
on how the exclusion mechanism actually works. Any hints where I should
look?</p>
<h4 id="jsmeix_commented_at_2017-09-15_1259"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1496#issuecomment-329775673">2017-09-15 12:59</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-09-15_1259" title="Permanent link">&para;</a></h4>
<p>@OliverO2<br />
Oh dear!</p>
<p>It seems you have to fight with btrfs subvolume stuff in Ubuntu.<br />
I had fights with the btrfs subvolume structure in SUSE.<br />
If you can - run away from btrfs subvolumes ;-)<br />
If you find nested btrfs subvolumes, run even more away!</p>
<p>First and foremost:<br />
I know nothing about the btrfs subvolume structure in Ubuntu.<br />
ReaR may need adaptions and enhancements to make<br />
it also work with the btrfs subvolume structure in Ubuntu.<br />
Currently ReaR seems to work with btrfs for SUSE and Red Hat.</p>
<p>In general when you have to deal with btrfs subvolumes:</p>
<p>(1)<br />
You basically must use the findmnt command<br />
to know what is really mounted where, e.g. for btrfs use</p>
<pre>
# findmnt -t btrfs
</pre>

<p>All other comands may only lead you into more<br />
and more confusion because they may more or less<br />
hide what is really mounted where.</p>
<p>(2)<br />
You basically must mount the whole btrfs filesystem<br />
(which means to mount btrfs root subvolume)<br />
at a mount point as you like e.g. via</p>
<pre>
mkdir /tmp/btrfs-root
mount -t btrfs -o subvolid=0 /dev/sdXn /tmp/btrfs-root
</pre>

<p>and then go to that mount point directory and<br />
inspect the whole btrfs filesystem.</p>
<p>(3)<br />
When not the btrfs root subvolume but a btrfs subvolume<br />
is mounted at the '/' mountpoint then you do not see<br />
the whole btrfs filesystem below '/' but only what is<br />
below the there mounted btrfs subvolume.<br />
Use (1) and (2) to get a better overview what there really is.</p>
<p>(4)<br />
When not the btrfs root subvolume but a btrfs subvolume<br />
is mounted at the '/' mountpoint then creating<br />
more subvolumes just with a command like</p>
<pre>
# btrfs subvolume create /path/to/mysubvol
</pre>

<p>creates that new subvolume below the btrfs subvolume<br />
that is mounted at the '/' mountpoint and usually this is<br />
not what is intended.<br />
Usually what is intended is to create a new subvolume<br />
at a path below the root of the whole btrfs filesystem.<br />
To create a new subvolume at a path below the root<br />
of the whole btrfs filesystem you need to first mount<br />
the btrfs root subvolume as described in item (2)<br />
and then create the new subvolume via the mountpoint<br />
directory where the root of the whole btrfs filesystem is.<br />
But such a new subvolume will not be visible/accessible<br />
when not the btrfs root subvolume but a btrfs subvolume<br />
is mounted at the '/' mountpoint.<br />
To make such a new subvolume visible and accessible<br />
it must be mounted at a mountpoint directory that is<br />
inside the btrfs subvolume that is mounted at the '/' mountpoint.<br />
Usually a /etc/fstab entry is created to mount such a<br />
new subvolume automatically during boot at a<br />
mountpoint directory that is inside the btrfs subvolume<br />
that is mounted at the '/' mountpoint.<br />
For details how this works under SUSE see<br />
<a href="https://lists.opensuse.org/opensuse-factory/2016-10/msg00397.html">https://lists.opensuse.org/opensuse-factory/2016-10/msg00397.html</a></p>
<p>Accordingly for this issue I guess:<br />
When in Ubuntu not the btrfs root subvolume but<br />
a btrfs subvolume is mounted at the '/' mountpoint<br />
then the docker folks may have created their new subvolume<br />
in a wrong way (i.e. as a second-level sub-subvolume below<br />
the btrfs subvolume that is mounted at the '/' mountpoint)<br />
and during "rear recover" such second-level sub-subvolumes<br />
cause issues, cf.<br />
<a href="https://github.com/rear/rear/issues/944">https://github.com/rear/rear/issues/944</a><br />
therein see in particular<br />
<a href="https://github.com/rear/rear/issues/944#issuecomment-238239926">https://github.com/rear/rear/issues/944#issuecomment-238239926</a><br />
and you may also follow the other links therein.</p>
<p>Have fun with nested btrfs subvolumes!<br />
;-)</p>
<h4 id="olivero2_commented_at_2017-09-15_1557"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/issues/1496#issuecomment-329824117">2017-09-15 15:57</a>:<a class="headerlink" href="#olivero2_commented_at_2017-09-15_1557" title="Permanent link">&para;</a></h4>
<p>@jsmeix<br />
Thanks for the extensive explanation.</p>
<blockquote>
<p>If you can - run away from btrfs subvolumes ;-)</p>
</blockquote>
<p>Not at all! We've been using Btrfs for more than three years and it has
shown to be a perfect fit over here. We snapshot each volume every 5
minutes for system-wide short-term backup (with a snapshot cleanup
schedule, of course). Our unattended backup solution creates backups
from snapshots, enabling consistent anytime backups without interrupting
work or shutting down services. And, once a week, recent backups are
compared to their snapshots to ensure that the whole backup system
actually does what it is meant to do.</p>
<blockquote>
<p>(1)<br />
You basically must use the findmnt command</p>
</blockquote>
<p>Thanks for pointing me to <code>findmnt</code>. Output over here is:</p>
<pre><code># findmnt -t btrfs
TARGET                  SOURCE                             FSTYPE OPTIONS
/                       /dev/sda2[/@]                      btrfs  rw,noatime,nodiratime,ssd,space_cache,subvolid=257,subvol=/@
├─/volumes/01           /dev/sda2                          btrfs  rw,noatime,nodiratime,ssd,space_cache,subvolid=5,subvol=/
├─/home                 /dev/sda2[/@home]                  btrfs  rw,noatime,nodiratime,ssd,space_cache,subvolid=258,subvol=/@home
├─/volumes/02           /dev/mapper/Foxtrot-02             btrfs  rw,noatime,nodiratime,ssd,space_cache,subvolid=5,subvol=/
├─/mnt/reserve          /dev/mapper/Foxtrot-02[/@]         btrfs  rw,noatime,nodiratime,ssd,space_cache,subvolid=257,subvol=/@
└─/var/lib/docker/btrfs /dev/sda2[/@/var/lib/docker/btrfs] btrfs  rw,noatime,nodiratime,ssd,space_cache,subvolid=257,subvol=/@/var/lib/docker/btrfs
</code></pre>
<p>Note that Btrfs automatically translates subvolid=0 to subvolid=5, its
internal hardwired root id.</p>
<blockquote>
<p>(2)<br />
You basically must mount the whole btrfs filesystem</p>
</blockquote>
<p>I do. Our volume organization is as follows:</p>
<ul>
<li>For each disk partition the root subvolume (subvolid=0) is mounted
    on /volumes/<disk-number> (e.g. <code>/volumes/01</code>).</li>
<li>On these root subvolumes, the primary system subvolumes (@, @home)
    are created, like (e.g. <code>/volumes/01/@</code>, <code>/volumes/01/@home</code>) and
    mounted in the usual locations (<code>/</code>, <code>/home</code>).</li>
<li>Snapshots are created from primary system subvolumes on the root
    subvolume, like <code>/volumes/01/.@-2017-09-15T16:20:01+02:00</code> and
    <code>/volumes/01/.@home-2017-09-15T16:20:01+02:00</code></li>
</ul>
<p>So far, this is all as intended. The root subvolume (subvolid=0) is used
for subvolume management only. The '/' mountpoint uses a subvolume named
<code>@</code>.</p>
<blockquote>
<p>and inspect the whole btrfs filesystem.</p>
</blockquote>
<pre><code># btrfs subvol list -a /volumes/01 | grep -v ' \.@'
ID 257 gen 106407 top level 5 path @
ID 258 gen 106407 top level 5 path @home
ID 5125 gen 27216 top level 257 path &lt;FS_TREE&gt;/@/var/lib/docker/btrfs/subvolumes/8bfcbb9c775e910d504ac7d0f091e9668d700fffcc4c10e71118330ddad47b80
ID 5126 gen 27217 top level 257 path &lt;FS_TREE&gt;/@/var/lib/docker/btrfs/subvolumes/4209efbc4922061100d9922741e2b5135d396a1586d1111f72d1beb9ea1cc513
ID 5127 gen 27218 top level 257 path &lt;FS_TREE&gt;/@/var/lib/docker/btrfs/subvolumes/e44faf88d5e4a25366e7e0eb2882f40b1c0d2b5fef1142f06b0dad3cd4e1ee4f
ID 5128 gen 27219 top level 257 path &lt;FS_TREE&gt;/@/var/lib/docker/btrfs/subvolumes/268b6c560568411d38215d3d87c08ddc0fb373bb02b4d1a114c589c790a69101
ID 5129 gen 28716 top level 257 path &lt;FS_TREE&gt;/@/var/lib/docker/btrfs/subvolumes/4c48e4299061b98be208013f5be89f05107f075fea4c4e659f117fa55225971b
ID 5134 gen 80934 top level 257 path &lt;FS_TREE&gt;/@/var/lib/docker/btrfs/subvolumes/e18c9690831dd193f37d5dadf0e0ff0f9cac75e6bba09e5b471b7a16538e639b
ID 5137 gen 80934 top level 257 path &lt;FS_TREE&gt;/@/var/lib/docker/btrfs/subvolumes/813f7476ee473d6a1e64b4e08877b0fd76ce0e6a472dfea8ca4f44711e545946
ID 5149 gen 80934 top level 257 path &lt;FS_TREE&gt;/@/var/lib/docker/btrfs/subvolumes/1f45e82870cc392d533d0976f2e1a732b8fab8b85f322ae77533c8cfd676dbff
ID 5311 gen 80934 top level 257 path &lt;FS_TREE&gt;/@/var/lib/docker/btrfs/subvolumes/86c787fc596f7f11931fdc6403ad713014d36b958464012d73b8940460cd2664-init
ID 5312 gen 80934 top level 257 path &lt;FS_TREE&gt;/@/var/lib/docker/btrfs/subvolumes/86c787fc596f7f11931fdc6403ad713014d36b958464012d73b8940460cd2664
</code></pre>
<blockquote>
<p>(3)<br />
When not the btrfs root subvolume but a btrfs subvolume<br />
is mounted at the '/' mountpoint then you do not see<br />
the whole btrfs filesystem below '/'</p>
</blockquote>
<p>True when looking at the directory tree, but the output of
<code>btrfs subvol list</code> is identical regardless of the path provided, as
long as that path is somewhere within the same Btrfs file system. (Even
if I use <code>btrfs subvol list -a /var/lib/docker/btrfs | grep -v '\.@'</code>
the output is the same.)</p>
<p>The strange thing is: Nowhere does a subvolume named
<code>/@/var/lib/docker/btrfs</code> or <code>@/var/lib/docker/btrfs</code> show up, so it
seems that Btrfs knows nothing about it.</p>
<blockquote>
<p>(4)<br />
When not the btrfs root subvolume but a btrfs subvolume<br />
is mounted at the '/' mountpoint then creating<br />
more subvolumes [...]<br />
creates that new subvolume below the btrfs subvolume<br />
that is mounted at the '/' mountpoint and usually this is<br />
not what is intended.</p>
</blockquote>
<p>In general, I don't see a problem with nested subvolumes as long as</p>
<ul>
<li>one has a reasonable mounting strategy and</li>
<li>keeps in mind that snapshots do not cross subvolume boundaries.</li>
</ul>
<p>This may be exactly what's intended.</p>
<p>So yes, docker creates subvolumes below the <code>@</code> subvolume, which in turn
is a subvolume of the root subvolume. Docker also creates subvolumes and
snapshots even further down the hierarchy (see <a href="https://docs.docker.com/engine/userguide/storagedriver/btrfs-driver/#how-the-btrfs-storage-driver-works">How the btrfs storage
driver
works</a>).</p>
<p>In my eyes there is nothing wrong with this except for that 'bogus'
volume name <code>/@/var/lib/docker/btrfs</code> unknown to Btrfs itself.</p>
<h4 id="conclusion_so_far">Conclusion so far<a class="headerlink" href="#conclusion_so_far" title="Permanent link">&para;</a></h4>
<p>I think ReaR should find a way to deal with it, which includes</p>
<ul>
<li>accepting subvolumes of subvolumes as normal Btrfs use,</li>
<li>automatically filtering out 'bogus' Btrfs volumes, which are
    impossible for ReaR to recreate, and</li>
<li>offering a configuration option to filter out Btrfs volumes on
    request.</li>
</ul>
<p>I would still be grateful if someone could point me to information on
how to make <code>EXCLUDE_RECREATE</code> cover Btrfs volumes.</p>
<h4 id="jsmeix_commented_at_2017-09-18_0735"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1496#issuecomment-330147358">2017-09-18 07:35</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-09-18_0735" title="Permanent link">&para;</a></h4>
<p>@OliverO2<br />
curently there is no support for EXCLUDE_RECREATE<br />
for any of the btrfs* components in ReaR.</p>
<h4 id="jsmeix_commented_at_2017-09-18_0745"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1496#issuecomment-330148933">2017-09-18 07:45</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-09-18_0745" title="Permanent link">&para;</a></h4>
<p>@OliverO2<br />
only a side note related to what you wrote:</p>
<pre>
We snapshot each volume every 5 minutes
for system-wide short-term backup ...
Our unattended backup solution creates
backups from snapshots, enabling
consistent anytime backups without
interrupting work or shutting down services.
</pre>

<p>I argue that such backups are not consistent,<br />
depending on what kind of consistency one<br />
expects to get from a backup of files:<br />
Reason:<br />
See the section<br />
"Generic files backup with the plain SUSE installation system" at<br />
<a href="https://en.opensuse.org/SDB:Disaster_Recovery">https://en.opensuse.org/SDB:Disaster_Recovery</a><br />
that reads (excerpts):</p>
<pre>
Consistent backup means that all files
in the backup are consistent on the
application level. For example assume
there is an application program running
that changes several files simultaneously.
When that program is running during files backup,
the backup may contain old data in some files
and new data in other files which could be
an inconsistent state that leads to errors
in that application after such an
inconsistent backup was restored. 
</pre>

<h4 id="olivero2_commented_at_2017-09-18_1124"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/issues/1496#issuecomment-330192016">2017-09-18 11:24</a>:<a class="headerlink" href="#olivero2_commented_at_2017-09-18_1124" title="Permanent link">&para;</a></h4>
<p>@jsmeix</p>
<blockquote>
<p>I argue that such backups are not consistent,</p>
</blockquote>
<p>What you get is intra-file-system consistency: Since btrfs snapshots are
atomic operations, snapshots offer the same consistency level you would
get from modern file systems after a power failure. When you backup from
such snapshots, you won't have problems with any application programmed
to survive a power failure (which you should expect from any reasonable
application) For example, file based DBMS generally change multiple
files in a safe sequence (possibly with added journaling) so that any
inconsistencies from a sudden outage can and will be rectified during
the next startup.</p>
<p>Of course, if you have unsafe applications, you have a problem. But then
you'd have a problem anyway since such an application wouldn't survive
its own crash due to internal (bug) or external circumstances (resource
exhaustion).</p>
<h4 id="jsmeix_commented_at_2017-09-19_0822"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1496#issuecomment-330466295">2017-09-19 08:22</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-09-19_0822" title="Permanent link">&para;</a></h4>
<p>With
<a href="https://github.com/rear/rear/pull/1499">https://github.com/rear/rear/pull/1499</a><br />
and
<a href="https://github.com/rear/rear/pull/1497">https://github.com/rear/rear/pull/1497</a><br />
this issue should be fixed.</p>
<p>@OliverO2<br />
many thanks for your valuable contributions to ReaR!</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2023 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2017-09-15.1496.issue.closed.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
