<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#1450 PR merged: Allow full migration of /dev/disk/by-id/devices - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#1450 PR merged: Allow full migration of /dev/disk/by-id/devices";
        var mkdocs_page_input_path = "issues/2017-08-21.1450.pr.merged.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/backup_netfs.html">Example of BACKUP=NETFS</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear29.html">Release Notes ReaR 2.9</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear28.html">Release Notes ReaR 2.8</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#1450 PR merged: Allow full migration of /dev/disk/by-id/devices</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="1450_pr_merged_allow_full_migration_of_devdiskby-iddevices"><a href="https://github.com/rear/rear/pull/1450">#1450 PR</a> <code>merged</code>: Allow full migration of /dev/disk/by-id/devices<a class="headerlink" href="#1450_pr_merged_allow_full_migration_of_devdiskby-iddevices" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>enhancement</code>, <code>fixed / solved / done</code>, <code>minor bug</code></p>
<h4 id="schabrolles_opened_issue_at_2017-08-21_1138"><img src="https://avatars.githubusercontent.com/u/19491077?u=0021b16ab426902cbe676f6831f41607bbe4d441&v=4" width="50"><a href="https://github.com/schabrolles">schabrolles</a> opened issue at <a href="https://github.com/rear/rear/pull/1450">2017-08-21 11:38</a>:<a class="headerlink" href="#schabrolles_opened_issue_at_2017-08-21_1138" title="Permanent link">&para;</a></h4>
<p>Currently, <code>/dev/disk/by-id/</code> devices are not "always" migrated.</p>
<ul>
<li>It should be taken by <code>finalize/GNU/Linux/260_rename_diskbyid.sh</code>
    script; but in its actual form, this script only migrate NEW by-id
    name if the real device (/dev/name) has the same name between source
    and target system.</li>
</ul>
<p>example: (<code>diskbyid_mappings</code> file)</p>
<pre><code>virtio-a1bd20bf-f66d-442c-8 vda
virtio-a1bd20bf-f66d-442c-8-part1 vda1
virtio-a1bd20bf-f66d-442c-8-part2 vda2
</code></pre>
<p>=&gt; <code>/dev/disk/by-id/virtio-a1bd20bf-f66d-442c-8</code> will be renamed only
if <code>/dev/vda</code> is present on the target system.</p>
<ul>
<li>Some files like
    <code>/etc/lilo.conf /etc/yaboot.conf /etc/default/grub_installdevice</code>
    are not part of the list of file to be migrated by
    <code>finalize/GNU/Linux/260_rename_diskbyid.sh</code><br />
<code>/etc/default/grub_installdevice</code> is used in SuSe Linux and use
    <code>/dev/disk/by-id/</code> devices to point to the bootloader partition. If
    we forget to migrate this file, <code>yast bootloader</code> will fail.</li>
</ul>
<hr />
<p><strong>Proposal:</strong></p>
<p>1- Add <code>/etc/lilo.conf /etc/yaboot.conf /etc/default/grub_installdevice</code>
to <code>FILES</code> variable in <code>finalize/GNU/Linux/260_rename_diskbyid.sh</code></p>
<p>2- Use <code>$SHARE_DIR/layout/prepare/default/320_apply_mappings.sh</code> to
apply device mapping on <code>diskbyid_mappings</code> file to migrate
<code>/dev/old_device</code> to <code>/dev/new_device</code> in case of recover on a different
system.</p>
<p>Add this section at the beginning of
<code>finalize/GNU/Linux/260_rename_diskbyid.sh</code></p>
<pre><code># Apply device mapping to replace device in case of migration.
tmp_layout="$LAYOUT_FILE"
LAYOUT_FILE="$OLD_ID_FILE"
source $SHARE_DIR/layout/prepare/default/320_apply_mappings.sh
LAYOUT_FILE="$tmp_layout"
</code></pre>
<p>But, in order to migrate <code>real device</code> from <code>diskbyid_mappings</code> file
(second column), with <code>320_apply_mappings.sh</code>, those one should be in
absolute PATH.</p>
<pre><code>virtio-a1bd20bf-f66d-442c-8 /dev/vda
virtio-a1bd20bf-f66d-442c-8-part1 /dev/vda1
virtio-a1bd20bf-f66d-442c-8-part2 /dev/vda2
</code></pre>
<hr />
<p>Tested with sles11 and sles12 on POWER</p>
<p>example of output with sles12 (/etc/default/grub_installdevice)</p>
<pre><code>[...]
Restore the Mountpoints (with permissions) from /var/lib/rear/recovery/mountpoint_permissions
Patching /etc/default/grub_installdevice: Replacing [/dev/disk/by-id/virtio-3af70bf3-fa3b-40b8-9-part1] by [/dev/disk/by-id/dm-name-mpatha-part1]
[...]
</code></pre>
<h4 id="schlomo_commented_at_2017-08-22_1222"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/1450#issuecomment-324009421">2017-08-22 12:22</a>:<a class="headerlink" href="#schlomo_commented_at_2017-08-22_1222" title="Permanent link">&para;</a></h4>
<p>@schabrolles I would put all these functions into <code>layout-functions.sh</code>
because they are used in that stage.</p>
<h4 id="schabrolles_commented_at_2017-08-23_1113"><img src="https://avatars.githubusercontent.com/u/19491077?u=0021b16ab426902cbe676f6831f41607bbe4d441&v=4" width="50"><a href="https://github.com/schabrolles">schabrolles</a> commented at <a href="https://github.com/rear/rear/pull/1450#issuecomment-324297865">2017-08-23 11:13</a>:<a class="headerlink" href="#schabrolles_commented_at_2017-08-23_1113" title="Permanent link">&para;</a></h4>
<p>@schlomo for your review.<br />
I have put all functions in <code>layout-function.sh</code> as per your request.<br />
Currently, I did not update any other additional script to point to
those functions. I think it is better to do it in a separate pull
request for better control and limit side effect.</p>
<p>Tested during a disk migration on :</p>
<ul>
<li>sles11 sp4</li>
<li>sles12 sp2</li>
<li>rhel7.3</li>
<li>ubuntu 16.04</li>
</ul>
<h4 id="schlomo_commented_at_2017-08-23_1523"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/1450#issuecomment-324370988">2017-08-23 15:23</a>:<a class="headerlink" href="#schlomo_commented_at_2017-08-23_1523" title="Permanent link">&para;</a></h4>
<p>In general, please try to use positive logic as much as possible. It
helps a lot to read code and understand the logic.</p>
<p>Good:</p>
<ul>
<li>check foo AND do something</li>
<li>check foo OR die with error (this is the classical assertion)</li>
</ul>
<p>Bad:</p>
<ul>
<li>check not foo or do something</li>
<li>check not foo and die with error</li>
</ul>
<p>The negated check makes one stop and think what does it actually mean.</p>
<h4 id="jsmeix_commented_at_2017-08-23_1531"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1450#issuecomment-324373208">2017-08-23 15:31</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-08-23_1531" title="Permanent link">&para;</a></h4>
<p>FYI:<br />
In general I would avoid the *IfError functions<br />
because they cannot work reliably in all cases<br />
because they test $? but $? can be an unexpected value<br />
(totally in compliance how bash works but unexpected)<br />
in a bit more complicated cases, cf.<br />
<a href="https://github.com/rear/rear/issues/1415#issuecomment-315692391">https://github.com/rear/rear/issues/1415#issuecomment-315692391</a><br />
where</p>
<pre>
StopIfError "USB device '$USB_DEVICE' is already mounted on $(grep -E "^$REAL_USB_DEVICE\\s" /proc/mounts | cut -d' ' -f2 |tail -1)"
</pre>

<p>did never error out as intended because the pipe after 'grep' always<br />
returns $? with zero value because 'tail -1' results zero return code.</p>
<h4 id="schabrolles_commented_at_2017-08-23_2242"><img src="https://avatars.githubusercontent.com/u/19491077?u=0021b16ab426902cbe676f6831f41607bbe4d441&v=4" width="50"><a href="https://github.com/schabrolles">schabrolles</a> commented at <a href="https://github.com/rear/rear/pull/1450#issuecomment-324483273">2017-08-23 22:42</a>:<a class="headerlink" href="#schabrolles_commented_at_2017-08-23_2242" title="Permanent link">&para;</a></h4>
<p>@jsmeix</p>
<p>What about :
<code>test -z "$var" &amp;&amp; Error "Empty string passed to UdevSymlinkName()"</code></p>
<h4 id="schlomo_commented_at_2017-08-24_0823"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/1450#issuecomment-324568249">2017-08-24 08:23</a>:<a class="headerlink" href="#schlomo_commented_at_2017-08-24_0823" title="Permanent link">&para;</a></h4>
<p>for that type of thing I prefer
<code>test "$var" || Error "Empty string passed to UdevSymlinkName()"</code>
because it is a positive check with an <em>else</em> clause.</p>
<h4 id="jsmeix_commented_at_2017-08-24_0938"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1450#issuecomment-324586094">2017-08-24 09:38</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-08-24_0938" title="Permanent link">&para;</a></h4>
<p>@schabrolles<br />
see my comment<br />
<a href="https://github.com/rear/rear/pull/1450#pullrequestreview-58116661">https://github.com/rear/rear/pull/1450#pullrequestreview-58116661</a><br />
what I personally prefer - i.e.</p>
<pre>
test "$var" || Error "var must not be empty"
</pre>

<p>or even</p>
<pre>
test $var || Error "var must not be empty (or only spaces)"
</pre>

<p>But technically</p>
<pre>
test -z "$var" && Error "var must not be empty"
</pre>

<p>is also right and sufficiently well understandable.</p>
<p>In contrast oversophisticated stuff like</p>
<pre>
! test -z "$var" || Error "var must not be empty"
</pre>

<p>is bad because it is needlessly hard to understand<br />
and it could even make simple minds explode ;-)</p>
<p>Ultimately it is your code so that the final decision<br />
is yours what specific coding style you prefer.</p>
<h4 id="jsmeix_commented_at_2017-08-24_0950"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1450#issuecomment-324588940">2017-08-24 09:50</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-08-24_0950" title="Permanent link">&para;</a></h4>
<p>I made evil typos in my prevois comment that I fixed now.<br />
The right code is</p>
<pre>
test "$var" || Error "var must not be empty"
</pre>

<p>and</p>
<pre>
test $var || Error "var must not be empty (or only spaces)"
</pre>

<p>@schabrolles<br />
FYI regarding 'Error' versus 'BugError':</p>
<p>BugError should only be used when the cause is a bug in ReaR.</p>
<p>Error should be used when the cause is not in ReaR itself.</p>
<p>For example when in script 100_prepare_it.sh a variable is set<br />
by ReaR that is needed in a subsequent script 200_do_it.sh<br />
then in script 200_do_it.sh an assertion should be like</p>
<pre>
# var must have been set in 100_prepare_it.sh:
test $var || BugError "var empty (or only spaces)"
</pre>

<p>but in 100_prepare_it.sh it would be usually a test like</p>
<pre>
# ... [ code that sets var ] ...
test $var || Error "Failed to set var (empty or only spaces)"
</pre>

<p>when the root cause why it failed to set var is not a bug in ReaR<br />
but an error in the environment where that code is run<br />
(i.e. something outside of ReaR).<br />
And when var must be provided by the user it would be</p>
<pre>
test $var || Error "var must not be empty (or only spaces)"
</pre>

<h4 id="schabrolles_commented_at_2017-08-24_1738"><img src="https://avatars.githubusercontent.com/u/19491077?u=0021b16ab426902cbe676f6831f41607bbe4d441&v=4" width="50"><a href="https://github.com/schabrolles">schabrolles</a> commented at <a href="https://github.com/rear/rear/pull/1450#issuecomment-324705285">2017-08-24 17:38</a>:<a class="headerlink" href="#schabrolles_commented_at_2017-08-24_1738" title="Permanent link">&para;</a></h4>
<p>@jsmeix<br />
Thanks for the precious info (I learn).<br />
This test on <code>$var</code> is made inside a function (provided by
<code>layout-function.sh</code>) that need an argument (var=$1), this function is
called by other ReaR scripts (like <code>260_rename_diskbyid.sh</code>).<br />
So, if <code>$var</code> is empty, this mean that something goes wrong in
<code>260_rename_diskbyid.sh</code> (which should have called the function with an
argument).<br />
Then it should be considered has a <em>"Bug"</em> ... Am I right ?</p>
<p>If yes, I see this example (in <code>layout-function.sh</code>):</p>
<pre><code>[[ "$name" ]]
BugIfError "Empty string passed to get_device_name"
</code></pre>
<p>What so you think about this implementation ?</p>
<h4 id="jsmeix_commented_at_2017-08-25_1035"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1450#issuecomment-324882648">2017-08-25 10:35</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-08-25_1035" title="Permanent link">&para;</a></h4>
<p>@schabrolles<br />
you are right - a syntactically wrong function call is a bug in ReaR.<br />
E.g. see the BugError in the UserInput function when things<br />
are hopelessly wrong versus the 'using fallback' or 'ignored'<br />
behaviour when there is a reasonable way to proceed.</p>
<h4 id="jsmeix_commented_at_2017-08-25_1047"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1450#issuecomment-324885335">2017-08-25 10:47</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-08-25_1047" title="Permanent link">&para;</a></h4>
<p>@schabrolles<br />
I found</p>
<pre>
    if test $sed_change -eq 1 ; then
</pre>

<p>which may show unwanted bash errors<br />
but quoting "$sed_change" does not help here<br />
because (on commandline):</p>
<pre>
# sed_change=" 1 " ; if test $sed_change -eq 1 ; then echo OK ; fi
OK

# sed_change="X" ; if test $sed_change -eq 1 ; then echo OK ; fi
-bash: test: X: integer expression expected

# sed_change="" ; if test $sed_change -eq 1 ; then echo OK ; fi
-bash: test: -eq: unary operator expected

# unset sed_change ; if test $sed_change -eq 1 ; then echo OK ; fi
-bash: test: -eq: unary operator expected

# sed_change=" 1 " ; if test "$sed_change" -eq 1 ; then echo OK ; fi
OK

# sed_change="X" ; if test "$sed_change" -eq 1 ; then echo OK ; fi
-bash: test: X: integer expression expected

# sed_change="" ; if test "$sed_change" -eq 1 ; then echo OK ; fi
-bash: test: : integer expression expected

# unset sed_change ; if test "$sed_change" -eq 1 ; then echo OK ; fi
-bash: test: : integer expression expected
</pre>

<p>so that - as far as I know - all what one can do is to<br />
suppress the unwanted STDERR bash messages<br />
that won't help in any way if they appear in the log<br />
(but they may cause user questions that something<br />
could be wrong in our code), so that I suggest simply</p>
<pre>
    # Avoid stderr if sed_change is not set or empty or not an integer value:
    if test "$sed_change" -eq 1 2>/dev/null ; then
</pre>

<p>(c.f. what I do in the UserInput function).</p>
<h4 id="jsmeix_commented_at_2017-08-25_1101"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1450#issuecomment-324888071">2017-08-25 11:01</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-08-25_1101" title="Permanent link">&para;</a></h4>
<p>I need to correct my wrong<br />
<a href="https://github.com/rear/rear/pull/1450#issuecomment-324373208">https://github.com/rear/rear/pull/1450#issuecomment-324373208</a><br />
where I had written</p>
<pre>
In general I would avoid the *IfError functions
because they cannot work reliably in all cases
because they test $? but $? can be an unexpected value
</pre>

<p>That reason is nonsense because also</p>
<pre>
COMMAND || Error "..."
</pre>

<p>test the exit code (i.e. $?) of COMMAND.</p>
<p>The actual reason why I avoid the *IfError functions<br />
is that they cannot work in case of 'set -e'<br />
cf.
<a href="https://github.com/rear/rear/issues/700">https://github.com/rear/rear/issues/700</a><br />
because in case of 'set -e' the bash directly exits<br />
when a single COMMAND results non-zero exit code<br />
and no subsequent *IfError function is ever called<br />
that could test $? of the previous COMMAND.<br />
For example on commandline:</p>
<pre>
# ( set -e ; cat qqq ; if (( $? != 0 )) ; then echo ERROR ; fi )
cat: qqq: No such file or directory

# ( set -e ; cat qqq || echo ERROR )
cat: qqq: No such file or directory
ERROR

# ( set -e ; if ! cat qqq ; then echo ERROR ; fi )
cat: qqq: No such file or directory
ERROR
</pre>

<p>The crucial point is that 'cat qqq || echo ERROR'<br />
or 'if ! cat qqq ; then echo ERROR ; fi'<br />
is a single COMMAND in bash.</p>
<h4 id="schlomo_commented_at_2017-08-25_1119"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/1450#issuecomment-324891214">2017-08-25 11:19</a>:<a class="headerlink" href="#schlomo_commented_at_2017-08-25_1119" title="Permanent link">&para;</a></h4>
<p>@schabrolles @jsmeix maybe I have an idea for a much simpler solution to
the sed change monitor problem:</p>
<p>Instead of writing to a special file write to STDOUT like this:</p>
<pre><code>$ rm changed
$ date &gt; d ; sed -i -e 's/2017/XXX/w /dev/stdout' d &gt;&gt;changed
$ date &gt; d ; sed -i -e 's/2016/XXX/w /dev/stdout' d &gt;&gt;changed
$ wc -l changed
1 changed
$ cat changed
Fr 25. Aug 13:15:10 CEST XXX
$ if test $(wc -l &lt; changed) -gt 0 ; then echo changed ; fi
changed
</code></pre>
<p>This trick also makes the code shorter and removes the need to reset the
change tracking file every time. You can collect all the change infos
from all the sed calls and then check in the end.</p>
<p>The other thing I noticed is that there is no <strong>/g</strong> flag in the sed
substitution which means that sed will only replace the first occurrence
of an ID on a single line. If this is not intentional then better add
<code>/g</code> to every substitution.</p>
<h4 id="jsmeix_commented_at_2017-08-25_1206"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1450#issuecomment-324900315">2017-08-25 12:06</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-08-25_1206" title="Permanent link">&para;</a></h4>
<p>@schlomo<br />
do I understand it correctly that the actual improvement of</p>
<pre>
sed -i -e 's/THIS/THAT/gw /dev/stdout' file >>all_changes
</pre>

<p>over</p>
<pre>
sed -i -e 's/THIS/THAT/gw current_changes' file
</pre>

<p>is that appending various sed's STDOUT into all_changes<br />
makes all changes sum up therein while in contrast<br />
sed's own 'w current_changes' cannot append<br />
so that one cannot collect changes of various<br />
sed calls this way in one same file?</p>
<h4 id="schlomo_commented_at_2017-08-25_1215"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/1450#issuecomment-324902327">2017-08-25 12:15</a>:<a class="headerlink" href="#schlomo_commented_at_2017-08-25_1215" title="Permanent link">&para;</a></h4>
<p>@jsmeix yes, that is the idea. Saves you from checking the result file
after every sed call and counting the lines in this file avoids the
problem with the quoting that you mentioned above.</p>
<h4 id="schabrolles_commented_at_2017-08-25_2106"><img src="https://avatars.githubusercontent.com/u/19491077?u=0021b16ab426902cbe676f6831f41607bbe4d441&v=4" width="50"><a href="https://github.com/schabrolles">schabrolles</a> commented at <a href="https://github.com/rear/rear/pull/1450#issuecomment-325034432">2017-08-25 21:06</a>:<a class="headerlink" href="#schabrolles_commented_at_2017-08-25_2106" title="Permanent link">&para;</a></h4>
<p>@schlomo thanks for the tip ... it is implemented now</p>
<h4 id="schabrolles_commented_at_2017-08-30_0928"><img src="https://avatars.githubusercontent.com/u/19491077?u=0021b16ab426902cbe676f6831f41607bbe4d441&v=4" width="50"><a href="https://github.com/schabrolles">schabrolles</a> commented at <a href="https://github.com/rear/rear/pull/1450#issuecomment-325936079">2017-08-30 09:28</a>:<a class="headerlink" href="#schabrolles_commented_at_2017-08-30_0928" title="Permanent link">&para;</a></h4>
<p>@jsmeix @gdha @schlomo Same for this one... Last review before merging.</p>
<h4 id="jsmeix_commented_at_2017-08-30_1155"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1450#issuecomment-325968144">2017-08-30 11:55</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-08-30_1155" title="Permanent link">&para;</a></h4>
<p>@schabrolles<br />
preferably use paired parenthesis for case patterns<br />
cf. "Paired parenthesis" in<br />
<a href="https://github.com/rear/rear/wiki/Coding-Style">https://github.com/rear/rear/wiki/Coding-Style</a></p>
<h4 id="schabrolles_commented_at_2017-08-30_1933"><img src="https://avatars.githubusercontent.com/u/19491077?u=0021b16ab426902cbe676f6831f41607bbe4d441&v=4" width="50"><a href="https://github.com/schabrolles">schabrolles</a> commented at <a href="https://github.com/rear/rear/pull/1450#issuecomment-326095492">2017-08-30 19:33</a>:<a class="headerlink" href="#schabrolles_commented_at_2017-08-30_1933" title="Permanent link">&para;</a></h4>
<p>@schlomo @jsmeix changes applied</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2025 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2017-08-21.1450.pr.merged.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/rear/rear-user-guide" class="fa fa-code-fork" style="color: #fcfcfc"> rear/rear-user-guide</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
