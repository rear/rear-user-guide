<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#2831 PR merged: Refactor rsync URL support, fixes rsync OUTPUT_URL - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#2831 PR merged: Refactor rsync URL support, fixes rsync OUTPUT_URL";
        var mkdocs_page_input_path = "issues/2022-06-29.2831.pr.merged.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/backup_netfs.html">Example of BACKUP=NETFS</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#2831 PR merged: Refactor rsync URL support, fixes rsync OUTPUT_URL</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="2831_pr_merged_refactor_rsync_url_support_fixes_rsync_output_url"><a href="https://github.com/rear/rear/pull/2831">#2831 PR</a> <code>merged</code>: Refactor rsync URL support, fixes rsync OUTPUT_URL<a class="headerlink" href="#2831_pr_merged_refactor_rsync_url_support_fixes_rsync_output_url" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>enhancement</code>, <code>cleanup</code>, <code>fixed / solved / done</code></p>
<h4 id="pcahyna_opened_issue_at_2022-06-29_1004"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> opened issue at <a href="https://github.com/rear/rear/pull/2831">2022-06-29 10:04</a>:<a class="headerlink" href="#pcahyna_opened_issue_at_2022-06-29_1004" title="Permanent link">&para;</a></h4>
<h5 id="pull_request_details">Pull Request Details:<a class="headerlink" href="#pull_request_details" title="Permanent link">&para;</a></h5>
<ul>
<li>
<p>Type: <strong>Bug Fix</strong></p>
</li>
<li>
<p>Impact: <strong>Normal</strong></p>
</li>
<li>
<p>Reference to related issue (URL): closes #2781</p>
</li>
<li>
<p>How was this pull request tested?</p>
<ul>
<li>recovery using <code>OUTPUT=USB</code> <code>BACKUP=RSYNC</code> with a
    <code>rsync://...:/...</code> (rsync over ssh) and <code>rsync://...::/...</code>
    (rsyncd) <code>BACKUP_URL</code></li>
<li>recovery using <code>OUTPUT=ISO</code> <code>BACKUP=RSYNC</code> with a
    <code>rsync://...:/...</code> (rsync over ssh) <code>BACKUP_URL</code> and three
    values of <code>OUTPUT_URL</code>: <code>rsync://...:/...</code> (rsync over ssh) but
    different from <code>BACKUP_URL</code>, <code>rsync://...::/...</code> (rsyncd), and
    undefined (to inherit <code>BACKUP_URL</code>). Verified that the output
    ISO is found at the right places on the rsync server.</li>
<li>mkrescue and mkbackuponly to localhost with a <code>rsync://...:/...</code>
    (rsync over ssh) <code>BACKUP_URL</code> and <code>OUTPUT_URL</code>, the latter
    pointing to a different directory than the former. Verified that
    after <code>mkrescue</code> the ISO is under <code>OUTPUT_URL</code> and not
    <code>BACKUP_URL</code>.</li>
</ul>
</li>
<li>
<p>Brief description of the changes in this pull request:</p>
</li>
</ul>
<p>The code to parse <code>rsync://</code> URLs was <code>BACKUP_URL</code> specific.<br />
If one specified <code>BACKUP=RSYNC</code> and an <code>OUTPUT_URL</code> different from
<code>BACKUP_URL</code>,<br />
the <code>OUTPUT_URL</code> was ignored and the output files went to <code>BACKUP_URL</code>.</p>
<p>Fix by introducing generic functions for rsync URL parsing and<br />
use them for both <code>BACKUP_URL</code> and <code>OUTPUT_URL</code>, as appropriate.<br />
Replace all uses of global RSYNC_* variables derived<br />
from <code>BACKUP_URL</code> by those functions.</p>
<h4 id="jsmeix_commented_at_2022-06-29_1159"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2831#issuecomment-1169893412">2022-06-29 11:59</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-06-29_1159" title="Permanent link">&para;</a></h4>
<p>@pcahyna<br />
thank you very much for that major cleanup!</p>
<p>Could you please provide me a summary of the advantages<br />
but also the possibly backward incompatible changes<br />
that could happen because of this cleanup?</p>
<p>I would like to add that summary to the<br />
"New features, bigger enhancements, and possibly backward incompatible
changes"<br />
section in the ReaR 2.7 release notes which are currently at<br />
<a href="https://github.com/rear/rear.github.com/blob/jsmeix-release-notes-2-7/documentation/release-notes-2-7.md">https://github.com/rear/rear.github.com/blob/jsmeix-release-notes-2-7/documentation/release-notes-2-7.md</a></p>
<h4 id="pcahyna_commented_at_2022-06-29_1512"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/2831#issuecomment-1170105155">2022-06-29 15:12</a>:<a class="headerlink" href="#pcahyna_commented_at_2022-06-29_1512" title="Permanent link">&para;</a></h4>
<p>During the work on this PR I have found many other anomalies in the
rsync code, most of them are left untouched.</p>
<ul>
<li>the handling of <code>rsync</code> output URL scheme is under RSYNC
    (<a href="https://github.com/rear/rear/tree/master/usr/share/rear/output/RSYNC/default">https://github.com/rear/rear/tree/master/usr/share/rear/output/RSYNC/default</a>),
    which is a backup method, despite the output URL being in principle
    independent from backup method. This leads to different code being
    executed for <code>OUTPUT_URL=rsync://</code> depending on whether
    <code>BACKUP=RSYNC</code> or not. (If not, the output is handled in
    <code>950_copy_result_files.sh</code>, which seems to handle the URL
    differently:
    <a href="https://github.com/rear/rear/blob/8b8ad86c71eaea0ad03d64f5892e3f37d797a5e0/usr/share/rear/output/default/950_copy_result_files.sh#L131">https://github.com/rear/rear/blob/8b8ad86c71eaea0ad03d64f5892e3f37d797a5e0/usr/share/rear/output/default/950_copy_result_files.sh#L131</a>
    )<ul>
<li>as a consequence, if <code>BACKUP=RSYNC</code>, the structure of the output
    files at a <code>rsync://</code> location is different. In other cases,
    <code>RSYNC_PREFIX</code> is not respected, but in case of <code>BACKUP=RSYNC</code>,
    <code>RSYNC_PREFIX</code> is respected. See
    <a href="https://github.com/rear/rear/issues/2781#issuecomment-1160172273">https://github.com/rear/rear/issues/2781#issuecomment-1160172273</a>
    for details.</li>
</ul>
</li>
<li>Creation of the <code>backup</code> prefix directory happens in the <code>output</code>
    stage
    (<a href="https://github.com/rear/rear/blob/8b8ad86c71eaea0ad03d64f5892e3f37d797a5e0/usr/share/rear/output/RSYNC/default/200_make_prefix_dir.sh#L6">https://github.com/rear/rear/blob/8b8ad86c71eaea0ad03d64f5892e3f37d797a5e0/usr/share/rear/output/RSYNC/default/200_make_prefix_dir.sh#L6</a>).
    If <code>backup</code> is executed without <code>output</code> (by running
    <code>rear mkbackuponly</code>), it crashes, because the prefix directory does
    not exist. (This one is fixed in the PR.)</li>
<li><code>BACKUP_RSYNC_OPTIONS</code> inconsistencies between rsync-over-ssh and
    rsyncd cases. For rsyncd, they are always added to rsync options,
    for ssh only when creating the backup. The former actually leads to
    a bug, where <code>--relative</code> gets added to <code>BACKUP_RSYNC_OPTIONS</code> and
    then <code>.autorelabel</code> becomes a directory (in
    <a href="https://github.com/rear/rear/blob/8b8ad86c71eaea0ad03d64f5892e3f37d797a5e0/usr/share/rear/backup/RSYNC/GNU/Linux/620_force_autorelabel.sh#L25">https://github.com/rear/rear/blob/8b8ad86c71eaea0ad03d64f5892e3f37d797a5e0/usr/share/rear/backup/RSYNC/GNU/Linux/620_force_autorelabel.sh#L25</a>),
    leading to selinux relabeling not working (I had to fix SELinux
    manually in my tests).</li>
<li>Some places seem to assume ssh access unconditionally, especially
    500_make_rsync_backup.sh (see the <code>check_remote_df</code>,
    <code>check_remote_du</code> functions). One instance of similar code got
    removed in #2797.</li>
<li>There is detection of xattr support on the remote server (using ssh
    access)
    <a href="https://github.com/rear/rear/blob/8b8ad86c71eaea0ad03d64f5892e3f37d797a5e0/usr/share/rear/prep/RSYNC/default/150_check_rsync_protocol_version.sh#L43">https://github.com/rear/rear/blob/8b8ad86c71eaea0ad03d64f5892e3f37d797a5e0/usr/share/rear/prep/RSYNC/default/150_check_rsync_protocol_version.sh#L43</a>,
    but this does not seem to work: in
    <code>cd ${path} &amp;&amp; touch .is_xattr_supported &amp;&amp; setfattr -n user.comment -v 'File created by ReaR to test if this filesystems suppor extended attributes.' .is_xattr_supported &amp;&amp; getfattr -n user.comment .is_xattr_supported 1&gt;/dev/null; find .is_xattr_supported -empty -delete</code>,
    the last <code>find</code> clobbers the exit status.</li>
</ul>
<h4 id="pcahyna_commented_at_2022-06-29_1916"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/2831#issuecomment-1170391357">2022-06-29 19:16</a>:<a class="headerlink" href="#pcahyna_commented_at_2022-06-29_1916" title="Permanent link">&para;</a></h4>
<blockquote>
<p>Could you please provide me a summary of the advantages<br />
but also the possibly backward incompatible changes<br />
that could happen because of this cleanup?</p>
</blockquote>
<p>I suppose you are interested in changes since 2.6, that is this change
and the change that triggered #2781 combined. Ok, I will provide a
summary.</p>
<h4 id="pcahyna_commented_at_2022-06-29_1955"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/2831#issuecomment-1170428318">2022-06-29 19:55</a>:<a class="headerlink" href="#pcahyna_commented_at_2022-06-29_1955" title="Permanent link">&para;</a></h4>
<p>@jsmeix "Rsync OUTPUT_URLs are now properly supported with
<code>BACKUP=RSYNC</code>. Previously the output went to the location specified by
<code>BACKUP_URL</code> and <code>OUTPUT_URL</code> was ignored. One exception was
<code>OUTPUT=PXE</code>, where the output was uploaded to <code>OUTPUT_URL</code> in addition
to <code>BACKUP_URL</code>, but <code>RSYNC_PREFIX</code> was not respected and the
interpretation of the URL was different - an URL of the form
<code>rsync://[USER@]HOST[:PORT]/PATH</code> was interpreted as using the rsync
protocol, while in all other cases such URL would be interpreted as
using rsync over ssh. This special handling is now removed - a rsync
<code>OUTPUT_URL</code> with <code>OUTPUT=PXE</code> now creates the <code>RSYNC_PREFIX</code> directory
at the destination and the URL is interpreted as in all other cases. "</p>
<p>Does it make sense? I know it is complicated. Too many special cases,
fortunately it is about removing some of them...</p>
<h4 id="jsmeix_commented_at_2022-06-30_0756"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2831#issuecomment-1170891977">2022-06-30 07:56</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-06-30_0756" title="Permanent link">&para;</a></h4>
<p>@pcahyna<br />
thank you for your summary!<br />
Yes, it does make sense.</p>
<h4 id="didacog_commented_at_2022-07-05_0816"><img src="https://avatars.githubusercontent.com/u/5380209?u=163f1571e6b9c9c7df94e2c6ca152b0a7406b52d&v=4" width="50"><a href="https://github.com/didacog">didacog</a> commented at <a href="https://github.com/rear/rear/pull/2831#issuecomment-1174757663">2022-07-05 08:16</a>:<a class="headerlink" href="#didacog_commented_at_2022-07-05_0816" title="Permanent link">&para;</a></h4>
<p>Hello, seems that you are avoiding OUTPUT_PREFIX_PXE and is not being
created when set in the config.</p>
<h4 id="jsmeix_commented_at_2022-07-05_0902"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2831#issuecomment-1174807979">2022-07-05 09:02</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-07-05_0902" title="Permanent link">&para;</a></h4>
<p>@didacog<br />
I will act for now here for @pcahyna<br />
until he has again time to look here<br />
but I am neither a PXE user nor a rsync user<br />
so I can not at all imagine what you have<br />
in your etc/rear/local.conf</p>
<p>Therefore please provide here sufficient information<br />
that I have at least a chance to understand your issue<br />
in particular your complete etc/rear/local.conf<br />
and your complete etc/rear/site.conf if you use one.<br />
I need the actual ReaR config files because<br />
I am not a DRLM user so DRLM config files are "foreign" for me.<br />
Additionally I need a complete ReaR debugscript log file<br />
to have a chance to deduce what happens on your system.</p>
<p>Only FYI:<br />
I want to release ReaR 2.7 on the date specified on<br />
<a href="https://github.com/rear/rear/milestones">https://github.com/rear/rear/milestones</a><br />
because I already postponed it rather often and<br />
I can't wait endlessly until every issue is solved<br />
because I am under increasing pressure to release<br />
a new ReaR version (regardless if it is perfect or not).<br />
For SUSE I could fix missing things relatively easy<br />
by SUSE maintenance updates for our SLE-HA customers<br />
and I assume it is same for Red Hat for RHEL customers.<br />
Other users could use our latest master code.</p>
<h4 id="jsmeix_commented_at_2022-07-05_0907"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2831#issuecomment-1174813127">2022-07-05 09:07</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-07-05_0907" title="Permanent link">&para;</a></h4>
<p>Regarding OUTPUT_PREFIX_PXE I see no difference between<br />
the changed code here and the master code:</p>
<pre><code>localhost:~/rear.pcahyna.rsync-url-fix-refactor.pullrequest2831 # find usr/sbin/rear usr/share/rear -type f | xargs grep 'OUTPUT_PREFIX_PXE' &gt;/tmp/OUTPUT_PREFIX_PXE.pcahyna.rsync-url-fix-refactor

localhost:~/rear.github.master # find usr/sbin/rear usr/share/rear -type f | xargs grep 'OUTPUT_PREFIX_PXE' &gt;/tmp/OUTPUT_PREFIX_PXE.rear.github.master

# diff -s /tmp/OUTPUT_PREFIX_PXE.rear.github.master /tmp/OUTPUT_PREFIX_PXE.pcahyna.rsync-url-fix-refactor
Files /tmp/OUTPUT_PREFIX_PXE.rear.github.master and /tmp/OUTPUT_PREFIX_PXE.pcahyna.rsync-url-fix-refactor are identical
</code></pre>
<p>so it seems nothing was changed regarding OUTPUT_PREFIX_PXE here.</p>
<h4 id="didacog_commented_at_2022-07-05_0927"><img src="https://avatars.githubusercontent.com/u/5380209?u=163f1571e6b9c9c7df94e2c6ca152b0a7406b52d&v=4" width="50"><a href="https://github.com/didacog">didacog</a> commented at <a href="https://github.com/rear/rear/pull/2831#issuecomment-1174835567">2022-07-05 09:27</a>:<a class="headerlink" href="#didacog_commented_at_2022-07-05_0927" title="Permanent link">&para;</a></h4>
<blockquote>
<p>Regarding OUTPUT_PREFIX_PXE I see no difference between the changed
code here and the master code:</p>
<pre><code>localhost:~/rear.pcahyna.rsync-url-fix-refactor.pullrequest2831 # find usr/sbin/rear usr/share/rear -type f | xargs grep 'OUTPUT_PREFIX_PXE' &gt;/tmp/OUTPUT_PREFIX_PXE.pcahyna.rsync-url-fix-refactor

localhost:~/rear.github.master # find usr/sbin/rear usr/share/rear -type f | xargs grep 'OUTPUT_PREFIX_PXE' &gt;/tmp/OUTPUT_PREFIX_PXE.rear.github.master

# diff -s /tmp/OUTPUT_PREFIX_PXE.rear.github.master /tmp/OUTPUT_PREFIX_PXE.pcahyna.rsync-url-fix-refactor
Files /tmp/OUTPUT_PREFIX_PXE.rear.github.master and /tmp/OUTPUT_PREFIX_PXE.pcahyna.rsync-url-fix-refactor are identical
</code></pre>
<p>so it seems nothing was changed regarding OUTPUT_PREFIX_PXE here.</p>
</blockquote>
<p>@jsmeix<br />
I just figured it out because of this comment:</p>
<pre><code>This special handling is now removed - a rsync OUTPUT_URL with OUTPUT=PXE now creates the RSYNC_PREFIX directory at the destination and the URL is interpreted as in all other cases. "
</code></pre>
<h4 id="didacog_commented_at_2022-07-05_0932"><img src="https://avatars.githubusercontent.com/u/5380209?u=163f1571e6b9c9c7df94e2c6ca152b0a7406b52d&v=4" width="50"><a href="https://github.com/didacog">didacog</a> commented at <a href="https://github.com/rear/rear/pull/2831#issuecomment-1174841182">2022-07-05 09:32</a>:<a class="headerlink" href="#didacog_commented_at_2022-07-05_0932" title="Permanent link">&para;</a></h4>
<blockquote>
<p>@didacog I will act for now here for @pcahyna until he has again time
to look here but I am neither a PXE user nor a rsync user so I can not
at all imagine what you have in your etc/rear/local.conf</p>
<p>Therefore please provide here sufficient information that I have at
least a chance to understand your issue in particular your complete
etc/rear/local.conf and your complete etc/rear/site.conf if you use
one. I need the actual ReaR config files because I am not a DRLM user
so DRLM config files are "foreign" for me. Additionally I need a
complete ReaR debugscript log file to have a chance to deduce what
happens on your system.</p>
<p>Only FYI: I want to release ReaR 2.7 on the date specified on
<a href="https://github.com/rear/rear/milestones">https://github.com/rear/rear/milestones</a>
because I already postponed it rather often and I can't wait endlessly
until every issue is solved because I am under increasing pressure to
release a new ReaR version (regardless if it is perfect or not). For
SUSE I could fix missing things relatively easy by SUSE maintenance
updates for our SLE-HA customers and I assume it is same for Red Hat
for RHEL customers. Other users could use our latest master code.</p>
</blockquote>
<hr />
<p>@jsmeix<br />
I understand, but I think this regression should be fixed before
releasing, or at least an agreement on how to solve it. Before any
change ReaR always created the PXE subfolder in the URL path, and is
important for security reasons. I'm sure nobody wants to share data over
tftp because backup and pxe outputs are in the same place ...<br />
Hopefully we can solve this before July 12th.</p>
<p>Regards,<br />
Didac</p>
<h4 id="pcahyna_commented_at_2022-07-05_1532"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/2831#issuecomment-1175198212">2022-07-05 15:32</a>:<a class="headerlink" href="#pcahyna_commented_at_2022-07-05_1532" title="Permanent link">&para;</a></h4>
<p>@jsmeix still here... I don't think that <code>OUTPUT_PREFIX_PXE</code> is the
problem (it had no special handling in the old code indeed, so it should
not need one now), but there is something else going on.</p>
<h4 id="jsmeix_commented_at_2022-07-06_0743"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2831#issuecomment-1175893229">2022-07-06 07:43</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-07-06_0743" title="Permanent link">&para;</a></h4>
<p>@pcahyna<br />
I appreciate it that you still participate here<br />
but you don't need if you don't like and when you have<br />
currently better things "to do" with "higher priority" ;-)</p>
<h4 id="jsmeix_commented_at_2022-07-06_0750"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2831#issuecomment-1175900604">2022-07-06 07:50</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-07-06_0750" title="Permanent link">&para;</a></h4>
<p>I have a plan how to proceed with this issue:</p>
<p>I would like to merge it tomorrow afternoon<br />
unless there are objections from @pcahyna or @rear/contributors</p>
<p>My reasoning:<br />
In its current state it is another good step forward<br />
towards cleaned up rsync code in ReaR.<br />
And when it is merged it is simpler and easier to get tested<br />
by all users who use our current GitHub master code.</p>
<p>Remaining issues because of our rsync code cleanup in ReaR<br />
can and will be fixed via separated pull requests.</p>
<h4 id="jsmeix_commented_at_2022-07-06_0815"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2831#issuecomment-1175924062">2022-07-06 08:15</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-07-06_0815" title="Permanent link">&para;</a></h4>
<p>In general regarding BACKUP=... versus OUTPUT=... :</p>
<p>The final goal should be that consistently and in general<br />
for all combinations of internal BACKUP methods and OUTPUT methods<br />
that are specified in etc/rear/local.conf like</p>
<pre><code>OUTPUT=output_method
OUTPUT_URL=output_scheme://output/destination
BACKUP=backup_method
BACKUP_URL=backup_scheme://backup/destination
</code></pre>
<p>the RESULT_FILES (i.e. the ReaR recovery system files)<br />
get sent to the output/destination<br />
via the output_scheme protocol<br />
and<br />
the backup files (e.g. backup.tar.gz and backup.log)<br />
get sent to the backup/destination<br />
via the backup_scheme protocol.</p>
<p>Optionally (but not strictly required)<br />
at most one of OUTPUT_URL or BACKUP_URL could be left out<br />
and then the one that is specified determines both.</p>
<p>For example the usual way like</p>
<pre><code>OUTPUT=output_method
BACKUP=backup_method
BACKUP_URL=backup_scheme://backup/destination
</code></pre>
<p>the RESULT_FILES (i.e. the ReaR recovery system files)<br />
get sent to the backup/destination<br />
via the backup_scheme protocol<br />
and<br />
the backup files (e.g. backup.tar.gz and backup.log)<br />
get sent to the backup/destination<br />
via the backup_scheme protocol.</p>
<p>But also the other way round should work like</p>
<pre><code>OUTPUT=output_method
OUTPUT_URL=output_scheme://output/destination
BACKUP=backup_method
</code></pre>
<p>the RESULT_FILES (i.e. the ReaR recovery system files)<br />
get sent to the output/destination<br />
via the output_scheme protocol<br />
and<br />
the backup files (e.g. backup.tar.gz and backup.log)<br />
get sent to the output/destination<br />
via the output_scheme protocol.</p>
<p>External BACKUP methods can behave as they like<br />
(i.e. whatever is reasonable for each particular external BACKUP
method).</p>
<h4 id="pcahyna_commented_at_2022-07-07_0951"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/2831#issuecomment-1177332886">2022-07-07 09:51</a>:<a class="headerlink" href="#pcahyna_commented_at_2022-07-07_0951" title="Permanent link">&para;</a></h4>
<p>@jsmeix yes, I agree, the problem is that the current code has special
output URL handling for <code>BACKUP=RSYNC</code>, which is inconsistent, since
output should be independent on backup. See</p>
<p><a href="https://github.com/pcahyna/rear/blob/5cb10407d08e0d923219c9b013d420a4b632843f/usr/share/rear/output/default/950_copy_result_files.sh#L132">https://github.com/pcahyna/rear/blob/5cb10407d08e0d923219c9b013d420a4b632843f/usr/share/rear/output/default/950_copy_result_files.sh#L132</a></p>
<p>This pull request makes the code respect <code>OUTPUT_URL</code> if it is not
identical to <code>BACKUP_URL</code>, but does not remove this special handling.
Should it be removed entirely before 2.7 ? Would be good for
consistency, but it would mean more changes and more testing (and also
behavior changes).</p>
<h4 id="pcahyna_commented_at_2022-07-07_0958"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/2831#issuecomment-1177340267">2022-07-07 09:58</a>:<a class="headerlink" href="#pcahyna_commented_at_2022-07-07_0958" title="Permanent link">&para;</a></h4>
<blockquote>
<p>the problem is (...)</p>
</blockquote>
<p>note that this is not the problem reported by @didacog, it is a separate
problem (and not a regression, it has been always there).</p>
<h4 id="jsmeix_commented_at_2022-07-07_1007"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2831#issuecomment-1177350179">2022-07-07 10:07</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-07-07_1007" title="Permanent link">&para;</a></h4>
<p>@pcahyna<br />
I would prefer to not add new bigger changes for ReaR 2.7<br />
so we could finally release it "as is" - even when 'rsync'<br />
is currently not yet well cleaned up - but we also have some<br />
more areas where current things in ReaR are not yet clean<br />
(e.g. OUTPUT=USB and ReaR recovery system bootloader setup)<br />
but nevertheless the current state should be sufficiently OK<br />
to be released.</p>
<h4 id="jsmeix_commented_at_2022-07-07_1014"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2831#issuecomment-1177357677">2022-07-07 10:14</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-07-07_1014" title="Permanent link">&para;</a></h4>
<p>By the way only as a side note FYI see my<br />
<a href="https://github.com/rear/rear/pull/2577#issuecomment-789696867">https://github.com/rear/rear/pull/2577#issuecomment-789696867</a><br />
and the subsequent comment there<br />
which looks like an inconsistency to me.</p>
<p>I think there should not be two subtle different methods<br />
in ReaR to do the backup via rsync and I still do not understand<br />
the reason behind why there are two different implementations<br />
in ReaR to do the backup via rsync - this all is too confusing.</p>
<h4 id="pcahyna_commented_at_2022-07-07_1014"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/2831#issuecomment-1177357939">2022-07-07 10:14</a>:<a class="headerlink" href="#pcahyna_commented_at_2022-07-07_1014" title="Permanent link">&para;</a></h4>
<p>@jsmeix I understand, the only advantage would be to make all related
behavior changes at the same time, so that users would not have to adapt
their workflows/configs multiple times.</p>
<h4 id="jsmeix_commented_at_2022-07-07_1022"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2831#issuecomment-1177365732">2022-07-07 10:22</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-07-07_1022" title="Permanent link">&para;</a></h4>
<p>Normally users would not have to adapt their workflows/configs multiple
times<br />
because when a user has a working disaster recovery procedure with
ReaR,<br />
then he should not update ReaR ("never change a working system").<br />
In contrast when things do not work sufficiently with an older ReaR
version,<br />
then the user should try out if a newer ReaR version works better.<br />
Cf. the section "Version upgrades with Relax-and-Recover" in<br />
<a href="https://en.opensuse.org/SDB:Disaster_Recovery">https://en.opensuse.org/SDB:Disaster_Recovery</a></p>
<p>So we can move forward little step by little step<br />
together with users who test each little step<br />
which is the only way we can move forward<br />
with our manpower at ReaR upstream.</p>
<h4 id="pcahyna_commented_at_2022-07-07_1025"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/2831#issuecomment-1177368306">2022-07-07 10:25</a>:<a class="headerlink" href="#pcahyna_commented_at_2022-07-07_1025" title="Permanent link">&para;</a></h4>
<blockquote>
<p>By the way only as a side note FYI see my <a href="https://github.com/rear/rear/pull/2577#issuecomment-789696867">#2577
(comment)</a>
and the subsequent comment there which looks like an inconsistency to
me.</p>
<p>I think there should not be two subtle different methods in ReaR to do
the backup via rsync and I still do not understand the reason behind
why there are two different implementations in ReaR to do the backup
via rsync - this all is too confusing.</p>
</blockquote>
<p>Indeed, that has been very confusing to me as well, but it is yet a
different kind of confusion than the one here. (And I have thought that
the <code>BACKUP=NETFS</code> and <code>BACKUP_PROG=rsync</code> does not use rsync over ssh,
but local rsync to a mounted filesystem, which makes more sense: the
rsync invocation reads</p>
<pre><code>$BACKUP_PROG --verbose "${BACKUP_RSYNC_OPTIONS[@]}" --one-file-system --delete \
            --exclude-from=$TMP_DIR/backup-exclude.txt --delete-excluded \
            $(cat $TMP_DIR/backup-include.txt) "$backuparchive" &gt;&amp;2
</code></pre>
<p>and <code>$backuparchive</code> does not contain anything ssh-transport-related. )</p>
<h4 id="jsmeix_commented_at_2022-07-07_1034"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2831#issuecomment-1177376772">2022-07-07 10:34</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-07-07_1034" title="Permanent link">&para;</a></h4>
<p>@pcahyna<br />
for the fun of it:<br />
It's a great relief to me to see that also you and @gdha seem to be
confused<br />
what BACKUP=NETFS with BACKUP_PROG=rsync versus BACKUP=RSYNC actually
does<br />
so I feel less lonely with my own confusion :-)</p>
<h4 id="jsmeix_commented_at_2022-07-07_1040"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2831#issuecomment-1177381979">2022-07-07 10:40</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-07-07_1040" title="Permanent link">&para;</a></h4>
<p>@rear/contributors<br />
I would like to merge it in a few hours<br />
(at about 15:00 CEST) unless there are objections</p>
<h4 id="didacog_commented_at_2022-07-07_1252"><img src="https://avatars.githubusercontent.com/u/5380209?u=163f1571e6b9c9c7df94e2c6ca152b0a7406b52d&v=4" width="50"><a href="https://github.com/didacog">didacog</a> commented at <a href="https://github.com/rear/rear/pull/2831#issuecomment-1177565000">2022-07-07 12:52</a>:<a class="headerlink" href="#didacog_commented_at_2022-07-07_1252" title="Permanent link">&para;</a></h4>
<p>@jsmeix please see<br />
<a href="https://github.com/rear/rear/issues/2781#issuecomment-1177558312">https://github.com/rear/rear/issues/2781#issuecomment-1177558312</a><br />
before merging!</p>
<h4 id="jsmeix_commented_at_2022-07-07_1301"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2831#issuecomment-1177577045">2022-07-07 13:01</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-07-07_1301" title="Permanent link">&para;</a></h4>
<p>@didacog<br />
thank you for debugging and for your fix!</p>
<p>Of course I will wait now until @pcahyna had a look.</p>
<p>So I will not merge it this week.<br />
Perhaps next week if all goes well<br />
(I am not in the office tomorrow).</p>
<h4 id="jsmeix_commented_at_2022-07-11_1108"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2831#issuecomment-1180261687">2022-07-11 11:08</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-07-11_1108" title="Permanent link">&para;</a></h4>
<p>@pcahyna<br />
THANK YOU SO MUCH!</p>
<p>I think I can feel the "URI/URL parsing hell" a bit ;-)<br />
I was in there when I cleaned up the url_* functions :-)<br />
(cf.
<a href="https://github.com/rear/rear/issues/856">https://github.com/rear/rear/issues/856</a>
and others)</p>
<h4 id="jsmeix_commented_at_2022-07-11_1111"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2831#issuecomment-1180263827">2022-07-11 11:11</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-07-11_1111" title="Permanent link">&para;</a></h4>
<p>According to<br />
<a href="https://github.com/rear/rear/issues/2781#issuecomment-1180233302">https://github.com/rear/rear/issues/2781#issuecomment-1180233302</a><br />
the issue
<a href="https://github.com/rear/rear/issues/2781">https://github.com/rear/rear/issues/2781</a><br />
is fixed with the latest commit here<br />
<a href="https://github.com/rear/rear/pull/2831/commits/e7556a13eb95f21b5fb749c089facaf8678f3cd4">https://github.com/rear/rear/pull/2831/commits/e7556a13eb95f21b5fb749c089facaf8678f3cd4</a><br />
so I would like to merge this pull request tomorrow afternoon<br />
unless there are objections by @rear/contributors</p>
<h4 id="pcahyna_commented_at_2022-07-12_1825"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/2831#issuecomment-1182198795">2022-07-12 18:25</a>:<a class="headerlink" href="#pcahyna_commented_at_2022-07-12_1825" title="Permanent link">&para;</a></h4>
<p>By the way, I tested the code after the last commit again by backing
up/recovering to/from a <code>rsync://</code> BACKUP_URL (only rsync over ssh was
tested though) and several possibilities for OUTPUT_URL. All the tests
pass.</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2024 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2022-06-29.2831.pr.merged.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/rear/rear-user-guide" class="fa fa-code-fork" style="color: #fcfcfc"> rear/rear-user-guide</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
