<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#2595 Issue closed: Can't restore EFI system with Software Raid - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#2595 Issue closed: Can\u0027t restore EFI system with Software Raid";
        var mkdocs_page_input_path = "issues/2021-04-02.2595.issue.closed.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#2595 Issue closed: Can't restore EFI system with Software Raid</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="2595_issue_closed_cant_restore_efi_system_with_software_raid"><a href="https://github.com/rear/rear/issues/2595">#2595 Issue</a> <code>closed</code>: Can't restore EFI system with Software Raid<a class="headerlink" href="#2595_issue_closed_cant_restore_efi_system_with_software_raid" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>enhancement</code>, <code>bug</code>, <code>fixed / solved / done</code></p>
<h4 id="rmetrich_opened_issue_at_2021-04-02_1158"><img src="https://avatars.githubusercontent.com/u/1163635?u=36b5e32e1dd55f1ce77cad431a5683fce40a7934&v=4" width="50"><a href="https://github.com/rmetrich">rmetrich</a> opened issue at <a href="https://github.com/rear/rear/issues/2595">2021-04-02 11:58</a>:<a class="headerlink" href="#rmetrich_opened_issue_at_2021-04-02_1158" title="Permanent link">&para;</a></h4>
<h4 id="relax-and-recover_rear_issue_template">Relax-and-Recover (ReaR) Issue Template<a class="headerlink" href="#relax-and-recover_rear_issue_template" title="Permanent link">&para;</a></h4>
<p>Fill in the following items before submitting a new issue<br />
(quick response is not guaranteed with free support):</p>
<ul>
<li>
<p>ReaR version ("/usr/sbin/rear -V"): Latest</p>
</li>
<li>
<p>OS version ("cat /etc/os-release" or "lsb_release -a" or "cat
    /etc/rear/os.conf"): N/A</p>
</li>
<li>
<p>ReaR configuration files ("cat /etc/rear/site.conf" and/or "cat
    /etc/rear/local.conf"): N/A</p>
</li>
<li>
<p>Hardware (PC or PowerNV BareMetal or ARM) or virtual machine (KVM
    guest or PoverVM LPAR): KVM or physical</p>
</li>
<li>
<p>System architecture (x86 compatible or PPC64/PPC64LE or what exact
    ARM device): x86_64</p>
</li>
<li>
<p>Firmware (BIOS or UEFI or Open Firmware) and bootloader (GRUB or
    ELILO or Petitboot): UEFI</p>
</li>
<li>
<p>Storage (local disk or SSD) and/or SAN (FC or iSCSI or FCoE) and/or
    multipath (DM or NVMe): Software RAID</p>
</li>
<li>
<p>Description of the issue (ideally so that others can reproduce it):</p>
</li>
</ul>
<p>Restoring a system having a software raid for /boot/efi, ReaR doesn't
create the EFI entry.</p>
<p>ReaR output:</p>
<pre><code># rear recover
[...]
Creating  EFI Boot Manager entry 'RedHatEnterpriseServer 7.9' for 'EFI\redhat\shimx64.efi' (UEFI_BOOTLOADER='/boot/efi/EFI/redhat/shimx64.efi')
efibootmgr failed to create EFI Boot Manager entry for 'EFI\redhat\shimx64.efi' (UEFI_BOOTLOADER='/boot/efi/EFI/redhat/shimx64.efi')
[...]
</code></pre>
<p>Log: (showing an error)</p>
<pre><code># grep -w efibootmgr /var/log/rear/rear-*.log
2021-04-02 13:34:58.284377507 efibootmgr --create --gpt --disk /dev/md --part 125 --write-signature --label "RedHatEnterpriseServer 7.9" --loader "\EFI\redhat\shimx64.efi"
2021-04-02 13:34:58.287082916 efibootmgr failed to create EFI Boot Manager entry for 'EFI\redhat\shimx64.efi' (UEFI_BOOTLOADER='/boot/efi/EFI/redhat/shimx64.efi')
</code></pre>
<p>The issue is due to the code
<code>/usr/share/rear/finalize/Linux-i386/670_run_efibootmgr.sh</code> not
supporting Software Raid at all:</p>
<pre><code> 30 BootEfiDev="$( mount | grep "$esp_mountpoint" | awk '{print $1}' )"
 31 # /dev/sda1 or /dev/mapper/vol34_part2 or /dev/mapper/mpath99p4
 32 Dev=$( get_device_name $BootEfiDev )
 33 # 1 (must anyway be a low nr &lt;9)
 34 ParNr=$( get_partition_number $Dev )
 35 # /dev/sda or /dev/mapper/vol34_part or /dev/mapper/mpath99p or /dev/mmcblk0p
 36 Disk=$( echo ${Dev%$ParNr} )
</code></pre>
<ul>
<li>Workaround, if any:</li>
</ul>
<p>Execute <strong>efibootmgr</strong> command manually on one of the members of the
Software Raid.</p>
<h4 id="pcahyna_commented_at_2021-04-05_2019"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/2595#issuecomment-813626419">2021-04-05 20:19</a>:<a class="headerlink" href="#pcahyna_commented_at_2021-04-05_2019" title="Permanent link">&para;</a></h4>
<p>Interesting. How can one create this RAID? I suppose only the two EFI
partitions (or the two whole disks) are RAID members and have superblock
format 1.0 (so that the superblock is at the end of the partition and
does not confuse the firmware)? If just the partitions are RAID members,
is the partition type the same as it would be without the RAID? Or is
the firmware actually aware of the RAID?<br />
(The question is, how does the layout look like exactly and how can one
install such a system in order to reproduce the problem)</p>
<h4 id="rmetrich_commented_at_2021-04-06_0554"><img src="https://avatars.githubusercontent.com/u/1163635?u=36b5e32e1dd55f1ce77cad431a5683fce40a7934&v=4" width="50"><a href="https://github.com/rmetrich">rmetrich</a> commented at <a href="https://github.com/rear/rear/issues/2595#issuecomment-813843855">2021-04-06 05:54</a>:<a class="headerlink" href="#rmetrich_commented_at_2021-04-06_0554" title="Permanent link">&para;</a></h4>
<p>It's enough to select RAID in Anaconda (on RHEL or Fedora). The
installer knows it's a EFI partition so will create it in 1.0 format.<br />
I guess the firmware must be RAID capable to fully work in the future
(e.g. in case of modification of the UEFI partition) but that's not the
problem here.</p>
<h4 id="pcahyna_commented_at_2021-04-13_1439"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/2595#issuecomment-818789594">2021-04-13 14:39</a>:<a class="headerlink" href="#pcahyna_commented_at_2021-04-13_1439" title="Permanent link">&para;</a></h4>
<p>@rmetrich or @gdha or @jsmeix , you can assign the issue to me, I am
working on it, , unless Renaud already has a fix.<br />
Here is a kickstart snippet to install such a system:</p>
<pre><code>part raid.3325 --fstype="mdmember" --ondisk=vda --size=1024
part raid.3527 --fstype="mdmember" --ondisk=vdb --size=157
part raid.3331 --fstype="mdmember" --ondisk=vdb --size=1024
part raid.3155 --fstype="mdmember" --ondisk=vdb --size=3937
part raid.3521 --fstype="mdmember" --ondisk=vda --size=157
part raid.3149 --fstype="mdmember" --ondisk=vda --size=3937
raid pv.3161 --device=pv00 --fstype="lvmpv" --level=RAID1 raid.3149 raid.3155
raid /boot --device=boot --fstype="xfs" --level=RAID1 raid.3325 raid.3331
raid /boot/efi --device=boot_efi --fstype="efi" --level=RAID1 --fsoptions="umask=0077,shortname=winnt" raid.3521 raid.3527
volgroup centos --pesize=4096 pv.3161
logvol /  --fstype="xfs" --size=2908 --name=root --vgname=centos
logvol swap  --fstype="swap" --size=1023 --name=swap --vgname=centos
</code></pre>
<h4 id="rmetrich_commented_at_2021-04-13_1531"><img src="https://avatars.githubusercontent.com/u/1163635?u=36b5e32e1dd55f1ce77cad431a5683fce40a7934&v=4" width="50"><a href="https://github.com/rmetrich">rmetrich</a> commented at <a href="https://github.com/rear/rear/issues/2595#issuecomment-818830020">2021-04-13 15:31</a>:<a class="headerlink" href="#rmetrich_commented_at_2021-04-13_1531" title="Permanent link">&para;</a></h4>
<p>@pcahyna Thanks a lot! I'm in PTO and additionally extremely busy with
other stuff ...</p>
<h4 id="gdha_commented_at_2021-04-13_1533"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/issues/2595#issuecomment-818830962">2021-04-13 15:33</a>:<a class="headerlink" href="#gdha_commented_at_2021-04-13_1533" title="Permanent link">&para;</a></h4>
<p>@pcahyna It is yours now.</p>
<h4 id="jsmeix_commented_at_2021-05-05_1236"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2595#issuecomment-832652070">2021-05-05 12:36</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-05-05_1236" title="Permanent link">&para;</a></h4>
<p>With
<a href="https://github.com/rear/rear/pull/2608">https://github.com/rear/rear/pull/2608</a>
merged<br />
this issue should be fixed.</p>
<p>@pcahyna @rmetrich<br />
thank you for all your work to get this missing functionality properly
implemented!</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2024 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2021-04-02.2595.issue.closed.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/rear/rear-user-guide" class="fa fa-code-fork" style="color: #fcfcfc"> rear/rear-user-guide</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
