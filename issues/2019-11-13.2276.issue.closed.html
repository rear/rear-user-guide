<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#2276 Issue closed: How to modify recovery system UEFI bootloader to boot the "normal" system by default? - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#2276 Issue closed: How to modify recovery system UEFI bootloader to boot the \"normal\" system by default?";
        var mkdocs_page_input_path = "issues/2019-11-13.2276.issue.closed.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#2276 Issue closed: How to modify recovery system UEFI bootloader to boot the "normal" system by default?</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="2276_issue_closed_how_to_modify_recovery_system_uefi_bootloader_to_boot_the_normal_system_by_default"><a href="https://github.com/rear/rear/issues/2276">#2276 Issue</a> <code>closed</code>: How to modify recovery system UEFI bootloader to boot the "normal" system by default?<a class="headerlink" href="#2276_issue_closed_how_to_modify_recovery_system_uefi_bootloader_to_boot_the_normal_system_by_default" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>enhancement</code>, <code>support / question</code>, <code>fixed / solved / done</code></p>
<h4 id="jorman_opened_issue_at_2019-11-13_2144"><img src="https://avatars.githubusercontent.com/u/5203988?v=4" width="50"><a href="https://github.com/Jorman">Jorman</a> opened issue at <a href="https://github.com/rear/rear/issues/2276">2019-11-13 21:44</a>:<a class="headerlink" href="#jorman_opened_issue_at_2019-11-13_2144" title="Permanent link">&para;</a></h4>
<p>Hi, I'm on Debian Buster and I just discovered rear, so rear is 2.4 for
me<br />
I followed some instruction to make a disk and till here, no problem</p>
<pre><code>OUTPUT=USB
BACKUP=NETFS
BACKUP_URL=usb:///dev/disk/by-label/REAR-000
</code></pre>
<p>The problem came when I reboot the system, because the bios see the
attached disk and start it before the "real" boot disk.<br />
Unfortunately I can't change the disk boot order inside the bios so, how
can I "force" the grub menu on rear disk in order to have the default
start set to my system disk instead starting the rear one?<br />
I searched a bit but I can't find exactly the solution.<br />
I hope to leave the hdd attached to my system and put under cron the
creation/update of the rear disk, in order to not have worry about any
system problem</p>
<p>Any idea?</p>
<p>J</p>
<h4 id="jsmeix_commented_at_2019-11-14_1330"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2276#issuecomment-553888458">2019-11-14 13:30</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-11-14_1330" title="Permanent link">&para;</a></h4>
<p>@Jorman<br />
on my test system the ReaR recovery system boot menu default entry is</p>
<pre><code>Boot First Local disk (hd0)
</code></pre>
<p>I assume in your case it is the same default<br />
but in your case that <code>First Local disk</code><br />
is not the "normal" system disk but the disk<br />
where the ReaR recovery system is.</p>
<p>So you like to have the next ReaR recovery system boot menu entry</p>
<pre><code>Boot Second Local disk (hd1)
</code></pre>
<p>as default ReaR recovery system boot menu entry.</p>
<p>The ReaR recovery system does not use GRUB to boot but syslinux.</p>
<p>The matching code to set up syslinux for the ReaR recovery system<br />
is in usr/share/rear/lib/bootloader-functions.sh<br />
the function make_syslinux_config<br />
<a href="https://github.com/rear/rear/blob/master/usr/share/rear/lib/bootloader-functions.sh#L185">https://github.com/rear/rear/blob/master/usr/share/rear/lib/bootloader-functions.sh#L185</a><br />
therein in particular the part about
<code>Use chain booting for booting disk</code><br />
<a href="https://github.com/rear/rear/blob/master/usr/share/rear/lib/bootloader-functions.sh#L297">https://github.com/rear/rear/blob/master/usr/share/rear/lib/bootloader-functions.sh#L297</a><br />
where the syslinux default boot menu entry is defined<br />
depending on the syslinux target flavour.</p>
<p>I think you need to change that code because as far as I see<br />
the ReaR recovery system default boot menu entry is hardcoded there.</p>
<h4 id="jorman_commented_at_2019-11-14_1937"><img src="https://avatars.githubusercontent.com/u/5203988?v=4" width="50"><a href="https://github.com/Jorman">Jorman</a> commented at <a href="https://github.com/rear/rear/issues/2276#issuecomment-554045467">2019-11-14 19:37</a>:<a class="headerlink" href="#jorman_commented_at_2019-11-14_1937" title="Permanent link">&para;</a></h4>
<p>Hi @jsmeix and thanks for your reply.<br />
Apologize me if I'm not using all correct words, ReaR is pretty new for
me.<br />
My system always use first a botable usb so, when I reboot the system,
ReaR recovery disk start.<br />
I see the code and I also see this:<br />
<a href="https://github.com/rear/rear/blob/2f66b904fdc1f69d31f1c9fa64e13a0964c21a38/usr/share/rear/lib/bootloader-functions.sh#L316-L321">https://github.com/rear/rear/blob/2f66b904fdc1f69d31f1c9fa64e13a0964c21a38/usr/share/rear/lib/bootloader-functions.sh#L316-L321</a><br />
So, maybe there's a way to "force" ReaR to extlinux? Maybe a single line
to add to configuration?</p>
<p>What do you think?</p>
<p>J</p>
<h4 id="jsmeix_commented_at_2019-11-15_1100"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2276#issuecomment-554316041">2019-11-15 11:00</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-11-15_1100" title="Permanent link">&para;</a></h4>
<p>I enhanced my <code>make_syslinux_config</code> function<br />
in usr/share/rear/lib/bootloader-functions.sh<br />
as follows (excerpt):</p>
<pre><code>    # Use chain booting for booting disk, if chain.c32 is available
    if [[ -r "$SYSLINUX_DIR/chain.c32" ]]; then
        cp $v "$SYSLINUX_DIR/chain.c32" "$BOOT_DIR/chain.c32" &gt;&amp;2

        echo "say boothd0 - boot first local disk"
        echo "label boothd0"
        syslinux_menu "label Boot First ^Local disk (hd0)"
        if [[ "$flavour" == "isolinux" ]] &amp;&amp; [ "$ISO_DEFAULT" == "boothd" ] ; then
            # for isolinux local boot means boot from first disk
            echo "default boothd0"
            syslinux_menu "default"
        fi
        if test "boothd0" = "$ISO_DEFAULT" ; then
            # the user has explicitly specified to boot via boothd0 by default
            echo "default boothd0"
            syslinux_menu "default"
        fi
        echo "kernel chain.c32"
        echo "append hd0"
        echo ""

        echo "say boothd1 - boot second local disk"
        echo "label boothd1"
        syslinux_menu "label Boot ^Second Local disk (hd1)"
        if [[ "$flavour" == "extlinux" ]] &amp;&amp; [ "$ISO_DEFAULT" == "boothd" ]; then
            # for extlinux local boot means boot from second disk because the boot disk became the first disk
            # which usually allows us to access the original first disk as second disk
            echo "default boothd1"
            syslinux_menu "default"
        fi
        if test "boothd1" = "$ISO_DEFAULT" ; then
            # the user has explicitly specified to boot via boothd1 by default
            echo "default boothd1"
            syslinux_menu "default"
        fi
        echo "kernel chain.c32"
        echo "append hd1"
        echo ""

    fi
</code></pre>
<p>i.e. I only added the parts</p>
<pre><code>    if test "boothd0" = "$ISO_DEFAULT" ; then
        # the user has explicitly specified to boot via boothd0 by default
        echo "default boothd0"
        syslinux_menu "default"
    fi
</code></pre>
<p>and</p>
<pre><code>    if test "boothd1" = "$ISO_DEFAULT" ; then
        # the user has explicitly specified to boot via boothd1 by default
        echo "default boothd1"
        syslinux_menu "default"
    fi
</code></pre>
<p>Now I can set in my etc/rear/local.conf</p>
<pre><code>ISO_DEFAULT="boothd1"
</code></pre>
<p>to enforce that the <code>boothd1</code> entry is used by default.</p>
<p>With also <code>KEEP_BUILD_DIR="yes"</code> in etc/rear/local.conf<br />
I can compare the result of the default <code>ISO_DEFAULT=boothd</code><br />
<a href="https://github.com/rear/rear/blob/master/usr/share/rear/conf/default.conf#L663">https://github.com/rear/rear/blob/master/usr/share/rear/conf/default.conf#L663</a><br />
with the result when <code>ISO_DEFAULT="boothd1"</code> is specified<br />
which is in my case:</p>
<pre><code># diff -U2 /tmp/rear.NBwgusoCAP0TAzj/tmp/isolinux/isolinux.cfg /tmp/rear.KWNoc5BX2UthLxW/tmp/isolinux/isolinux.cfg
...
@@ -45,6 +45,4 @@
 label boothd0
 MENU label Boot First ^Local disk (hd0)
-default boothd0
-MENU default
 kernel chain.c32
 append hd0
@@ -53,4 +51,6 @@
 label boothd1
 MENU label Boot ^Second Local disk (hd1)
+default boothd1
+MENU default
 kernel chain.c32
 append hd1
</code></pre>
<p>@Jorman<br />
do the same additions to your <code>make_syslinux_config</code> function<br />
in your usr/share/rear/lib/bootloader-functions.sh and<br />
set <code>ISO_DEFAULT="boothd1"</code> in your /etc/rear/local.conf<br />
and re-run <code>rear mkrescue</code> and tell us if now it boots<br />
from the second harddisk by default.</p>
<p>An addedum on Tue Dec 17 14:22:03 CET 2019:</p>
<p>Using <code>ISO_DEFAULT="boothd1"</code> in /etc/rear/local.conf<br />
cannot work in case of <code>OUTPUT=USB</code> because<br />
<code>ISO_DEFAULT</code> is only for <code>OUTPUT=ISO</code><br />
as the <code>ISO</code> prefix indicates and as documented in default.conf</p>
<p>For <code>OUTPUT=USB</code> the syslinux bootloader configuration happens via<br />
output/USB/Linux-i386/300_create_extlinux.sh<br />
where the default USB boot entry is hardcoded in a different way</p>
<pre><code>    # Use chain booting for booting disk, if chain.c32 is available
    if syslinux_has "chain.c32"; then
        syslinux_write &lt;&lt;EOF
ontimeout boothd1
label boothd1
    say boothd1 - boot second local disk
    menu label Boot ^Local disk (hd1)
    menu default
    kernel chain.c32
    append hd1

label bootlocal
    say bootlocal - boot second local bios disk
    menu label Boot ^BIOS disk (0x81)
    text help
Use this when booting from local disk 0x81 does not work !
    endtext
    localboot 0x81

EOF
</code></pre>
<p><a href="https://github.com/rear/rear/pull/2303">https://github.com/rear/rear/pull/2303</a><br />
intends to enhance the recovery system BIOS boot default settings<br />
for <code>OUTPUT=USB</code> and <code>OUTPUT=ISO</code> according to what<br />
is described above in this particular issue comment.</p>
<p>With
<a href="https://github.com/rear/rear/pull/2303">https://github.com/rear/rear/pull/2303</a>
merged via<br />
<a href="https://github.com/rear/rear/commit/a02ad4e5f3d1fc9299330287a4ba0c624e7d010c">https://github.com/rear/rear/commit/a02ad4e5f3d1fc9299330287a4ba0c624e7d010c</a><br />
the recovery system BIOS boot default settings for USB and ISO<br />
are enhanced and documented in default.conf:</p>
<p>For OUTPUT=ISO the user can now explicitly specify<br />
what to boot by default when booting the ISO on BIOS systems via<br />
ISO_DEFAULT="boothd0" to boot from the first disk and<br />
ISO_DEFAULT="boothd1" to boot from the second disk.</p>
<p>For OUTPUT=USB the user can now explicitly specify<br />
what to boot by default when booting the disk on BIOS systems via<br />
USB_BIOS_BOOT_DEFAULT="boothd0" to boot from the first disk.<br />
The default USB_BIOS_BOOT_DEFAULT="" boots the second disk.</p>
<h4 id="jorman_commented_at_2019-11-15_1229"><img src="https://avatars.githubusercontent.com/u/5203988?v=4" width="50"><a href="https://github.com/Jorman">Jorman</a> commented at <a href="https://github.com/rear/rear/issues/2276#issuecomment-554341828">2019-11-15 12:29</a>:<a class="headerlink" href="#jorman_commented_at_2019-11-15_1229" title="Permanent link">&para;</a></h4>
<p>Wow, thanks!<br />
I'll do the same modification and I'll try out the results!</p>
<h4 id="jorman_commented_at_2019-11-21_2134"><img src="https://avatars.githubusercontent.com/u/5203988?v=4" width="50"><a href="https://github.com/Jorman">Jorman</a> commented at <a href="https://github.com/rear/rear/issues/2276#issuecomment-557282250">2019-11-21 21:34</a>:<a class="headerlink" href="#jorman_commented_at_2019-11-21_2134" title="Permanent link">&para;</a></h4>
<p>Hi, I tried but for now is not working like expected.<br />
I'm testing it on a headless systems so without monitor I can't say what
happen during boot.<br />
The only I can say now is that I made the modifications and then
<code>rear -v mkbackup</code><br />
How can I check where's the problem?<br />
Now the rear disk is not mounted (so if the system reboot start
normally) and this's my configuration</p>
<pre><code>$ lsblk
NAME          MAJ:MIN RM   SIZE RO TYPE  MOUNTPOINT
sda             8:0    0   1,8T  0 disk
└─sda1          8:1    0   1,8T  0 part  /data/Magia
sdb             8:16   0   3,7T  0 disk
└─sdb1          8:17   0   3,7T  0 part
  └─md0         9:0    0   3,7T  0 raid1
    ├─vg0-lv1 253:0    0  18,6G  0 lvm   /
    ├─vg0-lv0 253:1    0   2,9G  0 lvm   [SWAP]
    ├─vg0-lv2 253:2    0   4,7G  0 lvm   /home
    └─vg0-lv3 253:3    0   3,6T  0 lvm   /data
sdc             8:32   0   3,7T  0 disk
└─sdc1          8:33   0   3,7T  0 part
  └─md0         9:0    0   3,7T  0 raid1
    ├─vg0-lv1 253:0    0  18,6G  0 lvm   /
    ├─vg0-lv0 253:1    0   2,9G  0 lvm   [SWAP]
    ├─vg0-lv2 253:2    0   4,7G  0 lvm   /home
    └─vg0-lv3 253:3    0   3,6T  0 lvm   /data
sdd             8:48   0   1,8T  0 disk
└─sdd1          8:49   0   1,8T  0 part  /data/Sharing
sde             8:64   1   492M  0 disk
└─sde1          8:65   1   490M  0 part  /boot/efi
sdg             8:96   0 931,5G  0 disk
└─sdg1          8:97   0 931,5G  0 part

$ cat /etc/fstab
# /etc/fstab: static file system information.
#
# Use 'blkid' to print the universally unique identifier for a
# device; this may be used with UUID= as a more robust way to name devices
# that works even if disks are added and removed. See fstab(5).
#
# &lt;file system&gt; &lt;mount point&gt;   &lt;type&gt;  &lt;options&gt;       &lt;dump&gt;  &lt;pass&gt;
/dev/mapper/vg0-lv1 /               ext4    errors=remount-ro 0       1
# /boot/efi was on /dev/sdc1 during installation
UUID=4BA7-208C  /boot/efi       vfat    umask=0077      0       1
/dev/mapper/vg0-lv3 /data           ext4    nosuid,user_xattr 0       2
/dev/mapper/vg0-lv2 /home           ext4    defaults        0       2
/dev/mapper/vg0-lv0 none            swap    sw              0       0
UUID=3624EB3324EAF531 /data/Magia ntfs auto,nosuid,user_xattr,nofail 0       2
UUID=F00473F20473BA64 /data/Travel ntfs auto,nosuid,user_xattr,nofail 0       2
UUID=0be8c5c6-84a2-4236-9337-c12f41024344 /data/Sharing ext4 defaults,nofail 0       2
</code></pre>
<p>Do you've some idea?</p>
<h4 id="jsmeix_commented_at_2019-11-26_1101"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2276#issuecomment-558578273">2019-11-26 11:01</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-11-26_1101" title="Permanent link">&para;</a></h4>
<p>@Jorman<br />
in your initial
<a href="https://github.com/rear/rear/issues/2276#issue-522490145">https://github.com/rear/rear/issues/2276#issue-522490145</a><br />
you wrote <code>bios</code><br />
but now I see in your<br />
<a href="https://github.com/rear/rear/issues/2276#issuecomment-557282250">https://github.com/rear/rear/issues/2276#issuecomment-557282250</a><br />
<code>/boot/efi</code></p>
<h4 id="jorman_commented_at_2019-11-26_1228"><img src="https://avatars.githubusercontent.com/u/5203988?v=4" width="50"><a href="https://github.com/Jorman">Jorman</a> commented at <a href="https://github.com/rear/rear/issues/2276#issuecomment-558607028">2019-11-26 12:28</a>:<a class="headerlink" href="#jorman_commented_at_2019-11-26_1228" title="Permanent link">&para;</a></h4>
<p>You right, my mistake, I get used to call it always bios, but is not the
same!<br />
Sorry if this caused some confusion to you, was not my intent<br />
The machine has an old bios uefi capable, I think is CSM function, but I
can't enter in bios anymore.<br />
My disk layout are GPT and the boot is from efi</p>
<pre><code>$ ls -lah /boot
totale 50M
drwxr-xr-x  4 root root 4,0K nov 17 06:42 .
drwxr-xr-x 19 root root 4,0K nov 24 09:13 ..
-rw-r--r--  1 root root 202K nov 11 01:30 config-4.19.0-6-amd64
drwx------  3 root root 4,0K gen  1  1970 efi
drwxr-xr-x  5 root root 4,0K nov 14 06:59 grub
-rw-r--r--  1 root root  42M nov 17 06:42 initrd.img-4.19.0-6-amd64
-rw-r--r--  1 root root 3,3M nov 11 01:30 System.map-4.19.0-6-amd64
-rw-r--r--  1 root root 5,1M nov 11 01:30 vmlinuz-4.19.0-6-amd64

# root @ Qnap in ~ [13:13:47]
$ ls /sys/firmware/efi
config_table  efivars  fw_platform_size  fw_vendor  runtime  runtime-map  systab  vars
</code></pre>
<p>This's the rear log after the last run, on 24-11-2019, when I did the
modification<br />
<a href="https://pastebin.com/JdxK4dAQ">https://pastebin.com/JdxK4dAQ</a></p>
<p>Do you think is possible to make it work?</p>
<h4 id="pcahyna_commented_at_2019-11-26_1302"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/2276#issuecomment-558618455">2019-11-26 13:02</a>:<a class="headerlink" href="#pcahyna_commented_at_2019-11-26_1302" title="Permanent link">&para;</a></h4>
<p>Cc @chlupnoha</p>
<h4 id="jsmeix_commented_at_2019-11-26_1359"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2276#issuecomment-558641223">2019-11-26 13:59</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-11-26_1359" title="Permanent link">&para;</a></h4>
<p>@Jorman<br />
to avoid confusion I recommend to use the word <code>BIOS</code><br />
only if you mean the legacy firmware in PC architecture<br />
and also when you use the firmware in legacy BIOS mode<br />
but the word <code>EFI</code> or <code>UEFI</code> if you mean nowadays firmware<br />
that you use in its native way (i.e. as [U]EFI bootloader)<br />
and the word <code>firmware</code> as generic name for such kind of software.<br />
There is no such thing as BIOS that is UEFI capable<br />
(old BIOS does not support [U]EFI) but there is firmware<br />
that supports UEFI but can also run in legacy BIOS mode.</p>
<p>I do not know sufficiently about how the<br />
recovery system UEFI bootloader setup<br />
during "rear mkrescue" actually works<br />
(I am one of those who avoid [U]EFI as much as possible)<br />
so I cannot really help with recovery system UEFI bootloader issues.</p>
<p>The following scripts that are run during "rear mkrescue"<br />
are the "usual suspects" for recovery system UEFI bootloader setup<br />
in case of <code>OUTPUT=USB</code></p>
<pre><code># usr/sbin/rear -s mkrescue | grep -i efi | egrep -vi 'efistub|prefix'

Source prep/default/320_include_uefi_env.sh
Source prep/default/330_include_uefi_tools.sh
Source rescue/default/850_save_sysfs_uefi_vars.sh
Source output/USB/Linux-i386/100_create_efiboot.sh
</code></pre>
<p>I would first of all have a look at<br />
usr/share/rear/output/USB/Linux-i386/100_create_efiboot.sh<br />
<a href="https://raw.githubusercontent.com/rear/rear/master/usr/share/rear/output/USB/Linux-i386/100_create_efiboot.sh">https://raw.githubusercontent.com/rear/rear/master/usr/share/rear/output/USB/Linux-i386/100_create_efiboot.sh</a></p>
<p>To see what that scripts actually do run "rear mkrescue"<br />
with full debugging i.e. run <code>rear -D mkrescue</code><br />
and inspect the log file.</p>
<p>Furthermore regarding UEFI boot with <code>OUTPUT=USB</code><br />
you must have your ReaR recovery system [USB]-disk prepared<br />
for UEFI with the appropriate "rear format" workflow call, cf.<br />
<a href="https://github.com/rear/rear/issues/2275#issuecomment-553802315">https://github.com/rear/rear/issues/2275#issuecomment-553802315</a><br />
the right "rear format" command is also mentioned in<br />
<a href="https://github.com/rear/rear/blob/master/usr/share/rear/output/USB/Linux-i386/100_create_efiboot.sh#L2">https://github.com/rear/rear/blob/master/usr/share/rear/output/USB/Linux-i386/100_create_efiboot.sh#L2</a></p>
<p>FYI<br />
for comparison the "usual suspects" scripts for recovery system<br />
UEFI bootloader setup in case of <code>OUTPUT=ISO</code>:</p>
<pre><code># usr/sbin/rear -s mkrescue | grep -i efi | egrep -vi 'efistub|prefix'

Source prep/default/320_include_uefi_env.sh
Source prep/default/330_include_uefi_tools.sh
Source rescue/default/850_save_sysfs_uefi_vars.sh
Source output/ISO/Linux-i386/250_populate_efibootimg.sh
Source output/ISO/Linux-i386/700_create_efibootimg.sh
</code></pre>
<h4 id="jsmeix_commented_at_2019-11-26_1400"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2276#issuecomment-558641624">2019-11-26 14:00</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-11-26_1400" title="Permanent link">&para;</a></h4>
<p>@gozora<br />
perhaps you could have a look here - as time permits ?</p>
<h4 id="jorman_commented_at_2019-11-26_2147"><img src="https://avatars.githubusercontent.com/u/5203988?v=4" width="50"><a href="https://github.com/Jorman">Jorman</a> commented at <a href="https://github.com/rear/rear/issues/2276#issuecomment-558831331">2019-11-26 21:47</a>:<a class="headerlink" href="#jorman_commented_at_2019-11-26_2147" title="Permanent link">&para;</a></h4>
<p>@jsmeix<br />
Understood!<br />
I remember I had to use the <code>rear format -- --efi /dev/sdX</code><br />
In this case sdh is the rear disk</p>
<pre><code>$ lsblk
NAME          MAJ:MIN RM   SIZE RO TYPE  MOUNTPOINT
sda             8:0    0   1,8T  0 disk
└─sda1          8:1    0   1,8T  0 part  /data/Magia
sdb             8:16   0   3,7T  0 disk
└─sdb1          8:17   0   3,7T  0 part
  └─md0         9:0    0   3,7T  0 raid1
    ├─vg0-lv1 253:0    0  18,6G  0 lvm   /
    ├─vg0-lv0 253:1    0   2,9G  0 lvm   [SWAP]
    ├─vg0-lv2 253:2    0   4,7G  0 lvm   /home
    └─vg0-lv3 253:3    0   3,6T  0 lvm   /data
sdc             8:32   0   3,7T  0 disk
└─sdc1          8:33   0   3,7T  0 part
  └─md0         9:0    0   3,7T  0 raid1
    ├─vg0-lv1 253:0    0  18,6G  0 lvm   /
    ├─vg0-lv0 253:1    0   2,9G  0 lvm   [SWAP]
    ├─vg0-lv2 253:2    0   4,7G  0 lvm   /home
    └─vg0-lv3 253:3    0   3,6T  0 lvm   /data
sdd             8:48   0   1,8T  0 disk
└─sdd1          8:49   0   1,8T  0 part  /data/Sharing
sde             8:64   1   492M  0 disk
└─sde1          8:65   1   490M  0 part  /boot/efi
sdg             8:96   0 931,5G  0 disk
└─sdg1          8:97   0 931,5G  0 part
sdh             8:112  0  55,9G  0 disk
├─sdh1          8:113  0   200M  0 part
└─sdh2          8:114  0  55,7G  0 part

Disk /dev/sdh: 55,9 GiB, 60022480384 bytes, 117231407 sectors
Disk model:  SV300S37A60G
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disklabel type: gpt
Disk identifier: CC8154D6-4121-4494-8E02-3ABE017A00C3

Dispositivo  Start      Fine   Settori  Size Tipo
/dev/sdh1    16384    425983    409600  200M EFI System
/dev/sdh2   425984 117229567 116803584 55,7G Linux filesystem
</code></pre>
<p>I'm not a programmer and rear is very new to me. I thought was only a
grub menu option to modify, because the rear disk works when I reboot
the system, but seem much complicated, sorry for that.<br />
I did the <code>rear -D mkrescue</code> command but I don't know if I really
understand all the log, I attach here the link of it maybe is more
helpful for you guys<br />
<a href="https://gofile.io/?c=zGnYLr">https://gofile.io/?c=zGnYLr</a></p>
<p>Do you think is better to point all to an ISO file?</p>
<h4 id="gozora_commented_at_2019-11-27_0701"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/2276#issuecomment-558958450">2019-11-27 07:01</a>:<a class="headerlink" href="#gozora_commented_at_2019-11-27_0701" title="Permanent link">&para;</a></h4>
<p>Hello @Jorman I don't think switching to ISO will help you. As far as I
know, Grub2 UEFI based boot-loaders don't option to boot either first or
second hard disk.<br />
I'll try to find a way how such entry could be added, but I have no ETA
for this.</p>
<p>V.</p>
<h4 id="jsmeix_commented_at_2019-11-27_0950"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2276#issuecomment-559013225">2019-11-27 09:50</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-11-27_0950" title="Permanent link">&para;</a></h4>
<p>From my limited end-user-only experience with UEFI booting<br />
I have the impression that the boot devices ordering<br />
is specified only in the UEFI firmware itself<br />
but not in a UEFI application like <code>BOOTX64.efi</code> that is created by<br />
usr/share/rear/output/USB/Linux-i386/100_create_efiboot.sh</p>
<p>By the way: I found<br />
<a href="https://www.happyassassin.net/2014/01/25/uefi-boot-how-does-that-actually-work-then/">https://www.happyassassin.net/2014/01/25/uefi-boot-how-does-that-actually-work-then/</a><br />
which is from 2014 but I assume it is still correct.</p>
<p>Therein I read about <code>The UEFI boot manager</code> and <code>efibootmgr</code><br />
which could be the right tool to specify the boot devices ordering<br />
because it has a <code>--bootorder</code> option that might be what is needed here?</p>
<p>As far as I see <code>efibootmgr</code> is called during "rear recover"<br />
when reinstalling the UEFI bootloader on the target system<br />
via finalize/Linux-i386/670_run_efibootmgr.sh<br />
and <code>efibootmgr</code> is also called during "rear mkrescue"<br />
when adding the <code>Relax-and-Recover</code> rescue system<br />
to the local UEFI booting on the original system<br />
via output/default/940_grub2_rescue.sh<br />
but <code>efibootmgr</code> is not called during "rear mkrescue"<br />
for the bootloader setup of the recovery system.</p>
<h4 id="gozora_commented_at_2019-11-27_0957"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/2276#issuecomment-559016101">2019-11-27 09:57</a>:<a class="headerlink" href="#gozora_commented_at_2019-11-27_0957" title="Permanent link">&para;</a></h4>
<p>@jsmeix Actually this is a very good point!<br />
@Jorman do you know that you can change your boot order from inside your
running OS using <code>efibotomgr</code>?</p>
<p>V.</p>
<h4 id="jsmeix_commented_at_2019-11-27_1028"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2276#issuecomment-559027871">2019-11-27 10:28</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-11-27_1028" title="Permanent link">&para;</a></h4>
<p>@gozora<br />
I think changing the (UEFI) boot devices ordering on the original
system<br />
is not something that ReaR should ever do (and never ever
automatically)<br />
in particular not something that should happen during "rear mkrescue"<br />
because "rear mkrescue/mkbackup" must not change anything<br />
on the currently running (original) system.</p>
<p>The GRUB_RESCUE stuff should stay the only (scaring) exception, cf.<br />
<a href="https://github.com/rear/rear/blob/master/usr/share/rear/conf/default.conf#L2585">https://github.com/rear/rear/blob/master/usr/share/rear/conf/default.conf#L2585</a></p>
<h4 id="gozora_commented_at_2019-11-27_1109"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/2276#issuecomment-559042339">2019-11-27 11:09</a>:<a class="headerlink" href="#gozora_commented_at_2019-11-27_1109" title="Permanent link">&para;</a></h4>
<p>@jsmeix I do agree!</p>
<p>That is why I've asked @Jorman in my
<a href="https://github.com/rear/rear/issues/2276#issuecomment-559016101">https://github.com/rear/rear/issues/2276#issuecomment-559016101</a>
do it manaully ;-)</p>
<p>V.</p>
<h4 id="jorman_commented_at_2019-11-27_1244"><img src="https://avatars.githubusercontent.com/u/5203988?v=4" width="50"><a href="https://github.com/Jorman">Jorman</a> commented at <a href="https://github.com/rear/rear/issues/2276#issuecomment-559072440">2019-11-27 12:44</a>:<a class="headerlink" href="#jorman_commented_at_2019-11-27_1244" title="Permanent link">&para;</a></h4>
<p>@jsmeix &amp; @gozora thank you both for your support, very much
appreciated!<br />
Actually my system is quite strange:<br />
I can't change the boot order from bios because I can't log into it
anymore.<br />
Is set to CSM capable, so I can boot from GPT EFI disks,<br />
efibotomgr is not working like expected, I think is a bug of my
firmware, so I need to fix the boot with this
<a href="https://wiki.debian.org/GrubEFIReinstall#Problem1:_Weak_EFI_implementation_only_recognizes_the_fallback_bootloader">https://wiki.debian.org/GrubEFIReinstall#Problem1:_Weak_EFI_implementation_only_recognizes_the_fallback_bootloader</a><br />
Whatever usb disk I attach to my system, in whatever position, if the
disk is bootable, take the precedence upon the main disk.</p>
<p>Let me know if I can make some log or test to better understand this</p>
<h4 id="gozora_commented_at_2019-11-27_2218"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/2276#issuecomment-559269612">2019-11-27 22:18</a>:<a class="headerlink" href="#gozora_commented_at_2019-11-27_2218" title="Permanent link">&para;</a></h4>
<p>After some experimenting with Grub2 features, I've successfully added
entry for booting OS original boot loader by chain loading it from ReaR
recovery system boot menu.</p>
<p>If all tests goes well, we could end up with something like:<br />
<img alt="Screenshot from 2019-11-27
22-19-35" src="https://user-images.githubusercontent.com/12116358/69762618-19307380-116b-11ea-86a8-b90f74ee1a08.png" /></p>
<p>@Jorman I'll have (hopefully) some basic code for testing ready during
next week (week 49) (last couple of months I'm very short on time),
guess you want to be volunteer for testing it? ;-)</p>
<p>V.</p>
<h4 id="jorman_commented_at_2019-11-27_2311"><img src="https://avatars.githubusercontent.com/u/5203988?v=4" width="50"><a href="https://github.com/Jorman">Jorman</a> commented at <a href="https://github.com/rear/rear/issues/2276#issuecomment-559281091">2019-11-27 23:11</a>:<a class="headerlink" href="#jorman_commented_at_2019-11-27_2311" title="Permanent link">&para;</a></h4>
<p>@gozora<br />
Yep, I can test if for you. For me is pretty simple, all the dirty and
hard work is made by all of you, many thanks for this! I would help but
I don't know if I can, there's a lot of code here!</p>
<h4 id="gozora_commented_at_2019-11-28_0724"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/2276#issuecomment-559373778">2019-11-28 07:24</a>:<a class="headerlink" href="#gozora_commented_at_2019-11-28_0724" title="Permanent link">&para;</a></h4>
<p>Hello @Jorman,</p>
<p>Don't worry, once the code is ready, all you will need to do is
download, install, run, reboot and post back your results.<br />
No coding or code review will be required from your site ;-).</p>
<p>I'll send you instructions what to do once I have it prepared.</p>
<p>V.</p>
<h4 id="jsmeix_commented_at_2019-11-28_0828"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2276#issuecomment-559391396">2019-11-28 08:28</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-11-28_0828" title="Permanent link">&para;</a></h4>
<p>@gozora<br />
WOW!</p>
<p>As "reward" for all your work here<br />
I even dared to assign this issue to you ;-)</p>
<h4 id="gozora_commented_at_2019-11-28_0838"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/2276#issuecomment-559394661">2019-11-28 08:38</a>:<a class="headerlink" href="#gozora_commented_at_2019-11-28_0838" title="Permanent link">&para;</a></h4>
<p>@jsmeix Thank you kind sir! ;-)</p>
<p>Should anybody be interested, this is the <a href="https://github.com/gozora/rear/tree/uefi_menu">repository with WIP
code</a>.</p>
<h4 id="jsmeix_commented_at_2019-11-28_1118"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2276#issuecomment-559453503">2019-11-28 11:18</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-11-28_1118" title="Permanent link">&para;</a></h4>
<p>@gozora<br />
in your
<a href="https://github.com/gozora/rear/tree/uefi_menu">https://github.com/gozora/rear/tree/uefi_menu</a><br />
there is for function create_grub2_cfg in lib/bootloader-functions.sh</p>
<pre><code>menuentry "Boot original system" {
    search --fs-uuid --no-floppy --set=root 78F9-F844
    chainloader (\$root)/EFI/sles_sap/shim.efi
    bla bla $UEFI_BOOTLOADER
    tst1: ${UEFI_BOOTLOADER#$(df $UEFI_BOOTLOADER | tail -n 1 | awk '{print $NF}')}
}
</code></pre>
<p>with a currently WIP hardcoded <code>chainloader</code> value.<br />
E.g. on my openSUSE Leap 15.0 system that is<br />
<code>/boot/efi/EFI/opensuse/shim.efi</code><br />
where the ESP is mounted on <code>/boot/efi</code>.</p>
<p>I suggest to make this value in any case a user config variable<br />
or does this <code>chainloader</code> value perhaps match the currrent<br />
UEFI_BOOTLOADER or SECURE_BOOT_BOOTLOADER values?</p>
<p>If this <code>chainloader</code> value can be different in some cases<br />
a separated user config variable like <code>UEFI_CHAINLOADER</code><br />
would be needed so that the user can enforce what he needs.</p>
<p>If empty ReaR could do some reasonable automatism or use<br />
a generic fallback value (e.g. <code>EFI/boot/bootx64.efi</code>) if possible<br />
but that is optional "nice to have" functionality.</p>
<h4 id="gozora_commented_at_2019-11-28_1145"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/2276#issuecomment-559462424">2019-11-28 11:45</a>:<a class="headerlink" href="#gozora_commented_at_2019-11-28_1145" title="Permanent link">&para;</a></h4>
<p>Hello @jsmeix I'm afraid that that only OS where this code currently
works is owned by me ;-). The values are hard coded because I did not
want to spend time with polishing and getting variables until I know
that my solution actually works ...</p>
<p>In other words <code>uefi_menu</code> branch is just a prototype that will be later
in process enhanced with something like:</p>
<pre><code>diff --git a/usr/share/rear/lib/bootloader-functions.sh b/usr/share/rear/lib/bootloader-functions.sh
index 07e7b517..f8b15e0f 100644
--- a/usr/share/rear/lib/bootloader-functions.sh
+++ b/usr/share/rear/lib/bootloader-functions.sh
@@ -487,6 +487,14 @@ function get_root_disk_UUID {
 function create_grub2_cfg {
 root_uuid=$(get_root_disk_UUID)

+# Get mount point where boot loader resides.
+#
+local esp_info=$(df $UEFI_BOOTLOADER | tail -n 1)
+local esp_mpt=$(echo $esp_info | awk '{print $NF}')
+local esp_disk=$(echo $esp_info | awk '{print $1}')
+local esp_relative_bootloader=${UEFI_BOOTLOADER#$esp_mpt}
+local esp_disk_uuid=$(lsblk --noheadings --output uuid $esp_disk)
+
 cat &lt;&lt; EOF
 set default="2"

@@ -521,11 +529,8 @@ menuentry "Relax-and-Recover (Secure Boot)"  --class gnu-linux --class gnu --cla
 }

 menuentry "Boot original system" {
-    search --fs-uuid --no-floppy --set=root 78F9-F844
-    chainloader (\$root)/EFI/sles_sap/shim.efi
-
-    bla bla $UEFI_BOOTLOADER
-    tst1: ${UEFI_BOOTLOADER#$(df $UEFI_BOOTLOADER | tail -n 1 | awk '{print $NF}')}
+    search --fs-uuid --no-floppy --set=root $esp_disk_uuid
+    chainloader (\$root)$esp_relative_bootloader
 }
</code></pre>
<p>and of course some explanatory comments ;-)</p>
<p>V.</p>
<h4 id="jsmeix_commented_at_2019-11-29_1335"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2276#issuecomment-559791942">2019-11-29 13:35</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-11-29_1335" title="Permanent link">&para;</a></h4>
<p>@gozora<br />
only an offhanded (totally untested) idea how to find out<br />
what EFI binary should be used by default or as fallback<br />
to boot the original system:</p>
<p>On my openSUSE Leap 15.0 system I get</p>
<pre><code># efibootmgr -v
BootCurrent: 0000
Timeout: 2 seconds
BootOrder: 0000,0016,0017,0014,001A,0012,0013,0015,0010
Boot0000* opensuse-secureboot   HD(1,GPT,841a03d5-4e52-4634-b21a-43935c88f5af,0x800,0xfa000)/File(\EFI\opensuse\shim.efi)
Boot0010  Diskette Drive        BBS(Floppy,Diskette Drive,0x0)..BO
...
</code></pre>
<p>I think <code>BootCurrent: 0000</code> shows how the<br />
currently running system was booted and its entry</p>
<pre><code>Boot0000* .../File(\EFI\opensuse\shim.efi)
</code></pre>
<p>shows the matching EFI binary <code>EFI\opensuse\shim.efi</code><br />
that was used to boot the currently running system.</p>
<p>This EFI binary appears in my currently running system<br />
as <code>/boot/efi/EFI/opensuse/shim.efi</code><br />
where the ESP is mounted on <code>/boot/efi</code> cf. my above<br />
<a href="https://github.com/rear/rear/issues/2276#issuecomment-559453503">https://github.com/rear/rear/issues/2276#issuecomment-559453503</a></p>
<p>So I think the <code>efibootmgr -v</code> output can be used to find out<br />
what EFI binary should be used by default or as fallback<br />
to boot the original system.</p>
<p>The idea behind is that "boot the original system" means<br />
"boot what was running while <code>rear mkrescue</code> was run"</p>
<h4 id="jsmeix_commented_at_2019-11-29_1340"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2276#issuecomment-559793552">2019-11-29 13:40</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-11-29_1340" title="Permanent link">&para;</a></h4>
<p>FYI<br />
I noticed right now that on my openSUSE Leap 15.0 system</p>
<pre><code># diff -s /boot/efi/EFI/opensuse/shim.efi /boot/efi/EFI/boot/bootx64.efi
Files /boot/efi/EFI/opensuse/shim.efi and /boot/efi/EFI/boot/bootx64.efi are identical
</code></pre>
<p>so that in my case even the generic<br />
UEFI firmware fallback <code>/EFI/boot/bootx64.efi</code><br />
would boot "the right thing".</p>
<h4 id="gozora_commented_at_2019-11-29_1905"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/2276#issuecomment-559865674">2019-11-29 19:05</a>:<a class="headerlink" href="#gozora_commented_at_2019-11-29_1905" title="Permanent link">&para;</a></h4>
<p>Hello @jsmeix,</p>
<p>What you see in your <code>efibootmgr -v</code> is just one case.<br />
It is very common case indeed, but by far not the only one.</p>
<p>Let me show you couple of other configurations:</p>
<p><strong>QEMU directly loaded by kernel and initrd options (no booloader
used)</strong><br />
<img alt="direct_kernel_initrd" src="https://user-images.githubusercontent.com/12116358/69885817-5ae22b00-12df-11ea-894e-05e2b49c6e93.png" /></p>
<p><strong>UEFI firmware defaults</strong><br />
When you don't have any UEFI boot entry present, UEFI looks for boot
loader in some default locations. If you name your boot loader
<em>bootx64.efi</em> and place it under _\EFI\BOOT_ it will be loaded
without need of any boot entry in UEFI menu. Once server is up, your
<code>efibootmgr -v</code> will look something like:<br />
<img alt="boot_bootx64" src="https://user-images.githubusercontent.com/12116358/69886011-3dfa2780-12e0-11ea-8546-4fb146f20a46.png" /></p>
<p><strong>Chainload</strong><br />
If you decide to boot your system using Grub2 chainloading (e.g. you
don't have boot loader installed directly on your OS disk, but e.g. on
some other device), You might get something like this:<br />
<img alt="Screenshot from 2019-11-29
19-37-41" src="https://user-images.githubusercontent.com/12116358/69886084-93cecf80-12e0-11ea-8377-b5178de66fa9.png" /></p>
<p><strong>startup.nsh / Internal Shell</strong><br />
If you might have trouble like I do with VirbualBox, which doesn't
remember UEFI boot entries when machine is power cycled, you might
either use <em>UEFI firmware defaults</em> or automatic startup file called
<em>startup.nsh</em> which when placed into ESP top directory will be executed
and boot what every your hart desires. I'm using <em>startup.nsh</em> to
EFISTUB boot my Arch:</p>
<pre><code>arch-efi:(/boot)(root)# cat startup.nsh 
fs0:
vmlinuz-linux initrd=initramfs-linux.img root=PARTUUID="cd4e03d7-40ac-4a67-b271-4e885edf4b3f"
</code></pre>
<p>In this scenario your <code>efibootmgr -v</code> will show:<br />
<img alt="Screenshot from 2019-11-29
19-54-23" src="https://user-images.githubusercontent.com/12116358/69886412-1efc9500-12e2-11ea-95c8-685de911c590.png" /></p>
<p><strong>efivarfs</strong> not mounted<br />
Another issue we might meet is <em>efivarfs</em> not mouted, in this case you
will get plain:</p>
<pre><code>arch-efi:(/root)(root)# efibootmgr -v
EFI variables are not supported on this system.
</code></pre>
<p>As you can see, it is not that easy to find out how was your system
booted.</p>
<p>I've decided to look for the boot loader with simplest idea that came to
my mind, using ReaRs UEFI_BOOTLOADER variable. Using this approach we
will have both consistency, and user can override this value if needed,
hence user will have the final power ;-).</p>
<p>V.</p>
<h4 id="jorman_commented_at_2019-11-29_2059"><img src="https://avatars.githubusercontent.com/u/5203988?v=4" width="50"><a href="https://github.com/Jorman">Jorman</a> commented at <a href="https://github.com/rear/rear/issues/2276#issuecomment-559879836">2019-11-29 20:59</a>:<a class="headerlink" href="#jorman_commented_at_2019-11-29_2059" title="Permanent link">&para;</a></h4>
<p>If can in someway help, here my efibootmgr:</p>
<pre><code>$ efibootmgr -v
BootCurrent: 0015
Timeout: 0 seconds
BootOrder: 0015,001A,001B,0016,0017,0018,001C,001D,001E,001F,0020,0021
Boot000A* ATA HDD2:     VenMsg(bc7838d2-0f82-4d60-8316-c068ee79d25b,91af625956449f41a7b91f4f892ab0f602)
Boot000B* ATA HDD3:     VenMsg(bc7838d2-0f82-4d60-8316-c068ee79d25b,91af625956449f41a7b91f4f892ab0f603)
Boot000C* ATA HDD4:     VenMsg(bc7838d2-0f82-4d60-8316-c068ee79d25b,91af625956449f41a7b91f4f892ab0f604)
Boot000D* ATA HDD5:     VenMsg(bc7838d2-0f82-4d60-8316-c068ee79d25b,91af625956449f41a7b91f4f892ab0f605)
Boot000E* Other HDD:    VenMsg(bc7838d2-0f82-4d60-8316-c068ee79d25b,91af625956449f41a7b91f4f892ab0f609)
Boot000F* Internal Shell        FvFile(c57ad6b7-0515-40a8-9d21-551652854e37)
Boot0010* ATA HDD       VenMsg(bc7838d2-0f82-4d60-8316-c068ee79d25b,91af625956449f41a7b91f4f892ab0f6)
Boot0011* Boot Next Boot Option VenMsg(bc7838d2-0f82-4d60-8316-c068ee79d25b,a7ca6d35b2c2684783721826a7404894)
Boot0012  Setup FvFile(721c8b66-426c-4e86-8e99-3457c46ab0b9)
Boot0013  Boot Menu     FvFile(86488440-41bb-42c7-93ac-450fbf7766bf)
Boot0014  Diagnostic Splash     FvFile(a7d8d9a6-6ab0-4aeb-ad9d-163e59a7a380)
Boot0015* USB HDD:      VenMsg(bc7838d2-0f82-4d60-8316-c068ee79d25b,33e821aaaf33bc4789bd419f88c50803)
Boot0016* USB CD:       VenMsg(bc7838d2-0f82-4d60-8316-c068ee79d25b,86701296aa5a7848b66cd49dd3ba6a55)
Boot0017* USB FDD:      VenMsg(bc7838d2-0f82-4d60-8316-c068ee79d25b,6ff015a28830b543a8b8641009461e49)
Boot0018* ATAPI CD:     VenMsg(bc7838d2-0f82-4d60-8316-c068ee79d25b,aea2090adfde214e8b3a5e471856a354)
Boot0019* CD-ROM:       VenMsg(bc7838d2-0f82-4d60-8316-c068ee79d25b,be9d0102e211f3489efa0b983c96839b)
Boot001A* ATA HDD0:     VenMsg(bc7838d2-0f82-4d60-8316-c068ee79d25b,91af625956449f41a7b91f4f892ab0f600)
Boot001B* ATA HDD1:     VenMsg(bc7838d2-0f82-4d60-8316-c068ee79d25b,91af625956449f41a7b91f4f892ab0f601)
Boot001C* ATA HDD2:     VenMsg(bc7838d2-0f82-4d60-8316-c068ee79d25b,91af625956449f41a7b91f4f892ab0f602)
Boot001D* ATA HDD3:     VenMsg(bc7838d2-0f82-4d60-8316-c068ee79d25b,91af625956449f41a7b91f4f892ab0f603)
Boot001E* ATA HDD4:     VenMsg(bc7838d2-0f82-4d60-8316-c068ee79d25b,91af625956449f41a7b91f4f892ab0f604)
Boot001F* ATA HDD5:     VenMsg(bc7838d2-0f82-4d60-8316-c068ee79d25b,91af625956449f41a7b91f4f892ab0f605)
Boot0020* Other HDD:    VenMsg(bc7838d2-0f82-4d60-8316-c068ee79d25b,91af625956449f41a7b91f4f892ab0f609)
Boot0021* Internal Shell        FvFile(c57ad6b7-0515-40a8-9d21-551652854e37)
Boot0022* ATA HDD       VenMsg(bc7838d2-0f82-4d60-8316-c068ee79d25b,91af625956449f41a7b91f4f892ab0f6)
Boot0023* Boot Next Boot Option VenMsg(bc7838d2-0f82-4d60-8316-c068ee79d25b,a7ca6d35b2c2684783721826a7404894)
</code></pre>
<h4 id="jorman_commented_at_2019-11-29_2259"><img src="https://avatars.githubusercontent.com/u/5203988?v=4" width="50"><a href="https://github.com/Jorman">Jorman</a> commented at <a href="https://github.com/rear/rear/issues/2276#issuecomment-559891977">2019-11-29 22:59</a>:<a class="headerlink" href="#jorman_commented_at_2019-11-29_2259" title="Permanent link">&para;</a></h4>
<p>@gozora<br />
Maybe is a stupid idea or is not relevant, I'll try to explain to you.<br />
We know the disk-id where rear create the emergency disk, so, is not
possible to set the boot loader in order to skip the same (rear) disk-id
during boot? In this way when the system boot-up and the boot loader
find the same disk id, after X seconds without any key pressed, skip to
very nexrt boot</p>
<p>Is so stupid</p>
<h4 id="gozora_commented_at_2019-11-30_0850"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/2276#issuecomment-559929063">2019-11-30 08:50</a>:<a class="headerlink" href="#gozora_commented_at_2019-11-30_0850" title="Permanent link">&para;</a></h4>
<p>Hello @Jorman it is not stupid idea ;-). I already have working
prototype ready. It however need some polishing. But if you want you can
try it <a href="https://github.com/gozora/rear/tree/uefi_menu?files=1">here</a>.</p>
<p>V.</p>
<h4 id="jorman_commented_at_2019-12-02_1235"><img src="https://avatars.githubusercontent.com/u/5203988?v=4" width="50"><a href="https://github.com/Jorman">Jorman</a> commented at <a href="https://github.com/rear/rear/issues/2276#issuecomment-560377862">2019-12-02 12:35</a>:<a class="headerlink" href="#jorman_commented_at_2019-12-02_1235" title="Permanent link">&para;</a></h4>
<p>@gozora<br />
I can try if you think is the time to make some test<br />
Just let me know if I have to make particular installation or some
extra.</p>
<p>J</p>
<h4 id="gozora_commented_at_2019-12-07_1124"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/2276#issuecomment-562842362">2019-12-07 11:24</a>:<a class="headerlink" href="#gozora_commented_at_2019-12-07_1124" title="Permanent link">&para;</a></h4>
<p>Hello @Jorman,</p>
<p>If you are still interested, you can test the code in my <a href="https://github.com/gozora/rear/tree/uefi_menu">uefi_menu
branch</a> whether it helps
to solve problem of yours.</p>
<p>In general you need to:</p>
<ol>
<li>download code from mentioned branch</li>
<li>install it</li>
<li>add <code>GRUB2_DEFAULT_BOOT="2"</code> to your <em>/etc/rear/local.conf</em> or
    <em>/etc/rear/site.conf</em> (this will make boot your original system as
    default when UEFI launches ReaR recovery system from your USB disk)</li>
<li>trigger <code>rear mkbackup</code> (or at least <code>rear mkrescue</code>) to refresh
    data in your current ReaR recovery system</li>
<li>reboot your system to see if all works as expected</li>
<li>post the results here</li>
</ol>
<p>Good luck with your tests!</p>
<p>V.</p>
<h4 id="gozora_commented_at_2019-12-07_1132"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/2276#issuecomment-562843028">2019-12-07 11:32</a>:<a class="headerlink" href="#gozora_commented_at_2019-12-07_1132" title="Permanent link">&para;</a></h4>
<p>@Jorman<br />
In general your Grub2 menu, (when installed from mentioned branch)
should look something like this:<br />
<img alt="Screenshot from 2019-12-07
12-29-46" src="https://user-images.githubusercontent.com/12116358/70373918-72c43b00-18ed-11ea-8736-89dcc1458ce1.png" /></p>
<p>V.</p>
<h4 id="jorman_commented_at_2019-12-07_1324"><img src="https://avatars.githubusercontent.com/u/5203988?v=4" width="50"><a href="https://github.com/Jorman">Jorman</a> commented at <a href="https://github.com/rear/rear/issues/2276#issuecomment-562851086">2019-12-07 13:24</a>:<a class="headerlink" href="#jorman_commented_at_2019-12-07_1324" title="Permanent link">&para;</a></h4>
<p>Hi @gozora<br />
Yep, I'm interested in this modification, in this way I can better
handle all and leave the recovery disk always attached, so with
duplicati that save extra data I can have more protection!<br />
I'll make like you said, and I'll report results.</p>
<p>Thanks in advance!</p>
<h4 id="jorman_commented_at_2019-12-08_1440"><img src="https://avatars.githubusercontent.com/u/5203988?v=4" width="50"><a href="https://github.com/Jorman">Jorman</a> commented at <a href="https://github.com/rear/rear/issues/2276#issuecomment-562955285">2019-12-08 14:40</a>:<a class="headerlink" href="#jorman_commented_at_2019-12-08_1440" title="Permanent link">&para;</a></h4>
<p>@gozora<br />
I did the test but I got some error, here what I did:</p>
<ol>
<li>Clone your repo (root folder)</li>
<li>Switch to uefi_menu branch</li>
<li>Copy the old configuration and add <code>GRUB2_DEFAULT_BOOT="2"</code></li>
<li>Use the <code>usr/sbin/rear format -- --efi /dev/sdh</code></li>
<li>Use <code>usr/sbin/rear -v mkbackup</code></li>
</ol>
<p>Note that I worked inside /root/rear folder, the one where I cloned your
repo, maybe was not a good idea?</p>
<p>The configuration:</p>
<pre><code># Default is to create Relax-and-Recover rescue media as ISO image
# set OUTPUT to change that
# set BACKUP to activate an automated (backup and) restore of your data
# Possible configuration values can be found in /usr/share/rear/conf/default.conf
#
# This file (local.conf) is intended for manual configuration. For configuration
# through packages and other automated means we recommend creating a new
# file named site.conf next to this file and to leave the local.conf as it is. 
# Our packages will never ship with a site.conf.
### write the rescue initramfs to USB and update the USB bootloader
OUTPUT=USB
#OUTPUT=OBDR
#ISO_DEFAULT="boothd1"
GRUB2_DEFAULT_BOOT="2"
### create a backup using the internal NETFS method, using 'tar'
BACKUP=NETFS
### write both rescue image and backup to the device labeled REAR-000
BACKUP_URL=usb:///dev/disk/by-label/REAR-000
### Exclude certain items
EXCLUDE_MOUNTPOINTS=( /data )
</code></pre>
<p>The logs:<br />
<a href="https://pastebin.com/WkGhPuQw">https://pastebin.com/WkGhPuQw</a><br />
<a href="https://pastebin.com/ypWrCkrC">https://pastebin.com/ypWrCkrC</a></p>
<p>What I did wrong?</p>
<h4 id="gozora_commented_at_2019-12-08_1832"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/2276#issuecomment-562978358">2019-12-08 18:32</a>:<a class="headerlink" href="#gozora_commented_at_2019-12-08_1832" title="Permanent link">&para;</a></h4>
<p>Your backup failed because some problem with <code>openssl</code>:</p>
<pre><code>ERROR: openssl failed with return code 1 and below output:
</code></pre>
<p>Which is strange because <code>openssl</code> is used for encryption of archive,
which is not happening according provided config file.</p>
<p>Can you run <code>rear -d -D mkbackup</code> and attach it to this thread ?</p>
<p>Thanks</p>
<p>V.</p>
<h4 id="jorman_commented_at_2019-12-08_2124"><img src="https://avatars.githubusercontent.com/u/5203988?v=4" width="50"><a href="https://github.com/Jorman">Jorman</a> commented at <a href="https://github.com/rear/rear/issues/2276#issuecomment-562995928">2019-12-08 21:24</a>:<a class="headerlink" href="#jorman_commented_at_2019-12-08_2124" title="Permanent link">&para;</a></h4>
<p>Yep, sure, here the entire log file<br />
<a href="https://filebin.net/gdini86jaesuhp55">https://filebin.net/gdini86jaesuhp55</a></p>
<p>I don't know why this error</p>
<h4 id="gozora_commented_at_2019-12-08_2144"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/2276#issuecomment-562998472">2019-12-08 21:44</a>:<a class="headerlink" href="#gozora_commented_at_2019-12-08_2144" title="Permanent link">&para;</a></h4>
<p>@Jorman 2 things</p>
<ol>
<li>You can attach files directly to github issue by dragndrop (some
    people might not feel safe to click third party links ...)</li>
<li>Problem described in your last log is different from previous one:</li>
</ol>
<p>original issue:</p>
<pre><code>2019-12-07 23:34:54.512145979 ERROR: openssl failed with return code 1 and below output:
</code></pre>
<p>current issue:</p>
<pre><code> mkdir: cannot create directory '\''/tmp/rear.4GjUebHeM9fPWuH/outputfs/rear/Qnap/20191208.2033'\'': No space left on device'
</code></pre>
<p>So try to cleanup some space on your USB disk and try to re-run
<code>rear -d -D mkbackup</code> ...</p>
<p>V.</p>
<h4 id="jorman_commented_at_2019-12-09_1238"><img src="https://avatars.githubusercontent.com/u/5203988?v=4" width="50"><a href="https://github.com/Jorman">Jorman</a> commented at <a href="https://github.com/rear/rear/issues/2276#issuecomment-563219241">2019-12-09 12:38</a>:<a class="headerlink" href="#jorman_commented_at_2019-12-09_1238" title="Permanent link">&para;</a></h4>
<p>Yep, you right, I don't know if a large file can be attached here, I'll
try</p>
<p>I just noticed that all the space is used to make the backup, but is
wrong, my configuration is set to exclude /data<br />
<code>EXCLUDE_MOUNTPOINTS=( /data )</code><br />
But to me seems that don't include all the folder inside, so I modified
it<br />
<code>EXCLUDE_MOUNTPOINTS=( /data/* )</code><br />
But again all the space is used!<br />
I think openssl don't is the problem, the problem is that the space
ends<br />
An extract of the log say:</p>
<pre><code>+ Debug 'Leaving debugscript mode (back to previous bash flags and options settings).'
+ test 1
+ Log 'Leaving debugscript mode (back to previous bash flags and options settings).'
+ echo '2019-12-08 23:52:03.344505773 Leaving debugscript mode (back to previous bash flags and options settings).'
2019-12-08 23:52:03.344505773 Leaving debugscript mode (back to previous bash flags and options settings).
2019-12-08 23:52:03.364982424 Including backup/NETFS/default/400_create_include_exclude_files.sh
2019-12-08 23:52:03.370581968 Entering debugscript mode via 'set -x'.
+ source /root/rear/usr/share/rear/backup/NETFS/default/400_create_include_exclude_files.sh
++ is_true no
++ case "$1" in
++ return 1
++ '[' NO '!=' YES ']'
++ read mountpoint device junk
++ IsInArray / /data/Download /data/Fanny /data/Jorman /data/Magia /data/Multimedia /data/Sharing /data/Travel /data/Varie /data/lost+found
++ return 1
++ echo /
++ read mountpoint device junk
++ IsInArray /home /data/Download /data/Fanny /data/Jorman /data/Magia /data/Multimedia /data/Sharing /data/Travel /data/Varie /data/lost+found
++ return 1
++ echo /home
++ read mountpoint device junk
++ IsInArray /data /data/Download /data/Fanny /data/Jorman /data/Magia /data/Multimedia /data/Sharing /data/Travel /data/Varie /data/lost+found
++ return 1
++ echo /data
++ read mountpoint device junk
++ IsInArray /boot/efi /data/Download /data/Fanny /data/Jorman /data/Magia /data/Multimedia /data/Sharing /data/Travel /data/Varie /data/lost+found
++ return 1
++ echo /boot/efi
++ read mountpoint device junk
++ for backup_exclude_item in "${BACKUP_PROG_EXCLUDE[@]}"
++ test '/tmp/*'
++ echo '/tmp/*'
++ for backup_exclude_item in "${BACKUP_PROG_EXCLUDE[@]}"
++ test '/dev/shm/*'
++ echo '/dev/shm/*'
++ for backup_exclude_item in "${BACKUP_PROG_EXCLUDE[@]}"
++ test '/root/rear/var/lib/rear/output/*'
++ echo '/root/rear/var/lib/rear/output/*'
++ for backup_exclude_item in "${BACKUP_PROG_EXCLUDE[@]}"
++ test /tmp/rear.WMvH8jK4z0EGQNM
++ echo /tmp/rear.WMvH8jK4z0EGQNM
++ is_true no
++ case "$1" in
++ return 1
++ for excluded_mountpoint in "${EXCLUDE_MOUNTPOINTS[@]}"
++ test /data/Download
++ echo /data/Download/
++ for excluded_mountpoint in "${EXCLUDE_MOUNTPOINTS[@]}"
++ test /data/Fanny
++ echo /data/Fanny/
++ for excluded_mountpoint in "${EXCLUDE_MOUNTPOINTS[@]}"
++ test /data/Jorman
++ echo /data/Jorman/
++ for excluded_mountpoint in "${EXCLUDE_MOUNTPOINTS[@]}"
++ test /data/Magia
++ echo /data/Magia/
++ for excluded_mountpoint in "${EXCLUDE_MOUNTPOINTS[@]}"
++ test /data/Multimedia
++ echo /data/Multimedia/
++ for excluded_mountpoint in "${EXCLUDE_MOUNTPOINTS[@]}"
++ test /data/Sharing
++ echo /data/Sharing/
++ for excluded_mountpoint in "${EXCLUDE_MOUNTPOINTS[@]}"
++ test /data/Travel
++ echo /data/Travel/
++ for excluded_mountpoint in "${EXCLUDE_MOUNTPOINTS[@]}"
++ test /data/Varie
++ echo /data/Varie/
++ for excluded_mountpoint in "${EXCLUDE_MOUNTPOINTS[@]}"
++ test /data/lost+found
++ echo /data/lost+found/
+ source_return_code=0
+ test 0 -eq 0
+ test 1
+ Debug 'Leaving debugscript mode (back to previous bash flags and options settings).'
+ test 1
+ Log 'Leaving debugscript mode (back to previous bash flags and options settings).'
+ echo '2019-12-08 23:52:03.411715609 Leaving debugscript mode (back to previous bash flags and options settings).'
2019-12-08 23:52:03.411715609 Leaving debugscript mode (back to previous bash flags and options settings).
2019-12-08 23:52:03.431887668 Including backup/NETFS/default/500_make_backup.sh
2019-12-08 23:52:03.437417650 Entering debugscript mode via 'set -x'.
+ source /root/rear/usr/share/rear/backup/NETFS/default/500_make_backup.sh
+++ url_scheme usb:///dev/disk/by-label/REAR-000
+++ local url=usb:///dev/disk/by-label/REAR-000
</code></pre>
<p>To me seems all ok, but I don't know why the backup is too big</p>
<pre><code>$ lsblk
NAME          MAJ:MIN RM   SIZE RO TYPE  MOUNTPOINT
sda             8:0    0   1,8T  0 disk
└─sda1          8:1    0   1,8T  0 part  /data/Magia
sdb             8:16   0   3,7T  0 disk
└─sdb1          8:17   0   3,7T  0 part
  └─md0         9:0    0   3,7T  0 raid1
    ├─vg0-lv1 253:0    0  18,6G  0 lvm   /
    ├─vg0-lv0 253:1    0   2,9G  0 lvm   [SWAP]
    ├─vg0-lv2 253:2    0   4,7G  0 lvm   /home
    └─vg0-lv3 253:3    0   3,6T  0 lvm   /data
sdc             8:32   0   3,7T  0 disk
└─sdc1          8:33   0   3,7T  0 part
  └─md0         9:0    0   3,7T  0 raid1
    ├─vg0-lv1 253:0    0  18,6G  0 lvm   /
    ├─vg0-lv0 253:1    0   2,9G  0 lvm   [SWAP]
    ├─vg0-lv2 253:2    0   4,7G  0 lvm   /home
    └─vg0-lv3 253:3    0   3,6T  0 lvm   /data
sdd             8:48   0   1,8T  0 disk
└─sdd1          8:49   0   1,8T  0 part  /data/Sharing
sde             8:64   1   492M  0 disk
└─sde1          8:65   1   490M  0 part  /boot/efi
sdf             8:80   0 931,5G  0 disk
└─sdf1          8:81   0 931,5G  0 part  /data/Travel
sdg             8:96   0  55,9G  0 disk
├─sdg1          8:97   0   400M  0 part
└─sdg2          8:98   0  55,5G  0 part
</code></pre>
<p>At this time sdg is the read disk and like you can see I want to exclude
all inside /data<br />
I attach the log here.</p>
<p>I make some error but I don't know where.</p>
<p>J<br />
<a href="https://github.com/rear/rear/files/3939613/rear-Qnap.zip">rear-Qnap.zip</a></p>
<h4 id="gozora_commented_at_2019-12-09_1405"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/2276#issuecomment-563253220">2019-12-09 14:05</a>:<a class="headerlink" href="#gozora_commented_at_2019-12-09_1405" title="Permanent link">&para;</a></h4>
<p>You can try:</p>
<pre><code>BACKUP_PROG_EXCLUDE=(
     ${BACKUP_PROG_EXCLUDE[@]}
     /data
)
</code></pre>
<p>V.</p>
<h4 id="jorman_commented_at_2019-12-09_2031"><img src="https://avatars.githubusercontent.com/u/5203988?v=4" width="50"><a href="https://github.com/Jorman">Jorman</a> commented at <a href="https://github.com/rear/rear/issues/2276#issuecomment-563424414">2019-12-09 20:31</a>:<a class="headerlink" href="#jorman_commented_at_2019-12-09_2031" title="Permanent link">&para;</a></h4>
<p>Now seems to work!<br />
I created the backup, I think without error, I attach the log file
here.<br />
I rebooted and the system is started normally, so seems to work!<br />
I don't have a monitor attached, if you need I can borrow a monitor and
try with it<br />
<a href="https://github.com/rear/rear/files/3941616/rear-Qnap.log">rear-Qnap.log</a></p>
<h4 id="gozora_commented_at_2019-12-09_2100"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/2276#issuecomment-563436488">2019-12-09 21:00</a>:<a class="headerlink" href="#gozora_commented_at_2019-12-09_2100" title="Permanent link">&para;</a></h4>
<p>Hello @Jorman,</p>
<p>I personally don't need any further confirmations, but if I were you,
I'd try it just to be sure that you can rely on such setup...</p>
<p>I'll try to put fixing code to ReaR upstream after
<a href="https://github.com/rear/rear/pull/2293">https://github.com/rear/rear/pull/2293</a>
is merged, since they are kind of related. Until that time you can keep
using version downloaded from
<a href="https://github.com/gozora/rear/tree/uefi_menu">https://github.com/gozora/rear/tree/uefi_menu</a>.</p>
<p>@jsmeix @gdha please keep this issue open. I think that first we should
deal with #2293 and afterwards I'll create PR to fix this problem.</p>
<p>V.</p>
<h4 id="jorman_commented_at_2019-12-09_2144"><img src="https://avatars.githubusercontent.com/u/5203988?v=4" width="50"><a href="https://github.com/Jorman">Jorman</a> commented at <a href="https://github.com/rear/rear/issues/2276#issuecomment-563453882">2019-12-09 21:44</a>:<a class="headerlink" href="#jorman_commented_at_2019-12-09_2144" title="Permanent link">&para;</a></h4>
<p>Ok! Many thanks I'll make some extra test to see if all works correctly!</p>
<h4 id="gozora_commented_at_2020-03-17_1806"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/2276#issuecomment-600218646">2020-03-17 18:06</a>:<a class="headerlink" href="#gozora_commented_at_2020-03-17_1806" title="Permanent link">&para;</a></h4>
<p>With #2326 merged, this issue can be closed.</p>
<p>V.</p>
<h4 id="jsmeix_commented_at_2020-03-18_1223"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2276#issuecomment-600591807">2020-03-18 12:23</a>:<a class="headerlink" href="#jsmeix_commented_at_2020-03-18_1223" title="Permanent link">&para;</a></h4>
<p>@Jorman<br />
we would appreciate it if you could verify (as your time permits)<br />
that things work for you with our current GitHub master code.</p>
<p>See "Testing current ReaR upstream GitHub master code" in<br />
<a href="https://en.opensuse.org/SDB:Disaster_Recovery">https://en.opensuse.org/SDB:Disaster_Recovery</a></p>
<h4 id="jorman_commented_at_2020-03-18_1313"><img src="https://avatars.githubusercontent.com/u/5203988?v=4" width="50"><a href="https://github.com/Jorman">Jorman</a> commented at <a href="https://github.com/rear/rear/issues/2276#issuecomment-600614804">2020-03-18 13:13</a>:<a class="headerlink" href="#jorman_commented_at_2020-03-18_1313" title="Permanent link">&para;</a></h4>
<p>@jsmeix<br />
I'll for sure.<br />
I'have to install it from scratch, so first I clone the master branch
then I make a deb, but for the configuration is changed some? I remember
I modified the configuration adding some but is still the same code or
is changed?</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2024 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2019-11-13.2276.issue.closed.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/rear/rear-user-guide" class="fa fa-code-fork" style="color: #fcfcfc"> rear/rear-user-guide</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
