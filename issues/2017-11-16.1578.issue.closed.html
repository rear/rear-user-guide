<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#1578 Issue closed: Create a recovery RAW disk - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#1578 Issue closed: Create a recovery RAW disk";
        var mkdocs_page_input_path = "issues/2017-11-16.1578.issue.closed.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/backup_netfs.html">Example of BACKUP=NETFS</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/netfs_nas.html">Internal Backup with tar to NFS server</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/rbme.html">External Backup using RBME</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/restic.html">External Backup using restic</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../development/squash-git-log-commments.html">How to squash git log comments into one line</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear29.html">Release Notes ReaR 2.9</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear28.html">Release Notes ReaR 2.8</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#1578 Issue closed: Create a recovery RAW disk</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="1578_issue_closed_create_a_recovery_raw_disk"><a href="https://github.com/rear/rear/issues/1578">#1578 Issue</a> <code>closed</code>: Create a recovery RAW disk<a class="headerlink" href="#1578_issue_closed_create_a_recovery_raw_disk" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>enhancement</code>, <code>documentation</code>, <code>fixed / solved / done</code></p>
<h4 id="greenblood_opened_issue_at_2017-11-16_1547"><img src="https://avatars.githubusercontent.com/u/6583431?v=4" width="50"><a href="https://github.com/GreenBlood">GreenBlood</a> opened issue at <a href="https://github.com/rear/rear/issues/1578">2017-11-16 15:47</a>:<a class="headerlink" href="#greenblood_opened_issue_at_2017-11-16_1547" title="Permanent link">&para;</a></h4>
<p>Hi, I use rear as a disaster recovery software in my company ; We do DRP
in the cloud through an automation process.<br />
The issue (and enhancement suggestion) I have is that the Cloud
infrastructure we use does not support ISO files as boot device, only
classic disk images (like raw, vmdk, qcow2 and such), therefore, I
cannot boot from the ISO to recover my machine.</p>
<p>I tried to "convert" the ISO file to an disk image but so far I couldn't
make it work...</p>
<p>One possible workaround would be to use OUTPUT=USB and send the recovery
environment to a mounted disk image which could be then booted on. The
other, more practical, would be to add the possibility to create a RAW
(or another format) disk image in place of the ISO file.</p>
<p>Does it seems like a feasable feature ?</p>
<p>Regards,<br />
GreenBlood</p>
<h4 id="gozora_commented_at_2017-11-16_1626"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/1578#issuecomment-344977249">2017-11-16 16:26</a>:<a class="headerlink" href="#gozora_commented_at_2017-11-16_1626" title="Permanent link">&para;</a></h4>
<p>Hey @GreenBlood,</p>
<p>In my opinion this is interesting feature indeed (but I'm somehow
strange, loving exotic things in ReaR c.f.
<a href="https://github.com/rear/rear/pull/1172">https://github.com/rear/rear/pull/1172</a>
:-)).<br />
Just in theory (without knowing much about virtual disks) I think this
is possible to implement, question is however effort ...<br />
I can add this on my TODO list, but implementation date would be a
riddle, as I have quite lot of work nowadays, so If you are willing to
implement this, you are more then welcome ;-)</p>
<p>V.</p>
<h4 id="jsmeix_commented_at_2017-11-17_0914"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1578#issuecomment-345187527">2017-11-17 09:14</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-11-17_0914" title="Permanent link">&para;</a></h4>
<p>@GreenBlood<br />
When you set in local.conf</p>
<pre>
KEEP_BUILD_DIR="yes"
</pre>

<p>and then run "rear mkrescue" you get<br />
all the ReaR recovery system files<br />
kept in /tmp/rear.XXXX/rootfs<br />
(without KEEP_BUILD_DIR="yes" the /tmp/rear.XXXX<br />
directory gets removed at the end of "rear mkrescue")<br />
so that you could do whatever you want with<br />
the ReaR recovery system files to manually create<br />
any kind of "bootable thingy" as you need it<br />
in your particular case.</p>
<p>When you know how to manually create what you need<br />
it should be relatively simple and straightforward to<br />
add support for new OUTPUT types in ReaR like</p>
<pre>
OUTPUT=RAWDISK
OUTPUT=VMDK
OUTPUT=QCOW2
</pre>

<p>Don't be afraid to do an initial GitHub pull request with<br />
your enhancements. It does not need to be a "perfect<br />
final solution". Any well documented enhancement is<br />
greately appreciated. Actually the only real requirement<br />
we have for GitHub pull request is that anybody can<br />
fully understand what "great new stuff" really is about cf.<br />
<a href="https://github.com/rear/rear/wiki/Coding-Style">https://github.com/rear/rear/wiki/Coding-Style</a></p>
<p>For an outstanding example of perfectly documented<br />
"great new stuff" you may have a look at<br />
<a href="https://github.com/rear/rear/pull/1574">https://github.com/rear/rear/pull/1574</a></p>
<h4 id="greenblood_commented_at_2017-11-17_1217"><img src="https://avatars.githubusercontent.com/u/6583431?v=4" width="50"><a href="https://github.com/GreenBlood">GreenBlood</a> commented at <a href="https://github.com/rear/rear/issues/1578#issuecomment-345229240">2017-11-17 12:17</a>:<a class="headerlink" href="#greenblood_commented_at_2017-11-17_1217" title="Permanent link">&para;</a></h4>
<p>@jsmeix Thank you very much for your support, I'm rather new in the
"community coding" universe so you make it less scary for me :)</p>
<p>Indeed, I had forgotten about the KEEP_BUILD_DIR option ; I'll try to
look into it and to make up some code to implement this.</p>
<p><strong>Edit :</strong> The main question i'm asking myself is that, by design, an
ISO is not /dev/sd*, but a raw/vmdl/qcow is, so the recovery disk would
have to detect and not try to restore on the first hard disk. For
example, we backup /dev/sda but restore it as /dev/sdb because sda is
the recovery disk.<br />
Is it already handled by the recovery script or is it fixed ?</p>
<h4 id="gdha_commented_at_2017-11-17_1322"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/issues/1578#issuecomment-345242370">2017-11-17 13:22</a>:<a class="headerlink" href="#gdha_commented_at_2017-11-17_1322" title="Permanent link">&para;</a></h4>
<p>@GreenBlood Could you explain in simple wording how you see this new
feature to work with ReaR? How is the process working to generate a RAW
image? Do you start from the KEEP_BUILD_DIR or ISO image? Would like
to understand the process behind it.<br />
And, secondly, how would the recover part work?<br />
Sorry for these (stupid) questions, but I have no experience on that
level (yet).</p>
<h4 id="schlomo_commented_at_2017-11-17_1414"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/issues/1578#issuecomment-345254340">2017-11-17 14:14</a>:<a class="headerlink" href="#schlomo_commented_at_2017-11-17_1414" title="Permanent link">&para;</a></h4>
<p>@GreenBlood did you try to use
<a href="http://www.syslinux.org/wiki/index.php?title=Isohybrid">isohybrid</a>? If
it works then you can extend ReaR to require and run <code>isohybrid</code> after
creating to ISO image üòÑ</p>
<h4 id="greenblood_commented_at_2017-11-17_1601"><img src="https://avatars.githubusercontent.com/u/6583431?v=4" width="50"><a href="https://github.com/GreenBlood">GreenBlood</a> commented at <a href="https://github.com/rear/rear/issues/1578#issuecomment-345284227">2017-11-17 16:01</a>:<a class="headerlink" href="#greenblood_commented_at_2017-11-17_1601" title="Permanent link">&para;</a></h4>
<p>@gdha<br />
I was thinking of maybe using the rescue system in the "initrd" to
create a small filesystem on a disk image.<br />
In summary, imho, "rear mkrescue" would go like :</p>
<ol>
<li>Build the base rear rescue system</li>
<li>Create a block device (with mknod for example) from an empty file
    and format it</li>
<li>Mount the newly create partition and copy the rescue system onto
    this partition</li>
<li>Create MBR and other boot-related process accordingly</li>
<li>The result is a raw disk image. It can be dd on a thumbdrive or, in
    my case, uploaded to a Cloud provider to be started on (and to
    recover data in the cloud infrastructure)</li>
<li>The image sits next to the backup data in the repository</li>
</ol>
<p>But with @schlomo's idea it might not be necessary to go through all
this</p>
<p>The issue it raised in my mind is that rear would then have to recover
to the SECOND block device, and not the first as usual. I'm not really
familiar with ReaR code structure so I guess the choice of the
destination disk is made to be first disk in =&gt; first disk out which
is not what we would want right here.</p>
<p>@schlomo I had never heard of this tool. Just tried it and I'm amazed at
how fast it is and efficient ! When the MBR was added, I converted it to
a qcow2 format and was able to boot from it seamlessly. So this is
definetly a step in the right way. The major problem then is the one I
talked about just above in this message</p>
<h4 id="schlomo_commented_at_2017-11-18_1632"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/issues/1578#issuecomment-345453504">2017-11-18 16:32</a>:<a class="headerlink" href="#schlomo_commented_at_2017-11-18_1632" title="Permanent link">&para;</a></h4>
<p>Are you sure that the ISO shows up as the first block device? I always
thought that isohybrid works only on the BIOS level. Truth is, I haven't
used isohybrid in many years and don't remember all the details.</p>
<h4 id="jsmeix_commented_at_2017-11-20_0930"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1578#issuecomment-345639197">2017-11-20 09:30</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-11-20_0930" title="Permanent link">&para;</a></h4>
<p>@GreenBlood<br />
regarding "first disk in =&gt; first disk out" in your<br />
<a href="https://github.com/rear/rear/issues/1578#issuecomment-345284227">https://github.com/rear/rear/issues/1578#issuecomment-345284227</a></p>
<p>It depends what exactly you mean with "first disk", "second disk".</p>
<p>During "rear mkrescue/mkbackup" ReaR saves the disk layout<br />
(disks, partitions, filesystems, mountpoints, ...) of the original<br />
system (where "rear mkrescue/mkbackup" runs) into the file<br />
/tmp/rear.XXX/rootfs/root/rear.master/var/lib/rear/layout/disklayout.conf</p>
<p>ReaR saves the disk layout using traditional kernel block<br />
device node names like /dev/sda /dev/sda1 ...<br />
cf.
<a href="https://github.com/rear/rear/issues/1063">https://github.com/rear/rear/issues/1063</a><br />
and follow the links to other issues therein.</p>
<p>During "rear recover" ReaR recreates the system using those<br />
device node names like /dev/sda /dev/sda1 ... as present on<br />
the replacement hardware.</p>
<p>There is some basic autodetection during "rear recover" when<br />
disks on the replacement hardware seem to not match what<br />
there was on the original system. If a mismatch is autodetected<br />
then ReaR goes into its "migration mode" (search the scripts<br />
for MIGRATION_MODE) where it asks via user dialogs what to do.</p>
<p>Currently that autodetection is based on comparing disk size<br />
cf. layout/prepare/default/250_compare_disks.sh</p>
<p>Accordingly things can go wrong when there are<br />
several disks with same size, cf.<br />
<a href="https://github.com/rear/rear/issues/1057#issuecomment-259390395">https://github.com/rear/rear/issues/1057#issuecomment-259390395</a></p>
<p>Things can even go terribly wrong when your USB disk<br />
where your ReaR recovery system and backup is<br />
has same size as your system harddisk, cf.<br />
<a href="https://github.com/rear/rear/issues/1271">https://github.com/rear/rear/issues/1271</a></p>
<h4 id="olivero2_commented_at_2017-11-21_1918"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/issues/1578#issuecomment-346132125">2017-11-21 19:18</a>:<a class="headerlink" href="#olivero2_commented_at_2017-11-21_1918" title="Permanent link">&para;</a></h4>
<p>I came across this issue accidentally and it looks like I've already
created something very close: Over here, an invocation of
<code>rear -v mkopalbpa</code> creates a raw disk image with a minimal ReaR
installation plus a combination of EFI+Legacy BIOS bootloaders
(syslinux-efi or Grub 2 for EFI, syslinux for legacy BIOS). The result
is a TCG Opal pre-boot authentication (PBA) image, which is meant to be
stored in a special section on an Opal-compliant self-encrypting disk to
support unlocking such disks via <a href="https://github.com/Drive-Trust-Alliance/sedutil">DTA
sedutil-cli</a>.</p>
<p>Currently I'm using the disk image for testing on VirtualBox (after
running something like
<code>VBoxManage convertfromraw TCG-Opal-PBA.img TCG-Opal-PBA.vdi --format VDI</code>)
where the same image boots via EFI and Legacy BIOS. Copying the disk
image via <code>dd</code> onto a USB device and booting from there on real hardware
also works. At this time the bootloaders are minimal installations as
the PBA area on Opal-compliant disk is of limited capacity (e.g. 128 MB
or so on a Samsung 850 Pro SSD).</p>
<p>I've already thought about making this available as a universal output
method not only for PBA images but also for complete ReaR rescue media.
I should have the PBA stuff ready by next week.</p>
<p>Using a test configuration like this:</p>
<pre><code>OUTPUT=OPALPBA
OPALPBA_URL="file:///mnt/reserve/Transfer/Rear.nobackup/OPALPBA"
OPALPBA_INCLUDE_SYSLINUX_EFI=no
</code></pre>
<p>this is what <code>rear -v mkopalbpa</code> output looks like:</p>
<pre><code>Relax-and-Recover 2.2 / Git
Using log file: /home/oliver/Repositories/external/rear/var/log/rear/rear-foxtrot.log
Using UEFI Boot Loader for Linux (USING_UEFI_BOOTLOADER=1)
Creating disk layout
Ignoring non-existing btrfs subvolume listed as mounted: /var/lib/docker/btrfs
Using guessed bootloader 'EFI'
Creating root filesystem layout
Trying to find what to use as UEFI bootloader...
Trying to find a 'well known file' to be used as UEFI bootloader...
Using '/boot/efi/EFI/ubuntu/grubx64.efi' as UEFI bootloader file
Copying logfile /home/oliver/Repositories/external/rear/var/log/rear/rear-foxtrot.log into initramfs as '/tmp/rear-foxtrot-partial-2017-11-21T20:10:18+01:00.log'
Copying files and directories
Copying binaries and libraries
Copying only currently loaded kernel modules (MODULES contains 'loaded_modules')
Omit copying files in /lib*/firmware/ (FIRMWARE_FILES='no')
Creating recovery/rescue system initramfs/initrd initrd.cgz with gzip default compression
Created initrd.cgz with gzip default compression (34180551 bytes) in 4 seconds
DISABLED: Using syslinux to create an EFI bootloader for the TCG Opal pre-boot authentication (PBA) image
Using Grub 2 to create an EFI bootloader for the TCG Opal pre-boot authentication (PBA) image
Creating TCG Opal pre-boot authentication (PBA) image (45 MiB)
Using syslinux to install a Legacy BIOS bootloader for the TCG Opal pre-boot authentication (PBA) image
Copying resulting files to file location
Saving /home/oliver/Repositories/external/rear/var/log/rear/rear-foxtrot.log as rear-foxtrot.log to file location
</code></pre>
<h4 id="gdha_commented_at_2017-11-22_0655"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/issues/1578#issuecomment-346259979">2017-11-22 06:55</a>:<a class="headerlink" href="#gdha_commented_at_2017-11-22_0655" title="Permanent link">&para;</a></h4>
<p>@OliverO2 Looking forward to the PR - looks very promising üëç</p>
<h4 id="greenblood_commented_at_2017-11-22_0900"><img src="https://avatars.githubusercontent.com/u/6583431?v=4" width="50"><a href="https://github.com/GreenBlood">GreenBlood</a> commented at <a href="https://github.com/rear/rear/issues/1578#issuecomment-346285761">2017-11-22 09:00</a>:<a class="headerlink" href="#greenblood_commented_at_2017-11-22_0900" title="Permanent link">&para;</a></h4>
<p>@schlomo<br />
Yup, but that might be my fault, as my cloud provider right now allows
only disk image (like vhd or qcow or antything, hence my original
question) so I had to convert it. I just tried again with just
isohybrid'ing the file and launching it on a local hypervisor and indeed
it displays as a standard disc, it's the convert part that does that.</p>
<p>@OliverO2 Sounds very nice! Out of curiosity, what does the Opal TCG
thingy implies on the output disk image ?</p>
<h4 id="olivero2_commented_at_2017-11-22_1150"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/issues/1578#issuecomment-346328272">2017-11-22 11:50</a>:<a class="headerlink" href="#olivero2_commented_at_2017-11-22_1150" title="Permanent link">&para;</a></h4>
<p>@GreenBlood Regarding TCG Opal requirements and raw disk image output,
there is really nothing special with these exceptions:</p>
<ul>
<li>The disk image must be small (maximum 128 MB on a Samsung 850 Pro
    SSD).</li>
<li>For usability reasons a very quiet boot process is required (so
    there are no bootloader menus or other fancy stuff).</li>
</ul>
<p>I have actually just adapted my scripts to provide a RAWDISK output
method, so you can just configure ReaR like this:</p>
<pre><code>OUTPUT=RAWDISK
OUTPUT_URL="file:///mnt/reserve/Transfer/Rear.nobackup/RAWDISK"
</code></pre>
<p>I have verified that I can boot a full ReaR rescue system from that disk
image. If you'd like to check it out, I could push this to my ReaR fork,
hopefully later today.</p>
<p>The bootable raw disk image doesn't really care about its boot device so
if you can configure your cloud infrastructure to address the ReaR image
as a second (third, or whatever) disk device, you should be fine.</p>
<h4 id="jsmeix_commented_at_2017-11-22_1208"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1578#issuecomment-346331972">2017-11-22 12:08</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-11-22_1208" title="Permanent link">&para;</a></h4>
<p>@OliverO2<br />
I like your meaningful ReaR verbose mode messages as in<br />
<a href="https://github.com/rear/rear/issues/1578#issuecomment-346132125">https://github.com/rear/rear/issues/1578#issuecomment-346132125</a><br />
very much!<br />
Regardless that I know nothing at all about<br />
"TCG Opal pre-boot authentication (PBA)"<br />
I get some basic understanding what goes on.<br />
I look forward to your pull request!</p>
<p>I only wonder why you implemented<br />
your new OUTPUT=OPALPBA method<br />
as a complete new workflow "mkopalbpa"?</p>
<h4 id="olivero2_commented_at_2017-11-22_1242"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/issues/1578#issuecomment-346339229">2017-11-22 12:42</a>:<a class="headerlink" href="#olivero2_commented_at_2017-11-22_1242" title="Permanent link">&para;</a></h4>
<p>@jsmeix Thanks!</p>
<p>Envision a PBA as a small black-box program that</p>
<ol>
<li>is booted instead of your regular operating system when your boot
    disk is locked,</li>
<li>asks for your boot disk password,</li>
<li>unlocks your boot disk,</li>
<li>initiates a reboot to start the regular operating system.</li>
</ol>
<p>The trick is that a locked Opal-compliant disk will present itself as a
smaller disk, which just contains the PBA. The firmware will then try to
boot that PBA. As soon as the Opal disk is unlocked, it will show its
real contents and the PBA will be hidden when rebooting into the regular
OS.</p>
<p>In my implementation, there is a complete rear-built system acting as
the PBA.</p>
<p>The PBA creation is more than just a new output method: Over here, a
complete rescue system is about 190 MiB in size while the PBA is just 45
MiB. Creating a PBA should be possible without changing the ReaR
configuration. So you should be able to use <code>rear mkrescue</code> to create
the rescue system as ususal and <code>rear mkopalpba</code> to create the PBA, both
from a single ReaR configuration.</p>
<p>I actually intend to go further and add another <code>installopalpba</code>
workflow. This is the usage information currently provided with my
RAWDISK output method:</p>
<pre><code>How to recover your system:
---------------------------

To recover your system, copy the attached raw disk image onto a disk device (a USB stick will do).
Do not use a partition (like /dev/sdc1), use the complete disk device (like /dev/sdc).
Be careful, this will overwrite disk contents.

Example:

   dd if=&lt;image&gt; bs=1M of=&lt;device&gt;

Then boot from the disk device into the rescue system.



How to install a TCG Opal pre-boot authentication (PBA) image
-------------------------------------------------------------


a) To enable TCG Opal support and install the PBA image onto a disk device:

      sudo rear installopalpba --setup [&lt;image&gt;] &lt;device&gt;


b) To replace the PBA image on a disk device where TCG Opal support has been enabled:

      sudo rear installopalpba [&lt;image&gt;] &lt;device&gt;


Note: If the &lt;image&gt; parameter is not provided, ReaR will either
- use the provided image when called on a rescue system, or
- generate a new image.
</code></pre>
<h4 id="olivero2_commented_at_2017-11-22_1529"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/issues/1578#issuecomment-346384421">2017-11-22 15:29</a>:<a class="headerlink" href="#olivero2_commented_at_2017-11-22_1529" title="Permanent link">&para;</a></h4>
<p>@GreenBlood and everyone interested:</p>
<p>At
<a href="https://github.com/OliverO2/rear/tree/feature/opal-support">https://github.com/OliverO2/rear/tree/feature/opal-support</a>
please find my incarnation of a RAWDISK output method.</p>
<p>Just configure like this and you should be ready to go:</p>
<pre><code>OUTPUT=RAWDISK
OUTPUT_URL="file:///your/preferred/output/location"
</code></pre>
<p>This is the first step towards TCG Opal support but the output method
works independently.</p>
<p>Tested on Ubuntu 16.04.3 LTS.</p>
<h4 id="greenblood_commented_at_2017-11-24_1634"><img src="https://avatars.githubusercontent.com/u/6583431?v=4" width="50"><a href="https://github.com/GreenBlood">GreenBlood</a> commented at <a href="https://github.com/rear/rear/issues/1578#issuecomment-346865300">2017-11-24 16:34</a>:<a class="headerlink" href="#greenblood_commented_at_2017-11-24_1634" title="Permanent link">&para;</a></h4>
<p>@OliverO2 It's really working great and the resulting image is perfectly
working, I only have one issue, some of my servers are not on an EFI
bootloader so the script trying to create EFI bootloader(grub-mkimage i
think) fails because it cannot find the required files.</p>
<pre><code>2017-11-24 16:29:20.774205693 Including output/RAWDISK/Linux-i386/270_create_grub2_efi_bootloader.sh
2017-11-24 16:29:20.778481003 Using Grub 2 to create an EFI bootloader
mkdir: created directory '/tmp/rear.ucQzU9aAufOZiZ0/EFI'
mkdir: created directory '/tmp/rear.ucQzU9aAufOZiZ0/EFI/BOOT'
grub-mkimage: error: cannot open /usr/lib/grub/x86_64-efi/moddep.lst': No such file or directory.
2017-11-24 16:29:20.787039299 ERROR: Error occurred during grub-mkimage of /tmp/rear.ucQzU9aAufOZiZ0/EFI/BOOT/BOOTX64.efi
</code></pre>
<p>I had to install the efi related packages to move on from there<br />
Tomorrow i'll try to remove the efi-related bash scripts (numbered 260
and 270 iirc) and see what's happening, but this whole feature looks
promising :)</p>
<h4 id="olivero2_commented_at_2017-11-24_1656"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/issues/1578#issuecomment-346868787">2017-11-24 16:56</a>:<a class="headerlink" href="#olivero2_commented_at_2017-11-24_1656" title="Permanent link">&para;</a></h4>
<p>@GreenBlood Good to hear that it's working in general, thanks for your
feedback. Seems like the autodetection for Grub 2/EFI needs to improve.</p>
<p>This is how I'd diagnose your situation:</p>
<ul>
<li>The scripts for the EFI bootloaders try to auto-detect if their
    respective bootloaders can actually be built, before trying to
    create their respective bootloader.</li>
<li>The syslinux/EFI detection works as you don't get any error messages
    from there. <code>260_create_syslinux_efi_bootloader.sh</code> just determines
    that the EFI variant of syslinux is not available and proceeds
    without trying to build a syslinux-based EFI bootloader.</li>
<li>The detection for Grub 2 succeeds in checking for <code>grub-mkimage</code> and
    thinks a complete Grub 2 installation (including EFI) is available.
    <code>270_create_grub2_efi_bootloader.sh</code> then tries to build a Grub
    2-based EFI bootloader but fails as required files are missing.</li>
</ul>
<p>Fortunately, you can use configuration variables to prevent EFI
bootloaders from being created:</p>
<ul>
<li>For syslinux/EFI you can set <code>RAWDISK_INCLUDE_SYSLINUX_EFI=no</code></li>
<li>For Grub 2/EFI you can set <code>RAWDISK_INCLUDE_GRUB2_EFI=no</code></li>
</ul>
<p>So in your case, it should be sufficient to just set
<code>RAWDISK_INCLUDE_GRUB2_EFI=no</code>. Then everything should work without any
change to scripts.</p>
<p>Hope this helps.</p>
<h4 id="olivero2_commented_at_2017-11-24_1745"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/issues/1578#issuecomment-346875484">2017-11-24 17:45</a>:<a class="headerlink" href="#olivero2_commented_at_2017-11-24_1745" title="Permanent link">&para;</a></h4>
<p>@GreenBlood A quick fix: Try to change lines 7-8 in
<code>270_create_grub2_efi_bootloader.sh</code> to:</p>
<pre><code># Run only if no EFI bootloader has been created yet and Grub 2 EFI is available
([[ -n "$RAWDISK_EFI_STAGING_ROOT" ]] || ! has_binary grub-mkimage || ! [[ -d /usr/lib/grub/x86_64-efi ]]) &amp;&amp; return 0
</code></pre>
<h4 id="greenblood_commented_at_2018-01-08_1558"><img src="https://avatars.githubusercontent.com/u/6583431?v=4" width="50"><a href="https://github.com/GreenBlood">GreenBlood</a> commented at <a href="https://github.com/rear/rear/issues/1578#issuecomment-356007382">2018-01-08 15:58</a>:<a class="headerlink" href="#greenblood_commented_at_2018-01-08_1558" title="Permanent link">&para;</a></h4>
<p>@OliverO2 I just saw your code got merged into the main branch. Thank
you very much for your work on this üëç</p>
<h4 id="olivero2_commented_at_2018-01-08_1611"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/issues/1578#issuecomment-356011702">2018-01-08 16:11</a>:<a class="headerlink" href="#olivero2_commented_at_2018-01-08_1611" title="Permanent link">&para;</a></h4>
<p>@GreenBlood Apparently it's about to get merged, but not done yet.
Thanks for your feedback!</p>
<h4 id="jsmeix_commented_at_2018-01-09_1010"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1578#issuecomment-356239428">2018-01-09 10:10</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-01-09_1010" title="Permanent link">&para;</a></h4>
<p>With
<a href="https://github.com/rear/rear/pull/1659">https://github.com/rear/rear/pull/1659</a>
merged<br />
I consider this issue to be fixed.</p>
<p>@OliverO2<br />
many thanks for your huge contribution to ReaR!</p>
<p>@GreenBlood<br />
FYI how to test the current ReaR GitHub master code:</p>
<p>Basically "git clone" it into a directory and then<br />
configure and run ReaR from within that directory like:</p>
<pre>
# git clone https://github.com/rear/rear.git

# cd rear

# vi etc/rear/local.conf

# usr/sbin/rear -D mkbackup
</pre>

<p>(note the relative paths "etc/rear/" and "usr/sbin/").</p>
<h4 id="greenblood_commented_at_2018-01-09_1455"><img src="https://avatars.githubusercontent.com/u/6583431?v=4" width="50"><a href="https://github.com/GreenBlood">GreenBlood</a> commented at <a href="https://github.com/rear/rear/issues/1578#issuecomment-356306927">2018-01-09 14:55</a>:<a class="headerlink" href="#greenblood_commented_at_2018-01-09_1455" title="Permanent link">&para;</a></h4>
<p>@jsmeix Yup dont worry about me I'm using a bunch of temporary VMs and
building the deb file (to integrate it with my others scripts). Thank
you tho !</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2025 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2017-11-16.1578.issue.closed.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/rear/rear-user-guide" class="fa fa-code-fork" style="color: #fcfcfc"> rear/rear-user-guide</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
