<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#2475 Issue closed: Opal PBA does not support NVMe drives - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#2475 Issue closed: Opal PBA does not support NVMe drives";
        var mkdocs_page_input_path = "issues/2020-08-08.2475.issue.closed.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#2475 Issue closed: Opal PBA does not support NVMe drives</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="2475_issue_closed_opal_pba_does_not_support_nvme_drives"><a href="https://github.com/rear/rear/issues/2475">#2475 Issue</a> <code>closed</code>: Opal PBA does not support NVMe drives<a class="headerlink" href="#2475_issue_closed_opal_pba_does_not_support_nvme_drives" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>enhancement</code>, <code>fixed / solved / done</code></p>
<h4 id="bmastenbrook_opened_issue_at_2020-08-08_2149"><img src="https://avatars.githubusercontent.com/u/1457527?u=aff86cda77b6bc37fa09a0233ea68d397ed31b10&v=4" width="50"><a href="https://github.com/bmastenbrook">bmastenbrook</a> opened issue at <a href="https://github.com/rear/rear/issues/2475">2020-08-08 21:49</a>:<a class="headerlink" href="#bmastenbrook_opened_issue_at_2020-08-08_2149" title="Permanent link">&para;</a></h4>
<h4 id="relax-and-recover_rear_issue_template">Relax-and-Recover (ReaR) Issue Template<a class="headerlink" href="#relax-and-recover_rear_issue_template" title="Permanent link">&para;</a></h4>
<p>Fill in the following items before submitting a new issue<br />
(quick response is not guaranteed with free support):</p>
<ul>
<li>
<p>ReaR version ("/usr/sbin/rear -V"): Relax-and-Recover
    2.6-git.4108.0f2f4a02.master / 2020-08-07</p>
</li>
<li>
<p>OS version ("cat /etc/os-release" or "lsb_release -a" or "cat
    /etc/rear/os.conf"): Ubuntu 20.04.1 LTS (Focal Fossa)</p>
</li>
<li>
<p>ReaR configuration files ("cat /etc/rear/site.conf" and/or "cat
    /etc/rear/local.conf"): N/A</p>
</li>
<li>
<p>Hardware (PC or PowerNV BareMetal or ARM) or virtual machine (KVM
    guest or PoverVM LPAR): PC</p>
</li>
<li>
<p>System architecture (x86 compatible or PPC64/PPC64LE or what exact
    ARM device): x86</p>
</li>
<li>
<p>Firmware (BIOS or UEFI or Open Firmware) and bootloader (GRUB or
    ELILO or Petitboot): UEFI with GRUB</p>
</li>
<li>
<p>Storage (local disk or SSD) and/or SAN (FC or iSCSI or FCoE) and/or
    multipath (DM or NVMe): NVMe WDC PC SN730 SDBQNTY-256G-1001</p>
</li>
<li>
<p>Storage layout ("lsblk -ipo
    NAME,KNAME,PKNAME,TRAN,TYPE,FSTYPE,SIZE,MOUNTPOINT" or "lsblk" as
    makeshift):</p>
</li>
</ul>
<!-- -->

<pre><code>NAME           MAJ:MIN RM   SIZE RO TYPE  MOUNTPOINT
nvme0n1        259:0    0 238.5G  0 disk  
├─nvme0n1p1    259:1    0    94M  0 part  /boot/efi
├─nvme0n1p2    259:2    0  15.3G  0 part  
│ └─swap_crypt 253:0    0  15.3G  0 crypt [SWAP]
└─nvme0n1p3    259:3    0 223.1G  0 part  /home
</code></pre>
<ul>
<li>Description of the issue (ideally so that others can reproduce it):</li>
</ul>
<p>NVMe devices are represented by the kernel as a root device
(<code>/dev/nvme0</code> in this example) and a sub-device for each namespace of
the drive (<code>/dev/nvme0n1</code> in this example). On most client SSDs, there
is only one namespace, and it contains the entirety of the user-visible
LBAs on the drive. <code>sedutil-cli</code> expects to be passed the device
representing the entire drive, but <code>partprobe</code> needs to be passed the
device representing the namespace.</p>
<p>All of the functions in <code>opal-functions.sh</code> attempt to pass the same
device to both <code>sedutil-cli</code> and <code>partprobe</code>, and <code>partprobe</code> returns an
error status when handed the root device for an NVMe drive instead of
the namespace device. As such, the unlocking function fails.</p>
<ul>
<li>Workaround, if any:</li>
</ul>
<p>None.</p>
<ul>
<li>Attachments, as applicable ("rear -D mkrescue/mkbackup/recover"
    debug log files):</li>
</ul>
<h4 id="jsmeix_commented_at_2020-08-10_1017"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2475#issuecomment-671274120">2020-08-10 10:17</a>:<a class="headerlink" href="#jsmeix_commented_at_2020-08-10_1017" title="Permanent link">&para;</a></h4>
<p>@OliverO2<br />
could you have a look at this issue here?</p>
<h4 id="olivero2_commented_at_2020-08-10_1030"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/issues/2475#issuecomment-671278937">2020-08-10 10:30</a>:<a class="headerlink" href="#olivero2_commented_at_2020-08-10_1030" title="Permanent link">&para;</a></h4>
<p>I'll look into this one too. I'd have to familiarize myself with NVME
stuff first but the issue seems to contain sufficient details to figure
out a solution.</p>
<h4 id="jsmeix_commented_at_2020-08-10_1041"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2475#issuecomment-671283014">2020-08-10 10:41</a>:<a class="headerlink" href="#jsmeix_commented_at_2020-08-10_1041" title="Permanent link">&para;</a></h4>
<p>@bmastenbrook<br />
I do not have a NVME device so I cannot reproduce things myself.</p>
<p>I am puzzled by your <code>lsblk</code> output versus your description</p>
<pre><code>NVMe devices are represented by the kernel as a root device
(/dev/nvme0 in this example) and a sub-device for each namespace
of the drive (/dev/nvme0n1 in this example)
</code></pre>
<p>because your <code>lsblk</code> output does not contain a <code>nvme0</code> kernel device<br />
so it seems there is no such device on your system.<br />
But when there is no <code>nvme0</code> kernel device I wonder how <code>sedutil-cli</code>
can<br />
expect to be passed the device representing the entire drive as <code>nvme0</code>?</p>
<p>I assume for <code>sedutil-cli ... &lt;device&gt;</code> the device needs to be a <code>disk</code>
type device<br />
which is usually e.g. something like <code>/dev/sda</code>.</p>
<p>In your <code>lsblk</code> output <code>nvme0n1</code> is show as a <code>disk</code> type device<br />
so I would expect that <code>sedutil-cli ... /dev/nvme0n1</code> works.</p>
<p>But it seems in case of NVMe devices there are two layers of <code>disk</code> like
devices:<br />
A hidden / non-visible low-level <code>nvme0</code> kind of <code>whole-disk</code> type
device plus<br />
one or more normal visible <code>nvme0n1</code> kind of <code>normal-disk</code> type devices?</p>
<p>Only FYI regarding "fun with device naming" for mmcblk/eMMC devices<br />
cf.
<a href="https://github.com/rear/rear/issues/2087#issuecomment-475650821">https://github.com/rear/rear/issues/2087#issuecomment-475650821</a><br />
and
<a href="https://github.com/rear/rear/issues/2087#issuecomment-477551079">https://github.com/rear/rear/issues/2087#issuecomment-477551079</a></p>
<h4 id="olivero2_commented_at_2020-08-10_1212"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/issues/2475#issuecomment-671318507">2020-08-10 12:12</a>:<a class="headerlink" href="#olivero2_commented_at_2020-08-10_1212" title="Permanent link">&para;</a></h4>
<blockquote>
<p>I assume for <code>sedutil-cli ... &lt;device&gt;</code> the device needs to be a
<code>disk</code> type device<br />
which is usually e.g. something like <code>/dev/sda</code>.</p>
</blockquote>
<p>Actually it could be a toaster as long as its driver provides the
necessary ioctls. <code>sedutil-cli</code> uses different ioctl commands for NVME
and SATA devices.</p>
<h4 id="jsmeix_commented_at_2020-08-10_1312"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2475#issuecomment-671345632">2020-08-10 13:12</a>:<a class="headerlink" href="#jsmeix_commented_at_2020-08-10_1312" title="Permanent link">&para;</a></h4>
<p>With <code>disk</code> type device I meant what the <code>TYPE</code> column of <code>lsblk</code>
shows<br />
so of course also whole toasters when shown as <code>disk</code> by <code>lsblk</code><br />
in contrast to toaster slots that could be shown as <code>part</code> by <code>lsblk</code>
;-)</p>
<h4 id="olivero2_commented_at_2020-08-10_1342"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/issues/2475#issuecomment-671361418">2020-08-10 13:42</a>:<a class="headerlink" href="#olivero2_commented_at_2020-08-10_1342" title="Permanent link">&para;</a></h4>
<p>@jsmeix<br />
Actually, it seems like <code>sedutil-cli</code> uses the nvme <em>character</em> device
<code>nvme0</code> in the above example, which is just a control device. This
control device is used to create the actual disk-type devices called
namespaces (= "amount of NVM storage formatted for block access") like
<code>nvme0n1</code>. Each namespace device can then be partitioned.</p>
<p><code>sedutil-cli --scan</code> is used to determine available Opal devices and
this seems to spit out the control devices in case of NVME. These
character devices are not considered by <code>lsblk</code>.</p>
<p>Maybe we should campaign for toasters being supported as NVME devices,
too, with the slots being the namespaces. ;-)</p>
<p>@bmastenbrook<br />
Could you change <code>usr/share/rear/lib/opal-functions.sh</code> like this and
try again?</p>
<ol>
<li>
<p>Insert this function just above the definion of
    <code>function opal_device_regenerate_dek_ERASING_ALL_DATA()</code>:</p>
<pre><code>function opal_device_partprobe() {
    local device="${1:?}"
    # uses partprobe to update partition tables for all block devices belonging to the given Opal device.

    case "$device" in
        (*/nvme*)
            partprobe "$device"n[0-9]  # consider all namespace block devices (NOTE: relies on nullglob)
            ;;
        (*)
            partprobe "$device"
            ;;
    esac
}
</code></pre>
</li>
<li>
<p>Change all <code>partprobe</code> invocations to <code>opal_device_partprobe</code></p>
</li>
</ol>
<h4 id="jsmeix_commented_at_2020-08-10_1407"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2475#issuecomment-671376837">2020-08-10 14:07</a>:<a class="headerlink" href="#jsmeix_commented_at_2020-08-10_1407" title="Permanent link">&para;</a></h4>
<p>@OliverO2<br />
I noticed <code>device="${1:?}"</code> and found the <code>${VAR:?}</code> form many times in
Opal related code<br />
but I this leads to an unfriendly exit without any error message when
VAR is null or unset.</p>
<p>This is described in "man bash" (GNU bash, version 4.4.23 in my case):</p>
<pre><code>${parameter:?word}
Display Error if Null or Unset.
If parameter is null or unset, the expansion of word
(or a message to that effect if word is not present)
is written to the standard error and
the shell, if it is not interactive, exits.
Otherwise, the value of parameter is substituted.
</code></pre>
<p>For example when I put</p>
<pre><code>LogPrint TEST begin
foo=""
bar="${foo:?}" || BugError "foo null or unset"
LogPrint TEST end
</code></pre>
<p>in a script ReaR exits as follows</p>
<pre><code># usr/sbin/rear -D mkrescue
Relax-and-Recover 2.6 / Git
Running rear mkrescue (PID 8066 date 2020-08-10 16:04:49)
Using log file: /root/rear.github.master/var/log/rear/rear-linux-h9wr.log
TEST begin
Exiting rear mkrescue (PID 8066) and its descendant processes ...
Running exit tasks
rear mkrescue failed, check /root/rear.github.master/var/log/rear/rear-linux-h9wr.log for details
</code></pre>
<h4 id="olivero2_commented_at_2020-08-10_1533"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/issues/2475#issuecomment-671427114">2020-08-10 15:33</a>:<a class="headerlink" href="#olivero2_commented_at_2020-08-10_1533" title="Permanent link">&para;</a></h4>
<p>@jsmeix<br />
These checks are just a compact attempt to catch internal bugs early
without putting too much error-checking distractions in the code. The
log file in your example helps to spot the cause:</p>
<pre><code>2020-08-10 17:20:16.233077604 TEST begin
/home/oliver/Repositories/open-source/rear/usr/share/rear/prep/default/009_test.sh: line 3: foo: parameter null or not set
2020-08-10 17:20:16.234854487 Exiting rear mkrescue (PID 20879) and its descendant processes ...
</code></pre>
<p>Is there a better alternative?</p>
<ul>
<li>Not checking at all (like most code in ReaR) would let ReaR either
    continue with undesirable results or trigger a follow-up error later
    on which is probably harder to diagnose.</li>
<li>Putting in explicit error-checking code everywhere (like
    <code>[[ -z "$foo" ]] || BugError "foo: parameter null or not set" ]]</code>)
    distracts from the primary functionality and makes the code harder
    to read.</li>
</ul>
<h4 id="jsmeix_commented_at_2020-08-11_1042"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2475#issuecomment-671871423">2020-08-11 10:42</a>:<a class="headerlink" href="#jsmeix_commented_at_2020-08-11_1042" title="Permanent link">&para;</a></h4>
<p>@OliverO2<br />
I think explicit testing is the best way for bash scripts.<br />
I try to explain my reasoning why below.</p>
<p>Regarding <code>bar="${foo:?}"</code>:</p>
<p>The problem for the user is that he does not get the error message on
his terminal.<br />
Let him search the actual error message from the log is not user
friendly.<br />
He needs at least some message about what went wrong on his terminal.<br />
Then he can search the log for more details related to that message.<br />
To show the bash error <code>foo: parameter null or not set</code> on his
terminal<br />
and have that message also in the log so the user can find the matching
part in the log</p>
<pre><code>{ bar="${foo:?}" ; } 2&gt;&gt; &gt;( tee -a "$RUNTIME_LOGFILE" 1&gt;&amp;8 )
</code></pre>
<p>is the only way that works for me.<br />
Why a compound group command <code>{ ... ; } 2&gt;</code> must be used see<br />
<a href="https://github.com/rear/rear/blob/master/usr/share/rear/lib/_input-output-functions.sh#L840">https://github.com/rear/rear/blob/master/usr/share/rear/lib/_input-output-functions.sh#L840</a><br />
and for the complicated redirection via <code>tee</code> process substitution see<br />
<a href="https://github.com/rear/rear/blob/master/usr/share/rear/backup/BORG/default/500_make_backup.sh#L71">https://github.com/rear/rear/blob/master/usr/share/rear/backup/BORG/default/500_make_backup.sh#L71</a><br />
and see the explanatory comment for that code.<br />
and for background information see the discussion in<br />
<a href="https://github.com/rear/rear/pull/2382">https://github.com/rear/rear/pull/2382</a><br />
in particular<br />
<a href="https://github.com/rear/rear/pull/2382#discussion_r417852393">https://github.com/rear/rear/pull/2382#discussion_r417852393</a><br />
and subsequent comments there like<br />
<a href="https://github.com/rear/rear/pull/2382#discussion_r418018571">https://github.com/rear/rear/pull/2382#discussion_r418018571</a><br />
and<br />
<a href="https://github.com/rear/rear/pull/2382#discussion_r419378558">https://github.com/rear/rear/pull/2382#discussion_r419378558</a></p>
<p>But what would code like</p>
<pre><code>function opal_device_partprobe() {
    { local device="${1:?}" ; } 2&gt;&gt; &gt;( tee -a "$RUNTIME_LOGFILE" 1&gt;&amp;8 )
</code></pre>
<p>actually help?<br />
E.g. it would not catch if <code>opal_device_partprobe /etc/fstab</code> was
called.<br />
Others who read that code would get a longer exercise in reverse
engineering<br />
what that complicated code intends to do or a longer comment is needed<br />
that explains them what the idea behind is.</p>
<p>In contrast explicit testing like</p>
<pre><code>function opal_device_partprobe() {
    local device="$1"
    test -b "$device" -o -c "$device" || BugError "opal_device_partprobe called for '$device' that is neither a block nor a character device"
</code></pre>
<p>makes it obvious for a code reader what that code is about and<br />
the user gets a helpful error message via ReaR standard functionality.</p>
<h4 id="olivero2_commented_at_2020-08-11_1340"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/issues/2475#issuecomment-671953235">2020-08-11 13:40</a>:<a class="headerlink" href="#olivero2_commented_at_2020-08-11_1340" title="Permanent link">&para;</a></h4>
<p>@jsmeix Since this is about ReaR coding conventions in general, could we
continue in a separate issue? This could also prompt some feedback from
other contributors. I don't know if is is possible to move the above
issue comments to a new issue. If so, I'd appreciate it.</p>
<h4 id="jsmeix_commented_at_2020-08-11_1342"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2475#issuecomment-671954689">2020-08-11 13:42</a>:<a class="headerlink" href="#jsmeix_commented_at_2020-08-11_1342" title="Permanent link">&para;</a></h4>
<p>@OliverO2<br />
yes, it does not belong to this issue.</p>
<h4 id="jsmeix_commented_at_2020-08-12_0842"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2475#issuecomment-672738774">2020-08-12 08:42</a>:<a class="headerlink" href="#jsmeix_commented_at_2020-08-12_0842" title="Permanent link">&para;</a></h4>
<p>@OliverO2<br />
would you like to open that separated issue about ReaR coding
conventions?</p>
<p>I ask you because I think when you do the initial description<br />
the issue would show things from your point of view which is the point
of view<br />
we need primarily as initial input to get something new and interesting.</p>
<p>In contrast if I did the initial description the issue would<br />
show things from my point of view which is what I described in<br />
<a href="https://github.com/rear/rear/issues/2475#issuecomment-671871423">https://github.com/rear/rear/issues/2475#issuecomment-671871423</a><br />
which is no new and interesting input but "just old known stuff" as in<br />
<a href="https://github.com/rear/rear/wiki/Coding-Style">https://github.com/rear/rear/wiki/Coding-Style</a></p>
<p>And there is no time pressure, in particular no need to change things<br />
in your code right now, so take your time as long as you need.</p>
<h4 id="olivero2_commented_at_2020-08-12_0953"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/issues/2475#issuecomment-672774646">2020-08-12 09:53</a>:<a class="headerlink" href="#olivero2_commented_at_2020-08-12_0953" title="Permanent link">&para;</a></h4>
<p>@jsmeix Sure, I can open the issue. The only downside is that I don't
know how to move comments from this issue to the new one. If this were
possible at all, it would probably be restricted to maintainers. But
let's do it this way, I'll start the new issue sometime this week, so
stay tuned. :-)</p>
<h4 id="jsmeix_commented_at_2020-08-12_1109"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2475#issuecomment-672807928">2020-08-12 11:09</a>:<a class="headerlink" href="#jsmeix_commented_at_2020-08-12_1109" title="Permanent link">&para;</a></h4>
<p>@OliverO2<br />
thank you in advance!</p>
<p>I don't know if it is possible to move comments to another issue.<br />
I see a "Reference in new issue" functionality but that seems to be
something different.<br />
I can hide comments in issues.<br />
So to "move" a comment I would manually copy&amp;paste it into the new
issue<br />
and then I could hide the old comment in the old issue.</p>
<h4 id="olivero2_commented_at_2020-08-23_2004"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/issues/2475#issuecomment-678818393">2020-08-23 20:04</a>:<a class="headerlink" href="#olivero2_commented_at_2020-08-23_2004" title="Permanent link">&para;</a></h4>
<p>@bmastenbrook Thanks again for opening this issue. Just a friendly
reminder: Could you please respond to the suggested solution
(<a href="https://github.com/rear/rear/issues/2475#issuecomment-671361418">https://github.com/rear/rear/issues/2475#issuecomment-671361418</a>)
or state if you have lost interest, so that we have an idea on how to
proceed?</p>
<h4 id="olivero2_commented_at_2020-09-04_0850"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/issues/2475#issuecomment-687016386">2020-09-04 08:50</a>:<a class="headerlink" href="#olivero2_commented_at_2020-09-04_0850" title="Permanent link">&para;</a></h4>
<p>@bmastenbrook I have prepared the above pull request to ease testing.
You could use the patch
<a href="https://github.com/rear/rear/pull/2488.patch">https://github.com/rear/rear/pull/2488.patch</a>
or the entire code at
<a href="https://github.com/OliverO2/rear/tree/feature-opal-nvme-support">https://github.com/OliverO2/rear/tree/feature-opal-nvme-support</a>.
As time permits, of course. 😊</p>
<h4 id="github-actions_commented_at_2020-11-04_0134"><img src="https://avatars.githubusercontent.com/in/15368?v=4" width="50"><a href="https://github.com/apps/github-actions">github-actions</a> commented at <a href="https://github.com/rear/rear/issues/2475#issuecomment-721463247">2020-11-04 01:34</a>:<a class="headerlink" href="#github-actions_commented_at_2020-11-04_0134" title="Permanent link">&para;</a></h4>
<p>Stale issue message</p>
<h4 id="jsmeix_commented_at_2020-11-05_1351"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2475#issuecomment-722390803">2020-11-05 13:51</a>:<a class="headerlink" href="#jsmeix_commented_at_2020-11-05_1351" title="Permanent link">&para;</a></h4>
<p>With
<a href="https://github.com/rear/rear/pull/2488">https://github.com/rear/rear/pull/2488</a>
merged<br />
this issue should be fixed.</p>
<h4 id="gitthangbaby_commented_at_2020-11-15_2056"><img src="https://avatars.githubusercontent.com/u/57070151?v=4" width="50"><a href="https://github.com/gitthangbaby">gitthangbaby</a> commented at <a href="https://github.com/rear/rear/issues/2475#issuecomment-727635409">2020-11-15 20:56</a>:<a class="headerlink" href="#gitthangbaby_commented_at_2020-11-15_2056" title="Permanent link">&para;</a></h4>
<p>i got the git version, flashed Secure Boot PBA and a nice plymouth
dialog is displayed after 11 seconds (not very fast, exactly like LUKS
delay, but better than DTA PBA of 5 seconds + forced reboot 15 sec).
After setting password, the message says "drive couldn't be unlocked"
and next attempts fail to progress booting. In fact, the NVME is indeed
unlocked with first attempt, as I can see when i fallback to OPAL
PBA&gt; command line (and by a negative check of falling back before
password entry). I can unlock with sed-opal-unlocker also as only PBA
changed. I have two NVME so the fastest approach is sed-opal-unlocker
service with 1 sec delay but not suitable for single drive nor boot
files being on the SED drive which i'd like.</p>
<p>unlockers summary:<br />
BIOS: password prompt can be triggered with MBREnable=false but it
doesn't work<br />
DTA PBA: works with 5 + 15sec delay, except Ryzen systems, unreadable
GUI with no pwd repeat, no Secure Boot?<br />
DTA forks: some bring different hashing, some bring support for Ryzen,
added password save for suspend, none are compatible with DTA.
unreadable GUI with no pwd repeat, no Secure Boot?<br />
sed-opal-unlocker: almost no delay, password can be in hashed file,
added password save for suspend, runs as a service too late to move any
boot files to SED drive, compatible with DTA, Secure boot ok<br />
rear: 11sec delay, nice GUI with pwd repeat, added password save for
suspend?, compatible with DTA, Secure boot ok</p>
<h4 id="olivero2_commented_at_2020-11-16_1747"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/issues/2475#issuecomment-728220696">2020-11-16 17:47</a>:<a class="headerlink" href="#olivero2_commented_at_2020-11-16_1747" title="Permanent link">&para;</a></h4>
<p>@gitthangbaby Thanks for your report.</p>
<p>If the PBA fails to unlock your device, could you please use the rescue
system to provide a detailed log?</p>
<p>This is what you could do to help find the cause:</p>
<ol>
<li>Prepare a rescue system on a USB stick according to <strong>Step 3</strong> in
    <a href="https://github.com/rear/rear/blob/master/doc/user-guide/13-tcg-opal-support.adoc#quick-start-setting-up-self-encrypting-disks">Quick Start: Setting up Self-Encrypting
    Disks</a>.</li>
<li>Shut down your system so that SEDs become locked.</li>
<li>Boot the rescue system.</li>
<li>Log in as <code>root</code> (locally, or from another system via <code>ssh</code>)</li>
<li>Run these commands:<ul>
<li><code>lsblk -o +MODEL</code></li>
<li><code>rear opaladmin info</code></li>
</ul>
</li>
<li>Provide the output of the above commands.</li>
<li>Run this command to attempt to unlock SEDs.<ul>
<li><code>rear -D opaladmin unlock</code></li>
</ul>
</li>
<li>Provide the complete contents of the log file
    <code>/var/log/rear/rear-*.log</code><ul>
<li>NOTE: Capture the log contents right away as it will be
    overwritten by the next rear invocation.</li>
</ul>
</li>
<li>Run once more:<ul>
<li><code>rear opaladmin info</code></li>
</ul>
</li>
<li>Provide the output of the above command.</li>
</ol>
<h4 id="gitthangbaby_commented_at_2020-11-24_1814"><img src="https://avatars.githubusercontent.com/u/57070151?v=4" width="50"><a href="https://github.com/gitthangbaby">gitthangbaby</a> commented at <a href="https://github.com/rear/rear/issues/2475#issuecomment-733150205">2020-11-24 18:14</a>:<a class="headerlink" href="#gitthangbaby_commented_at_2020-11-24_1814" title="Permanent link">&para;</a></h4>
<p>Hi. Sorry for no reply, I had a misfortune of flashing the Rear USB
image (thinking it's PBA) to unlocked NVME drive (thinking it's locked),
so i lost all distros. The Rear USB started with grub&gt; only.<br />
Since i have advantage of two drives, i decided to put effort to
initram-ize the boot process and it was extremely difficult but
successful.</p>
<h4 id="olivero2_commented_at_2020-11-24_2204"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/issues/2475#issuecomment-733259736">2020-11-24 22:04</a>:<a class="headerlink" href="#olivero2_commented_at_2020-11-24_2204" title="Permanent link">&para;</a></h4>
<p>@gitthangbaby No problem. It would still be valuable if you could try
<a href="https://github.com/rear/rear/issues/2475#issuecomment-728220696">the above
steps</a>
and provide output and log file. I'm pretty sure whatever is is, it can
be fixed easily once we have the necessary information.</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2024 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2020-08-08.2475.issue.closed.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/rear/rear-user-guide" class="fa fa-code-fork" style="color: #fcfcfc"> rear/rear-user-guide</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
