<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#3068 Issue closed: ISO_RECOVERY_MODE=unattended reboot loop if ISO CD-ROM is first boot device - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#3068 Issue closed: ISO_RECOVERY_MODE=unattended reboot loop if ISO CD-ROM is first boot device";
        var mkdocs_page_input_path = "issues/2023-11-06.3068.issue.closed.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/backup_netfs.html">Example of BACKUP=NETFS</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear29.html">Release Notes ReaR 2.9</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear28.html">Release Notes ReaR 2.8</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#3068 Issue closed: ISO_RECOVERY_MODE=unattended reboot loop if ISO CD-ROM is first boot device</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="3068_issue_closed_iso_recovery_modeunattended_reboot_loop_if_iso_cd-rom_is_first_boot_device"><a href="https://github.com/rear/rear/issues/3068">#3068 Issue</a> <code>closed</code>: ISO_RECOVERY_MODE=unattended reboot loop if ISO CD-ROM is first boot device<a class="headerlink" href="#3068_issue_closed_iso_recovery_modeunattended_reboot_loop_if_iso_cd-rom_is_first_boot_device" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>enhancement</code>, <code>support / question</code>, <code>fixed / solved / done</code></p>
<h4 id="gitarplayer_opened_issue_at_2023-11-06_1224"><img src="https://avatars.githubusercontent.com/u/51920729?v=4" width="50"><a href="https://github.com/GitarPlayer">GitarPlayer</a> opened issue at <a href="https://github.com/rear/rear/issues/3068">2023-11-06 12:24</a>:<a class="headerlink" href="#gitarplayer_opened_issue_at_2023-11-06_1224" title="Permanent link">&para;</a></h4>
<p>ReaR version ("/usr/sbin/rear -V"):<br />
2.7</p>
<p>If your ReaR version is not the current version, explain why you can't
upgrade:</p>
<p>OS version ("cat /etc/os-release" or "lsb_release -a" or "cat
/etc/rear/os.conf"):<br />
RHEL8</p>
<p>ReaR configuration files ("cat /etc/rear/site.conf" and/or "cat
/etc/rear/local.conf"):</p>
<pre><code>OUTPUT=ISO
OUTPUT_URL=nfs://myserver/backups
ISO_DEFAULT=automatic
# ISO_RECOVER_MODE=unattended
</code></pre>
<p>Description of the issue (ideally so that others can reproduce it):</p>
<p>Hello,</p>
<p>I am attempting to create a ReaR recovery environment<br />
to perform automated disaster recovery with ISO output and NFS share.<br />
I want to fully automate the recovery.<br />
If I use ISO_DEFAULT when booted from that ISO<br />
it will automatically trigger the recovery<br />
but at the end there is a prompt<br />
on how one wants to proceed<br />
(Enter rear recovery shell, reboot).<br />
So this is not fully automatic.<br />
If I use ISO_RECOVER_MODE=unattended it automatically reboots<br />
but one is caught in an infinite reboot loop<br />
if the ISO CD Rom is the first boot device.</p>
<p>I know I can handle that at the automation layer<br />
with Ansible and the ILO/Vsphere API logic.<br />
But ideally I am looking for something like<br />
ISO_RECOVER_MODE=poweroff,<br />
which would just shut off after recovery.<br />
I know I could always sed the corresponding bash script<br />
after installing the rear package so it does a poweroff<br />
instead of a reboot.<br />
But I would like to avoid that to keep support by Red Hat.</p>
<ol>
<li>Is there a way to configure this behaviour already?</li>
<li>Or do I need to create a PR for this?</li>
<li>Would it also be merged back to rear 2.6 and repackaged?</li>
</ol>
<p>Thank you very much for your hard work.<br />
I did around 40 rear recovery across physical,<br />
virtualized, RHEL7 and RHEL8 and all worked like a charm.</p>
<h4 id="jsmeix_commented_at_2023-11-06_1409"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/3068#issuecomment-1794906040">2023-11-06 14:09</a>:<a class="headerlink" href="#jsmeix_commented_at_2023-11-06_1409" title="Permanent link">&para;</a></h4>
<p>My first totally offhanded idea is<br />
whether or not it could be sufficiently simple<br />
to enhance the current hardcoded behaviour of</p>
<pre><code>ISO_RECOVER_MODE="unattended"
</code></pre>
<p>by optionally something like</p>
<pre><code>ISO_RECOVER_MODE="unattended=COMMAND"
</code></pre>
<p>so that optionally COMMAND could be run after successful 'rear
recover'<br />
instead of the current hardcoded 'reboot' that is currently online at<br />
<a href="https://github.com/rear/rear/blob/master/usr/share/rear/skel/default/etc/scripts/system-setup#L200">https://github.com/rear/rear/blob/master/usr/share/rear/skel/default/etc/scripts/system-setup#L200</a></p>
<p>Or alternatively (perhaps easier to implement and more versatile<br />
as a separated variable where its value is not a kernel argument)<br />
an additional new config variable like</p>
<pre><code>ISO_RECOVER_MODE_COMMAND="COMMAND"
</code></pre>
<p>or</p>
<pre><code>RECOVERY_REBOOT_COMMAND="COMMAND"
</code></pre>
<p>?</p>
<h4 id="gitarplayer_commented_at_2023-11-06_1857"><img src="https://avatars.githubusercontent.com/u/51920729?v=4" width="50"><a href="https://github.com/GitarPlayer">GitarPlayer</a> commented at <a href="https://github.com/rear/rear/issues/3068#issuecomment-1795946151">2023-11-06 18:57</a>:<a class="headerlink" href="#gitarplayer_commented_at_2023-11-06_1857" title="Permanent link">&para;</a></h4>
<p><code>ISO_RECOVER_MODE_COMMAND="COMMAND</code> sounds like a great suggestion. With
that you could even register your client to a server (for example
subscription-manager or start a monitoring agent like Zabbix or Splunk).
The default value could be reboot for backwards compatibility.</p>
<h4 id="jsmeix_commented_at_2023-11-07_1156"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/3068#issuecomment-1798359915">2023-11-07 11:56</a>:<a class="headerlink" href="#jsmeix_commented_at_2023-11-07_1156" title="Permanent link">&para;</a></h4>
<p>@GitarPlayer<br />
to do some additional things after "rear recover"<br />
had recreated the system (just before "rear recover" exits)<br />
you can use POST_RECOVERY_SCRIPT or POST_RECOVERY_COMMANDS,<br />
see its description in usr/share/rear/conf/default.conf<br />
for ReaR 2.7 online at<br />
<a href="https://github.com/rear/rear/blob/rear-2.7/usr/share/rear/conf/default.conf#L3494">https://github.com/rear/rear/blob/rear-2.7/usr/share/rear/conf/default.conf#L3494</a></p>
<p>What I mean here is only specifically what (simple) command<br />
should be called after "rear recover" had exited<br />
to automatically reboot the recreated system<br />
or alternatively do something else.</p>
<h4 id="jsmeix_commented_at_2023-11-07_1330"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/3068#issuecomment-1798526286">2023-11-07 13:30</a>:<a class="headerlink" href="#jsmeix_commented_at_2023-11-07_1330" title="Permanent link">&para;</a></h4>
<p>After looking at the code in<br />
usr/share/rear/skel/default/etc/scripts/system-setup<br />
I decided (at least for now as far as I understand things)<br />
to implement a simple and generic <code>RECOVERY_REBOOT_COMMAND</code><br />
in particular because <code>ISO_RECOVER_MODE="unattended=COMMAND"</code><br />
would be specific for ISO but we also have PXE_RECOVER_MODE<br />
and I do not like to mess around with possibly complicated<br />
kernel command line arguments with options and values like<br />
<code>ISO_RECOVER_MODE="unattended='COMMAND -option1 --option2=value'"</code><br />
and in general I like to Keep Separated Issues Separated "KSIS"<br />
(i.e. the recover mode versus its "reboot" command),<br />
cf. RFC 1925 item (5)</p>
<pre><code>It is always possible to aglutenate [sic]
multiple separate problems into a single
complex interdependent solution.
In most cases this is a bad idea.
</code></pre>
<p>@GitarPlayer<br />
I would appreciate it if you could have a look<br />
at my currently offhanded and untested proposal<br />
<a href="https://github.com/rear/rear/pull/3070">https://github.com/rear/rear/pull/3070</a></p>
<p>Perhaps you could even test it?<br />
You could manually change your<br />
usr/share/rear/skel/default/etc/scripts/system-setup<br />
as shown in<br />
<a href="https://github.com/rear/rear/pull/3070/files">https://github.com/rear/rear/pull/3070/files</a><br />
but only the RECOVERY_REBOOT_COMMAND changes<br />
(i.e. not the SECRET_OUTPUT_DEV stuff)<br />
and then specify in your etc/rear/local.conf</p>
<pre><code>RECOVERY_REBOOT_COMMAND="poweroff"
</code></pre>
<p>redo a "rear mkbackup" and test if "rear recover"<br />
does an automated 'poweroff' in 'unattended' mode.</p>
<h4 id="gitarplayer_commented_at_2023-11-07_2145"><img src="https://avatars.githubusercontent.com/u/51920729?v=4" width="50"><a href="https://github.com/GitarPlayer">GitarPlayer</a> commented at <a href="https://github.com/rear/rear/issues/3068#issuecomment-1800228239">2023-11-07 21:45</a>:<a class="headerlink" href="#gitarplayer_commented_at_2023-11-07_2145" title="Permanent link">&para;</a></h4>
<p>many thanks @jsmeix that worked like a charm.<br />
I did your suggested changes and I think it would be a great addition.</p>
<p>Pardon my ignorance, but what about setting</p>
<pre><code>POST_RECOVERY_COMMANDS+=( 'echo "powering off in 30 seconds" sleep 30 poweroff' )
</code></pre>
<p>Of course your proposed solution is much nicer<br />
but this would work just fine as interim solution<br />
until your PR is merged and released to RHEL8?<br />
Or am I missing out something obvious?</p>
<h4 id="jsmeix_commented_at_2023-11-08_0846"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/3068#issuecomment-1801338749">2023-11-08 08:46</a>:<a class="headerlink" href="#jsmeix_commented_at_2023-11-08_0846" title="Permanent link">&para;</a></h4>
<p>@GitarPlayer<br />
thank you so much for your test!</p>
<p>Calling 'poweroff' in POST_RECOVERY_COMMANDS<br />
happens while "rear recover" is still running<br />
so 'poweroff' will terminate this running 'rear' process<br />
which works likely OK in practice because at that state<br />
"rear recover" had done its job (i.e. the system is recreated).</p>
<p>But it is cleaner to let the running 'rear' process finish<br />
regularly on its own which does in particular</p>
<pre><code>LogToSyslog "$PROGRAM $WORKFLOW finished with zero exit code"
</code></pre>
<p>see in current GitHub master code<br />
<a href="https://github.com/rear/rear/blob/master/usr/sbin/rear#L759">https://github.com/rear/rear/blob/master/usr/sbin/rear#L759</a><br />
so with 'poweroff' in POST_RECOVERY_COMMANDS<br />
one would no longer get that syslog message<br />
which could make an important difference<br />
for some users in some cases.</p>
<h4 id="gitarplayer_commented_at_2023-11-08_1416"><img src="https://avatars.githubusercontent.com/u/51920729?v=4" width="50"><a href="https://github.com/GitarPlayer">GitarPlayer</a> commented at <a href="https://github.com/rear/rear/issues/3068#issuecomment-1801978158">2023-11-08 14:16</a>:<a class="headerlink" href="#gitarplayer_commented_at_2023-11-08_1416" title="Permanent link">&para;</a></h4>
<p>thank you very much for pointing out the exact difference. LogToSyslog
could be very useful for Event Driven Ansible indeed.</p>
<h4 id="pcahyna_commented_at_2023-11-08_2308"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/3068#issuecomment-1802861048">2023-11-08 23:08</a>:<a class="headerlink" href="#pcahyna_commented_at_2023-11-08_2308" title="Permanent link">&para;</a></h4>
<p>Hi @GitarPlayer</p>
<p>I think there are two ways to approach the problem. You can have manual
intervention before the start of the recovery, or after it. In the first
case, you can remove <code>ISO_DEFAULT=automatic</code> and select the appropriate
entry in the ReaR boot menu manually when the CD boots. I believe the
default entry chainloads the first hard drive without manual
intervention, so this way the reboot loop is avoided.</p>
<p>If after the recovery, you need to change the boot order after the
recovery has completed and the system has rebooted. The new
<code>RECOVERY_REBOOT_COMMAND="poweroff"</code> will help with the reboot loop, but
you still have to change the boot order next time when you power the
machine back on. Since we can't change the boot order from inside the
system, there is no way around the problem (except maybe putting "eject"
into <code>POST_RECOVERY_COMMANDS</code>, but even then I suspect the BIOS will
load the CD-ROM tray back before attempting to boot from it).</p>
<p>Note that the problem is specific to BIOS machines. On machines with
smarter firmware (UEFI, Open Firmware) we restore the original boot
order, which means that next time we will boot into the recovered system
and not the recovery medium.</p>
<h4 id="schlomo_commented_at_2023-11-10_1040"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/issues/3068#issuecomment-1805485385">2023-11-10 10:40</a>:<a class="headerlink" href="#schlomo_commented_at_2023-11-10_1040" title="Permanent link">&para;</a></h4>
<p>Thanks everybody for <em>not</em> doing <code>KEY=VAL=CUSTOM</code> stuff...</p>
<p>I guess you could manage to start a delayed poweroff via
<code>POST_RECOVERY_COMMANDS</code> but it is not very intuitive as ReaR tries
really hard to collect all subprocesses.</p>
<p>#3070 will provide a nice solution.</p>
<h4 id="pcahyna_commented_at_2023-11-13_1635"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/3068#issuecomment-1808519044">2023-11-13 16:35</a>:<a class="headerlink" href="#pcahyna_commented_at_2023-11-13_1635" title="Permanent link">&para;</a></h4>
<p>KEY=VAL=CUSTOM would be really quite ugly and at the same time
inflexible.</p>
<h4 id="jsmeix_commented_at_2023-11-21_1150"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/3068#issuecomment-1820769846">2023-11-21 11:50</a>:<a class="headerlink" href="#jsmeix_commented_at_2023-11-21_1150" title="Permanent link">&para;</a></h4>
<p>With
<a href="https://github.com/rear/rear/pull/3070">https://github.com/rear/rear/pull/3070</a>
merged<br />
this issue should be solved.</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2025 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2023-11-06.3068.issue.closed.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/rear/rear-user-guide" class="fa fa-code-fork" style="color: #fcfcfc"> rear/rear-user-guide</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
