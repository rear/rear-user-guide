<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#1513 PR merged: Avoid leaking unprotected SSH keys for root user into rescue medium and introduce ssh-agent - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#1513 PR merged: Avoid leaking unprotected SSH keys for root user into rescue medium and introduce ssh-agent";
        var mkdocs_page_input_path = "issues/2017-09-24.1513.pr.merged.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#1513 PR merged: Avoid leaking unprotected SSH keys for root user into rescue medium and introduce ssh-agent</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="1513_pr_merged_avoid_leaking_unprotected_ssh_keys_for_root_user_into_rescue_medium_and_introduce_ssh-agent"><a href="https://github.com/rear/rear/pull/1513">#1513 PR</a> <code>merged</code>: Avoid leaking unprotected SSH keys for root user into rescue medium and introduce ssh-agent<a class="headerlink" href="#1513_pr_merged_avoid_leaking_unprotected_ssh_keys_for_root_user_into_rescue_medium_and_introduce_ssh-agent" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>fixed / solved / done</code>, <code>critical / security / legal</code></p>
<h4 id="schlomo_opened_issue_at_2017-09-24_1619"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> opened issue at <a href="https://github.com/rear/rear/pull/1513">2017-09-24 16:19</a>:<a class="headerlink" href="#schlomo_opened_issue_at_2017-09-24_1619" title="Permanent link">&para;</a></h4>
<p>Fixes #1511 and continues the work from #1500</p>
<p>Thanks a lot to @OliverO2 for the initial work. I removed the code that
encrypts SSH keys so that we now simply remove unprotected SSH keys from
the rescue media (unless explicit configuration tells us to keep
unprotected SSH keys).</p>
<p>This change improves the security of ReaR but constitutes a breaking in
change. I find improving the security a good reason for breaking
changes, we just have to explain it in the release notes.</p>
<h4 id="jsmeix_commented_at_2017-09-26_0821"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1513#issuecomment-332123766">2017-09-26 08:21</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-09-26_0821" title="Permanent link">&para;</a></h4>
<p>I fully agree with all you - which means from my point of view<br />
there is actually no conflict - everybody is right - only the<br />
current implementation is insufficient - according to how<br />
I understand the above comments.</p>
<p>The current implementation has the same shortcoming<br />
as much (probaby even most) other code in ReaR also has:<br />
The general shortcoming in ReaR is that it too often<br />
tries to do "things right only fully automated".<br />
The "only" is the actual problem.</p>
<p>Nothing is wrong with "try to do things right fully automated".<br />
This should be the usual default behaviour in ReaR.</p>
<p>But things fail when "fully automated" is the only way.<br />
It is against the idea that the user must have final power.<br />
To provide ready-made final power to our ReaR users<br />
there must be powerful config variable settings.</p>
<p>Currently the boolean SSH_UNPROTECTED_PRIVATE_KEYS<br />
cannot provide much power to the user because all what the<br />
user can do is to set this to a 'true' value and then all power<br />
is left to ReaR to do "things right fully automated".</p>
<p>But any automatism will fail in this or that cases.<br />
In this case the automated unprotected SSH keys detection<br />
fails in this or that cases.</p>
<p>Therefore the user must get the final power to specify<br />
what exactly he wants and ReaR must just obey.</p>
<p>Note the crucial difference:<br />
Ideally the user should not need to specify something.<br />
Ideally ReaR does "things right fully automated"<br />
when the user has not specified what to do.<br />
But when needed the user must be able to explicitly<br />
specify anything exactly as he he wants it to be done.</p>
<p>The solution is to implement a config variable that specifies<br />
what SSH keys get included in the recovery system<br />
as a string of words (i.e. each value is a word)<br />
or preferably as an array (to be future-proof so that<br />
a single value can be also a strings of several words).</p>
<p>A setting like<br />
SSH_KEYS=( 'no_autodetected_unprotected_keys' )<br />
has the same meaning as now, i.e. a best effort attempt<br />
to autodetect unprotected SSH keys and exclude them.</p>
<p>A setting like<br />
SSH_KEYS=( 'no' )<br />
will not copy any SSH keys (i.e. all scripts and other<br />
code pieces that copy SSH keys are completely skipped).<br />
Nevertheless the user can still use COPY_AS_IS<br />
to copy exactly only those SSH keys that he wants.</p>
<p>A setting like<br />
SSH_KEYS=( 'yes' )<br />
will copy all SSH keys in a predefined (i.e. hardcoded) list<br />
of directories (those directories need to be documented).<br />
I think this is the current behaviour (without this pull request)<br />
so that it provides the backward compatible behaviour<br />
for those users who need that.<br />
It needs to be documented that this behaviour is insecure.<br />
This behaviour should no longer be the default.</p>
<p>A setting like<br />
SSH_KEYS=( ' ' )<br />
will do whatever we think the best default is.</p>
<p>A setting like<br />
SSH_KEYS=( '/etc/ssh*' '/etc/openssh*' '/etc/centrifydc/ssh*'
'/root/.ssh' '/root/.shosts' )<br />
could be a list of bash globbing patterns or probably even<br />
better a list of filename globbing patterns that are used<br />
as '-iname' arguments for 'find' calls to find SSH keys.</p>
<p>Cf. how I implemented FIRMWARE_FILES<br />
UEFI_BOOTLOADER and MODULES.</p>
<h4 id="jsmeix_commented_at_2017-09-26_0840"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1513#issuecomment-332128486">2017-09-26 08:40</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-09-26_0840" title="Permanent link">&para;</a></h4>
<p>@schlomo<br />
only a side note regarding<br />
"How should users restore their backup if the keys are required for
that?"<br />
see RECOVERY_UPDATE_URL my grand big hammer<br />
for anything an unlucky admin might need when it is already<br />
too late to recreate his recovery system :-)</p>
<h4 id="jsmeix_commented_at_2017-09-26_0846"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1513#issuecomment-332130167">2017-09-26 08:46</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-09-26_0846" title="Permanent link">&para;</a></h4>
<p>@OliverO2<br />
only a side note regarding<br />
"inconvenience of entering a password once or twice during restore":<br />
When the new UserInput function is used to get the password<br />
from the user one can even predefine the input in a (hopefully)<br />
sufficiently secure way in the running recovery system before<br />
running "rear recover" via</p>
<pre>
# export USER_INPUT_matching_ID="mypassword"
</pre>

<h4 id="olivero2_commented_at_2017-09-26_2011"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/pull/1513#issuecomment-332320728">2017-09-26 20:11</a>:<a class="headerlink" href="#olivero2_commented_at_2017-09-26_2011" title="Permanent link">&para;</a></h4>
<p>@jsmeix Understood. For me it would be sufficient to ask for the
password once in the restore script. This is where all SSH access takes
place.</p>
<p>The difficulty lies in transmitting the password to <code>ssh</code>. As it wants
to gather the password via direct tty access, transferring it via stdin
is not an option. You'd have to resort to using <code>sshpass</code> for that. The
<a href="http://manpages.ubuntu.com/manpages/xenial/en/man1/sshpass.1.html">sshpass manual
page</a>
explains:</p>
<pre><code>SECURITY CONSIDERATIONS
       First  and  foremost,  users  of  sshpass  should  realize  that  ssh's
       insistance on only getting the password interactively  is  not  without
       reason.  It  is close to impossible to securely store the password, [...]
</code></pre>
<p>Also note that <code>sshpass</code> might not be installed by default. On Ubuntu
16.04 LTS, it is not.</p>
<p>So yes, it can be done to have the user enter an SSH password once and
use it multiple times afterwards. It's not as risky on a (single-user,
run-once) rescue system as it would be on a multi-user production
system. It's also not risk free (e.g., future modifications to
general-purpose ReaR code might introduce accidental logging/storing).</p>
<h4 id="schlomo_commented_at_2017-09-27_0532"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/1513#issuecomment-332413380">2017-09-27 05:32</a>:<a class="headerlink" href="#schlomo_commented_at_2017-09-27_0532" title="Permanent link">&para;</a></h4>
<p>About the general direction: I think that we should keep in mind that
ReaR is <strong>just a tool</strong> and not a magic solution. For me that means that
it should strive to be as secure by default as we can make it without
completely loosing our main functionality. It also means that we should
let the admin decide everything else. And we should try to automate the
common cases while enabling custom cases through configuration.</p>
<p>I'd also like to keep it simple. As the ssh handling only uses the
<code>COPY_AS_IS</code> array the admin can easily use <code>COPY_AS_IS_EXCLUDE</code> to
exclude further files if he wants to keep them off the rescue media.
This is actually a real advantage of using existing ReaR infrastructure
for the copy instead of coding something special. I there at this moment
would prefer not to introduce a complex <code>SSH_KEYS</code> variable as described
by @jsmeix above (sorry and thanks for the illustration) in an attempt
to keep the complexity of this topic low.</p>
<p>With regard to passwords I also think we should keep things sufficiently
simple. If we want users to be able to enter SSH passwords during
recovery then we should let the ssh tool prompt for them. Why? Because
ReaR is meant to be a wrapper that automates the existing standard
tools.</p>
<p>I actually don't remember anybody who explicitly wanted to use SSH
passwords before, to the best of my knowledge everybody seems to use SSH
keys. I would therefore consider SSH password a custom use case that we
should make efforts not to obstruct but I wouldn't optimize for it.</p>
<h4 id="jsmeix_commented_at_2017-09-27_1152"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1513#issuecomment-332496642">2017-09-27 11:52</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-09-27_1152" title="Permanent link">&para;</a></h4>
<p>Only FYI regarding "let the ssh tool prompt for [passwords]", cf.<br />
<a href="https://github.com/rear/rear/pull/1493#issuecomment-332141858">https://github.com/rear/rear/pull/1493#issuecomment-332141858</a></p>
<h4 id="olivero2_commented_at_2017-09-27_1501"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/pull/1513#issuecomment-332551016">2017-09-27 15:01</a>:<a class="headerlink" href="#olivero2_commented_at_2017-09-27_1501" title="Permanent link">&para;</a></h4>
<p>To be sure, I've just checked the <code>ssh</code> client (OpenSSH 7.2): It does
not use file descriptors 0, 1, 2. It opens <code>/dev/tty</code> in read/write mode
and uses it to issue the password prompt and to read the password. So it
just ignores I/O redirections. AFAIK it's been this way almost from the
beginning of time ;-).</p>
<h4 id="jsmeix_commented_at_2017-09-27_1609"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1513#issuecomment-332573233">2017-09-27 16:09</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-09-27_1609" title="Permanent link">&para;</a></h4>
<p>@schlomo<br />
ultimately it this pull request is your code<br />
so that the final decision is of course yours.</p>
<p>Nevertheless an addedum regarding my proposal in<br />
<a href="https://github.com/rear/rear/pull/1513#issuecomment-332123766">https://github.com/rear/rear/pull/1513#issuecomment-332123766</a></p>
<p>I did not mean that all those fancy SSH_KEYS functionality<br />
is needed right now - perhaps none of the fancy functionality is<br />
ever needed.</p>
<p>But I meant that you may not introduce now a rather limited<br />
new boolean SSH_UNPROTECTED_PRIVATE_KEYS<br />
but use a more versatile usable variable from the beginning<br />
so that if needed we could more easily enhance its functionality.</p>
<p>For now I think only support for something like<br />
SSH_KEYS=( 'no_autodetected_unprotected_keys' )<br />
plus<br />
SSH_KEYS=( 'no' )<br />
to provide also a secure setting is probably sufficient.</p>
<p>For that a plain string variable is also sufficient like<br />
SSH_KEYS='no_autodetected_unprotected_keys'<br />
SSH_KEYS='no'<br />
because one can easily enhance string variables into arrays.</p>
<h4 id="jsmeix_commented_at_2017-10-04_1429"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1513#issuecomment-334174185">2017-10-04 14:29</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-10-04_1429" title="Permanent link">&para;</a></h4>
<p>@schlomo<br />
I would like to suggest that you "just merge" whatever<br />
seems to be "the right thing from your current point of view"<br />
at least as a first step to get the whole issue moved forward.</p>
<p>There are still three weeks left until ReaR 2.3 is planned<br />
to be released (currently "Due by October 31, 2017")<br />
where others could implement further adaptions and<br />
enhancements if needed.</p>
<h4 id="jsmeix_commented_at_2017-10-09_1031"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1513#issuecomment-335119911">2017-10-09 10:31</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-10-09_1031" title="Permanent link">&para;</a></h4>
<p>@gdha @gozora do you have an opinion<br />
how we could proceed here?</p>
<p>I would just merge it as is<br />
so that others (if needed) may further adapt and enhance it<br />
so that in the end we could release something that is<br />
considered to be " reasonably o.k." in ReaR 2.3.</p>
<p>Simply put:<br />
Should I just merge it as is soon?</p>
<h4 id="gdha_commented_at_2017-10-09_1104"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/pull/1513#issuecomment-335126363">2017-10-09 11:04</a>:<a class="headerlink" href="#gdha_commented_at_2017-10-09_1104" title="Permanent link">&para;</a></h4>
<p>@jsmeix sure - go ahead and merge it (as it is now)</p>
<h4 id="gozora_commented_at_2017-10-09_1131"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/pull/1513#issuecomment-335131512">2017-10-09 11:31</a>:<a class="headerlink" href="#gozora_commented_at_2017-10-09_1131" title="Permanent link">&para;</a></h4>
<p>@jsmeix<br />
Ok for me ...</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2023 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2017-09-24.1513.pr.merged.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
