<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>2017 08 01.1437.issue.closed - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "2017 08 01.1437.issue.closed";
        var mkdocs_page_input_path = "issues/2017-08-01.1437.issue.closed.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/rust.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', '366986045', 'auto');
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a> &raquo;</li>
      <li>2017 08 01.1437.issue.closed</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="1437_issue_closed_it_seems_migration_mode_migrates_only_disks_but_not_the_bootloader"><a href="https://github.com/rear/rear/issues/1437">#1437 Issue</a> <code>closed</code>: It seems migration mode migrates only disks but not the bootloader<a class="headerlink" href="#1437_issue_closed_it_seems_migration_mode_migrates_only_disks_but_not_the_bootloader" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>enhancement</code>, <code>bug</code>, <code>no-issue-activity</code></p>
<h4 id="jsmeix_opened_issue_at_2017-08-01_1253"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> opened issue at <a href="https://github.com/rear/rear/issues/1437">2017-08-01 12:53</a>:<a class="headerlink" href="#jsmeix_opened_issue_at_2017-08-01_1253" title="Permanent link">&para;</a></h4>
<p>I am playing around with the migration mode<br />
using current ReaR master code:</p>
<p>First and foremost:<br />
Currently I have no real practical experience with using<br />
the migration mode so that I could do "stupid things".<br />
But even if I do "stupid things" it would be nice if ReaR<br />
could detect that and show an information message.</p>
<p>What I did:</p>
<p>I migrated an original system on a single /dev/sda onto<br />
a replacement system with two disks /dev/sda and /dev/sdb.</p>
<p>First I used the new /dev/sda for an initial "rear recover"<br />
and the recreated system works well.</p>
<p>Then (using the same replacement system) I tried<br />
to migrate the original /dev/sda onto the new /dev/sdb<br />
(and leave the existing new /dev/sda untouched).</p>
<p>After reboot from /dev/sdb it is /dev/sda2 that is mounted at '/'<br />
in the recreated system instead of the expected /dev/sdb2.</p>
<p>Details:</p>
<p>During 'rear recover' (with
<a href="https://github.com/rear/rear/pull/1434">https://github.com/rear/rear/pull/1434</a>)<br />
I get (excerpts):</p>
<pre>
RESCUE e205:~ # rear recover
...
Comparing disks.
Device sda has size 22548578304, 21474836480 expected
Switching to manual disk layout configuration.
Original disk /dev/sda does not exist (with same size) in the target system
Choose an appropriate replacement for /dev/sda
1) /dev/sda
2) /dev/sdb
3) Do not map /dev/sda
4) Use Relax-and-Recover shell and return back to here
(default 1 timeout 300 seconds)
2
Using /dev/sdb (chosen by user) for recreating /dev/sda
Current disk mapping table (source -> target):
    /dev/sda /dev/sdb
Confirm or edit the disk mapping
1) Confirm disk mapping and continue 'rear recover'
2) Edit disk mapping (/var/lib/rear/layout/disk_mappings)
3) Use Relax-and-Recover shell and return back to here
4) Abort 'rear recover'
(default 1 timeout 300 seconds)
1
User confirmed disk mapping
...
Start system layout restoration.
Creating partitions for disk /dev/sdb (msdos)
Creating filesystem of type ext4 with mount point / on /dev/sdb2.
/dev/sdb2: 2 bytes were erased at offset 0x00000438 (ext4): 53 ef
Mounting filesystem /
Creating swap on /dev/sdb1
Disk layout created.
Restoring from '/tmp/rear.fn8jkb8erNoB8Md/outputfs/e205/backup.tar.gz'...
...
Restored 2435 MiB in 34 seconds [avg. 73364 KiB/sec]
Restoring finished.
Running mkinitrd...
Recreated initrd (/sbin/mkinitrd).
Installing GRUB2 boot loader
Finished recovering your system. You can explore it under '/mnt/local'.

RESCUE e205:~ # mount | grep sd
/dev/sdb2 on /mnt/local type ext4 (rw,relatime,data=ordered)

RESCUE e205:~ # cat /mnt/local/etc/fstab
# UUID=28e43119-dac1-4426-a71a-1d70b26d33d7 swap                 swap       defaults              0 0
# UUID=46d7e8be-7812-49d1-8d24-e25ed0589e94 /                    ext4       acl,user_xattr        1 1
/dev/sdb1  swap  swap  defaults        0 0
/dev/sdb2  /     ext4  acl,user_xattr  1 1

RESCUE e205:~ # reboot
</pre>

<p>But after reboot from /dev/sdb<br />
it is /dev/sda2 that is mounted at '/' (instead of /dev/sdb2):</p>
<pre>
g198:~ # findmnt | grep sd
/                     /dev/sda2  ext4       rw,relatime,data=ordered

g198:~ # cat /etc/fstab
# UUID=28e43119-dac1-4426-a71a-1d70b26d33d7 swap                 swap       defaults              0 0
# UUID=46d7e8be-7812-49d1-8d24-e25ed0589e94 /                    ext4       acl,user_xattr        1 1
/dev/sda1  swap  swap  defaults        0 0
/dev/sda2  /     ext4  acl,user_xattr  1 1
</pre>

<p>I did not yet check the details but on first glance it looks as if<br />
the bootloader that was installed on /dev/sdb uses /dev/sda2<br />
as root partition and because I had initially done a recovery<br />
onto /dev/sda that even boots but it is not what I intended.</p>
<p>When I grep for MIGRATION_MODE in the sources<br />
it is found only in those files:</p>
<pre>
layout/prepare/GNU/Linux/100_include_partition_code.sh
layout/prepare/GNU/Linux/110_include_lvm_code.sh
layout/prepare/default/010_prepare_files.sh
layout/prepare/default/250_compare_disks.sh
layout/prepare/default/300_map_disks.sh
layout/prepare/default/320_apply_mappings.sh
layout/prepare/default/400_autoresize_disks.sh
layout/prepare/default/500_confirm_layout.sh
layout/prepare/default/270_overrule_migration_mode.sh
layout/recreate/default/100_ask_confirmation.sh
</pre>

<p>This indicates that migration mode migrates only disks<br />
but not the bootloader.</p>
<p>Because I am not aware of user reports about this issue<br />
I consider it only as a "minor bug" that bootloader is not<br />
migrated in compliance with a disk migration.<br />
I assume in practice the boot disk is not changed<br />
(only the boot disk size may change in practice)<br />
so that I assume bootloader migration is perhaps<br />
not really important in practice.</p>
<h4 id="jsmeix_commented_at_2017-08-01_1355"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1437#issuecomment-319376858">2017-08-01 13:55</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-08-01_1355" title="Permanent link">&para;</a></h4>
<p>@gozora<br />
because this issue is related to bootloader installation:</p>
<p>I do not understand how $VAR_DIR/recovery/bootdisk is used.<br />
As far as I see this file is only written in<br />
prep/GNU/Linux/300_include_grub_tools.sh<br />
and prep/default/320_include_uefi_env.sh<br />
but I cannot find where that information is ever used<br />
during "rear recover".</p>
<p>Do you know how $VAR_DIR/recovery/bootdisk<br />
is meant to be used?</p>
<p>As far as I see in<br />
finalize/Linux-i386/620_install_grub2.sh<br />
it installs the bootloader based on autodetected<br />
information what device is mounted<br />
in the recovery system at '/mnt/local/'<br />
i.e. what should also be mounted later<br />
in the recreated system at '/'.</p>
<p>It seems things work somewhat unpredictable<br />
(at least for my tests):</p>
<p>I did a second try to recover on my replacement system<br />
onto /dev/sdb (and leave its /dev/sda untouched) using<br />
the same existing ReaR ISO image and backup.tar.gz.</p>
<p>In the recovery system before I run "rear recover" I get</p>
<pre>
RESCUE e205:~ # cat /var/lib/rear/recovery/bootdisk 
/dev/sda2

RESCUE e205:~ # cat /var/lib/rear/recovery/bootloader 
GRUB2
</pre>

<p>Both are right because it is what there is on the original system.</p>
<p>Now I recover on a replacement system onto /dev/sdb as described<br />
in
<a href="https://github.com/rear/rear/issues/1437#issue-247058823">https://github.com/rear/rear/issues/1437#issue-247058823</a><br />
but now I run "rear -d -D recover" to get full debugging.</p>
<p>After "rear -d -D recover" I get in the still running<br />
recovery system in the ReaR log file:</p>
<pre>
+ source /usr/share/rear/finalize/Linux-i386/620_install_grub2.sh
...
++ bootparts=/dev/sdb2
...
++ bootdisk=/dev/sdb
...
++ grub2-install --root-directory=/mnt/local /dev/sdb
Installing for i386-pc platform.
grub2-install: warning: cannot open directory `/usr/share/locale': No such file or directory.
Installation finished. No error reported.
</pre>

<p>Furthermore I get in the still running recovery system:</p>
<pre>
RESCUE e205:~ # grep 'root=' /mnt/local/boot/grub2/grub.cfg
set root='hd0,msdos2'
set root='hd0,msdos2'
        set root='hd0,msdos2'
        linux   /boot/vmlinuz-4.4.21-69-default root=UUID=46d7e8be-7812-49d1-8d24-e25ed0589e94  resume=/dev/sda1 splash=silent quiet showopts
                set root='hd0,msdos2'
                linux   /boot/vmlinuz-4.4.21-69-default root=UUID=46d7e8be-7812-49d1-8d24-e25ed0589e94  resume=/dev/sda1 splash=silent quiet showopts
                set root='hd0,msdos2'
                linux   /boot/vmlinuz-4.4.21-69-default root=UUID=46d7e8be-7812-49d1-8d24-e25ed0589e94  

RESCUE e205:~ # ls -l /dev/disk/by-uuid/
total 0
lrwxrwxrwx 1 root root  9 Aug  1 13:20 2017-08-01-09-40-25-00 -> ../../sr0
lrwxrwxrwx 1 root root 10 Aug  1 13:20 28e43119-dac1-4426-a71a-1d70b26d33d7 -> ../../sdb1
lrwxrwxrwx 1 root root 10 Aug  1 13:20 46d7e8be-7812-49d1-8d24-e25ed0589e94 -> ../../sdb2
</pre>

<p>That looks to me as if the bootloader is correctly installed<br />
onto /dev/sdb and this time after reboot from /dev/sdb<br />
it is actually /dev/sdb2 that is mounted at '/' as expected.</p>
<p>At least for me something does not work consistently here:<br />
Two subsequent "rear recover" using same ReaR ISO image and<br />
same backup.tar.gz should not result different recreated systems.</p>
<h4 id="jsmeix_commented_at_2017-08-01_1455"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1437#issuecomment-319395392">2017-08-01 14:55</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-08-01_1455" title="Permanent link">&para;</a></h4>
<p>A third retry to recover on my replacement system<br />
onto /dev/sdb (and leave its /dev/sda untouched) using<br />
the same existing ReaR ISO image and backup.tar.gz<br />
results again that /dev/sda2 gets falsely mounted on '/'<br />
in the recreated system.</p>
<p>Also a fourth and a fifth retry results that /dev/sda2<br />
gets falsely mounted on '/' in the recreated system.</p>
<h4 id="gozora_commented_at_2017-08-01_1552"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/1437#issuecomment-319412972">2017-08-01 15:52</a>:<a class="headerlink" href="#gozora_commented_at_2017-08-01_1552" title="Permanent link">&para;</a></h4>
<p>@jsmeix, I've never try migration mode actually, but I'll take a look as
it seems to be interesting topic.<br />
It will take me some time however as my new computer arrived yesterday
and I need to do some installation work first ;-).</p>
<p>V.</p>
<h4 id="schabrolles_commented_at_2017-08-23_1138"><img src="https://avatars.githubusercontent.com/u/19491077?u=0021b16ab426902cbe676f6831f41607bbe4d441&v=4" width="50"><a href="https://github.com/schabrolles">schabrolles</a> commented at <a href="https://github.com/rear/rear/issues/1437#issuecomment-324302791">2017-08-23 11:38</a>:<a class="headerlink" href="#schabrolles_commented_at_2017-08-23_1138" title="Permanent link">&para;</a></h4>
<p>@jsmeix,<br />
could you try again, but before starting a recover, try to wipe the
disks before with dd</p>
<pre><code>dd if=/dev/zero of=/dev/sda bs=1M count=1000
dd if=/dev/zero of=/dev/sdb bs=1M count=1000
</code></pre>
<p>if the disks are not wiped, you could have twice the same UUID created
for the FS (or maybe VG/LV duplicate). OS could mount the first device
it gets as /</p>
<h4 id="jsmeix_commented_at_2017-10-20_0949"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1437#issuecomment-338160426">2017-10-20 09:49</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-10-20_0949" title="Permanent link">&para;</a></h4>
<p>Will not be solved for the ReaR v2.3 release<br />
but later in a ReaR future release.</p>
<h4 id="jsmeix_commented_at_2017-11-28_1519"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1437#issuecomment-347556381">2017-11-28 15:19</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-11-28_1519" title="Permanent link">&para;</a></h4>
<p>Because of<br />
<a href="https://github.com/rear/rear/issues/1271#issuecomment-347555836">https://github.com/rear/rear/issues/1271#issuecomment-347555836</a><br />
I think this issue here is no longer a minor bug but a normal bug.</p>
<h4 id="jsmeix_commented_at_2018-07-06_1241"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1437#issuecomment-403022440">2018-07-06 12:41</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-07-06_1241" title="Permanent link">&para;</a></h4>
<p>Since
<a href="https://github.com/rear/rear/pull/1843">https://github.com/rear/rear/pull/1843</a>
is merged therein the commit<br />
<a href="https://github.com/rear/rear/pull/1843/commits/0ce177d1019064ec4f74110ed003579430b99d34">https://github.com/rear/rear/pull/1843/commits/0ce177d1019064ec4f74110ed003579430b99d34</a><br />
migrates also the GRUB2 bootloader installation on x86 compatible
architecture<br />
according to the disk layout mapping.</p>
<p>When
<a href="https://github.com/rear/rear/pull/1848">https://github.com/rear/rear/pull/1848</a>
gets merged<br />
also the GRUB2 bootloader installation on PPC64/PPC64LE<br />
gets migrated according to the disk layout mapping.</p>
<p>But currently nothing is done to migrate other bootloader
installations<br />
according to the disk layout mapping.</p>
<h4 id="github-actions_commented_at_2020-07-01_0133"><img src="https://avatars.githubusercontent.com/in/15368?v=4" width="50"><a href="https://github.com/apps/github-actions">github-actions</a> commented at <a href="https://github.com/rear/rear/issues/1437#issuecomment-652134819">2020-07-01 01:33</a>:<a class="headerlink" href="#github-actions_commented_at_2020-07-01_0133" title="Permanent link">&para;</a></h4>
<p>Stale issue message</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2022 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2017-08-01.1437.issue.closed.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
