<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#2125 PR merged: Fix #2120: avoid unwanted "Welcome to" messages in log file - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#2125 PR merged: Fix #2120: avoid unwanted \"Welcome to\" messages in log file";
        var mkdocs_page_input_path = "issues/2019-04-28.2125.pr.merged.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a> &raquo;</li>
      <li class="breadcrumb-item active">#2125 PR merged: Fix #2120: avoid unwanted "Welcome to" messages in log file</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="2125_pr_merged_fix_2120_avoid_unwanted_welcome_to_messages_in_log_file"><a href="https://github.com/rear/rear/pull/2125">#2125 PR</a> <code>merged</code>: Fix #2120: avoid unwanted "Welcome to" messages in log file<a class="headerlink" href="#2125_pr_merged_fix_2120_avoid_unwanted_welcome_to_messages_in_log_file" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>enhancement</code>, <code>cleanup</code>, <code>fixed / solved / done</code>,
<code>minor bug</code></p>
<h4 id="olivero2_opened_issue_at_2019-04-28_1622"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> opened issue at <a href="https://github.com/rear/rear/pull/2125">2019-04-28 16:22</a>:<a class="headerlink" href="#olivero2_opened_issue_at_2019-04-28_1622" title="Permanent link">&para;</a></h4>
<h5 id="pull_request_details">Pull Request Details:<a class="headerlink" href="#pull_request_details" title="Permanent link">&para;</a></h5>
<ul>
<li>
<p>Type: <strong>Bug Fix</strong></p>
</li>
<li>
<p>Impact: <strong>Low</strong></p>
</li>
<li>
<p>Reference to related issue (URL): #2120</p>
</li>
<li>
<p>How was this pull request tested? Ran <code>rear mkrescue</code> on Ubuntu
    18.04.2 LTS server before and after patching. Verifying log output
    changes as intended. Also tested a full restore successfully.</p>
</li>
<li>
<p>Brief description of the changes in this pull request:</p>
</li>
</ul>
<p>This PR intends to fix #2120, avoiding unwanted "Welcome to" messages
in the log file from <code>rear mkrescue</code>.</p>
<p>These invocations of <code>bash --login</code> in
<code>usr/share/rear/build/default/990_verify_rootfs.sh</code> were affected as
follows:</p>
<ol>
<li>Motd message does not appear in log file, as output is filtered by
    <em>grep</em>. But if someone would change the welcome message text to
    something containing the phrase "not found", the grep expression
    would always match and subsequent code would behave erroneously. The
    fix prevents this.</li>
<li>Motd does appear in log file. Fix has been verified to suppress it.</li>
<li>Motd does appear in log file. Fix has been verified to suppress it.</li>
</ol>
<p>Other invocations of <code>bash --login</code> across rear scripts are not affected
in the same way: They do not chroot into the rescue system
(<code>chroot $ROOTFS_DIR</code>), but into the recovered target system instead
(<code>chroot $TARGET_FS_ROOT</code>). The target system has its own set of bash
profile files, so it does not emit the ReaR welcome message. Examples
tested:</p>
<ul>
<li><code>usr/share/rear/finalize/Debian/i386/550_rebuild_initramfs.sh</code></li>
<li><code>usr/share/rear/finalize/Linux-i386/660_install_grub2.sh</code></li>
<li><code>usr/share/rear/restore/default/900_create_missing_directories.sh</code></li>
</ul>
<h4 id="schlomo_commented_at_2019-04-28_1625"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/2125#issuecomment-487393960">2019-04-28 16:25</a>:<a class="headerlink" href="#schlomo_commented_at_2019-04-28_1625" title="Permanent link">&para;</a></h4>
<p>Good catch, redirecting STDIN makes sure that the shell is
non-interactive.</p>
<h4 id="olivero2_commented_at_2019-04-28_1648"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/pull/2125#issuecomment-487395889">2019-04-28 16:48</a>:<a class="headerlink" href="#olivero2_commented_at_2019-04-28_1648" title="Permanent link">&para;</a></h4>
<p>At least the redirection covers what
<code>usr/share/rear/skel/default/etc/bash.bashrc</code> thinks about
interactivity. Bash seems to have its own notion of it and the presence
of the <code>-c</code> option already makes it consider itself non-interactive (<code>i</code>
missing from <code>$-</code>).</p>
<h4 id="gdha_commented_at_2019-04-29_0804"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/pull/2125#issuecomment-487484869">2019-04-29 08:04</a>:<a class="headerlink" href="#gdha_commented_at_2019-04-29_0804" title="Permanent link">&para;</a></h4>
<p>@jsmeix looks worth taking with the release 2.5, no?<br />
@OliverO2 thanks for the cleanup of the code</p>
<h4 id="jsmeix_commented_at_2019-04-29_0822"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2125#issuecomment-487489546">2019-04-29 08:22</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-04-29_0822" title="Permanent link">&para;</a></h4>
<p>@OliverO2<br />
as always many thanks for your thorough analysis of the issue<br />
and for your fix!</p>
<p>Because you wrote (excerpts)</p>
<pre><code>Motd message does not appear in log file,
as output is filtered by 'grep'
...
(chroot $TARGET_FS_ROOT). The target system
has its own set of bash profile files
</code></pre>
<p>I got a bit scared because this means there could be also any kind<br />
of unexpected bash output in the target system chroot environment<br />
(e.g. because of any etc/motd in the target system environment)<br />
so that I checked right now our <code>chroot ... /bin/bash --login</code> calls as
in<br />
<a href="https://github.com/rear/rear/issues/2120#issuecomment-484159562">https://github.com/rear/rear/issues/2120#issuecomment-484159562</a><br />
if there are some where stdout is used like</p>
<pre><code>chroot ... /bin/bash --login ... | ...
</code></pre>
<p>Fortunately it seems there are none (except the single one that is<br />
fixed by this pull request - the first one in the output below)</p>
<pre><code># find usr/share/rear/ -name '*.sh' | xargs grep -h -o 'chroot .* /bin/bash --login .*' | sort -u

chroot $ROOTFS_DIR /bin/bash --login -c "cd $( dirname $binary ) &amp;&amp; ldd $binary" | grep -q 'not found' &amp;&amp; broken_binaries="$broken_binaries $binary"

chroot $ROOTFS_DIR /bin/bash --login -c "type $program" || missing_programs="$missing_programs $program"

chroot $ROOTFS_DIR /bin/bash --login -c "type $required_program" || missing_required_programs="$missing_required_programs $required_program"

chroot $TARGET_FS_ROOT /bin/bash --login -c "chown $v $owner:$group $directory" 1&gt;&amp;2 ; then

chroot $TARGET_FS_ROOT /bin/bash --login -c "echo -e '$root_password\n$root_password' | passwd root"

chroot $TARGET_FS_ROOT /bin/bash --login -c "$grub_name-install $bootdisk" ; then

chroot $TARGET_FS_ROOT /bin/bash --login -c "$grub_name-install $grub2_install_device" ; then

chroot $TARGET_FS_ROOT /bin/bash --login -c "$grub_name-install $grub2_install_option $grub2_install_device" ; then

chroot $TARGET_FS_ROOT /bin/bash --login -c "$grub_name-install $grub2_install_option $part" ; then

chroot $TARGET_FS_ROOT /bin/bash --login -c "$grub_name-mkconfig -o /boot/$grub_name/grub.cfg" ; then

chroot $TARGET_FS_ROOT /bin/bash --login -c "$networking_preparation_command" || LogPrint "Command failed: $networking_preparation_command"

chroot $TARGET_FS_ROOT /bin/bash --login -c "$network_setup_command" || LogPrint "Command failed: $network_setup_command"

chroot $TARGET_FS_ROOT /bin/bash --login -c 'type -P mkinitrd'

chroot $TARGET_FS_ROOT /bin/bash --login -c 'type -P update-initramfs'

chroot $TARGET_FS_ROOT /bin/bash --login -c '/usr/sbin/grub2-mkconfig -o /boot/grub2/grub.cfg'

chroot $TARGET_FS_ROOT /bin/bash --login -c "/usr/share/mdadm/mkconf &gt;/etc/mdadm/mdadm.conf" ; then

chroot $TARGET_FS_ROOT /bin/bash --login -c "yes '' | TERM=dumb yast2 --ncurses lan add name=eth0 ethdevice=eth0 bootproto=dhcp" || true
</code></pre>
<h4 id="jsmeix_commented_at_2019-04-29_0837"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2125#issuecomment-487493765">2019-04-29 08:37</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-04-29_0837" title="Permanent link">&para;</a></h4>
<p>@schlomo @gdha<br />
what do you think about redirecting the input to /dev/null for chroot
calls<br />
(provided input is not needed in each particular case)<br />
to avoid such unwanted messages in any case for ReaR 2.6?<br />
Cf.<br />
<a href="https://github.com/rear/rear/issues/2120#issuecomment-485695688">https://github.com/rear/rear/issues/2120#issuecomment-485695688</a></p>
<h4 id="olivero2_commented_at_2019-04-29_1201"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/pull/2125#issuecomment-487552338">2019-04-29 12:01</a>:<a class="headerlink" href="#olivero2_commented_at_2019-04-29_1201" title="Permanent link">&para;</a></h4>
<p>I know I haven't been asked but let me drop some points to consider:</p>
<ul>
<li><code>usr/share/rear/skel/default/etc/bash.bashrc</code> checks via <code>tty -s</code>.</li>
<li>The 'canonical' way to check for an interactive shell is <a href="https://www.gnu.org/software/bash/manual/html_node/Is-this-Shell-Interactive_003f.html">something
    like <code>[[ $- == *i* ]]</code> (Bash Reference
    Manual)</a>.</li>
<li><code>$-</code> contains an <code>i</code> whenever there are commands to execute (either
    via <code>-c</code> or via at least one non-option argument), or if a <code>-i</code>
    option is present. <code>-c</code> is present in all <code>bash --login</code> invocations
    within ReaR, <code>-i</code> is not.</li>
<li>There are no guarantees regarding the actions being performed by the
    target system's profile files in general.</li>
<li>There are no guarantees regarding the actions being performed by the
    target system's profile files in case of an incomplete setup (e.g
    <code>PATH</code> not set up as expected).</li>
<li>Unless you are in control of each and every profile file involved,
    there might be unwanted side effects when invoking <code>bash --login</code> in
    the (partially set up) target environment. Maybe it is worth to look
    for a safer way to achieve things.</li>
</ul>
<h4 id="jsmeix_commented_at_2019-04-29_1232"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2125#issuecomment-487561025">2019-04-29 12:32</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-04-29_1232" title="Permanent link">&para;</a></h4>
<p>@OliverO2<br />
of course you are always welcome to contribute your thoughts!</p>
<p>I asked @schlomo and @gdha because I hope they may better<br />
know about the history why certain things are as they are in ReaR<br />
like why there is in usr/share/rear/skel/default/etc/bash.bashrc</p>
<pre><code># print motd for interactive shells
tty -s &amp;&amp; test -s /etc/motd &amp;&amp; cat /etc/motd
</code></pre>
<p>Regarding using <code>$-</code> to determine if we run interactively:<br />
This should work at least down to SLES10-SP4<br />
with GNU bash 3.1.17 where "man bash" reads</p>
<pre><code>An interactive shell is one started without non-option arguments
and without the -c option whose standard input and error are both
connected to terminals (as determined by isatty(3)), or one started
with the -i option. PS1 is set and $- includes i if bash is interactive,
allowing a shell script or a startup file to test this state.
</code></pre>
<p>In general regarding <code>chroot ... /bin/bash --login -c "command ..."</code><br />
versus <code>chroot ... /path/to/command ...</code> see<br />
<a href="https://github.com/rear/rear/issues/862">https://github.com/rear/rear/issues/862</a><br />
and therein in particular<br />
<a href="https://github.com/rear/rear/issues/862#issuecomment-274068914">https://github.com/rear/rear/issues/862#issuecomment-274068914</a><br />
and subsequent comments therein and subsequent issues like<br />
<a href="https://github.com/rear/rear/pull/1345#issuecomment-299798204">https://github.com/rear/rear/pull/1345#issuecomment-299798204</a></p>
<h4 id="olivero2_commented_at_2019-04-29_1239"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/pull/2125#issuecomment-487563171">2019-04-29 12:39</a>:<a class="headerlink" href="#olivero2_commented_at_2019-04-29_1239" title="Permanent link">&para;</a></h4>
<blockquote>
<p>Regarding using <code>$-</code> to determine if we run interactively:<br />
This should work at least down to SLES10-SP4<br />
with GNU bash 3.1.17</p>
</blockquote>
<p>I suppose you'd even find <code>$-</code> and the <code>i</code> option in the ancient bourne
shell. If I remember correctly it's been there ever since. The only
difference in detection is the pattern matching available in bash.</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2023 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2019-04-28.2125.pr.merged.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
