<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#1418 PR merged: Make function get_disk_size () be more tolerant when querying /sys/... - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#1418 PR merged: Make function get_disk_size () be more tolerant when querying /sys/...";
        var mkdocs_page_input_path = "issues/2017-07-16.1418.pr.merged.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/backup_netfs.html">Example of BACKUP=NETFS</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/netfs_nas.html">Internal Backup with tar to NFS server</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/rbme.html">External Backup using RBME</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../development/squash-git-log-commments.html">How to squash git log comments into one line</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear29.html">Release Notes ReaR 2.9</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear28.html">Release Notes ReaR 2.8</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#1418 PR merged: Make function get_disk_size () be more tolerant when querying /sys/...</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="1418_pr_merged_make_function_get_disk_size_be_more_tolerant_when_querying_sys"><a href="https://github.com/rear/rear/pull/1418">#1418 PR</a> <code>merged</code>: Make function get_disk_size () be more tolerant when querying /sys/...<a class="headerlink" href="#1418_pr_merged_make_function_get_disk_size_be_more_tolerant_when_querying_sys" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>enhancement</code>, <code>fixed / solved / done</code>, <code>minor bug</code></p>
<h4 id="gozora_opened_issue_at_2017-07-16_1516"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> opened issue at <a href="https://github.com/rear/rear/pull/1418">2017-07-16 15:16</a>:<a class="headerlink" href="#gozora_opened_issue_at_2017-07-16_1516" title="Permanent link">&para;</a></h4>
<p>Hello guys,</p>
<p>After thinking a bit about this issue a bit, I've decided to introduce
new function <strong>retry_command ()</strong> in <em>layout-functions.sh</em>, as it might
be useful for other situations in the future as well.</p>
<p>As always any comments are mote than welcome.</p>
<p>V.</p>
<h4 id="gozora_commented_at_2017-07-17_1109"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/pull/1418#issuecomment-315726470">2017-07-17 11:09</a>:<a class="headerlink" href="#gozora_commented_at_2017-07-17_1109" title="Permanent link">&para;</a></h4>
<p>Just a small check point on what we have so far (because I'm having
trouble to keep attention :-) )</p>
<pre><code>try_and_verify ()
{
    command="$*";
    local retry=0;

    for pass in trial verification;
    do
        until command_stdout=$(eval $command); do
            sleep $REAR_SLEEP_DELAY;
            retry=$(( retry + 1 ));
            if [[ $retry -ge $REAR_MAX_RETRIES ]]; then
                Error "Could not successfully finish command: '$command'";
            fi;
        done;
    done

    echo $command_stdout
}
</code></pre>
<h4 id="jsmeix_commented_at_2017-07-17_1132"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1418#issuecomment-315730823">2017-07-17 11:32</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-07-17_1132" title="Permanent link">&para;</a></h4>
<p>Since your<br />
<a href="https://github.com/rear/rear/pull/1418#commitcomment-23133281">https://github.com/rear/rear/pull/1418#commitcomment-23133281</a><br />
I understand the reason behind and I like it!</p>
<p>Your try_and_verify in your<br />
<a href="https://github.com/rear/rear/pull/1418#issuecomment-315726470">https://github.com/rear/rear/pull/1418#issuecomment-315726470</a><br />
works well for me:</p>
<pre>
# REAR_SLEEP_DELAY=1
# REAR_MAX_RETRIES=3

# filename="/etc/issue"

# out=$( try_and_verify cat qqq $filename )
cat: qqq: No such file or directory
cat: qqq: No such file or directory
cat: qqq: No such file or directory
Could not successfully finish command: 'cat qqq /etc/issue'

# echo "'$out'"
''

# out=$( try_and_verify cat qqq $filename '||' echo Hello )
cat: qqq: No such file or directory
cat: qqq: No such file or directory

# echo "'$out'"
'Welcome to SUSE Linux Enterprise Desktop 11 SP3 (i586) - Kernel \r (\l). Hello'
</pre>

<p>Note the appended 'Hello' after the /etc/issue output.</p>
<h4 id="jsmeix_commented_at_2017-07-17_1135"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1418#issuecomment-315731319">2017-07-17 11:35</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-07-17_1135" title="Permanent link">&para;</a></h4>
<p>You must use</p>
<pre>
    echo "$command_stdout"
</pre>

<p>to get spaces and newlines in the output:</p>
<pre>
# out=$( try_and_verify cat qqq $filename '||' echo Hello )
cat: qqq: No such file or directory
cat: qqq: No such file or directory

# echo "'$out'"
'
Welcome to SUSE Linux Enterprise Desktop 11 SP3  (i586) - Kernel \r (\l).


Hello'
</pre>

<h4 id="schlomo_commented_at_2017-07-17_1137"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/1418#issuecomment-315731657">2017-07-17 11:37</a>:<a class="headerlink" href="#schlomo_commented_at_2017-07-17_1137" title="Permanent link">&para;</a></h4>
<p>Please also test for files with blanks like this:</p>
<pre><code>out=$( function cat "/etc/file with blank" "||" wc -l )
</code></pre>
<p>It is very important that we make ReaR safe internally so that we won't
fail when users provide such paths.</p>
<h4 id="gozora_commented_at_2017-07-17_1151"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/pull/1418#issuecomment-315734121">2017-07-17 11:51</a>:<a class="headerlink" href="#gozora_commented_at_2017-07-17_1151" title="Permanent link">&para;</a></h4>
<p>@schlomo<br />
Following syntax works fine for me:</p>
<pre><code>nr_blocks=$(try_and_verify 'cat "/tmp/disk size"')
</code></pre>
<h4 id="gozora_commented_at_2017-07-17_1153"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/pull/1418#issuecomment-315734632">2017-07-17 11:53</a>:<a class="headerlink" href="#gozora_commented_at_2017-07-17_1153" title="Permanent link">&para;</a></h4>
<p>@schlomo<br />
Even this one:</p>
<pre><code>nr_blocks=$(try_and_verify 'cat "/tmp/disk size" | wc -l')
</code></pre>
<h4 id="schlomo_commented_at_2017-07-17_1158"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/1418#issuecomment-315735663">2017-07-17 11:58</a>:<a class="headerlink" href="#schlomo_commented_at_2017-07-17_1158" title="Permanent link">&para;</a></h4>
<p>@gozora I personally find such double quotings really ugly. Hence IMHO
it is much better to use '$@' which avoids that.</p>
<h4 id="gozora_commented_at_2017-07-17_1204"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/pull/1418#issuecomment-315737031">2017-07-17 12:04</a>:<a class="headerlink" href="#gozora_commented_at_2017-07-17_1204" title="Permanent link">&para;</a></h4>
<p>@schlomo<br />
Do you mean replacing <code>command="$*"</code> with <code>command="$@"</code>?</p>
<h4 id="schlomo_commented_at_2017-07-17_1209"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/1418#issuecomment-315737942">2017-07-17 12:09</a>:<a class="headerlink" href="#schlomo_commented_at_2017-07-17_1209" title="Permanent link">&para;</a></h4>
<p>Yes and no. Don't copy the command into your own variable but use <code>"$@"</code>
as is. Did you see my in-line remarks on your PR?</p>
<h4 id="schlomo_commented_at_2017-07-17_1210"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/1418#issuecomment-315738077">2017-07-17 12:10</a>:<a class="headerlink" href="#schlomo_commented_at_2017-07-17_1210" title="Permanent link">&para;</a></h4>
<p>And yes, you can use <code>eval "$@"</code> to support even more complex things.</p>
<h4 id="gozora_commented_at_2017-07-17_1236"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/pull/1418#issuecomment-315743387">2017-07-17 12:36</a>:<a class="headerlink" href="#gozora_commented_at_2017-07-17_1236" title="Permanent link">&para;</a></h4>
<p>@schlomo</p>
<blockquote>
<p>Did you see my in-line remarks on your PR?</p>
</blockquote>
<p>I can see inline remarks from @gdha and @jsmeix but not a single one
from you ...</p>
<p>This is a new version of function:</p>
<pre><code>try_and_verify ()
{
    local retry=0

    for pass in trial verification; do
        until command_stdout=$(eval "$@"); do
            sleep $REAR_SLEEP_DELAY
            retry=$(( retry + 1 ))
            if [[ $retry -ge $REAR_MAX_RETRIES ]]; then
                Error "Could not successfully finish command '$@'"
            fi
        done
    done

    echo "$command_stdout"
}
</code></pre>
<p>Is it OK for everybody ?</p>
<p>V.</p>
<h4 id="schlomo_commented_at_2017-07-17_1239"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/1418#issuecomment-315743990">2017-07-17 12:39</a>:<a class="headerlink" href="#schlomo_commented_at_2017-07-17_1239" title="Permanent link">&para;</a></h4>
<p>I didn't realize I need to send my review remarks. Sorry.</p>
<h4 id="schlomo_commented_at_2017-07-17_1246"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/1418#issuecomment-315745432">2017-07-17 12:46</a>:<a class="headerlink" href="#schlomo_commented_at_2017-07-17_1246" title="Permanent link">&para;</a></h4>
<p>To be honest, I don't really get the point of the trial and verification
approach. If I read the code correctly it will actually do the command
twice but not compare between the two outputs.</p>
<p>What is your use case where you need to run the command <strong>twice</strong>?</p>
<p>IMHO you should choose one of the following approaches:</p>
<ul>
<li>Run the command till two consecutive executions yield the same
    result.</li>
<li>Run the command till it is successful. No need to repeat it.</li>
<li>The combination: Run till two consecutive executions yield the same
    result <em>and</em> are successful.</li>
</ul>
<p>About the numeric evaluation: I strongly suggest to be consistent there
and use either <code>(( ))`` or</code>let<code>and not</code>[[
]]<code>. In our [coding style](https://github.com/rear/rear/wiki/Coding-Style#test---) we mention to not use</code>[[`
for numerical checks, maybe we should expand that also to be more clear
about assignments.</p>
<h4 id="gozora_commented_at_2017-07-17_1302"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/pull/1418#issuecomment-315748954">2017-07-17 13:02</a>:<a class="headerlink" href="#gozora_commented_at_2017-07-17_1302" title="Permanent link">&para;</a></h4>
<p>@schlomo</p>
<blockquote>
<p>What is your use case where you need to run the command twice?</p>
</blockquote>
<p>Please check
<a href="https://github.com/rear/rear/issues/1370#issuecomment-303046386">https://github.com/rear/rear/issues/1370#issuecomment-303046386</a></p>
<blockquote>
<ul>
<li>Run the command till two consecutive executions yield the same
    result.</li>
<li>The combination: Run till two consecutive executions yield the
    same result and are successful.</li>
</ul>
</blockquote>
<p>This smells by endless loop, so I don't think it is a good idea.</p>
<blockquote>
<p>About the numeric evaluation: I strongly suggest to be consistent ...</p>
</blockquote>
<p>Which part of code you have on your mind?</p>
<p>V.</p>
<h4 id="schlomo_commented_at_2017-07-17_1315"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/1418#issuecomment-315752115">2017-07-17 13:15</a>:<a class="headerlink" href="#schlomo_commented_at_2017-07-17_1315" title="Permanent link">&para;</a></h4>
<p>@gozora Now I understand the background story. After reading it I have a
strong opinion that the "try and validate" approach is overengineering
that makes ReaR more complex. It tries to work around the fact that we
use the wrong tools for a job (as it is the case of using partprobe to
"force" a block device to appear).</p>
<p>I am all in favor of implementing a wait logic in ReaR but would like to
keep all of that really simple. That means that in my opinion your
function should just do that: Retry several times till something works.
So your other <code>until ... do</code> example would fit the job much better.</p>
<p>And yes, we need to deal with udev properly and stop kicking it. But
this is another problem.</p>
<p>About numeric evaluation: Please use <code>((</code> or <code>let</code> when you deal with
variables that contain numbers.</p>
<h4 id="gozora_commented_at_2017-07-17_1330"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/pull/1418#issuecomment-315755788">2017-07-17 13:30</a>:<a class="headerlink" href="#gozora_commented_at_2017-07-17_1330" title="Permanent link">&para;</a></h4>
<p>@schlomo</p>
<blockquote>
<p>After reading it I have a strong opinion that the "try and validate"
approach is overengineering that makes ReaR more complex.</p>
</blockquote>
<p>I basically don't have opinion here. Maybe you guys who are with ReaR
much longer, should run some vote or something ;-)</p>
<blockquote>
<p>About numeric evaluation: Please use (( or let when you deal with
variables that contain numbers.</p>
</blockquote>
<p>I guess that is what I already did, or am I overlooking something?</p>
<pre><code>retry=$(( retry + 1 ))
</code></pre>
<h4 id="schlomo_commented_at_2017-07-17_1344"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/1418#issuecomment-315759543">2017-07-17 13:44</a>:<a class="headerlink" href="#schlomo_commented_at_2017-07-17_1344" title="Permanent link">&para;</a></h4>
<p>The numerical assignment should be</p>
<pre><code>let retry++
(( retry++ ))
</code></pre>
<p>and the test should be also</p>
<pre><code>if (( retry &gt; REAR_MAX_RETRIES )) ; then
</code></pre>
<p>And the error messages in case of a failure should not only explain
<strong>what</strong> went wrong (the actual command) but rather explain <strong>why</strong> this
is an issue and what the user should do now.</p>
<h4 id="gozora_commented_at_2017-07-17_1355"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/pull/1418#issuecomment-315762562">2017-07-17 13:55</a>:<a class="headerlink" href="#gozora_commented_at_2017-07-17_1355" title="Permanent link">&para;</a></h4>
<blockquote>
<p>And the error messages in case of a failure should not only explain
what went wrong (the actual command) but rather explain why this is an
issue and what the user should do now.</p>
</blockquote>
<p>Again a small example, to check If I get your idea right:</p>
<p>You would like to change:</p>
<pre><code># ls /tmp1
ls: cannot access /tmp1: No such file or directory
</code></pre>
<p>to</p>
<pre><code># ls /tmp1
ls: cannot access /tmp1: No such file or directory
ls: Because you've made a typo.
</code></pre>
<p>?</p>
<p>V.</p>
<h4 id="schlomo_commented_at_2017-07-17_1400"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/1418#issuecomment-315764039">2017-07-17 14:00</a>:<a class="headerlink" href="#schlomo_commented_at_2017-07-17_1400" title="Permanent link">&para;</a></h4>
<p>Yes, although I would turn the order around. First print the ReaR error
message and then the command and the output. That way the reading order
(top-bottom) helps the user get the full context.</p>
<p>Example:</p>
<pre><code>... other rear output ...
ERROR: Could not get block device for freshly created partitions
Timed out after 5 seconds waiting for command 'stat -t /dev/sda4' to be successful:
stat: cannot stat '/dev/sda4': No such file or directory
</code></pre>
<h4 id="jsmeix_commented_at_2017-07-17_1403"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1418#issuecomment-315765049">2017-07-17 14:03</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-07-17_1403" title="Permanent link">&para;</a></h4>
<p>I think on first glance the following could be assumed:</p>
<p>The try_and_verify function looks primarily meant for<br />
things as in
<a href="https://github.com/rear/rear/issues/791">https://github.com/rear/rear/issues/791</a><br />
where the verify part is needed because of<br />
<a href="https://github.com/rear/rear/issues/791#issuecomment-211318620">https://github.com/rear/rear/issues/791#issuecomment-211318620</a></p>
<p>But for the issue in<br />
<a href="https://github.com/rear/rear/issues/1370">https://github.com/rear/rear/issues/1370</a><br />
it looks as if a plain retry_command function<br />
(without additional verify) is the right thing.</p>
<p>But according to<br />
<a href="https://github.com/rear/rear/issues/1370#issuecomment-303046386">https://github.com/rear/rear/issues/1370#issuecomment-303046386</a><br />
from my point of view the issue in<br />
<a href="https://github.com/rear/rear/issues/1370">https://github.com/rear/rear/issues/1370</a><br />
is actually the same as<br />
<a href="https://github.com/rear/rear/issues/791">https://github.com/rear/rear/issues/791</a></p>
<p>Because of that a "try and validate" approach is needed<br />
because according to what I put together in<br />
<a href="https://github.com/rear/rear/issues/791">https://github.com/rear/rear/issues/791</a><br />
that is how things behave.</p>
<p>@schlomo<br />
regarding using partprobe to "force" a block device to appear:<br />
Yes, that is (as far as I understand it) the wrong tool.<br />
But from that does not follow ReaR can avoid the<br />
"try and validate" approach because "try and validate"<br />
results from how udev and the kernel behave<br />
at least sometimes.</p>
<p>Because udev and kernel behave sometimes unreliably<br />
we need a "try and validate" approach that makes ReaR<br />
more complex to compensate those bugs elsewhere,<br />
cf. "Dirty hacks welcome" in<br />
<a href="https://github.com/rear/rear/wiki/Coding-Style">https://github.com/rear/rear/wiki/Coding-Style</a></p>
<p>In my personal opinion the real bug is in tools like parted<br />
that return to the user 'successfully' without having their<br />
job actually completely done.</p>
<p>E.g. after</p>
<pre>
parted /dev/sda unit MiB mkpart primary ext2 8 2048
</pre>

<p>returned successfully the new /dev/sda1 should be there<br />
rock solid ready to use so that an immediate subsequent</p>
<pre>
mkfs.ext2 /dev/sda1
</pre>

<p>should always "just work". i.e.</p>
<pre>
parted /dev/sda unit MiB mkpart primary ext2 8 2048 && mkfs.ext2 /dev/sda1
</pre>

<p>should "just work".<br />
But this is not true so that ReaR has to work around.</p>
<h4 id="schlomo_commented_at_2017-07-17_1411"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/1418#issuecomment-315767285">2017-07-17 14:11</a>:<a class="headerlink" href="#schlomo_commented_at_2017-07-17_1411" title="Permanent link">&para;</a></h4>
<p>@jsmeix I understood you in the other issue so that we simply should
wait for the block device after using <code>parted</code> instead of kicking udev.
Is that wrong? For that we just need a <strong>simple</strong> <code>retry_command</code>
function.</p>
<p>I am really against this generic retry function that does stuff twice
after it is successful. It requires the developer to be very much aware
of the fact. Imagine you use that on something that does more than just
<strong>read</strong> something? Like creating a filesystem? It will fail till the
block device appears, work exactly once, and then fail again (unless you
have <code>--force</code> specified). In such a case the use of the try and
validate approach is wrong because the validation and the trying should
use different commands.</p>
<p>AFAIKT for the reason that @gozora wrote his function a plain retry is
enough and that is why I would like to keep it that simple here and see
where that helps us. If you need the try and validate approach then
please call the retry function <strong>twice</strong> to make it very transparent
that you need to have two successful calls of that command.</p>
<p>Again, keeping it simple reduces both code lines and complexity and also
increases readability for those cases where you need this special
behavior.</p>
<p>If we generalize each and every problem then ReaR will become too
complex and we will have a very hard time to debug it when those things
cause problems.</p>
<h4 id="jsmeix_commented_at_2017-07-17_1431"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1418#issuecomment-315773035">2017-07-17 14:31</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-07-17_1431" title="Permanent link">&para;</a></h4>
<p>@schlomo<br />
it would not work reliably if ReaR waited for a block device<br />
(e.g. before parted and before mkfs) with a simple<br />
retry_command function because nowadays at least sometimes<br />
block devices can disappear and reappear out of a sudden, see<br />
<a href="https://github.com/rear/rear/issues/791#issuecomment-211318620">https://github.com/rear/rear/issues/791#issuecomment-211318620</a><br />
so that a verify part is needed to be fail-safe.</p>
<p>A simple retry_command function that is called two times<br />
should be sufficient like in</p>
<pre>
# wait for /dev/sda
retry_command test -b /dev/sda
# verify /dev/sda is there stable
retry_command test -b /dev/sda
# make /dev/sda1
parted ... mkpart ... /dev/sda
# wait for /dev/sda1
retry_command test -b /dev/sda1
# verify /dev/sda1 is there stable
retry_command test -b /dev/sda1
# make /dev/sda1 ext2
mkfs.ext2 /dev/sda1
</pre>

<p>Looks ugly?<br />
YES!<br />
That is the ugliness of how udev/systemd/kernel/whatever behave :-(</p>
<p>Accordingly a try_and_verify function<br />
that calls retry_command two times<br />
hides some of the ugliness:</p>
<pre>
# wait for /dev/sda and verify it is there stable
try_and_verify test -b /dev/sda
# make /dev/sda1
parted ... mkpart ... /dev/sda
# wait for /dev/sda1 and verify it is there stable
try_and_verify test -b /dev/sda1
# make /dev/sda1 ext2
mkfs.ext2 /dev/sda1
</pre>

<p>For the fun of weirdness:<br />
If device nodes could disappear and reappear several times<br />
until they stay there stable, a try_and_verify function would<br />
have to call retry_command as many times as disappear and<br />
reappear could happen in the worst case to be really fail-safe ;-)</p>
<h4 id="schlomo_commented_at_2017-07-17_1436"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/1418#issuecomment-315774420">2017-07-17 14:36</a>:<a class="headerlink" href="#schlomo_commented_at_2017-07-17_1436" title="Permanent link">&para;</a></h4>
<p>@jsmeix in that case I would prefer to have a <code>retry_command</code> function
and another function <code>retry_and_verify</code> that calls the <code>retry_command</code>
function twice. You get the same result and I get the keep it simple
approach. :-)</p>
<h4 id="jsmeix_commented_at_2017-07-17_1437"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1418#issuecomment-315774820">2017-07-17 14:37</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-07-17_1437" title="Permanent link">&para;</a></h4>
<p>@schlomo<br />
I agree that the current try_and_verify function cannot be used<br />
with arbitrary commands - it particular not with commands that<br />
write something (unless that writing is idempotent), cf.<br />
<a href="https://github.com/rear/rear/pull/1418#commitcomment-23133068">https://github.com/rear/rear/pull/1418#commitcomment-23133068</a></p>
<h4 id="jsmeix_commented_at_2017-07-17_1451"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1418#issuecomment-315778836">2017-07-17 14:51</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-07-17_1451" title="Permanent link">&para;</a></h4>
<p>I think the name 'retry_and_verify' still does not make it<br />
absolutely clear that the command is really called twice<br />
because 'verify' may look like a safe read-only test.</p>
<p>I think there should be a plain 'retry_command' function<br />
plus a 'retry_command_twice' function that calls<br />
retry_command two times.<br />
Or any other name that makes it obvious that command<br />
is called at least two times e.g. 'retry_and_retry_command'<br />
(or whatever you like).</p>
<p>Now when users look at plain code like</p>
<pre>
retry_command_twice test -b /dev/sda
parted ... mkpart ... /dev/sda
retry_command_twice test -b /dev/sda1
mkfs.ext2 /dev/sda1
</pre>

<p>they may get somewhat alerted by the strange function name<br />
because strange things do actually happen here.</p>
<h4 id="schlomo_commented_at_2017-07-17_1453"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/1418#issuecomment-315779458">2017-07-17 14:53</a>:<a class="headerlink" href="#schlomo_commented_at_2017-07-17_1453" title="Permanent link">&para;</a></h4>
<p>@jsmeix fine with me, the more names explain what they do the better.</p>
<h4 id="jsmeix_commented_at_2017-07-18_0909"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1418#issuecomment-316004608">2017-07-18 09:09</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-07-18_0909" title="Permanent link">&para;</a></h4>
<p>After sleeping over it I think I know what went wrong:</p>
<p>I think the root cause is that the function errors out.<br />
I think normally a function should not end the whole program<br />
(except things like an explicit 'exit_program' function).<br />
I think normally a function should only return a non-zero exit code<br />
when it failed and leave it to its caller what to do in this case.</p>
<p>In particular assume the use case where a command should<br />
be retried but it is not fatal when it fails like:</p>
<pre>
retry_command CMD1 || retry_command CMD2 || Error "..."
</pre>

<p>Currently this is not possible.</p>
<p>Accordingly I like to suggest to remove the Error and<br />
replace it with a 'return 1' and a simple generic<br />
Log or LogPrint message i.e. no longer a specific error<br />
message as (somewhat overcomplicated additional)<br />
function argument.</p>
<p>I assume this would - by the way - also solve the<br />
obscure issue with the clean exit (which indicates<br />
that things had become needlessly overcomplicated).</p>
<p>With such a simple and straightforward 'retry_command' function<br />
that only does what its name tells and nothing more<br />
code would become more clear because error messages<br />
are then in the caller and not indirectly in the function.<br />
Cf. RFC 1925 6a:<br />
"It is always possible to add another level of indirection."</p>
<p>E.g. my above example would then look like</p>
<pre>
# wait for /dev/sda
retry_command test -b /dev/sda || Error "/dev/sda did not appear"
# verify that /dev/sda stays there stable
retry_command test -b /dev/sda || Error "/dev/sda disappeared"
# make /dev/sda1
parted ... mkpart ... /dev/sda || Error "making /dev/sda1 failed"
# wait for /dev/sda1
retry_command test -b /dev/sda1 || Error "/dev/sda1 did not appear"
# verify that /dev/sda1 stays there stable
retry_command test -b /dev/sda1 || Error "/dev/sda1 disappeared"
# make ext2 on /dev/sda1
mkfs.ext2 /dev/sda1 || Error "making ext2 on /dev/sda1 failed"
</pre>

<p>In contrast to what I wrote above in<br />
<a href="https://github.com/rear/rear/pull/1418#issuecomment-315773035">https://github.com/rear/rear/pull/1418#issuecomment-315773035</a><br />
I think meanwhile that the two subsequent explicit calls of<br />
'retry_command test -b ...' plus the specific different error<br />
messages make the code more clear and better understandable<br />
compared to "obscure hidden magic" in a try_and_verify function.</p>
<h4 id="schlomo_commented_at_2017-07-18_0911"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/1418#issuecomment-316005085">2017-07-18 09:11</a>:<a class="headerlink" href="#schlomo_commented_at_2017-07-18_0911" title="Permanent link">&para;</a></h4>
<p>@jsmeix very good thoughts. Indeed it is very bad programming practice
to <em>die</em> from within function calls. In languages with exceptions (Java,
Python ...) functions only report errors but don't decide what to do.</p>
<h4 id="jsmeix_commented_at_2017-07-18_0920"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1418#issuecomment-316007355">2017-07-18 09:20</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-07-18_0920" title="Permanent link">&para;</a></h4>
<p>@gozora</p>
<p>I think the command that actually should be retried<br />
according to the original code is</p>
<pre>
test -r /sys/block/$disk_name/size
</pre>

<p>because the original code errors out after that comand.</p>
<p>Accordingly I think with a simple 'retry_command' function<br />
the code should be something like this:</p>
<pre>
retry_command test -r /sys/block/$disk_name/size || Error "..."
</pre>

<h4 id="gozora_commented_at_2017-07-18_1307"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/pull/1418#issuecomment-316057854">2017-07-18 13:07</a>:<a class="headerlink" href="#gozora_commented_at_2017-07-18_1307" title="Permanent link">&para;</a></h4>
<p>@schlomo @jsmeix any ideas for commit messages are more than welcome :-)</p>
<h4 id="schlomo_commented_at_2017-07-18_1324"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/1418#issuecomment-316062311">2017-07-18 13:24</a>:<a class="headerlink" href="#schlomo_commented_at_2017-07-18_1324" title="Permanent link">&para;</a></h4>
<p>@gozora I mean this file (first green line in screenshot):<br />
<img alt="image" src="https://user-images.githubusercontent.com/101384/28319064-1d30946a-6bcd-11e7-9549-ab9b5a831f3a.png" /></p>
<h4 id="gozora_commented_at_2017-07-18_1330"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/pull/1418#issuecomment-316063912">2017-07-18 13:30</a>:<a class="headerlink" href="#gozora_commented_at_2017-07-18_1330" title="Permanent link">&para;</a></h4>
<p>@schlomo I know what you mean ...<br />
But get_disk_size () is called by following code in
<em>200_partition_layout.sh</em></p>
<pre><code>devsize=$(get_disk_size ${disk#/sys/block/})
</code></pre>
<p>Afterwards (in get_disk_size) you call retry_command ().<br />
If I would omit <code>$(</code> and <code>)</code> then <code>devsize=123456</code> becomes</p>
<pre><code>devsize='
123456'
</code></pre>
<p>Does it give a sense?</p>
<h4 id="schlomo_commented_at_2017-07-18_1345"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/1418#issuecomment-316068241">2017-07-18 13:45</a>:<a class="headerlink" href="#schlomo_commented_at_2017-07-18_1345" title="Permanent link">&para;</a></h4>
<p>@gozora I checked out your branch to understand what is happening.</p>
<p>The <code>get_disk_size</code> function is defined as this</p>
<pre><code>get_disk_size() {
    local disk_name=$1

    local block_size=$(get_block_size ${disk_name%/*})

    $(retry_command test -r /sys/block/$disk_name/size) || Error "Could not determine size of disk $disk_name"

    local nr_blocks=$( &lt; /sys/block/$disk_name/size)
    local disk_size=$(( nr_blocks * block_size ))

    ### Make sure we always return a number
    echo $(( disk_size ))
}
</code></pre>
<p>The <code>$( ... ) || Error</code> line is IMHO problematic because it will try to
<em>execute</em> whatever is returned by the subshell. In your specific case in
most situations the subshell returns nothing, so it seems OK.</p>
<p>But, this whole story reveals a bug in your <code>retry_function</code>: If the
command generates no output the <code>retry_function</code> will nevertheless
output an <strong>empty line</strong>. To trace such things I use
<code>sudo usr/sbin/rear shell</code> in your branch:</p>
<pre><code># set -x 
set -x 
# retry_command :
retry_command :
+ retry_command :
+ local retry=0
++ eval :
+++ :
+ command_stdout=
+ echo ''
</code></pre>
<p>Here we clearly see that the <code>echo ''</code> is the culprit here. If you
replace it with <code>echo -n</code> then everything will be fine and then you can
remove the <code>$( ... )</code> from the <code>get_disk_size</code> function.</p>
<h4 id="gozora_commented_at_2017-07-18_1358"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/pull/1418#issuecomment-316072225">2017-07-18 13:58</a>:<a class="headerlink" href="#gozora_commented_at_2017-07-18_1358" title="Permanent link">&para;</a></h4>
<p>Hello @schlomo,</p>
<p>I need a bit cool down time from this issue ...<br />
I start to feel a bit angry and I don't want to do programming like
this.</p>
<p>So if you want, feel free to complete this pull request, or postpone it
for v2.3.</p>
<p>Sorry for that.</p>
<p>V.</p>
<h4 id="schlomo_commented_at_2017-07-18_1416"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/1418#issuecomment-316077580">2017-07-18 14:16</a>:<a class="headerlink" href="#schlomo_commented_at_2017-07-18_1416" title="Permanent link">&para;</a></h4>
<p>@gozora sure thing and sorry for upsetting you with my nitpicking.</p>
<h4 id="jsmeix_commented_at_2017-07-18_1430"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1418#issuecomment-316082453">2017-07-18 14:30</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-07-18_1430" title="Permanent link">&para;</a></h4>
<p>@schlomo<br />
I changed it hopefully right (not yet tested)<br />
according to how I think what you mean.<br />
Could you please have a look and verify if it works?</p>
<p>By the way regarding<br />
<a href="https://github.com/rear/rear/pull/1418#issuecomment-316068241">https://github.com/rear/rear/pull/1418#issuecomment-316068241</a></p>
<pre>
To trace ... things ... use
  usr/sbin/rear shell
</pre>

<p>Wow!<br />
Now I understand for what "rear shell" is meant to be used.</p>
<h4 id="schlomo_commented_at_2017-07-18_1436"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/1418#issuecomment-316084124">2017-07-18 14:36</a>:<a class="headerlink" href="#schlomo_commented_at_2017-07-18_1436" title="Permanent link">&para;</a></h4>
<p>I think it looks <strong>very</strong> good now. Does anybody actually have a test
case for this fix? If not then we'll have to merge it like this.</p>
<h4 id="jsmeix_commented_at_2017-07-18_1439"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1418#issuecomment-316085318">2017-07-18 14:39</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-07-18_1439" title="Permanent link">&para;</a></h4>
<p>I am brave and merge it right now as is and then I test it<br />
and if issues appear I fix them...</p>
<h4 id="schlomo_commented_at_2017-07-18_1443"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/1418#issuecomment-316086550">2017-07-18 14:43</a>:<a class="headerlink" href="#schlomo_commented_at_2017-07-18_1443" title="Permanent link">&para;</a></h4>
<p>Thanks a lot. This is real team work!</p>
<h4 id="jsmeix_commented_at_2017-07-18_1520"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1418#issuecomment-316098505">2017-07-18 15:20</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-07-18_1520" title="Permanent link">&para;</a></h4>
<p>I tested it by adding to init/default/030_update_recovery_system.sh<br />
(I use an 'init' script because those are run for any workflow):</p>
<pre>
disk_name=sda
disk_size=$( get_disk_size $disk_name)
LogPrint "get_disk_size $disk_name results $disk_size"
disk_name=qqq
disk_size=$( get_disk_size $disk_name)
</pre>

<p>and it results</p>
<pre>
e205:~/rear.master # usr/sbin/rear -d -D mkrescue
Relax-and-Recover 2.1 / Git
Using log file: /root/rear.master/var/log/rear/rear-e205.log
get_disk_size sda results 21474836480
ERROR: Could not determine size of disk qqq
Aborting due to an error, check /root/rear.master/var/log/rear/rear-e205.log for details
Terminated
</pre>

<p>with this in the log file (excerpts):</p>
<pre>
+ source /root/rear.master/usr/share/rear/init/default/030_update_recovery_system.sh
++ disk_name=sda
+++ get_disk_size sda
+++ local disk_name=sda
++++ get_block_size sda
++++ '[' -r /sys/block/sda/queue/logical_block_size ']'
++++ echo 512
+++ local block_size=512
+++ retry_command test -r /sys/block/sda/size
+++ local retry=0
++++ eval test -r /sys/block/sda/size
+++++ test -r /sys/block/sda/size
+++ command_stdout=
+++ echo -n ''
+++ local nr_blocks=41943040
+++ local disk_size=21474836480
+++ echo 21474836480
++ disk_size=21474836480
++ LogPrint 'get_disk_size sda results 21474836480'
++ Log 'get_disk_size sda results 21474836480'
+++ date '+%Y-%m-%d %H:%M:%S.%N '
++ local 'timestamp=2017-07-18 17:17:01.006874366 '
++ test 1 -gt 0
++ echo '2017-07-18 17:17:01.006874366 get_disk_size sda results 21474836480'
2017-07-18 17:17:01.006874366 get_disk_size sda results 21474836480
++ Print 'get_disk_size sda results 21474836480'
++ test 1
++ echo -e 'get_disk_size sda results 21474836480'
++ disk_name=qqq
+++ get_disk_size qqq
+++ local disk_name=qqq
++++ get_block_size qqq
++++ '[' -r /sys/block/qqq/queue/logical_block_size ']'
++++ echo 512
+++ local block_size=512
+++ retry_command test -r /sys/block/qqq/size
+++ local retry=0
++++ eval test -r /sys/block/qqq/size
+++++ test -r /sys/block/qqq/size
+++ command_stdout=
+++ sleep 1
+++ let retry++
+++ ((  retry >= REAR_MAX_RETRIES  ))
++++ eval test -r /sys/block/qqq/size
+++++ test -r /sys/block/qqq/size
+++ command_stdout=
+++ sleep 1
+++ let retry++
+++ ((  retry >= REAR_MAX_RETRIES  ))
++++ eval test -r /sys/block/qqq/size
+++++ test -r /sys/block/qqq/size
+++ command_stdout=
+++ sleep 1
+++ let retry++
+++ ((  retry >= REAR_MAX_RETRIES  ))
++++ eval test -r /sys/block/qqq/size
+++++ test -r /sys/block/qqq/size
+++ command_stdout=
+++ sleep 1
+++ let retry++
+++ ((  retry >= REAR_MAX_RETRIES  ))
++++ eval test -r /sys/block/qqq/size
+++++ test -r /sys/block/qqq/size
+++ command_stdout=
+++ sleep 1
+++ let retry++
+++ ((  retry >= REAR_MAX_RETRIES  ))
+++ Log 'retry_command '\''test -r /sys/block/qqq/size'\'' failed'
++++ date '+%Y-%m-%d %H:%M:%S.%N '
+++ local 'timestamp=2017-07-18 17:17:06.020432290 '
+++ test 1 -gt 0
+++ echo '2017-07-18 17:17:06.020432290 retry_command '\''test -r /sys/block/qqq/size'\'' failed'
2017-07-18 17:17:06.020432290 retry_command 'test -r /sys/block/qqq/size' failed
+++ return 1
+++ Error 'Could not determine size of disk qqq'
+++ LogPrintError 'ERROR: Could not determine size of disk qqq'
+++ Log 'ERROR: Could not determine size of disk qqq'
</pre>

<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2025 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2017-07-16.1418.pr.merged.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/rear/rear-user-guide" class="fa fa-code-fork" style="color: #fcfcfc"> rear/rear-user-guide</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
