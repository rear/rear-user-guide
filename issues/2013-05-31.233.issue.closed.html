<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#233 Issue closed: fedora19 btrfs subvolumes issues (diskrestore.sh) - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#233 Issue closed: fedora19 btrfs subvolumes issues (diskrestore.sh)";
        var mkdocs_page_input_path = "issues/2013-05-31.233.issue.closed.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/backup_netfs.html">Example of BACKUP=NETFS</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#233 Issue closed: fedora19 btrfs subvolumes issues (diskrestore.sh)</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="233_issue_closed_fedora19_btrfs_subvolumes_issues_diskrestoresh"><a href="https://github.com/rear/rear/issues/233">#233 Issue</a> <code>closed</code>: fedora19 btrfs subvolumes issues (diskrestore.sh)<a class="headerlink" href="#233_issue_closed_fedora19_btrfs_subvolumes_issues_diskrestoresh" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>bug</code>, <code>discuss / RFC</code></p>
<h4 id="gdha_opened_issue_at_2013-05-31_1331"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> opened issue at <a href="https://github.com/rear/rear/issues/233">2013-05-31 13:31</a>:<a class="headerlink" href="#gdha_opened_issue_at_2013-05-31_1331" title="Permanent link">&para;</a></h4>
<p>On a fedora19 system we see the following:</p>
<pre><code># cat disklayout.conf
disk /dev/sda 8589934592 msdos
part /dev/sda 524288000 1048576 primary boot /dev/sda1
part /dev/sda 1912602624 525336576 primary none /dev/sda2
part /dev/sda 6151995392 2437939200 primary none /dev/sda3
#disk /dev/sdb 4294967296 msdos
fs /dev/sda3 / btrfs uuid=efcf1774-7cad-4fb4-8fcb-9d90a396d5b5 label='fedora'   options=rw,relatime,seclabel,space_cache
fs /dev/sda3 /home btrfs uuid=efcf1774-7cad-4fb4-8fcb-9d90a396d5b5 label='fedora'   options=rw,relatime,seclabel,space_cache
fs /dev/sda1 /boot ext4 uuid=70c882be-7672-4b4f-8b19-51b66b7f2561 label= blocksize=1024 reserved_blocks=5% max_mounts=-1 check_interval=0d bytes_per_inode=4095 options=rw,relatime,seclabel,data=ordered
swap /dev/sda2 uuid=d5bac901-323f-40a8-84ca-e2bfb79efa7c label=

# df
Filesystem     1K-blocks    Used Available Use% Mounted on
/dev/sda3        6007808 2925784   2781640  52% /
devtmpfs          391928       0    391928   0% /dev
tmpfs             402296      72    402224   1% /dev/shm
tmpfs             402296     840    401456   1% /run
tmpfs             402296       0    402296   0% /sys/fs/cgroup
tmpfs             402296      20    402276   1% /tmp
/dev/sda3        6007808 2925784   2781640  52% /home
/dev/sda1         487652   74593    387459  17% /boot
</code></pre>
<p>As you can see it is odd to see <code>/dev/sda3</code> twice listed in
<code>disklayout.conf</code> (in particular <code>/</code> and <code>/home</code>).<br />
Of course, in recovery mode, that gives trouble (trying do a mkfs on
/dev/sda3 twice). This is not really the fault of rear, but still rear
gets the blame (I guess).<br />
We can fix this manually in the <code>diskrestore.sh</code> script, and the restore
is successful afterwards.</p>
<p>Reboot the system and then it seems that not all uuids were correctly
migrated (perhaps in the initrd??) and we're dropped into a rescue
prompt of dracut-initqueue.</p>
<h4 id="gdha_commented_at_2013-05-31_1334"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/issues/233#issuecomment-18744972">2013-05-31 13:34</a>:<a class="headerlink" href="#gdha_commented_at_2013-05-31_1334" title="Permanent link">&para;</a></h4>
<p>some extra info:</p>
<pre><code># cat /etc/fstab
UUID=efcf1774-7cad-4fb4-8fcb-9d90a396d5b5 /                       btrfs   subvol=root     1 1
UUID=70c882be-7672-4b4f-8b19-51b66b7f2561 /boot                   ext4    defaults        1 2
UUID=efcf1774-7cad-4fb4-8fcb-9d90a396d5b5 /home                   btrfs   subvol=home     1 2
UUID=d5bac901-323f-40a8-84ca-e2bfb79efa7c swap                    swap    defaults        0 0

# ll /dev/disk/by-uuid/
total 0
lrwxrwxrwx. 1 root root 10 May 31 09:58 70c882be-7672-4b4f-8b19-51b66b7f2561 -&gt; ../../sda1
lrwxrwxrwx. 1 root root 10 May 31 09:58 d5bac901-323f-40a8-84ca-e2bfb79efa7c -&gt; ../../sda2
lrwxrwxrwx. 1 root root 10 May 31 09:58 efcf1774-7cad-4fb4-8fcb-9d90a396d5b5 -&gt; ../../sda3
</code></pre>
<p>ok, / and /home are sub-volumes and share the same uuid - that must be
the reason why rear got confused.<br />
What is exactly shown as labels?</p>
<pre><code># btrfs filesystem show  --all-devices
Label: 'fedora'  uuid: efcf1774-7cad-4fb4-8fcb-9d90a396d5b5
        Total devices 1 FS bytes used 2.53GB
        devid    1 size 5.73GB used 3.50GB path /dev/sda3

Btrfs v0.20-rc1
</code></pre>
<h4 id="gdha_commented_at_2013-06-04_1256"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/issues/233#issuecomment-18906890">2013-06-04 12:56</a>:<a class="headerlink" href="#gdha_commented_at_2013-06-04_1256" title="Permanent link">&para;</a></h4>
<p>In the <code>disklayout.conf</code> file we should add the entries:</p>
<pre><code>fs /dev/sda3 / btrfs uuid=efcf1774-7cad-4fb4-8fcb-9d90a396d5b5 label='fedora'   options=rw,relatime,seclabel,space_cache
fs /dev/sda3 /home btrfs uuid=efcf1774-7cad-4fb4-8fcb-9d90a396d5b5 label='fedora'   options=rw,relatime,seclabel,space_cache
</code></pre>
<p>into</p>
<pre><code>fs /dev/sda3 / btrfs uuid=efcf1774-7cad-4fb4-8fcb-9d90a396d5b5 label='fedora'   options=rw,relatime,seclabel,space_cache,subvol=home
fs /dev/sda3 /home btrfs uuid=efcf1774-7cad-4fb4-8fcb-9d90a396d5b5 label='fedora'   options=rw,relatime,seclabel,space_cache,subvol=root
</code></pre>
<p>The sub-volumes can be seen with:</p>
<pre><code># btrfs subvolume list -a /
ID 256 gen 19 top level 5 path &lt;FS_TREE&gt;/home
ID 258 gen 350 top level 5 path &lt;FS_TREE&gt;/root
</code></pre>
<p>And, even a bit more details:</p>
<pre><code># btrfs subvolume show /
/
        Name:                   root
        uuid:                   aa27988c-5f42-d14b-9247-30b0275317a6
        Parent uuid:            -
        Creation time:          2013-05-30 08:24:52
        Object ID:              258
        Generation (Gen):       381
        Gen at creation:        8
        Parent:                 5
        Top Level:              5
        Flags:                  -
        Snapshot(s):
# btrfs subvolume show /home
/home
        Name:                   home
        uuid:                   f05e8187-ee74-ad4c-a302-c6c7e31f749b
        Parent uuid:            -
        Creation time:          2013-05-30 08:24:52
        Object ID:              256
        Generation (Gen):       19
        Gen at creation:        5
        Parent:                 5
        Top Level:              5
        Flags:                  -
        Snapshot(s):
</code></pre>
<h4 id="gdha_commented_at_2013-06-06_1408"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/issues/233#issuecomment-19047358">2013-06-06 14:08</a>:<a class="headerlink" href="#gdha_commented_at_2013-06-06_1408" title="Permanent link">&para;</a></h4>
<p>Hum, recovery was after some tweeking successful. However, at the next
reboot:<br />
<img alt="image" src="https://f.cloud.github.com/assets/888633/618340/5bc5ca5e-ceb2-11e2-9e98-3089afa82bf9.png" /><br />
we get an error of the initqueue - the UUID seems correct, but need some
more investigation...</p>
<h4 id="gdha_commented_at_2013-06-25_1420"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/issues/233#issuecomment-19979169">2013-06-25 14:20</a>:<a class="headerlink" href="#gdha_commented_at_2013-06-25_1420" title="Permanent link">&para;</a></h4>
<p>OpenSuSe 12.3 the command <code>btrfs subvolume list /</code> looks like:</p>
<pre><code>ID 256 top level 5 path tmp
ID 258 top level 5 path opt
ID 259 top level 5 path srv
ID 260 top level 5 path var/crash
ID 261 top level 5 path var/spool
ID 262 top level 5 path var/log
ID 263 top level 5 path var/tmp
ID 268 top level 5 path .snapshots
ID 269 top level 5 path .snapshots/1/snapshot
ID 270 top level 5 path .snapshots/2/snapshot
ID 271 top level 5 path .snapshots/3/snapshot
ID 272 top level 5 path .snapshots/4/snapshot
ID 273 top level 5 path .snapshots/5/snapshot
ID 274 top level 5 path .snapshots/6/snapshot
ID 275 top level 5 path .snapshots/7/snapshot
ID 276 top level 5 path .snapshots/8/snapshot
ID 277 top level 5 path .snapshots/9/snapshot
ID 278 top level 5 path .snapshots/10/snapshot
ID 279 top level 5 path .snapshots/11/snapshot
ID 280 top level 5 path .snapshots/12/snapshot
ID 281 top level 5 path .snapshots/13/snapshot
ID 282 top level 5 path .snapshots/14/snapshot
ID 283 top level 5 path .snapshots/15/snapshot
ID 284 top level 5 path .snapshots/16/snapshot
ID 286 top level 5 path .snapshots/17/snapshot
</code></pre>
<p>The code in script
<code>layout/prepare/GNU/Linux/13_include_filesystem_code.sh</code> will not work
on OpenSuse:<br />
<code>echo "btrfs_id=\$(btrfs subvolume list /mnt/local$mp | tail -1 | awk '{print \$2}')" &gt;&gt; $LAYOUT_CODE</code></p>
<h4 id="pavoldomin_commented_at_2014-08-18_1940"><img src="https://avatars.githubusercontent.com/u/1576908?v=4" width="50"><a href="https://github.com/pavoldomin">pavoldomin</a> commented at <a href="https://github.com/rear/rear/issues/233#issuecomment-52543750">2014-08-18 19:40</a>:<a class="headerlink" href="#pavoldomin_commented_at_2014-08-18_1940" title="Permanent link">&para;</a></h4>
<p>Hello,</p>
<p>I am just evaluating sles11.3 btrfs support; indeed ReaR would not be
capable to recover the YaST default subvolume layout. The point is, ReaR
takes fs layout from the 'mount' output, but btrfs subvolumes may not be
"mounted", yet still visible in the / tree, just as the example in the
comment above shows. Therefore, I believe btrfs deserves dedicated
layout code, as its not just filesystem but also a volume manager. What
about new disklayout.conf entries like:</p>
<pre><code>btrfs_subvol &lt;btrfs subvolume list output&gt;
....
btrfs_snapshot &lt;btrfs subvolume list -s output&gt;
....
</code></pre>
<p>The fs recovery code would than construct corresponding
<code>btrfs subvolume {create|snapshot|set-default}</code> commands after fs
creation and before actual mount. What do you think?<br />
I may find a time to make some basic implementation for this, if you
find this suggestion reasonable.</p>
<h4 id="gdha_commented_at_2014-08-19_0656"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/issues/233#issuecomment-52596836">2014-08-19 06:56</a>:<a class="headerlink" href="#gdha_commented_at_2014-08-19_0656" title="Permanent link">&para;</a></h4>
<p>@pavoldomin I like the idea as currently btrfs is a nightmare the way it
is implemented across the different Linux distro's. We would be happy to
accept a pull request around new layout code for btrfs.<br />
@rear/contributors Any other suggestions or comments?</p>
<h4 id="pavoldomin_commented_at_2014-08-19_0707"><img src="https://avatars.githubusercontent.com/u/1576908?v=4" width="50"><a href="https://github.com/pavoldomin">pavoldomin</a> commented at <a href="https://github.com/rear/rear/issues/233#issuecomment-52597609">2014-08-19 07:07</a>:<a class="headerlink" href="#pavoldomin_commented_at_2014-08-19_0707" title="Permanent link">&para;</a></h4>
<p>...With the one additional correction. Obviously,
<code>btrfs_snapshot &lt;btrfs subvolume list -s output&gt;</code> make little sense, as
there is no tool (none that i am aware of) to backup/restore btrfs
snapshots.</p>
<h4 id="gdha_commented_at_2014-11-03_1502"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/issues/233#issuecomment-61489959">2014-11-03 15:02</a>:<a class="headerlink" href="#gdha_commented_at_2014-11-03_1502" title="Permanent link">&para;</a></h4>
<p>@rear/contributors The
<code>usr/share/rear/layout/prepare/GNU/Linux/13_include_filesystem_code.sh</code>
script contains one big functions <code>create_fs</code> which is called from
<code>usr/share/rear/lib/layout-functions.sh</code> section
<code>create_$type "$device"</code> to recreate the file system and mount it under
<code>/mnt/local/</code><br />
However, the <em>btrfs</em> file system is becoming so complex to mount
something with its sub-volumes etc., and furthermore the way to do it
differs between the Linux distro's I think it would become wiser to make
a separate script under the Linux distro directories, e.g. <code>SUSE_LINUX</code>
or <code>Fedora</code> to mount it. Perhaps we could make a script
<code>14_mount_filesystem_code.sh</code> with a function <code>mount_fs</code>.<br />
E.g. <code>layout/prepare/GNU/Linux/13_mount_filesystem_code.sh</code> and
<code>layout/prepare/SUSE_LINUX/i386/14_mount_filesystem_code.sh</code> (use 14 for
as distro related code which is higher than 13 - so we are sure it
overrules the generic <code>mount_fs</code> function).<br />
All feedback is welcome...</p>
<h4 id="gdha_commented_at_2015-01-25_1709"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/issues/233#issuecomment-71381476">2015-01-25 17:09</a>:<a class="headerlink" href="#gdha_commented_at_2015-01-25_1709" title="Permanent link">&para;</a></h4>
<p>Issue #497 also includes fedora btrfs support - we can close this one</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2024 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2013-05-31.233.issue.closed.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/rear/rear-user-guide" class="fa fa-code-fork" style="color: #fcfcfc"> rear/rear-user-guide</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
