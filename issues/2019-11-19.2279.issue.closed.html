<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#2279 Issue closed: Do more when COPY_AS_IS misses required shared libraries? - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#2279 Issue closed: Do more when COPY_AS_IS misses required shared libraries?";
        var mkdocs_page_input_path = "issues/2019-11-19.2279.issue.closed.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a> &raquo;</li>
      <li class="breadcrumb-item active">#2279 Issue closed: Do more when COPY_AS_IS misses required shared libraries?</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="2279_issue_closed_do_more_when_copy_as_is_misses_required_shared_libraries"><a href="https://github.com/rear/rear/issues/2279">#2279 Issue</a> <code>closed</code>: Do more when COPY_AS_IS misses required shared libraries?<a class="headerlink" href="#2279_issue_closed_do_more_when_copy_as_is_misses_required_shared_libraries" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>enhancement</code>, <code>documentation</code>, <code>cleanup</code>,
<code>fixed / solved / done</code></p>
<h4 id="olivero2_opened_issue_at_2019-11-19_1432"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> opened issue at <a href="https://github.com/rear/rear/issues/2279">2019-11-19 14:32</a>:<a class="headerlink" href="#olivero2_opened_issue_at_2019-11-19_1432" title="Permanent link">&para;</a></h4>
<p>This is to continue a discussion about whether to extend the
functionality of <code>COPY_AS_IS</code> with respect to detecting and/or
automatically adding missing shared libraries.</p>
<p>This is a starting point of former postings:
<a href="https://github.com/rear/rear/pull/2278#discussion_r347488398">https://github.com/rear/rear/pull/2278#discussion_r347488398</a></p>
<p>Answering @jsmeix:
<a href="https://github.com/rear/rear/pull/2278#discussion_r347813267">https://github.com/rear/rear/pull/2278#discussion_r347813267</a></p>
<blockquote>
<p>To verify my assumption I ask you to do the following test:</p>
</blockquote>
<p>I did some tests on a production development system (equipped with SSDs
in a RAID 1 configuration). I've used <code>rear mkopalpba</code> as this was where
the libraries were missing. I'm reluctant to post complete logs publicly
from such a system but I nevertheless tried to capture all the relevant
information.</p>
<h4 id="console_output">Console output<a class="headerlink" href="#console_output" title="Permanent link">&para;</a></h4>
<p>These common lines appeared at the top of each run and were stripped
from output below for better readability:</p>
<pre><code>Cannot include default keyboard mapping (no KEYMAPS_DEFAULT_DIRECTORY specified)
Cannot include keyboard mappings (neither KEYMAPS_DEFAULT_DIRECTORY nor KEYMAPS_DIRECTORIES specified)
Broken symlink '/bin/vim' in recovery system because 'readlink' cannot determine its link target
Symlink '/usr/share/misc/magic' -&gt; '/usr/share/file/magic' refers to a non-existing directory on the recovery system.
It will not be copied by default. You can include '/usr/share/file/magic' via the 'COPY_AS_IS' configuration variable.
Symlink '/var/lib/rear' -&gt; '/var/lib/rear' refers to a non-existing directory on the recovery system.
It will not be copied by default. You can include '/var/lib/rear' via the 'COPY_AS_IS' configuration variable.
</code></pre>
<p>Now my experiments with different find configurations in
<code>build/default/990_verify_rootfs.sh</code>:</p>
<ol>
<li>
<p>Using <code>find $ROOTFS_DIR -type f -executable -printf '/%P\n'</code>:</p>
<pre><code>rear# time usr/sbin/rear mkopalpba

real    0m19,947s
user    0m10,081s
sys     0m3,106s
</code></pre>
</li>
<li>
<p>Using <code>find $ROOTFS_DIR -type f -printf '/%P\n'</code>:</p>
<pre><code>rear# time usr/sbin/rear mkopalpba
There are binaries or libraries in the ReaR recovery system that need additional libraries
/usr/lib/x86_64-linux-gnu/plymouth/renderers/drm.so requires additional libraries
        libdrm.so.2 =&gt; not found
/usr/lib/x86_64-linux-gnu/plymouth/label.so requires additional libraries
        libpangocairo-1.0.so.0 =&gt; not found
        libpango-1.0.so.0 =&gt; not found
        libcairo.so.2 =&gt; not found
/usr/lib/x86_64-linux-gnu/plymouth/script.so requires additional libraries
        libply-splash-graphics.so.4 =&gt; not found
ReaR recovery system in '/tmp/rear.Xj27qSSQ3vBsLKx/rootfs' needs additional libraries, check /home/oliver/Repositories/open-source/rear/var/log/rear/rear-foxtrot.log for details

real    0m38,900s
user    0m25,695s
sys     0m8,661s
</code></pre>
</li>
<li>
<p>Using
    <code>find $ROOTFS_DIR -type f \( -executable -o -name '*.so' -o -name '*.so.[0-9]*' \) -printf '/%P\n'</code>:</p>
<pre><code>rear# time usr/sbin/rear mkopalpba
There are binaries or libraries in the ReaR recovery system that need additional libraries
/usr/lib/x86_64-linux-gnu/plymouth/renderers/drm.so requires additional libraries
        libdrm.so.2 =&gt; not found
/usr/lib/x86_64-linux-gnu/plymouth/label.so requires additional libraries
        libpangocairo-1.0.so.0 =&gt; not found
        libpango-1.0.so.0 =&gt; not found
        libcairo.so.2 =&gt; not found
/usr/lib/x86_64-linux-gnu/plymouth/script.so requires additional libraries
        libply-splash-graphics.so.4 =&gt; not found
ReaR recovery system in '/tmp/rear.V9PCzDCTxHcYtvk/rootfs' needs additional libraries, check /home/oliver/Repositories/open-source/rear/var/log/rear/rear-foxtrot.log for details

real    0m21,177s
user    0m10,828s
sys     0m3,409s
</code></pre>
</li>
<li>
<p>Using
    <code>find $ROOTFS_DIR/bin $ROOTFS_DIR/lib* $ROOTFS_DIR/opt $ROOTFS_DIR/sbin $ROOTFS_DIR/usr/bin $ROOTFS_DIR/usr/lib* $ROOTFS_DIR/usr/local $ROOTFS_DIR/usr/sbin -type f \( -executable -o -name '*.so' -o -name '*.so.[0-9]*' \) -print | sed "s;^$ROOTFS_DIR;;"</code>:</p>
<pre><code>rear# time usr/sbin/rear mkopalpba
There are binaries or libraries in the ReaR recovery system that need additional libraries
/usr/lib/x86_64-linux-gnu/plymouth/renderers/drm.so requires additional libraries
        libdrm.so.2 =&gt; not found
/usr/lib/x86_64-linux-gnu/plymouth/label.so requires additional libraries
        libpangocairo-1.0.so.0 =&gt; not found
        libpango-1.0.so.0 =&gt; not found
        libcairo.so.2 =&gt; not found
/usr/lib/x86_64-linux-gnu/plymouth/script.so requires additional libraries
        libply-splash-graphics.so.4 =&gt; not found
ReaR recovery system in '/tmp/rear.GGJ1oyz8XIuv7U9/rootfs' needs additional libraries, check /home/oliver/Repositories/open-source/rear/var/log/rear/rear-foxtrot.log for details

real    0m20,628s
user    0m10,856s
sys     0m3,362s
</code></pre>
</li>
</ol>
<h4 id="log_excerpts">Log excerpts<a class="headerlink" href="#log_excerpts" title="Permanent link">&para;</a></h4>
<ul>
<li>Log excerpt from configuration no. 2:
    <a href="https://github.com/rear/rear/files/3864218/2.log.txt">2.log.txt</a></li>
<li>Log excerpt from configuration no. 4:
    <a href="https://github.com/rear/rear/files/3864220/4.log.txt">4.log.txt</a></li>
</ul>
<h4 id="remarks">Remarks<a class="headerlink" href="#remarks" title="Permanent link">&para;</a></h4>
<ul>
<li>Checking each and every file (no. 2) takes about 20 additional
    seconds (+50%) on a seemingly rather fast system.</li>
<li>Including just shared libraries into the search required almost no
    additional time (below measurement precision).</li>
<li>Configurations no. 3 and no. 4 limit the check to executables and
    shared libraries conforming to Linux conventions (cf. <a href="http://tldp.org/HOWTO/Program-Library-HOWTO/shared-libraries.html">Shared
    Libraries</a>).</li>
<li>Configuration no. 4 limits the check to all reasonable directories
    containing executables according to the <a href="https://en.wikipedia.org/wiki/Filesystem_Hierarchy_Standard">Filesystem Hierarchy
    Standard</a>.
    (As this uses find with<br />
    multiple starting points, stripping <code>$ROOTFS_DIR</code> from paths could
    not be done via <code>-printf</code>, so sed was used.)</li>
<li>To choose an option, there are some conflicting goals to consider:<ul>
<li>Fast runtime -&gt; shorter testing cycles for ReaR developers
    and users -&gt; more contributions, better product quality</li>
<li>More complete checking -&gt; catching remaining errors early
    -&gt; better operational quality</li>
<li>Safer checking -&gt; reducing the attack surface -&gt;
    protecting privacy, avoiding financial losses</li>
</ul>
</li>
<li>Keeping in mind that all of the above alternatives would improve the
    current situation: If we cannot have everything, which goal do we
    value more?<br />
    We'd have to judge the likelihood and risks involved. Would we go
    for finding problems in obscure places or would we prefer higher
    security?</li>
<li>In my view, as ReaR is a program that runs regularly with root
    privileges, I'd favor security over catching errors in obscure
    situations. Note that chroot doesn't help here as root can easily
    break out of it (cf. <a href="https://access.redhat.com/blogs/766093/posts/1975883">Is chroot a security feature? - Red Hat
    Customer
    Portal</a>).</li>
</ul>
<h4 id="jsmeix_commented_at_2019-11-19_1519"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2279#issuecomment-555555150">2019-11-19 15:19</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-11-19_1519" title="Permanent link">&para;</a></h4>
<p>For completeness and easier readability<br />
a copy of the relevant posts about this topic here<br />
in
<a href="https://github.com/rear/rear/pull/2278">https://github.com/rear/rear/pull/2278</a></p>
<p>A copy of<br />
<a href="https://github.com/rear/rear/pull/2278#discussion_r347445136">https://github.com/rear/rear/pull/2278#discussion_r347445136</a></p>
<p>Now I am wondering if there could be ever a use case<br />
to have a shared object (library) in the ReaR recovery system<br />
but not also all of its dependant required other shared objects?</p>
<p>I think a shared object (library) can not at all work<br />
without its dependant required other shared objects<br />
so I think</p>
<ul>
<li>either have a shared object with all its required other shared
    objects</li>
<li>or do not have the shared object at all because it is useless</li>
</ul>
<p>Or could a shared object be useful in any way<br />
without all its required other shared objects?</p>
<p>A copy of<br />
<a href="https://github.com/rear/rear/pull/2278#discussion_r347458656">https://github.com/rear/rear/pull/2278#discussion_r347458656</a></p>
<p>No. It just won't load. So it is a non-functional trap waiting for
someone to step into. ;-)</p>
<p>And I'd like to object, as least a bit: While ReaR is not that high on
(even developer-oriented) usability, it is not that bad: ReaR has so
many little functions included that try to auto-detect and/or
auto-correct stuff which would be hard to get right the first time. So
it just works in many cases, which makes it get usability points. ReaR
also includes considerable effort to spot problems and provide useful
information in logs, which makes it get additional points.</p>
<p>So maybe improving COPY_AS_IS to inspect shared libraries would be a
good idea. Currently, it lets ldd look at every shell/python/whatever
executable script, so why not make it inspect shared libraries? The only
problem would be the naming. It's not just <em>.so or </em>.so<em> (as this would
include syslog.socket) or lib</em>.so*. You could have:</p>
<ul>
<li>libSegFault.so</li>
<li>libacl.so.1.1.0</li>
<li>pam_gdm.so</li>
</ul>
<p>Maybe something like *.so plus <em>.so.[0-9]</em> would do...</p>
<p>A copy of<br />
<a href="https://github.com/rear/rear/pull/2278#discussion_r347488398">https://github.com/rear/rear/pull/2278#discussion_r347488398</a></p>
<p>My reason behinf my question in<br />
<a href="https://github.com/rear/rear/pull/2278#discussion_r347445136">https://github.com/rear/rear/pull/2278#discussion_r347445136</a><br />
is exactly what you propose in your reply<br />
<a href="https://github.com/rear/rear/pull/2278#discussion_r347458656">https://github.com/rear/rear/pull/2278#discussion_r347458656</a></p>
<p>improving COPY_AS_IS to inspect shared libraries would be a good idea</p>
<p>but I would try to go even further and try to<br />
improve COPY_AS_IS to inspect all regular files<br />
because as far as I know ldd won't run amok<br />
for files that it cannot work with<br />
e.g. on my openSUSE Leap 15.0 system</p>
<pre><code># ldd /etc/fstab 
ldd: warning: you do not have execution permission for `/etc/fstab'
        not a dynamic executable

# ldd /boot/vmlinuz-4.12.14-lp150.12.82-default
ldd: warning: you do not have execution permission for `/boot/vmlinuz-4.12.14-lp150.12.82-default'
        not a dynamic executable

# ldd /dev/sda
ldd: /dev/sda: not regular file
</code></pre>
<p>which may result in the end to inspect all regular files<br />
in the recovery system, i.e. to enhance first and foremost<br />
usr/share/rear/build/default/990_verify_rootfs.sh<br />
to check all files if they have all required libraries<br />
actually accessible inside the recovery system.</p>
<p>A copy of<br />
<a href="https://github.com/rear/rear/pull/2278#discussion_r347495018">https://github.com/rear/rear/pull/2278#discussion_r347495018</a></p>
<p>All files would probaby be a bit too much. I've tested a bit and found
that this one would get me all shared libraries:</p>
<pre><code>find / -mount \( -name \*.so -o -name \*.so.[0-9]\* \) -print
</code></pre>
<p>But some caution from
<a href="http://man7.org/linux/man-pages/man1/ldd.1.html">http://man7.org/linux/man-pages/man1/ldd.1.html</a>
seems advisable:</p>
<pre><code>    Security

    Be aware that in some circumstances (e.g., where the program speci‐
    fies an ELF interpreter other than ld-linux.so), some versions of ldd
    may attempt to obtain the dependency information by attempting to
    directly execute the program, which may lead to the execution of
    whatever code is defined in the program's ELF interpreter, and per‐
    haps to execution of the program itself. (In glibc versions before
    2.27, the upstream ldd implementation did this for example, although
    most distributions provided a modified version that did not.)

    Thus, you should never employ ldd on an untrusted executable, since
    this may result in the execution of arbitrary code. A safer alterna‐
    tive when dealing with untrusted executables is:

    $ objdump -p /path/to/program | grep NEEDED

    Note, however, that this alternative shows only the direct dependen‐
    cies of the executable, while ldd shows the entire dependency tree of
    the executable.
</code></pre>
<p>So if someone configured ReaR to include user-writable directories in
COPY_AS_IS, executables lying around there might be executed with root
privileges. This could already happen currently, so it would probably be
a good idea to limit executable examination to safe paths only.</p>
<p>It is not clear from the above statement whether a shared library would
be considered an executable, too (in most respects, it is). So if
COPY_AS_IS were to be extended, it would probably be safer to limit
automatic examination of shared libraries to safe paths only (such as
/lib and /usr/lib) as well.</p>
<p>I still think that extending COPY_AS_IS would be a good idea and might
even save you some support headaches later on.</p>
<p>A copy of<br />
<a href="https://github.com/rear/rear/pull/2278#discussion_r347813267">https://github.com/rear/rear/pull/2278#discussion_r347813267</a></p>
<p>I know about the security issues with ldd<br />
which is another reason behind why I think<br />
I should first and foremost enhance 990_verify_rootfs.sh<br />
to inspect all regular files of the recovery system with ldd<br />
because 990_verify_rootfs.sh is unning ldd within the<br />
recovery system build directory via chroot $ROOTFS_DIR ... ldd<br />
so that things happen within a separated chroot environment<br />
and not directly on the original running system.</p>
<p>I think if 990_verify_rootfs.sh would have checked all regular files<br />
with ldd you would have got a notification about the missing<br />
libraries in your particular recovery system.</p>
<p>To verify my assumption I ask you to do the following test:<br />
Change in your build/default/990_verify_rootfs.sh the line</p>
<pre><code>for binary in $( find $ROOTFS_DIR -type f -executable -printf '/%P\n' ) ; do
</code></pre>
<p>to</p>
<pre><code>for binary in $( find $ROOTFS_DIR -type f -printf '/%P\n' ) ; do
</code></pre>
<p>(i.e. remove the -executable to find all regular files)<br />
and run "rear -D mkrescue" but without your</p>
<pre><code>OPAL_PBA_LIBS+=( /usr/lib/x86_64-linux-gnu/plymouth/*.so )
</code></pre>
<p>and attach your rear debug log so that I can have a look<br />
how things behave then in your case.</p>
<p>I tested it on my rather fast computer on plain command line<br />
where testing all regular files in a /tmp/rear.XXXXXX/rootfs<br />
means testing about 16 times more files<br />
(11769 regular files instead of 732 executables)<br />
which needs about 14 times more time<br />
(about one and a half minute instead of 6 seconds):</p>
<pre><code># ROOTFS_DIR=/tmp/rear.lASNytXC8KICp3f/rootfs

# find $ROOTFS_DIR -type f -executable -printf '/%P\n' | wc -l
732

# find $ROOTFS_DIR -type f -printf '/%P\n' | wc -l
11769

# time for binary in $( find $ROOTFS_DIR -type f -executable -printf '/%P\n' ) ; \
 do chroot $ROOTFS_DIR /bin/bash --login -c "cd $( dirname $binary ) \
 &amp;&amp; ldd $binary" &lt;/dev/null 2&gt;/dev/null | grep -q 'not found' \
 &amp;&amp; broken_binaries="$broken_binaries $binary" ; done

real    0m5.534s
user    0m3.964s
sys     0m3.096s

# time for binary in $( find $ROOTFS_DIR -type f -printf '/%P\n' ) ; \
 do chroot $ROOTFS_DIR /bin/bash --login -c "cd $( dirname $binary ) \
 &amp;&amp; ldd $binary" &lt;/dev/null 2&gt;/dev/null | grep -q 'not found' \
 &amp;&amp; broken_binaries="$broken_binaries $binary" ; done

real    1m17.684s
user    0m55.042s
sys     0m41.441s
</code></pre>
<p>I think one or two minutes more time during "rear mkrescue"<br />
do not matter in practice because I assume there is plenty of time<br />
when the admin runs "rear mkrescue" (or even "rear mkbackup")<br />
and it results a more reliably working recovery system<br />
which could save the admin hours of later work<br />
when the recovery system does not work.</p>
<p>The only case I know where time matters for "rear mkrescue"<br />
is the broken by design 'udev' workflow, cf.<br />
<a href="https://github.com/rear/rear/issues/840">https://github.com/rear/rear/issues/840</a></p>
<p>I also tested "rear mkresue" with a modified 990_verify_rootfs.sh</p>
<pre><code>-for binary in $( find $ROOTFS_DIR -type f -executable -printf '/%P\n' ) ; do
+for binary in $( find $ROOTFS_DIR -type f -printf '/%P\n' ) ; do
...
-    # Redirected stdin for login shell avoids motd welcome message, cf. https://github.com/rear/rear/issues/2120.
-    chroot $ROOTFS_DIR /bin/bash --login -c "cd $( dirname $binary ) &amp;&amp; ldd $binary" &lt; /dev/null | grep -q 'not found' &amp;&amp; broken_binaries="$broken_binaries $binary"
+    # Redirected stdin for login shell avoids motd welcome message, cf. https://github.com/rear/rear/issues/2120
+    # and redirected stderr avoids tons of ldd warning messages in the log like 'ldd: warning: you do not have execution permission for ...'
+    # cf. https://blog.schlomo.schapiro.org/2015/04/warning-is-waste-of-my-time.html
+    chroot $ROOTFS_DIR /bin/bash --login -c "cd $( dirname $binary ) &amp;&amp; ldd $binary" &lt;/dev/null 2&gt;/dev/null | grep -q 'not found' &amp;&amp; broken_binaries="$broken_binaries $binary"
</code></pre>
<p>That modified 990_verify_rootfs.sh needed only about 40 seconds<br />
during "rear mkrescue" in my case.</p>
<p>The reason is that kernel modules are not tested, cf.<br />
<a href="https://github.com/rear/rear/blob/master/usr/share/rear/build/default/990_verify_rootfs.sh#L99">https://github.com/rear/rear/blob/master/usr/share/rear/build/default/990_verify_rootfs.sh#L99</a><br />
and from the 11769 regular files in my recovery system<br />
there are 3935 kernel modules</p>
<pre><code># find $ROOTFS_DIR -type f | wc -l
11769

# find $ROOTFS_DIR -type f | grep '/lib/modules/' | wc -l
3935
</code></pre>
<p>so only about two-thirds of the regular files<br />
are actually tested with ldd.</p>
<p>The whole "rear mkrescue" took one minute and 15 seconds<br />
with testing all regular files that are no kernel modules.</p>
<p>I noticed that I use FIRMWARE_FILES=( 'no' ) (as I always do)<br />
which is not the default.<br />
Without it (i.e. by default) I get about 2000 firmware files<br />
in the recovery system where running ldd also does<br />
not make sense so I also skip ldd for firmware files</p>
<pre><code>-    # so we 'grep' for '/lib/modules/' anywhere in the full path of the binary:
-    grep -q "/lib/modules/" &lt;&lt;&lt;"$binary" &amp;&amp; continue
+    # so we 'grep' for '/lib/modules/' anywhere in the full path of the binary.
+    # Also skip the ldd test for firmware files where it also does not make sense:
+    egrep -q '/lib/modules/|/lib.*/firmware/' &lt;&lt;&lt;"$binary" &amp;&amp; continue
</code></pre>
<p>which saves me about 6 seconds for useless ldd for firmware files.</p>
<p>A copy of<br />
<a href="https://github.com/rear/rear/pull/2278#discussion_r347854647">https://github.com/rear/rear/pull/2278#discussion_r347854647</a></p>
<p>I was thinking about if it could be sufficient<br />
to run ldd only for the regular files in some<br />
"well known" directories in the recovery system.</p>
<p>I did a quick test to see in which directories in the recovery system<br />
ldd found regular files that are dynamic executables<br />
i.e. in which directories in the recovery system there are<br />
files where running ldd makes sense:</p>
<pre><code># ROOTFS_DIR=/tmp/rear.c3mdOvGKSRIkH8L/rootfs/

# for d in $( for f in $( find $ROOTFS_DIR -type f -printf '/%P\n' ) ; \
 do ldd $f 2&gt;/dev/null | grep -v 'not a dynamic executable' \
 &amp;&amp; echo $f is a dynamic executable ; done \
 | grep 'is a dynamic executable' | cut -d ' ' -f1 ) ; \
 do dirname $d ; done | sort -u

/bin
/lib64
/usr/lib/dracut
/usr/lib/dracut/modules.d/99kdump
/usr/lib/perl5/5.26.1/x86_64-linux-thread-multi/CORE
/usr/lib/systemd
/usr/lib/systemd/system-generators
/usr/lib/udev
/usr/lib64
/usr/lib64/rsyslog
</code></pre>
<p>Accordingly files where running ldd makes sense<br />
can appear in arbitrary directories in the recovery system<br />
so it is not sufficient to run ldd only for the regular files<br />
in some "well known" directories in the recovery system.</p>
<h4 id="jsmeix_commented_at_2019-11-19_1535"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2279#issuecomment-555562821">2019-11-19 15:35</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-11-19_1535" title="Permanent link">&para;</a></h4>
<p>@OliverO2<br />
thank you so much for your valuable input.<br />
It helps a lot and it is much appreciated!</p>
<p>On first glance I like your item 3. most of all</p>
<pre><code>find $ROOTFS_DIR -type f \( -executable -o -name '*.so' -o -name '*.so.[0-9]*' \) -printf '/%P\n':
</code></pre>
<p>because it is simple and straightforward<br />
and it is reasonably complete<br />
(libraries without a '.so...' suffix are considered "unreasonable")<br />
and it still runs fast.</p>
<p>By the way:<br />
I don't know if the much simplified directory structure<br />
in the recovery system is still in compliance with the FHS<br />
so by gut feeling I prefer a generic method (as in your item 3.)<br />
over a method that depends on compliance with a standard<br />
(perhaps currently it is in compliance with FHS but<br />
should we depend and rely on that for the future?), cf.<br />
"Better very simple code than oversophisticated (possibly fragile)
constructs"<br />
in
<a href="https://github.com/rear/rear/wiki/Coding-Style">https://github.com/rear/rear/wiki/Coding-Style</a></p>
<h4 id="jsmeix_commented_at_2019-11-19_1606"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2279#issuecomment-555577578">2019-11-19 16:06</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-11-19_1606" title="Permanent link">&para;</a></h4>
<p>@OliverO2<br />
if you like you could test
<a href="https://github.com/rear/rear/pull/2280">https://github.com/rear/rear/pull/2280</a></p>
<h4 id="olivero2_commented_at_2019-11-19_1610"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/issues/2279#issuecomment-555579381">2019-11-19 16:10</a>:<a class="headerlink" href="#olivero2_commented_at_2019-11-19_1610" title="Permanent link">&para;</a></h4>
<p>@jsmeix<br />
The FHS is pretty broad, so with respect to this issue ReaR is
sufficiently compliant. I'd say that find configuration no. 4 would
almost never miss a single executable or library. I'd be surprised if
any of the supported operating systems or ReaR itself were deviating
from the directories covered by no 4.</p>
<p>I would not expect problems own my own if you'd not limit the directory
list. But I'd be unhappy if some admin by accident configured something
like <code>/home/hugo/testing</code> into <code>COPY_AS_IS</code>, forgets about it later, and
then some scary executables make it into that user directory, having
code execute with root privileges on the next (automatic) run of
<code>rear mkrescue</code>. The common policy for privileged executables is to do
only what's absolutely necessary with root privileges and drop
privileges as soon as possible.</p>
<h4 id="olivero2_commented_at_2019-11-19_1611"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/issues/2279#issuecomment-555579684">2019-11-19 16:11</a>:<a class="headerlink" href="#olivero2_commented_at_2019-11-19_1611" title="Permanent link">&para;</a></h4>
<blockquote>
<p>@OliverO2<br />
if you like you could test #2280</p>
</blockquote>
<p>I'll do.</p>
<h4 id="olivero2_commented_at_2019-11-19_1853"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/issues/2279#issuecomment-555654259">2019-11-19 18:53</a>:<a class="headerlink" href="#olivero2_commented_at_2019-11-19_1853" title="Permanent link">&para;</a></h4>
<p>Have tested it with <code>mkopalpba</code>, successfully. Made me even find another
set of libraries with one additional missing dependency. Pushed another
commit to correct this.</p>
<h4 id="jsmeix_commented_at_2019-11-22_1239"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2279#issuecomment-557516738">2019-11-22 12:39</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-11-22_1239" title="Permanent link">&para;</a></h4>
<p>With
<a href="https://github.com/rear/rear/pull/2280">https://github.com/rear/rear/pull/2280</a>
merged<br />
this issue should be fixed for now.</p>
<p>I would like to do a mitigation of the ldd security issue<br />
with things like <code>COPY_AS_IS+=( /home/JohnDoe )</code><br />
in a separated pull request, cf.<br />
<a href="https://github.com/rear/rear/pull/2280#issuecomment-557501226">https://github.com/rear/rear/pull/2280#issuecomment-557501226</a></p>
<h4 id="jsmeix_commented_at_2019-11-25_1628"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2279#issuecomment-558232897">2019-11-25 16:28</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-11-25_1628" title="Permanent link">&para;</a></h4>
<p>@OliverO2<br />
I would appreciate it if you could have a look at my subsequent pull
request<br />
<a href="https://github.com/rear/rear/pull/2286">https://github.com/rear/rear/pull/2286</a></p>
<h4 id="jsmeix_commented_at_2019-11-29_1304"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2279#issuecomment-559783624">2019-11-29 13:04</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-11-29_1304" title="Permanent link">&para;</a></h4>
<p>With
<a href="https://github.com/rear/rear/pull/2286">https://github.com/rear/rear/pull/2286</a>
merged<br />
the mitigation of the ldd security issue<br />
with things like <code>COPY_AS_IS+=( /home/JohnDoe )</code><br />
is implemented.</p>
<h4 id="jsmeix_commented_at_2019-11-29_1309"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2279#issuecomment-559784912">2019-11-29 13:09</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-11-29_1309" title="Permanent link">&para;</a></h4>
<p>@OliverO2<br />
because since
<a href="https://github.com/rear/rear/pull/2286">https://github.com/rear/rear/pull/2286</a><br />
the ldd test is skipped for files with untrused owner<br />
it can now happen that executables with untrused owner<br />
do not work in the recovery system when there are<br />
missing libraries for executables with untrused owner<br />
and "rear mkrescue" would not error out in this case<br />
but the user is at least informed, cf.<br />
<a href="https://github.com/rear/rear/pull/2286#issuecomment-559757716">https://github.com/rear/rear/pull/2286#issuecomment-559757716</a></p>
<h4 id="jsmeix_commented_at_2019-11-29_1311"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2279#issuecomment-559785533">2019-11-29 13:11</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-11-29_1311" title="Permanent link">&para;</a></h4>
<p>My next step is to use TRUSTED_FILE_OWNERS to check<br />
all files before they are copied into the recovery system<br />
or directly after they were copied into the recovery system<br />
(depending on what works better or is simpler to implement)<br />
which will be done via a separated pull request (as time permits).</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2023 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2019-11-19.2279.issue.closed.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
