<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#3058 PR merged: Skip useless xfs mount options when mounting during recovery - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#3058 PR merged: Skip useless xfs mount options when mounting during recovery";
        var mkdocs_page_input_path = "issues/2023-10-25.3058.pr.merged.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#3058 PR merged: Skip useless xfs mount options when mounting during recovery</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="3058_pr_merged_skip_useless_xfs_mount_options_when_mounting_during_recovery"><a href="https://github.com/rear/rear/pull/3058">#3058 PR</a> <code>merged</code>: Skip useless xfs mount options when mounting during recovery<a class="headerlink" href="#3058_pr_merged_skip_useless_xfs_mount_options_when_mounting_during_recovery" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>enhancement</code>, <code>bug</code>, <code>fixed / solved / done</code></p>
<h4 id="pcahyna_opened_issue_at_2023-10-25_1047"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> opened issue at <a href="https://github.com/rear/rear/pull/3058">2023-10-25 10:47</a>:<a class="headerlink" href="#pcahyna_opened_issue_at_2023-10-25_1047" title="Permanent link">&para;</a></h4>
<h5 id="pull_request_details">Pull Request Details:<a class="headerlink" href="#pull_request_details" title="Permanent link">&para;</a></h5>
<ul>
<li>
<p>Type: <strong>Bug Fix</strong></p>
</li>
<li>
<p>Impact: <strong>Normal</strong></p>
</li>
<li>
<p>Reference to related issue (URL): closes #2777</p>
</li>
<li>
<p>How was this pull request tested?<br />
    Full backup and recovery with `MKFS_XFS_OPTIONS="-d sunit=128 -d
    swidth=128" and root on XFS. Before the change, recovery failed to
    mount the root filesystem during layout restoration.</p>
</li>
<li>
<p>Description of the changes in this pull request:</p>
</li>
</ul>
<p>The mount command displays all mount options for a filesystem, including
those that are not explictitly set in fstab, and ReaR saves them to disk
layout. In the case of XFS, some of them can be harmful for mounting the
filesystem during layout restoration:</p>
<p>The <code>logbsize=</code>... mount option is a purely performance/memory usage
optimization option, which can lead to mount failures, because it must
be an integer multiple of the log stripe unit and the log stripe unit
can be different in the recreated filesystem from the original
filesystem. It was reported for some some exotic situation apparently
involving an old filesystem created with a version of xfsprogs that
accepted values that it does not accept anymore, see GitHub issue #2777
. More importantly, it can occur when using <code>MKFS_XFS_OPTIONS</code>, because
this will lead to a change of filesystem parameters and the mount
options will no longer match. If <code>logbsize</code> is not an integer multiple
of the log stripe unit, mount fails with the warning
<code>XFS (...): logbuf size must be greater than or equal to log stripe size</code>
in the kernel log (and a confusing error message
<code>mount: ...: wrong fs type, bad option, bad superblock on ..., missing codepage or helper program, or other error.</code>
from the mount command), causing the layout restoration in the recovery
process to fail.</p>
<p>Wrong sunit/swidth can cause mount to fail as well, with this in the
kernel log:
<code>kernel: XFS (...): alignment check failed: sunit/swidth vs. agsize</code>.</p>
<p>Therefore, remove the <code>logbsize=</code>... and <code>sunit=</code>.../<code>swidth=</code>... from
XFS mount options before mounting the file system.</p>
<p>(Another option possibility be to remove them already when saving the
layout, in layout/save/GNU/Linux/230_filesystem_layout.sh, but I
decided to follow the example of btrfs here.)</p>
<h4 id="jsmeix_commented_at_2023-10-26_0823"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/3058#issuecomment-1780641848">2023-10-26 08:23</a>:<a class="headerlink" href="#jsmeix_commented_at_2023-10-26_0823" title="Permanent link">&para;</a></h4>
<p>@pcahyna<br />
I am wondering if the function name <code>remove_mount_options_values</code><br />
correctly indicates what this function actually does because<br />
from only reading its description it seems this function<br />
removes whole mount options like<br />
<code>nodev,uid=1,rw,gid=1</code>-&gt; <code>nodev,rw</code><br />
and not only the values from mount options like<br />
<code>nodev,uid=1,rw,gid=1</code>-&gt; <code>nodev,uid,rw,gid</code><br />
so the simpler function name <code>remove_mount_options</code> might be better?</p>
<h4 id="jsmeix_commented_at_2023-10-26_0907"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/3058#issuecomment-1780713972">2023-10-26 09:07</a>:<a class="headerlink" href="#jsmeix_commented_at_2023-10-26_0907" title="Permanent link">&para;</a></h4>
<p>It is an enhancement when ReaR even works in an<br />
"exotic situation apparently involving an old filesystem<br />
created with a version of xfsprogs that accepted values<br />
that it does not accept anymore".</p>
<p>I think in practice that situation is not as exotic as it seems<br />
because (at least how SLES service pack upgrades happen at SUSE)<br />
it could be rather common that upgrades of basic system software<br />
happen via software package upgrades (e.g. RPM package updates)<br />
and (of course) not by reinstalling the system anew.</p>
<p>By the way cf.<br />
<a href="https://en.opensuse.org/SDB:Disaster_Recovery">https://en.opensuse.org/SDB:Disaster_Recovery</a></p>
<pre><code>You must continuously validate that the recovery
still works on the replacement hardware in particular
after each change of the basic system.
.
.
.
When you have a working disaster recovery procedure,
do not upgrade ReaR and do not change the basic software
that is used by ReaR (like partitioning tools, filesystem tools,
bootloader tools, ISO image creating tools, and so on).
...
When you have a working disaster recovery procedure running
and you upgrade software that is related to the basic system
or you do other changes in your basic system, you must also
carefully and completely re-validate that your particular
disaster recovery procedure still works for you.
</code></pre>
<h4 id="pcahyna_commented_at_2023-10-26_1028"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/3058#issuecomment-1780846094">2023-10-26 10:28</a>:<a class="headerlink" href="#pcahyna_commented_at_2023-10-26_1028" title="Permanent link">&para;</a></h4>
<blockquote>
<p>@pcahyna I am wondering if the function name
<code>remove_mount_options_values</code> correctly indicates what this function
actually does because from only reading its description it seems this
function removes whole mount options like <code>nodev,uid=1,rw,gid=1</code>-&gt;
<code>nodev,rw</code></p>
</blockquote>
<p>more descriptive name would be <code>remove_mount_options_with_values</code>, but I
felt it was a bit too long.</p>
<blockquote>
<p>and not only the values from mount options like
<code>nodev,uid=1,rw,gid=1</code>-&gt; <code>nodev,uid,rw,gid</code> so the simpler function
name <code>remove_mount_options</code> might be better?</p>
</blockquote>
<p><code>remove_mount_options</code> would suggest that it removes anything, even
options without values (<code>rw</code>, <code>nodev</code> and so on), which it is not able
to do (I preferred to keep the implementation simpler).</p>
<p>Maybe it would be better to let the function let look for both options
witjout values, and options with values, and remove them both? (And
rename it.) My only worry is that there might be a case where an option
without a value means something different than an option with a value.
The oncly case I found where an option can be specified both with and
without value is <code>utf8</code>:</p>
<pre><code>       utf8
           UTF8 is the filesystem safe 8-bit encoding of Unicode that is used
           by the console. It can be enabled for the filesystem with this
           option or disabled with utf8=0, utf8=no or utf8=false. If uni_xlate
           gets set, UTF8 gets disabled.
</code></pre>
<h4 id="jsmeix_commented_at_2023-10-26_1058"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/3058#issuecomment-1780890829">2023-10-26 10:58</a>:<a class="headerlink" href="#jsmeix_commented_at_2023-10-26_1058" title="Permanent link">&para;</a></h4>
<p>@pcahyna<br />
I didn't want to make a bigger issue with this function name.<br />
Leave it as is - its current name is OK - and what is most important:<br />
It is well described what it does so the name is not a real issue.</p>
<h4 id="pcahyna_commented_at_2023-10-26_1110"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/3058#issuecomment-1780907433">2023-10-26 11:10</a>:<a class="headerlink" href="#pcahyna_commented_at_2023-10-26_1110" title="Permanent link">&para;</a></h4>
<blockquote>
<p>It is an enhancement when ReaR even works in an "exotic situation
apparently involving an old filesystem created with a version of
xfsprogs that accepted values that it does not accept anymore".</p>
<p>I think in practice that situation is not as exotic as it seems
because (at least how SLES service pack upgrades happen at SUSE) it
could be rather common that upgrades of basic system software happen
via software package upgrades (e.g. RPM package updates) and (of
course) not by reinstalling the system anew.</p>
</blockquote>
<p>Indeed.</p>
<p>I described it as "exotic", because even in older RHEL versions that had
more relaxed checks on XFS parameters I was not able to create the
problematic combination of parameters. Probably there is some trick that
I am missing, given that the bug report is real.</p>
<h4 id="pcahyna_commented_at_2023-10-30_1730"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/3058#issuecomment-1785720910">2023-10-30 17:30</a>:<a class="headerlink" href="#pcahyna_commented_at_2023-10-30_1730" title="Permanent link">&para;</a></h4>
<p>@jsmeix thank you for having a look!</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2023 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2023-10-25.3058.pr.merged.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
