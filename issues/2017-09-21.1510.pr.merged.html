<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#1510 PR merged: Improve ReaR network migration - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#1510 PR merged: Improve ReaR network migration";
        var mkdocs_page_input_path = "issues/2017-09-21.1510.pr.merged.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#1510 PR merged: Improve ReaR network migration</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="1510_pr_merged_improve_rear_network_migration"><a href="https://github.com/rear/rear/pull/1510">#1510 PR</a> <code>merged</code>: Improve ReaR network migration<a class="headerlink" href="#1510_pr_merged_improve_rear_network_migration" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>enhancement</code>, <code>fixed / solved / done</code></p>
<h4 id="schabrolles_opened_issue_at_2017-09-21_1501"><img src="https://avatars.githubusercontent.com/u/19491077?u=0021b16ab426902cbe676f6831f41607bbe4d441&v=4" width="50"><a href="https://github.com/schabrolles">schabrolles</a> opened issue at <a href="https://github.com/rear/rear/pull/1510">2017-09-21 15:01</a>:<a class="headerlink" href="#schabrolles_opened_issue_at_2017-09-21_1501" title="Permanent link">&para;</a></h4>
<p>The objective of this PR is to update the network migration process in
ReaR.</p>
<p>Before this PR, network migration was based on udev rules files to
detect and update mac or interface name.</p>
<p>A) The problem is that newer Linux distro (rhel7, ubuntu) does not
automatically update anymore the udev network rule files.</p>
<p>This prevent ReaR :</p>
<ul>
<li>to propose new interface in case of migration</li>
<li>to rename interface and properly activate network in recovery mode</li>
<li>to perform Network Migration on the restored image.</li>
</ul>
<p>=&gt; Migration is also currently impossible with <code>biosdevname</code> network
interface name format (which is the new default for ubuntu/redhat.)</p>
<p>B) Network parameter migration (ip/routes via
<code>/etc/rear/mapping/ip_addresses</code> or <code>/etc/rear/mapping/routes</code>) are only
compatible with RedHat/Suse sysconfig file format. (not debian/ubuntu)</p>
<p>This PR propose a migration compatible with latest RH / ubuntu (not
based in udev rules but biosdevname) while keeping compatibility with
udev rules for older distro.</p>
<ol>
<li>always propose new interface (even when udev rules is not used or
    empty)</li>
<li>keep udev rules renaming as default (for compatibility)</li>
<li>perform a direct migration of network system-setup scripts (only if
    udev migration cannot be done.) =&gt; to activate network in rescue
    mode</li>
<li>Allow a migration of debian/ubuntu network configuration files
    (currently only redhat/suse)</li>
</ol>
<p>Tested in migration on POWER with rhel 7.3 / suse 11 / suse 12 / ubuntu
16.04 (with and without <code>net.ifnames=0</code>)</p>
<h4 id="jsmeix_commented_at_2017-09-22_0912"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1510#issuecomment-331394855">2017-09-22 09:12</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-09-22_0912" title="Permanent link">&para;</a></h4>
<p>Only for the fun of it:<br />
Perhaps the initial comment in<br />
finalize/GNU/Linux/320_migrate_network_configuration_files.sh<br />
is no longer fully right:<br />
"rewrite all the network configuration files for SUSE LINUX"<br />
;-)</p>
<h4 id="schabrolles_commented_at_2017-09-22_0949"><img src="https://avatars.githubusercontent.com/u/19491077?u=0021b16ab426902cbe676f6831f41607bbe4d441&v=4" width="50"><a href="https://github.com/schabrolles">schabrolles</a> commented at <a href="https://github.com/rear/rear/pull/1510#issuecomment-331403222">2017-09-22 09:49</a>:<a class="headerlink" href="#schabrolles_commented_at_2017-09-22_0949" title="Permanent link">&para;</a></h4>
<p>@jsmeix thanks for the quick review and trust :-) ... But I will wait
the other to test this one with vagrant to cross check and hunt any
regression / issues.<br />
Especially @gdha as I think it should solves some of the issues he had
with ubuntu and <code>biosdevames</code> (#1400, #951 and #1020)</p>
<h4 id="jsmeix_commented_at_2017-09-22_1004"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1510#issuecomment-331406631">2017-09-22 10:04</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-09-22_1004" title="Permanent link">&para;</a></h4>
<p>@schabrolles<br />
don't overestimate my trust here ;-)<br />
Basically all I can do is to "bindly trust" you here<br />
because I am mostly clueless in this area<br />
so better do not trust my review here.</p>
<h4 id="jsmeix_commented_at_2017-09-22_1134"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1510#issuecomment-331423317">2017-09-22 11:34</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-09-22_1134" title="Permanent link">&para;</a></h4>
<p>@schabrolles<br />
because you added your functions to lib/network-functions.sh<br />
I had a first look at that script (I never had something to do with
it)<br />
and I saw its strange looking functions (some of them even<br />
just call 'exit' which is totally unusual in "normal" ReaR scripts).</p>
<p>Now I am wondering (in particular after reading its initial comment)<br />
if lib/network-functions.sh was ever meant to be sourced<br />
by usr/sbin/rear to make its strange functions avaiable<br />
to all ReaR scripts?</p>
<p>In current (i.e. without this pull request) code<br />
lib/network-functions.sh is explicitly sourced by<br />
skel/default/bin/dhclient-script and<br />
skel/default/etc/scripts/system-setup.d/58-start-dhclient.sh<br />
which matches the initial comment in lib/network-functions.sh</p>
<p>Currently the only "normal" ReaR script that calls<br />
a function from lib/network-functions.sh is<br />
finalize/GNU/Linux/320_migrate_network_configuration_files.sh<br />
which calls only the prefix2netmask function and that call<br />
was added by @gdha via<br />
<a href="https://github.com/rear/rear/commit/8472c46b31de2b748a6f948325101a970c452e61">https://github.com/rear/rear/commit/8472c46b31de2b748a6f948325101a970c452e61</a></p>
<p>From my current point of view lib/network-functions.sh<br />
was never meant to be sourced by usr/sbin/rear to have<br />
its functions available in all "normal" ReaR scripts.</p>
<p>From my current point of view lib/network-functions.sh<br />
is only meant to be sourced and used to setup dhclient<br />
during recovery system initialization via the 'skel' scripts.</p>
<p>Simply put:<br />
I think some general cleanup is needed here.<br />
I think this should be done as a separated issue:<br />
I think network-functions.sh should be renamed into<br />
somethinmg like dhclient-setup-functions.sh<br />
and moved away from usr/share/rear/lib<br />
probably into usr/share/rear/skel and the two 'skel' scritps<br />
that source it should be adapted.</p>
<p>@schabrolles<br />
accordingly I think that your new networking functions<br />
should be implemented in a new separated file<br />
so that later we can do the dhclient setup functions<br />
cleanup.</p>
<p>The problem is that lib/network-functions.sh is the exact right name<br />
for generic networking functions for normal ReaR scripts<br />
so that the current lib/network-functions.sh should be right now<br />
renamed e.g. into dhclient-setup-functions.sh but then the two<br />
'skel' scripts need to be adapted right now which means<br />
that general cleanup needs to be done right now :-(</p>
<p>@schabrolles<br />
what do you think?</p>
<h4 id="jsmeix_commented_at_2017-09-22_1214"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1510#issuecomment-331430528">2017-09-22 12:14</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-09-22_1214" title="Permanent link">&para;</a></h4>
<p>@gdha<br />
I see now that lib/network-functions.sh was added via your<br />
<a href="https://github.com/rear/rear/commit/38d5bd280654dd4e05a8a408daad8e08925c3ab0">https://github.com/rear/rear/commit/38d5bd280654dd4e05a8a408daad8e08925c3ab0</a></p>
<p>Can you explain if that strange looking functions therein<br />
are really meant to be always available in all normal<br />
ReaR scripts?</p>
<p>What I mean is:<br />
None of the functions in lib/network-functions.sh<br />
uses any of the standard ReaR functions that we have<br />
but instead those functions in lib/network-functions.sh<br />
implement all on their own so that I think those functions<br />
basically come from a foreign world and live in that world<br />
which makes them not well suitable to be used by normal<br />
ReaR scripts.</p>
<h4 id="jsmeix_commented_at_2017-09-22_1219"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1510#issuecomment-331431446">2017-09-22 12:19</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-09-22_1219" title="Permanent link">&para;</a></h4>
<p>@schabrolles<br />
I really dislike it when a specific issue like this one<br />
out of a sudden "explodes" into a monstrous task<br />
to overhaul major parts of ReaR.<br />
I do want to Keep Separated Issues Separated (KSIS).<br />
Therefore it should be best when you first merge<br />
this pull request as soon as possible.<br />
Afterwards we can do the lib/network-functions.sh<br />
cleanup as time permits.</p>
<h4 id="jsmeix_commented_at_2017-09-22_1230"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1510#issuecomment-331433456">2017-09-22 12:30</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-09-22_1230" title="Permanent link">&para;</a></h4>
<p>I missed two functions in lib/network-functions.sh<br />
that are currently called by a normal ReaR script:<br />
is_ip and get_ip_from_fqdn are called in
lib/bootloader-functions.sh<br />
which was implemented by @schabrolles via<br />
<a href="https://github.com/rear/rear/commit/ef0256256d38e8c52d7f3e17797ea9378f3727b4">https://github.com/rear/rear/commit/ef0256256d38e8c52d7f3e17797ea9378f3727b4</a></p>
<h4 id="schabrolles_commented_at_2017-09-25_1327"><img src="https://avatars.githubusercontent.com/u/19491077?u=0021b16ab426902cbe676f6831f41607bbe4d441&v=4" width="50"><a href="https://github.com/schabrolles">schabrolles</a> commented at <a href="https://github.com/rear/rear/pull/1510#issuecomment-331880506">2017-09-25 13:27</a>:<a class="headerlink" href="#schabrolles_commented_at_2017-09-25_1327" title="Permanent link">&para;</a></h4>
<p>@jsmeix<br />
I've source <code>lib/network-functions.sh</code> in the <strong>skel</strong> <code>00-functions.sh</code>
to have access to <code>get_device_by_hwaddr()</code> function in
<code>55-migrate-network-devices.sh</code> (also part of <strong>skel</strong>).<br />
=&gt; The purpose is to have to IP set to the good interface (recognized
by its IP) during boot in rescue mode. (when <code>/etc/scripts/system-setup</code>
and <code>/etc/scripts/system-setup.d/*</code> scripts are executed.)</p>
<p>I'm not sure that <code>usr/sbin/rear</code> will execute
<code>/etc/scripts/system-setup.d/00-functions.sh</code>.... But I may be wrong.</p>
<h4 id="jsmeix_commented_at_2017-09-26_0922"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1510#issuecomment-332139660">2017-09-26 09:22</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-09-26_0922" title="Permanent link">&para;</a></h4>
<p>@schabrolles<br />
just proceed here as you like and as it works for you<br />
because as I wrote above we should do any<br />
"grand cleanup" via a separated issue/pull-request<br />
later at any time as time permits because currently<br />
nothing goes wrong so that there is no need to do<br />
such a "grand cleanup" right now.</p>
<h4 id="gdha_commented_at_2017-09-26_0924"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/pull/1510#issuecomment-332140203">2017-09-26 09:24</a>:<a class="headerlink" href="#gdha_commented_at_2017-09-26_0924" title="Permanent link">&para;</a></h4>
<p>@schabrolles @jsmeix I agree that network-functions.sh is collection I
grabbed from an old RHEL system to get the job done as easy as possible
(at that time - many, many years ago).<br />
I agree we better split it apart (network piece required for DHCP in
skel and network functions which are required by main rear script). That
will make it easier afterwards to clean it up.<br />
I also agree to merge this PR asap to get things going as the PR is a
good thing to have.<br />
@schabrolles rear will not execute
<code>/etc/scripts/system-setup.d/00-functions.sh</code> or source it as it is part
of the booting up part of the rescue image (it is sourced by
/etc/scripts/system-setup script)</p>
<h4 id="schabrolles_commented_at_2017-09-26_0939"><img src="https://avatars.githubusercontent.com/u/19491077?u=0021b16ab426902cbe676f6831f41607bbe4d441&v=4" width="50"><a href="https://github.com/schabrolles">schabrolles</a> commented at <a href="https://github.com/rear/rear/pull/1510#issuecomment-332144054">2017-09-26 09:39</a>:<a class="headerlink" href="#schabrolles_commented_at_2017-09-26_0939" title="Permanent link">&para;</a></h4>
<p>@gdha thanks for your review.<br />
Did you try it on your ubuntu 16.04 systems (where you have biosdevname)
? It solves the issues on my side; I just wanted to know if it solves
yours.</p>
<h4 id="jsmeix_commented_at_2017-09-26_1115"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/1510#issuecomment-332166569">2017-09-26 11:15</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-09-26_1115" title="Permanent link">&para;</a></h4>
<p>Regarding the lib/network-functions.sh cleanup I submitted<br />
<a href="https://github.com/rear/rear/issues/1517">https://github.com/rear/rear/issues/1517</a></p>
<h4 id="gdha_commented_at_2017-09-26_1554"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/pull/1510#issuecomment-332244866">2017-09-26 15:54</a>:<a class="headerlink" href="#gdha_commented_at_2017-09-26_1554" title="Permanent link">&para;</a></h4>
<p>@schabrolles No, I did not test it yet with ubuntu16 yet as I was
struggling with ubuntu14 provisioning (just got it working without
errors). Pff - what people need to do to earn some money...<br />
I would say just merge it and I'll test it upcoming Friday with Ubuntu16
(if I did not break the Ubuntu16 provisioning now as everything is now
one cookbook).</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2024 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2017-09-21.1510.pr.merged.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/rear/rear-user-guide" class="fa fa-code-fork" style="color: #fcfcfc"> rear/rear-user-guide</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
