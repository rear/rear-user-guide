<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#2029 Issue closed: No /verify/BORG/ script to verify a BORG backup can be restored - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#2029 Issue closed: No /verify/BORG/ script to verify a BORG backup can be restored";
        var mkdocs_page_input_path = "issues/2019-02-01.2029.issue.closed.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/backup_netfs.html">Example of BACKUP=NETFS</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#2029 Issue closed: No /verify/BORG/ script to verify a BORG backup can be restored</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="2029_issue_closed_no_verifyborg_script_to_verify_a_borg_backup_can_be_restored"><a href="https://github.com/rear/rear/issues/2029">#2029 Issue</a> <code>closed</code>: No /verify/BORG/ script to verify a BORG backup can be restored<a class="headerlink" href="#2029_issue_closed_no_verifyborg_script_to_verify_a_borg_backup_can_be_restored" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>enhancement</code>, <code>fixed / solved / done</code></p>
<h4 id="chojindsl_opened_issue_at_2019-02-01_1710"><img src="https://avatars.githubusercontent.com/u/1926396?u=705546e01ca12110cc5f18b9dbc2ffe1b447cd76&v=4" width="50"><a href="https://github.com/ChojinDSL">ChojinDSL</a> opened issue at <a href="https://github.com/rear/rear/issues/2029">2019-02-01 17:10</a>:<a class="headerlink" href="#chojindsl_opened_issue_at_2019-02-01_1710" title="Permanent link">&para;</a></h4>
<p>Today I setup a new server and took that opportunity to test a recovery
scenario using ReaR. This exposed a couple of issues, which I was
thankfully able to work around.</p>
<p>But I was wondering, is there a possibility to test the recovery
procedure without actually changing anything?<br />
A sort of "dry-run" option if you will.</p>
<p>While I was testing, I ran into several issues.</p>
<ol>
<li>
<p>I use borg as a backup utility. I installed borg via the distro's
    repo. It wasn't until I actually tried to perform a recovery that I
    then realized that a bunch of dependency libraries where missing. I
    managed to fix that by uploading the standalone binary and copying
    it to the correct place and afterwards ensuring that the standalone
    binary was installed on my systems instead of the distro version.</p>
</li>
<li>
<p>Another issue was missing ssh keys for the Recovery ISO to be able
    to connect via SSH to wherever the backups are hosted.<br />
    This was an option I wasn't even aware of and only found by digging
    through the documentation.</p>
</li>
</ol>
<p>Unfortunately, if you perform a recovery, connecting to the Backup
Repository is not performed until AFTER the disks have been written to,
e.g. partition layout, filesystem creation, etc.</p>
<p>This whole situation creates a bit of a chicken and egg scenario. You
won't be aware of the issues until you actually try to perform the whole
procedure for real. Risking a potentially borked system and having to
pursue other recovery options.</p>
<p>Here's where a test run would be beneficial. Basically, run through all
(or almost all) the steps without actually writing anything to the disks
so you can make sure that all the bits and pieces work together.<br />
Especially considering how tricky (if not impossible) it would be to
create a new recovery ISO with the issues fixed.</p>
<h4 id="gozora_commented_at_2019-02-05_1103"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/2029#issuecomment-460597483">2019-02-05 11:03</a>:<a class="headerlink" href="#gozora_commented_at_2019-02-05_1103" title="Permanent link">&para;</a></h4>
<p>Hello @ChojinDSL,</p>
<blockquote>
<p>Today I setup a new server and took that opportunity to test a
recovery scenario using ReaR. This exposed a couple of issues, which I
was thankfully able to work around.</p>
</blockquote>
<p>Yes, as you might have noticed ReaR is designed not to let you hang in
the middle of restore and it gives you breathing space and possibilities
to finish your operation (most of the time ;-))</p>
<blockquote>
<ol>
<li>I use borg as a backup utility. I installed borg via the distro's
    repo. It wasn't until I actually tried to perform a recovery that
    I then realized that a bunch of dependency libraries where
    missing. I managed to fix that by uploading the standalone binary
    and copying it to the correct place and afterwards ensuring that
    the standalone binary was installed on my systems instead of the
    distro version.</li>
</ol>
</blockquote>
<p>There is a notice about this in
<a href="https://github.com/rear/rear/blob/master/doc/user-guide/04-scenarios.adoc#rear-with-borg-back-end">Documentation</a>,
right at the beginning marked as <strong>Important</strong> ;-)</p>
<blockquote>
<ol>
<li>Another issue was missing ssh keys for the Recovery ISO to be able
    to connect via SSH to wherever the backups are hosted. This was an
    option I wasn't even aware of and only found by digging through
    the documentation.</li>
</ol>
</blockquote>
<p>Just FYI, this was implemented because of
<a href="https://github.com/rear/rear/issues/1512">https://github.com/rear/rear/issues/1512</a>.
I'll not comment on this any further ...</p>
<blockquote>
<p>Unfortunately, if you perform a recovery, connecting to the Backup
Repository is not performed until AFTER the disks have been written
to, e.g. partition layout, filesystem creation, etc.</p>
</blockquote>
<p>I currently don't see any easy way how we could implement global
<code>--dry-run</code> into ReaR because there is way to many backup solutions
implemented. However I can think about some pre-check for <strong>Borg</strong>
restore, that will be doing a test connection to Borg server prior
anything is written to disk, and prompts user for if he wants to
continue on failure, it should not be such a big deal ...</p>
<p>@jsmeix thanks for assigning! It somehow escaped my attention ;-).</p>
<p>V.</p>
<h4 id="jsmeix_commented_at_2019-02-05_1108"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2029#issuecomment-460598870">2019-02-05 11:08</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-02-05_1108" title="Permanent link">&para;</a></h4>
<p>Testing the recovery procedure without actually changing anything<br />
i.e. via something like <code>rear --dry-run recover</code> is not supported<br />
and as far as I can imagine this cannot be supported in general.</p>
<p>General reason:<br />
I think it is not possible to test something without actually doing
it.<br />
I think really testing something requires to actually do it<br />
in contrast to checking only this or that preconditions but even<br />
to check a precondition something must be actually done.<br />
One may think to only test something it could be done only temporarily<br />
but "do something temporarily" does not make sense because<br />
what exactly should it mean to "do something temporarily"?<br />
Either it is actually done or something else is done that is only a
fake<br />
to make it look as if it was actually done but in fact nothing was
done<br />
but of course such "nothing" cannot provide any real result.<br />
Cf. the "Reasoning" part in the section about<br />
<code>Transaction Semantics For Each "One Setup"</code> in<br />
<a href="https://en.opensuse.org/Archive:YaST_Printer_redesign">https://en.opensuse.org/Archive:YaST_Printer_redesign</a></p>
<p>@ChojinDSL<br />
regardless of the general reason in your particular case you wrote that</p>
<pre><code>if you perform a recovery, connecting to the Backup Repository
is not performed until AFTER the disks have been written
</code></pre>
<p>This should not happen.</p>
<p>What scripts are usually run during <code>rear recover</code> are<br />
(excerpts - in my case I use BACKUP=NETFS)</p>
<pre><code># usr/sbin/rear -s recover
Relax-and-Recover 2.4 / Git
...
Source conf/...
...
Source init/...
...
Source setup/...
...
Source verify/default/020_cciss_scsi_engage.sh
Source verify/default/020_translate_url.sh
Source verify/default/030_translate_tape.sh
Source verify/default/040_validate_variables.sh
Source verify/NETFS/default/050_check_NETFS_requirements.sh
Source verify/default/050_create_mappings_dir.sh
Source verify/GNU/Linux/050_sane_recovery_check.sh
Source verify/NETFS/default/050_start_required_nfs_daemons.sh
Source verify/NETFS/default/060_mount_NETFS_path.sh
Source verify/NETFS/default/070_set_backup_archive.sh
Source verify/NETFS/default/090_set_readonly_options.sh
Source verify/GNU/Linux/230_storage_and_network_modules.sh
Source verify/GNU/Linux/260_recovery_storage_drivers.sh
Source verify/NETFS/default/550_check_backup_archive.sh
Source verify/NETFS/default/600_check_encryption_key.sh
Source verify/NETFS/default/980_umount_NETFS_dir.sh
Source layout/prepare/...
...
Source layout/recreate/...
...
Source restore/...
...
Source finalize/...
...
Source wrapup/...
...
Exiting rear recover ...
</code></pre>
<p>In the <code>verify</code> stage in case of <code>BACKUP=NETFS</code> there is in particular<br />
usr/share/rear/verify/NETFS/default/550_check_backup_archive.sh<br />
run which checks whether the backup archive is actually there.</p>
<p>I do not use BORG backup but I can set <code>BACKUP=BORG</code> and<br />
run <code>usr/sbin/rear -s recover</code> and then it seems there is<br />
no check script to verify that the backup can be restored:</p>
<pre><code># usr/sbin/rear -s recover
...
Source verify/default/020_cciss_scsi_engage.sh
Source verify/default/020_translate_url.sh
Source verify/default/030_translate_tape.sh
Source verify/default/040_validate_variables.sh
Source verify/default/050_create_mappings_dir.sh
Source verify/GNU/Linux/050_sane_recovery_check.sh
Source verify/GNU/Linux/230_storage_and_network_modules.sh
Source verify/GNU/Linux/260_recovery_storage_drivers.sh
...
</code></pre>
<p>I.e. it seems some <code>/verify/BORG/</code> script is missing that would<br />
verify that the BORG backup can be actually restored.</p>
<p>@gozora<br />
could you have a look here?<br />
I guess some excerpts of the scripts that are run during<br />
BORG backup restore</p>
<pre><code>Source restore/BORG/default/100_set_vars.sh
Source restore/BORG/default/250_mount_usb.sh
Source restore/BORG/default/300_load_archives.sh
Source restore/BORG/default/400_restore_backup.sh
</code></pre>
<p>should be also run already during the <code>verify</code> stage to verify that<br />
the BORG backup can be restored later during the <code>restore</code> stage.</p>
<p>@ChojinDSL<br />
in general when you booted the ReaR recovery system<br />
and logged in there as 'root' you can manually run any<br />
commands you like to check what you need before you<br />
call <code>rear recover</code>.</p>
<p>You can automate that by using PRE_RECOVERY_SCRIPT<br />
see its description in usr/share/rear/conf/default.conf<br />
that is run via
usr/share/rear/setup/default/010_pre_recovery_script.sh<br />
to automatically run e.g. a BORG check command as a workaround<br />
that you could use for now until this issue here got fixed in ReaR.</p>
<p>@ChojinDSL<br />
regarding what you wrote<br />
<code>missing ssh keys for the Recovery ISO to be able to connect via SSH</code><br />
see the documentation about SSH_FILES and SSH_ROOT_PASSWORD<br />
and SSH_UNPROTECTED_PRIVATE_KEYS in<br />
usr/share/rear/conf/default.conf e.g. online at<br />
<a href="https://raw.githubusercontent.com/rear/rear/master/usr/share/rear/conf/default.conf">https://raw.githubusercontent.com/rear/rear/master/usr/share/rear/conf/default.conf</a></p>
<p>For the reason why the recovery system ISO image should not contain<br />
private or confidential data (at least not unless the user explicitly<br />
configured something) see<br />
<a href="https://github.com/rear/rear/pull/1472#issuecomment-328459748">https://github.com/rear/rear/pull/1472#issuecomment-328459748</a></p>
<h4 id="gozora_commented_at_2019-02-05_1117"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/2029#issuecomment-460601248">2019-02-05 11:17</a>:<a class="headerlink" href="#gozora_commented_at_2019-02-05_1117" title="Permanent link">&para;</a></h4>
<p>@jsmeix</p>
<blockquote>
<p>could you have a look here?</p>
</blockquote>
<p>Yes, I'll work on this as time permits ...</p>
<p>V.</p>
<h4 id="schlomo_commented_at_2019-02-05_1146"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/issues/2029#issuecomment-460608817">2019-02-05 11:46</a>:<a class="headerlink" href="#schlomo_commented_at_2019-02-05_1146" title="Permanent link">&para;</a></h4>
<p>@ChojinDSL I think that we expect users to also use VMs for initial
testing if they are not sure about their setup. You can also recover a
physical system or other VM in a new VM, ReaR will do the necessary
migration for you.</p>
<h4 id="jsmeix_commented_at_2019-02-05_1150"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2029#issuecomment-460609821">2019-02-05 11:50</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-02-05_1150" title="Permanent link">&para;</a></h4>
<p>@ChojinDSL<br />
in general you may also have a look at<br />
<a href="https://en.opensuse.org/SDB:Disaster_Recovery">https://en.opensuse.org/SDB:Disaster_Recovery</a></p>
<h4 id="gozora_commented_at_2019-02-10_1918"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/2029#issuecomment-462162734">2019-02-10 19:18</a>:<a class="headerlink" href="#gozora_commented_at_2019-02-10_1918" title="Permanent link">&para;</a></h4>
<p>Code in
<a href="https://github.com/rear/rear/pull/2037">https://github.com/rear/rear/pull/2037</a>
will do some basic Borg repository listing and behaves as follows:</p>
<pre><code>RESCUE fedora:~ # rear recover
Relax-and-Recover 2.4 / Git
Running rear recover (PID 1751)
Using log file: /var/log/rear/rear-fedora.log
Running workflow recover within the ReaR rescue/recovery system
Failed to list Borg archive.
If you decide to continue, ReaR will partition your disks, but most probably will NOT be able to restore your data!
Do you want to continue?
1) View 'rear recover' log file (/var/log/rear/rear-fedora.log)
2) Use Relax-and-Recover shell and return back to here
3) Continue 'rear recover'
4) Abort 'rear recover'
(default '4' timeout 300 seconds)
</code></pre>
<p>and logs the reason why <code>borg list</code> failed:</p>
<pre><code>2019-02-10 13:51:37.599616287 Including verify/BORG/default/400_check_archive_access.sh
2019-02-10 13:51:38.833303269 Failed to list Borg archive.
2019-02-10 13:51:38.834574449 If you decide to continue, ReaR will partition your disks, but most probably will NOT be able to restore your data!
2019-02-10 13:51:38.835747610 Command "borg list  ssh://borg@backup:22/mnt/rear/borg/fedora" returned: 
No key file for repository ssh://borg@backup:22/mnt/rear/borg/fedora found in /root/.config/borg/keys.
</code></pre>
<p>I've tested three scenarios (IMHO the most common):</p>
<ol>
<li>Borg server is down</li>
<li>pass phrase is incorrect</li>
<li>keys are missing</li>
</ol>
<p>V.</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2024 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2019-02-01.2029.issue.closed.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/rear/rear-user-guide" class="fa fa-code-fork" style="color: #fcfcfc"> rear/rear-user-guide</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
