<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#3047 PR merged: Skip invalid disk drives (zero sized, no media) when saving layout - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#3047 PR merged: Skip invalid disk drives (zero sized, no media) when saving layout";
        var mkdocs_page_input_path = "issues/2023-09-11.3047.pr.merged.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/backup_netfs.html">Example of BACKUP=NETFS</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear28.html">Release Notes ReaR 2.8</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#3047 PR merged: Skip invalid disk drives (zero sized, no media) when saving layout</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="3047_pr_merged_skip_invalid_disk_drives_zero_sized_no_media_when_saving_layout"><a href="https://github.com/rear/rear/pull/3047">#3047 PR</a> <code>merged</code>: Skip invalid disk drives (zero sized, no media) when saving layout<a class="headerlink" href="#3047_pr_merged_skip_invalid_disk_drives_zero_sized_no_media_when_saving_layout" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>enhancement</code>, <code>cleanup</code>, <code>fixed / solved / done</code></p>
<h4 id="pcahyna_opened_issue_at_2023-09-11_1418"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> opened issue at <a href="https://github.com/rear/rear/pull/3047">2023-09-11 14:18</a>:<a class="headerlink" href="#pcahyna_opened_issue_at_2023-09-11_1418" title="Permanent link">&para;</a></h4>
<h5 id="pull_request_details">Pull Request Details:<a class="headerlink" href="#pull_request_details" title="Permanent link">&para;</a></h5>
<ul>
<li>
<p>Type: <strong>Enhancement</strong></p>
</li>
<li>
<p>Impact: <strong>Normal</strong></p>
</li>
<li>
<p>Reference to related issue (URL): fixes #2958</p>
</li>
<li>
<p>How was this pull request tested?</p>
<ul>
<li>
<p><code>rear savelayout</code> on Fedora 36 with empty USB SD card reader<br />
    I show the relevant log excerpt and the corresponding part of
    <code>disklayout.conf</code>, if any.</p>
<ul>
<li>
<p>original code:
        No partition label type for 'disk /dev/sdb' (may cause 'rear recover' failure)</p>
<pre><code># Disk /dev/sdb
# Format: disk &lt;devname&gt; &lt;size(bytes)&gt; &lt;partition label type&gt;
#disk /dev/sdb 0
</code></pre>
</li>
<li>
<p>new code:
        Ignoring sdb: blockdev: cannot open /dev/sdb: No medium found</p>
<p>No sdb in disklayout
        -   new code without reverting
0a1d634ed15500bb21f37ac1bbb11c8a4bb11545<br />
same result
        -   original code only with
0a1d634ed15500bb21f37ac1bbb11c8a4bb11545 reverted<br />
This reproduces
<a href="https://github.com/rear/rear/issues/2810">https://github.com/rear/rear/issues/2810</a>
    ERROR: Invalid 'disk /dev/sdb' entry (no partition table type for '/dev/sdb')
    Some latest log messages since the last called script 200_partition_layout.sh:
      2023-06-20 19:23:08.249840221 Saving disks and their partitions
    Some messages from /var/tmp/rear.ZC1Unp4TNvGyfNj/tmp/rear.savelayout.stdout_stderr since the last called script 200_partition_layout.sh:
      blockdev: cannot open /dev/sdb: No medium found
      Error: Error opening /dev/sdb: No medium found
    Use debug mode '-d' for some debug messages or debugscript mode '-D' for full debug messages with 'set -x' output
    Aborting due to an error, check /home/pcahyna/rear/rear/var/log/rear/rear-pacaziste.log for details
    Terminated
    -   <code>rear savelayout</code> on Fedora 36 with empty USB SD card reader and
        <code>AUTOEXCLUDE_DISKS=n</code>
        -   original code:
    No partition label type for 'disk /dev/sdb' (may cause 'rear recover' failure)
    /dev/sdb size 0 is not a positive integer
    ERROR: 
    ====================
    BUG in /home/pcahyna/rear/rear/usr/share/rear/layout/save/default/950_verify_disklayout_file.sh line 257:
    'Entries in /home/pcahyna/rear/rear/var/lib/rear/layout/disklayout.conf are broken ('rear recover' would fail)'
    --------------------
    Please report it at https://github.com/rear/rear/issues
    and include all related parts from /home/pcahyna/rear/rear/var/log/rear/rear-pacaziste.log
    preferably the whole debug information via 'rear -D savelayout'
    ====================
    Some latest log messages since the last called script 950_verify_disklayout_file.sh:
      2023-06-20 19:16:28.417175129 Verifying that the entries in /home/pcahyna/rear/rear/var/lib/rear/layout/disklayout.conf are correct
      2023-06-20 19:16:28.424548585 Verifying that the 'disk' entries in /home/pcahyna/rear/rear/var/lib/rear/layout/disklayout.conf are correct
      2023-06-20 19:16:28.436529921 Verifying that the 'part' entries for /dev/sda in /home/pcahyna/rear/rear/var/lib/rear/layout/disklayout.conf are correct
      2023-06-20 19:16:28.446834398 Verifying that the 'part' entries for /dev/sda in /home/pcahyna/rear/rear/var/lib/rear/layout/disklayout.conf specify consecutive partitions
      2023-06-20 19:16:28.458051434 Verifying that the 'part' entries for /dev/sdb in /home/pcahyna/rear/rear/var/lib/rear/layout/disklayout.conf are correct
      2023-06-20 19:16:28.468396791 Verifying that the 'part' entries for /dev/sdb in /home/pcahyna/rear/rear/var/lib/rear/layout/disklayout.conf specify consecutive partitions
      2023-06-20 19:16:28.473731880 Verifying that the 'lvm...' entries in /home/pcahyna/rear/rear/var/lib/rear/layout/disklayout.conf are correct
      2023-06-20 19:16:28.506275876 /dev/sdb size 0 is not a positive integer
    Some messages from /var/tmp/rear.dSRYZZLoczSVake/tmp/rear.savelayout.stdout_stderr since the last called script 950_verify_disklayout_file.sh:
      256060514304
      1073741824
      1048576
      254985371648
      1074790400
      0
    Use debug mode '-d' for some debug messages or debugscript mode '-D' for full debug messages with 'set -x' output
    Aborting due to an error, check /home/pcahyna/rear/rear/var/log/rear/rear-pacaziste.log for details
    Terminated</p>
<pre><code># Disk /dev/sdb
# Format: disk &lt;devname&gt; &lt;size(bytes)&gt; &lt;partition label type&gt;
disk /dev/sdb 0 
# Partitions on /dev/sdb
</code></pre>
<p>This reproduces #2958
        -   new code:
    Ignoring sdb: blockdev: cannot open /dev/sdb: No medium found</p>
<p>No sdb in disklayout
        -   new code without reverting
0a1d634ed15500bb21f37ac1bbb11c8a4bb11545<br />
same result
    -   full backup and recovery on RHEL 8 with empty USB SD card reader
Running 'layout/save' stage ======================
Creating disk layout
Ignoring sde: blockdev: cannot open /dev/sde: No medium found
Automatically excluding disk /dev/sdb (not used by any mounted filesystem)
Marking component '/dev/sdb' as done in /var/lib/rear/layout/disktodo.conf
Automatically excluding disk /dev/sdc (not used by any mounted filesystem)
Marking component '/dev/sdc' as done in /var/lib/rear/layout/disktodo.conf
Automatically excluding disk /dev/sdd (not used by any mounted filesystem)
Marking component '/dev/sdd' as done in /var/lib/rear/layout/disktodo.conf
Disabling excluded components in /var/lib/rear/layout/disklayout.conf
Disabling component 'disk /dev/sdb' in /var/lib/rear/layout/disklayout.conf
Disabling component 'disk /dev/sdc' in /var/lib/rear/layout/disklayout.conf
Disabling component 'disk /dev/sdd' in /var/lib/rear/layout/disklayout.conf</p>
</li>
</ul>
</li>
<li>
<p>full backup and recovery on RHEL 8 with empty USB SD card reader
    and <code>AUTOEXCLUDE_DISKS=n</code>
        Running 'layout/save' stage ======================
        Creating disk layout
        Ignoring sde: blockdev: cannot open /dev/sde: No medium found
        Disabling excluded components in /var/lib/rear/layout/disklayout.conf</p>
</li>
</ul>
</li>
<li>
<p>Brief description of the changes in this pull request:</p>
<ul>
<li>Introduce function is_disk_valid, which performs checks for
    disk usability beyond validating the device name, and use it
    when saving the disk layout. In some cases the device name may
    be valid, but there are no data, typically because it is a drive
    with removable media and there is no medium in the tray. Happens
    typically with card (e.g. SD card) readers with empty slot.<br />
    This is a normal occurrence, so do not Error out, only display a
    message and skip the device.</li>
<li>Revert commit 0a1d634ed15500bb21f37ac1bbb11c8a4bb11545 . We now
    skip disks with no data (like when there is no medium), so
    incomplete disk entries (without partition type) should not
    occur anymore. Restore the code that aborted when such disks
    were encountered.<br />
    Incomplete entries should not be allowed to occur, as they could
    confuse the layout restoration code. Moreover, the layout
    restoration wipes all disks in the layout, so if during layout
    restoration there happens to be a medium in the drive that was
    empty during layout save, the data on the medium would get
    overwritten and lost. And if there is not medium, the layout
    recreation script would fail.<br />
    See the discussion at
    <a href="https://github.com/rear/rear/issues/2958#issuecomment-1479588829">https://github.com/rear/rear/issues/2958#issuecomment-1479588829</a></li>
</ul>
</li>
</ul>
<h4 id="jsmeix_commented_at_2023-09-12_0651"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/3047#issuecomment-1715104224">2023-09-12 06:51</a>:<a class="headerlink" href="#jsmeix_commented_at_2023-09-12_0651" title="Permanent link">&para;</a></h4>
<p>@pcahyna<br />
thank you for this enhancement and<br />
the cleanup of the old clumsy code<br />
and for your explanatory description<br />
of the various cases (in particular<br />
things like the special DASD case)!</p>
<h4 id="pcahyna_commented_at_2023-09-12_1513"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/3047#issuecomment-1715919594">2023-09-12 15:13</a>:<a class="headerlink" href="#pcahyna_commented_at_2023-09-12_1513" title="Permanent link">&para;</a></h4>
<p>@jsmeix I believe I addressed all review comments in last 3 commits.</p>
<h4 id="jsmeix_commented_at_2023-09-13_0556"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/3047#issuecomment-1716993143">2023-09-13 05:56</a>:<a class="headerlink" href="#jsmeix_commented_at_2023-09-13_0556" title="Permanent link">&para;</a></h4>
<p>@pcahyna<br />
thank you for the fine tuning.<br />
All looks perfect to me.<br />
Feel free to merge it as you like.</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2024 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2023-09-11.3047.pr.merged.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/rear/rear-user-guide" class="fa fa-code-fork" style="color: #fcfcfc"> rear/rear-user-guide</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
