<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#2748 PR merged: Include dmsetup and dmeventd unconditionally - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#2748 PR merged: Include dmsetup and dmeventd unconditionally";
        var mkdocs_page_input_path = "issues/2022-01-25.2748.pr.merged.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a> &raquo;</li>
      <li class="breadcrumb-item active">#2748 PR merged: Include dmsetup and dmeventd unconditionally</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="2748_pr_merged_include_dmsetup_and_dmeventd_unconditionally"><a href="https://github.com/rear/rear/pull/2748">#2748 PR</a> <code>merged</code>: Include <code>dmsetup</code> and <code>dmeventd</code> unconditionally<a class="headerlink" href="#2748_pr_merged_include_dmsetup_and_dmeventd_unconditionally" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>bug</code>, <code>cleanup</code>, <code>fixed / solved / done</code></p>
<h4 id="lzaoral_opened_issue_at_2022-01-25_1650"><img src="https://avatars.githubusercontent.com/u/48823770?v=4" width="50"><a href="https://github.com/lzaoral">lzaoral</a> opened issue at <a href="https://github.com/rear/rear/pull/2748">2022-01-25 16:50</a>:<a class="headerlink" href="#lzaoral_opened_issue_at_2022-01-25_1650" title="Permanent link">&para;</a></h4>
<h5 id="pull_request_details">Pull Request Details:<a class="headerlink" href="#pull_request_details" title="Permanent link">&para;</a></h5>
<ul>
<li>
<p>Type: <strong>Bug Fix</strong></p>
</li>
<li>
<p>Impact: <strong>High</strong></p>
</li>
<li>
<p>Reference to related issue (URL): None</p>
</li>
<li>
<p>How was this pull request tested?</p>
</li>
</ul>
<p>Successful recovery of a RHEL 8.5 VM with BIOS without encryption, LVM<br />
or multipath with this patch applied and unsuccessful recovery of the
same<br />
machine without it. RHEL 8.5 has <code>os-prober</code> 1.74 and does not ship<br />
<code>grub-mount</code> binary.</p>
<ul>
<li>Brief description of the changes in this pull request:</li>
</ul>
<p>Changes usr/share/rear/conf/GNU/Linux.conf</p>
<p>Older releases of <code>os-prober</code> (1.74 and below) use <code>dmsetup</code> as a
fallback<br />
solution for mounting when <code>grub-mount</code> is missing.</p>
<p>However, <code>dmsetup</code> was included in the rescue image if and only if
LVM,<br />
multipath or encryption were detected. Thus, BIOS machines that do<br />
not use these but still have <code>dmsetup</code> present, would block
indefinitely<br />
on the "Installing GRUB2 boot loader..." step.</p>
<p>GRUB2 installation is performed in a chroot after the data have
already<br />
been recovered. ReaR would call <code>grub-mkconfig</code> which calls
<code>os-prober</code><br />
which then executes <code>dmsetup</code>. However, it would never receive the
response<br />
trough host's udev as the rescue system would not have <code>dmsetup</code>
present<br />
to send it.</p>
<p>EDIT: reworded the description (thanks @pcahyna for suggestions!)<br />
EDIT2: usr/share/rear/conf/GNU/Linux.conf is now being changed.</p>
<h4 id="pcahyna_commented_at_2022-01-25_1704"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/2748#issuecomment-1021410869">2022-01-25 17:04</a>:<a class="headerlink" href="#pcahyna_commented_at_2022-01-25_1704" title="Permanent link">&para;</a></h4>
<p>Similar problem was reported for another case outside the context of
ReaR where grub2-mkconfig is executed in a chroot with udev running
outside the chroot: the Debian installer. The result is the same: it
hangs forever when executing <code>os-prober</code>. See
<a href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=853927">https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=853927</a>
<a href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=860833">https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=860833</a>
. The root cause of the problem has never been properly understood and
the code in <code>os-prober</code> that executes dmsetup got eventually removed to
fix this problem:
<a href="https://bazaar.launchpad.net/~ubuntu-installer/os-prober/master/revision/419">https://bazaar.launchpad.net/~ubuntu-installer/os-prober/master/revision/419</a>
. Some distributions still have the problematic <code>os-prober</code> though.</p>
<h4 id="pcahyna_commented_at_2022-01-25_1709"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/2748#issuecomment-1021415057">2022-01-25 17:09</a>:<a class="headerlink" href="#pcahyna_commented_at_2022-01-25_1709" title="Permanent link">&para;</a></h4>
<p>In order to show the problem the system must not use any LVM, thus the
previous code did not include <code>dmsetup</code> in the rescue system. Note also
that the old message "Device mapper found enabled. Including LVM tools."
was a bit incorrect: LVM tools got included only if both device-mapper
and LVM were found, finding device-mapper enabled was not enough.</p>
<h4 id="jsmeix_commented_at_2022-01-26_1324"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2748#issuecomment-1022194404">2022-01-26 13:24</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-01-26_1324" title="Permanent link">&para;</a></h4>
<p>In general when programs are useful in any case in the recovery system<br />
shoudn't such programs be better added to PROGS in<br />
the generic usr/share/rear/conf/GNU/Linux.conf ?</p>
<h4 id="jsmeix_commented_at_2022-01-26_1329"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2748#issuecomment-1022198595">2022-01-26 13:29</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-01-26_1329" title="Permanent link">&para;</a></h4>
<p>Only FYI:<br />
The "Device mapper found enabled. Including LVM tools." message
originated from<br />
<a href="https://github.com/rear/rear/commit/777133cb9fb944af2681a82f2ff65cf1ea869e98">https://github.com/rear/rear/commit/777133cb9fb944af2681a82f2ff65cf1ea869e98</a></p>
<h4 id="pcahyna_commented_at_2022-01-31_0921"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/2748#issuecomment-1025531137">2022-01-31 09:21</a>:<a class="headerlink" href="#pcahyna_commented_at_2022-01-31_0921" title="Permanent link">&para;</a></h4>
<blockquote>
<p>In general when programs are useful in any case in the recovery
system<br />
shoudn't such programs be better added to PROGS in<br />
the generic usr/share/rear/conf/GNU/Linux.conf ?</p>
</blockquote>
<p>@jsmeix I agree. This case of <code>dmsetup</code> has nothing to do with LVM,
really, although superficially it may appear related. So it belong to
another location, and <code>usr/share/rear/conf/GNU/Linux.conf</code> is a good
one. (Only a comment could be left here, explaining why <code>dmsetup</code> is not
being added here despite being related to LVM, or perhaps the current
code could be left as it is - I suppose that there is no problem with
adding a tool to <code>PROGS</code> twice?)</p>
<h4 id="lzaoral_commented_at_2022-01-31_1547"><img src="https://avatars.githubusercontent.com/u/48823770?v=4" width="50"><a href="https://github.com/lzaoral">lzaoral</a> commented at <a href="https://github.com/rear/rear/pull/2748#issuecomment-1025922413">2022-01-31 15:47</a>:<a class="headerlink" href="#lzaoral_commented_at_2022-01-31_1547" title="Permanent link">&para;</a></h4>
<p>@jsmeix @pcahyna I've added <code>dmsetup</code> and <code>dmeventd</code> with explanation
for doing so to <code>usr/share/rear/conf/GNU/Linux.conf</code>.</p>
<h4 id="jsmeix_commented_at_2022-02-01_0715"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2748#issuecomment-1026540266">2022-02-01 07:15</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-02-01_0715" title="Permanent link">&para;</a></h4>
<p>There should be no problem adding something to PROGS or REQUIRED_PROGS
several times<br />
because in build/GNU/Linux/390_copy_binaries_libraries.sh<br />
there is a <code>sort -u</code></p>
<pre><code>local all_binaries=( $( for bin in "${PROGS[@]}" "${REQUIRED_PROGS[@]}" ; do
                            ...
                        done 2&gt;&gt;/dev/$DISPENSABLE_OUTPUT_DEV | sort -u ) )
...
copy_binaries "$ROOTFS_DIR/bin" "${all_binaries[@]}"
</code></pre>
<p>and even without <code>sort -u</code> copying something several times should not
cause harm.</p>
<h4 id="jsmeix_commented_at_2022-02-01_0716"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2748#issuecomment-1026540874">2022-02-01 07:16</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-02-01_0716" title="Permanent link">&para;</a></h4>
<p>When there are no objections I would like to merge it today afternoon.</p>
<h4 id="jsmeix_commented_at_2022-02-02_1229"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2748#issuecomment-1027894010">2022-02-02 12:29</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-02-02_1229" title="Permanent link">&para;</a></h4>
<p>I assume the description is OK now<br />
so I would like to merge it today in about one hour<br />
unless there are objections soon.</p>
<h4 id="jsmeix_commented_at_2022-02-02_1354"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2748#issuecomment-1027963360">2022-02-02 13:54</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-02-02_1354" title="Permanent link">&para;</a></h4>
<p>@lzaoral @pcahyna<br />
thank you for your deep analysis of the problem and for your fix!</p>
<p>I think I understand "something" but the main point is that one
understands<br />
"without it things could block indefinitely at 'Installing GRUB2 boot
loader...'"<br />
so better safe than sorry and have sometimes needed things in the
recovery system<br />
because after "rear recover" failed it is a bit late to add missing
stuff to the recovery system ;-)</p>
<h4 id="pcahyna_commented_at_2022-02-02_1402"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/2748#issuecomment-1027970904">2022-02-02 14:02</a>:<a class="headerlink" href="#pcahyna_commented_at_2022-02-02_1402" title="Permanent link">&para;</a></h4>
<blockquote>
<p>so better safe than sorry and have sometimes needed things in the
recovery system<br />
because after "rear recover" failed it is a bit late to add missing
stuff to the recovery system ;-)</p>
</blockquote>
<p>Technically, this is not 100% true. You can copy dmsetup from the
restored chroot to the running rescue ramdisk and restart rear recover,
so this is one of the less disastrous errors that may happen (there are
other ways to add missing stuff to the ramdisk, even a forgotten backup
client can be added). But in this case the problem is really mysterious
and it took us days to even figure out that dmsetup is what one needs
(debian / ubuntu were never able to debug this problem in their
installer and they rather requested removal of the problematic code from
os-prober entirely), so it is very unlikely that one would find out the
workaround.<br />
Also, if you get a heart attack because the recovery of your broken
$CRITICAL_SERVER failed, workarounds won't help you, as you are already
dead :-)</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2023 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2022-01-25.2748.pr.merged.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
