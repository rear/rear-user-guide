<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#2142 PR merged: support for s390 (zLinux) arch - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#2142 PR merged: support for s390 (zLinux) arch";
        var mkdocs_page_input_path = "issues/2019-05-09.2142.pr.merged.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/backup_netfs.html">Example of BACKUP=NETFS</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#2142 PR merged: support for s390 (zLinux) arch</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="2142_pr_merged_support_for_s390_zlinux_arch"><a href="https://github.com/rear/rear/pull/2142">#2142 PR</a> <code>merged</code>: support for s390 (zLinux) arch<a class="headerlink" href="#2142_pr_merged_support_for_s390_zlinux_arch" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>enhancement</code>, <code>fixed / solved / done</code></p>
<h4 id="mutable-dan_opened_issue_at_2019-05-09_1533"><img src="https://avatars.githubusercontent.com/u/50145067?u=0b8898582fe782d29312c1d9a3c689216efdbade&v=4" width="50"><a href="https://github.com/mutable-dan">mutable-dan</a> opened issue at <a href="https://github.com/rear/rear/pull/2142">2019-05-09 15:33</a>:<a class="headerlink" href="#mutable-dan_opened_issue_at_2019-05-09_1533" title="Permanent link">&para;</a></h4>
<h5 id="pull_request_details">Pull Request Details:<a class="headerlink" href="#pull_request_details" title="Permanent link">&para;</a></h5>
<ul>
<li>
<p>Type: <strong>New Feature</strong></p>
</li>
<li>
<p>Impact: <strong>Normal</strong></p>
</li>
<li>
<p>Reference to related issue (URL):
    <a href="https://github.com/rear/rear/issues/2137">https://github.com/rear/rear/issues/2137</a></p>
</li>
<li>
<p>How was this pull request tested?</p>
</li>
</ul>
<!-- -->

<ul>
<li>Testing against s390 rhel 7 - using mkrescue</li>
<li>Not tested against SLEL &gt; 11 but will</li>
</ul>
<!-- -->

<ul>
<li>Details:<br />
    Start of process to add s390 support to rear for RHEL. This pull
    adds some support to identify and verify boot partition and identify
    dependencies. Not tested with sles which boots to zipl and hands off
    to grub</li>
</ul>
<h4 id="mutable-dan_commented_at_2019-05-09_1914"><img src="https://avatars.githubusercontent.com/u/50145067?u=0b8898582fe782d29312c1d9a3c689216efdbade&v=4" width="50"><a href="https://github.com/mutable-dan">mutable-dan</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-491030516">2019-05-09 19:14</a>:<a class="headerlink" href="#mutable-dan_commented_at_2019-05-09_1914" title="Permanent link">&para;</a></h4>
<p>fixed a syntax error in 950_verify_disklayout_file.sh after the
pull<br />
It looks like the fix made it into the pull</p>
<h4 id="jsmeix_commented_at_2019-05-10_0823"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-491204253">2019-05-10 08:23</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-05-10_0823" title="Permanent link">&para;</a></h4>
<p>@mutable-dan<br />
thank you for your early pull request!</p>
<p>I added some comments about what I recognized<br />
from plain looking at the code.</p>
<h4 id="jsmeix_commented_at_2019-05-17_1357"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-493463118">2019-05-17 13:57</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-05-17_1357" title="Permanent link">&para;</a></h4>
<p>@mutable-dan<br />
many thanks for all your work here - it is much appreciated.<br />
As time permits I will try to have a closer look next week.<br />
I am still struggling with getting used to use an IBM Z system<br />
e.g. x3270 terminal emulator, XEDIT, <code>#cp</code>, and things like that<br />
(I feel I drop one clanger after another)...</p>
<h4 id="jsmeix_commented_at_2019-05-21_1453"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-494426331">2019-05-21 14:53</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-05-21_1453" title="Permanent link">&para;</a></h4>
<p>Here more of my changes that I did (as a IBM Z noob)<br />
in my (currently basically blind) attempt to move forward a bit:</p>
<p>Because <code>OUTPUT=ISO</code> does not make sense on IBM Z<br />
I created a new file
usr/share/rear/output/IPL/Linux-s390/800_create_ipl.sh</p>
<pre><code># Create the 'initial program' to boot/load the ReaR recovery system
# on IBM Z via IPL (initial program load)
LogPrint "Creating initial program for IPL on IBM Z"
RESULT_FILES+=( $KERNEL_FILE $TMP_DIR/$REAR_INITRD_FILENAME )
</code></pre>
<p>which is currently basically an almost empty dummy<br />
that only results that kernel and ReaR's initrd get copied<br />
whereto the RESULT_FILES are normally copied.</p>
<p>Now I can use a new tentative output method <code>OUTPUT=IPL</code><br />
(we can rename or change all that as we like).</p>
<p>This way I get the currently used kernel of my running original system<br />
and ReaR's created initrd that contains the ReaR recovery system<br />
copied to my NFS server (I use <code>BACKUP=NETFS</code>).</p>
<p>But I needed also some generic improvements and fixes in<br />
usr/share/rear/output/default/950_copy_result_files.sh<br />
to make things work for me:</p>
<pre><code>--- usr/share/rear/output/default/950_copy_result_files.sh.original     2019-05-20 13:50:22.938205486 +0200
+++ usr/share/rear/output/default/950_copy_result_files.sh      2019-05-21 15:32:50.638205486 +0200
@@ -1,39 +1,40 @@
 #
 # copy resulting files to network output location

+# For example for "rear mkbackuponly" there are usually no result files
+# that would need to be copied here to the network output location:
+test "$RESULT_FILES" || return 0
+
 local scheme=$( url_scheme $OUTPUT_URL )
 local host=$( url_host $OUTPUT_URL )
 local path=$( url_path $OUTPUT_URL )
 local opath=$( output_path $scheme $path )

 # if $opath is empty return silently (e.g. scheme tape)
-if [[ -z "$opath" || -z "$OUTPUT_URL" || "$scheme" == "obdr" || "$scheme" == "tape" ]]; then
+if [[ -z "$opath" || -z "$OUTPUT_URL" || "$scheme" == "obdr" || "$scheme" == "tape" ]] ; then
     return 0
 fi

 LogPrint "Copying resulting files to $scheme location"

 echo "$VERSION_INFO" &gt;"$TMP_DIR/VERSION" || Error "Could not create $TMP_DIR/VERSION file"
-if test -s $(get_template "RESULT_usage_$OUTPUT.txt") ; then
-    cp $v $(get_template "RESULT_usage_$OUTPUT.txt") "$TMP_DIR/README" &gt;&amp;2
-    StopIfError "Could not copy '$(get_template RESULT_usage_$OUTPUT.txt)'"
+RESULT_FILES+=( "$TMP_DIR/VERSION" )
+
+local usage_readme_file=$( get_template "RESULT_usage_$OUTPUT.txt" )
+if test -s $usage_readme_file ; then
+    cp $v $usage_readme_file "$TMP_DIR/README" || Error "Could not copy $usage_readme_file to $TMP_DIR/README"
+    RESULT_FILES+=( "$TMP_DIR/README" )
 fi

 # Usually RUNTIME_LOGFILE=/var/log/rear/rear-$HOSTNAME.log
 # The RUNTIME_LOGFILE name is set by the main script from LOGFILE in default.conf
 # but later user config files are sourced in the main script where LOGFILE can be set different
 # so that the user config LOGFILE basename is used as final logfile name:
-final_logfile_name=$( basename $LOGFILE )
+local final_logfile_name=$( basename $LOGFILE )
 cat "$RUNTIME_LOGFILE" &gt; "$TMP_DIR/$final_logfile_name" || Error "Could not copy $RUNTIME_LOGFILE to $TMP_DIR/$final_logfile_name"
+RESULT_FILES+=( "$TMP_DIR/$final_logfile_name" )
 LogPrint "Saving $RUNTIME_LOGFILE as $final_logfile_name to $scheme location"

-# Add the README, VERSION and the final logfile to the RESULT_FILES array
-RESULT_FILES=( "${RESULT_FILES[@]}" "$TMP_DIR/VERSION" "$TMP_DIR/README" "$TMP_DIR/$final_logfile_name" )
-
-# For example for "rear mkbackuponly" there are usually no result files
-# that would need to be copied here to the network output location:
-test "$RESULT_FILES" || return 0
-
 # The real work (actually copying resulting files to the network output location):
 case "$scheme" in
     (nfs|cifs|usb|file|sshfs|ftpfs|davfs)
</code></pre>
<p>With hat changes and this etc/rear/local.conf</p>
<pre><code>OUTPUT=IPL
BACKUP=NETFS
BACKUP_OPTIONS="nfsvers=3,nolock"
BACKUP_URL=nfs://10.160.67.243/nfs
SSH_ROOT_PASSWORD="rear"
USE_DHCLIENT="yes"
KEEP_BUILD_DIR="yes"
FIRMWARE_FILES=( 'no' )
PROGRESS_MODE="plain"
PROGRESS_WAIT_SECONDS="5"
</code></pre>
<p>"rear -D mkbackup" does this for me</p>
<pre><code># usr/sbin/rear -D mkbackup
Relax-and-Recover 2.4 / Git
Running rear mkbackup (PID 2922)
Using log file: /root/rear.pull2142/var/log/rear/rear-linux-coqs.log
Using backup archive '/tmp/rear.mj7lzA4sKBwh903/outputfs/linux-coqs/backup.tar.gz'
Using autodetected kernel '/boot/image-4.12.14-94.41-default' as kernel in the recovery system
Creating disk layout
Using sysconfig bootloader 'grub2'
Verifying that the entries in /root/rear.pull2142/var/lib/rear/layout/disklayout.conf are correct ...
Creating root filesystem layout
Handling network interface 'eth0'
eth0 is a physical device
Handled network interface 'eth0'
Copying logfile /root/rear.pull2142/var/log/rear/rear-linux-coqs.log into initramfs as '/tmp/rear-linux-coqs-partial-2019-05-21T16:44:13+02:00.log'
Copying files and directories
Copying binaries and libraries
Copying all kernel modules in /lib/modules/4.12.14-94.41-default (MODULES contains 'all_modules')
Omit copying files in /lib*/firmware/ (FIRMWARE_FILES='no')
Skip copying broken symlink '/etc/mtab' target '/proc/11599/mounts' on /proc/ /sys/ /dev/ or /run/
Testing that the recovery system in /tmp/rear.mj7lzA4sKBwh903/rootfs contains a usable system
Creating recovery/rescue system initramfs/initrd initrd.cgz with gzip default compression
Created initrd.cgz with gzip default compression (75587348 bytes) in 13 seconds
Creating initial program for IPL on IBM Z
Copying resulting files to nfs location
Saving /root/rear.pull2142/var/log/rear/rear-linux-coqs.log as rear-linux-coqs.log to nfs location
Copying result files '/boot/image-4.12.14-94.41-default /tmp/rear.mj7lzA4sKBwh903/tmp/initrd.cgz /tmp/rear.mj7lzA4sKBwh903/tmp/VERSION /tmp/rear.mj7lzA4sKBwh903/tmp/rear-linux-coqs.log' to /tmp/rear.mj7lzA4sKBwh903/outputfs/linux-coqs at nfs location
Creating tar archive '/tmp/rear.mj7lzA4sKBwh903/outputfs/linux-coqs/backup.tar.gz'
Preparing archive operation
Archived 50 MiB [avg 7442 KiB/sec] 
...
Archived 990 MiB [avg 4737 KiB/sec] 
OK
Archived 990 MiB in 219 seconds [avg 4629 KiB/sec]
Exiting rear mkbackup (PID 2922) and its descendant processes ...
Running exit tasks
You should also rm -Rf /tmp/rear.mj7lzA4sKBwh903
</code></pre>
<p>and it results those files on my NFS server</p>
<pre><code># ls -lhtr /nfs/linux-coqs
total 1.1G
-rw-rw-rw- 1 nobody nobody   13M May 21 16:44 image-4.12.14-94.41-default
-rw-rw-rw- 1 nobody nobody   73M May 21 16:44 initrd.cgz
-rw-rw-rw- 1 nobody nobody   267 May 21 16:44 VERSION
-rw-rw-rw- 1 nobody nobody  2.7M May 21 16:44 rear-linux-coqs.log
-rw-rw-rw- 1 nobody nobody 1013M May 21 16:48 backup.tar.gz
-rw-rw-rw- 1 nobody nobody  9.6M May 21 16:48 backup.log
</code></pre>
<p>So now I got kernel, ReaR recovery system initrd and the backup<br />
out of the original system and safe on my NFS server.</p>
<p>My next step is now to learn how I could "boot" (i.e. <code>IPL</code>)<br />
a IBM Z system with that kernel and ReaR's initrd<br />
or to learn that I need to do things totally differently...</p>
<h4 id="mutable-dan_commented_at_2019-05-21_1928"><img src="https://avatars.githubusercontent.com/u/50145067?u=0b8898582fe782d29312c1d9a3c689216efdbade&v=4" width="50"><a href="https://github.com/mutable-dan">mutable-dan</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-494525698">2019-05-21 19:28</a>:<a class="headerlink" href="#mutable-dan_commented_at_2019-05-21_1928" title="Permanent link">&para;</a></h4>
<blockquote>
<p>Here more of my changes that I did (as a IBM Z noob)<br />
in my (currently basically blind) attempt to move forward a bit:</p>
</blockquote>
<p>thx, will merge your changes. on rhel, there are errors in the
networking.... which I am looking at</p>
<p>i will make the changes regarding partition info (above) and push the
changes. Then continue with the networking problems. There is code for
copying kernel modules (for network (and dasd) drivers for s390) which I
am not following 100%. I made some very small changes to add directories
with modules.</p>
<h4 id="jsmeix_commented_at_2019-05-22_0658"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-494677718">2019-05-22 06:58</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-05-22_0658" title="Permanent link">&para;</a></h4>
<p>@mutable-dan<br />
in general regarding "copying kernel modules" i.e. what kernel modules<br />
will be copied into the ReaR recovery system:</p>
<p>Since the curent ReaR 2.5 release by default all kernel modules<br />
will be copied into the ReaR recovery system, see in the<br />
"Release Notes for Relax-and-Recover version 2.5" at<br />
<a href="http://relax-and-recover.org/documentation/release-notes-2-5">http://relax-and-recover.org/documentation/release-notes-2-5</a><br />
the part about</p>
<pre><code>Version 2.5 (May 2019)

Abstract

New features, bigger enhancements, and possibly backward incompatible changes:

...

Now there is in default.conf MODULES=( 'all_modules' )
which means that now by default all kernel modules
get included in the recovery system (issue #2041).
Usually this is required when ...
Additionaly it makes the recovery system better prepared
when ... (issue #1870) ... (issue #1202) ...
Furthermore this is helpful to be on the safe side ... (issue #1355) ...
</code></pre>
<p>and see the issues mentioned therein for background information.</p>
<p>Therefore since ReaR 2.5 you should not need to worry about<br />
possibly missing kernel modules in the recovery system.<br />
If on IBM Z architecture some kernel modules are missing<br />
in the recovery system it would be a bug in the current<br />
usr/share/rear/build/GNU/Linux/400_copy_modules.sh<br />
<a href="https://raw.githubusercontent.com/rear/rear/master/usr/share/rear/build/GNU/Linux/400_copy_modules.sh">https://raw.githubusercontent.com/rear/rear/master/usr/share/rear/build/GNU/Linux/400_copy_modules.sh</a><br />
that would have to be fixed.</p>
<h4 id="jsmeix_commented_at_2019-05-22_1007"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-494739752">2019-05-22 10:07</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-05-22_1007" title="Permanent link">&para;</a></h4>
<p>Here some more of my further steps to move forward a bit:</p>
<p>I use two same IBM Z test systems each on z/VM 5.4.</p>
<p>On the first one (my "original system") with hostname s390vsl179<br />
I did "rear mkbackup" as described in my above<br />
<a href="https://github.com/rear/rear/pull/2142#issuecomment-494426331">https://github.com/rear/rear/pull/2142#issuecomment-494426331</a></p>
<p>On the second one (my "replacement hardware") with hostname s390vsl180<br />
I try to do the "rear recover".</p>
<p>I learned that to <code>ipl</code> my kernel and ReaR's initrd that I saved on my
NFS server<br />
on an empty IBM Z system is an advanced task that I postpone to learn
later.</p>
<p>What I did as an easier way how to "boot" my kernel and ReaR's initrd<br />
on an IBM Z system is to "boot" that via <code>kexec</code> from within a<br />
normally running IBM Z system that runs SLES12-SP4.</p>
<p>I.e. on my second IBM Z system with hostname s390vsl180<br />
I have SLES12-SP4 normally running and there I copied<br />
my kernel and ReaR's initrd from my NFS server<br />
so that I have both locally as those files</p>
<pre><code>/root/s390vsl179/initrd.cgz
/root/s390vsl179/image-4.12.14-94.41-default
</code></pre>
<p>Then I did</p>
<pre><code># sync

# kexec -l /root/s390vsl179/image-4.12.14-94.41-default --initrd=/root/s390vsl179/initrd.cgz --command-line=root=/dev/ram0 rw vga=normal hvc_iucv=8 TERM=dumb

# kexec -e
</code></pre>
<p>The <code>kexec -e</code> does an immediate hard boot of the new kernel<br />
and initrd which is why I did <code>sync</code> before to be on the safe side<br />
so that I could still reboot the system from the disk if <code>kexec -e</code>
fails<br />
but for me <code>kexec -e</code> just worked (that was really unexpected).</p>
<p>I got the <code>--command-line</code> paremeters for the <code>kexec -l</code> from<br />
a combination of what /proc/cmdline shows on my original<br />
system s390vsl179 wherefrom I took</p>
<pre><code>hvc_iucv=8 TERM=dumb
</code></pre>
<p>plus what /proc/cmdline shows from another booted<br />
ReaR recovery system on x86 hardware wherefrom I took</p>
<pre><code>root=/dev/ram0 rw vga=normal
</code></pre>
<p>but I did something wrong with the <code>kexec -l</code> call<br />
(probably I forgot proper quoting of the command-line paremeters)<br />
because in the via <code>kexec -e</code> booted ReaR recovery system I get</p>
<pre><code>RESCUE s390vsl179:~ # cat /proc/cmdline 
root=/dev/ram0
</code></pre>
<p>After the <code>kexec -e</code> I used the x3270 terminal to log in<br />
at that new booted system to find out what its IP address is.<br />
For me it is fortunately still the same as before so that I could<br />
log in via <code>ssh</code> to the running ReaR recovery system on s390vsl179<br />
because I use in my etc/rear/local.conf</p>
<pre><code>SSH_ROOT_PASSWORD="rear"
USE_DHCLIENT="yes"
</code></pre>
<p>cf.
<a href="https://github.com/rear/rear/pull/2142#issuecomment-494426331">https://github.com/rear/rear/pull/2142#issuecomment-494426331</a><br />
The DHCP server that I happen to use in my particular environment<br />
does fortunately "the right thing" for me (otherwise I would have had<br />
to do some manual networking setup from within the x3270 terminal).</p>
<p>In the ReaR recovery system I called "rear -D recover"</p>
<pre><code>RESCUE s390vsl179:~ # rear -D recover
Relax-and-Recover 2.4 / Git
Running rear recover (PID 1021)
Using log file: /var/log/rear/rear-s390vsl179.log
Running workflow recover within the ReaR rescue/recovery system
Starting required daemons for NFS: RPC portmapper (portmap or rpcbind) and rpc.statd if available.
Started RPC portmapper 'rpcbind'.
RPC portmapper 'rpcbind' available.
Started rpc.statd.
RPC status rpc.statd available.
Using backup archive '/tmp/rear.7zf40H5a5ZjPj1S/outputfs/s390vsl179/backup.tar.gz'
Calculating backup archive size
Backup archive size is 672M     /tmp/rear.7zf40H5a5ZjPj1S/outputfs/s390vsl179/backup.tar.gz (compressed)
Comparing disks
Device dasda has expected (same) size 7385333760 (will be used for recovery)
Disk configuration looks identical
UserInput -I DISK_LAYOUT_PROCEED_RECOVERY needed in /usr/share/rear/layout/prepare/default/250_compare_disks.sh line 148
Proceed with recovery (yes) otherwise manual disk layout configuration is enforced
(default 'yes' timeout 30 seconds)

UserInput: No real user input (empty or only spaces) - using default input
UserInput: No choices - result is 'yes'
User confirmed to proceed with recovery
Partition rear-noname on /dev/dasda: size reduced to fit on disk.
Start system layout restoration.
Creating partitions for disk /dev/dasda (dasd)
UserInput -I LAYOUT_CODE_RUN needed in /usr/share/rear/layout/recreate/default/200_run_layout_code.sh line 127
The disk layout recreation script failed
1) Rerun disk recreation script (/var/lib/rear/layout/diskrestore.sh)
2) View 'rear recover' log file (/var/log/rear/rear-s390vsl179.log)
3) Edit disk recreation script (/var/lib/rear/layout/diskrestore.sh)
4) View original disk space usage (/var/lib/rear/layout/config/df.txt)
5) Use Relax-and-Recover shell and return back to here
6) Abort 'rear recover'
(default '1' timeout 300 seconds)
6
UserInput: Valid choice number result 'Abort 'rear recover''
ERROR: User chose to abort 'rear recover' in /usr/share/rear/layout/recreate/default/200_run_layout_code.sh
Some latest log messages since the last called script 200_run_layout_code.sh:
  2019-05-22 11:32:22.413374182 4) View original disk space usage (/var/lib/rear/layout/config/df.txt)
  2019-05-22 11:32:22.414657490 5) Use Relax-and-Recover shell and return back to here
  2019-05-22 11:32:22.415920179 6) Abort 'rear recover'
  2019-05-22 11:32:22.417189991 (default '1' timeout 300 seconds)
  2019-05-22 11:32:37.982610365 UserInput: 'read' got as user input '6'
  2019-05-22 11:32:37.985135427 UserInput: Valid choice number result 'Abort 'rear recover''
  2019-05-22 11:32:37.986851756 Error detected during restore.
  2019-05-22 11:32:37.987994430 Restoring saved original /var/lib/rear/layout/disklayout.conf
Aborting due to an error, check /var/log/rear/rear-s390vsl179.log for details
Exiting rear recover (PID 1021) and its descendant processes ...
Running exit tasks
You should also rm -Rf /tmp/rear.7zf40H5a5ZjPj1S
Terminated
</code></pre>
<p>so ReaR works in general but as expected for this very first attempt<br />
"rear recover" fails.</p>
<p>My next step is now to analyze the "rear recover" debug log<br />
to find out what went wrong...</p>
<h4 id="jsmeix_commented_at_2019-05-22_1016"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-494742554">2019-05-22 10:16</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-05-22_1016" title="Permanent link">&para;</a></h4>
<p>Except from the "rear recover" debug log<br />
(i.e. what the diskrestore.sh script does)<br />
that shows why it failed</p>
<pre><code>++ source /var/lib/rear/layout/diskrestore.sh
+++ LogPrint 'Start system layout restoration.'
+++ Log 'Start system layout restoration.'
+++ echo '2019-05-22 11:32:22.177658372 Start system layout restoration.'
2019-05-22 11:32:22.177658372 Start system layout restoration.
+++ Print 'Start system layout restoration.'
+++ mkdir -p /mnt/local
+++ create_component vgchange rear
+++ local device=vgchange
+++ local type=rear
+++ local touchfile=rear-vgchange
+++ '[' -e /tmp/rear.7zf40H5a5ZjPj1S/tmp/touch/rear-vgchange ']'
+++ return 0
+++ lvm vgchange -a n
+++ component_created vgchange rear
+++ local device=vgchange
+++ local type=rear
+++ local touchfile=rear-vgchange
+++ touch /tmp/rear.7zf40H5a5ZjPj1S/tmp/touch/rear-vgchange
+++ set -e
+++ set -x
+++ create_component /dev/dasda disk
+++ local device=/dev/dasda
+++ local type=disk
+++ local touchfile=disk--dev-dasda
+++ '[' -e /tmp/rear.7zf40H5a5ZjPj1S/tmp/touch/disk--dev-dasda ']'
+++ return 0
+++ Log 'Stop mdadm'
+++ echo '2019-05-22 11:32:22.262948865 Stop mdadm'
2019-05-22 11:32:22.262948865 Stop mdadm
+++ grep -q md /proc/mdstat
+++ Log 'Erasing MBR of disk /dev/dasda'
+++ echo '2019-05-22 11:32:22.264773053 Erasing MBR of disk /dev/dasda'
2019-05-22 11:32:22.264773053 Erasing MBR of disk /dev/dasda
+++ dd if=/dev/zero of=/dev/dasda bs=512 count=1
1+0 records in
1+0 records out
512 bytes copied, 2.8952e-05 s, 17.7 MB/s
+++ sync
+++ LogPrint 'Creating partitions for disk /dev/dasda (dasd)'
+++ Log 'Creating partitions for disk /dev/dasda (dasd)'
+++ echo '2019-05-22 11:32:22.267478178 Creating partitions for disk /dev/dasda (dasd)'
2019-05-22 11:32:22.267478178 Creating partitions for disk /dev/dasda (dasd)
+++ Print 'Creating partitions for disk /dev/dasda (dasd)'
+++ my_udevsettle
+++ has_binary udevadm
+++ for bin in '$@'
+++ type udevadm
+++ return 0
+++ udevadm settle
+++ return 0
+++ parted -s /dev/dasda mklabel dasd
+++ my_udevsettle
+++ has_binary udevadm
+++ for bin in '$@'
+++ type udevadm
+++ return 0
+++ udevadm settle
+++ return 0
+++ my_udevsettle
+++ has_binary udevadm
+++ for bin in '$@'
+++ type udevadm
+++ return 0
+++ udevadm settle
+++ return 0
+++ parted -s /dev/dasda mkpart ''\''dasda1'\''' 98304B 314621951B
parted: invalid token: dasda1
Error: Expecting a file system type.
</code></pre>
<p>Those are the <code>parted</code> calls in diskrestore.sh</p>
<pre><code>RESCUE s390vsl179:~ # grep ^parted /root/rear.pull2142/var/lib/rear/layout/diskrestore.sh

parted -s /dev/dasda mklabel dasd &gt;&amp;2
parted -s /dev/dasda mkpart "'dasda1'" 98304B 314621951B &gt;&amp;2
parted -s /dev/dasda mkpart "'dasda2'" 314621952B 838926335B &gt;&amp;2
parted -s /dev/dasda mkpart "'dasda3'" 838926336B 7385198591B &gt;&amp;2
</code></pre>
<p>I will now do manual <code>parted</code> commands in the<br />
ReaR recovery system to learn how to correctly<br />
do that for IBM Z architecture...</p>
<h4 id="jsmeix_commented_at_2019-05-22_1355"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-494813151">2019-05-22 13:55</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-05-22_1355" title="Permanent link">&para;</a></h4>
<p>Here the parted commands that were run by YaST<br />
when installing the original system:</p>
<pre><code># grep ' SystemCmd Executing: ' /var/log/YaST2/y2log-1 | grep -o 'parted .*' | egrep -v ' print | rm '

parted -s --wipesignatures --align=optimal '/dev/dasda' unit cyl mkpart ext2 1 3414"
parted -s --wipesignatures --align=optimal '/dev/dasda' unit cyl mkpart ext2 3414 9103"
parted -s --wipesignatures --align=optimal '/dev/dasda' unit cyl mkpart ext2 9103 80135"
</code></pre>
<p>and how the disk looks on the original system:</p>
<pre><code># parted -s /dev/dasda unit cyl print unit MiB print unit B print

Model: IBM S390 DASD drive (dasd)
Disk /dev/dasda: 80135cyl
Sector size (logical/physical): 512B/4096B
BIOS cylinder,head,sector geometry: 80136,15,12.  Each cylinder is 92.2kB.
Partition Table: dasd
Disk Flags:

Number  Start    End       Size      File system     Flags
 1      1cyl     3413cyl   3412cyl   ext2
 2      3413cyl  9102cyl   5689cyl   linux-swap(v1)
 3      9102cyl  80135cyl  71033cyl  ext4

Model: IBM S390 DASD drive (dasd)
Disk /dev/dasda: 7043MiB
Sector size (logical/physical): 512B/4096B
Partition Table: dasd
Disk Flags:

Number  Start    End      Size     File system     Flags
 1      0.09MiB  300MiB   300MiB   ext2
 2      300MiB   800MiB   500MiB   linux-swap(v1)
 3      800MiB   7043MiB  6243MiB  ext4

Model: IBM S390 DASD drive (dasd)
Disk /dev/dasda: 7385333760B
Sector size (logical/physical): 512B/4096B
Partition Table: dasd
Disk Flags:

Number  Start       End          Size         File system     Flags
 1      98304B      314621951B   314523648B   ext2
 2      314621952B  838926335B   524304384B   linux-swap(v1)
 3      838926336B  7385333759B  6546407424B  ext4
</code></pre>
<h4 id="jsmeix_commented_at_2019-05-22_1419"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-494823543">2019-05-22 14:19</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-05-22_1419" title="Permanent link">&para;</a></h4>
<p>The following parted commands work for me in the recovery system</p>
<pre><code>RESCUE s390vsl179:~# parted -s /dev/dasda mklabel dasd

RESCUE s390vsl179:~# parted -s /dev/dasda mkpart ext2 98304B 314621951B

RESCUE s390vsl179:~# parted -s /dev/dasda mkpart linux-swap 314621952B 838926335B

RESCUE s390vsl179:~# parted -s /dev/dasda mkpart ext4 838926336B 7385333759B

RESCUE s390vsl179:~ # parted -s /dev/dasda unit B print
Model: IBM S390 DASD drive (dasd)
Disk /dev/dasda: 7385333760B
Sector size (logical/physical): 512B/4096B
Partition Table: dasd
Disk Flags:

Number  Start       End          Size         File system  Flags
 1      98304B      314621951B   314523648B   ext2
 2      314621952B  838926335B   524304384B
 3      838926336B  7385333759B  6546407424B

RESCUE s390vsl179:~ # wipefs --all --force /dev/dasda3 || wipefs --all /dev/dasda3 || dd if=/dev/zero of=/dev/dasda3 bs=512 count=1 || true

RESCUE s390vsl179:~ # mkfs -t ext4 -b 4096 -i 16372 -U 6e3eac1a-6b90-450a-87b4-1d4336c43282 -F /dev/dasda3
mke2fs 1.43.8 (1-Jan-2018)
Creating filesystem with 1598244 4k blocks and 400624 inodes
Filesystem UUID: 6e3eac1a-6b90-450a-87b4-1d4336c43282
Superblock backups stored on blocks: 
        32768, 98304, 163840, 229376, 294912, 819200, 884736

Allocating group tables: done                            
Writing inode tables: done                            
Creating journal (16384 blocks): done
Writing superblocks and filesystem accounting information: done

RESCUE s390vsl179:~ # tune2fs  -m 4 -c -1 -i 0d -o user_xattr,acl /dev/dasda3
tune2fs 1.43.8 (1-Jan-2018)
Setting maximal mount count to -1
Setting interval between checks to 0 seconds
Setting reserved blocks percentage to 4% (63929 blocks)

RESCUE s390vsl179:~ # mkdir -p /mnt/local/

RESCUE s390vsl179:~ # mount -o rw,relatime,data=ordered /dev/dasda3 /mnt/local/

RESCUE s390vsl179:~ # wipefs --all --force /dev/dasda1 || wipefs --all /dev/dasda1 || dd if=/dev/zero of=/dev/dasda1 bs=512 count=1 || true
/dev/dasda1: 2 bytes were erased at offset 0x00000438 (ext2): 53 ef

RESCUE s390vsl179:~ # mkfs -t ext2 -b 4096 -i 4095 -U 5b24febc-c69f-4555-9ec0-d15ce8d51b79 -F /dev/dasda1
mke2fs 1.43.8 (1-Jan-2018)
Creating filesystem with 76788 4k blocks and 76896 inodes
Filesystem UUID: 5b24febc-c69f-4555-9ec0-d15ce8d51b79
Superblock backups stored on blocks: 
        32768

Allocating group tables: done                            
Writing inode tables: done                            
Writing superblocks and filesystem accounting information: done

RESCUE s390vsl179:~ # tune2fs  -m 4 -c -1 -i 0d -o user_xattr,acl /dev/dasda1
tune2fs 1.43.8 (1-Jan-2018)
Setting maximal mount count to -1
Setting interval between checks to 0 seconds
Setting reserved blocks percentage to 4% (3071 blocks)

RESCUE s390vsl179:~ # mkdir -p /mnt/local/boot/zipl

RESCUE s390vsl179:~ # mount -o rw,relatime,block_validity,barrier,user_xattr,acl /dev/dasda1 /mnt/local/boot/zipl

RESCUE s390vsl179:~ # mkswap -U 8093294b-52ef-4e9f-999e-f1cbaa49a2b9 /dev/dasda2
Setting up swapspace version 1, size = 500 MiB (524300288 bytes)
no label, UUID=8093294b-52ef-4e9f-999e-f1cbaa49a2b9

# mount | grep dasd
/dev/dasda3 on /mnt/local type ext4 (rw,relatime,data=ordered)
/dev/dasda1 on /mnt/local/boot/zipl type ext2 (rw,relatime,block_validity,barrier,user_xattr,acl)

RESCUE s390vsl179:~ # rear -D restoreonly
Relax-and-Recover 2.4 / Git
Running rear restoreonly (PID 7859)
Using log file: /var/log/rear/rear-s390vsl179.7859.log
Running workflow restoreonly within the ReaR rescue/recovery system
Starting required daemons for NFS: RPC portmapper (portmap or rpcbind) and rpc.statd if available.
Started RPC portmapper 'rpcbind'.
RPC portmapper 'rpcbind' available.
RPC status rpc.statd available.
Using backup archive '/tmp/rear.JQtYoJkM2KD4JnQ/outputfs/s390vsl179/backup.tar.gz'
Calculating backup archive size
Backup archive size is 672M     /tmp/rear.JQtYoJkM2KD4JnQ/outputfs/s390vsl179/backup.tar.gz (compressed)
Restoring from '/tmp/rear.JQtYoJkM2KD4JnQ/outputfs/s390vsl179/backup.tar.gz' (restore log in /var/lib/rear/restore/restoreonly.backup.tar.gz.7859.restore.log) ...
Backup restore program 'tar' started in subshell (PID=8568)
Restored 300 MiB [avg. 61472 KiB/sec] 
Restored 442 MiB [avg. 45309 KiB/sec] 
Restored 585 MiB [avg. 40000 KiB/sec] 
Restored 719 MiB [avg. 36850 KiB/sec] 
Restored 857 MiB [avg. 35138 KiB/sec] 
Restored 989 MiB [avg. 33790 KiB/sec] 
Restored 1204 MiB [avg. 35250 KiB/sec] 
Restored 1566 MiB [avg. 40102 KiB/sec] 
OK
Restored 1608 MiB in 45 seconds [avg. 36592 KiB/sec]
Restoring finished (verify backup restore log messages in /var/lib/rear/restore/restoreonly.backup.tar.gz.7859.restore.log)
Recreating directories (with permissions) from /var/lib/rear/recovery/directories_permissions_owner_group
Finished recovering your system. You can explore it under '/mnt/local'.
Saving /var/log/rear/rear-s390vsl179.7859.log as /var/log/rear/rear-s390vsl179.log
Exiting rear restoreonly (PID 7859) and its descendant processes ...
Running exit tasks
You should also rm -Rf /tmp/rear.JQtYoJkM2KD4JnQ

RESCUE s390vsl179:~ # du -hs /mnt/local/*
5.1M    /mnt/local/bin
85M     /mnt/local/boot
4.0K    /mnt/local/dev
13M     /mnt/local/etc
48K     /mnt/local/home
49M     /mnt/local/lib
17M     /mnt/local/lib64
16K     /mnt/local/lost+found
4.0K    /mnt/local/mnt
4.0K    /mnt/local/opt
4.0K    /mnt/local/proc
37M     /mnt/local/root
4.0K    /mnt/local/run
14M     /mnt/local/sbin
4.0K    /mnt/local/selinux
20K     /mnt/local/srv
4.0K    /mnt/local/sys
4.0K    /mnt/local/tmp
1.4G    /mnt/local/usr
63M     /mnt/local/var
</code></pre>
<p>The <code>du -hs /mnt/local/*</code> output in the recovery system is basically<br />
identical to the <code>du -hs /*</code> output on the original system so that<br />
so fat things look good.</p>
<p>Next step is to find out how to manually install the bootloader<br />
from within the recovery system...</p>
<h4 id="jsmeix_commented_at_2019-05-22_1456"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-494839383">2019-05-22 14:56</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-05-22_1456" title="Permanent link">&para;</a></h4>
<p>On SLES12-SP4 manually installing the bootloader<br />
from within the recovery system is just</p>
<pre><code>RESCUE s390vsl179:~ # mount --bind /proc /mnt/local/proc

RESCUE s390vsl179:~ # mount --bind /sys /mnt/local/sys

RESCUE s390vsl179:~ # mount --bind /dev /mnt/local/dev

RESCUE s390vsl179:~ # chroot /mnt/local

s390vsl179:/ # update-bootloader --reinit

s390vsl179:/ # exit
exit

RESCUE s390vsl179:~ # reboot
umounting all filesystems
/mnt/local/dev           : successfully unmounted
/mnt/local/sys           : ignored
/mnt/local/proc          : ignored
/mnt/local/boot/zipl     : successfully unmounted
/mnt/local               : successfully unmounted
/dev/pts                 : ignored
/sys/fs/cgroup/cpuset    : successfully unmounted
/sys/fs/cgroup/memory    : successfully unmounted
/sys/fs/cgroup/rdma      : successfully unmounted
/sys/fs/cgroup/devices   : successfully unmounted
/sys/fs/cgroup/perf_event: successfully unmounted
/sys/fs/cgroup/pids      : successfully unmounted
/sys/fs/cgroup/freezer   : successfully unmounted
/sys/fs/cgroup/hugetlb   : successfully unmounted
/sys/fs/cgroup/cpu,cpuacct: successfully unmounted
/sys/fs/cgroup/blkio     : successfully unmounted
/sys/fs/cgroup/net_cls,net_prio: successfully unmounted
/sys/fs/pstore           : successfully unmounted
umount: /sys/fs/cgroup/systemd: not mounted
/sys/fs/cgroup           : successfully unmounted
umount: /run: target is busy
        (In some cases useful info about processes that
         use the device is found by lsof(8) or fuser(1).)
/dev/pts                 : ignored
/dev/shm                 : successfully unmounted
/sys/kernel/security     : successfully unmounted
/dev                     : successfully unmounted
/proc                    : ignored
/sys                     : ignored
umount: /: not mounted
syncing disks... waiting 3 seconds before reboot
</code></pre>
<p>and the recreated system boots and works.</p>
<h4 id="jsmeix_commented_at_2019-05-22_1459"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-494840866">2019-05-22 14:59</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-05-22_1459" title="Permanent link">&para;</a></h4>
<p>In
<a href="https://github.com/rear/rear/pull/2142#issuecomment-494823543">https://github.com/rear/rear/pull/2142#issuecomment-494823543</a><br />
the <code>mkfs</code> related commands are just copies from what I already have<br />
in my diskrestore.sh script in the running ReaR recovery system.</p>
<p>So all what needs to be adapted for now to make "rear recover"<br />
work in this particular IBM Z case is the <code>parted</code> commands<br />
in the diskrestore.sh script and how to install the bootloader.</p>
<h4 id="mutable-dan_commented_at_2019-05-22_1629"><img src="https://avatars.githubusercontent.com/u/50145067?u=0b8898582fe782d29312c1d9a3c689216efdbade&v=4" width="50"><a href="https://github.com/mutable-dan">mutable-dan</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-494877158">2019-05-22 16:29</a>:<a class="headerlink" href="#mutable-dan_commented_at_2019-05-22_1629" title="Permanent link">&para;</a></h4>
<blockquote>
<p>in general regarding "copying kernel modules" i.e. what kernel
modules<br />
will be copied into the ReaR recovery system:</p>
</blockquote>
<p>@jsmeix this is the area in question, I have not checked it into my fork
yet because I wanted to debug it first. Looking at the code for creating
the rescue, did not seem to copy all modules</p>
<p>Here are changes:</p>
<p><code>git diff rescue/GNU/Linux/230_storage_and_network_modules.sh</code></p>
<pre><code>diff --git a/usr/share/rear/rescue/GNU/Linux/230_storage_and_network_modules.sh b/usr/share/rear/rescue/GNU/Linux/230_storage_and_network_modules.sh
index 365ef5b3..2fa6d6fe 100644
--- a/usr/share/rear/rescue/GNU/Linux/230_storage_and_network_modules.sh
+++ b/usr/share/rear/rescue/GNU/Linux/230_storage_and_network_modules.sh
@@ -14,15 +14,15 @@ function find_modules_in_dirs () {

 # Include storage drivers
 Log "Including storage drivers"
-STORAGE_DRIVERS=( $( find_modules_in_dirs /lib/modules/$KERNEL_VERSION/kernel/drivers/{block,firewire,ide,ata,md,message,scsi,usb/storage} ) )
+STORAGE_DRIVERS=( $( find_modules_in_dirs /lib/modules/$KERNEL_VERSION/kernel/drivers/{block,firewire,ide,ata,md,message,scsi,usb/storage,s390/block,s390/scsi} ) )

 # Include network drivers
 Log "Including network drivers"
-NETWORK_DRIVERS=( $( find_modules_in_dirs /lib/modules/$KERNEL_VERSION/kernel/drivers/net ) )
+NETWORK_DRIVERS=( $( find_modules_in_dirs /lib/modules/$KERNEL_VERSION/kernel/drivers/{net,s390/net} ) )

 # Include crypto drivers
 Log "Including crypto drivers"
-CRYPTO_DRIVERS=( $( find_modules_in_dirs /lib/modules/$KERNEL_VERSION/kernel/crypto ) )
+CRYPTO_DRIVERS=( $( find_modules_in_dirs /lib/modules/$KERNEL_VERSION/kernel/{crypto,s390/crypto} ) )
</code></pre>
<p>Here is a dir listing for example:</p>
<pre><code>ls -l /lib/modules/3.10.0-957.10.1.el7.s390x/kernel/drivers/s390/
total 4
drwxr-xr-x 2 root root  143 Apr  4 13:27 block
drwxr-xr-x 2 root root 4096 Apr  4 13:27 char
drwxr-xr-x 2 root root   74 Apr  4 13:27 cio
drwxr-xr-x 2 root root  114 Apr  4 13:27 crypto
drwxr-xr-x 2 root root  134 Apr  4 13:27 net
drwxr-xr-x 2 root root   20 Apr  4 13:27 scsi

ls -l /lib/modules/3.10.0-957.10.1.el7.s390x/kernel/drivers/s390/block/
total 804
-rw-r--r-- 1 root root  55985 Feb  7 02:38 dasd_diag_mod.ko
-rw-r--r-- 1 root root 235513 Feb  7 02:38 dasd_eckd_mod.ko
-rw-r--r-- 1 root root  58097 Feb  7 02:38 dasd_fba_mod.ko
-rw-r--r-- 1 root root 271673 Feb  7 02:38 dasd_mod.ko
-rw-r--r-- 1 root root  66297 Feb  7 02:38 dcssblk.ko
-rw-r--r-- 1 root root  71449 Feb  7 02:38 scm_block.ko
-rw-r--r-- 1 root root  48249 Feb  7 02:38 xpram.ko

ls -l /lib/modules/3.10.0-957.10.1.el7.s390x/kernel/drivers/s390/net/
total 1188
-rw-r--r-- 1 root root 244969 Feb  7 02:38 ctcm.ko
-rw-r--r-- 1 root root  34833 Feb  7 02:38 fsm.ko
-rw-r--r-- 1 root root 150873 Feb  7 02:38 lcs.ko
-rw-r--r-- 1 root root 317497 Feb  7 02:38 qeth.ko
-rw-r--r-- 1 root root 154057 Feb  7 02:38 qeth_l2.ko
-rw-r--r-- 1 root root 220377 Feb  7 02:38 qeth_l3.ko
-rw-r--r-- 1 root root  38201 Feb  7 02:38 smsgiucv_app.ko
-rw-r--r-- 1 root root  42321 Feb  7 02:38 smsgiucv.ko
</code></pre>
<p>Here is the log before this change:</p>
<pre><code>   4822 + source **/usr/share/rear/rescue/GNU/Linux/230_storage_and_network_modules.sh**
   4823 ++ Log 'Including storage drivers'
   4824 ++ echo '2019-05-10 15:06:37.460544032 Including storage drivers'
   4825 2019-05-10 15:06:37.460544032 Including storage drivers
   4826 ++ STORAGE_DRIVERS=($( find_modules_in_dirs /lib/modules/$KERNEL_VERSION/kernel/drivers/{block,firewire,ide,ata,md,message,scsi,usb/storage} ))
   4827 +++ find_modules_in_dirs /lib/modules/3.10.0-957.10.1.el7.s390x/kernel/drivers/block /lib/modules/3.10.0-957.10.1.el7.s390x/kernel/drivers/firewire /lib/modules/3.10.0-957.10.1.el7.s390x/kernel/drivers/ide /lib/modules/3.10.0-957.10.1.el7.s390x/kernel/drivers/ata /lib/modules/3.10.0-957.10.1.el7.s390x/kernel/drivers/md /lib/modules/3.10.0-957.10.1.el7.s390x/kernel/drivers/message /lib/modules/3.10.0-957.10.1.el7.s390x/kernel/drivers/scsi /lib/modules/3.10.0-957.10.1.el7.s390x/kernel/drivers/usb/storage
   4828 +++ sed -e 's/^\(.*\)\.ko.*/\1/'
   4829 +++ find /lib/modules/3.10.0-957.10.1.el7.s390x/kernel/drivers/block /lib/modules/3.10.0-957.10.1.el7.s390x/kernel/drivers/firewire /lib/modules/3.10.0-957.10.1.el7.s390x/kernel/drivers/ide /lib/modules/3.10.0-957.10.1.el7.s390x/kernel/drivers/ata/lib/modules/3.10.0-957.10.1.el7.s390x/kernel/drivers/md/lib/modules/3.10.0-957.10.1.el7.s390x/kernel/drivers/message /lib/modules/3.10.0-957.10.1.el7.s390x/kernel/drivers/scsi /lib/modules/3.10.0-957.10.1.el7.s390x/kernel/drivers/usb/storage -type f -name '*.ko*' -printf '%f\n'
   4830 ++ Log 'Including network drivers'
   4831 ++ echo '2019-05-10 15:06:37.585248173 Including network drivers'
   4832 2019-05-10 15:06:37.585248173 Including network drivers
   4833 ++ NETWORK_DRIVERS=($( find_modules_in_dirs /lib/modules/$KERNEL_VERSION/kernel/drivers/net ))
   4834 +++ find_modules_in_dirs /lib/modules/3.10.0-957.10.1.el7.s390x/kernel/drivers/net
   4835 +++ sed -e 's/^\(.*\)\.ko.*/\1/'
   4836 +++ find /lib/modules/3.10.0-957.10.1.el7.s390x/kernel/drivers/net -type f -name '*.ko*' -printf '%f\n'
   4837 ++ Log 'Including crypto drivers'
   4838 ++ echo '2019-05-10 15:06:37.708446923 Including crypto drivers'
   4839 2019-05-10 15:06:37.708446923 Including crypto drivers
   4840 ++ CRYPTO_DRIVERS=($( find_modules_in_dirs /lib/modules/$KERNEL_VERSION/kernel/crypto ))
   4841 +++ find_modules_in_dirs /lib/modules/3.10.0-957.10.1.el7.s390x/kernel/crypto
   4842 +++ find /lib/modules/3.10.0-957.10.1.el7.s390x/kernel/crypto -type f -name '*.ko*' -printf '%f\n'
   4843 +++ sed -e 's/^\(.*\)\.ko.*/\1/'
   4844 ++ Log 'Including virtualization drivers'
   4845 ++ echo '2019-05-10 15:06:37.915648720 Including virtualization drivers'
   4846 2019-05-10 15:06:37.915648720 Including virtualization drivers
   4847 ++ VIRTUAL_DRIVERS=($( find_modules_in_dirs /lib/modules/$KERNEL_VERSION/kernel/drivers/{virtio,xen} ))
   4848 +++ find_modules_in_dirs /lib/modules/3.10.0-957.10.1.el7.s390x/kernel/drivers/virtio /lib/modules/3.10.0-957.10.1.el7.s390x/kernel/drivers/xen
   4849 +++ sed -e 's/^\(.*\)\.ko.*/\1/'
   4850 +++ find /lib/modules/3.10.0-957.10.1.el7.s390x/kernel/drivers/virtio /lib/modules/3.10.0-957.10.1.el7.s390x/kernel/drivers/xen -type f -name '*.ko*' -printf '%f\n'
   4851 ++ Log 'Including additional drivers'
   4852 ++ echo '2019-05-10 15:06:38.007149501 Including additional drivers'
   4853 2019-05-10 15:06:38.007149501 Including additional drivers
   4854 ++ EXTRA_DRIVERS=($( find_modules_in_dirs /lib/modules/$KERNEL_VERSION/{extra,weak-updates} ))
   4855 +++ find_modules_in_dirs /lib/modules/3.10.0-957.10.1.el7.s390x/extra /lib/modules/3.10.0-957.10.1.el7.s390x/weak-updates
   4856 +++ sed -e 's/^\(.*\)\.ko.*/\1/'
   4857 +++ find /lib/modules/3.10.0-957.10.1.el7.s390x/extra /lib/modules/3.10.0-957.10.1.el7.s390x/weak-updates -type f -name '*.ko*' -printf '%f\n'
   4858 ++ unset -f find_modules_in_dirs
   4859 + source_return_code=0
</code></pre>
<h4 id="mutable-dan_commented_at_2019-05-22_2321"><img src="https://avatars.githubusercontent.com/u/50145067?u=0b8898582fe782d29312c1d9a3c689216efdbade&v=4" width="50"><a href="https://github.com/mutable-dan">mutable-dan</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-495010023">2019-05-22 23:21</a>:<a class="headerlink" href="#mutable-dan_commented_at_2019-05-22_2321" title="Permanent link">&para;</a></h4>
<p>@jsmeix</p>
<p><strong>there are 3 problems on rhel so far</strong></p>
<p>and then comes actual recovery!</p>
<ol>
<li>
<p>StopIfError 'Could not copy
    '''/usr/share/rear/conf/templates/RESULT_usage_RAMDISK.txt<br />
    which looks a little similar to the changes you made to
    950_copy_result_files (have not looked deply at it)</p>
</li>
<li>
<p>this looks tp be fixed by:<br />
    in
    <a href="https://github.com/rear/rear/pull/2142#issuecomment-494426331">https://github.com/rear/rear/pull/2142#issuecomment-494426331</a><br />
    file: usr/share/rear/output/default/950_copy_result_files.sh<br />
    -- do you want me to implement your changes or can i merge your fix?</p>
</li>
<li>
<p>Handling network interface 'enccw0.0.0610'<br />
    enccw0.0.0610 is a physical device<br />
    Skipping 'enccw0.0.0610': not yet supported.<br />
    Failed to handle network interface 'enccw0.0.0610'.<br />
    -- Will look at next.</p>
</li>
<li>
<p>kernel not detected<br />
    will investigate where the kernel autodetect is done</p>
</li>
</ol>
<p>i am currently outputting to a ramdisk,<br />
next, i will setup the netfs to nfs. we probably don't need IPL, we will
see.<br />
writing the initrd, kernel, etc to an nfs share should be sufficient<br />
once i get the init, kernel and params on nfs, i can test the boot</p>
<p>i am getting the initrd written but not the kernel, will investigate
where the kernel autodetect is done</p>
<pre><code>Creating root filesystem layout
Handling network interface 'enccw0.0.0610'
enccw0.0.0610 is a physical device
Skipping 'enccw0.0.0610': not yet supported.
Failed to handle network interface 'enccw0.0.0610'.
To log into the recovery system via ssh set up /root/.ssh/authorized_keys or specify SSH_ROOT_PASSWORD
Copying logfile /var/log/rear/rear-red72a1.log into initramfs as '/tmp/rear-red72a1-partial-2019-05-22T18:18:40-0400.log'
Copying files and directories
Copying binaries and libraries
Copying all kernel modules in /lib/modules/3.10.0-957.10.1.el7.s390x (MODULES contains 'all_modules')
Copying all files in /lib*/firmware/
Skip copying broken symlink '/etc/mtab' target '/proc/2798/mounts' on /proc/ /sys/ /dev/ or /run/
Broken symlink '/usr/lib/modules/3.10.0-957.10.1.el7.s390x/build' in recovery system because 'readlink' cannot determine its link target
Broken symlink '/usr/lib/modules/3.10.0-957.10.1.el7.s390x/source' in recovery system because 'readlink' cannot determine its link target
Testing that the recovery system in /tmp/rear.MMwixuIEPrKkf3l/rootfs contains a usable system
Creating recovery/rescue system initramfs/initrd initrd.cgz with gzip default compression

Created initrd.cgz with gzip default compression (213731276 bytes) in 309 seconds
Copying resulting files to file location
Saving /var/log/rear/rear-red72a1.log as rear-red72a1.log to file location
Copying result files '/tmp/rear.MMwixuIEPrKkf3l/tmp/VERSION /tmp/rear.MMwixuIEPrKkf3l/tmp/README /tmp/rear.MMwixuIEPrKkf3l/tmp/rear-red72a1.log' to /home/garyd/ramdisk/red72a1 at file location
Exiting rear mkrescue (PID 58731) and its descendant processes ...
Running exit tasks
You should also rm -Rf /tmp/rear.MMwixuIEPrKkf3l
</code></pre>
<p>that was interesting what you did with kexec. I have read about ppl
doing that, but never did so myself</p>
<h4 id="jsmeix_commented_at_2019-05-23_0655"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-495091647">2019-05-23 06:55</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-05-23_0655" title="Permanent link">&para;</a></h4>
<p>@mutable-dan<br />
I did my generic improvements and fixes in<br />
usr/share/rear/output/default/950_copy_result_files.sh<br />
that I listed in my above<br />
<a href="https://github.com/rear/rear/pull/2142#issuecomment-494426331">https://github.com/rear/rear/pull/2142#issuecomment-494426331</a><br />
only in my personal ReaR scripts that I run on my IBM Z test systems.</p>
<p>I will do a GitHub pull request with that changes and merge it<br />
into our current GitHub ReaR master code...</p>
<p>Regarding your changes in<br />
rescue/GNU/Linux/230_storage_and_network_modules.sh</p>
<p>You won't actually need them because with current ReaR 2.5<br />
default.conf <code>MODULES=( 'all_modules' )</code> setting<br />
you get by default all modules in the recovery system, cf. my<br />
<a href="https://github.com/rear/rear/pull/2142#issuecomment-494677718">https://github.com/rear/rear/pull/2142#issuecomment-494677718</a></p>
<p>I checked that on my IBM Z test system where I had run "rear mkbackup"<br />
(I use <code>KEEP_BUILD_DIR="yes"</code>)</p>
<pre><code># find /tmp/rear.NlvtWuz8Sx0tjOd/rootfs/lib/modules/ | grep s390 | wc -l
69

# find /lib/modules/ | grep s390 | wc -l
69
</code></pre>
<p>i.e. same number of '390' kernel module files (and directories)<br />
in the recovery system (at <code>/tmp/rear.NlvtWuz8Sx0tjOd/rootfs/</code>)<br />
as in the original system and</p>
<pre><code># find /lib/modules/ | wc -l
1003

# find /tmp/rear.NlvtWuz8Sx0tjOd/rootfs/lib/modules/ | wc -l
1002

# find /lib/modules/ | grep scsi_debug
/lib/modules/4.12.14-94.41-default/kernel/drivers/scsi/scsi_debug.ko

# find /tmp/rear.NlvtWuz8Sx0tjOd/rootfs/lib/modules/ | grep scsi_debug || echo not found
not found

# grep ^EXCLUDE_MODULES usr/share/rear/conf/default.conf
EXCLUDE_MODULES=( scsi_debug )
</code></pre>
<p>same (except one) number of all kernel module files (and directories)<br />
in the recovery system (at <code>/tmp/rear.NlvtWuz8Sx0tjOd/rootfs/</code>)<br />
as in the original system - the exception is <code>scsi_debug</code> which<br />
is intentionally excluded, see usr/share/rear/conf/default.conf</p>
<p>Nevertheless your changes in<br />
rescue/GNU/Linux/230_storage_and_network_modules.sh<br />
are useful and needed if a user sets <code>MODULES=()</code> in<br />
his etc/rear/local.conf</p>
<h4 id="jsmeix_commented_at_2019-05-23_0747"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-495106513">2019-05-23 07:47</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-05-23_0747" title="Permanent link">&para;</a></h4>
<p>@mutable-dan<br />
with
<a href="https://github.com/rear/rear/pull/2147">https://github.com/rear/rear/pull/2147</a>
merged<br />
my generic improvements and fixes for<br />
usr/share/rear/output/default/950_copy_result_files.sh<br />
are now in our current GitHub ReaR master code<br />
so that the items <code>1.</code> and <code>2.</code> in<br />
<a href="https://github.com/rear/rear/pull/2142#issuecomment-495010023">https://github.com/rear/rear/pull/2142#issuecomment-495010023</a><br />
should be fixed now.</p>
<h4 id="jsmeix_commented_at_2019-05-23_0807"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-495112806">2019-05-23 08:07</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-05-23_0807" title="Permanent link">&para;</a></h4>
<p>@mutable-dan<br />
regarding item <code>3. Handling network interface 'enccw0.0.0610'</code> in<br />
<a href="https://github.com/rear/rear/pull/2142#issuecomment-495010023">https://github.com/rear/rear/pull/2142#issuecomment-495010023</a><br />
I cannot help because I don't know much about networking details<br />
(I use DHCP and be happy that on SLES12 <code>eth0</code> is used).</p>
<p>I think @rmetrich can help with crazy network interface names<br />
because he implemented very most of our current<br />
usr/share/rear/rescue/GNU/Linux/310_network_devices.sh<br />
which is where the network device configuration for<br />
the ReaR recovery system happens.</p>
<p>A general workaround to deal with things like</p>
<pre><code>Failed to handle network interface 'enccw0.0.0610'.
</code></pre>
<p>is to specify NETWORKING_PREPARATION_COMMANDS<br />
see its description in usr/share/rear/conf/default.conf<br />
or - probably easier - do it as I do with</p>
<pre><code>SSH_ROOT_PASSWORD="rear"
USE_DHCLIENT="yes"
</code></pre>
<p>to use DHCP for recovery system networking setup<br />
and get remote access to it via SSH.<br />
Usually you do not need full networking setup in the recovery system.<br />
You need just enough to be able to access your backup.</p>
<p>Regarding item <code>4. kernel not detected</code> in<br />
<a href="https://github.com/rear/rear/pull/2142#issuecomment-495010023">https://github.com/rear/rear/pull/2142#issuecomment-495010023</a><br />
see usr/share/rear/prep/GNU/Linux/400_guess_kernel.sh<br />
which is where the kernel is autodetected<br />
i.e. where the KERNEL_FILE variable is set.<br />
You must use ReaR 2.5 because before ReaR 2.5<br />
KERNEL_FILE was set by a mess of various scripts<br />
that I cleaned up for ReaR 2.5, see the<br />
"Release Notes for Relax-and-Recover version 2.5" at<br />
<a href="http://relax-and-recover.org/documentation/release-notes-2-5">http://relax-and-recover.org/documentation/release-notes-2-5</a><br />
therein the part about</p>
<pre><code>Cleaned up how KERNEL_FILE is set: Now the
KERNEL_FILE variable is set in the ‘prep’ stage only by
the new prep/GNU/Linux/400_guess_kernel.sh
that replaces the old
...
(issues #1851 #1983 #1985)
</code></pre>
<p>for details see those issues<br />
<a href="https://github.com/rear/rear/issues/1851">https://github.com/rear/rear/issues/1851</a><br />
<a href="https://github.com/rear/rear/pull/1983">https://github.com/rear/rear/pull/1983</a><br />
<a href="https://github.com/rear/rear/pull/1985">https://github.com/rear/rear/pull/1985</a></p>
<p>The KERNEL_FILE value is the file of the currently running kernel<br />
and that kernel should be used in the ReaR recovery system<br />
i.e. the ReaR recovery system should be booted with that kernel.</p>
<p>In my usr/share/rear/output/IPL/Linux-s390/800_create_ipl.sh<br />
cf.
<a href="https://github.com/rear/rear/pull/2142#issuecomment-494426331">https://github.com/rear/rear/pull/2142#issuecomment-494426331</a><br />
I use KERNEL_FILE to copy the currently used kernel<br />
whereto the RESULT_FILES are normally copied<br />
(which is in my case the NFS share on my NFS server)<br />
plus the ReaR recovery system files that are in ReaR's initrd<br />
and ReaR's initrd file is $TMP_DIR/$REAR_INITRD_FILENAME</p>
<p>In<br />
<a href="https://github.com/rear/rear/pull/2142#issuecomment-494739752">https://github.com/rear/rear/pull/2142#issuecomment-494739752</a><br />
I copy that kernel and ReaR's initrd from my NFS server<br />
to my "replacement hardware" IBM Z system to boot the<br />
ReaR recovery system there via <code>kexec -l ...</code> and <code>kecex -e</code>.</p>
<h4 id="jsmeix_commented_at_2019-05-23_1224"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-495196467">2019-05-23 12:24</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-05-23_1224" title="Permanent link">&para;</a></h4>
<p>@mutable-dan<br />
using <code>OUTPUT=RAMDISK</code> on IBM Z will not call<br />
usr/share/rear/output/RAMDISK/Linux-i386/900_copy_ramdisk.sh<br />
because that is in <code>.../Linux-i386/</code>.</p>
<p>To get an architecure-dependent script run on IBM Z you would need<br />
usr/share/rear/output/RAMDISK/Linux-s390/900_copy_ramdisk.sh</p>
<p>Cf. my usr/share/rear/output/IPL/Linux-s390/800_create_ipl.sh<br />
in
<a href="https://github.com/rear/rear/pull/2142#issuecomment-494426331">https://github.com/rear/rear/pull/2142#issuecomment-494426331</a></p>
<h4 id="jsmeix_commented_at_2019-05-23_1237"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-495200737">2019-05-23 12:37</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-05-23_1237" title="Permanent link">&para;</a></h4>
<p>@mutable-dan<br />
it seems things work for me with <code>OUTPUT=RAMDISK</code> on IBM Z<br />
with the following completely overhauled 900_copy_ramdisk.sh<br />
stored as usr/share/rear/output/RAMDISK/default/900_copy_ramdisk.sh</p>
<pre><code>#
# output/RAMDISK/default/900_copy_ramdisk.sh
#
# Add kernel and the ReaR recovery system initrd to RESULT_FILES
# so that the subsequent output/default/950_copy_result_files.sh
# will copy them to the output location specified via OUTPUT_URL
# (if not specified OUTPUT_URL is inherited from BACKUP_URL).
#

local kernel_file="$KERNEL_FILE"
local initrd_file="$TMP_DIR/$REAR_INITRD_FILENAME"

# The 'test' intentionally also fails when RAMDISK_SUFFIX is more than one word
# because we do not want blanks in kernel or initrd file names:
if test $RAMDISK_SUFFIX ; then
    kernel_file="$TMP_DIR/kernel-$RAMDISK_SUFFIX"
    cp $v -pLf $KERNEL_FILE $kernel_file || Error "Failed to copy KERNEL_FILE '$KERNEL_FILE'"
    initrd_file="$TMP_DIR/initramfs-$RAMDISK_SUFFIX.img"
    cp $v -pLf $TMP_DIR/$REAR_INITRD_FILENAME $initrd_file || Error "Failed to copy initramfs '$REAR_INITRD_FILENAME'"
fi

DebugPrint "Adding $kernel_file and $initrd_file to RESULT_FILES"
RESULT_FILES+=( $kernel_file $initrd_file )
</code></pre>
<p>With that I get (excerpts)</p>
<pre><code># usr/sbin/rear -D mkbackup
...
Adding /tmp/rear.ofaJcBdmGc6LlM5/tmp/kernel-s390vsl179 and /tmp/rear.ofaJcBdmGc6LlM5/tmp/initramfs-s390vsl179.img to RESULT_FILES
Copying resulting files to nfs location
Saving /root/rear.pull2142/var/log/rear/rear-s390vsl179.log as rear-s390vsl179.log to nfs location
Copying result files '/tmp/rear.ofaJcBdmGc6LlM5/tmp/kernel-s390vsl179 /tmp/rear.ofaJcBdmGc6LlM5/tmp/initramfs-s390vsl179.img /tmp/rear.ofaJcBdmGc6LlM5/tmp/VERSION /tmp/rear.ofaJcBdmGc6LlM5/tmp/README /tmp/rear.ofaJcBdmGc6LlM5/tmp/rear-s390vsl179.log' to /tmp/rear.ofaJcBdmGc6LlM5/outputfs/s390vsl179 at nfs location
</code></pre>
<p>and on my NFS server I get</p>
<pre><code># ls -lhtr /nfs/s390vsl179/
total 770M
-rw-rw-rw- 1 nobody nobody  13M May 23 14:21 kernel-s390vsl179
-rw-rw-rw- 1 nobody nobody  69M May 23 14:21 initramfs-s390vsl179.img
-rw-rw-rw- 1 nobody nobody  271 May 23 14:21 VERSION
-rw-rw-rw- 1 nobody nobody  190 May 23 14:21 README
-rw-rw-rw- 1 nobody nobody 2.7M May 23 14:21 rear-s390vsl179.log
-rw-rw-rw- 1 nobody nobody 683M May 23 14:23 backup.tar.gz
-rw-rw-rw- 1 nobody nobody 3.3M May 23 14:23 backup.log
</code></pre>
<h4 id="mutable-dan_commented_at_2019-05-23_1942"><img src="https://avatars.githubusercontent.com/u/50145067?u=0b8898582fe782d29312c1d9a3c689216efdbade&v=4" width="50"><a href="https://github.com/mutable-dan">mutable-dan</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-495358085">2019-05-23 19:42</a>:<a class="headerlink" href="#mutable-dan_commented_at_2019-05-23_1942" title="Permanent link">&para;</a></h4>
<p>@jsmeix</p>
<p><strong>Sumamry</strong></p>
<ul>
<li>Backup to nfs - ok</li>
<li>Kernel is recognized and copied</li>
<li>verified kernel modules are correct</li>
</ul>
<p><a href="https://github.com/rear/rear/pull/2142#issuecomment-495091647">https://github.com/rear/rear/pull/2142#issuecomment-495091647</a></p>
<blockquote>
<p>Nevertheless your changes in<br />
rescue/GNU/Linux/230_storage_and_network_modules.sh<br />
are useful and needed if a user sets MODULES=() in<br />
his etc/rear/local.conf</p>
</blockquote>
<ul>
<li>please let me know if you want the modules changes checked in. right
    now it is stashed.</li>
<li>ran rescue to NFS and confirmed the module count</li>
</ul>
<p><a href="https://github.com/rear/rear/pull/2142#issuecomment-495010023">https://github.com/rear/rear/pull/2142#issuecomment-495010023</a><br />
items: 1, 2, 4 are fixed</p>
<p><a href="https://github.com/rear/rear/pull/2142#issuecomment-495112806">https://github.com/rear/rear/pull/2142#issuecomment-495112806</a></p>
<blockquote>
<p>Regarding item 4. kernel not detected in<br />
#2142 (comment)<br />
see usr/share/rear/prep/GNU/Linux/400_guess_kernel.sh<br />
which is where the kernel is autodetected<br />
i.e. where the KERNEL_FILE variable is set.<br />
You must use ReaR 2.5 because before ReaR 2.5...</p>
</blockquote>
<p>I am merging from master to my fork, so i have the changes in v2.5 of
<strong>usr/share/rear/prep/GNU/Linux/400_guess_kernel.sh</strong></p>
<p>Will start the networking next, then IPL param<br />
Thank you for your help</p>
<h4 id="jsmeix_commented_at_2019-05-24_0928"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-495540773">2019-05-24 09:28</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-05-24_0928" title="Permanent link">&para;</a></h4>
<p>@mutable-dan<br />
yes, I would like to have your changes in<br />
rescue/GNU/Linux/230_storage_and_network_modules.sh<br />
committed because they are useful and needed<br />
if a user sets <code>MODULES=()</code> in his etc/rear/local.conf</p>
<h4 id="jsmeix_commented_at_2019-05-24_1002"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-495554406">2019-05-24 10:02</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-05-24_1002" title="Permanent link">&para;</a></h4>
<p>Right now I did another (partially manual) recovery<br />
on my "replacement hardware" with what I recently<br />
created on my NFS server with <code>OUTPUT=RAMDISK</code><br />
(and the new output/RAMDISK/default/900_copy_ramdisk.sh)<br />
as shown in<br />
<a href="https://github.com/rear/rear/pull/2142#issuecomment-495200737">https://github.com/rear/rear/pull/2142#issuecomment-495200737</a></p>
<p>Here my etc/rear/local.conf that I used</p>
<pre><code>OUTPUT=RAMDISK
BACKUP=NETFS
BACKUP_OPTIONS="nfsvers=3,nolock"
BACKUP_URL=nfs://10.160.67.243/nfs
SSH_ROOT_PASSWORD="rear"
USE_DHCLIENT="yes"
KEEP_BUILD_DIR="yes"
FIRMWARE_FILES=( 'no' )
PROGRESS_MODE="plain"
PROGRESS_WAIT_SECONDS="5"
</code></pre>
<p>I booted kernel-s390vsl179 and initramfs-s390vsl179.img<br />
on my "replacement hardware" via <code>kexec</code> from within the<br />
running first recreated system from my above very first attempt<br />
to do a "rear recover" (excerpts of what I did now):</p>
<pre><code>s390vsl180:~ # scp root@...:/nfs/s390vsl179/*s390vsl179* .
initramfs-s390vsl179.img
kernel-s390vsl179

s390vsl180:~ # kexec -l kernel-s390vsl179 --initrd=initramfs-s390vsl179.img --command-line='root=/dev/ram0 rw vga=normal hvc_iucv=8 TERM=dumb'

s390vsl180:~ # sync

s390vsl180:~ # kexec -e
</code></pre>
<p>Now s390vsl180 does a hard reboot and boots the<br />
ReaR recovery system where I log in via SSH<br />
and run "rear recover" in enforced MIGRATION_MODE<br />
so that I get the dialogs that allow me to adapt the<br />
still wrong parted comands in diskrestore.sh</p>
<p>Don't get confused that the running recovery system shows<br />
as hostname <code>s390vsl179</code> which is the hostname of the original system<br />
but the recovery system is actually running on my "replacement
hardware".</p>
<pre><code>RESCUE s390vsl179:~ # export MIGRATION_MODE=true

RESCUE s390vsl179:~ # rear -D recover
...
Confirm or edit the disk recreation script
1) Confirm disk recreation script and continue 'rear recover'
2) Edit disk recreation script (/var/lib/rear/layout/diskrestore.sh)
3) View disk recreation script (/var/lib/rear/layout/diskrestore.sh)
4) View original disk space usage (/var/lib/rear/layout/config/df.txt)
5) Use Relax-and-Recover shell and return back to here
6) Abort 'rear recover'
(default '1' timeout 300 seconds)
2
</code></pre>
<p>Before the parted comands in diskrestore.sh are</p>
<pre><code>RESCUE s390vsl179:~ # grep ^parted /root/rear.pull2142/var/lib/rear/layout/diskrestore.sh    
parted -s /dev/dasda mklabel dasd &gt;&amp;2
parted -s /dev/dasda mkpart "'dasda1'" 98304B 314621951B &gt;&amp;2
parted -s /dev/dasda mkpart "'dasda2'" 314621952B 838926335B &gt;&amp;2
parted -s /dev/dasda mkpart "'dasda3'" 838926336B 7385198591B &gt;&amp;2
</code></pre>
<p>I changed them to</p>
<pre><code>RESCUE s390vsl179:~ # grep ^parted /root/rear.pull2142/var/lib/rear/layout/diskrestore.sh
parted -s /dev/dasda mklabel dasd &gt;&amp;2
parted -s /dev/dasda mkpart ext2 98304B 314621951B &gt;&amp;2
parted -s /dev/dasda mkpart linux-swap 314621952B 838926335B &gt;&amp;2
parted -s /dev/dasda mkpart ext4 838926336B 7385333759B &gt;&amp;2
</code></pre>
<p>Note that in particular for the last partition the partition end byte<br />
value was not right: Before it was <code>7385198591B</code><br />
which is not what parted reports for the disk size</p>
<pre><code># parted -s /dev/dasda unit B print
Model: IBM S390 DASD drive (dasd)
Disk /dev/dasda: 7385333760B
...
</code></pre>
<p>so that this is another issue that needs to be investigated.</p>
<p>With the changed parted comands in diskrestore.sh<br />
the disk layout setup "just worked " for me<br />
and "rear recover" continues with</p>
<pre><code>UserInput -I LAYOUT_MIGRATED_CONFIRMATION needed in /usr/share/rear/layout/recreate/default/200_run_layout_code.sh line 98
Confirm the recreated disk layout or go back one step
1) Confirm recreated disk layout and continue 'rear recover'
2) Go back one step to redo disk layout recreation
3) Use Relax-and-Recover shell and return back to here
4) Abort 'rear recover'
(default '1' timeout 300 seconds)
1
UserInput: Valid choice number result 'Confirm recreated disk layout and continue 'rear recover''
User confirmed recreated disk layout
Restoring from '/tmp/rear.pH3rsfVF7M6pgA4/outputfs/s390vsl179/backup.tar.gz' (restore log in /var/lib/rear/restore/recover.backup.tar.gz.586.restore.log) ...
Backup restore program 'tar' started in subshell (PID=2697)
Restored 465 MiB [avg. 95322 KiB/sec] 
Restored 823 MiB [avg. 84298 KiB/sec] 
Restored 1215 MiB [avg. 82959 KiB/sec] 
Restoring MB/s 
OK
Restored 1628 MiB in 25 seconds [avg. 66716 KiB/sec]
Restoring finished (verify backup restore log messages in /var/lib/rear/restore/recover.backup.tar.gz.586.restore.log)
Recreating directories (with permissions) from /var/lib/rear/recovery/directories_permissions_owner_group
Migrating disk-by-id mappings in certain restored files in /mnt/local to current disk-by-id mappings ...
Replacing restored udev rule '/mnt/local//etc/udev/rules.d/70-persistent-net.rules' with the one from the ReaR rescue system
Migrating network configuration files according to the mapping files ...
UserInput -I RESTORED_FILES_CONFIRMATION needed in /usr/share/rear/finalize/default/520_confirm_finalize.sh line 41
Confirm restored config files are OK or adapt them as needed
1) Confirm it is OK to recreate initrd and reinstall bootloader and continue 'rear recover'
2) Edit restored etc/fstab (/mnt/local/etc/fstab)
3) View restored etc/fstab (/mnt/local/etc/fstab)
4) Use Relax-and-Recover shell and return back to here
5) Abort 'rear recover'
(default '1' timeout 300 seconds)
1
UserInput: Valid choice number result 'Confirm it is OK to recreate initrd and reinstall bootloader and continue 'rear recover''
User confirmed restored files
WARNING:
For this system
SUSE_LINUX/12.4 on Linux-s390 (based on SUSE/12/s390)
there is no code to install a boot loader on the recovered system
or the code that we have failed to install the boot loader correctly.
Please contribute appropriate code to the Relax-and-Recover project,
see http://relax-and-recover.org/development/
Take a look at the scripts in /usr/share/rear/finalize,
for example see the scripts
/usr/share/rear/finalize/Linux-i386/630_install_grub.sh
/usr/share/rear/finalize/Linux-i386/660_install_grub2.sh

---------------------------------------------------
|  IF YOU DO NOT INSTALL A BOOT LOADER MANUALLY,  |
|  THEN YOUR SYSTEM WILL NOT BE ABLE TO BOOT.     |
---------------------------------------------------

You can use 'chroot /mnt/local bash --login'
to change into the recovered system.
You should at least mount /proc in the recovered system
e.g. via 'mount -t proc none /mnt/local/proc'
before you change into the recovered system
and manually install a boot loader therein.

Finished recovering your system. You can explore it under '/mnt/local'.
Exiting rear recover (PID 586) and its descendant processes ...
Running exit tasks
You should also rm -Rf /tmp/rear.pH3rsfVF7M6pgA4
</code></pre>
<p>This is expected because we do not yet have<br />
code to install a boot loader on IBM Z<br />
so that I need to do that manually as before:</p>
<pre><code>RESCUE s390vsl179:~ # mount --bind /proc /mnt/local/proc

RESCUE s390vsl179:~ # mount --bind /sys /mnt/local/sys

RESCUE s390vsl179:~ # mount --bind /dev /mnt/local/dev

RESCUE s390vsl179:~ # chroot /mnt/local bash --login

s390vsl179:/ # update-bootloader --reinit

s390vsl179:/ # exit
logout

RESCUE s390vsl179:~ # reboot
</code></pre>
<p>Now the recreated system on my "replacement hardware" reboots<br />
and it works and I can log in via SSH</p>
<pre><code># ssh root@10.161.155.180
...
s390vsl180:~ #
</code></pre>
<p>Now it shows the right hostname that belongs to its IP 10.161.155.180<br />
because its hostname is set via DHCP (in contrast to the recovery
system<br />
that does not set its hostname via DHCP regardless that I also use
DHCP<br />
for the network setup of the recovery system).</p>
<h4 id="mutable-dan_commented_at_2019-05-24_1342"><img src="https://avatars.githubusercontent.com/u/50145067?u=0b8898582fe782d29312c1d9a3c689216efdbade&v=4" width="50"><a href="https://github.com/mutable-dan">mutable-dan</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-495633926">2019-05-24 13:42</a>:<a class="headerlink" href="#mutable-dan_commented_at_2019-05-24_1342" title="Permanent link">&para;</a></h4>
<blockquote>
<p>@mutable-dan<br />
yes, I would like to have your changes in<br />
rescue/GNU/Linux/230_storage_and_network_modules.sh<br />
committed because they are useful and needed<br />
if a user sets <code>MODULES=()</code> in his etc/rear/local.conf</p>
</blockquote>
<p>completed</p>
<h4 id="mutable-dan_commented_at_2019-05-24_1813"><img src="https://avatars.githubusercontent.com/u/50145067?u=0b8898582fe782d29312c1d9a3c689216efdbade&v=4" width="50"><a href="https://github.com/mutable-dan">mutable-dan</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-495738478">2019-05-24 18:13</a>:<a class="headerlink" href="#mutable-dan_commented_at_2019-05-24_1813" title="Permanent link">&para;</a></h4>
<p>I will try booting the kernel on a throw away VM. I heard people talk
about using kexec to boot a new kernel in a running machine, but I have
not tried it yet.</p>
<h4 id="jsmeix_commented_at_2019-05-27_0736"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-496111513">2019-05-27 07:36</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-05-27_0736" title="Permanent link">&para;</a></h4>
<p>@mutable-dan<br />
using kexec to boot a new kernel plus initrd in an already running
system<br />
is only my current workaround to boot the recovery system for my
tests,<br />
cf.
<a href="https://github.com/rear/rear/pull/2142#issuecomment-494739752">https://github.com/rear/rear/pull/2142#issuecomment-494739752</a></p>
<p>But that is not a real solution because for real disaster recovery<br />
it must be possible to boot the recovery system on "bare metal"<br />
(where "bare metal" on IBM Z means an empty virtual machine).</p>
<h4 id="jsmeix_commented_at_2019-05-27_0935"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-496149143">2019-05-27 09:35</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-05-27_0935" title="Permanent link">&para;</a></h4>
<p>I found out why during "rear recover" the last partition end byte
value<br />
was decreased from <code>7385333760</code> to <code>7385198592</code><br />
cf.
<a href="https://github.com/rear/rear/pull/2142#issuecomment-495554406">https://github.com/rear/rear/pull/2142#issuecomment-495554406</a></p>
<p>I have in my "rear recover" log those lines (excerpts):</p>
<pre><code>++ device_size=7385333760
++ [[ dasd == \g\p\t ]]
++ [[ dasd == \g\p\t\_\s\y\n\c\_\m\b\r ]]
++ [[ dasd == \d\a\s\d ]]
+++ mathlib_calculate '7385333760 - 33*4096'
+++ bc -ql
++ device_size=7385198592
...
++ start=838926336
++ end=7385333760
++ [[ -n 7385198592 ]]
++ ((  end &gt; 7385198592  ))
++ LogPrint 'Partition rear-noname on /dev/dasda: size reduced to fit on disk.'
++ Log 'Partition rear-noname on /dev/dasda: size reduced to fit on disk.'
++ echo '2019-05-24 11:09:55.182732415 Partition rear-noname on /dev/dasda: size reduced to fit on disk.'
2019-05-24 11:09:55.182732415 Partition rear-noname on /dev/dasda: size reduced to fit on disk.
++ Print 'Partition rear-noname on /dev/dasda: size reduced to fit on disk.'
++ Log 'End changed from 7385333760 to 7385198592.'
++ echo '2019-05-24 11:09:55.184125605 End changed from 7385333760 to 7385198592.'
2019-05-24 11:09:55.184125605 End changed from 7385333760 to 7385198592.
++ end=7385198592
++ is_true ''
++ case "$1" in
++ return 1
++ [[ rear-noname == \r\e\a\r\-\n\o\n\a\m\e ]]
+++ basename /dev/dasda3
++ name=dasda3
++ [[ -n y ]]
++ [[ -n 7385198592 ]]
+++ mathlib_calculate '7385198592 - 1'
+++ bc -ql
++ end=7385198591B
</code></pre>
<p>The matching code for that is in the create_partitions() function in<br />
usr/share/rear/layout/prepare/GNU/Linux/100_include_partition_code.sh</p>
<pre><code>            device_size=$( get_disk_size  "$sysfs_name" )

            ### GPT disks need 33 LBA blocks at the end of the disk
            # For the SUSE specific gpt_sync_mbr partitioning scheme
            # see https://github.com/rear/rear/issues/544
            if [[ "$label" == "gpt" || "$label" == "gpt_sync_mbr" || "$label" == "dasd" ]] ; then
                device_size=$( mathlib_calculate "$device_size - 33*$block_size" )
                # Only if resizing all partitions is explicity wanted
                # resizing of arbitrary partitions may also happen via the code below
                # in addition to layout/prepare/default/430_autoresize_all_partitions.sh
                if is_true "$autoresize_partitions" ; then
                    Log "Size reductions of GPT partitions probably needed."
                fi
            fi
...
        ### Test to make sure we're not past the end of the disk.
        if [[ "$device_size" ]] &amp;&amp; (( end &gt; $device_size )) ; then
            LogPrint "Partition $name on $device: size reduced to fit on disk."
            Log "End changed from $end to $device_size."
            end="$device_size"
        fi
</code></pre>
<p>So the cause is that in this case here <code>dasd</code> should not be treated<br />
same as GPT (that needs 33 LBA blocks at the end of the disk)<br />
which means in this case here my added <code>dasd</code> must be removed<br />
from this particular <code>if</code> clause so that it is again as it was before:</p>
<pre><code>            ### GPT disks need 33 LBA blocks at the end of the disk
            # For the SUSE specific gpt_sync_mbr partitioning scheme
            # see https://github.com/rear/rear/issues/544
            if [[ "$label" == "gpt" || "$label" == "gpt_sync_mbr" ]] ; then
</code></pre>
<h4 id="jsmeix_commented_at_2019-05-27_1122"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-496178838">2019-05-27 11:22</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-05-27_1122" title="Permanent link">&para;</a></h4>
<p>@mutable-dan<br />
now I use your current code from your<br />
GitHub Innovation-Data-Processing/s390 branch.</p>
<p>I needed the following changes to make<br />
the disk layout recreation "just work" for me:</p>
<pre><code>--- usr/share/rear/layout/prepare/GNU/Linux/100_include_partition_code.sh.original      2019-05-27 10:38:53.938907196 +0200
+++ usr/share/rear/layout/prepare/GNU/Linux/100_include_partition_code.sh       2019-05-27 11:36:03.538907196 +0200
@@ -141,7 +141,7 @@
             # For the SUSE specific gpt_sync_mbr partitioning scheme
             # see https://github.com/rear/rear/issues/544
             # see https://github.com/rear/rear/pull/2142 for s390 partitioning
-            if [[ "$label" == "gpt" || "$label" == "gpt_sync_mbr" || "$label" == "dasd" ]] ; then
+            if [[ "$label" == "gpt" || "$label" == "gpt_sync_mbr" ]] ; then
                 device_size=$( mathlib_calculate "$device_size - 33*$block_size" )
                 # Only if resizing all partitions is explicity wanted
                 # resizing of arbitrary partitions may also happen via the code below
</code></pre>
<p>to fix
<a href="https://github.com/rear/rear/pull/2142#issuecomment-496149143">https://github.com/rear/rear/pull/2142#issuecomment-496149143</a></p>
<p>Additionally I needed some bigger changes in<br />
usr/share/rear/layout/save/GNU/Linux/200_partition_layout.sh<br />
to get things right with the partition 'Name' value and hopefully<br />
also with partition 'Flags' (but in my case there are no flags):</p>
<p><a href="https://github.com/rear/rear/files/3223538/200_partition_layout.sh.txt">200_partition_layout.sh.txt</a></p>
<p>I needed to append <code>.txt</code> to the actual file name
<code>200_partition_layout.sh</code><br />
to be able to attach it here because GitHub does not support <code>*.sh</code>
files, see<br />
<a href="https://help.github.com/en/articles/file-attachments-on-issues-and-pull-requests">https://help.github.com/en/articles/file-attachments-on-issues-and-pull-requests</a></p>
<h4 id="jsmeix_commented_at_2019-05-27_1220"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-496194073">2019-05-27 12:20</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-05-27_1220" title="Permanent link">&para;</a></h4>
<p>To get the bootloaders (GRUB2 and ZIPL) installed<br />
during "rear recover" on SLES I made a new script<br />
usr/share/rear/finalize/SUSE_LINUX/s390/660_install_grub2_and_zipl.sh</p>
<p><a href="https://github.com/rear/rear/files/3223663/660_install_grub2_and_zipl.sh.txt">660_install_grub2_and_zipl.sh.txt</a></p>
<p>Now for the first time "rear recover" on SLES-12-SP4<br />
"just worked" for me:</p>
<pre><code>RESCUE s390vsl179:~ # rear -D recover
Relax-and-Recover 2.5 / Git
Running rear recover (PID 578)
Using log file: /var/log/rear/rear-s390vsl179.log
Running workflow recover within the ReaR rescue/recovery system
Starting required daemons for NFS: RPC portmapper (portmap or rpcbind) and rpc.statd if available.
Started RPC portmapper 'rpcbind'.
RPC portmapper 'rpcbind' available.
Started rpc.statd.
RPC status rpc.statd available.
Using backup archive '/tmp/rear.3uDnuGbRknJ8oB2/outputfs/s390vsl179/backup.tar.gz'
Will do driver migration (recreating initramfs/initrd)
Calculating backup archive size
Backup archive size is 692M     /tmp/rear.3uDnuGbRknJ8oB2/outputfs/s390vsl179/backup.tar.gz (compressed)
Comparing disks
Device dasda has expected (same) size 7385333760 (will be used for recovery)
Disk configuration looks identical
UserInput -I DISK_LAYOUT_PROCEED_RECOVERY needed in /usr/share/rear/layout/prepare/default/250_compare_disks.sh line 148
Proceed with recovery (yes) otherwise manual disk layout configuration is enforced
(default 'yes' timeout 30 seconds)

UserInput: No real user input (empty or only spaces) - using default input
UserInput: No choices - result is 'yes'
User confirmed to proceed with recovery
Start system layout restoration.
Disk '/dev/dasda': creating 'dasd' partition table
Disk '/dev/dasda': creating partition number 1 with name ''ext2''
Disk '/dev/dasda': creating partition number 2 with name ''ext2''
Disk '/dev/dasda': creating partition number 3 with name ''ext2''
Creating filesystem of type ext4 with mount point / on /dev/dasda3.
Mounting filesystem /
Creating filesystem of type ext2 with mount point /boot/zipl on /dev/dasda1.
Mounting filesystem /boot/zipl
Creating swap on /dev/dasda2
Disk layout created.
Restoring from '/tmp/rear.3uDnuGbRknJ8oB2/outputfs/s390vsl179/backup.tar.gz' (restore log in /var/lib/rear/restore/recover.backup.tar.gz.578.restore.log) ...
Backup restore program 'tar' started in subshell (PID=2175)
Restored 394 MiB [avg. 80801 KiB/sec] 
Restored 801 MiB [avg. 82065 KiB/sec] 
Restored 1172 MiB [avg. 80016 KiB/sec] 
Restored 1583 MiB [avg. 81078 KiB/sec] 
OK
Restored 1646 MiB in 25 seconds [avg. 67428 KiB/sec]
Restoring finished (verify backup restore log messages in /var/lib/rear/restore/recover.backup.tar.gz.578.restore.log)
Recreating directories (with permissions) from /var/lib/rear/recovery/directories_permissions_owner_group
Migrating disk-by-id mappings in certain restored files in /mnt/local to current disk-by-id mappings ...
Replacing restored udev rule '/mnt/local//etc/udev/rules.d/70-persistent-net.rules' with the one from the ReaR rescue system
Migrating network configuration files according to the mapping files ...
Installing GRUB2 boot loader plus ZIPL...
Finished recovering your system. You can explore it under '/mnt/local'.
Exiting rear recover (PID 578) and its descendant processes ...
Running exit tasks
You should also rm -Rf /tmp/rear.3uDnuGbRknJ8oB2
RESCUE s390vsl179:~ # reboot
</code></pre>
<p>For comparison on the original system</p>
<pre><code># parted -s /dev/dasda unit B print
Model: IBM S390 DASD drive (dasd)
Disk /dev/dasda: 7385333760B
Sector size (logical/physical): 512B/4096B
Partition Table: dasd
Disk Flags:

Number  Start       End          Size         File system     Flags
 1      98304B      314621951B   314523648B   ext2
 2      314621952B  838926335B   524304384B   linux-swap(v1)
 3      838926336B  7385333759B  6546407424B  ext4
</code></pre>
<p>versus on the recreated system</p>
<pre><code># parted -s /dev/dasda unit B print
Model: IBM S390 DASD drive (dasd)
Disk /dev/dasda: 7385333760B
Sector size (logical/physical): 512B/4096B
Partition Table: dasd
Disk Flags:

Number  Start       End          Size         File system     Flags
 1      98304B      314621951B   314523648B   ext2
 2      314621952B  838926335B   524304384B   linux-swap(v1)
 3      838926336B  7385333759B  6546407424B  ext4
</code></pre>
<p>i.e. byte-by-byte identical partitioning.<br />
The right <code>File system</code> entries happen via the <code>mkfs</code> commands<br />
so that the hardcoded fixed dummy <code>ext2</code> that are shown during</p>
<pre><code>Disk '/dev/dasda': creating partition number 1 with name ''ext2''
Disk '/dev/dasda': creating partition number 2 with name ''ext2''
Disk '/dev/dasda': creating partition number 3 with name ''ext2''
</code></pre>
<p>do not matter in the end.</p>
<h4 id="jsmeix_commented_at_2019-05-28_1033"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-496461028">2019-05-28 10:33</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-05-28_1033" title="Permanent link">&para;</a></h4>
<p>My pull request
<a href="https://github.com/rear/rear/pull/2150">https://github.com/rear/rear/pull/2150</a><br />
contains the changes of my above<br />
<a href="https://github.com/rear/rear/pull/2142#issuecomment-496178838">https://github.com/rear/rear/pull/2142#issuecomment-496178838</a><br />
and<br />
<a href="https://github.com/rear/rear/pull/2142#issuecomment-496194073">https://github.com/rear/rear/pull/2142#issuecomment-496194073</a></p>
<h4 id="mutable-dan_commented_at_2019-05-28_2131"><img src="https://avatars.githubusercontent.com/u/50145067?u=0b8898582fe782d29312c1d9a3c689216efdbade&v=4" width="50"><a href="https://github.com/mutable-dan">mutable-dan</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-496697777">2019-05-28 21:31</a>:<a class="headerlink" href="#mutable-dan_commented_at_2019-05-28_2131" title="Permanent link">&para;</a></h4>
<blockquote>
<p>My pull request #2150<br />
contains the changes of my above<br />
<a href="https://github.com/rear/rear/pull/2142#issuecomment-496178838">#2142
(comment)</a><br />
and<br />
<a href="https://github.com/rear/rear/pull/2142#issuecomment-496194073">#2142
(comment)</a></p>
</blockquote>
<p>hello,</p>
<p>I will merge your changes mentioned above into my fork. The one area I
will need to look at is the assumption of ext2. if it acts as just a
placeholder, should be ok. it it overrides the actual filesystem type,
could be a problem. rhel on z uses xfs</p>
<p>thank you</p>
<h4 id="jsmeix_commented_at_2019-05-29_1023"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-496878540">2019-05-29 10:23</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-05-29_1023" title="Permanent link">&para;</a></h4>
<p>@mutable-dan<br />
right now I merged
<a href="https://github.com/rear/rear/pull/2150">https://github.com/rear/rear/pull/2150</a><br />
so that now there should be generic support for dasd disks<br />
in the current ReaR GitHub master code.</p>
<p>Regarding why using a dummy file system type 'ext2' for<br />
dasd disk 'part' entries should work, e.g. as in my disklayout.conf</p>
<pre><code>part /dev/dasda 314523648 98304 ext2 none /dev/dasda1
part /dev/dasda 524304384 314621952 ext2 none /dev/dasda2
part /dev/dasda 6546407424 838926336 ext2 none /dev/dasda3
</code></pre>
<p>see the comment at<br />
<a href="https://github.com/rear/rear/blob/master/usr/share/rear/layout/save/GNU/Linux/200_partition_layout.sh#L175">https://github.com/rear/rear/blob/master/usr/share/rear/layout/save/GNU/Linux/200_partition_layout.sh#L175</a></p>
<p>Regarding (re)-installing the bootloader on s390 on Red Hat<br />
I think you need to make a Red Hat specific new script named like<br />
(directories named <code>.../Fedora/...</code> are also used for RHEL)</p>
<pre><code>usr/share/rear/finalize/Fedora/s390/660_install_zipl.sh
</code></pre>
<p>when Red Hat uses plain <code>zipl</code> as bootloader on IMB Z.</p>
<h4 id="mutable-dan_commented_at_2019-05-29_2117"><img src="https://avatars.githubusercontent.com/u/50145067?u=0b8898582fe782d29312c1d9a3c689216efdbade&v=4" width="50"><a href="https://github.com/mutable-dan">mutable-dan</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-497112668">2019-05-29 21:17</a>:<a class="headerlink" href="#mutable-dan_commented_at_2019-05-29_2117" title="Permanent link">&para;</a></h4>
<p>re
<a href="https://github.com/rear/rear/pull/2142#issuecomment-496878540">https://github.com/rear/rear/pull/2142#issuecomment-496878540</a><br />
understood</p>
<p>i merged your commits to master into my fork.</p>
<h4 id="mutable-dan_commented_at_2019-05-31_2202"><img src="https://avatars.githubusercontent.com/u/50145067?u=0b8898582fe782d29312c1d9a3c689216efdbade&v=4" width="50"><a href="https://github.com/mutable-dan">mutable-dan</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-497873829">2019-05-31 22:02</a>:<a class="headerlink" href="#mutable-dan_commented_at_2019-05-31_2202" title="Permanent link">&para;</a></h4>
<p>working on rhel zIPL bootloader<br />
<a href="https://github.com/rear/rear/pull/2142#issuecomment-496194073">https://github.com/rear/rear/pull/2142#issuecomment-496194073</a><br />
and<br />
<a href="https://github.com/rear/rear/pull/2142#issuecomment-496878540">https://github.com/rear/rear/pull/2142#issuecomment-496878540</a></p>
<p>created initram and kernel on nfs and we were able to ILP. don't have
the recover menu because of the above<br />
i have a suse 11&amp; 12 zlinux which i will be able to iPL also</p>
<h4 id="mutable-dan_commented_at_2019-06-04_2021"><img src="https://avatars.githubusercontent.com/u/50145067?u=0b8898582fe782d29312c1d9a3c689216efdbade&v=4" width="50"><a href="https://github.com/mutable-dan">mutable-dan</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-498828073">2019-06-04 20:21</a>:<a class="headerlink" href="#mutable-dan_commented_at_2019-06-04_2021" title="Permanent link">&para;</a></h4>
<p>We have been IPLing the generated kernel and init. we found we were
missing a few tools<br />
added s390 tools for working with dasd and qeth, see below. working on
recovery....</p>
<pre><code>PROGS=( "${PROGS[@]}" cmsfscat  cmsfsck  cmsfscp  cmsfslst  cmsfsvol )
PROGS=( "${PROGS[@]}" chccwdev chshut chiucvallow chchp tape390_crypt tape390_display )
PROGS=( "${PROGS[@]}" cmsfscat  cmsfsck  cmsfscp  cmsfslst  cmsfsvol )
PROGS=( "${PROGS[@]}" lsdasd lsqeth lstape )
PROGS=( "${PROGS[@]}" cio_ignore zdump zfcpconf.sh zgetdump ziomon ziomon_mgr ziomon_zfcpdd ziorep_traffic znetconf )
PROGS=( "${PROGS[@]}" fcp_cio_free zfcpdbf zic ziomon_fcpconf ziomon_util ziorep_config ziorep_utilization znet_cio_free zramctl )
</code></pre>
<h4 id="jsmeix_commented_at_2019-06-05_0946"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-499015525">2019-06-05 09:46</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-06-05_0946" title="Permanent link">&para;</a></h4>
<p>@mutable-dan<br />
a general note regarding things as in<br />
<a href="https://github.com/rear/rear/pull/2142#issuecomment-498828073">https://github.com/rear/rear/pull/2142#issuecomment-498828073</a></p>
<p>In<br />
<a href="https://github.com/rear/rear/pull/2142/files">https://github.com/rear/rear/pull/2142/files</a><br />
I do not see where e.g. the program <code>cmsfscat</code> is called by a ReaR
script.</p>
<p>In general regarding things like PROGS, COPY_AS_IS, REQUIRED_PROGS<br />
and LIBS:</p>
<p>What is specified in those arrays is only what is needed to be run<br />
within the running ReaR recovery system, i.e. what is called<br />
during recovery system startup (e.g. by skel/default/etc/scripts)<br />
and during "rear recover".</p>
<p>Currently I fail to see how all those PROGS and REQUIRED_PROGS<br />
that you specified are run from within the ReaR recovery system<br />
or at all by a ReaR script.</p>
<p>REQUIRED_PROGS are additionally required to exist<br />
in the original system because e.g. "rear mkrescue"<br />
aborts in init/default/950_check_missing_programs.sh<br />
when an element of the REQUIRED_PROGS is missing.</p>
<p>See the comment in init/default/950_check_missing_programs.sh<br />
regarding how to add programs to REQUIRED_PROGS as needed<br />
from other ReaR scripts, for example see the script<br />
layout/save/GNU/Linux/230_filesystem_layout.sh<br />
and cf.
<a href="https://github.com/rear/rear/issues/1963">https://github.com/rear/rear/issues/1963</a></p>
<h4 id="mutable-dan_commented_at_2019-06-05_1654"><img src="https://avatars.githubusercontent.com/u/50145067?u=0b8898582fe782d29312c1d9a3c689216efdbade&v=4" width="50"><a href="https://github.com/mutable-dan">mutable-dan</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-499167231">2019-06-05 16:54</a>:<a class="headerlink" href="#mutable-dan_commented_at_2019-06-05_1654" title="Permanent link">&para;</a></h4>
<blockquote>
<p>@mutable-dan<br />
a general note regarding things as in<br />
<a href="https://github.com/rear/rear/pull/2142#issuecomment-498828073">#2142
(comment)</a></p>
</blockquote>
<p>Hi<br />
we put everything Z in right now while we figure out how to manually get
the network, storage devices and filesystems up. it's a slow process
building recoveries and booting on the zvm emulator.</p>
<p>some of the links provided add clarity to the usage of PROGS,
COPY_AS_IS, REQUIRED_PROGS and LIBS and
<a href="https://github.com/rear/rear/blob/master/doc/user-guide/09-design-concepts.adoc">https://github.com/rear/rear/blob/master/doc/user-guide/09-design-concepts.adoc</a>
helps a little too, but i have been unable to find a complete
description of these vars and how they should be used. any info would be
helpful.<br />
The difference between a recovery and original system was also confused
a bit, once we figure out what is needed, i'll pull out the rest</p>
<h4 id="jsmeix_commented_at_2019-06-06_1455"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-499529607">2019-06-06 14:55</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-06-06_1455" title="Permanent link">&para;</a></h4>
<p>@mutable-dan<br />
while you are trying things out I suggest to set things<br />
like PROGS, COPY_AS_IS, REQUIRED_PROGS, LIBS<br />
only in your etc/rear/local.conf</p>
<p>When you know what you need where and when,<br />
you could add it into scripts.</p>
<p>This way I think I could merge this pull request soon<br />
provided it does no longer contain things that are not needed<br />
for a very first (limited) usage of ReaR on IBM Z<br />
e.g. only having kernel and ReaR's initrd on an NFS server<br />
but no yet support how to boot/IPL them on a Z system.</p>
<p>The support how to boot/IPL them on a Z system<br />
can later be added via separated subsequent pull requests,<br />
cf. the part about "Submit early, submit often" in<br />
<a href="https://github.com/rear/rear/commit/f719fee860f656859ec12838b0c5b36d32532d6a#commitcomment-33455129">https://github.com/rear/rear/commit/f719fee860f656859ec12838b0c5b36d32532d6a#commitcomment-33455129</a><br />
and<br />
<a href="https://github.com/rear/rear/commit/f719fee860f656859ec12838b0c5b36d32532d6a#commitcomment-33473579">https://github.com/rear/rear/commit/f719fee860f656859ec12838b0c5b36d32532d6a#commitcomment-33473579</a></p>
<h4 id="mutable-dan_commented_at_2019-06-07_1745"><img src="https://avatars.githubusercontent.com/u/50145067?u=0b8898582fe782d29312c1d9a3c689216efdbade&v=4" width="50"><a href="https://github.com/mutable-dan">mutable-dan</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-499976736">2019-06-07 17:45</a>:<a class="headerlink" href="#mutable-dan_commented_at_2019-06-07_1745" title="Permanent link">&para;</a></h4>
<p>move most of the tools refed in 305_include_s390_tools.sh to
local.conf</p>
<h4 id="mutable-dan_commented_at_2019-06-13_2258"><img src="https://avatars.githubusercontent.com/u/50145067?u=0b8898582fe782d29312c1d9a3c689216efdbade&v=4" width="50"><a href="https://github.com/mutable-dan">mutable-dan</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-501908214">2019-06-13 22:58</a>:<a class="headerlink" href="#mutable-dan_commented_at_2019-06-13_2258" title="Permanent link">&para;</a></h4>
<p>@jsmeix</p>
<p>manually enabled networking and dasd device on zlinux instance. modified
200_partition_layout.sh to write additional info needed to dasd format
and partition the drive to disklayout.conf</p>
<pre><code># dasdfmt - disk layout is either cdl for the compatible disk layout (default) or ldl
#  example usage: dasdfmt -b 4096 -d cdl -y /dev/dasda
# dasdfmt /dev/dasda
# dasdfmt -b &lt;blocksize&gt; -d &lt;layout&gt; -y &lt;devname&gt;
dasdfmt -b 4096 -d CDL -y /dev/dasda
# fdasd /dev/dasda
# write fdasd as device [start,end,type]
# repeat [start,end,type] for each partition
# where: start - start track, end - end track
# parse line fdasd_config into a file and call fdasd -c filename /dev/dasda
#        type: optional and specifies the partition type. &lt;type&gt; can be one of: native, swap, raid, lvm, or gpfs.  If omitted, 'native' is used
# fdasd -c /var/lib/rear/layout/fdasd.conf &lt;devname&gt;
fdasd_config /dev/dasda [2,10668,native] [10669,491399,lvm] 
# Disk /dev/dasda
# Format: disk &lt;devname&gt; &lt;size(bytes)&gt; &lt;partition label type&gt;
disk /dev/dasda 24153292800 dasd
# Partitions on /dev/dasda
# Format: part &lt;device&gt; &lt;partition size(bytes)&gt; &lt;partition start(bytes)&gt; &lt;partition type|name&gt; &lt;flags&gt; /dev/&lt;partition&gt;
part /dev/dasda 524304384 98304 ext2 none /dev/dasda1
part /dev/dasda 23628890112 524402688 ext2 none /dev/dasda2
# Format for LVM PVs
</code></pre>
<p>please let me know if there is a more appropriate place for this code.
next step is to find the place in recovery to read this and prep the
drives for the 'normal' linux setup</p>
<h4 id="mutable-dan_commented_at_2019-06-14_1535"><img src="https://avatars.githubusercontent.com/u/50145067?u=0b8898582fe782d29312c1d9a3c689216efdbade&v=4" width="50"><a href="https://github.com/mutable-dan">mutable-dan</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-502156235">2019-06-14 15:35</a>:<a class="headerlink" href="#mutable-dan_commented_at_2019-06-14_1535" title="Permanent link">&para;</a></h4>
<blockquote>
<p>I think for overall consistency it must be ensured that there is<br />
a non-empty <code>&lt;partition type|name&gt;</code> value in disklayout.conf<br />
cf.
<a href="https://github.com/rear/rear/pull/2142/files#r285583301">https://github.com/rear/rear/pull/2142/files#r285583301</a></p>
</blockquote>
<p>completed. just was not referenced in commit</p>
<h4 id="jsmeix_commented_at_2019-06-17_1319"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-502678994">2019-06-17 13:19</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-06-17_1319" title="Permanent link">&para;</a></h4>
<p>@mutable-dan<br />
with your changes in layout/save/GNU/Linux/200_partition_layout.sh via
your<br />
<a href="https://github.com/rear/rear/pull/2142/commits/335f060bbb89e46baa9d484fa501bfa28e243378">https://github.com/rear/rear/pull/2142/commits/335f060bbb89e46baa9d484fa501bfa28e243378</a><br />
you introduce support for preparing a <code>dasd</code> disk<br />
with the commands <code>dasdfmt</code> plus <code>fdasd</code><br />
instead of <code>parted</code> which is normally used to prepare a disk<br />
but you do not exclude that <code>parted</code> is also used<br />
when <code>dasdfmt</code> plus <code>fdasd</code> should be used.</p>
<p>As far as I know newer <code>parted</code> supports preparing a <code>dasd</code> disk<br />
and on current SLES we (i.e. SUSE) do no longer provide the<br />
commands <code>dasdfmt</code> and <code>fdasd</code> so that for IMB Z support<br />
on current SLES only <code>parted</code> is used to prepare a <code>dasd</code> disk<br />
and it seems <code>parted</code> is the only tool that is supported by SUSE<br />
to prepare a <code>dasd</code> disk.<br />
At least for my tests here plain <code>parted</code> had worked for me<br />
to prepare the <code>dasd</code> disk on my IBM Z test system.</p>
<p>Therefore my question:<br />
What is the reason why you need to additionally support<br />
preparing a <code>dasd</code> disk with <code>dasdfmt</code> plus <code>fdasd</code>?</p>
<p>When two kind of tools can be used to do the same thing in ReaR<br />
both methods must exclude each other (otherwise <code>parted</code> would<br />
be run in addition after <code>dasdfmt</code> and <code>fdasd</code> had been run)<br />
and both methods must be continuously maintained<br />
in ReaR for a possibly very long time in the future.</p>
<p>In other words:<br />
When there is no mandatory reason to use <code>dasdfmt</code> plus <code>fdasd</code><br />
to prepare a <code>dasd</code> disk, I suggest to not add support for them to<br />
keep the code in ReaR simpler and better maintainable<br />
(the current code is already rather hard to maintain).</p>
<h4 id="mutable-dan_commented_at_2019-06-17_2041"><img src="https://avatars.githubusercontent.com/u/50145067?u=0b8898582fe782d29312c1d9a3c689216efdbade&v=4" width="50"><a href="https://github.com/mutable-dan">mutable-dan</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-502842854">2019-06-17 20:41</a>:<a class="headerlink" href="#mutable-dan_commented_at_2019-06-17_2041" title="Permanent link">&para;</a></h4>
<blockquote>
<p>@mutable-dan<br />
with your changes in layout/save/GNU/Linux/200_partition_layout.sh
via your</p>
</blockquote>
<p>on rhel dasdfmt looks to be needed else it does not show up as a block
device w/o. it looks like i can use parted instead of fdasd on rhel. i
am testing....</p>
<h4 id="jsmeix_commented_at_2019-06-18_1410"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-503152699">2019-06-18 14:10</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-06-18_1410" title="Permanent link">&para;</a></h4>
<p>@mutable-dan<br />
what <code>parted</code> does during <code>rear recover</code> is implemented in<br />
layout/prepare/GNU/Linux/100_include_partition_code.sh<br />
therein rather indirectly via the <code>create_disk()</code> function<br />
that gets called during <code>rear recover</code> as needed by<br />
layout/prepare/default/540_generate_device_code.sh<br />
therein again indirectly via the <code>create_device()</code> function<br />
that is implemented in lib/layout-functions.sh which calls</p>
<pre><code>create_$type "$device"
</code></pre>
<p>where <code>$type</code> is basically the keyword in disklayout.conf<br />
cf. "Disk layout file syntax" at<br />
<a href="https://github.com/rear/rear/blob/master/doc/user-guide/06-layout-configuration.adoc">https://github.com/rear/rear/blob/master/doc/user-guide/06-layout-configuration.adoc</a></p>
<p>E.g. for the <code>disk</code> keyword in disklayout.conf</p>
<pre><code>create_disk "$device"
</code></pre>
<p>is called (i.e. the <code>create_disk()</code> function in
100_include_partition_code.sh)<br />
and that function calls the <code>create_partitions()</code> function that is
also<br />
implemented in 100_include_partition_code.sh so that finally<br />
the <code>create_partitions()</code> function emits <code>parted</code> command calls<br />
(and other stuff) into the <code>diskrestore.sh</code> script that is finally
called by<br />
usr/share/rear/layout/recreate/default/200_run_layout_code.sh</p>
<p>Just simple - isn't it ;-)</p>
<p>Seriously:</p>
<p>The indirection via the <code>diskrestore.sh</code> script is crucial and
mandatory.</p>
<p>There must never even happen anything on the user's target system<br />
before the <code>diskrestore.sh</code> script is run.</p>
<p>All commands that prepare the user's target system disks must be
written<br />
into the <code>diskrestore.sh</code> script (via appropriate <code>create_$type</code>
functions<br />
or other appropriate functions or code in <code>rear recover</code> scripts) and<br />
not any command that changes any user's target system disk<br />
must ever be run directly via a <code>rear recover</code> script.</p>
<p>The reason behind is:</p>
<p>The <code>diskrestore.sh</code> script is the one and only piece of code<br />
that recreates the disk layout (i.e. partitions, filesystems, mount
points)<br />
of all the user's target system disks.</p>
<p>This way the user can see the actual commands<br />
that recreate his target system disks, cf.<br />
<a href="https://github.com/rear/rear/pull/2081#issuecomment-496175444">https://github.com/rear/rear/pull/2081#issuecomment-496175444</a><br />
and<br />
the user can modify those commands as needed<br />
e.g. when something fails cf.</p>
<pre><code>... if the worst comes to the worst - even temporary quick
and dirty workarounds are relatively easily possible ...
</code></pre>
<p>in the section "Disaster recovery with Relax-and-Recover (ReaR)"<br />
in
<a href="https://en.opensuse.org/SDB:Disaster_Recovery">https://en.opensuse.org/SDB:Disaster_Recovery</a><br />
or in case of a migration where the target system disks<br />
are not fully compatible with the original system disks<br />
(e.g. migration from two smaller disks onto one big disk).</p>
<h4 id="mutable-dan_commented_at_2019-06-24_1610"><img src="https://avatars.githubusercontent.com/u/50145067?u=0b8898582fe782d29312c1d9a3c689216efdbade&v=4" width="50"><a href="https://github.com/mutable-dan">mutable-dan</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-505076442">2019-06-24 16:10</a>:<a class="headerlink" href="#mutable-dan_commented_at_2019-06-24_1610" title="Permanent link">&para;</a></h4>
<p>With this check-in rhel is able to properly partition dasd drives. There
are some items that need to be discussed, such as placement of the dasd
enable and dasd info placed in the disklayout.conf. All suggestions are,
of course, welcome.</p>
<p><strong>usr/share/rear/layout/prepare/GNU/Linux/100_include_partition_code.sh</strong><br />
This is a temp fix:<br />
+ #if [[ "$label" == "gpt" || "$label" == "gpt_sync_mbr" ||
"$label" == "dasd" ]] ; then<br />
+ if [[ "$label" == "gpt" || "$label" == "gpt_sync_mbr" ]] ;
then<br />
removed dasd while we figure out how to handle this<br />
If i put the dasd condition back in and add something for suse such as
"$OS_VENDOR" == "SUSE_LINUX", will that work?<br />
rhel dasd are basically dos partitions, the gpd re-calc caused rhel to
fail when partitioning</p>
<p><strong>usr/share/rear/layout/prepare/default/205_s390_enable_disk.sh</strong><br />
dasd drive on rhel... needs to be enabled before partitioning, is this a
good place?</p>
<p><strong>usr/share/rear/layout/save/GNU/Linux/200_partition_layout.sh</strong><br />
currently putting dasd info, specifically bus-id, info in
disklayout.conf<br />
echo "dasd_channel $( lsdasd|grep dasd|awk '{ print $1 " " $2 " " $3 "
" $4}' )"<br />
putting it here simplifies 200_partition_layout.sh. would probably
need to write another loop over sys/block if we do not put it in
disklayout.conf unless you know a bash way to direct the stdout temp to
another file in the loop. does this potentially break anything?</p>
<pre><code>Bus-ID     Status      Name      Device  Type  BlkSz  Size      Blocks
==============================================================================
0.0.0100   active      dasda     94:0    ECKD  4096   23034MB   5896800
</code></pre>
<h4 id="jsmeix_commented_at_2019-06-25_0751"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-505330190">2019-06-25 07:51</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-06-25_0751" title="Permanent link">&para;</a></h4>
<p>@mutable-dan<br />
to have different code for different Linux distributions<br />
I recommend to use OS_MASTER_VENDOR<br />
because that is more general as OS_VENDOR</p>
<p>Regarding how OS_MASTER_VENDOR is set see<br />
usr/share/rear/lib/config-functions.sh</p>
<p>Accordingly code like the following is fine:</p>
<pre><code>if test "SUSE_LINUX" = $OS_VENDOR ; then
    # Special case for SUSE
    ...
else
    # Generic case for all other Linux distributions 
    ...
fi
</code></pre>
<p>Probably even better because the <code>case</code> construct can be more easily<br />
enhanced and adapted if needed in the future for more Linux
distributions:</p>
<pre><code>case $OS_MASTER_VENDOR in
    (SUSE)
        # Specific code for SUSE
        ...
        ;;
    (Fedora)
        # Specific code for Fedora, Red Hat, CentOS, Scientific Linux, and Oracle Linux
        ...
        ;;
    (Debian)
        # Specific code for Debian, Ubuntu, and Linux Mint
        ...
        ;;
    (Arch)
        # Specific code for Arch Linux
        ...
        ;;
    (*)
        # Generic default case
        ...
        ;;
esac
</code></pre>
<p>cf. <code>get_part_device_name_format()</code>
usr/share/rear/lib/layout-functions.sh</p>
<hr />
<p>Regarding
<code>dasd drive on rhel... needs to be enabled before partitioning</code>:</p>
<p>In your
usr/share/rear/layout/prepare/default/205_s390_enable_disk.sh<br />
I do not see how you write the commands to enable a dasd drive<br />
into the disrkrestore.sh file - I would expect code like</p>
<pre><code>    cat &gt;&gt; "$LAYOUT_CODE" &lt;&lt;EOF
# enable the dasd device on $bus (i.e. sets the device online)
chccwdev -e $bus
EOF
</code></pre>
<p>cf.
usr/share/rear/layout/prepare/GNU/Linux/100_include_partition_code.sh</p>
<p>I would add the dasd drive enable code to the <code>create_disk()</code> function
in<br />
usr/share/rear/layout/prepare/GNU/Linux/100_include_partition_code.sh<br />
e.g. something like</p>
<pre><code>if [[ "$ARCH" == "Linux-s390" &amp;&amp; "$OS_VENDOR" != "SUSE_LINUX" ]] ; then

   cat &gt;&gt; "$LAYOUT_CODE" &lt;&lt;EOF
# enable the dasd device on $bus (i.e. sets the device online)
chccwdev -e $bus
EOF

fi
</code></pre>
<p>but I do not know about Red Hat on IBM Z so perhaps a separated script<br />
is better.</p>
<p>In any case you must never call commands that change a disk directly<br />
cf. my
<a href="https://github.com/rear/rear/pull/2142#issuecomment-503152699">https://github.com/rear/rear/pull/2142#issuecomment-503152699</a><br />
all those commands must hapen via the disrkrestore.sh script.</p>
<p>I do not know if <code>chccwdev -e $bus</code> actually changes an existing disk.</p>
<p>According to<br />
<a href="https://www.ibm.com/support/knowledgecenter/en/linuxonibm/com.ibm.linux.z.lgdd/lgdd_r_chccwdev_cmd.html">https://www.ibm.com/support/knowledgecenter/en/linuxonibm/com.ibm.linux.z.lgdd/lgdd_r_chccwdev_cmd.html</a></p>
<pre><code>Use the chccwdev command to set attributes for CCW devices
and to set CCW devices online or offline.
</code></pre>
<p>the chccwdev command can set attributes which seems it<br />
can actually change an existing disk.</p>
<p>In general I would prefer to have all commands that are needed<br />
to set up the disks in the disrkrestore.sh script - i.e. also needed<br />
commands that do not actually change a disk.</p>
<p>Reason:</p>
<p>I would prefer to have the disrkrestore.sh script complete<br />
so that the user could use that script alone on bare metal<br />
to set up the disks, cf. my above<br />
<a href="https://github.com/rear/rear/pull/2142#issuecomment-503152699">https://github.com/rear/rear/pull/2142#issuecomment-503152699</a></p>
<pre><code>The diskrestore.sh script is the one and only piece of code
that recreates the disk layout
</code></pre>
<p>I know in current ReaR this is not always true.<br />
There is some "initial preparation stuff" elsewhere<br />
(e.g. there could be some special <code>udev</code> scripts and<br />
there are initially needed commands like <code>mpathconf</code><br />
and initially needed services like <code>multipathd</code>, cf.<br />
usr/share/rear/layout/prepare/GNU/Linux/210_load_multipath.sh).<br />
But I think the goal should be to try to have as much as possible<br />
in the disrkrestore.sh script (as far as possible with reasonable
effort).</p>
<hr />
<p>Regarding
<code>putting dasd info, specifically bus-id, info in disklayout.conf</code></p>
<p>I think it is fine to put such info into disklayout.conf<br />
as long as the general disklayout.conf syntax</p>
<pre><code># a comment
unique_component_keyword first_value  second_value ...
</code></pre>
<p>is used, cf. the section "Disk layout file syntax" in<br />
<a href="https://github.com/rear/rear/blob/master/doc/user-guide/06-layout-configuration.adoc">https://github.com/rear/rear/blob/master/doc/user-guide/06-layout-configuration.adoc</a><br />
in particular</p>
<pre><code>None of the component keywords is a leading substring
of another component keyword
</code></pre>
<p>so your new component keyword <code>dasd_channel</code> is o.k.<br />
because there is no component keyword <code>dasd</code>.</p>
<h4 id="mutable-dan_commented_at_2019-06-25_2204"><img src="https://avatars.githubusercontent.com/u/50145067?u=0b8898582fe782d29312c1d9a3c689216efdbade&v=4" width="50"><a href="https://github.com/mutable-dan">mutable-dan</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-505640413">2019-06-25 22:04</a>:<a class="headerlink" href="#mutable-dan_commented_at_2019-06-25_2204" title="Permanent link">&para;</a></h4>
<p>@jsmeix<br />
I am looking at your comments above....</p>
<p>Also looking at the networking.</p>
<p>on rhel the network devices are not enabled on boot:<br />
/sys/class/net/*<br />
has no devices and thus can not find a MAC</p>
<p>the manual process would be to (without persisting device info)<br />
scan the devices</p>
<pre><code>znetconf -u
Scanning for network devices...
Device IDs                 Type    Card Type      CHPID Drv.
------------------------------------------------------------
0.0.0600,0.0.0601,0.0.0602 1731/01 OSA (QDIO)        00 qeth
0.0.0610,0.0.0611,0.0.0612 1731/01 OSA (QDIO)        02 qeth
0.0.7400,0.0.7401,0.0.7402 1731/05 HiperSockets      03 qeth
</code></pre>
<p>ignore the hipersockers<br />
then for each device</p>
<p>update:<br />
need to remove th ignore for each device scanned by znetconf -u
(excluding hipersockets)</p>
<pre><code>cio_ignore -r 0.0.0600,0.0.0601,0.0.0602
cio_ignore -r 0.0.0610,0.0.0611,0.0.0612
</code></pre>
<p>then add the deivces:</p>
<pre><code>znetconf -a 0600
Scanning for network devices...
Successfully configured device 0.0.0600 (enccw0.0.0600)

znetconf -a 0610
Scanning for network devices...
/bin/znetconf: line 560: echo: write error: No such device
znetconf: Error: Failed to make 0.0.0610 online
</code></pre>
<p>in this case 0610 is not configured</p>
<p>and for those added run:</p>
<pre><code>znetconf -a 0600
Scanning for network devices...
Successfully configured device 0.0.0600 (enccw0.0.0600)
</code></pre>
<p>this needs to be done before
etc/scripts/system-setup.d/55-migrate-network-devices.sh<br />
How would you propose doing this for zlinux only??<br />
Perhaps:</p>
<ul>
<li>write a 50-s390-add-network-device.sh to this dir if s390 and not
    suse --&gt; znetconf</li>
<li>in 55-migrate-network-devices.sh, check if znetconf exists and if
    /sys/class/net/ does not has a device --&gt; znetconf</li>
</ul>
<h4 id="jsmeix_commented_at_2019-06-26_1030"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-505818214">2019-06-26 10:30</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-06-26_1030" title="Permanent link">&para;</a></h4>
<p>@mutable-dan<br />
I think in the ReaR recovery system setup scripts</p>
<pre><code>usr/share/rear/skel/default/etc/scripts/system-setup
usr/share/rear/skel/default/etc/scripts/system-setup.d/*.sh
</code></pre>
<p>you don't have all those Linux distribution specific variables<br />
like <code>OS_MASTER_VENDOR</code> set because the recovery system setup scripts<br />
do not call the SetOSVendorAndVersion function in
lib/config-functions.sh<br />
so that in the recovery system setup scripts you cannot write code like</p>
<pre><code>if test "Fedora" = $OS_MASTER_VENDOR ; then
</code></pre>
<p>as you could do in "normal" ReaR scripts where "normal ReaR scripts"<br />
mean those scripts that are run when e.g. "rear mkbackup"<br />
or "rear recover" are run, i.e. scripts that run "within" usr/sbin/rear.</p>
<p>I think a new separated generic recovery system setup script</p>
<pre><code>usr/share/rear/skel/default/etc/scripts/system-setup.d/50-prepare-network-devices.sh
</code></pre>
<p>would be best to enable network devices as needed.</p>
<p>I think adding such code to the 55-migrate-network-devices.sh script is
wrong<br />
because it is not about migrating network devices.</p>
<p>I think the script name should not be specific for the architecture<br />
(i.e. no 's390' in the script name) so that this script can be also
used<br />
if neded on other architectures in the future.</p>
<p>Inside the script the code can do what is neded to distingush between<br />
different architectures.</p>
<p>On SUSE we also have /sbin/znetconf (via our s390-tools RPM) installed<br />
so that you cannot distinguish between RHEL and SLES whether or not<br />
a command <code>znetconf</code> exists.</p>
<p>E.g. on my s390 test system I get</p>
<pre><code># znetconf -u
Scanning for network devices...
Device IDs                 Type    Card Type      CHPID Drv. 
------------------------------------------------------------
0.0.0700,0.0.0701,0.0.0702 1731/01 OSA (QDIO)        01 qeth

# znetconf -a 0700
Scanning for network devices...
Successfully configured device 0.0.0700 (eth1)

# znetconf -c
Device IDs                 Type    Card Type      CHPID Drv. Name             State  
-------------------------------------------------------------------------------------
0.0.0800,0.0.0801,0.0.0802 1731/01 Virt.NIC QDIO     00 qeth eth0             online 
0.0.0700,0.0.0701,0.0.0702 1731/01 Virt.NIC QDIO     01 qeth eth1             online
</code></pre>
<p>But I assume when a command <code>znetconf</code> exists<br />
(i.e. this is the test to find out we are on s390 architecture)<br />
you can run <code>znetconf -u</code> and <code>znetconf -a</code> in any case<br />
and nothing will go actually wrong so that<br />
on RHEL the code would enable network devices while<br />
on SLES the same code would actually do nothing.</p>
<p>To distinguish the architecture it seems you can use<br />
the <code>ARCH</code> variable in recovery system setup scripts<br />
because usr/share/rear/skel/default/etc/scripts/system-setup<br />
sources /usr/share/rear/conf/default.conf which sets <code>ARCH</code>.</p>
<h4 id="jsmeix_commented_at_2019-06-26_1035"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-505819614">2019-06-26 10:35</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-06-26_1035" title="Permanent link">&para;</a></h4>
<p>@mutable-dan<br />
FYI:<br />
The main networking setup in the ReaR recovery system<br />
happens during "rear mkrescue/mkbackup" via</p>
<pre><code>usr/share/rear/rescue/GNU/Linux/310_network_devices.sh
</code></pre>
<p>that generates an additional recovery system setup script</p>
<pre><code>$ROOTFS_DIR/etc/scripts/system-setup.d/60-network-devices.sh
</code></pre>
<p>which is only in the ReaR recovery system.<br />
To see what files there are in your particular ReaR recovery system<br />
after you did run "rear mkrescue/mkbackup" specify</p>
<pre><code>KEEP_BUILD_DIR="yes"
</code></pre>
<p>in you etc/rear/local.conf - cf. my a bit outdated etc/rear/local.conf
in<br />
<a href="https://github.com/rear/rear/pull/2142#issuecomment-494426331">https://github.com/rear/rear/pull/2142#issuecomment-494426331</a><br />
my current etc/rear/local.conf is</p>
<pre><code>OUTPUT=RAMDISK
BACKUP=NETFS
BACKUP_OPTIONS="nfsvers=3,nolock"
BACKUP_URL=nfs://10.160.67.243/nfs
SSH_ROOT_PASSWORD="rear"
USE_DHCLIENT="yes"
KEEP_BUILD_DIR="yes"
FIRMWARE_FILES=( 'no' )
PROGRESS_MODE="plain"
PROGRESS_WAIT_SECONDS="5"
</code></pre>
<p>and see the KEEP_BUILD_DIR description in default.conf</p>
<h4 id="mutable-dan_commented_at_2019-06-28_2300"><img src="https://avatars.githubusercontent.com/u/50145067?u=0b8898582fe782d29312c1d9a3c689216efdbade&v=4" width="50"><a href="https://github.com/mutable-dan">mutable-dan</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-506900480">2019-06-28 23:00</a>:<a class="headerlink" href="#mutable-dan_commented_at_2019-06-28_2300" title="Permanent link">&para;</a></h4>
<p>@jsmeix<br />
see
<a href="https://github.com/rear/rear/pull/2142#issuecomment-505818214">https://github.com/rear/rear/pull/2142#issuecomment-505818214</a><br />
I have updated 310_network_device to write to
scripts/system-setup.d/50-prepare-network-device.sh<br />
tested on rhel</p>
<p>see
<a href="https://github.com/rear/rear/pull/2142#issuecomment-505330190">https://github.com/rear/rear/pull/2142#issuecomment-505330190</a></p>
<blockquote>
<p>In your
usr/share/rear/layout/prepare/default/205_s390_enable_disk.sh<br />
I do not see how you write the commands to enable a dasd drive<br />
into the disrkrestore.sh file - I would expect code like</p>
</blockquote>
<p>for the 205_s90_enable disk, i tried writing to diskrestore.sh but had
some problems:<br />
currently i am not using zipl to mod the boot loader so it boots, runs
the scripts (which enable the networking device) i then run rear
recover<br />
<code>specifically rear -vDd recover</code><br />
but the dasd devices are not enabled because diskrestore has not run and
i had changed layout/prepare/default/205_s390_enable_disk.sh to
conditionally write to diskrestore.sh</p>
<p>when does diskrestore run?<br />
is it called by the recover or meant to run manually?<br />
if manually, should the dasd disks also be enabled in
layout/prepare/default/205_s390_enable_disk.sh</p>
<h4 id="jsmeix_commented_at_2019-07-01_0824"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-507167430">2019-07-01 08:24</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-07-01_0824" title="Permanent link">&para;</a></h4>
<p>@mutable-dan<br />
in general to get a better idea which scripts are run when<br />
use the simulation mode via the <code>-s</code> option like (excerpt)</p>
<pre><code># rear -s recover
...
Source layout/prepare/GNU/Linux/100_include_partition_code.sh
...
Source layout/prepare/default/540_generate_device_code.sh
...
Source layout/recreate/default/100_confirm_layout_code.sh
Source layout/recreate/default/200_run_layout_code.sh
</code></pre>
<p>usually the <code>layout/prepare/.../...include...code.sh</code> scripts<br />
contain only functions that are run later,<br />
the layout/prepare/default/540_generate_device_code.sh<br />
generates the <code>diskrestore.sh</code> script,<br />
the layout/recreate/default/100_confirm_layout_code.sh<br />
is a user dialog that appears in MIGRATION_MODE<br />
where the user can edit the <code>diskrestore.sh</code> script if neded,<br />
finally the <code>diskrestore.sh</code> script is run by<br />
the layout/recreate/default/200_run_layout_code.sh script.</p>
<p>I would recommend to run "rear recover" in MIGRATION_MODE via</p>
<pre><code># export MIGRATION_MODE="true"

# rear -D recover
</code></pre>
<p>This way you get several user dialogs that you can confirm step by
step.<br />
In each one you can also <code>Use Relax-and-Recover shell</code><br />
and return back to that particular user dialog.<br />
In the Relax-and-Recover shell you can inspect or even adapt<br />
the system at that state during the "rear recover" process.</p>
<p>For example this way you could manually enable your dasd disks<br />
before the <code>diskrestore.sh</code> script is run to find out what exact<br />
command works for you to enable your dasd disks.<br />
Or you could add that command to your <code>diskrestore.sh</code> script.</p>
<h4 id="mutable-dan_commented_at_2019-07-02_2125"><img src="https://avatars.githubusercontent.com/u/50145067?u=0b8898582fe782d29312c1d9a3c689216efdbade&v=4" width="50"><a href="https://github.com/mutable-dan">mutable-dan</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-507850532">2019-07-02 21:25</a>:<a class="headerlink" href="#mutable-dan_commented_at_2019-07-02_2125" title="Permanent link">&para;</a></h4>
<p>see
<a href="https://github.com/rear/rear/pull/2142#issuecomment-505330190">https://github.com/rear/rear/pull/2142#issuecomment-505330190</a></p>
<blockquote>
<p>In your
usr/share/rear/layout/prepare/default/205_s390_enable_disk.sh<br />
I do not see how you write the commands to enable a dasd drive<br />
into the disrkrestore.sh file - I would expect code like</p>
</blockquote>
<p><strong>I don't see where disrkrestore.sh gets called</strong></p>
<h3 id="below_are_all_the_scripts_called">Below are all the scripts called<a class="headerlink" href="#below_are_all_the_scripts_called" title="Permanent link">&para;</a></h3>
<h4 id="on_boot">on boot:<a class="headerlink" href="#on_boot" title="Permanent link">&para;</a></h4>
<hr />
<pre><code>Running 00-functions.sh...
Running 01-run-ldconfig.sh...
Running 10-console-setup.sh...
Running 20-check-boot-options.sh...
Running 40-start-udev-or-load-modules.sh...
Running 41-load-special-modules.sh...
Running 42-engage-scsi.sh...
Running 45-serial-console.sh...
Running 50-prepare-network-devices.sh...  &lt;----------------------- zlinux rhel enable network devices
Running 55-migrate-network-devices.sh...
Running 58-start-dhclient.sh...
Running 60-network-devices.sh...
Running 62-routing.sh...
Running 65-sysctl.sh...
Running 99-makedev.sh...
</code></pre>
<h5 id="right_now_zipl_is_not_called_to_setup_the_boot_loader_so_rear_is_not_called_by_the_boot_recovery">Right now zipl is not called to setup the boot loader so rear is not called by the boot recovery<a class="headerlink" href="#right_now_zipl_is_not_called_to_setup_the_boot_loader_so_rear_is_not_called_by_the_boot_recovery" title="Permanent link">&para;</a></h5>
<p>(I need to look into the proper sequences)</p>
<h4 id="rear_-vdd_recover_-_or_as_you_mentioned_rear_-s_recover">rear -vDd recover - or as you mentioned, rear -s recover<a class="headerlink" href="#rear_-vdd_recover_-_or_as_you_mentioned_rear_-s_recover" title="Permanent link">&para;</a></h4>
<hr />
<pre><code>Relax-and-Recover 2.4 / Git
Running rear recover (PID 1465)
Using log file: /var/log/rear/rear-red72a1.log
Simulation mode activated, Relax-and-Recover base directory: /usr/share/rear
Source conf/GNU/Linux.conf
Source init/default/005_verify_os_conf.sh
Source init/default/010_EFISTUB_check.sh
Source init/default/010_set_drlm_env.sh
Source init/default/030_update_recovery_system.sh
Source init/default/050_check_rear_recover_mode.sh
Source init/default/950_check_missing_programs.sh
Source setup/default/005_ssh_agent_start.sh
Source setup/default/010_pre_recovery_script.sh
Source verify/default/020_cciss_scsi_engage.sh
Source verify/default/020_translate_url.sh
Source verify/default/030_translate_tape.sh
Source verify/default/040_validate_variables.sh
Source verify/default/050_create_mappings_dir.sh
Source verify/GNU/Linux/050_sane_recovery_check.sh
Source verify/GNU/Linux/230_storage_and_network_modules.sh
Source verify/GNU/Linux/260_recovery_storage_drivers.sh
Source layout/prepare/default/010_prepare_files.sh
Source layout/prepare/GNU/Linux/100_include_partition_code.sh
Source layout/prepare/GNU/Linux/110_include_lvm_code.sh
Source layout/prepare/GNU/Linux/120_include_raid_code.sh
Source layout/prepare/GNU/Linux/131_include_filesystem_code.sh
Source layout/prepare/GNU/Linux/133_include_mount_filesystem_code.sh
Source layout/prepare/GNU/Linux/135_include_btrfs_subvolumes_generic_code.sh
Source layout/prepare/GNU/Linux/136_include_btrfs_subvolumes_SLES_code.sh
Source layout/prepare/GNU/Linux/140_include_swap_code.sh
Source layout/prepare/GNU/Linux/150_include_drbd_code.sh
Source layout/prepare/GNU/Linux/160_include_luks_code.sh
Source layout/prepare/GNU/Linux/170_include_hpraid_code.sh
Source layout/prepare/GNU/Linux/180_include_opaldisk_code.sh
Source layout/prepare/default/200_recreate_hpraid.sh
Source layout/prepare/default/205_s390_enable_disk.sh   &lt;----------------------- does chccwdev -e [channel] from disklayout.conf :-o
Source layout/prepare/GNU/Linux/210_load_multipath.sh
Source layout/prepare/default/250_compare_disks.sh
Source layout/prepare/default/270_overrule_migration_mode.sh
Source layout/prepare/default/300_map_disks.sh
Source layout/prepare/default/310_remove_exclusions.sh
Source layout/prepare/default/320_apply_mappings.sh
Source layout/prepare/default/420_autoresize_last_partitions.sh
Source layout/prepare/default/430_autoresize_all_partitions.sh
Source layout/prepare/default/500_confirm_layout_file.sh
Source layout/prepare/default/510_list_dependencies.sh
Source layout/prepare/default/520_exclude_components.sh
Source layout/prepare/default/540_generate_device_code.sh
Source layout/prepare/default/550_finalize_script.sh
Source layout/prepare/default/600_show_unprocessed.sh
Source layout/prepare/default/610_exclude_from_restore.sh
Source layout/recreate/default/100_confirm_layout_code.sh
Source layout/recreate/default/200_run_layout_code.sh
Source layout/recreate/default/250_verify_mount.sh
Source restore/Fedora/050_copy_dev_files.sh
Source restore/default/050_remount_async.sh
......
Source finalize/Fedora/s390/660_install_zipl.sh  &lt;------- will look at
Source finalize/default/880_check_for_mount_by_id.sh
Source finalize/default/890_finish_checks.sh
Source finalize/default/900_remount_sync.sh
Source wrapup/default/500_post_recovery_script.sh
Source wrapup/default/980_good_bye.sh
Source wrapup/default/990_copy_logfile.sh
Exiting rear recover (PID 1465) and its descendant processes ...
Running exit tasks
You should also rm -Rf /tmp/rear.3GFZkfaiyaAeaBG
</code></pre>
<h4 id="how_disks_are_enabled">How disks are enabled<a class="headerlink" href="#how_disks_are_enabled" title="Permanent link">&para;</a></h4>
<p>currently layout/prepare/default/205_s390_enable_disk.sh<br />
reads from /var/lib/rear/layout/disklayout.conf</p>
<pre><code>where:
   /usr/share/rear/layout/save/GNU/Linux/200_partition_layout.sh:363
      calls lsdasd and writes
         dasd_channel 0.0.0100 active dasda 94:0 --&gt; /var/lib/rear/layout/disklayout.conf
   i know that this is not part of the disklayout.conf spec
   one way to get around this (if we need to) is to have a separate device loop and write to another file

   We can't do lsdasd -a to get all device and then enable each of them
   because they are enabled as dasda, dasdb, dasdc, ... 
   and we don't know which channel belongs to which device
</code></pre>
<p>As mentioned, I don't see where disrkrestore.sh is called and if i do
not enable the disk devices before 250_compare_disks.sh then recovery
fails</p>
<h4 id="jsmeix_commented_at_2019-07-03_0804"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-507986721">2019-07-03 08:04</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-07-03_0804" title="Permanent link">&para;</a></h4>
<p>@mutable-dan</p>
<p>regarding the recovery system startup scripts in
etc/scripts/system-setup.d/</p>
<p>To debug issues with the recovery system startup scripts add <code>debug</code><br />
to the kernel command line when booting the ReaR recovery system.<br />
This way the recovery system startup scripts will be called with
<code>set -x</code> set<br />
and each one after you confirmed its execution with [Enter] so that
you<br />
can see for each one its <code>set -x</code> output on the console.</p>
<p>Regarding where disrkrestore.sh is called:</p>
<p>It is called by layout/recreate/default/200_run_layout_code.sh<br />
that runs disrkrestore.sh via <code>source $LAYOUT_CODE</code><br />
which happens in a user dialog while loop (excerpt):</p>
<pre><code># Run the disk layout recreation code (diskrestore.sh)
# again and again until it succeeds or the user aborts:
while true ; do
    # Run LAYOUT_CODE in a sub-shell because it sets 'set -e'
    # so that it exits the running shell in case of an error
    # but that exit must not exit this running bash here:
    ( source $LAYOUT_CODE )
</code></pre>
<h4 id="jsmeix_commented_at_2019-07-03_0817"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-507991041">2019-07-03 08:17</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-07-03_0817" title="Permanent link">&para;</a></h4>
<p>@mutable-dan<br />
FYI what I personally basically always do to get an initial idea<br />
what belongs to a certain "thingy" in all those ReaR scripts<br />
is searching through all those ReaR scripts for it like</p>
<pre><code># find usr/sbin/rear usr/share/rear/ -type f | xargs grep 'diskrestore'
</code></pre>
<p>or when I need primarily "suspicious" ReaR script file names</p>
<pre><code># find usr/sbin/rear usr/share/rear/ -type f | xargs grep -li 'diskrestore'
</code></pre>
<p>The main problem is to know how a certain "thingy" is called in ReaR<br />
e.g. <code>diskrestore.sh</code> or <code>LAYOUT_CODE</code> versus<br />
<code>disklayout.conf</code> or <code>LAYOUT_FILE</code> or <code>DISKLAYOUT_FILE</code><br />
cf.
<a href="https://github.com/rear/rear/issues/718">https://github.com/rear/rear/issues/718</a></p>
<h4 id="mutable-dan_commented_at_2019-07-17_2027"><img src="https://avatars.githubusercontent.com/u/50145067?u=0b8898582fe782d29312c1d9a3c689216efdbade&v=4" width="50"><a href="https://github.com/mutable-dan">mutable-dan</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-512555313">2019-07-17 20:27</a>:<a class="headerlink" href="#mutable-dan_commented_at_2019-07-17_2027" title="Permanent link">&para;</a></h4>
<p>@jsmeix rhel 7 is in a working state:<br />
able to build the recovery kernel and initfs<br />
send it to zvm<br />
punch the kernel init and params and ipl the recovery machine<br />
run rear recovery, test that the dasd drives are partitioned with zipl
boot loader<br />
ipl the dasd bus-id to a recovered system</p>
<p>will look at sles while we put rhel through some more rigorous testing</p>
<h4 id="mutable-dan_commented_at_2019-07-25_1737"><img src="https://avatars.githubusercontent.com/u/50145067?u=0b8898582fe782d29312c1d9a3c689216efdbade&v=4" width="50"><a href="https://github.com/mutable-dan">mutable-dan</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-515140570">2019-07-25 17:37</a>:<a class="headerlink" href="#mutable-dan_commented_at_2019-07-25_1737" title="Permanent link">&para;</a></h4>
<p>@jsmeix will start testing sles15</p>
<h4 id="jsmeix_commented_at_2019-08-02_0950"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-517639167">2019-08-02 09:50</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-08-02_0950" title="Permanent link">&para;</a></h4>
<p>@mutable-dan<br />
take your time - I am not in the office for some weeks.<br />
I add @gdha as another reviewer so that this issue can be merged<br />
as soon as things work for you and when the changes look o.k. for us.</p>
<h4 id="mutable-dan_commented_at_2019-08-02_1614"><img src="https://avatars.githubusercontent.com/u/50145067?u=0b8898582fe782d29312c1d9a3c689216efdbade&v=4" width="50"><a href="https://github.com/mutable-dan">mutable-dan</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-517759806">2019-08-02 16:14</a>:<a class="headerlink" href="#mutable-dan_commented_at_2019-08-02_1614" title="Permanent link">&para;</a></h4>
<blockquote>
<p>@mutable-dan<br />
take your time - I am not in the office for some weeks.<br />
I add @gdha as another reviewer so that this issue can be merged</p>
</blockquote>
<p>sles15 is in dev<br />
rhel7.x is out of dev testing and going to proper testing</p>
<p>our additional minimum list of testing<br />
rhel 6.x, 8.x<br />
sles 11-15</p>
<h4 id="mutable-dan_commented_at_2019-08-08_2145"><img src="https://avatars.githubusercontent.com/u/50145067?u=0b8898582fe782d29312c1d9a3c689216efdbade&v=4" width="50"><a href="https://github.com/mutable-dan">mutable-dan</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-519699303">2019-08-08 21:45</a>:<a class="headerlink" href="#mutable-dan_commented_at_2019-08-08_2145" title="Permanent link">&para;</a></h4>
<p>@jsmeix @gdha</p>
<p>i am seeing the following error on sles15</p>
<pre><code>5641 Create subvolume '/mnt/local//@/boot/grub2/s390x-emu'
5642 ++++ btrfs subvolume list -a /mnt/local/
5643 ++++ sed -e 's/&lt;FS_TREE&gt;\///'
5644 ++++ grep ' @$'
5645 ++++ tr -s '[:blank:]' ' '
5646 ++++ cut -d ' ' -f 2
5647 +++ subvolumeID=257
5648 +++ btrfs subvolume set-default 257 /mnt/local/
5649 +++ umount /mnt/local/
5650 +++ test -x /usr/lib/snapper/installation-helper
5651 +++ LogPrintError '/usr/lib/snapper/installation-helper not executable may indicate an error with btrfs default subvolume setup for @/.snapshots/1/snapshot on /dev/dasda2'
5652 +++ Log '/usr/lib/snapper/installation-helper not executable may indicate an error with btrfs default subvolume setup for @/.snapshots/1/snapshot on /dev/dasda2'
5653 +++ echo '2019-08-08 16:08:33.436925452 /usr/lib/snapper/installation-helper not executable may indicate an error with btrfs default subvolume setup for @/.snapshots/1/snapsho
5654 2019-08-08 16:08:33.436925452 /usr/lib/snapper/installation-helper not executable may indicate an error with btrfs default subvolume setup for @/.snapshots/1/snapshot on /dev/
5655 +++ PrintError '/usr/lib/snapper/installation-helper not executable may indicate an error with btrfs default subvolume setup for @/.snapshots/1/snapshot on /dev/dasda2'
5656 +++ mount -t btrfs -o subvolid=0 -o rw,relatime,ssd,space_cache /dev/dasda2 /mnt/local/
5657 +++ umount /mnt/local/
5658 +++ mount -t btrfs -o rw,relatime,ssd,space_cache /dev/dasda2 /mnt/local/
5659 +++ mount -t btrfs
5660 +++ tr -s '[:blank:]' ' '
5661 +++ grep -q ' on /mnt/local/root '
5662 +++ test -d /mnt/local/root
5663 +++ mount -t btrfs -o rw,relatime,ssd,space_cache -o subvol=@/root /dev/dasda2 /mnt/local/root
5664 +++ mount -t btrfs
5665 +++ tr -s '[:blank:]' ' '
5666 +++ grep -q ' on /mnt/local/boot/grub2/s390x-emu '
5667 +++ test -d /mnt/local/boot/grub2/s390x-emu
5668 +++ mount -t btrfs -o rw,relatime,ssd,space_cache -o subvol=@/boot/grub2/s390x-emu /dev/dasda2 /mnt/local/boot/grub2/s390x-emu
5669 +++ mount -t btrfs
5670 +++ tr -s '[:blank:]' ' '
5671 +++ grep -q ' on /mnt/local/tmp '
5672 +++ test -d /mnt/local/tmp
5673 +++ mount -t btrfs -o rw,relatime,ssd,space_cache -o subvol=@/tmp /dev/dasda2 /mnt/local/tmp
5674 +++ mount -t btrfs
5675 +++ tr -s '[:blank:]' ' '
5676 +++ grep -q ' on /mnt/local/.snapshots '
5677 +++ test -d /mnt/local/.snapshots
5678 +++ mkdir -p /mnt/local/.snapshots
5679 +++ mount -t btrfs -o rw,relatime,ssd,space_cache -o subvol=@/.snapshots /dev/dasda2 /mnt/local/.snapshots
5680 mount: /mnt/local/.snapshots: wrong fs type, bad option, bad superblock on /dev/dasda2, missing codepage or helper program, or other error.
</code></pre>
<p>the mount:</p>
<pre><code>mount -t btrfs -o rw,relatime,ssd,space_cache -o subvol=@/root /dev/dasda2 /mnt/local/root
</code></pre>
<p>is failing. i played around with the mount cmd...</p>
<pre><code>lsblk -f
NAME     FSTYPE LABEL UUID                                 MOUNTPOINT
dasda                                                      
|-dasda1                                                   
|-dasda2 btrfs        2829d9d0-d58f-4aaf-a6a8-d1ed02b3a78c /mnt/local
`-dasda3
</code></pre>
<p>i am wondering if<br />
<code>/usr/lib/snapper/installation-helper</code><br />
is needed</p>
<p>i saw this older issue:
<a href="https://github.com/rear/rear/issues/944">https://github.com/rear/rear/issues/944</a></p>
<p>I have just started to look at it but thought you might have some
insight?</p>
<h4 id="jsmeix_commented_at_2019-08-09_0519"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-519781753">2019-08-09 05:19</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-08-09_0519" title="Permanent link">&para;</a></h4>
<p>For SLES 12 and 15 with its special default btrfs structure<br />
you need a special ReaR config, see the SLE* example config files in<br />
usr/share/rear/conf/examples in particular for SLES 15 use<br />
<a href="https://github.com/rear/rear/blob/master/usr/share/rear/conf/examples/SLE12-SP2-btrfs-example.conf">https://github.com/rear/rear/blob/master/usr/share/rear/conf/examples/SLE12-SP2-btrfs-example.conf</a><br />
as template.<br />
Terein see the comments how to add the right btrfs subvolumes to the
backup.</p>
<p>Alternatively to simplify testing use a simpler SLES system without
btrfs<br />
e.g. with only a single ext4 filesystem, cf. the section<br />
"First steps with Relax-and-Recover" therein in particular item 3. at<br />
<a href="https://en.opensuse.org/SDB:Disaster_Recovery">https://en.opensuse.org/SDB:Disaster_Recovery</a></p>
<h4 id="mutable-dan_commented_at_2019-09-10_2046"><img src="https://avatars.githubusercontent.com/u/50145067?u=0b8898582fe782d29312c1d9a3c689216efdbade&v=4" width="50"><a href="https://github.com/mutable-dan">mutable-dan</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-530112270">2019-09-10 20:46</a>:<a class="headerlink" href="#mutable-dan_commented_at_2019-09-10_2046" title="Permanent link">&para;</a></h4>
<p>@jsmeix</p>
<p>hi,<br />
on rescue boot, i am seeing:</p>
<p>summary:</p>
<p><code>systemd: Running with unpopulated /etc. systemd: Failed to populate /etc with preset unit settings, ignoring: Invalid argument</code></p>
<p>Do you know what this means?</p>
<p>long:</p>
<pre><code>Ý    3.561919¨ Loaded X.509 cert 'Red Hat Enterprise Linux kernel signing key: 0
26b6326e6920a99e57c526059c3007a11236fc8'
Ý    3.561936¨ registered taskstats version 1
Ý    3.562283¨ Freeing unused kernel memory: 676K (b81000 - c2a000)
Ý    3.567292¨ ip_tables: (C) 2000-2006 Netfilter Core Team
Ý    3.567307¨ systemdÝ1¨: Inserted module 'ip_tables'
Ý    3.569119¨ random: systemd: uninitialized urandom read (16 bytes read)
Ý    3.569560¨ random: systemd: uninitialized urandom read (16 bytes read)
Ý    3.573099¨ systemdÝ1¨: systemd 219 running in system mode. (+PAM +AUDIT +SEL
INUX +IMA -APPARMOR +SMACK +SYSVINIT +UTMP +LIBCRYPTSETUP +GCRYPT +GNUTLS +ACL +
XZ +LZ4 -SECCOMP +BLKID +ELFUTILS +KMOD +IDN)
Ý    3.573286¨ systemdÝ1¨: Detected virtualization zvm.
Ý    3.573293¨ systemdÝ1¨: Detected architecture s390x.
Ý    3.573299¨ systemdÝ1¨: Running with unpopulated /etc.

Welcome to  Ý0;31mRed Hat Enterprise Linux Server 7.6 (Maipo) Ý0m!

Ý    3.573367¨ systemdÝ1¨: Set hostname to &lt;r76a1&gt;.
Ý    3.573383¨ random: systemd: uninitialized urandom read (16 bytes read)
Ý    3.573387¨ systemdÝ1¨: Initializing machine ID from random generator.
Ý    3.574060¨ random: systemd: uninitialized urandom read (16 bytes read)
Ý    3.574355¨ random: systemd: uninitialized urandom read (16 bytes read)
Ý    3.574889¨ random: systemd: uninitialized urandom read (16 bytes read)
Ý    3.575209¨ systemdÝ1¨: Failed to populate /etc with preset unit settings, ig
noring: Invalid argument
Ý    3.577334¨ random: systemd: uninitialized urandom read (16 bytes read)
Ý    3.577351¨ random: systemd: uninitialized urandom read (16 bytes read)
Ý    3.577406¨ random: systemd: uninitialized urandom read (16 bytes read)
Ý    3.578011¨ random: systemd: uninitialized urandom read (16 bytes read)
Ý    3.580211¨ systemdÝ1¨: Reached target System Initialization.
Ý Ý32m  OK   Ý0m¨ Reached target System Initialization.
Ý    3.580494¨ systemdÝ1¨: Created slice -.slice.
Ý Ý32m  OK   Ý0m¨ Created slice -.slice.
Ý    3.580546¨ systemdÝ1¨: Listening on Syslog Socket.
Ý Ý32m  OK   Ý0m¨ Listening on Syslog Socket.
Ý    3.580580¨ systemdÝ1¨: Listening on Delayed Shutdown Socket.
Ý Ý32m  OK   Ý0m¨ Listening on Delayed Shutdown Socket.
Ý    3.580724¨ systemdÝ1¨: Created slice system.slice.
Ý Ý32m  OK   Ý0m¨ Created slice system.slice.
Ý    3.580810¨ systemdÝ1¨: Listening on udev Control Socket.
Ý Ý32m  OK   Ý0m¨ Listening on udev Control Socket.
Ý    3.580911¨ systemdÝ1¨: Created slice system-getty.slice.
Ý Ý32m  OK   Ý0m¨ Created slice system-getty.slice.
Ý    3.580980¨ systemdÝ1¨: Listening on udev Kernel Socket.
Ý Ý32m  OK   Ý0m¨ Listening on udev Kernel Socket.
Ý    3.581496¨ systemdÝ1¨: Starting udev Kernel Device Manager...
         Starting udev Kernel Device Manager...
Ý    3.582078¨ systemdÝ1¨: Starting udev Coldplug all Devices...
         Starting udev Coldplug all Devices...
Ý    3.582223¨ systemdÝ1¨: Created slice system-serial\x2dgetty.slice.
Ý Ý32m  OK   Ý0m¨ Created slice system-serial\x2dgetty.slice.
Ý    3.582879¨ systemdÝ1¨: Starting Relax-and-Recover boot script...
         Starting Relax-and-Recover boot script...
Ý    3.583582¨ systemdÝ1¨: Started Relax-and-Recover sshd service.
Ý Ý32m  OK   Ý0m¨ Started Relax-and-Recover sshd service.
Ý    3.587758¨ systemd-udevdÝ49¨: starting version 219
Ý    3.598385¨ systemdÝ1¨: Listening on Logging Socket.
Ý Ý32m  OK   Ý0m¨ Listening on Logging Socket.
Ý    3.598445¨ systemdÝ1¨: Listening on D-Bus System Message Bus Socket.
Ý Ý32m  OK   Ý0m¨ Listening on D-Bus System Message Bus Socket.
Ý    3.598520¨ systemdÝ1¨: Listening on Journal Socket.
Ý Ý32m  OK   Ý0m¨ Listening on Journal Socket.
Ý    3.598548¨ systemdÝ1¨: Reached target Sockets.
Ý Ý32m  OK   Ý0m¨ Reached target Sockets.
Ý    3.599012¨ systemdÝ1¨: Started Journal Service.
Ý Ý32m  OK   Ý0m¨ Started Journal Service.
Ý    3.611874¨ systemdÝ1¨: Started udev Coldplug all Devices.
Ý Ý32m  OK   Ý0m¨ Started udev Coldplug all Devices.
Ý Ý32m  OK   Ý0m¨ Started udev Kernel Device Manager.
Ý Ý32m  OK   Ý0m¨ Reached target Basic System.
         Starting Initialize Rescue System...
Ý Ý32m  OK   Ý0m¨ Started Relax-and-Recover boot script.
Ý Ý32m  OK   Ý0m¨ Found device /dev/hvc0.
Ý Ý32m  OK   Ý0m¨ Found device /dev/ttyS0.
Ý Ý32m  OK   Ý0m¨ Found device /dev/ttysclp0.

Verifying md5sums of the files in the Relax-and-Recover rescue system

md5sums are OK


Configuring Relax-and-Recover rescue system
</code></pre>
<h4 id="mutable-dan_commented_at_2019-09-10_2047"><img src="https://avatars.githubusercontent.com/u/50145067?u=0b8898582fe782d29312c1d9a3c689216efdbade&v=4" width="50"><a href="https://github.com/mutable-dan">mutable-dan</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-530112633">2019-09-10 20:47</a>:<a class="headerlink" href="#mutable-dan_commented_at_2019-09-10_2047" title="Permanent link">&para;</a></h4>
<blockquote>
<p>For SLES 12 and 15 with its special default btrfs structure<br />
you need a special ReaR config, see the SLE* example config files
in<br />
usr/share/rear/conf/examples in particular for SLES 15 use</p>
</blockquote>
<p>note: this is working....<br />
thx</p>
<h4 id="mutable-dan_commented_at_2019-09-19_2157"><img src="https://avatars.githubusercontent.com/u/50145067?u=0b8898582fe782d29312c1d9a3c689216efdbade&v=4" width="50"><a href="https://github.com/mutable-dan">mutable-dan</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-533324423">2019-09-19 21:57</a>:<a class="headerlink" href="#mutable-dan_commented_at_2019-09-19_2157" title="Permanent link">&para;</a></h4>
<p>@jsmeix<br />
adding ed for 3270 terminal editing<br />
currently working on getting recovery kernel to see the network device
for rhel76</p>
<h4 id="mutable-dan_commented_at_2019-09-19_2201"><img src="https://avatars.githubusercontent.com/u/50145067?u=0b8898582fe782d29312c1d9a3c689216efdbade&v=4" width="50"><a href="https://github.com/mutable-dan">mutable-dan</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-533325535">2019-09-19 22:01</a>:<a class="headerlink" href="#mutable-dan_commented_at_2019-09-19_2201" title="Permanent link">&para;</a></h4>
<p>@jsmeix<br />
adding ed line editor for 3270 editing<br />
good to keep this. currently using it while working on a networking
issue for the recovery kernel on rhel 76. not sure about this one.
recovery does not see any net devices</p>
<h4 id="mutable-dan_commented_at_2019-09-24_2306"><img src="https://avatars.githubusercontent.com/u/50145067?u=0b8898582fe782d29312c1d9a3c689216efdbade&v=4" width="50"><a href="https://github.com/mutable-dan">mutable-dan</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-534781898">2019-09-24 23:06</a>:<a class="headerlink" href="#mutable-dan_commented_at_2019-09-24_2306" title="Permanent link">&para;</a></h4>
<p>@jsmeix @gdha<br />
Having a problem with rhel 7.6:</p>
<ul>
<li>not loading kernel modules</li>
<li>not seeing qeth devices even after qeth, qeth_l2 (even l3) are
    loaded</li>
</ul>
<!-- -->

<pre><code>/etc/scripts/system-setup.d/01-run-ldconfig.sh: FAILED  (both 7.2 &amp; 7.6)
./etc/udev/udev.conf: FAILED
./root/rear/usr/share/rear/skel/default/etc/scripts/system-setup.d/01-run-ldcon??? FAILED
</code></pre>
<p>i put a set -x in 01-run-ldconfig.sh<br />
on boot it looks roughly the same up to
40-start-udev-or-load-modules.sh<br />
and 40-start-udev-or-load-modules.sh look the same</p>
<p>we verified it's not the vm, any thoughts?</p>
<h4 id="jsmeix_commented_at_2019-09-25_0939"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-534940458">2019-09-25 09:39</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-09-25_0939" title="Permanent link">&para;</a></h4>
<p>@mutable-dan<br />
I am not in the office since some weeks and for some more weeks<br />
so that I cannot do much for ReaR.<br />
I cannot try out or test anything for ReaR - in particular not on IBM
Z.<br />
I expect to be back in the office at about beginning of October.<br />
But I also expect that I have to do first and foremost other stuff with
higher priority.<br />
Cf.
<a href="https://github.com/rear/rear/issues/799#issuecomment-531247109">https://github.com/rear/rear/issues/799#issuecomment-531247109</a></p>
<p>Regarding RHEL specific things<br />
@rmetrich and @pcahyna<br />
are our Red Hat experts.</p>
<p>Currently we do not have a dedicated IBM Z specialist.<br />
Perhaps @schabrolles from IBM might be able to help<br />
but he is actually an IBM POWER specialist who is<br />
<code>currently in vacation till the end of the month</code><br />
and then <code>busy with client on-site requests</code><br />
cf.
<a href="https://github.com/rear/rear/pull/2232#issuecomment-531280327">https://github.com/rear/rear/pull/2232#issuecomment-531280327</a></p>
<h4 id="mutable-dan_commented_at_2019-11-05_2113"><img src="https://avatars.githubusercontent.com/u/50145067?u=0b8898582fe782d29312c1d9a3c689216efdbade&v=4" width="50"><a href="https://github.com/mutable-dan">mutable-dan</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-550022616">2019-11-05 21:13</a>:<a class="headerlink" href="#mutable-dan_commented_at_2019-11-05_2113" title="Permanent link">&para;</a></h4>
<p>adding support for kernel and initrd override for s390</p>
<h4 id="override_kernel_and_initrd_name_if_arch_is_s390_and_zvm_namingy_is_in_localconf">override kernel and initrd name if arch is s390 and ZVM_NAMING=Y is in local.conf<a class="headerlink" href="#override_kernel_and_initrd_name_if_arch_is_s390_and_zvm_namingy_is_in_localconf" title="Permanent link">&para;</a></h4>
<p>note: s390 kernel copy is only through nfs</p>
<p>s390 optional naming override of initrd and kernel to match the s390
filesytem naming conventions<br />
on s390 in ReaR, there is an option to name the initrd and kernel in the
form of VMID kernel, VMID initrd</p>
<p>file names on s390 are in the form of name type mode, we are concerned
with name and type<br />
if the vm name (cp q userid) is HOSTA then the files written will be
HOSTA kernel and HOSTA initrd</p>
<p>The reason for this option is that, on the flat filesytem of s390 with
many VM's there needs to be a way to organize the generated recoveries</p>
<p>vars needed:<br />
ZVM_NAMING - set in local.conf, if Y then enable naming override<br />
ZVM_KERNEL_NAME - keeps track of kernel name in results array
(internal)<br />
ARCH - override only if ARCH is Linux-s390 (internal)</p>
<p>initrd name override is handled in 900_create_initramfs.sh<br />
kernel name override is handled in 400_guess_kernel.sh<br />
kernel name override is handled in 950_copy_result_files.sh</p>
<h4 id="jsmeix_commented_at_2019-11-06_0927"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-550223676">2019-11-06 09:27</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-11-06_0927" title="Permanent link">&para;</a></h4>
<p>@mutable-dan<br />
thank you for your continuous work on this issue!</p>
<p>Please tell me when things are in a at least basically usable state for
you<br />
because I would like to merge this pull request as soon as it is<br />
sufficiently complete to provide a single useful piece of functionality.</p>
<p>There is no need to wait until all is done for full featured IBM Z
support.</p>
<p>As soon as IBM Z support is usable at least in a very basic way<br />
things should be merged into our ReaR GitHub master code<br />
so that other IBM Z users could try it out and test it<br />
which helps a lot to improve IBM Z support in ReaR.</p>
<h4 id="mutable-dan_commented_at_2019-11-06_1534"><img src="https://avatars.githubusercontent.com/u/50145067?u=0b8898582fe782d29312c1d9a3c689216efdbade&v=4" width="50"><a href="https://github.com/mutable-dan">mutable-dan</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-550364092">2019-11-06 15:34</a>:<a class="headerlink" href="#mutable-dan_commented_at_2019-11-06_1534" title="Permanent link">&para;</a></h4>
<p>@jsmeix</p>
<p>thank you.<br />
looking at some disk issues for LDL formatted disks. I would like to
wait until the end of this week before we discuss merging. CDL formatted
disks work fine, but not LDL<br />
SELinux kept us busy (recovery is a little different than non s390), I
will need to make some notes for the end users. Simple solution, but it
wasn't obvious</p>
<h4 id="mutable-dan_commented_at_2019-11-18_1826"><img src="https://avatars.githubusercontent.com/u/50145067?u=0b8898582fe782d29312c1d9a3c689216efdbade&v=4" width="50"><a href="https://github.com/mutable-dan">mutable-dan</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-555145699">2019-11-18 18:26</a>:<a class="headerlink" href="#mutable-dan_commented_at_2019-11-18_1826" title="Permanent link">&para;</a></h4>
<p>@jsmeix the LDL code is in testing, re-testing sles and then we can look
to merge</p>
<h4 id="jsmeix_commented_at_2019-11-19_0818"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-555386841">2019-11-19 08:18</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-11-19_0818" title="Permanent link">&para;</a></h4>
<p>@mutable-dan<br />
thank you for your current status notification!</p>
<h4 id="mutable-dan_commented_at_2019-11-21_2211"><img src="https://avatars.githubusercontent.com/u/50145067?u=0b8898582fe782d29312c1d9a3c689216efdbade&v=4" width="50"><a href="https://github.com/mutable-dan">mutable-dan</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-557295910">2019-11-21 22:11</a>:<a class="headerlink" href="#mutable-dan_commented_at_2019-11-21_2211" title="Permanent link">&para;</a></h4>
<p>@jsmeix when you ready, we are ready to begin the merge</p>
<h4 id="jsmeix_commented_at_2019-11-22_1244"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-557518186">2019-11-22 12:44</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-11-22_1244" title="Permanent link">&para;</a></h4>
<p>@mutable-dan<br />
thank you for the notification.<br />
I will re-do the review next week (as time permits).</p>
<h4 id="jsmeix_commented_at_2019-12-02_1050"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-560342506">2019-12-02 10:50</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-12-02_1050" title="Permanent link">&para;</a></h4>
<p>I would like to merge it tomorrow<br />
unless there are objections.</p>
<h4 id="jsmeix_commented_at_2019-12-02_1352"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-560405160">2019-12-02 13:52</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-12-02_1352" title="Permanent link">&para;</a></h4>
<p>@mutable-dan @gdha @rmetrich<br />
I did a lot of (hopefully correct) adaptions here.<br />
I would much appreciate it if you could review what I did.</p>
<h4 id="mutable-dan_commented_at_2019-12-02_1922"><img src="https://avatars.githubusercontent.com/u/50145067?u=0b8898582fe782d29312c1d9a3c689216efdbade&v=4" width="50"><a href="https://github.com/mutable-dan">mutable-dan</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-560542310">2019-12-02 19:22</a>:<a class="headerlink" href="#mutable-dan_commented_at_2019-12-02_1922" title="Permanent link">&para;</a></h4>
<p>@jsmeix</p>
<p>all of your changes look good. i moved 305_include_s390_tools.sh to
Linux-s390 dir and testing it.</p>
<p>will remove commented conditional once tests look ok</p>
<h4 id="jsmeix_commented_at_2019-12-03_0842"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-561060480">2019-12-03 08:42</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-12-03_0842" title="Permanent link">&para;</a></h4>
<p>@mutable-dan<br />
thank you for testing it!<br />
I will wait with merging it until you gave me an OK<br />
that you finished your testing and things work for you.</p>
<p>There is another script where I think that it could be moved<br />
into an architecture specific directory:</p>
<p>From<br />
usr/share/rear/layout/prepare/default/205_s390_enable_disk.sh<br />
to<br />
usr/share/rear/layout/prepare/Linux-s390/205_s390_enable_disk.sh</p>
<p>See<br />
<a href="https://github.com/rear/rear/blob/fb02447031edafb68685a93bc0ac9bdc911ab625/usr/share/rear/layout/prepare/default/205_s390_enable_disk.sh#L7">https://github.com/rear/rear/blob/fb02447031edafb68685a93bc0ac9bdc911ab625/usr/share/rear/layout/prepare/default/205_s390_enable_disk.sh#L7</a></p>
<p>That script has also several <code>FIXME:</code> comments from me<br />
because I do not understand the intent behind how<br />
the <code>echo</code> commands are meant to work in that script.</p>
<h4 id="mutable-dan_commented_at_2019-12-10_1751"><img src="https://avatars.githubusercontent.com/u/50145067?u=0b8898582fe782d29312c1d9a3c689216efdbade&v=4" width="50"><a href="https://github.com/mutable-dan">mutable-dan</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-564152688">2019-12-10 17:51</a>:<a class="headerlink" href="#mutable-dan_commented_at_2019-12-10_1751" title="Permanent link">&para;</a></h4>
<p>@jsmeix<br />
i do not see any outstanding issues, did i address all?<br />
thx</p>
<h4 id="jsmeix_commented_at_2019-12-13_1014"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-565384137">2019-12-13 10:14</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-12-13_1014" title="Permanent link">&para;</a></h4>
<p>@rmetrich<br />
you had</p>
<pre><code>requested changes on behalf of rear/contributors on May 13
</code></pre>
<p><a href="https://github.com/rear/rear/pull/2142#pullrequestreview-236492905">https://github.com/rear/rear/pull/2142#pullrequestreview-236492905</a><br />
which is meanwhile marked as resolved.</p>
<p>But the change request from your review at that time is still there<br />
so I would like to ask you to have one more look here<br />
and dismiss or re-confirm your change request.</p>
<h4 id="mutable-dan_commented_at_2019-12-13_1640"><img src="https://avatars.githubusercontent.com/u/50145067?u=0b8898582fe782d29312c1d9a3c689216efdbade&v=4" width="50"><a href="https://github.com/mutable-dan">mutable-dan</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-565512386">2019-12-13 16:40</a>:<a class="headerlink" href="#mutable-dan_commented_at_2019-12-13_1640" title="Permanent link">&para;</a></h4>
<blockquote>
<p>Now all looks OK to me from plain looking at the code<br />
so I would like to merge it next Monday<br />
unless there are objections.</p>
</blockquote>
<p>no objections, please move forward with the merge on monday.<br />
thank you</p>
<h4 id="jsmeix_commented_at_2019-12-16_1404"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-566074814">2019-12-16 14:04</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-12-16_1404" title="Permanent link">&para;</a></h4>
<p>@mutable-dan<br />
thank you for all your continuous work<br />
that you contributed to ReaR here!</p>
<h4 id="mutable-dan_commented_at_2019-12-16_1553"><img src="https://avatars.githubusercontent.com/u/50145067?u=0b8898582fe782d29312c1d9a3c689216efdbade&v=4" width="50"><a href="https://github.com/mutable-dan">mutable-dan</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-566120396">2019-12-16 15:53</a>:<a class="headerlink" href="#mutable-dan_commented_at_2019-12-16_1553" title="Permanent link">&para;</a></h4>
<p>@jsmeix<br />
thank you, glad to help, we will continue to help support, bug fix and
test releases, glad to have the pull request completed. thank you for
your help also.</p>
<p>we should make a wiki section on s390 (which i would be happy to
contribute to) to give people tips and support trying out zlinux. so
that others do not repeat our mistakes and hurdles.</p>
<p>for example:<br />
on rhel with selinux, it was necessary on booting the recovery to put
selinux=0 on the kernel cmdline.... ie in the zvm param file.</p>
<p>and<br />
3270 can be a challenge for those used to vt220</p>
<h4 id="jsmeix_commented_at_2019-12-16_1659"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-566148833">2019-12-16 16:59</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-12-16_1659" title="Permanent link">&para;</a></h4>
<p>@gdha<br />
is it possible to have a wiki section on "IBM Z" (a.k.a. "s390")<br />
where @mutable-dan could contribute to?</p>
<p>@mutable-dan<br />
don't worry about 3270 terminal,<br />
even I managed to use it (for some very limited meaning of "use")<br />
and who fails with 3270 terminal is not old enough to use IBM Z ;-)</p>
<h4 id="jsmeix_commented_at_2019-12-19_1643"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-567567867">2019-12-19 16:43</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-12-19_1643" title="Permanent link">&para;</a></h4>
<p>@mutable-dan @gdha<br />
I wonder if a wiki section on "IBM Z" is actually the right place<br />
because the wiki is outside of what is provided in ReaR itself.</p>
<p>I wonder if it is perhaps better to provide documentation about<br />
"ReaR on IBM Z (s390)" in the same way as other ReaR documentation<br />
<a href="https://github.com/rear/rear/tree/master/doc/user-guide">https://github.com/rear/rear/tree/master/doc/user-guide</a><br />
inside ReaR e.g. as <code>doc/user-guide/17-ReaR-on-IBM-Z-s390.adoc</code></p>
<h4 id="mutable-dan_commented_at_2019-12-19_2111"><img src="https://avatars.githubusercontent.com/u/50145067?u=0b8898582fe782d29312c1d9a3c689216efdbade&v=4" width="50"><a href="https://github.com/mutable-dan">mutable-dan</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-567678549">2019-12-19 21:11</a>:<a class="headerlink" href="#mutable-dan_commented_at_2019-12-19_2111" title="Permanent link">&para;</a></h4>
<p>@jsmeix @gdha<br />
having 17-rear....</p>
<p>makes sense, as it is a guide to s390 zlinux and not rear</p>
<h4 id="mutable-dan_commented_at_2020-01-02_1605"><img src="https://avatars.githubusercontent.com/u/50145067?u=0b8898582fe782d29312c1d9a3c689216efdbade&v=4" width="50"><a href="https://github.com/mutable-dan">mutable-dan</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-570253231">2020-01-02 16:05</a>:<a class="headerlink" href="#mutable-dan_commented_at_2020-01-02_1605" title="Permanent link">&para;</a></h4>
<p>you mentioned a document section<br />
<a href="https://github.com/rear/rear/tree/master/doc/user-guide">https://github.com/rear/rear/tree/master/doc/user-guide</a>
above, i also see there is a zlinux section in the wiki. i am thinking
that for the helper info discussed, you would want it in the wiki?</p>
<p>what would you want a branch made to handle this that will be merged
back on approval?</p>
<p>thx</p>
<h4 id="jsmeix_commented_at_2020-01-08_1213"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-572022181">2020-01-08 12:13</a>:<a class="headerlink" href="#jsmeix_commented_at_2020-01-08_1213" title="Permanent link">&para;</a></h4>
<p>@gdha<br />
could you describe us what<br />
<a href="https://github.com/rear/rear/wiki/zLinux">https://github.com/rear/rear/wiki/zLinux</a><br />
is intended for<br />
and where documentation about "ReaR on IBM Z (s390)"<br />
should be usually provided?</p>
<h4 id="wasifmoh_commented_at_2020-08-14_1010"><img src="https://avatars.githubusercontent.com/u/60352623?v=4" width="50"><a href="https://github.com/wasifmoh">wasifmoh</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-674001322">2020-08-14 10:10</a>:<a class="headerlink" href="#wasifmoh_commented_at_2020-08-14_1010" title="Permanent link">&para;</a></h4>
<p>Hi ,<br />
Was trying to test Rear 2.6 on s390x architecture , but the rpm build
fails , Can you please help me ?</p>
<pre><code>[root@test9 rear]# ls
COPYING  MAINTAINERS  Makefile  README.adoc  build  dist  doc  etc  packaging  tests  usr
[root@test9 rear]# make rpm 
rm -Rf dist build
rm -f build-stamp
make -C doc clean
make[1]: Entering directory `/data/rear/doc'
rm -f unconv.8 *.html *.xml
make -C user-guide clean
make[2]: Entering directory `/data/rear/doc/user-guide'
rm -f *.html *.svg *.xml
make[2]: Leaving directory `/data/rear/doc/user-guide'
make[1]: Leaving directory `/data/rear/doc'
== Validating scripts and configuration ==
find etc/ usr/share/rear/conf/ -name '*.conf' | xargs -n 1 bash -n
bash -n usr/sbin/rear
find . -name '*.sh' | xargs -n 1 bash -O extglob -O nullglob -n
find usr/share/rear -name '*.sh' | grep -v -E '(lib|skel|conf)' | while read FILE ; do \
    num=$(echo ${FILE##*/} | cut -c1-3); \
    if [[ "$num" = "000" || "$num" = "999" ]] ; then \
        echo "ERROR: script $FILE may not start with $num"; \
        exit 1; \
    else \
        if $( grep '[_[:alpha:]]' &lt;&lt;&lt; $num &gt;/dev/null 2&gt;&amp;1 ) ; then \
            echo "ERROR: script $FILE must start with 3 digits"; \
            exit 1; \
        fi; \
    fi; \
done
== Prepare manual ==
make -C doc man
make[1]: Entering directory `/data/rear/doc'
make[1]: Nothing to be done for `man'.
make[1]: Leaving directory `/data/rear/doc'
== Building archive rear-2.6-git.4110.df5e18b.master ==
rm -Rf build/rear-2.6-git.4110.df5e18b.master
mkdir -p dist build/rear-2.6-git.4110.df5e18b.master
tar -c --exclude-from=.gitignore --exclude=.gitignore --exclude=".??*" * | \
    tar -C build/rear-2.6-git.4110.df5e18b.master -x
== Rewriting packaging/rpm/rear.spec, packaging/debian/rear.dsc and usr/sbin/rear ==
sed -i.orig \
    -e 's#^Source:.*#Source: https://sourceforge.net/projects/rear/files/rear/2.6/rear-2.6-git.4110.df5e18b.master.tar.gz#' \
    -e 's#^Version:.*#Version: 2.6#' \
    -e 's#^%define rpmrelease.*#%define rpmrelease .git.4110.df5e18b.master#' \
    -e 's#^%setup.*#%setup -q -n rear-2.6-git.4110.df5e18b.master#' \
    build/rear-2.6-git.4110.df5e18b.master/packaging/rpm/rear.spec
sed -i.orig \
    -e 's#^Version:.*#Version: 2.6-0git.4110.df5e18b.master#' \
    build/rear-2.6-git.4110.df5e18b.master/packaging/debian/rear.dsc
sed -i.orig \
    -e 's#^readonly VERSION=.*#readonly VERSION=2.6-git.4110.df5e18b.master#' \
    -e 's#^readonly RELEASE_DATE=.*#readonly RELEASE_DATE="2020-08-10"#' \
    build/rear-2.6-git.4110.df5e18b.master/usr/sbin/rear
tar -czf dist/rear-2.6-git.4110.df5e18b.master.tar.gz -C build rear-2.6-git.4110.df5e18b.master
== Building SRPM package rear-2.6-git.4110.df5e18b.master ==
rpmbuild -ts --clean --nodeps \
    --define="_topdir /data/rear/build/rpmbuild" \
    --define="_sourcedir /data/rear/dist" \
    --define="_srcrpmdir /data/rear/dist" \
    --define "debug_package %{nil}" \
    dist/rear-2.6-git.4110.df5e18b.master.tar.gz
Wrote: /data/rear/dist/rear-2.6-1.git.4110.df5e18b.master.el7.src.rpm
Executing(--clean): /bin/sh -e /var/tmp/rpm-tmp.SaDiwM
+ umask 022
+ cd /data/rear/build/rpmbuild/BUILD
+ rm -rf rear-2.6-git.4110.df5e18b.master
+ exit 0
== Building RPM package rear-2.6-git.4110.df5e18b.master ==
rpmbuild --rebuild --clean \
    --define="_topdir /data/rear/build/rpmbuild" \
    --define="_rpmdir /data/rear/dist" \
    --define "_rpmfilename %%{NAME}-%%{VERSION}-%%{RELEASE}.%%{ARCH}.rpm" \
    --define "debug_package %{nil}" \
    dist/rear-2.6-1*.src.rpm
Installing dist/rear-2.6-1.git.4110.df5e18b.master.el7.src.rpm
error: Architecture is not included: s390x
make: *** [rpm] Error 1
[root@test9 rear]#
</code></pre>
<h4 id="wasifmoh_commented_at_2020-08-14_1012"><img src="https://avatars.githubusercontent.com/u/60352623?v=4" width="50"><a href="https://github.com/wasifmoh">wasifmoh</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-674001907">2020-08-14 10:12</a>:<a class="headerlink" href="#wasifmoh_commented_at_2020-08-14_1012" title="Permanent link">&para;</a></h4>
<pre><code>[root@test9 rear]# uname -a 
Linux test9 3.10.0-957.el7.s390x #1 SMP Thu Oct 4 16:53:20 EDT 2018 s390x s390x s390x GNU/Linux
[root@test9 rear]# lscpu
Architecture:          s390x
CPU op-mode(s):        32-bit, 64-bit
Byte Order:            Big Endian
CPU(s):                2
On-line CPU(s) list:   0,1
Thread(s) per core:    1
Core(s) per socket:    1
Socket(s) per book:    1
Book(s) per drawer:    1
Drawer(s):             2
Vendor ID:             IBM/S390
Machine type:          3906
BogoMIPS:              21881.00
Hypervisor:            z/VM 7.1.0
Hypervisor vendor:     IBM
Virtualization type:   full
Dispatching mode:      horizontal
L1d cache:             128K
L1i cache:             128K
L2d cache:             4096K
L2i cache:             2048K
L3 cache:              131072K
L4 cache:              688128K
Flags:                 esan3 zarch stfle msa ldisp eimm dfp edat etf3eh highgprs te vx vxd vxe gs sie
[root@test9 rear]#
</code></pre>
<h4 id="jsmeix_commented_at_2020-08-14_1230"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2142#issuecomment-674051276">2020-08-14 12:30</a>:<a class="headerlink" href="#jsmeix_commented_at_2020-08-14_1230" title="Permanent link">&para;</a></h4>
<p>@wasifmoh<br />
instead of trying to make a RPM locally<br />
(I think you do not need to have ReaR as RPM package to test it)<br />
I would recommend<br />
"Testing current ReaR upstream GitHub master code"<br />
as described in<br />
<a href="https://en.opensuse.org/SDB:Disaster_Recovery">https://en.opensuse.org/SDB:Disaster_Recovery</a></p>
<p>If you have issues with booting the ReaR recovery system<br />
on your replacement IBM Z virtual machine you may have a look at<br />
"Launching the ReaR recovery system via kexec" in<br />
<a href="https://en.opensuse.org/SDB:Disaster_Recovery">https://en.opensuse.org/SDB:Disaster_Recovery</a><br />
as a workaround.</p>
<p>See also the part about<br />
"Initial preliminary first basic support for IBM Z architecture" in<br />
<a href="https://github.com/rear/rear/blob/master/doc/rear-release-notes.txt#L202">https://github.com/rear/rear/blob/master/doc/rear-release-notes.txt#L202</a></p>
<p>Many thanks in advance for testing ReaR on IBM Z architecture!</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2024 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2019-05-09.2142.pr.merged.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/rear/rear-user-guide" class="fa fa-code-fork" style="color: #fcfcfc"> rear/rear-user-guide</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
