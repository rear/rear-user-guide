<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#1796 Issue closed: No code has been generated to recreate pv:/dev/mapper/mpathc_part2 (lvmdev) - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#1796 Issue closed: No code has been generated to recreate pv:/dev/mapper/mpathc_part2 (lvmdev)";
        var mkdocs_page_input_path = "issues/2018-05-04.1796.issue.closed.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/backup_netfs.html">Example of BACKUP=NETFS</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#1796 Issue closed: No code has been generated to recreate pv:/dev/mapper/mpathc_part2 (lvmdev)</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="1796_issue_closed_no_code_has_been_generated_to_recreate_pvdevmappermpathc_part2_lvmdev"><a href="https://github.com/rear/rear/issues/1796">#1796 Issue</a> <code>closed</code>: No code has been generated to recreate pv:/dev/mapper/mpathc_part2 (lvmdev)<a class="headerlink" href="#1796_issue_closed_no_code_has_been_generated_to_recreate_pvdevmappermpathc_part2_lvmdev" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>support / question</code>, <code>fixed / solved / done</code>,
<code>external tool</code></p>
<h4 id="bern66_opened_issue_at_2018-05-04_1232"><img src="https://avatars.githubusercontent.com/u/38959869?u=f7f85617d38f6bebe9285f89b6794b229152df0c&v=4" width="50"><a href="https://github.com/bern66">bern66</a> opened issue at <a href="https://github.com/rear/rear/issues/1796">2018-05-04 12:32</a>:<a class="headerlink" href="#bern66_opened_issue_at_2018-05-04_1232" title="Permanent link">&para;</a></h4>
<p>I am in the process to test ReaR. To test the restore, I use the same
machine where "rear mkrescue" was run. In the below output of "rear -D
recover" you can see the following messages:</p>
<pre><code>No code has been generated to recreate pv:/dev/mapper/mpathc_part2 (lvmdev).
    To recreate it manually add code to /var/lib/rear/layout/diskrestore.sh or abort.

UserInput -I ADD_CODE_TO_RECREATE_MISSING_PVDEVMAPPERMPATHCPART2LVMDEV needed in /usr/share/rear/layout/prepare/default/600_show_unprocessed.sh line 33

Manually add code that recreates pv:/dev/mapper/mpathc_part2 (lvmdev)
</code></pre>
<p>Do I really have to add code to complete a restore? Or did I missed
something while configuring the site.conf for my environment?</p>
<p>I really hope I will not have to add code at restore because we have
hundreds of systems. In a situation of DR it would be another problem on
the pile.</p>
<pre><code>RESCUE tstinf01:~ # rear -D recover
Relax-and-Recover 2.3 / 2018-04-20
Using log file: /var/log/rear/rear-tstinf01.log
Running workflow recover within the ReaR rescue/recovery system
Will do driver migration (recreating initramfs/initrd)
IBM Spectrum Protect
Command Line Backup-Archive Client Interface
  Client Version 8, Release 1, Level 2.0
  Client date/time: 05/04/18   11:07:05
(c) Copyright by IBM Corporation and other(s) 1990, 2017. All Rights Reserved.

eode Name: STSTINF01
Session established with server GISPA: Linux/x86_64
  Server Version 8, Release 1, Level 4.000
  Server date/time: 05/04/18   07:07:12  Last access: 05/04/18   07:06:39

Domain Name               : QAASBA
Activated Policy Set Name : QAASBA
Activation date/time      : 03/26/18   10:14:56
Default Mgmt Class Name   : QAASBA
Grace Period Backup Retn. : 30 day(s)
Grace Period Archive Retn.: 365 day(s)


MgmtClass Name                  : HDB
Description                     : Management Class for HANA Database


MgmtClass Name                  : HDBNL
Description                     : Management Class for HANA DB No Limit Retention


MgmtClass Name                  : HLOG
Description                     : Management Class for HANA Logs


MgmtClass Name                  : QAASBA
Description                     : MGMT Class default pour QAAS

TSM restores by default the latest backup data. Alternatively you can specify
a different date and time to enable Point-In-Time Restore. Press ENTER to
use the most recent available backup
Enter date/time (YYYY-MM-DD HH:mm:ss) or press ENTER [30 secs]:
Skipping Point-In-Time Restore, will restore most recent data.

The TSM Server reports the following for this node:
                  #     Last Incr Date          Type    Replication       File Space Name
                --------------------------------------------------------------------------------
                  1     01-05-2018 22:16:40     BTRFS   Current           /
                  2     01-05-2018 22:10:59     BTRFS   Current           /.snapshots
                  3     01-05-2018 22:11:12     BTRFS   Current           /boot/grub2/powerpc-ieee1275
                  4     01-05-2018 22:11:26     XFS     Current           /home
                  5     01-05-2018 22:11:38     BTRFS   Current           /opt
                  6     01-05-2018 22:11:12     BTRFS   Current           /srv
                  7     01-05-2018 22:11:20     BTRFS   Current           /usr/local
                  8     01-05-2018 22:11:14     BTRFS   Current           /var/cache
                  9     01-05-2018 22:11:24     BTRFS   Current           /var/crash
                 10     01-05-2018 22:11:03     BTRFS   Current           /var/lib/libvirt/images
                 11     01-05-2018 22:11:12     BTRFS   Current           /var/lib/machines
                 12     01-05-2018 22:11:03     BTRFS   Current           /var/lib/mailman
                 13     01-05-2018 22:11:12     BTRFS   Current           /var/lib/mariadb
                 14     01-05-2018 22:11:24     BTRFS   Current           /var/lib/mysql
                 15     01-05-2018 22:11:03     BTRFS   Current           /var/lib/named
                 16     01-05-2018 22:11:12     BTRFS   Current           /var/lib/pgsql
                 17     01-05-2018 22:11:12     BTRFS   Current           /var/log
                 18     01-05-2018 22:11:24     BTRFS   Current           /var/opt
                 19     01-05-2018 22:11:26     BTRFS   Current           /var/spool
                 20     01-05-2018 22:11:26     BTRFS   Current           /var/tmp
Please enter the numbers of the filespaces we should restore.
Pay attention to enter the filesystems in the correct order
(like restore / before /var/log)
(default: 1 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20): [30 secs]
The following filesystems will be restored:
/
/boot/grub2/powerpc-ieee1275
/home
/opt
/srv
/usr/local
/var/cache
/var/crash
/var/lib/libvirt/images
/var/lib/machines
/var/lib/mailman
/var/lib/mariadb
/var/lib/mysql
/var/lib/named
/var/lib/pgsql
/var/log
/var/opt
/var/spool
/var/tmp
Is this selection correct ? (Y|n) [30 secs]
Setting up multipathing
Activating multipath
multipath activated
Listing multipath device found
mpathc  (254, 0)
Comparing disks
Device dm-0 has expected (same) size 107374182400 (will be used for recovery)
Disk configuration looks identical
UserInput -I DISK_LAYOUT_PROCEED_RECOVERY needed in /usr/share/rear/layout/prepare/default/250_compare_disks.sh line 146
Proceed with recovery (yes) otherwise manual disk layout configuration is enforced
(default 'yes' timeout 30 seconds)
yes
UserInput: No choices - result is 'yes'
User confirmed to proceed with recovery
No code has been generated to recreate pv:/dev/mapper/mpathc_part2 (lvmdev).
    To recreate it manually add code to /var/lib/rear/layout/diskrestore.sh or abort.
UserInput -I ADD_CODE_TO_RECREATE_MISSING_PVDEVMAPPERMPATHCPART2LVMDEV needed in /usr/share/rear/layout/prepare/default/600_show_unprocessed.sh line 33
Manually add code that recreates pv:/dev/mapper/mpathc_part2 (lvmdev)
1) View /var/lib/rear/layout/diskrestore.sh
2) Edit /var/lib/rear/layout/diskrestore.sh
3) Go to Relax-and-Recover shell
4) Continue 'rear recover'
5) Abort 'rear recover'
(default '4' timeout 300 seconds)
1
UserInput: Valid choice number result 'View /var/lib/rear/layout/diskrestore.sh'
#!/bin/bash

LogPrint "Start system layout restoration."

mkdir -p /mnt/local
if create_component "vgchange" "rear" ; then
    lvm vgchange -a n &gt;/dev/null
    component_created "vgchange" "rear"
fi

set -e
set -x

if create_component "/dev/mapper/mpathc" "multipath" ; then
# Create /dev/mapper/mpathc (multipath)
LogPrint "Creating partitions for disk /dev/mapper/mpathc (msdos)"
my_udevsettle
parted -s /dev/mapper/mpathc mklabel msdos &gt;&amp;2
my_udevsettle
my_udevsettle
parted -s /dev/mapper/mpathc mkpart 'primary' 1048576B 8225279B &gt;&amp;2
my_udevsettle
my_udevsettle
parted -s /dev/mapper/mpathc set 1 boot on &gt;&amp;2
my_udevsettle
my_udevsettle
parted -s /dev/mapper/mpathc set 1 prep on &gt;&amp;2
my_udevsettle
my_udevsettle
parted -s /dev/mapper/mpathc mkpart 'primary' 8225280B 107002667519B &gt;&amp;2
my_udevsettle
my_udevsettle
parted -s /dev/mapper/mpathc set 2 lvm on &gt;&amp;2
my_udevsettle
sleep 1
if ! partprobe -s /dev/mapper/mpathc &gt;&amp;2 ; then
    LogPrint 'retrying partprobe /dev/mapper/mpathc after 10 seconds'
    sleep 10
    if ! partprobe -s /dev/mapper/mpathc &gt;&amp;2 ; then
        LogPrint 'retrying partprobe /dev/mapper/mpathc after 1 minute'
        sleep 60
        if ! partprobe -s /dev/mapper/mpathc &gt;&amp;2 ; then
            LogPrint 'partprobe /dev/mapper/mpathc failed, proceeding bona fide'
        fi
    fi
fi
component_created "/dev/mapper/mpathc" "multipath"
else
    LogPrint "Skipping /dev/mapper/mpathc (multipath) as it has already been created."
fi

if create_component "/dev/mapper/mpathc1" "part" ; then
# Create /dev/mapper/mpathc1 (part)
component_created "/dev/mapper/mpathc1" "part"
else
    LogPrint "Skipping /dev/mapper/mpathc1 (part) as it has already been created."
fi

if create_component "/dev/mapper/mpathc2" "part" ; then
# Create /dev/mapper/mpathc2 (part)
component_created "/dev/mapper/mpathc2" "part"
else
    LogPrint "Skipping /dev/mapper/mpathc2 (part) as it has already been created."
fi


set +x
set +e

LogPrint "Disk layout created."

UserInput -I ADD_CODE_TO_RECREATE_MISSING_PVDEVMAPPERMPATHCPART2LVMDEV needed in /usr/share/rear/layout/prepare/default/600_show_unprocessed.sh line 33
Manually add code that recreates pv:/dev/mapper/mpathc_part2 (lvmdev)
1) View /var/lib/rear/layout/diskrestore.sh
2) Edit /var/lib/rear/layout/diskrestore.sh
3) Go to Relax-and-Recover shell
4) Continue 'rear recover'
5) Abort 'rear recover'
(default '4' timeout 300 seconds)
5
UserInput: Valid choice number result 'Abort 'rear recover''
ERROR: User chose to abort 'rear recover' in /usr/share/rear/layout/prepare/default/600_show_unprocessed.sh
Aborting due to an error, check /var/log/rear/rear-tstinf01.log for details
You should also rm -Rf /tmp/rear.nVsRkyuhN0xgWT6
Terminated
</code></pre>
<p>RESCUE tstinf01:~ # rear -V<br />
Relax-and-Recover 2.3 / 2018-04-20</p>
<p>tstinf01:~ # arch<br />
ppc64le</p>
<p>Booting via SMS</p>
<p>tstinf01:~ # lsb_release -a<br />
LSB Version: n/a<br />
Distributor ID: SUSE<br />
Description: SUSE Linux Enterprise Server for SAP Applications 12 SP2<br />
Release: 12.2<br />
Codename: n/a</p>
<p>tstinf01:~ # cat site.conf<br />
OUTPUT=ISO<br />
OUTPUT_URL=nfs://tstinf02/exports/rear/iso<br />
ISO_PREFIX="$HOSTNAME-rear-$( date "+%y%m%d" )"<br />
ISO_VOLID=$HOSTNAME<br />
REAR_INITRD_COMPRESSION=lzma<br />
AUTOEXCLUDE_MULTIPATH=n<br />
BOOT_OVER_SAN=y<br />
BACKUP=TSM<br />
COPY_AS_IS_TSM=( /etc/$HOSTNAME /opt/tivoli/tsm/client/ba/bin/dsmc
/opt/tivoli/tsm/client/ba/bin/tsmbench_inclexcl
/opt/tivoli/tsm/client/ba/bin/dsm.sys
/opt/tivoli/tsm/client/ba/bin/dsm.opt
/opt/tivoli/tsm/client/api/bin64/libgpfs.so
/opt/tivoli/tsm/client/api/bin64/libdmapi.so
/opt/tivoli/tsm/client/ba/bin/EN_US/dsmclientV3.cat
/usr/local/ibm/gsk8* )<br />
COPY_AS_IS_EXCLUDE_TSM=( )<br />
PROGS_TSM=(dsmc)<br />
TSM_LD_LIBRARY_PATH="/opt/tivoli/tsm/client/ba/bin:/opt/tivoli/tsm/client/api/bin64:/opt/tivoli/tsm/client/api/bin:/opt/tivoli/tsm/client/api/bin64/cit/bin"<br />
TSM_RESULT_FILE_PATH=/opt/tivoli/tsm/rear<br />
TSM_RESULT_SAVE=n<br />
TSM_ARCHIVE_MGMT_CLASS=qaasba<br />
TSM_RM_ISOFILE=y</p>
<p>Thanks,</p>
<h4 id="jsmeix_commented_at_2018-05-04_1246"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-386590382">2018-05-04 12:46</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-05-04_1246" title="Permanent link">&para;</a></h4>
<p>PPC and MULTIPATH (plus TSM and a special way to boot <code>SMS</code>)<br />
looks very much as if only @schabrolles might actually help here...</p>
<h4 id="jsmeix_commented_at_2018-05-04_1253"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-386592239">2018-05-04 12:53</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-05-04_1253" title="Permanent link">&para;</a></h4>
<p>@bern66<br />
it seems you use SLES12-SP2 with its default btrfs structure<br />
but I do not see the usual config variables in your
etc/rear/local.conf<br />
(or etc/rear/site.conf) that are needed for the SLE12 btrfs structure,<br />
cf. the example config files in usr/share/rear/conf/examples/<br />
(there is also one for SLE12 with SAP HANA).</p>
<h4 id="bern66_commented_at_2018-05-04_1352"><img src="https://avatars.githubusercontent.com/u/38959869?u=f7f85617d38f6bebe9285f89b6794b229152df0c&v=4" width="50"><a href="https://github.com/bern66">bern66</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-386608105">2018-05-04 13:52</a>:<a class="headerlink" href="#bern66_commented_at_2018-05-04_1352" title="Permanent link">&para;</a></h4>
<p>Thanks jsmeix! I didn't know about the details for btrfs and SLES12.
I'll add those elements of configuration in my environment.</p>
<h4 id="schabrolles_commented_at_2018-05-04_1400"><img src="https://avatars.githubusercontent.com/u/19491077?u=0021b16ab426902cbe676f6831f41607bbe4d441&v=4" width="50"><a href="https://github.com/schabrolles">schabrolles</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-386610435">2018-05-04 14:00</a>:<a class="headerlink" href="#schabrolles_commented_at_2018-05-04_1400" title="Permanent link">&para;</a></h4>
<p>@bern66 can you also show your <code>/var/lib/rear/layout/disklayout.conf</code></p>
<p>just for reference, here is an example of a configuration file that is
working for me (Power8 LPAR, SLES12, TSM, PXE boot server instead of
ISO)</p>
<pre><code># Default is to create Relax-and-Recover rescue media as ISO image
# set OUTPUT to change that
# set BACKUP to activate an automated (backup and) restore of your data
# Possible configuration values can be found in /usr/share/rear/conf/default.conf
#
# This file (local.conf) is intended for manual configuration. For configuration
# through packages and other automated means we recommend creating a new
# file named site.conf next to this file and to leave the local.conf as it is.
# Our packages will never ship with a site.conf.

AUTOEXCLUDE_MULTIPATH=n
BOOT_OVER_SAN=y
REAR_INITRD_COMPRESSION=lzma

OUTPUT=PXE
OUTPUT_PREFIX_PXE=rear/$HOSTNAME
PXE_CONFIG_GRUB_STYLE=y
PXE_CONFIG_URL="nfs://{{ PXE_SERVER_IP }}/var/lib/tftpboot/boot/grub2/powerpc-ieee1275"
PXE_CREATE_LINKS=IP
PXE_REMOVE_OLD_LINKS=y
PXE_TFTP_URL="nfs://{{ PXE_SERVER_IP }}/var/lib/tftpboot"
OUTPUT_OPTIONS="nfsvers=4,nolock"

BACKUP=TSM
COPY_AS_IS_TSM=( /etc/adsm/TSM.PWD /opt/tivoli/tsm/client/ba/bin/dsmc /opt/tivoli/tsm/client/ba/bin/tsmbench_inclexcl /opt/tivoli/tsm/client/ba/bin/dsm.sys /opt/tivoli/tsm/client/ba/bin/dsm.opt /opt/tivoli/tsm/client/api/bin64/libgpfs.so /opt/tivoli/tsm/client/api/bin64/libdmapi.so /opt/tivoli/tsm/client/ba/bin/EN_US/dsmclientV3.cat /usr/local/ibm/gsk8* )
TSM_RESULT_SAVE=n

## SLES12
BACKUP_OPTIONS="nfsvers=4,nolock"
REQUIRED_PROGS=( "${REQUIRED_PROGS[@]}" snapper chattr lsattr )
COPY_AS_IS=( "${COPY_AS_IS[@]}" /usr/lib/snapper/installation-helper /etc/snapper/config-templates/default )

for subvol in $(findmnt -n -r -t btrfs | cut -d ' ' -f 1 | grep -v '^/$' | egrep -v 'snapshots|crash') ; do
    BACKUP_PROG_INCLUDE=( "${BACKUP_PROG_INCLUDE[@]}" "$subvol" )
done

POST_RECOVERY_SCRIPT=( 'if snapper --no-dbus -r $TARGET_FS_ROOT get-config | grep -q "^QGROUP.*[0-9]/[0-9]" ; then snapper --no-dbus -r $TARGET_FS_ROOT set-config QGROUP= ; snapper --no-dbus -r $TARGET_FS_ROOT setup-quota &amp;&amp; echo snapper setup-quota done || echo snapper setup-quota failed ; else echo snapper setup-quota not used ; fi' )
</code></pre>
<h4 id="bern66_commented_at_2018-05-04_1407"><img src="https://avatars.githubusercontent.com/u/38959869?u=f7f85617d38f6bebe9285f89b6794b229152df0c&v=4" width="50"><a href="https://github.com/bern66">bern66</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-386612720">2018-05-04 14:07</a>:<a class="headerlink" href="#bern66_commented_at_2018-05-04_1407" title="Permanent link">&para;</a></h4>
<p>Of course I can do that even more if it can help you helping me. The
disklayout.conf below is from a test server. Our production servers will
more LUNs, just in case it could matter somehow. Here it is:</p>
<pre><code>tstinf01:~ # cat /var/lib/rear/layout/disklayout.conf
lvmdev /dev/system /dev/mapper/mpathc_part2 RWHsoG-C5a3-78M5-FmaZ-xMvD-dN5N-jSsKXJ 208973520
lvmgrp /dev/system 4096 25509 104484864
lvmvol /dev/system home 5120 41943040
lvmvol /dev/system root 7589 62169088
lvmvol /dev/system swap 12800 104857600
# Filesystems (only ext2,ext3,ext4,vfat,xfs,reiserfs,btrfs are supported).
# Format: fs &lt;device&gt; &lt;mountpoint&gt; &lt;fstype&gt; [uuid=&lt;uuid&gt;] [label=&lt;label&gt;] [&lt;attributes&gt;]
fs /dev/mapper/system-home /home xfs uuid=71d6e654-92a0-4bc2-b152-e3a5bab13f9f label=/home  options=rw,relatime,attr2,inode64,noquota
fs /dev/mapper/system-root / btrfs uuid=97590a87-5390-44f0-826f-a9425d42e396 label= options=rw,relatime,space_cache,subvolid=5,subvol=/
# Btrfs default subvolume for /dev/mapper/system-root at /
# Format: btrfsdefaultsubvol &lt;device&gt; &lt;mountpoint&gt; &lt;btrfs_subvolume_ID&gt; &lt;btrfs_subvolume_path&gt;
btrfsdefaultsubvol /dev/mapper/system-root / 5 /
# Btrfs snapshot subvolumes for /dev/mapper/system-root at /
# Btrfs snapshot subvolumes are listed here only as documentation.
# There is no recovery of btrfs snapshot subvolumes.
# Format: btrfssnapshotsubvol &lt;device&gt; &lt;mountpoint&gt; &lt;btrfs_subvolume_ID&gt; &lt;btrfs_subvolume_path&gt;
#btrfssnapshotsubvol /dev/mapper/system-root / 669 @/.snapshots/255/snapshot
#btrfssnapshotsubvol /dev/mapper/system-root / 670 @/.snapshots/256/snapshot
#btrfssnapshotsubvol /dev/mapper/system-root / 700 @/.snapshots/279/snapshot
#btrfssnapshotsubvol /dev/mapper/system-root / 701 @/.snapshots/280/snapshot
#btrfssnapshotsubvol /dev/mapper/system-root / 702 @/.snapshots/281/snapshot
#btrfssnapshotsubvol /dev/mapper/system-root / 703 @/.snapshots/282/snapshot
#btrfssnapshotsubvol /dev/mapper/system-root / 704 @/.snapshots/283/snapshot
#btrfssnapshotsubvol /dev/mapper/system-root / 705 @/.snapshots/284/snapshot
# Btrfs normal subvolumes for /dev/mapper/system-root at /
# Format: btrfsnormalsubvol &lt;device&gt; &lt;mountpoint&gt; &lt;btrfs_subvolume_ID&gt; &lt;btrfs_subvolume_path&gt;
# Btrfs subvolumes that belong to snapper are listed here only as documentation.
# Snapper's base subvolume '/@/.snapshots' is deactivated here because during 'rear recover'
# it is created by 'snapper/installation-helper --step 1' (which fails if it already exists).
# Furthermore any normal btrfs subvolume under snapper's base subvolume would be wrong.
# See https://github.com/rear/rear/issues/944#issuecomment-238239926
# and https://github.com/rear/rear/issues/963#issuecomment-240061392
# how to create a btrfs subvolume in compliance with the SLES12 default brtfs structure.
# In short: Normal btrfs subvolumes on SLES12 must be created directly below '/@/'
# e.g. '/@/var/lib/mystuff' (which requires that the btrfs root subvolume is mounted)
# and then the subvolume is mounted at '/var/lib/mystuff' to be accessible from '/'
# plus usually an entry in /etc/fstab to get it mounted automatically when booting.
# Because any '@/.snapshots' subvolume would let 'snapper/installation-helper --step 1' fail
# such subvolumes are deactivated here to not let 'rear recover' fail:
#btrfsnormalsubvol /dev/mapper/system-root / 258 @/.snapshots
btrfsnormalsubvol /dev/mapper/system-root / 257 @
btrfsnormalsubvol /dev/mapper/system-root / 259 @/boot/grub2/powerpc-ieee1275
btrfsnormalsubvol /dev/mapper/system-root / 260 @/opt
btrfsnormalsubvol /dev/mapper/system-root / 261 @/srv
btrfsnormalsubvol /dev/mapper/system-root / 262 @/tmp
btrfsnormalsubvol /dev/mapper/system-root / 263 @/usr/local
btrfsnormalsubvol /dev/mapper/system-root / 264 @/var/cache
btrfsnormalsubvol /dev/mapper/system-root / 265 @/var/crash
btrfsnormalsubvol /dev/mapper/system-root / 266 @/var/lib/libvirt/images
btrfsnormalsubvol /dev/mapper/system-root / 267 @/var/lib/machines
btrfsnormalsubvol /dev/mapper/system-root / 268 @/var/lib/mailman
btrfsnormalsubvol /dev/mapper/system-root / 269 @/var/lib/mariadb
btrfsnormalsubvol /dev/mapper/system-root / 270 @/var/lib/mysql
btrfsnormalsubvol /dev/mapper/system-root / 271 @/var/lib/named
btrfsnormalsubvol /dev/mapper/system-root / 272 @/var/lib/pgsql
btrfsnormalsubvol /dev/mapper/system-root / 273 @/var/log
btrfsnormalsubvol /dev/mapper/system-root / 274 @/var/opt
btrfsnormalsubvol /dev/mapper/system-root / 275 @/var/spool
btrfsnormalsubvol /dev/mapper/system-root / 276 @/var/tmp
# All mounted btrfs subvolumes (including mounted btrfs default subvolumes and mounted btrfs snapshot subvolumes).
# Determined by the findmnt command that shows the mounted btrfs_subvolume_path.
# Format: btrfsmountedsubvol &lt;device&gt; &lt;subvolume_mountpoint&gt; &lt;mount_options&gt; &lt;btrfs_subvolume_path&gt;
btrfsmountedsubvol /dev/mapper/system-root / rw,relatime,space_cache,subvolid=5,subvol=/ /
btrfsmountedsubvol /dev/mapper/system-root /var/log rw,relatime,space_cache,subvolid=273,subvol=/@/var/log @/var/log
btrfsmountedsubvol /dev/mapper/system-root /var/lib/mysql rw,relatime,space_cache,subvolid=270,subvol=/@/var/lib/mysql @/var/lib/mysql
btrfsmountedsubvol /dev/mapper/system-root /var/lib/pgsql rw,relatime,space_cache,subvolid=272,subvol=/@/var/lib/pgsql @/var/lib/pgsql
btrfsmountedsubvol /dev/mapper/system-root /var/lib/mariadb rw,relatime,space_cache,subvolid=269,subvol=/@/var/lib/mariadb @/var/lib/mariadb
btrfsmountedsubvol /dev/mapper/system-root /var/lib/libvirt/images rw,relatime,space_cache,subvolid=266,subvol=/@/var/lib/libvirt/images @/var/lib/libvirt/images
btrfsmountedsubvol /dev/mapper/system-root /var/lib/named rw,relatime,space_cache,subvolid=271,subvol=/@/var/lib/named @/var/lib/named
btrfsmountedsubvol /dev/mapper/system-root /var/crash rw,relatime,space_cache,subvolid=265,subvol=/@/var/crash @/var/crash
btrfsmountedsubvol /dev/mapper/system-root /var/lib/machines rw,relatime,space_cache,subvolid=267,subvol=/@/var/lib/machines @/var/lib/machines
btrfsmountedsubvol /dev/mapper/system-root /.snapshots rw,relatime,space_cache,subvolid=258,subvol=/@/.snapshots @/.snapshots
btrfsmountedsubvol /dev/mapper/system-root /opt rw,relatime,space_cache,subvolid=260,subvol=/@/opt @/opt
btrfsmountedsubvol /dev/mapper/system-root /usr/local rw,relatime,space_cache,subvolid=263,subvol=/@/usr/local @/usr/local
btrfsmountedsubvol /dev/mapper/system-root /tmp rw,relatime,space_cache,subvolid=262,subvol=/@/tmp @/tmp
btrfsmountedsubvol /dev/mapper/system-root /var/cache rw,relatime,space_cache,subvolid=264,subvol=/@/var/cache @/var/cache
btrfsmountedsubvol /dev/mapper/system-root /var/tmp rw,relatime,space_cache,subvolid=276,subvol=/@/var/tmp @/var/tmp
btrfsmountedsubvol /dev/mapper/system-root /var/lib/mailman rw,relatime,space_cache,subvolid=268,subvol=/@/var/lib/mailman @/var/lib/mailman
btrfsmountedsubvol /dev/mapper/system-root /var/spool rw,relatime,space_cache,subvolid=275,subvol=/@/var/spool @/var/spool
btrfsmountedsubvol /dev/mapper/system-root /var/opt rw,relatime,space_cache,subvolid=274,subvol=/@/var/opt @/var/opt
btrfsmountedsubvol /dev/mapper/system-root /srv rw,relatime,space_cache,subvolid=261,subvol=/@/srv @/srv
btrfsmountedsubvol /dev/mapper/system-root /boot/grub2/powerpc-ieee1275 rw,relatime,space_cache,subvolid=259,subvol=/@/boot/grub2/powerpc-ieee1275 @/boot/grub2/powerpc-ieee1275
# Mounted btrfs subvolumes that have the 'no copy on write' attribute set.
# Format: btrfsnocopyonwrite &lt;btrfs_subvolume_path&gt;
# Swap partitions or swap files
# Format: swap &lt;filename&gt; uuid=&lt;uuid&gt; label=&lt;label&gt;
swap /dev/mapper/system-swap uuid=10bd73bf-48b3-46d6-8608-7ce9972ea4ab label=
multipath /dev/mapper/mpathc 107374182400 /dev/sda,/dev/sdb,/dev/sdc,/dev/sdd,/dev/sde,/dev/sdf,/dev/sdg,/dev/sdh
part /dev/mapper/mpathc 7176704 1048576 primary boot,prep /dev/mapper/mpathc1
part /dev/mapper/mpathc 106994442240 8225280 primary lvm /dev/mapper/mpathc2
</code></pre>
<p>Thanks,</p>
<h4 id="schabrolles_commented_at_2018-05-04_1418"><img src="https://avatars.githubusercontent.com/u/19491077?u=0021b16ab426902cbe676f6831f41607bbe4d441&v=4" width="50"><a href="https://github.com/schabrolles">schabrolles</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-386616052">2018-05-04 14:18</a>:<a class="headerlink" href="#schabrolles_commented_at_2018-05-04_1418" title="Permanent link">&para;</a></h4>
<p>@bern66<br />
I don't see why <code>pv:/dev/mapper/mpathc_part2</code> is not recreated. I would
need to have a look at the log file in debug mode.</p>
<p>try again with <code>rear -d recover</code> and send me the log file generated.</p>
<h4 id="schabrolles_commented_at_2018-05-04_1513"><img src="https://avatars.githubusercontent.com/u/19491077?u=0021b16ab426902cbe676f6831f41607bbe4d441&v=4" width="50"><a href="https://github.com/schabrolles">schabrolles</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-386632589">2018-05-04 15:13</a>:<a class="headerlink" href="#schabrolles_commented_at_2018-05-04_1513" title="Permanent link">&para;</a></h4>
<p>@bern66,</p>
<p>I think I begin to understand what happen here.... but don't have the
root cause yet.<br />
It seems that your SLES12 created the partition on the multipath device
in an unusual way (for a sles12)<br />
partition are named <code>/dev/mapper/mpathc2</code> while usually it is
<code>/dev/mapper/mpathc_part2</code><br />
(@jsmeix what do you think .... Do you know why partition are named like
RedHat here .... this multipath_partition naming convention will kill
me .... )</p>
<h4 id="bern66_commented_at_2018-05-04_1514"><img src="https://avatars.githubusercontent.com/u/38959869?u=f7f85617d38f6bebe9285f89b6794b229152df0c&v=4" width="50"><a href="https://github.com/bern66">bern66</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-386632851">2018-05-04 15:14</a>:<a class="headerlink" href="#bern66_commented_at_2018-05-04_1514" title="Permanent link">&para;</a></h4>
<p>@schabrolles<br />
The requested log file is attached.</p>
<p>Thanks<br />
<a href="https://github.com/rear/rear/files/1974930/rear-tstinf01-partial-2018-05-04T09_57_36-04_00.log.gz">rear-tstinf01-partial-2018-05-04T09_57_36-04_00.log.gz</a></p>
<h4 id="bern66_commented_at_2018-05-04_1521"><img src="https://avatars.githubusercontent.com/u/38959869?u=f7f85617d38f6bebe9285f89b6794b229152df0c&v=4" width="50"><a href="https://github.com/bern66">bern66</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-386634960">2018-05-04 15:21</a>:<a class="headerlink" href="#bern66_commented_at_2018-05-04_1521" title="Permanent link">&para;</a></h4>
<p>@schabrolles<br />
Regarding the naming convention, actually we have been advised by SuSE
to <strong>not</strong> use friendly names. As a test at some point I changed it to
<code>user_friendly_names yes</code> to try to fix my problem but that did not
help. I'll have to switch it back to no.</p>
<p>For example:</p>
<pre><code>tstinf02:~ # head /etc/multipath.conf
# Default multipath.conf file created for install boot

# Used mpathN names
defaults {
user_friendly_names no
}
devices {
    device {
        vendor "IBM"
</code></pre>
<h4 id="bern66_commented_at_2018-05-04_1528"><img src="https://avatars.githubusercontent.com/u/38959869?u=f7f85617d38f6bebe9285f89b6794b229152df0c&v=4" width="50"><a href="https://github.com/bern66">bern66</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-386637061">2018-05-04 15:28</a>:<a class="headerlink" href="#bern66_commented_at_2018-05-04_1528" title="Permanent link">&para;</a></h4>
<p>Switching to <code>user_friendly_names no</code> changes the names from this:</p>
<pre><code>tstinf01:~ # ls -l /dev/mapper/
total 0
crw------- 1 root root  10, 236 May  4 11:22 control
brw-r----- 1 root disk 254,   0 May  4 11:22 mpathc
brw-r----- 1 root disk 254,   1 May  4 11:22 mpathc1
brw-r----- 1 root disk 254,   2 May  4 11:22 mpathc2
lrwxrwxrwx 1 root root        7 May  4 11:22 mpathc_part1 -&gt; ../dm-1
lrwxrwxrwx 1 root root        7 May  4 11:22 mpathc_part2 -&gt; ../dm-2
lrwxrwxrwx 1 root root        7 May  4 11:22 system-home -&gt; ../dm-5
lrwxrwxrwx 1 root root        7 May  4 11:22 system-root -&gt; ../dm-3
lrwxrwxrwx 1 root root        7 May  4 11:22 system-swap -&gt; ../dm-4
</code></pre>
<p>to:</p>
<pre><code>tstinf01:~ # ls -l /dev/mapper/
total 0
brw-r----- 1 root disk 254,   0 May  4 11:24 3600507680c800450b80000000000093e
brw-r----- 1 root disk 254,   1 May  4 11:24 3600507680c800450b80000000000093e1
brw-r----- 1 root disk 254,   2 May  4 11:24 3600507680c800450b80000000000093e2
lrwxrwxrwx 1 root root        7 May  4 11:24 3600507680c800450b80000000000093e_part1 -&gt; ../dm-1
lrwxrwxrwx 1 root root        7 May  4 11:24 3600507680c800450b80000000000093e_part2 -&gt; ../dm-2
crw------- 1 root root  10, 236 May  4 11:24 control
lrwxrwxrwx 1 root root        7 May  4 11:24 system-home -&gt; ../dm-5
lrwxrwxrwx 1 root root        7 May  4 11:24 system-root -&gt; ../dm-3
lrwxrwxrwx 1 root root        7 May  4 11:24 system-swap -&gt; ../dm-4
</code></pre>
<h4 id="schabrolles_commented_at_2018-05-04_1536"><img src="https://avatars.githubusercontent.com/u/19491077?u=0021b16ab426902cbe676f6831f41607bbe4d441&v=4" width="50"><a href="https://github.com/schabrolles">schabrolles</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-386639703">2018-05-04 15:36</a>:<a class="headerlink" href="#schabrolles_commented_at_2018-05-04_1536" title="Permanent link">&para;</a></h4>
<p>@bern66<br />
from what I see, It looks good with or without firendly name for a
sles12... (XXXXX_part2)<br />
What I don't understand is why your disklayout.conf report
<code>/dev/mapper/mpathc2</code> and not <code>mpathc_part2</code>.</p>
<p>If it is the case, this mean the problem is during the "mkrescue" part
and not during the restore.<br />
could you also run the following command <code>rear -d mkrescue</code> and send me
the output ?</p>
<h4 id="bern66_commented_at_2018-05-04_1601"><img src="https://avatars.githubusercontent.com/u/38959869?u=f7f85617d38f6bebe9285f89b6794b229152df0c&v=4" width="50"><a href="https://github.com/bern66">bern66</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-386646995">2018-05-04 16:01</a>:<a class="headerlink" href="#bern66_commented_at_2018-05-04_1601" title="Permanent link">&para;</a></h4>
<p>Attached is the log of <code>rear -d mkrescue</code>.</p>
<p>Thanks a lot for your assistance!</p>
<p><a href="https://github.com/rear/rear/files/1975086/rear-tstinf01.log">rear-tstinf01.log</a></p>
<h4 id="schabrolles_commented_at_2018-05-04_1607"><img src="https://avatars.githubusercontent.com/u/19491077?u=0021b16ab426902cbe676f6831f41607bbe4d441&v=4" width="50"><a href="https://github.com/schabrolles">schabrolles</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-386648653">2018-05-04 16:07</a>:<a class="headerlink" href="#schabrolles_commented_at_2018-05-04_1607" title="Permanent link">&para;</a></h4>
<p>My mistake ... it was <code>rear -D mkrescue</code> sorry for that... I need the
debug script</p>
<h4 id="bern66_commented_at_2018-05-04_1618"><img src="https://avatars.githubusercontent.com/u/38959869?u=f7f85617d38f6bebe9285f89b6794b229152df0c&v=4" width="50"><a href="https://github.com/bern66">bern66</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-386651698">2018-05-04 16:18</a>:<a class="headerlink" href="#bern66_commented_at_2018-05-04_1618" title="Permanent link">&para;</a></h4>
<p>No problem... here it is!</p>
<p>Thanks again for your assitance!</p>
<p><a href="https://github.com/rear/rear/files/1975132/rear-tstinf01.log.gz">rear-tstinf01.log.gz</a></p>
<h4 id="schabrolles_commented_at_2018-05-04_2020"><img src="https://avatars.githubusercontent.com/u/19491077?u=0021b16ab426902cbe676f6831f41607bbe4d441&v=4" width="50"><a href="https://github.com/schabrolles">schabrolles</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-386722196">2018-05-04 20:20</a>:<a class="headerlink" href="#schabrolles_commented_at_2018-05-04_2020" title="Permanent link">&para;</a></h4>
<p>@bern66,<br />
I made a quick change for another problem, maybe it could also help
you.<br />
could you try this version :</p>
<pre><code>git clone https://github.com/schabrolles/rear -b issue_1766
</code></pre>
<h4 id="jsmeix_commented_at_2018-05-07_0814"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-386992547">2018-05-07 08:14</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-05-07_0814" title="Permanent link">&para;</a></h4>
<p>@schabrolles<br />
regarding your
<a href="https://github.com/rear/rear/issues/1796#issuecomment-386632589">https://github.com/rear/rear/issues/1796#issuecomment-386632589</a></p>
<p>Since SLES12 it should be usually <code>/dev/mapper/mpathc-part2</code><br />
(the <code>/dev/mapper/mpathc_part2</code> form is usually for SLE11).</p>
<p>I am not a multipath user so that all what I know about<br />
SUSE multipath partition names is what I got via mail in<br />
<a href="https://github.com/rear/rear/pull/1765#issuecomment-378229855">https://github.com/rear/rear/pull/1765#issuecomment-378229855</a><br />
and<br />
<a href="https://github.com/rear/rear/pull/1765#issuecomment-378246918">https://github.com/rear/rear/pull/1765#issuecomment-378246918</a><br />
which is basically that on SLES12 it is always</p>
<pre>
/dev/mapper/foo => /dev/mapper/foo-part1
</pre>

<p>@bern66<br />
accordingly @schabrolles had recently documented<br />
the known SUSE multipath partition names<br />
in usr/share/rear/lib/layout-functions.sh<br />
in the get_part_device_name_format() function<br />
cf.
<a href="https://github.com/rear/rear/pull/1765/files">https://github.com/rear/rear/pull/1765/files</a></p>
<p>In your initial comment here you wrote</p>
<pre>
Relax-and-Recover 2.3 / 2018-04-20
</pre>

<p>but
<a href="https://github.com/rear/rear/pull/1765">https://github.com/rear/rear/pull/1765</a>
was committed<br />
<a href="https://github.com/rear/rear/commit/160e3263ed50d7f6bed4977197d1e0014e475aa3">https://github.com/rear/rear/commit/160e3263ed50d7f6bed4977197d1e0014e475aa3</a><br />
on April 23 2018<br />
so that your ReaR from 2018-04-20 is a bit too old.</p>
<p>In general regardless if your particular issue (unexpected SUSE
multipath partition name)<br />
is already fixed in our current ReaR upstream GitHub master code<br />
I recommend to try out our current ReaR upstream GitHub master code<br />
because that is the only place where we at ReaR upstream fix bugs.</p>
<p>To use our current ReaR upstream GitHub master code<br />
do the following:</p>
<p>Basically "git clone" it into a separated directory and then<br />
configure and run ReaR from within that directory like:</p>
<pre>
# git clone https://github.com/rear/rear.git

# mv rear rear.github.master

# cd rear.github.master

# vi etc/rear/local.conf

# usr/sbin/rear -D mkbackup
</pre>

<p>Note the relative paths "etc/rear/" and "usr/sbin/".</p>
<p>If the issue also happens with current ReaR upstream GitHub master
code<br />
please provide us a complete ReaR debug log file of "rear -D
mkrescue/mkbackup"<br />
and the resulting disklayout.conf file from your original system<br />
plus a complete ReaR debug log file of "rear -D recover"<br />
so that we can have a look how it behaves in your particular
environment<br />
cf. "Debugging issues with Relax-and-Recover" at<br />
<a href="https://en.opensuse.org/SDB:Disaster_Recovery">https://en.opensuse.org/SDB:Disaster_Recovery</a></p>
<p>If it perhaps "just works" with current ReaR upstream GitHub master
code<br />
we would really appreciate an explicit positive feedback.</p>
<h4 id="jsmeix_commented_at_2018-05-07_0831"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-386996844">2018-05-07 08:31</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-05-07_0831" title="Permanent link">&para;</a></h4>
<p>@bern66<br />
if on your particular SLES12 system<br />
your multipath devices are named</p>
<pre>
 /dev/mapper/mpathc2
</pre>

<p>and not in the usual SLES12 form which is</p>
<pre>
/dev/mapper/mpathc-part2
</pre>

<p><a href="https://github.com/rear/rear/pull/1765#issuecomment-378229855">https://github.com/rear/rear/pull/1765#issuecomment-378229855</a><br />
and<br />
<a href="https://github.com/rear/rear/pull/1765#issuecomment-378246918">https://github.com/rear/rear/pull/1765#issuecomment-378246918</a><br />
seem to indicate that on your particular SLES12 system<br />
there is no udev rule file /usr/lib/udev/rules.d/66-kpartx.rules<br />
(it is provided by the kpartx RPM)<br />
or it is there but the actual rule therein</p>
<pre>
RUN+="/sbin/kpartx -u -p -part /dev/$name"
</pre>

<p>does not work as it should on your particular SLES12 system.<br />
But because I am not a multipath user this is only a blind guess.</p>
<h4 id="schabrolles_commented_at_2018-05-07_0836"><img src="https://avatars.githubusercontent.com/u/19491077?u=0021b16ab426902cbe676f6831f41607bbe4d441&v=4" width="50"><a href="https://github.com/schabrolles">schabrolles</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-386997966">2018-05-07 08:36</a>:<a class="headerlink" href="#schabrolles_commented_at_2018-05-07_0836" title="Permanent link">&para;</a></h4>
<p>@jsmeix</p>
<p>I think the problem here is the presence of device <code>/dev/mapper/mpathc1</code>
which is unusual ..<br />
It seems to not be a link but a real device create with <code>mknode</code> command
... I don't why... (I don't have such device on my multipathed SLE12).</p>
<p>because of that multipathed partition are recorded like
<code>/dev/mapper/mapthc1</code> in <code>disklayout.conf</code><br />
The problem could be related to issue #1766 where I propose a new way
to discover the multipathed partition name based on <code>/sys</code> and
device-mapper.</p>
<p>I think it should also solve the issue here because it will find the
dm-X device as partition and then find the real name (instead of trying
to guess from device name + [1-9]* , or -part[1-9]* .... )</p>
<p><a href="https://github.com/schabrolles/rear/commit/c635fd9da08307980f3c07f977731fb60d4e0cfe">https://github.com/schabrolles/rear/commit/c635fd9da08307980f3c07f977731fb60d4e0cfe</a></p>
<p>If @bern66 or @badarmontassar confirm it solves their issue, I will make
a PR.</p>
<h4 id="jsmeix_commented_at_2018-05-07_0840"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-386998851">2018-05-07 08:40</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-05-07_0840" title="Permanent link">&para;</a></h4>
<p>@bern66<br />
how did you install your particular SLES12 system?</p>
<p>On my SLES12-SP3 installed form an original SLES12 installation medium I
get</p>
<pre>
# rpm -qf /usr/lib/udev/rules.d/66-kpartx.rules
kpartx-0.7.1+7+suse.3edc5f7d-1.26.x86_64

# rpm -e --test kpartx
error: Failed dependencies:
        kpartx is needed by (installed) dmraid-1.0.0.rc16-34.3.x86_64
        kpartx is needed by (installed) multipath-tools-0.7.1+7+suse.3edc5f7d-1.26.x86_64

# rpm -e --test dmraid
error: Failed dependencies:
        dmraid is needed by (installed) os-prober-1.61-29.1.x86_64

# rpm -e --test multipath-tools
error: Failed dependencies:
        multipath-tools is needed by (installed) patterns-sles-base-12-77.8.x86_64
</pre>

<p>i.e. one cannot have kpartx not installed without breaking<br />
several other RPM dependencies that are usually installed.</p>
<h4 id="jsmeix_commented_at_2018-05-07_0851"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-387001483">2018-05-07 08:51</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-05-07_0851" title="Permanent link">&para;</a></h4>
<p>@schabrolles</p>
<p>I think the presence of a multipath device <code>/dev/mapper/mpathc1</code><br />
instead of the usually expected <code>/dev/mapper/mpathc-part1</code> on SLES12<br />
indicates that this particular SLES12 system is not as it should be.<br />
This might lead to an endless sequence of other problems for the user<br />
because I think nobody expects a SLES12 system with such multipath<br />
so that the user may run into endless more troubles e.g. when asking<br />
our official SUSE support or someone else about whatever issues<br />
that are somehow related to his particular SLES12 multipath system.<br />
Furthermore I fear whatever other stuff in SUSE (e.g. YaST or
whatever)<br />
may "do strage things" if the multipath device names are not the
expected ones.</p>
<p>Nevertheless if you can make the ReaR multipath code to even "just
work"<br />
for any kind of multipath device names it would be of course absolutely
great,<br />
in particular when users then could report "all fails - except ReaR" ;-)</p>
<h4 id="bern66_commented_at_2018-05-07_1219"><img src="https://avatars.githubusercontent.com/u/38959869?u=f7f85617d38f6bebe9285f89b6794b229152df0c&v=4" width="50"><a href="https://github.com/bern66">bern66</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-387047164">2018-05-07 12:19</a>:<a class="headerlink" href="#bern66_commented_at_2018-05-07_1219" title="Permanent link">&para;</a></h4>
<p>Hello everyone,</p>
<p>There is so many things in your previous comments, I'll need some times
to reply to all your questions and suggestions.</p>
<p>But a first few points:</p>
<ul>
<li>kpartx is installed on our systems;</li>
<li>I did not installed our SLES12 system myself. We are in an IBM Power
    System environment and an image has been created initially from
    which all other systems are build from. I am fairly new in this
    environment;</li>
<li>I'll give a try with the latest version for ReaR.</li>
</ul>
<p>Also, a SuSE consultant came to help us with many aspects of our
environment and didn't mention anything wrong with our multipath
setting. But he mention that we should not use friendly names
specifically to support DR configurations.</p>
<p>Regarding the naming of the multipath, here is what I have when using
friendly names:</p>
<pre><code>tstinf01:~ # ls -l /dev/mapper/
total 0
crw------- 1 root root  10, 236 May  7 07:17 control
brw-r----- 1 root disk 254,   0 May  7 07:17 mpathc
brw-r----- 1 root disk 254,   1 May  7 07:17 mpathc1
brw-r----- 1 root disk 254,   2 May  7 07:17 mpathc2
lrwxrwxrwx 1 root root        7 May  7 07:17 mpathc_part1 -&gt; ../dm-1
lrwxrwxrwx 1 root root        7 May  7 07:17 mpathc_part2 -&gt; ../dm-2
lrwxrwxrwx 1 root root        7 May  7 07:17 system-home -&gt; ../dm-5
lrwxrwxrwx 1 root root        7 May  7 07:17 system-root -&gt; ../dm-3
lrwxrwxrwx 1 root root        7 May  7 07:17 system-swap -&gt; ../dm-4
</code></pre>
<p>And here is what I have when not using friendly names:</p>
<pre><code>tstinf01:~ # ls -l /dev/mapper/
total 0
brw-r----- 1 root disk 254,   0 May  7 08:17 3600507680c800450b80000000000093e
brw-r----- 1 root disk 254,   1 May  7 08:17 3600507680c800450b80000000000093e1
brw-r----- 1 root disk 254,   2 May  7 08:17 3600507680c800450b80000000000093e2
lrwxrwxrwx 1 root root        7 May  7 08:17 3600507680c800450b80000000000093e_part1 -&gt; ../dm-1
lrwxrwxrwx 1 root root        7 May  7 08:17 3600507680c800450b80000000000093e_part2 -&gt; ../dm-2
crw------- 1 root root  10, 236 May  7 08:17 control
lrwxrwxrwx 1 root root        7 May  7 08:17 system-home -&gt; ../dm-5
lrwxrwxrwx 1 root root        7 May  7 08:17 system-root -&gt; ../dm-3
lrwxrwxrwx 1 root root        7 May  7 08:17 system-swap -&gt; ../dm-4
</code></pre>
<p>The version of my system is 12.2:</p>
<pre><code>tstinf01:~ # lsb_release -a
LSB Version:    n/a
Distributor ID: SUSE
Description:    SUSE Linux Enterprise Server for SAP Applications 12 SP2
Release:        12.2
Codename:       n/a
</code></pre>
<p>Thanks for your assistance, you are amazing!</p>
<h4 id="bern66_commented_at_2018-05-07_1849"><img src="https://avatars.githubusercontent.com/u/38959869?u=f7f85617d38f6bebe9285f89b6794b229152df0c&v=4" width="50"><a href="https://github.com/bern66">bern66</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-387164885">2018-05-07 18:49</a>:<a class="headerlink" href="#bern66_commented_at_2018-05-07_1849" title="Permanent link">&para;</a></h4>
<p>I compiled the latest version of ReaR and ended up with the same problem
as initially described except that I use no friendly names:</p>
<pre><code>RESCUE tstinf01:~ # rear -D recover
Relax-and-Recover 2.3. / 2018-05-07
Using log file: /var/log/rear/rear-tstinf01.log
Running workflow recover within the ReaR rescue/recovery system

[snip]

UserInput: No choices - result is 'yes'
User confirmed to proceed with recovery
No code has been generated to recreate pv:/dev/mapper/3600507680c800450b80000000000093e_part2 (lvmdev).
    To recreate it manually add code to /var/lib/rear/layout/diskrestore.sh or abort.
UserInput -I ADD_CODE_TO_RECREATE_MISSING_PVDEVMAPPER3600507680C800450B80000000000093EPART2LVMDEV needed in /usr/share/rear/layout/prepare/default/600_show_unprocessed.sh line 33
Manually add code that recreates pv:/dev/mapper/3600507680c800450b80000000000093e_part2 (lvmdev)
1) View /var/lib/rear/layout/diskrestore.sh
2) Edit /var/lib/rear/layout/diskrestore.sh
3) Go to Relax-and-Recover shell
4) Continue 'rear recover'
5) Abort 'rear recover'
(default '4' timeout 300 seconds)
</code></pre>
<p>One thing I do not understand, @schabrolles you said in a comment that
XXXX_part2 was not there but it is. See below:</p>
<p>tstinf02:~ # grep part2 disklayout.conf<br />
lvmdev /dev/system /dev/mapper/3600507680c800450b80000000000093e_part2
RWHsoG-C5a3-78M5-FmaZ-xMvD-dN5N-jSsKXJ 208973520</p>
<p>I attach the <code>disklayout.conf</code> and the log file of <code>rear -D recover</code> if
it can help.</p>
<p><a href="https://github.com/rear/rear/files/1981061/log_disklayout.tar.gz">log_disklayout.tar.gz</a></p>
<h4 id="schabrolles_commented_at_2018-05-07_1916"><img src="https://avatars.githubusercontent.com/u/19491077?u=0021b16ab426902cbe676f6831f41607bbe4d441&v=4" width="50"><a href="https://github.com/schabrolles">schabrolles</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-387172760">2018-05-07 19:16</a>:<a class="headerlink" href="#schabrolles_commented_at_2018-05-07_1916" title="Permanent link">&para;</a></h4>
<p>@bern66,</p>
<p>The issue is you have
<code>lvmdev /dev/system /dev/mapper/3600507680c800450b80000000000093e_part2</code>
but the partition is named
<code>part /dev/mapper/3600507680c800450b80000000000093e2</code> instead of
<code>part /dev/mapper/3600507680c800450b80000000000093e_part2</code>.</p>
<p>As explained in a previous comment, could you give a try to the patch I
prepared for issue #1766. I think it could help here.</p>
<pre><code>git clone https://github.com/schabrolles/rear -b issue_1766
mv rear rear.github.issue_1766
cd rear.github.issue_1766
vi etc/rear/local.conf
usr/sbin/rear -D mkbackup
</code></pre>
<h4 id="bern66_commented_at_2018-05-08_1400"><img src="https://avatars.githubusercontent.com/u/38959869?u=f7f85617d38f6bebe9285f89b6794b229152df0c&v=4" width="50"><a href="https://github.com/bern66">bern66</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-387412149">2018-05-08 14:00</a>:<a class="headerlink" href="#bern66_commented_at_2018-05-08_1400" title="Permanent link">&para;</a></h4>
<p>@schabrolles<br />
I tried the fix for issue 1766 and got the same problem.</p>
<pre><code>RESCUE tstinf01:~ # rear -D recover
Relax-and-Recover 2.3-git_1766. / 2018-05-08
Using log file: /var/log/rear/rear-tstinf01.log
Running workflow recover within the ReaR rescue/recovery system
Testing connection to TSM server
. . .
UserInput -I DISK_LAYOUT_PROCEED_RECOVERY needed in /usr/share/rear/layout/prepare/default/250_compare_disks.sh line 146
Proceed with recovery (yes) otherwise manual disk layout configuration is enforced
(default 'yes' timeout 30 seconds)
UserInput: No real user input (empty or only spaces) - using default input
UserInput: No choices - result is 'yes'
Proceeding with recovery by default
No code has been generated to recreate pv:/dev/mapper/3600507680c800450b80000000000093e_part2 (lvmdev).
    To recreate it manually add code to /var/lib/rear/layout/diskrestore.sh or abort.
UserInput -I ADD_CODE_TO_RECREATE_MISSING_PVDEVMAPPER3600507680C800450B80000000000093EPART2LVMDEV needed in /usr/share/rear/layout/prepare/default/600_show_unprocessed.sh line 33
Manually add code that recreates pv:/dev/mapper/3600507680c800450b80000000000093e_part2 (lvmdev)
1) View /var/lib/rear/layout/diskrestore.sh
2) Edit /var/lib/rear/layout/diskrestore.sh
</code></pre>
<p>I attached the disklayout.conf and the log of <code>read -D recover</code>.</p>
<p><a href="https://github.com/rear/rear/files/1984200/rear-20180508.zip">rear-20180508.zip</a></p>
<p>I'll now take a look at your message regarding 1802.</p>
<p>Thanks for your help</p>
<h4 id="schabrolles_commented_at_2018-05-08_1406"><img src="https://avatars.githubusercontent.com/u/19491077?u=0021b16ab426902cbe676f6831f41607bbe4d441&v=4" width="50"><a href="https://github.com/schabrolles">schabrolles</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-387414313">2018-05-08 14:06</a>:<a class="headerlink" href="#schabrolles_commented_at_2018-05-08_1406" title="Permanent link">&para;</a></h4>
<p>@bern66,<br />
send me the logfile generated during "rear -D mkbackup"</p>
<h4 id="bern66_commented_at_2018-05-08_1412"><img src="https://avatars.githubusercontent.com/u/38959869?u=f7f85617d38f6bebe9285f89b6794b229152df0c&v=4" width="50"><a href="https://github.com/bern66">bern66</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-387416408">2018-05-08 14:12</a>:<a class="headerlink" href="#bern66_commented_at_2018-05-08_1412" title="Permanent link">&para;</a></h4>
<p>@schabrolles<br />
Here is the log!</p>
<p><a href="https://github.com/rear/rear/files/1984245/rear-tstinf01-rear-D-mkrescue.log.zip">rear-tstinf01-rear-D-mkrescue.log.zip</a></p>
<h4 id="schabrolles_commented_at_2018-05-08_1454"><img src="https://avatars.githubusercontent.com/u/19491077?u=0021b16ab426902cbe676f6831f41607bbe4d441&v=4" width="50"><a href="https://github.com/schabrolles">schabrolles</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-387430515">2018-05-08 14:54</a>:<a class="headerlink" href="#schabrolles_commented_at_2018-05-08_1454" title="Permanent link">&para;</a></h4>
<p>@bern66,</p>
<p>Is it possible to have a look to your <code>/etc/multipath.conf</code>.<br />
I really don't know why your system is generating block devices in
<code>/dev/mapper</code>... You should only have some links which point to
<code>/dev/dm- X</code>. (except <code>control</code>)</p>
<h4 id="bern66_commented_at_2018-05-08_1505"><img src="https://avatars.githubusercontent.com/u/38959869?u=f7f85617d38f6bebe9285f89b6794b229152df0c&v=4" width="50"><a href="https://github.com/bern66">bern66</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-387434374">2018-05-08 15:05</a>:<a class="headerlink" href="#bern66_commented_at_2018-05-08_1505" title="Permanent link">&para;</a></h4>
<p>@schabrolles<br />
Why not! There is no secret in a multipath.conf file. Here it is:</p>
<pre><code># Default multipath.conf file created for install boot
# Used mpathN names
defaults {
user_friendly_names no
}
devices {
    device {
        vendor "IBM"
        product "^2145"
        path_grouping_policy "group_by_prio"
        features "1 queue_if_no_path"
        prio "alua"
        failback "immediate"
    }
}
</code></pre>
<p>I hope it can help you.</p>
<p>Thanks for your great assitance!</p>
<h4 id="schabrolles_commented_at_2018-05-08_1535"><img src="https://avatars.githubusercontent.com/u/19491077?u=0021b16ab426902cbe676f6831f41607bbe4d441&v=4" width="50"><a href="https://github.com/schabrolles">schabrolles</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-387445056">2018-05-08 15:35</a>:<a class="headerlink" href="#schabrolles_commented_at_2018-05-08_1535" title="Permanent link">&para;</a></h4>
<p>@bern66,<br />
I got exactly the same config: PowerVM LPAR with SLES12 and multipath
disks on SAN over a IBM SVC (2145)</p>
<p>But .... I can't reproduce what you have on your side. I use the same
<code>multipath.conf</code> file and NO block device into <code>/dev/mapper</code>. only
links:</p>
<pre><code>rear-sles12-143:~ # ls -l /dev/mapper/
total 0
lrwxrwxrwx 1 root root       7 May  8 17:26 3600507680c82004cf8000000000000d8 -&gt; ../dm-0
lrwxrwxrwx 1 root root       7 May  8 17:26 3600507680c82004cf8000000000000d8_part1 -&gt; ../dm-5
lrwxrwxrwx 1 root root       7 May  8 17:26 3600507680c82004cf8000000000000d8-part1 -&gt; ../dm-5
lrwxrwxrwx 1 root root       7 May  8 17:26 3600507680c82004cf8000000000000d8_part2 -&gt; ../dm-6
lrwxrwxrwx 1 root root       7 May  8 17:26 3600507680c82004cf8000000000000d8-part2 -&gt; ../dm-6
lrwxrwxrwx 1 root root       7 May  8 17:26 3600507680c82004cf8000000000008d4 -&gt; ../dm-1
lrwxrwxrwx 1 root root       7 May  8 17:26 3600507680c82004cf8000000000008d4_part1 -&gt; ../dm-3
lrwxrwxrwx 1 root root       7 May  8 17:26 3600507680c82004cf8000000000008d4-part1 -&gt; ../dm-3
lrwxrwxrwx 1 root root       7 May  8 17:26 3600507680c82004cf8000000000008d5 -&gt; ../dm-2
lrwxrwxrwx 1 root root       7 May  8 17:26 3600507680c82004cf8000000000008d5_part1 -&gt; ../dm-4
lrwxrwxrwx 1 root root       7 May  8 17:26 3600507680c82004cf8000000000008d5-part1 -&gt; ../dm-4
crw------- 1 root root 10, 236 May  8 17:26 control
lrwxrwxrwx 1 root root       7 May  8 17:26 system-root -&gt; ../dm-7
lrwxrwxrwx 1 root root       7 May  8 17:26 system-swap -&gt; ../dm-8
lrwxrwxrwx 1 root root       7 May  8 17:26 vgdata-lv_data -&gt; ../dm-9
</code></pre>
<p>Getting a multipath partition name give me this: (which is OK)</p>
<pre><code>rear-sles12-143:~ # cat /sys/block/dm-6/dm/name 
3600507680c82004cf8000000000000d8-part2
</code></pre>
<p>You may be have some custom udev rules that creates this block devices.
Could you pleas list the content of your <code>/etc/udev/rules.d</code> directory ?
here is mine:</p>
<pre><code>rear-sles12-143:~ # ls -l /etc/udev/rules.d/
total 128
-rw-r--r-- 1 root root  594 Dec 21 13:52 50-iscsi-firmware-login.rules
-rw-r--r-- 1 root root 1062 May  5 18:00 70-persistent-net.rules
</code></pre>
<h4 id="bern66_commented_at_2018-05-08_1627"><img src="https://avatars.githubusercontent.com/u/38959869?u=f7f85617d38f6bebe9285f89b6794b229152df0c&v=4" width="50"><a href="https://github.com/bern66">bern66</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-387461461">2018-05-08 16:27</a>:<a class="headerlink" href="#bern66_commented_at_2018-05-08_1627" title="Permanent link">&para;</a></h4>
<p>I think I might have found something.</p>
<p>Look what I had in /etc/udev/rules.d/:</p>
<pre>
tstinf01:~ # ll /etc/udev/rules.d/
total 128
-rw-r--r-- 1 root root  66 Apr 24 11:18 70-persistent-net.rules
-rw-r--r-- 1 root root 998 Jul 10  2017 99-storixmpath.rules
</pre>

<p>So with those rules, we had:</p>
<pre>
tstinf01:/etc/udev/rules.d # ll /dev/mapper/
total 0
brw-r----- 1 root disk 254,   0 May  8 10:05 3600507680c800450b80000000000093e
brw-r----- 1 root disk 254,   1 May  8 10:05 3600507680c800450b80000000000093e1
brw-r----- 1 root disk 254,   2 May  8 10:05 3600507680c800450b80000000000093e2
lrwxrwxrwx 1 root root        7 May  8 10:05 3600507680c800450b80000000000093e_part1 -> ../dm-1
lrwxrwxrwx 1 root root        7 May  8 10:05 3600507680c800450b80000000000093e_part2 -> ../dm-2
</pre>

<p>I disable 99-storixmpath.rules:</p>
<pre>
tstinf01:~ # ll /etc/udev/rules.d/
total 128
-rw-r--r-- 1 root root  66 Apr 24 11:18 70-persistent-net.rules
-rw-r--r-- 1 root root 998 Jul 10  2017 99-storixmpath.rules.WHATISTHIS
</pre>

<p>I rebooted and got links for everything.</p>
<pre>
tstinf01:~ # ls -l /dev/mapper/
total 0
lrwxrwxrwx 1 root root       7 May  8 11:44 3600507680c800450b80000000000093e -> ../dm-0
lrwxrwxrwx 1 root root       7 May  8 11:44 3600507680c800450b80000000000093e1 -> ../dm-1
lrwxrwxrwx 1 root root       7 May  8 11:44 3600507680c800450b80000000000093e2 -> ../dm-2
lrwxrwxrwx 1 root root       7 May  8 11:44 3600507680c800450b80000000000093e_part1 -> ../dm-1
lrwxrwxrwx 1 root root       7 May  8 11:44 3600507680c800450b80000000000093e_part2 -> ../dm-2
</pre>

<p>But in /sys we still see <code>3600507680c800450b80000000000093e1</code> while we
need <code>3600507680c800450b80000000000093e_part1</code> if I understand you.</p>
<pre>
tstinf01:~ # cat /sys/block/dm-1/dm/name
3600507680c800450b80000000000093e1
</pre>

<h4 id="schabrolles_commented_at_2018-05-08_1632"><img src="https://avatars.githubusercontent.com/u/19491077?u=0021b16ab426902cbe676f6831f41607bbe4d441&v=4" width="50"><a href="https://github.com/schabrolles">schabrolles</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-387463106">2018-05-08 16:32</a>:<a class="headerlink" href="#schabrolles_commented_at_2018-05-08_1632" title="Permanent link">&para;</a></h4>
<p>@bern66 ,<br />
Do you have run <code>mkinitrd</code> to regenerate the ramdisk before rebooting ?</p>
<h4 id="bern66_commented_at_2018-05-08_1640"><img src="https://avatars.githubusercontent.com/u/38959869?u=f7f85617d38f6bebe9285f89b6794b229152df0c&v=4" width="50"><a href="https://github.com/bern66">bern66</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-387465346">2018-05-08 16:40</a>:<a class="headerlink" href="#bern66_commented_at_2018-05-08_1640" title="Permanent link">&para;</a></h4>
<p>Yes I have mkinitrd.... but you are scaring me a bit.... Don't tell me
I'll have to regenerate a new initrd??</p>
<h4 id="bern66_commented_at_2018-05-08_1653"><img src="https://avatars.githubusercontent.com/u/38959869?u=f7f85617d38f6bebe9285f89b6794b229152df0c&v=4" width="50"><a href="https://github.com/bern66">bern66</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-387469272">2018-05-08 16:53</a>:<a class="headerlink" href="#bern66_commented_at_2018-05-08_1653" title="Permanent link">&para;</a></h4>
<p>As this is a test lpar, I ran mkinitrd.</p>
<pre>
tstinf01:~> ls -l /dev/mapper/
total 0
lrwxrwxrwx 1 root root       7 May  8 12:51 3600507680c800450b80000000000093e -> ../dm-0
lrwxrwxrwx 1 root root       7 May  8 12:51 3600507680c800450b80000000000093e_part1 -> ../dm-1
lrwxrwxrwx 1 root root       7 May  8 12:51 3600507680c800450b80000000000093e-part1 -> ../dm-1
lrwxrwxrwx 1 root root       7 May  8 12:51 3600507680c800450b80000000000093e_part2 -> ../dm-2
lrwxrwxrwx 1 root root       7 May  8 12:51 3600507680c800450b80000000000093e-part2 -> ../dm-2
</pre>

<h4 id="schabrolles_commented_at_2018-05-08_1654"><img src="https://avatars.githubusercontent.com/u/19491077?u=0021b16ab426902cbe676f6831f41607bbe4d441&v=4" width="50"><a href="https://github.com/schabrolles">schabrolles</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-387469615">2018-05-08 16:54</a>:<a class="headerlink" href="#schabrolles_commented_at_2018-05-08_1654" title="Permanent link">&para;</a></h4>
<p>Try <code>lsinitrd | grep storix</code> ... if you see the old file, this mean you
have to regenerate the ramdisk to remove it. Otherwise, the storix
script will run in the initrd during boot time.</p>
<h4 id="schabrolles_commented_at_2018-05-08_1657"><img src="https://avatars.githubusercontent.com/u/19491077?u=0021b16ab426902cbe676f6831f41607bbe4d441&v=4" width="50"><a href="https://github.com/schabrolles">schabrolles</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-387470462">2018-05-08 16:57</a>:<a class="headerlink" href="#schabrolles_commented_at_2018-05-08_1657" title="Permanent link">&para;</a></h4>
<p>@bern66 ,</p>
<p>Much better !!!! then try again <code>rear mkbackup</code> and <code>rear recover</code> and
give us good news !!!</p>
<h4 id="bern66_commented_at_2018-05-08_1812"><img src="https://avatars.githubusercontent.com/u/38959869?u=f7f85617d38f6bebe9285f89b6794b229152df0c&v=4" width="50"><a href="https://github.com/bern66">bern66</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-387493151">2018-05-08 18:12</a>:<a class="headerlink" href="#bern66_commented_at_2018-05-08_1812" title="Permanent link">&para;</a></h4>
<p>@schabrolles<br />
No good news.....</p>
<pre>
UserInput -I LAYOUT_CODE_RUN needed in /usr/share/rear/layout/recreate/default/200_run_layout_code.sh line 127
The disk layout recreation script failed
</pre>

<pre>
RESCUE tstinf01:~ # rear -vD recover
Relax-and-Recover 2.3-git_1766. / 2018-05-08
Using log file: /var/log/rear/rear-tstinf01.log
Running workflow recover within the ReaR rescue/recovery system
Testing connection to TSM server
IBM Spectrum Protect
Command Line Backup-Archive Client Interface
  Client Version 8, Release 1, Level 2.0
  Client date/time: 05/08/18   18:04:07
(c) Copyright by IBM Corporation and other(s) 1990, 2017. All Rights Reserved.

Node Name: STSTINF01
Session established with server GISPA: Linux/x86_64
  Server Version 8, Release 1, Level 4.000
  Server date/time: 05/08/18   14:04:07  Last access: 05/08/18   13:58:32

IBM Spectrum Protect Server Connection Information

Home Server Name........: GISPA
Server Type.............: Linux/x86_64
Archive Retain Protect..: "No"
Server Version..........: Ver. 8, Rel. 1, Lev. 4.0
Last Access Date........: 05/08/18   13:58:32
Delete Backup Files.....: "No"
Delete Archive Files....: "Yes"
Deduplication...........: "Client Or Server"

Node Name...............: STSTINF01
User Name...............: root

SSL Information.........: TLSv1.2 AES-256-GCM

Secondary Server Information
Configured for failover to server GISPB

Testing connection to TSM server completed successfully

TSM restores by default the latest backup data. Alternatively you can specify
a different date and time to enable Point-In-Time Restore. Press ENTER to
use the most recent available backup
Enter date/time (YYYY-MM-DD HH:mm:ss) or press ENTER [30 secs]:
Skipping Point-In-Time Restore, will restore most recent data.

The TSM Server reports the following for this node:
                  #     Last Incr Date          Type    Replication       File Space Name
                --------------------------------------------------------------------------------
                  1     07-05-2018 22:11:31     BTRFS   Current           /
                  2     07-05-2018 22:11:04     BTRFS   Current           /.snapshots
                  3     07-05-2018 22:11:04     BTRFS   Current           /boot/grub2/powerpc-ieee1275
                  4     07-05-2018 22:11:18     XFS     Current           /home
                  5     07-05-2018 22:11:04     BTRFS   Current           /opt
                  6     07-05-2018 22:11:07     BTRFS   Current           /srv
                  7     07-05-2018 22:11:04     BTRFS   Current           /usr/local
                  8     07-05-2018 22:11:04     BTRFS   Current           /var/cache
                  9     07-05-2018 22:11:04     BTRFS   Current           /var/crash
                 10     07-05-2018 22:11:08     BTRFS   Current           /var/lib/libvirt/images
                 11     07-05-2018 22:11:08     BTRFS   Current           /var/lib/machines
                 12     07-05-2018 22:11:04     BTRFS   Current           /var/lib/mailman
                 13     07-05-2018 22:11:04     BTRFS   Current           /var/lib/mariadb
                 14     07-05-2018 22:10:54     BTRFS   Current           /var/lib/mysql
                 15     07-05-2018 22:11:13     BTRFS   Current           /var/lib/named
                 16     07-05-2018 22:11:07     BTRFS   Current           /var/lib/pgsql
                 17     07-05-2018 22:11:13     BTRFS   Current           /var/log
                 18     07-05-2018 22:11:06     BTRFS   Current           /var/opt
                 19     07-05-2018 22:11:13     BTRFS   Current           /var/spool
                 20     07-05-2018 22:11:07     BTRFS   Current           /var/tmp
Please enter the numbers of the filespaces we should restore.
Pay attention to enter the filesystems in the correct order
(like restore / before /var/log)
(default: 1 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20): [30 secs]
The following filesystems will be restored:
/
/boot/grub2/powerpc-ieee1275
/home
/opt
/srv
/usr/local
/var/cache
/var/crash
/var/lib/libvirt/images
/var/lib/machines
/var/lib/mailman
/var/lib/mariadb
/var/lib/mysql
/var/lib/named
/var/lib/pgsql
/var/log
/var/opt
/var/spool
/var/tmp
Is this selection correct ? (Y|n) [30 secs] y
Setting up multipathing
Activating multipath
multipath activated
Listing multipath device found
3600507680c800450b80000000000093e       (254, 0)
Comparing disks
Device dm-0 has expected (same) size 107374182400 (will be used for recovery)
Disk configuration looks identical
UserInput -I DISK_LAYOUT_PROCEED_RECOVERY needed in /usr/share/rear/layout/prepare/default/250_compare_disks.sh line 146
Proceed with recovery (yes) otherwise manual disk layout configuration is enforced
(default 'yes' timeout 30 seconds)
yes
UserInput: No choices - result is 'yes'
User confirmed to proceed with recovery
Start system layout restoration.
Creating partitions for disk /dev/mapper/3600507680c800450b80000000000093e (msdos)
Creating LVM PV /dev/mapper/3600507680c800450b80000000000093e-part2
Restoring LVM VG system
Sleeping 3 seconds to let udev or systemd-udevd create their devices...
Creating filesystem of type btrfs with mount point / on /dev/mapper/system-root.
Mounting filesystem /
UserInput -I LAYOUT_CODE_RUN needed in /usr/share/rear/layout/recreate/default/200_run_layout_code.sh line 127
The disk layout recreation script failed
1) Rerun disk recreation script (/var/lib/rear/layout/diskrestore.sh)
2) View 'rear recover' log file (/var/log/rear/rear-tstinf01.log)
3) Edit disk recreation script (/var/lib/rear/layout/diskrestore.sh)
4) View original disk space usage (/var/lib/rear/layout/config/df.txt)
5) Use Relax-and-Recover shell and return back to here
6) Abort 'rear recover'
(default '1' timeout 300 seconds)
6
UserInput: Valid choice number result 'Abort 'rear recover''
ERROR: User chose to abort 'rear recover' in /usr/share/rear/layout/recreate/default/200_run_layout_code.sh
Aborting due to an error, check /var/log/rear/rear-tstinf01.log for details
Exiting rear recover (PID 4193) and its descendant processes
Running exit tasks
You should also rm -Rf /tmp/rear.F25RIt3XyC7og40
Terminated
RESCUE tstinf01:~ #
</pre>

<h4 id="schabrolles_commented_at_2018-05-08_1837"><img src="https://avatars.githubusercontent.com/u/19491077?u=0021b16ab426902cbe676f6831f41607bbe4d441&v=4" width="50"><a href="https://github.com/schabrolles">schabrolles</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-387500638">2018-05-08 18:37</a>:<a class="headerlink" href="#schabrolles_commented_at_2018-05-08_1837" title="Permanent link">&para;</a></h4>
<p>send /var/log/rear/rear-tstinf01.log</p>
<h4 id="bern66_commented_at_2018-05-08_1849"><img src="https://avatars.githubusercontent.com/u/38959869?u=f7f85617d38f6bebe9285f89b6794b229152df0c&v=4" width="50"><a href="https://github.com/bern66">bern66</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-387504298">2018-05-08 18:49</a>:<a class="headerlink" href="#bern66_commented_at_2018-05-08_1849" title="Permanent link">&para;</a></h4>
<p>@schabrolles<br />
Here is the log.</p>
<p><a href="https://github.com/rear/rear/files/1985232/rear-tstinf01.log">rear-tstinf01.log</a></p>
<p>But I don't know what I will do if I have to run mkinitrd on 200+
LPARs???</p>
<p>Thanks again for you assistance!</p>
<h4 id="schabrolles_commented_at_2018-05-08_1906"><img src="https://avatars.githubusercontent.com/u/19491077?u=0021b16ab426902cbe676f6831f41607bbe4d441&v=4" width="50"><a href="https://github.com/schabrolles">schabrolles</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-387509250">2018-05-08 19:06</a>:<a class="headerlink" href="#schabrolles_commented_at_2018-05-08_1906" title="Permanent link">&para;</a></h4>
<p>@bern66,</p>
<p>if you have installed storix on your 200+ LPARS, then you will have to
run mkinitrd after having removed <code>99-storixmpath.rules</code></p>
<p>For the error, it seems that the device
<code>/dev/mapper/3600507680c800450b80000000000093e-part2</code> is used ....
don't know why.</p>
<pre><code>lvm pvcreate -ff --yes -v --uuid RWHsoG-C5a3-78M5-FmaZ-xMvD-dN5N-jSsKXJ --restorefile /var/lib/rear/layout/lvm/system.cfg /dev/mapper/3600507680c800450b80000000000093e-part2
Can't open /dev/mapper/3600507680c800450b80000000000093e-part2 exclusively.  Mounted filesystem?
</code></pre>
<p>Did you try several time rear recover without rebooting on the DVD media
?</p>
<h4 id="bern66_commented_at_2018-05-08_1916"><img src="https://avatars.githubusercontent.com/u/38959869?u=f7f85617d38f6bebe9285f89b6794b229152df0c&v=4" width="50"><a href="https://github.com/bern66">bern66</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-387511981">2018-05-08 19:16</a>:<a class="headerlink" href="#bern66_commented_at_2018-05-08_1916" title="Permanent link">&para;</a></h4>
<p>Well storix has not been installed on all our LPARS but on the image
from which all other LPARs have been created therefore it is .</p>
<p>Yes, I tried a few times until I realize I forgot to tell the TSM server
to be open up the security for my test machine on first login for a
recover. This is a security feature in TSM. I have to do it every time I
do a test.</p>
<h4 id="schabrolles_commented_at_2018-05-08_1946"><img src="https://avatars.githubusercontent.com/u/19491077?u=0021b16ab426902cbe676f6831f41607bbe4d441&v=4" width="50"><a href="https://github.com/schabrolles">schabrolles</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-387520346">2018-05-08 19:46</a>:<a class="headerlink" href="#schabrolles_commented_at_2018-05-08_1946" title="Permanent link">&para;</a></h4>
<p>Then, I'm afraid you will have to regenerate initrd on all your LPARs to
completely clean and remove storix stuff.</p>
<p>I think the fact that you retry to recover several times without
rebooting can explain the error you got. ReaR recreates the disklayout
(partition/LVM/fs) and mount the new filesystem on <code>/mnt/local</code>. Then,
it starts TSM to recover the data in <code>/mnt/local</code>.</p>
<p>If you have to retry a recovery without rebooting on the ISO image,
don't forget to:</p>
<ul>
<li>umount everything from <code>/mnt/local</code></li>
<li>go to <code>/var/lib/rear/layout</code> and restore the disklayout.conf (rear
    create a backup of the file each time a recover is started) This
    important if you are doing a migration (restore to another
    hardware).</li>
</ul>
<p>Could you try again by rebooting on the recovery media?</p>
<h4 id="jsmeix_commented_at_2018-05-09_1005"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-387690055">2018-05-09 10:05</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-05-09_1005" title="Permanent link">&para;</a></h4>
<p>@schabrolles<br />
only FYI regarding your
<a href="https://github.com/rear/rear/issues/1796#issuecomment-387445056">https://github.com/rear/rear/issues/1796#issuecomment-387445056</a></p>
<p>Nowadays the system's default udev rules are in /usr/lib/udev/rules.d/<br />
e.g. the kpartx RPM provides /usr/lib/udev/rules.d/66-kpartx.rules<br />
and the udev rules in /etc/udev/rules.d/ are primarily meant for<br />
user-specific udev rules, see "man udev" that reads (excerpt)</p>
<pre>
RULES FILES
The udev rules are read from the files located in the
system rules directory /usr/lib/udev/rules.d,
the volatile runtime directory /run/udev/rules.d
and the local administration directory /etc/udev/rules.d.
All rules files are collectively sorted and processed in
lexical order, regardless of the directories in which they live.
However, files with identical filenames replace each other.
Files in /etc have the highest priority, files in /run take
precedence over files with the same name in /usr/lib.
This can be used to override a system-supplied rules file
with a local file if needed; a symlink in /etc with the same
name as a rules file in /usr/lib, pointing to /dev/null,
disables the rules file entirely.
Rule files must have the extension .rules;
other extensions are ignored.
</pre>

<h4 id="jsmeix_commented_at_2018-05-09_1026"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-387695097">2018-05-09 10:26</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-05-09_1026" title="Permanent link">&para;</a></h4>
<p>@bern66<br />
I don't know about Storix.<br />
Could you provide some basic background information<br />
why you use it in addition to ReaR?</p>
<p>I only see at<br />
<a href="https://www.storix.com/">https://www.storix.com/</a><br />
that it is another "Full-system backup and disaster recovery" tool<br />
and in<br />
<a href="https://www.storix.com/download/sbaDM-Multipath.pdf">https://www.storix.com/download/sbaDM-Multipath.pdf</a><br />
their special requirements regarding multipath are described<br />
in particular they need <code>user_friendly_names yes</code> plus their<br />
particular udev rules file /etc/udev/rules.d/99-storixmpath.rules</p>
<p>It seems using Storix conflicts with using ReaR at least in case of
multipath<br />
and it is good when we at ReaR upstream know about that possible
conflict<br />
so that we may describe that possible conflict in the ReaR
documentation<br />
to avoid that also other users have to learn it the hard way that a
prior usage<br />
or setup of Storix on a system may cause issues when later ReaR is used.</p>
<h4 id="jsmeix_commented_at_2018-05-09_1037"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-387697624">2018-05-09 10:37</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-05-09_1037" title="Permanent link">&para;</a></h4>
<p>In general regarding retrying "rear recover":</p>
<p>It depends if umounting everything from /mnt/local/<br />
plus using the original disklayout.conf is sufficient<br />
because when the diskrestore.sh script had (partially) run<br />
the disks are (partially) changed in whatever unwanted<br />
and possibly broken way.</p>
<p>Unfortunately ReaR still has no "cleanupdisk" script<br />
cf.
<a href="https://github.com/rear/rear/issues/799">https://github.com/rear/rear/issues/799</a><br />
so that a subsequent "rear recover" may fail because<br />
a prior "rear recover" had somehow messed up the disk.</p>
<p>This means one may have to manually clean up the disks<br />
before retrying "rear recover".</p>
<h4 id="bern66_commented_at_2018-05-09_1229"><img src="https://avatars.githubusercontent.com/u/38959869?u=f7f85617d38f6bebe9285f89b6794b229152df0c&v=4" width="50"><a href="https://github.com/bern66">bern66</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-387722461">2018-05-09 12:29</a>:<a class="headerlink" href="#bern66_commented_at_2018-05-09_1229" title="Permanent link">&para;</a></h4>
<p>We thought about using storix at some point but it has been removed from
our environment. Removed but unfortunately, some traces of it are still
laying around.</p>
<p>Now making sure our TSM server is ready for a recover, I rebooted my
server and tried another <code>rear -D recover</code> only once. ;-) I block on the
following fail.</p>
<pre><code>Mounting filesystem /
UserInput -I LAYOUT_CODE_RUN needed in /usr/share/rear/layout/recreate/default/200_run_layout_code.sh line 127
The disk layout recreation script failed
</code></pre>
<p>The recover log is attached as well as the disklayout.conf if it can
help.</p>
<p>Thanks for your help or devotion should I say. :-)</p>
<p><a href="https://github.com/rear/rear/files/1987769/recover-20180509.zip">recover-20180509.zip</a></p>
<h4 id="schabrolles_commented_at_2018-05-09_1406"><img src="https://avatars.githubusercontent.com/u/19491077?u=0021b16ab426902cbe676f6831f41607bbe4d441&v=4" width="50"><a href="https://github.com/schabrolles">schabrolles</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-387750489">2018-05-09 14:06</a>:<a class="headerlink" href="#schabrolles_commented_at_2018-05-09_1406" title="Permanent link">&para;</a></h4>
<p>@bern66</p>
<p>Did you add the following lines in your rear configuration file? (see
<a href="https://github.com/rear/rear/issues/1796#issuecomment-386592239">https://github.com/rear/rear/issues/1796#issuecomment-386592239</a>)</p>
<pre><code>## SLES12
BACKUP_OPTIONS="nfsvers=4,nolock"
REQUIRED_PROGS=( "${REQUIRED_PROGS[@]}" snapper chattr lsattr )
COPY_AS_IS=( "${COPY_AS_IS[@]}" /usr/lib/snapper/installation-helper /etc/snapper/config-templates/default )

for subvol in $(findmnt -n -r -t btrfs | cut -d ' ' -f 1 | grep -v '^/$' | egrep -v 'snapshots|crash') ; do
    BACKUP_PROG_INCLUDE=( "${BACKUP_PROG_INCLUDE[@]}" "$subvol" )
done

POST_RECOVERY_SCRIPT=( 'if snapper --no-dbus -r $TARGET_FS_ROOT get-config | grep -q "^QGROUP.*[0-9]/[0-9]" ; then snapper --no-dbus -r $TARGET_FS_ROOT set-config QGROUP= ; snapper --no-dbus -r $TARGET_FS_ROOT setup-quota &amp;&amp; echo snapper setup-quota done || echo snapper setup-quota failed ; else echo snapper setup-quota not used ; fi' )
</code></pre>
<h4 id="bern66_commented_at_2018-05-09_1514"><img src="https://avatars.githubusercontent.com/u/38959869?u=f7f85617d38f6bebe9285f89b6794b229152df0c&v=4" width="50"><a href="https://github.com/bern66">bern66</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-387773622">2018-05-09 15:14</a>:<a class="headerlink" href="#bern66_commented_at_2018-05-09_1514" title="Permanent link">&para;</a></h4>
<p>Yes, those entries are in my rear configuration file site.conf. Here is
the content of my site.conf.<br />
I like your idea of a for loop for BACKUP_PROG_INCLUDE. I'll use your
suggestion.</p>
<pre><code>OUTPUT=ISO
OUTPUT_URL=nfs://tstinf02/exports/rear/iso
ISO_PREFIX="$HOSTNAME-rear-$( date "+%y%m%d" )"
ISO_VOLID=$HOSTNAME

REAR_INITRD_COMPRESSION=lzma

MODULES_LOAD=( autofs4 scsi_mod scsi_dh_alua scsi_dh_emc scsi_dh_rdac dm_mod dm_multipath sg dm_log dm_region_hash dm_mirror scsi_transport_srp scsi_transport_fc ibmvscsi ibmvfc cdrom sr_mod sd_mod dm_service_time raid6_pq xor btrfs sunrpc rtc_generic ibmveth libcrc32c xfs af_packet isofs nls_utf8 netlink_diag af_packet_diag unix_diag inet_diag udp_diag tcp_diag rpaphp rpadlpar_io )

REQUIRED_PROGS=( "${REQUIRED_PROGS[@]}" snapper chattr lsattr )

COPY_AS_IS=( "${COPY_AS_IS[@]}" /usr/lib/snapper/installation-helper /etc/snapper/config-templates/default )

BACKUP_PROG_INCLUDE=( '/var/log/*' '/var/lib/mysql/*' '/var/lib/pgsql/*' '/var/lib/mariadb/*' '/var/lib/libvirt/images/*' '/var/lib/named/*' '/var/crash/*' '/var/lib/machines/*' '/.snapshots/*' '/opt/*' '/usr/local/*' '/tmp/*' '/var/cache/*' '/var/tmp/*' '/var/lib/mailman/*' '/var/spool/*' '/var/opt/*' '/srv/*' '/boot/grub2/powerpc-ieee1275/*' )

AUTOEXCLUDE_MULTIPATH=n

BOOT_OVER_SAN=y

BACKUP=TSM

COPY_AS_IS_TSM=( /etc/$HOSTNAME /opt/tivoli/tsm/client/ba/bin/dsmc /opt/tivoli/tsm/client/ba/bin/tsmbench_inclexcl /opt/tivoli/tsm/client/ba/bin/dsm.sys /opt/tivoli/tsm/client/ba/bin/dsm.opt /opt/tivoli/tsm/client/api/bin64/libgpfs.so /opt/tivoli/tsm/client/api/bin64/libdmapi.so /opt/tivoli/tsm/client/ba/bin/EN_US/dsmclientV3.cat /usr/local/ibm/gsk8/* )

COPY_AS_IS_EXCLUDE_TSM=( )

PROGS_TSM=(dsmc)

TSM_LD_LIBRARY_PATH="/opt/tivoli/tsm/client/ba/bin:/opt/tivoli/tsm/client/api/bin64:/opt/tivoli/tsm/client/api/bin:/opt/tivoli/tsm/client/api/bin64/cit/bin"

TSM_RESULT_FILE_PATH=/opt/tivoli/tsm/rear

TSM_RESULT_SAVE=n

TSM_ARCHIVE_MGMT_CLASS=qaasba

TSM_RM_ISOFILE=y
</code></pre>
<h4 id="schabrolles_commented_at_2018-05-09_1610"><img src="https://avatars.githubusercontent.com/u/19491077?u=0021b16ab426902cbe676f6831f41607bbe4d441&v=4" width="50"><a href="https://github.com/schabrolles">schabrolles</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-387792021">2018-05-09 16:10</a>:<a class="headerlink" href="#schabrolles_commented_at_2018-05-09_1610" title="Permanent link">&para;</a></h4>
<p>@jsmeix, I think you could help here.</p>
<p>There is no <code>btrfsdefaultsubvol</code> defined with <code>@/.snapshots</code> in the
@bern66 disklayout.conf.<br />
I think the system was configured to not use snapshots... (@bern66 could
you confirm ?)<br />
So, the snapper installer-helper code is not triggered.</p>
<p>disklayout extract</p>
<pre><code># Btrfs default subvolume for /dev/mapper/system-root at /
# Format: btrfsdefaultsubvol &lt;device&gt; &lt;mountpoint&gt; &lt;btrfs_subvolume_ID&gt; &lt;btrfs_subvolume_path&gt;
btrfsdefaultsubvol /dev/mapper/system-root / 5 /
# Btrfs snapshot subvolumes for /dev/mapper/system-root at /
# Btrfs snapshot subvolumes are listed here only as documentation.
# There is no recovery of btrfs snapshot subvolumes.
# Format: btrfssnapshotsubvol &lt;device&gt; &lt;mountpoint&gt; &lt;btrfs_subvolume_ID&gt; &lt;btrfs_subvolume_path&gt;
#btrfssnapshotsubvol /dev/mapper/system-root / 669 @/.snapshots/255/snapshot
#btrfssnapshotsubvol /dev/mapper/system-root / 670 @/.snapshots/256/snapshot
#btrfssnapshotsubvol /dev/mapper/system-root / 700 @/.snapshots/279/snapshot
#btrfssnapshotsubvol /dev/mapper/system-root / 701 @/.snapshots/280/snapshot
#btrfssnapshotsubvol /dev/mapper/system-root / 702 @/.snapshots/281/snapshot
#btrfssnapshotsubvol /dev/mapper/system-root / 703 @/.snapshots/282/snapshot
#btrfssnapshotsubvol /dev/mapper/system-root / 704 @/.snapshots/283/snapshot
#btrfssnapshotsubvol /dev/mapper/system-root / 705 @/.snapshots/284/snapshot
# Btrfs normal subvolumes for /dev/mapper/system-root at /
# Format: btrfsnormalsubvol &lt;device&gt; &lt;mountpoint&gt; &lt;btrfs_subvolume_ID&gt; &lt;btrfs_subvolume_path&gt;
# Btrfs subvolumes that belong to snapper are listed here only as documentation.
# Snapper's base subvolume '/@/.snapshots' is deactivated here because during 'rear recover'
# it is created by 'snapper/installation-helper --step 1' (which fails if it already exists).
# Furthermore any normal btrfs subvolume under snapper's base subvolume would be wrong.
# See https://github.com/rear/rear/issues/944#issuecomment-238239926
# and https://github.com/rear/rear/issues/963#issuecomment-240061392
# how to create a btrfs subvolume in compliance with the SLES12 default brtfs structure.
# In short: Normal btrfs subvolumes on SLES12 must be created directly below '/@/'
# e.g. '/@/var/lib/mystuff' (which requires that the btrfs root subvolume is mounted)
# and then the subvolume is mounted at '/var/lib/mystuff' to be accessible from '/'
# plus usually an entry in /etc/fstab to get it mounted automatically when booting.
# Because any '@/.snapshots' subvolume would let 'snapper/installation-helper --step 1' fail
# such subvolumes are deactivated here to not let 'rear recover' fail:
#btrfsnormalsubvol /dev/mapper/system-root / 258 @/.snapshots
btrfsnormalsubvol /dev/mapper/system-root / 257 @
</code></pre>
<p>The layout creation failed with the following message:<br />
The subvol .snapshots cannot be found. (I assume it should be recreated
by snapper installer-helper)</p>
<pre><code>+++ grep -q ' on /mnt/local/.snapshots '
+++ test -d /mnt/local/.snapshots
+++ mkdir -p /mnt/local/.snapshots
+++ mount -t btrfs -o rw,relatime,space_cache -o subvol=@/.snapshots /dev/mapper/system-root /mnt/local/.snapshots
mount: mount(2) failed: No such file or directory
++ ((  1 == 0  ))
++ true
+++ UserInput -I LAYOUT_CODE_RUN -p 'The disk layout recreation script failed' -D 'Rerun disk recreation script (/var/lib/rear/layout/diskrestore.sh)' 'Rerun disk recreation script (/var/lib/rear/layout/diskrestore.sh)' 'View '\''rear recover'\'' log file (/var/log/rear/rear-tstinf01.log)' 'Edit disk recreation script (/var/lib/rear/layout/diskrestore.sh)' 'View original disk space usage (/var/lib/rear/layout/config/df.txt)' 'Use Relax-and-Recover shell and return back to here' 'Abort '\''rear recover'\'''
</code></pre>
<h4 id="jsmeix_commented_at_2018-05-09_1627"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-387797072">2018-05-09 16:27</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-05-09_1627" title="Permanent link">&para;</a></h4>
<p>@bern66<br />
I will have a look but please be patient - I am not in the office<br />
until next Moday and next week I am only rarely in the office.</p>
<p>What does on your original system the command</p>
<pre>
findmnt -a -o SOURCE,TARGET,FSTYPE
</pre>

<p>show?</p>
<h4 id="bern66_commented_at_2018-05-09_1712"><img src="https://avatars.githubusercontent.com/u/38959869?u=f7f85617d38f6bebe9285f89b6794b229152df0c&v=4" width="50"><a href="https://github.com/bern66">bern66</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-387809919">2018-05-09 17:12</a>:<a class="headerlink" href="#bern66_commented_at_2018-05-09_1712" title="Permanent link">&para;</a></h4>
<p>Yes, snapshots are enabled in our environment.</p>
<p>Could the problem that @schabrolles is talking about related to the fact
that I didn't select snapshot to be restore? When running
<code>rear recover</code>, it eventually asked for the fs we would like to restore.
I went with the suggested default which didn't include snapshots. Here
is the extract I am talking about.</p>
<pre><code>. . . 
Skipping Point-In-Time Restore, will restore most recent data.

The TSM Server reports the following for this node:
                  #     Last Incr Date          Type    Replication       File Space Name
                --------------------------------------------------------------------------------
                  1     07-05-2018 22:11:31     BTRFS   Current           /
                  2     07-05-2018 22:11:04     BTRFS   Current           /.snapshots
                  3     07-05-2018 22:11:04     BTRFS   Current           /boot/grub2/powerpc-ieee1275
                  4     07-05-2018 22:11:18     XFS     Current           /home
                  5     07-05-2018 22:11:04     BTRFS   Current           /opt
                  6     07-05-2018 22:11:07     BTRFS   Current           /srv
                  7     07-05-2018 22:11:04     BTRFS   Current           /usr/local
                  8     07-05-2018 22:11:04     BTRFS   Current           /var/cache
                  9     07-05-2018 22:11:04     BTRFS   Current           /var/crash
                 10     07-05-2018 22:11:08     BTRFS   Current           /var/lib/libvirt/images
                 11     07-05-2018 22:11:08     BTRFS   Current           /var/lib/machines
                 12     07-05-2018 22:11:04     BTRFS   Current           /var/lib/mailman
                 13     07-05-2018 22:11:04     BTRFS   Current           /var/lib/mariadb
                 14     07-05-2018 22:10:54     BTRFS   Current           /var/lib/mysql
                 15     07-05-2018 22:11:13     BTRFS   Current           /var/lib/named
                 16     07-05-2018 22:11:07     BTRFS   Current           /var/lib/pgsql
                 17     07-05-2018 22:11:13     BTRFS   Current           /var/log
                 18     07-05-2018 22:11:06     BTRFS   Current           /var/opt
                 19     07-05-2018 22:11:13     BTRFS   Current           /var/spool
                 20     07-05-2018 22:11:07     BTRFS   Current           /var/tmp
Please enter the numbers of the filespaces we should restore.
Pay attention to enter the filesystems in the correct order
(like restore / before /var/log)
(default: 1 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20): [30 secs]
The following filesystems will be restored:
/
/boot/grub2/powerpc-ieee1275
/home
/opt
/srv
/usr/local
/var/cache
/var/crash
/var/lib/libvirt/images
/var/lib/machines
/var/lib/mailman
/var/lib/mariadb
/var/lib/mysql
/var/lib/named
/var/lib/pgsql
/var/log
/var/opt
/var/spool
/var/tmp
Is this selection correct ? (Y|n) [30 secs] y
. . .
</code></pre>
<p>@jsmeix your required output is shown below.</p>
<pre><code>tstinf01:~ # findmnt -a -o SOURCE,TARGET,FSTYPE
SOURCE                                                  TARGET                                FSTYPE
/dev/mapper/system-root                                 /                                     btrfs
sysfs                                                   |-/sys                                sysfs
securityfs                                              | |-/sys/kernel/security              securityfs
tmpfs                                                   | |-/sys/fs/cgroup                    tmpfs
cgroup                                                  | | |-/sys/fs/cgroup/systemd          cgroup
cgroup                                                  | | |-/sys/fs/cgroup/memory           cgroup
cgroup                                                  | | |-/sys/fs/cgroup/cpu,cpuacct      cgroup
cgroup                                                  | | |-/sys/fs/cgroup/devices          cgroup
cgroup                                                  | | |-/sys/fs/cgroup/pids             cgroup
cgroup                                                  | | |-/sys/fs/cgroup/hugetlb          cgroup
cgroup                                                  | | |-/sys/fs/cgroup/blkio            cgroup
cgroup                                                  | | |-/sys/fs/cgroup/cpuset           cgroup
cgroup                                                  | | |-/sys/fs/cgroup/freezer          cgroup
cgroup                                                  | | |-/sys/fs/cgroup/net_cls,net_prio cgroup
cgroup                                                  | | `-/sys/fs/cgroup/perf_event       cgroup
pstore                                                  | |-/sys/fs/pstore                    pstore
debugfs                                                 | `-/sys/kernel/debug                 debugfs
tracefs                                                 |   `-/sys/kernel/debug/tracing       tracefs
proc                                                    |-/proc                               proc
systemd-1                                               | `-/proc/sys/fs/binfmt_misc          autofs
binfmt_misc                                             |   `-/proc/sys/fs/binfmt_misc        binfmt_misc
devtmpfs                                                |-/dev                                devtmpfs
tmpfs                                                   | |-/dev/shm                          tmpfs
devpts                                                  | |-/dev/pts                          devpts
mqueue                                                  | |-/dev/mqueue                       mqueue
hugetlbfs                                               | `-/dev/hugepages                    hugetlbfs
tmpfs                                                   |-/run                                tmpfs
tmpfs                                                   | |-/run/user/186                     tmpfs
tmpfs                                                   | |-/run/user/122                     tmpfs
tmpfs                                                   | `-/run/user/110                     tmpfs
sunrpc                                                  |-/var/lib/nfs/rpc_pipefs             rpc_pipefs
/dev/mapper/system-root[/@/opt]                         |-/opt                                btrfs
/dev/mapper/system-root[/@/var/lib/mariadb]             |-/var/lib/mariadb                    btrfs
/dev/mapper/system-root[/@/var/opt]                     |-/var/opt                            btrfs
/dev/mapper/system-root[/@/usr/local]                   |-/usr/local                          btrfs
/dev/mapper/system-root[/@/var/lib/libvirt/images]      |-/var/lib/libvirt/images             btrfs
/dev/mapper/system-root[/@/srv]                         |-/srv                                btrfs
/dev/mapper/system-root[/@/var/lib/pgsql]               |-/var/lib/pgsql                      btrfs
/dev/mapper/system-root[/@/tmp]                         |-/tmp                                btrfs
/dev/mapper/system-root[/@/boot/grub2/powerpc-ieee1275] |-/boot/grub2/powerpc-ieee1275        btrfs
/dev/mapper/system-root[/@/var/cache]                   |-/var/cache                          btrfs
/dev/mapper/system-root[/@/var/lib/machines]            |-/var/lib/machines                   btrfs
/dev/mapper/system-root[/@/var/lib/mailman]             |-/var/lib/mailman                    btrfs
/dev/mapper/system-root[/@/var/lib/mysql]               |-/var/lib/mysql                      btrfs
/dev/mapper/system-root[/@/var/crash]                   |-/var/crash                          btrfs
/dev/mapper/system-root[/@/var/log]                     |-/var/log                            btrfs
/dev/mapper/system-root[/@/.snapshots]                  |-/.snapshots                         btrfs
/dev/mapper/system-root[/@/var/spool]                   |-/var/spool                          btrfs
/dev/mapper/system-root[/@/var/lib/named]               |-/var/lib/named                      btrfs
/dev/mapper/system-root[/@/var/tmp]                     |-/var/tmp                            btrfs
/dev/mapper/system-home                                 |-/home                               xfs
/etc/auto.direct                                        `-/install                            autofs
nfs02:/install                                        `-/install                          nfs4
</code></pre>
<h4 id="schabrolles_commented_at_2018-05-09_1725"><img src="https://avatars.githubusercontent.com/u/19491077?u=0021b16ab426902cbe676f6831f41607bbe4d441&v=4" width="50"><a href="https://github.com/schabrolles">schabrolles</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-387813509">2018-05-09 17:25</a>:<a class="headerlink" href="#schabrolles_commented_at_2018-05-09_1725" title="Permanent link">&para;</a></h4>
<p>@bern66,</p>
<p>I would suggest to exclude /.snapshots from your TSM backup. Even if TSM
is using dedup, it just slow down the Backup process.</p>
<p>what is strange in yout System, is that you are mounting directly the
btrfs / instead of a subvolume (snapshot)</p>
<p>Here is the output of <code>findmnt -a -o SOURCE,TARGET,FSTYPE -t btrfs</code> on
my system</p>
<pre><code>SOURCE                                                  TARGET                         FSTYPE
/dev/mapper/system-root[/@/.snapshots/1/snapshot]       /                              btrfs
/dev/mapper/system-root[/@/var/cache]                   |-/var/cache                   btrfs
/dev/mapper/system-root[/@/srv]                         |-/srv                         btrfs
/dev/mapper/system-root[/@/var/opt]                     |-/var/opt                     btrfs
/dev/mapper/system-root[/@/var/lib/mariadb]             |-/var/lib/mariadb             btrfs
/dev/mapper/system-root[/@/var/lib/libvirt/images]      |-/var/lib/libvirt/images      btrfs
/dev/mapper/system-root[/@/usr/local]                   |-/usr/local                   btrfs
/dev/mapper/system-root[/@/var/lib/pgsql]               |-/var/lib/pgsql               btrfs
/dev/mapper/system-root[/@/.snapshots]                  |-/.snapshots                  btrfs
/dev/mapper/system-root[/@/var/crash]                   |-/var/crash                   btrfs
/dev/mapper/system-root[/@/boot/grub2/powerpc-ieee1275] |-/boot/grub2/powerpc-ieee1275 btrfs
/dev/mapper/system-root[/@/tmp]                         |-/tmp                         btrfs
/dev/mapper/system-root[/@/var/lib/machines]            |-/var/lib/machines            btrfs
/dev/mapper/system-root[/@/var/log]                     |-/var/log                     btrfs
/dev/mapper/system-root[/@/var/lib/named]               |-/var/lib/named               btrfs
/dev/mapper/system-root[/@/var/lib/mysql]               |-/var/lib/mysql               btrfs
/dev/mapper/system-root[/@/opt]                         |-/opt                         btrfs
/dev/mapper/system-root[/@/home]                        |-/home                        btrfs
/dev/mapper/system-root[/@/var/lib/mailman]             |-/var/lib/mailman             btrfs
/dev/mapper/system-root[/@/var/spool]                   |-/var/spool                   btrfs
/dev/mapper/system-root[/@/var/tmp]                     `-/var/tmp                     btrfs
</code></pre>
<h4 id="bern66_commented_at_2018-05-09_1803"><img src="https://avatars.githubusercontent.com/u/38959869?u=f7f85617d38f6bebe9285f89b6794b229152df0c&v=4" width="50"><a href="https://github.com/bern66">bern66</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-387824996">2018-05-09 18:03</a>:<a class="headerlink" href="#bern66_commented_at_2018-05-09_1803" title="Permanent link">&para;</a></h4>
<p>Yes, snapshots are already excluded.</p>
<p>And for the rest, I have no clue why it is like it is as I was not
involved in the creation of the first system.</p>
<h4 id="jsmeix_commented_at_2018-05-14_0923"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-388753131">2018-05-14 09:23</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-05-14_0923" title="Permanent link">&para;</a></h4>
<p>Damn!<br />
With the current ReaR GitHub master code it does no longer work<br />
to recreate a SLES12-GA/SP0 system which has this default btrfs
structure:</p>
<pre>
# findmnt -a -o SOURCE,TARGET,FSTYPE -t btrfs
SOURCE                              TARGET                   FSTYPE
/dev/sda2[/@]                       /                        btrfs
/dev/sda2[/@/.snapshots]            |-/.snapshots            btrfs
/dev/sda2[/@/var/opt]               |-/var/opt               btrfs
/dev/sda2[/@/var/tmp]               |-/var/tmp               btrfs
/dev/sda2[/@/srv]                   |-/srv                   btrfs
/dev/sda2[/@/var/spool]             |-/var/spool             btrfs
/dev/sda2[/@/home]                  |-/home                  btrfs
/dev/sda2[/@/var/log]               |-/var/log               btrfs
/dev/sda2[/@/var/lib/pgsql]         |-/var/lib/pgsql         btrfs
/dev/sda2[/@/var/lib/named]         |-/var/lib/named         btrfs
/dev/sda2[/@/var/lib/mailman]       |-/var/lib/mailman       btrfs
/dev/sda2[/@/var/crash]             |-/var/crash             btrfs
/dev/sda2[/@/usr/local]             |-/usr/local             btrfs
/dev/sda2[/@/tmp]                   |-/tmp                   btrfs
/dev/sda2[/@/opt]                   |-/opt                   btrfs
/dev/sda2[/@/boot/grub2/x86_64-efi] |-/boot/grub2/x86_64-efi btrfs
/dev/sda2[/@/boot/grub2/i386-pc]    `-/boot/grub2/i386-pc    btrfs
</pre>

<h4 id="jsmeix_commented_at_2018-05-14_0934"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-388756113">2018-05-14 09:34</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-05-14_0934" title="Permanent link">&para;</a></h4>
<p>@bern66<br />
regardless of my
<a href="https://github.com/rear/rear/issues/1796#issuecomment-388753131">https://github.com/rear/rear/issues/1796#issuecomment-388753131</a><br />
it seems your btrfs structure is not any SLE12 default btrfs structure
because you have</p>
<pre>
SOURCE                          TARGET        FSTYPE
/dev/mapper/system-root         /             btrfs
</pre>

<p>while SLES12-GA/SP0 has</p>
<pre>
SOURCE                      TARGET           FSTYPE
/dev/sda2[/@]               /                btrfs
</pre>

<p>As far as I know snapper snapshotting and in particular the rollback<br />
will not work at all or will not work correctly if you do not have one<br />
of the SLE12 default btrfs structures and I do know that only the
latest<br />
of the SLE12 default btrfs structures should work well with snapper<br />
snapshotting and rollback.<br />
I fear any tiny deviation from the SLE12-SP2 default btrfs structure<br />
may lead to whaever kind of unexpected (and probably even unsupported)<br />
issues.<br />
Therefore I do really recommend that you get your SLE12-SP2 systems<br />
in full compliance with SUSE's SLE12-SP2 defaults to avoid that<br />
whatever things may behave unexpectedly or even just fail later<br />
cf.
<a href="https://github.com/rear/rear/issues/1796#issuecomment-387001483">https://github.com/rear/rear/issues/1796#issuecomment-387001483</a></p>
<p>Regarding the diffent (incompatible) SLE12 default btrfs structures
see<br />
<a href="https://github.com/rear/rear/issues/1368#issuecomment-302410707">https://github.com/rear/rear/issues/1368#issuecomment-302410707</a></p>
<p>In general regarding that oversophisticated SUSE btrfs default
structures<br />
see
<a href="https://github.com/rear/rear/pull/1435#issuecomment-319011579">https://github.com/rear/rear/pull/1435#issuecomment-319011579</a></p>
<h4 id="schabrolles_commented_at_2018-05-14_0938"><img src="https://avatars.githubusercontent.com/u/19491077?u=0021b16ab426902cbe676f6831f41607bbe4d441&v=4" width="50"><a href="https://github.com/schabrolles">schabrolles</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-388757117">2018-05-14 09:38</a>:<a class="headerlink" href="#schabrolles_commented_at_2018-05-14_0938" title="Permanent link">&para;</a></h4>
<p>@jsmeix,</p>
<p>I recommend to @bern66 to use the following code which should be used
with SLES12SP2</p>
<pre><code>## SLES12
BACKUP_OPTIONS="nfsvers=4,nolock"
REQUIRED_PROGS=( "${REQUIRED_PROGS[@]}" snapper chattr lsattr )
COPY_AS_IS=( "${COPY_AS_IS[@]}" /usr/lib/snapper/installation-helper /etc/snapper/config-templates/default )

for subvol in $(findmnt -n -r -t btrfs | cut -d ' ' -f 1 | grep -v '^/$' | egrep -v 'snapshots|crash') ; do
    BACKUP_PROG_INCLUDE=( "${BACKUP_PROG_INCLUDE[@]}" "$subvol" )
done

POST_RECOVERY_SCRIPT=( 'if snapper --no-dbus -r $TARGET_FS_ROOT get-config | grep -q "^QGROUP.*[0-9]/[0-9]" ; then snapper --no-dbus -r $TARGET_FS_ROOT set-config QGROUP= ; snapper --no-dbus -r $TARGET_FS_ROOT setup-quota &amp;&amp; echo snapper setup-quota done || echo snapper setup-quota failed ; else echo snapper setup-quota not used ; fi' )
</code></pre>
<p>But it seems this SLES12 has a SP0 disklayout (maybe due to successive
upgrade SP0-&gt;SP1-&gt;SP2 which, if I remember well, does not change
the layout)<br />
Could the fact we use a SLES12SP2 btrfs additional script instead of
SLES12SP0 could explain the fact it fails here?</p>
<h4 id="jsmeix_commented_at_2018-05-14_0955"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-388762181">2018-05-14 09:55</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-05-14_0955" title="Permanent link">&para;</a></h4>
<p>@schabrolles<br />
no, his SLES12 has not a SP0 btrfs disklayout but something different<br />
see my
<a href="https://github.com/rear/rear/issues/1796#issuecomment-388756113">https://github.com/rear/rear/issues/1796#issuecomment-388756113</a></p>
<p>It would be o.k if his SLES12 had a SP0 btrfs disklayout because<br />
that is an expected thing where ReaR should "just work", cf. the
"Reason" in<br />
<a href="https://github.com/rear/rear/issues/1368#issuecomment-302410707">https://github.com/rear/rear/issues/1368#issuecomment-302410707</a></p>
<h4 id="jsmeix_commented_at_2018-05-14_1001"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-388763887">2018-05-14 10:01</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-05-14_1001" title="Permanent link">&para;</a></h4>
<p>With this manual change in disklayout.conf of a SLES12-SP0 default btrfs
system</p>
<pre>
# Because any '@/.snapshots' subvolume would let 'snapper/installation-helper --step 1' fail
 # such subvolumes are deactivated here to not let 'rear recover' fail:
 #btrfsnormalsubvol /dev/sda2 / 275 @/.snapshots
 btrfsnormalsubvol /dev/sda2 / 257 @
+btrfsnormalsubvol /dev/sda2 / 275 @/.snapshots
 btrfsnormalsubvol /dev/sda2 / 258 @/boot/grub2/i386-pc
 btrfsnormalsubvol /dev/sda2 / 259 @/boot/grub2/x86_64-efi
</pre>

<p>"rear recover" works for me again for a SLES12-SP0 default btrfs system.</p>
<p>What I had messed up for SLES12-SP0 when implementing<br />
support for the SLES12-SP1 btrfs structure where things are<br />
set up by 'snapper/installation-helper --step 1' is conditional code<br />
that does not do the installation-helper stuff when it is not used.</p>
<p>I will do a pull request - hopefully today - but at least on Thursday or
Friday.<br />
I will not be in the office tomorrow and on Wednesdey,<br />
cf.
<a href="https://github.com/rear/rear/issues/1796#issuecomment-387797072">https://github.com/rear/rear/issues/1796#issuecomment-387797072</a><br />
and at home I do not have the needed various SLE12 test systems<br />
(guess what: at home I do not use any btrfs stuff - guess why ;-)</p>
<h4 id="jsmeix_commented_at_2018-05-14_1105"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-388779558">2018-05-14 11:05</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-05-14_1105" title="Permanent link">&para;</a></h4>
<p>Only a side note FWTFIW regarding "fun with btrfs":<br />
On my SLES12-SP3 test system (virtual KVM/QEMU machine) with default
btrfs<br />
that "just booted" for several weeks I get now suddenly during booting<br />
funny longer delays with several repeating interesting messages like</p>
<pre>
... NMI watchdog: BUG: soft lockup - CPU#0 stuck for 22s! [btrfs-balance:431]
</pre>

<p>intermixed with even more funny</p>
<pre>
... rcu_sched kthread starved for 105012 jiffies! ...
</pre>

<p>and there it sits looking somehow busy with itself with its btrfs
stuff...<br />
(on the host the "Virtual Machine Manager" shows constant 100% CPU for
that system)<br />
and I can only wait and hope and pray...</p>
<h4 id="jsmeix_commented_at_2018-05-14_1145"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-388788775">2018-05-14 11:45</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-05-14_1145" title="Permanent link">&para;</a></h4>
<p>No time to hope and pray for btrfs any longer.<br />
I just killed that SLES12-SP3 test system.<br />
I got it recreated with ReaR in a few minutes :-)</p>
<h4 id="bern66_commented_at_2018-05-14_1402"><img src="https://avatars.githubusercontent.com/u/38959869?u=f7f85617d38f6bebe9285f89b6794b229152df0c&v=4" width="50"><a href="https://github.com/bern66">bern66</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-388827831">2018-05-14 14:02</a>:<a class="headerlink" href="#bern66_commented_at_2018-05-14_1402" title="Permanent link">&para;</a></h4>
<p>@jsmeix regarding your comment
<a href="https://github.com/rear/rear/issues/1796#issuecomment-388756113">https://github.com/rear/rear/issues/1796#issuecomment-388756113</a>
and the default btrfs structure, I would say that a structure like:</p>
<pre><code>SOURCE                          TARGET                FSTYPE
/dev/mapper/system-root         /                     btrfs
</code></pre>
<p>is part of a "default" SLES12 structure. At the installation we simply
choose the LVM-based Proposal.</p>
<p>The structure:</p>
<pre><code>SOURCE                      TARGET                   FSTYPE
/dev/sda2[/@]               /                        btrfs
</code></pre>
<p>is when one choose to go with Partition-based Proposal.</p>
<p>Unless you mean that a default installation is when one do a
next-next-next installation without changing anything.</p>
<p>As a test, I did a new installation with SLES12-SP3 and -SP0 and I ended
up with the same structure as above while choosing LVM-based proposal in
both cases:</p>
<p>SLES12-SP0</p>
<pre><code>Filesystem               Size  Used Avail Use% Mounted on
/dev/mapper/system-root  6.6G  2.8G  3.5G  45% /
/dev/mapper/system-root  6.6G  2.8G  3.5G  45% /var/tmp
/dev/mapper/system-root  6.6G  2.8G  3.5G  45% /var/opt
[snip]
</code></pre>
<p>SLES12-SP3</p>
<pre><code>Filesystem               Size  Used Avail Use% Mounted on
/dev/mapper/system-root  6.6G  2.1G  4.4G  32% /
/dev/mapper/system-root  6.6G  2.1G  4.4G  32% /var/crash
/dev/mapper/system-root  6.6G  2.1G  4.4G  32% /opt
[snip]
</code></pre>
<p>I personally would consider this a "default" installation. I would
consider an installation not a default one when someone modify the
installation beyond the regular installation process.</p>
<h4 id="bern66_commented_at_2018-05-14_1915"><img src="https://avatars.githubusercontent.com/u/38959869?u=f7f85617d38f6bebe9285f89b6794b229152df0c&v=4" width="50"><a href="https://github.com/bern66">bern66</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-388930882">2018-05-14 19:15</a>:<a class="headerlink" href="#bern66_commented_at_2018-05-14_1915" title="Permanent link">&para;</a></h4>
<p>I did a test in my own environment, intel and Virtualbox. I easily
restored btrfs filesystems inside an LVM without any problem. That is my
SLES12-SP3 environment from my previous comment.</p>
<pre><code>Filesystem               Size  Used Avail Use% Mounted on
/dev/mapper/system-root  6.6G  2.1G  4.4G  32% /
/dev/mapper/system-root  6.6G  2.1G  4.4G  32% /var/crash
/dev/mapper/system-root  6.6G  2.1G  4.4G  32% /opt
[snip]
</code></pre>
<p>Could the problem more related to our architecture, ppc64le, than the
disklayout?</p>
<h4 id="schabrolles_commented_at_2018-05-14_1924"><img src="https://avatars.githubusercontent.com/u/19491077?u=0021b16ab426902cbe676f6831f41607bbe4d441&v=4" width="50"><a href="https://github.com/schabrolles">schabrolles</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-388933204">2018-05-14 19:24</a>:<a class="headerlink" href="#schabrolles_commented_at_2018-05-14_1924" title="Permanent link">&para;</a></h4>
<p>@bern66 what about the snapshots on your virtualbox setup ... I cannot
see them in your "screenshots".... The issue we currently have is
related to the recreation of the snapshots FS.</p>
<h4 id="bern66_commented_at_2018-05-15_1419"><img src="https://avatars.githubusercontent.com/u/38959869?u=f7f85617d38f6bebe9285f89b6794b229152df0c&v=4" width="50"><a href="https://github.com/bern66">bern66</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-389183975">2018-05-15 14:19</a>:<a class="headerlink" href="#bern66_commented_at_2018-05-15_1419" title="Permanent link">&para;</a></h4>
<p>@schabrolles<br />
Indeed I didn't have any snaphosts. I'll give it another try with
snapshots.</p>
<p>But in the other hand, unless there is something I do not understand
which is very possible, if you take a look at my comment
<a href="https://github.com/rear/rear/issues/1796#issuecomment-387809919">https://github.com/rear/rear/issues/1796#issuecomment-387809919</a>
you shoud see that I didn't select the .snapshot file space. Is it the
fs you talk about? In the selection of fs so far I always kept the
default selection presented.</p>
<p>Thanks,</p>
<h4 id="schabrolles_commented_at_2018-05-15_1444"><img src="https://avatars.githubusercontent.com/u/19491077?u=0021b16ab426902cbe676f6831f41607bbe4d441&v=4" width="50"><a href="https://github.com/schabrolles">schabrolles</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-389193239">2018-05-15 14:44</a>:<a class="headerlink" href="#schabrolles_commented_at_2018-05-15_1444" title="Permanent link">&para;</a></h4>
<p>@bern66,<br />
just run <code>findmnt /</code></p>
<p>here is the output I got on my system (LPAR on POWER - SLES12SP2)</p>
<pre><code>TARGET SOURCE                                            FSTYPE OPTIONS
/      /dev/mapper/system-root[/@/.snapshots/1/snapshot] btrfs  rw,relatime,space_cache,subvolid=279,subvol=/@/.snapshot
</code></pre>
<h4 id="jsmeix_commented_at_2018-05-17_0744"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-389775698">2018-05-17 07:44</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-05-17_0744" title="Permanent link">&para;</a></h4>
<p>I would have been really surprised if the kind of underlying
block-device<br />
(e.g. a plain disk partition like /dev/sda2 versus a logical volume like
/dev/dm-1)<br />
would make a difference which btrfs structure is created on it.</p>
<p>The following shows - as far as I can reproduce it - that the btrfs
structure<br />
(and in particular how the btrfs parts are mounted)<br />
does not depend on whether or not the "LVM-based Proposal" is used.</p>
<p>When I install a SLES12-GA/SP0 system<br />
from an original SUSE SLES12-GA/SP0 installation medium<br />
with its original SUSE SLES12-GA/SP0 installer<br />
(i.e. the YaST installer on that SLES12-GA/SP0 installation medium)<br />
on a virtual KVM/QEMU machine with a single 20GiB virtual harddisk<br />
I get when I select the "LVM-based Proposal" in YaST<br />
this result in the installed system:</p>
<pre>
# cat /etc/issue
Welcome to SUSE Linux Enterprise Server 12  (x86_64) - Kernel \r (\l).

# findmnt -a -o SOURCE,TARGET,FSTYPE -t btrfs
SOURCE                                            TARGET                   FSTYPE
/dev/mapper/system-root[/@]                       /                        btrfs
/dev/mapper/system-root[/@/.snapshots]            |-/.snapshots            btrfs
/dev/mapper/system-root[/@/var/lib/mailman]       |-/var/lib/mailman       btrfs
/dev/mapper/system-root[/@/var/spool]             |-/var/spool             btrfs
/dev/mapper/system-root[/@/tmp]                   |-/tmp                   btrfs
/dev/mapper/system-root[/@/var/tmp]               |-/var/tmp               btrfs
/dev/mapper/system-root[/@/home]                  |-/home                  btrfs
/dev/mapper/system-root[/@/var/opt]               |-/var/opt               btrfs
/dev/mapper/system-root[/@/var/lib/pgsql]         |-/var/lib/pgsql         btrfs
/dev/mapper/system-root[/@/var/lib/named]         |-/var/lib/named         btrfs
/dev/mapper/system-root[/@/var/log]               |-/var/log               btrfs
/dev/mapper/system-root[/@/var/crash]             |-/var/crash             btrfs
/dev/mapper/system-root[/@/usr/local]             |-/usr/local             btrfs
/dev/mapper/system-root[/@/srv]                   |-/srv                   btrfs
/dev/mapper/system-root[/@/opt]                   |-/opt                   btrfs
/dev/mapper/system-root[/@/boot/grub2/x86_64-efi] |-/boot/grub2/x86_64-efi btrfs
/dev/mapper/system-root[/@/boot/grub2/i386-pc]    `-/boot/grub2/i386-pc    btrfs

# file /dev/mapper/system-root
/dev/mapper/system-root: symbolic link to `../dm-1'

# readlink -e /dev/mapper/system-root
/dev/dm-1

# file /dev/dm-1
/dev/dm-1: block special (254/1)

# lsblk -i -p -o NAME,KNAME,PKNAME,MAJ:MIN,TYPE,FSTYPE,SIZE /dev/sda
NAME                        KNAME     PKNAME    MAJ:MIN TYPE FSTYPE       SIZE
/dev/sda                    /dev/sda              8:0   disk               20G
`-/dev/sda1                 /dev/sda1 /dev/sda    8:1   part LVM2_member   20G
  |-/dev/mapper/system-swap /dev/dm-0 /dev/sda1 254:0   lvm  swap         1.5G
  `-/dev/mapper/system-root /dev/dm-1 /dev/sda1 254:1   lvm  btrfs       18.5G

# pvdisplay 
  --- Physical volume ---
  PV Name               /dev/sda1
  VG Name               system
  PV Size               20.00 GiB / not usable 3.00 MiB
  Allocatable           yes 
  PE Size               4.00 MiB
  Total PE              5119
  Free PE               2
  Allocated PE          5117
  PV UUID               hyUS23-Gd2Y-YR70-kLlZ-22BQ-n4ee-AneoHm

# vgdisplay 
  --- Volume group ---
  VG Name               system
  System ID             
  Format                lvm2
  Metadata Areas        1
  Metadata Sequence No  3
  VG Access             read/write
  VG Status             resizable
  MAX LV                0
  Cur LV                2
  Open LV               2
  Max PV                0
  Cur PV                1
  Act PV                1
  VG Size               20.00 GiB
  PE Size               4.00 MiB
  Total PE              5119
  Alloc PE / Size       5117 / 19.99 GiB
  Free  PE / Size       2 / 8.00 MiB
  VG UUID               tejprz-WpZp-jLD1-JSKc-fTcK-16W9-DCyfw4

# lvdisplay 
  --- Logical volume ---
  LV Path                /dev/system/root
  LV Name                root
  VG Name                system
  LV UUID                YPFEHh-VedF-fm2Y-rtwT-dCFO-z2fk-SSfgMv
  LV Write Access        read/write
  LV Creation host, time (none), 2018-05-17 08:39:24 +0200
  LV Status              available
  # open                 1
  LV Size                18.53 GiB
  Current LE             4744
  Segments               1
  Allocation             inherit
  Read ahead sectors     auto
  - currently set to     1024
  Block device           254:1

  --- Logical volume ---
  LV Path                /dev/system/swap
  LV Name                swap
  VG Name                system
  LV UUID                3GWaTs-1IKN-OEen-mh3s-RBEY-PQNx-mO2mMJ
  LV Write Access        read/write
  LV Creation host, time (none), 2018-05-17 08:39:25 +0200
  LV Status              available
  # open                 2
  LV Size                1.46 GiB
  Current LE             373
  Segments               1
  Allocation             inherit
  Read ahead sectors     auto
  - currently set to     1024
  Block device           254:0
</pre>

<p>When I install a SLES12-SP3 system<br />
from an original SUSE SLES12-SP3 installation medium<br />
with its original SUSE SLES12-SP3 installer<br />
(i.e. the YaST installer on that SLES12-SP3 installation medium)<br />
on a virtual KVM/QEMU machine with a single 20GiB virtual harddisk<br />
I get when I select the "LVM-based Proposal" in YaST<br />
this result in the installed system:</p>
<pre>
# cat /etc/issue
Welcome to SUSE Linux Enterprise Server 12 SP3  (x86_64) - Kernel \r (\l).

# findmnt -a -o SOURCE,TARGET,FSTYPE -t btrfs
SOURCE                                             TARGET                    FSTYPE
/dev/mapper/system-root[/@/.snapshots/1/snapshot]  /                         btrfs
/dev/mapper/system-root[/@/usr/local]              |-/usr/local              btrfs
/dev/mapper/system-root[/@/var/lib/named]          |-/var/lib/named          btrfs
/dev/mapper/system-root[/@/srv]                    |-/srv                    btrfs
/dev/mapper/system-root[/@/var/lib/mariadb]        |-/var/lib/mariadb        btrfs
/dev/mapper/system-root[/@/var/lib/pgsql]          |-/var/lib/pgsql          btrfs
/dev/mapper/system-root[/@/var/cache]              |-/var/cache              btrfs
/dev/mapper/system-root[/@/boot/grub2/i386-pc]     |-/boot/grub2/i386-pc     btrfs
/dev/mapper/system-root[/@/home]                   |-/home                   btrfs
/dev/mapper/system-root[/@/var/tmp]                |-/var/tmp                btrfs
/dev/mapper/system-root[/@/var/spool]              |-/var/spool              btrfs
/dev/mapper/system-root[/@/.snapshots]             |-/.snapshots             btrfs
/dev/mapper/system-root[/@/var/lib/mailman]        |-/var/lib/mailman        btrfs
/dev/mapper/system-root[/@/opt]                    |-/opt                    btrfs
/dev/mapper/system-root[/@/var/lib/mysql]          |-/var/lib/mysql          btrfs
/dev/mapper/system-root[/@/var/lib/machines]       |-/var/lib/machines       btrfs
/dev/mapper/system-root[/@/var/log]                |-/var/log                btrfs
/dev/mapper/system-root[/@/var/crash]              |-/var/crash              btrfs
/dev/mapper/system-root[/@/var/lib/libvirt/images] |-/var/lib/libvirt/images btrfs
/dev/mapper/system-root[/@/tmp]                    |-/tmp                    btrfs
/dev/mapper/system-root[/@/boot/grub2/x86_64-efi]  |-/boot/grub2/x86_64-efi  btrfs
/dev/mapper/system-root[/@/var/opt]                `-/var/opt                btrfs

# file /dev/mapper/system-root
/dev/mapper/system-root: symbolic link to `../dm-1'

# readlink -e /dev/mapper/system-root
/dev/dm-1

# file /dev/dm-1
/dev/dm-1: block special (254/1)

# lsblk -i -p -o NAME,KNAME,PKNAME,MAJ:MIN,TYPE,FSTYPE,SIZE /dev/sda
NAME                        KNAME     PKNAME    MAJ:MIN TYPE FSTYPE       SIZE
/dev/sda                    /dev/sda              8:0   disk               20G
`-/dev/sda1                 /dev/sda1 /dev/sda    8:1   part LVM2_member   20G
  |-/dev/mapper/system-swap /dev/dm-0 /dev/sda1 254:0   lvm  swap         1.5G
  `-/dev/mapper/system-root /dev/dm-1 /dev/sda1 254:1   lvm  btrfs       18.6G

# pvdisplay 
  --- Physical volume ---
  PV Name               /dev/sda1
  VG Name               system
  PV Size               20.00 GiB / not usable 3.00 MiB
  Allocatable           yes 
  PE Size               4.00 MiB
  Total PE              5119
  Free PE               2
  Allocated PE          5117
  PV UUID               wKSGQ9-VyTZ-8vCv-t0gL-elPF-5d7u-h0nr5y

# vgdisplay 
  --- Volume group ---
  VG Name               system
  System ID             
  Format                lvm2
  Metadata Areas        1
  Metadata Sequence No  3
  VG Access             read/write
  VG Status             resizable
  MAX LV                0
  Cur LV                2
  Open LV               2
  Max PV                0
  Cur PV                1
  Act PV                1
  VG Size               20.00 GiB
  PE Size               4.00 MiB
  Total PE              5119
  Alloc PE / Size       5117 / 19.99 GiB
  Free  PE / Size       2 / 8.00 MiB
  VG UUID               nw0UCG-WT1G-3cv1-AA73-nMC7-i1cd-nDRZPm

# lvdisplay 
  --- Logical volume ---
  LV Path                /dev/system/root
  LV Name                root
  VG Name                system
  LV UUID                pcAtC2-nFQf-RtLx-wNFs-10r6-W6cm-97LIDR
  LV Write Access        read/write
  LV Creation host, time install, 2018-05-17 09:32:47 +0200
  LV Status              available
  # open                 1
  LV Size                18.54 GiB
  Current LE             4746
  Segments               1
  Allocation             inherit
  Read ahead sectors     auto
  - currently set to     1024
  Block device           254:1

  --- Logical volume ---
  LV Path                /dev/system/swap
  LV Name                swap
  VG Name                system
  LV UUID                01GXgu-AxQv-TfzR-Pitr-OwHL-Pat9-nc5X2M
  LV Write Access        read/write
  LV Creation host, time install, 2018-05-17 09:32:47 +0200
  LV Status              available
  # open                 2
  LV Size                1.45 GiB
  Current LE             371
  Segments               1
  Allocation             inherit
  Read ahead sectors     auto
  - currently set to     1024
  Block device           254:0
</pre>

<h4 id="bern66_commented_at_2018-05-17_1303"><img src="https://avatars.githubusercontent.com/u/38959869?u=f7f85617d38f6bebe9285f89b6794b229152df0c&v=4" width="50"><a href="https://github.com/bern66">bern66</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-389858628">2018-05-17 13:03</a>:<a class="headerlink" href="#bern66_commented_at_2018-05-17_1303" title="Permanent link">&para;</a></h4>
<p>Should I understand there is a fix for my problem? If there is a fix, is
it available so I could test it in my environment?</p>
<p>Thanks,</p>
<h4 id="jsmeix_commented_at_2018-05-17_1458"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-389897062">2018-05-17 14:58</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-05-17_1458" title="Permanent link">&para;</a></h4>
<p>No,<br />
it confirms
<a href="https://github.com/rear/rear/issues/1796#issuecomment-388762181">https://github.com/rear/rear/issues/1796#issuecomment-388762181</a><br />
also for the "LVM-based Proposal" in YaST as far as I can reproduce it.</p>
<p>I know about no SLES12 btrfs where its root subvolume<br />
is mounted at all.</p>
<p>What is mounted at the root of the filesystem tree<br />
(i.e. what is mounted at the '/' mountpoint directory) is<br />
for SLES12-SP0 the normal /@ subvolume (which causes an issue) and<br />
since SLES12-SP1 a snapper /@/.snapshots/1/snapshot subvolume.</p>
<h4 id="jsmeix_commented_at_2018-05-18_1153"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-390183733">2018-05-18 11:53</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-05-18_1153" title="Permanent link">&para;</a></h4>
<p>With
<a href="https://github.com/rear/rear/pull/1813">https://github.com/rear/rear/pull/1813</a>
merged it should work again<br />
to recreate a SLES12-GA/SP0 system whith its default btrfs structure<br />
cf.
<a href="https://github.com/rear/rear/issues/1796#issuecomment-388753131">https://github.com/rear/rear/issues/1796#issuecomment-388753131</a></p>
<h4 id="bern66_commented_at_2018-05-18_1203"><img src="https://avatars.githubusercontent.com/u/38959869?u=f7f85617d38f6bebe9285f89b6794b229152df0c&v=4" width="50"><a href="https://github.com/bern66">bern66</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-390185670">2018-05-18 12:03</a>:<a class="headerlink" href="#bern66_commented_at_2018-05-18_1203" title="Permanent link">&para;</a></h4>
<p>Thanks @jsmeix I'll give it a try today.</p>
<h4 id="jsmeix_commented_at_2018-05-18_1236"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-390193128">2018-05-18 12:36</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-05-18_1236" title="Permanent link">&para;</a></h4>
<p>@bern66<br />
very likely this will not help you unless you get a btrfs structure<br />
that is one of the known SLES12 btrfs structures,<br />
i.e. either the one of a SLES12-GA/SP0 system<br />
where what is mounted at '/' shows up as</p>
<pre>
# findmnt -a -o SOURCE,TARGET -t btrfs
SOURCE                                            TARGET
/dev/mapper/system-root[/@]                       /
...
</pre>

<p>or the one of a SLES12-SP1-or-later system<br />
where what is mounted at '/' shows up as</p>
<pre>
# findmnt -a -o SOURCE,TARGET -t btrfs
SOURCE                                             TARGET
/dev/mapper/system-root[/@/.snapshots/1/snapshot]  /
...
</pre>

<p>If you can you should try to get a SLES12-SP1-or-later<br />
btrfs structure because the old SLES12-GA/SP0 btrfs setup<br />
has an issue which is a "disk space leak" bug,<br />
see<br />
<a href="https://www.suse.com/releasenotes/x86_64/SUSE-SLES/12-SP1/">https://www.suse.com/releasenotes/x86_64/SUSE-SLES/12-SP1/</a><br />
that reads (excerpt):</p>
<pre>
2.2.9 Installing into a Snapper-Controlled Btrfs Subvolume

Prior to SUSE Linux Enterprise 12 SP1, after the first rollback
of the system the original root volume was no longer reachable
and would never be removed automatically.
This resulted in a disk space leak.

Starting with SP1, YaST installs the system into a subvolume
controlled by Snapper.
</pre>

<h4 id="bern66_commented_at_2018-05-22_1604"><img src="https://avatars.githubusercontent.com/u/38959869?u=f7f85617d38f6bebe9285f89b6794b229152df0c&v=4" width="50"><a href="https://github.com/bern66">bern66</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-391047347">2018-05-22 16:04</a>:<a class="headerlink" href="#bern66_commented_at_2018-05-22_1604" title="Permanent link">&para;</a></h4>
<p>@jsmeix @schabrolles<br />
I did a fresh install of SLES12-SP2:</p>
<pre><code>tstinf03:/ # lsb_release -a
LSB Version:    n/a
Distributor ID: SUSE
Description:    SUSE Linux Enterprise Server for SAP Applications 12 SP2
Release:        12.2
Codename:       n/a
</code></pre>
<p>In a Power environment:</p>
<pre><code>tstinf03:/ # arch
ppc64le
</code></pre>
<p>For which I understand I have a standard btrfs structure:</p>
<pre><code>tstinf03:/ # btrfs subvolume  list -a /
ID 257 gen 118 top level 5 path &lt;FS_TREE&gt;/@
ID 258 gen 212 top level 257 path &lt;FS_TREE&gt;/@/.snapshots
ID 260 gen 236 top level 258 path &lt;FS_TREE&gt;/@/.snapshots/1/snapshot
ID 261 gen 209 top level 257 path &lt;FS_TREE&gt;/@/boot/grub2/powerpc-ieee1275
ID 262 gen 231 top level 257 path &lt;FS_TREE&gt;/@/home
ID 263 gen 118 top level 257 path &lt;FS_TREE&gt;/@/opt
ID 264 gen 212 top level 257 path &lt;FS_TREE&gt;/@/srv
ID 265 gen 236 top level 257 path &lt;FS_TREE&gt;/@/tmp
ID 266 gen 237 top level 257 path &lt;FS_TREE&gt;/@/usr/local
ID 267 gen 237 top level 257 path &lt;FS_TREE&gt;/@/var/cache
ID 268 gen 219 top level 257 path &lt;FS_TREE&gt;/@/var/crash
ID 269 gen 219 top level 257 path &lt;FS_TREE&gt;/@/var/lib/libvirt/images
ID 270 gen 219 top level 257 path &lt;FS_TREE&gt;/@/var/lib/machines
ID 271 gen 219 top level 257 path &lt;FS_TREE&gt;/@/var/lib/mailman
ID 272 gen 219 top level 257 path &lt;FS_TREE&gt;/@/var/lib/mariadb
ID 273 gen 219 top level 257 path &lt;FS_TREE&gt;/@/var/lib/mysql
ID 274 gen 219 top level 257 path &lt;FS_TREE&gt;/@/var/lib/named
ID 275 gen 219 top level 257 path &lt;FS_TREE&gt;/@/var/lib/pgsql
ID 276 gen 238 top level 257 path &lt;FS_TREE&gt;/@/var/log
ID 277 gen 219 top level 257 path &lt;FS_TREE&gt;/@/var/opt
ID 278 gen 238 top level 257 path &lt;FS_TREE&gt;/@/var/spool
ID 279 gen 231 top level 257 path &lt;FS_TREE&gt;/@/var/tmp
ID 292 gen 162 top level 258 path &lt;FS_TREE&gt;/@/.snapshots/2/snapshot
ID 293 gen 164 top level 258 path &lt;FS_TREE&gt;/@/.snapshots/3/snapshot
ID 294 gen 165 top level 258 path &lt;FS_TREE&gt;/@/.snapshots/4/snapshot
ID 295 gen 166 top level 258 path &lt;FS_TREE&gt;/@/.snapshots/5/snapshot
ID 296 gen 167 top level 258 path &lt;FS_TREE&gt;/@/.snapshots/6/snapshot
ID 297 gen 168 top level 258 path &lt;FS_TREE&gt;/@/.snapshots/7/snapshot
ID 298 gen 169 top level 258 path &lt;FS_TREE&gt;/@/.snapshots/8/snapshot
ID 299 gen 170 top level 258 path &lt;FS_TREE&gt;/@/.snapshots/9/snapshot
ID 300 gen 171 top level 258 path &lt;FS_TREE&gt;/@/.snapshots/10/snapshot
ID 301 gen 172 top level 258 path &lt;FS_TREE&gt;/@/.snapshots/11/snapshot
ID 302 gen 180 top level 258 path &lt;FS_TREE&gt;/@/.snapshots/12/snapshot
ID 303 gen 181 top level 258 path &lt;FS_TREE&gt;/@/.snapshots/13/snapshot
ID 304 gen 183 top level 258 path &lt;FS_TREE&gt;/@/.snapshots/14/snapshot
ID 305 gen 184 top level 258 path &lt;FS_TREE&gt;/@/.snapshots/15/snapshot
ID 306 gen 190 top level 258 path &lt;FS_TREE&gt;/@/.snapshots/16/snapshot
ID 307 gen 191 top level 258 path &lt;FS_TREE&gt;/@/.snapshots/17/snapshot
ID 308 gen 202 top level 258 path &lt;FS_TREE&gt;/@/.snapshots/18/snapshot
ID 309 gen 204 top level 258 path &lt;FS_TREE&gt;/@/.snapshots/19/snapshot
</code></pre>
<p>I then did a rear backup with <code>rear -vD mkbackup</code> and tried a rear
recover with <code>rear -vD recover</code>. The recover still ended in error. See
below the output of the recover and attached is the rear recover log. So
far from my understanding, the problem seems to be the
<code>subvol=@/.snapshots</code>.</p>
<pre><code>RESCUE pgiststinf03:~ # rear -vD recover
Relax-and-Recover 2.3-git. / 2018-05-18
Using log file: /var/log/rear/rear-pgiststinf03.log
Running workflow recover within the ReaR rescue/recovery system
Starting required daemons for NFS: RPC portmapper (portmap or rpcbind) and rpc.statd if available.
Started RPC portmapper 'rpcbind'.
RPC portmapper 'rpcbind' available.
Started rpc.statd.
RPC status rpc.statd available.
Starting rpc.idmapd failed.
Using backup archive '/tmp/rear.qeI4KlUR0ME2oC2/outputfs/pgiststinf03/backup.tar.gz'
Will do driver migration (recreating initramfs/initrd)
Calculating backup archive size
Backup archive size is 1.4G     /tmp/rear.qeI4KlUR0ME2oC2/outputfs/pgiststinf03/backup.tar.gz (compressed)
Setting up multipathing
Activating multipath
multipath activated
Starting multipath daemon
multipathd started
Listing multipath device found
 size=100G
Comparing disks
Device mapper!3600507680c800450b800000000000ba7 does not exist (manual configuration needed)
Switching to manual disk layout configuration
Using /dev/mapper/3600507680c800450b800000000000bb9 (same size) for recreating /dev/mapper/3600507680c800450b800000000000ba7
Current disk mapping table (source -&gt; target):
    /dev/mapper/3600507680c800450b800000000000ba7 /dev/mapper/3600507680c800450b800000000000bb9
UserInput -I LAYOUT_MIGRATION_CONFIRM_MAPPINGS needed in /usr/share/rear/layout/prepare/default/300_map_disks.sh line 211
Confirm or edit the disk mapping
1) Confirm disk mapping and continue 'rear recover'
2) Edit disk mapping (/var/lib/rear/layout/disk_mappings)
3) Use Relax-and-Recover shell and return back to here
4) Abort 'rear recover'
(default '1' timeout 300 seconds)
1
UserInput: Valid choice number result 'Confirm disk mapping and continue 'rear recover''
User confirmed disk mapping
UserInput -I LAYOUT_FILE_CONFIRMATION needed in /usr/share/rear/layout/prepare/default/500_confirm_layout_file.sh line 26
Confirm or edit the disk layout file
1) Confirm disk layout and continue 'rear recover'
2) Edit disk layout (/var/lib/rear/layout/disklayout.conf)
3) View disk layout (/var/lib/rear/layout/disklayout.conf)
4) View original disk space usage (/var/lib/rear/layout/config/df.txt)
5) Use Relax-and-Recover shell and return back to here
6) Abort 'rear recover'
(default '1' timeout 300 seconds)
1
UserInput: Valid choice number result 'Confirm disk layout and continue 'rear recover''
User confirmed disk layout file
Doing SLES12-SP1 (and later) btrfs subvolumes setup because the default subvolume path contains '@/.snapshots/'
UserInput -I LAYOUT_CODE_CONFIRMATION needed in /usr/share/rear/layout/recreate/default/100_confirm_layout_code.sh line 26
Confirm or edit the disk recreation script
1) Confirm disk recreation script and continue 'rear recover'
2) Edit disk recreation script (/var/lib/rear/layout/diskrestore.sh)
3) View disk recreation script (/var/lib/rear/layout/diskrestore.sh)
4) View original disk space usage (/var/lib/rear/layout/config/df.txt)
5) Use Relax-and-Recover shell and return back to here
6) Abort 'rear recover'
(default '1' timeout 300 seconds)
1
UserInput: Valid choice number result 'Confirm disk recreation script and continue 'rear recover''
User confirmed disk recreation script
Start system layout restoration.
Creating partitions for disk /dev/mapper/3600507680c800450b800000000000bb9 (msdos)
Creating LVM PV /dev/mapper/3600507680c800450b800000000000bb9-part2
Creating LVM VG system
Creating LVM volume system/root
Creating LVM volume system/swap
Creating filesystem of type btrfs with mount point / on /dev/mapper/system-root.
Mounting filesystem /
/usr/lib/snapper/installation-helper not executable may indicate an error with btrfs default subvolume setup for @/.snapshots/1/snapshot on /dev/mapper/system-root
UserInput -I LAYOUT_CODE_RUN needed in /usr/share/rear/layout/recreate/default/200_run_layout_code.sh line 127
The disk layout recreation script failed
1) Rerun disk recreation script (/var/lib/rear/layout/diskrestore.sh)
2) View 'rear recover' log file (/var/log/rear/rear-pgiststinf03.log)
3) Edit disk recreation script (/var/lib/rear/layout/diskrestore.sh)
4) View original disk space usage (/var/lib/rear/layout/config/df.txt)
5) Use Relax-and-Recover shell and return back to here
6) Abort 'rear recover'
(default '1' timeout 300 seconds)
6
UserInput: Valid choice number result 'Abort 'rear recover''
ERROR: User chose to abort 'rear recover' in /usr/share/rear/layout/recreate/default/200_run_layout_code.sh
Aborting due to an error, check /var/log/rear/rear-pgiststinf03.log for details
Exiting rear recover (PID 2830) and its descendant processes
Running exit tasks
You should also rm -Rf /tmp/rear.qeI4KlUR0ME2oC2
Terminated
RESCUE pgiststinf03:~ #
</code></pre>
<p><a href="https://github.com/rear/rear/files/2027493/rear-pgiststinf03.log-20180522.gz">rear-pgiststinf03.log-20180522.gz</a></p>
<h4 id="schabrolles_commented_at_2018-05-22_1739"><img src="https://avatars.githubusercontent.com/u/19491077?u=0021b16ab426902cbe676f6831f41607bbe4d441&v=4" width="50"><a href="https://github.com/schabrolles">schabrolles</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-391077939">2018-05-22 17:39</a>:<a class="headerlink" href="#schabrolles_commented_at_2018-05-22_1739" title="Permanent link">&para;</a></h4>
<p>@bern66 could you please check the following into your "recovery system"</p>
<pre><code>ls -l /usr/lib/snapper/installation-helper
</code></pre>
<p>Did you add the SLES12SP2 addtional configuration lines into your
<code>/etc/rear/local.conf</code> file ?</p>
<pre><code>## SLES12
BACKUP_OPTIONS="nfsvers=4,nolock"
REQUIRED_PROGS=( "${REQUIRED_PROGS[@]}" snapper chattr lsattr )
COPY_AS_IS=( "${COPY_AS_IS[@]}" /usr/lib/snapper/installation-helper /etc/snapper/config-templates/default )

for subvol in $(findmnt -n -r -t btrfs | cut -d ' ' -f 1 | grep -v '^/$' | egrep -v 'snapshots|crash') ; do
    BACKUP_PROG_INCLUDE=( "${BACKUP_PROG_INCLUDE[@]}" "$subvol" )
done

POST_RECOVERY_SCRIPT=( 'if snapper --no-dbus -r $TARGET_FS_ROOT get-config | grep -q "^QGROUP.*[0-9]/[0-9]" ; then snapper --no-dbus -r $TARGET_FS_ROOT set-config QGROUP= ; snapper --no-dbus -r $TARGET_FS_ROOT setup-quota &amp;&amp; echo snapper setup-quota done || echo snapper setup-quota failed ; else echo snapper setup-quota not used ; fi' )
</code></pre>
<h4 id="bern66_commented_at_2018-05-22_1856"><img src="https://avatars.githubusercontent.com/u/38959869?u=f7f85617d38f6bebe9285f89b6794b229152df0c&v=4" width="50"><a href="https://github.com/bern66">bern66</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-391102997">2018-05-22 18:56</a>:<a class="headerlink" href="#bern66_commented_at_2018-05-22_1856" title="Permanent link">&para;</a></h4>
<p>Damn! I forgot this line and another one. Now it works for a normal
btrfs structure under IBM Power Systems. I now have to find out if I can
fix the anomaly in our actual btrfs systems.</p>
<p>Thanks!</p>
<h4 id="jsmeix_commented_at_2018-05-23_0919"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-391280219">2018-05-23 09:19</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-05-23_0919" title="Permanent link">&para;</a></h4>
<p>@bern66<br />
in your<br />
<a href="https://github.com/rear/rear/issues/1796#issuecomment-391047347">https://github.com/rear/rear/issues/1796#issuecomment-391047347</a><br />
the <code>btrfs subvolume  list -a /</code> output looks o.k.<br />
but that only means you have the usual SLES12-SP1-or-later btrfs
subvolumes<br />
but that does not tell how those subvolumes are mounted, in particular<br />
it does not tell what subvolume is mounted at the root of the filesystem
tree<br />
(i.e. what subvolume is mounted at the <code>/</code> directory)<br />
only <code>findmnt -a -o SOURCE,TARGET -t btrfs</code> will tell that.</p>
<p>In general regarding btrfs and how to find out what its <em>actual</em>
structure is<br />
(not how it looks from within the mounted tree of filesystems and
subvolume), see<br />
<a href="https://github.com/rear/rear/issues/1496#issuecomment-329775673">https://github.com/rear/rear/issues/1496#issuecomment-329775673</a><br />
therein what I wrote about<br />
"In general when you have to deal with btrfs subvolumes".<br />
therein items (1) (2) and (3) - item (4) should not happen for a
pristine<br />
SLES12 default installation but it could happen when whatever tools<br />
create additional btrfs subvolumes in a SLES12 system.</p>
<p>Regarding what subvolume is mounted at the <code>/</code> directory in SLES12:<br />
It is the btrfs default subvolume that gets mounted at <code>/</code> in SLES12<br />
i.e. what <code>btrfs subvolume get-default /</code> shows.</p>
<p>For some very initial basics about btrfs on SLES12 you may also have a
look at<br />
<a href="https://en.opensuse.org/images/8/8b/Relax-and-Recover_jsmeix_presentation.pdf">https://en.opensuse.org/images/8/8b/Relax-and-Recover_jsmeix_presentation.pdf</a><br />
therein the two pages about "Relax-and-Recover on SLE12"<br />
which is about the old SLE12-GA/SP0 (where <code>.../@</code> is the default
subvolume)<br />
that is linked as "Fundamentals about Relax-and-Recover presentation
PDF"<br />
in the "See also" section in<br />
<a href="https://en.opensuse.org/SDB:Disaster_Recovery">https://en.opensuse.org/SDB:Disaster_Recovery</a></p>
<h4 id="jsmeix_commented_at_2018-05-23_0945"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-391288035">2018-05-23 09:45</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-05-23_0945" title="Permanent link">&para;</a></h4>
<p>@bern66<br />
in your older
<a href="https://github.com/rear/rear/issues/1796#issuecomment-387412149">https://github.com/rear/rear/issues/1796#issuecomment-387412149</a><br />
(I don't know if that is still valid here)<br />
therein in your
<a href="https://github.com/rear/rear/files/1984200/rear-20180508.zip">https://github.com/rear/rear/files/1984200/rear-20180508.zip</a><br />
your disklayout.conf contains</p>
<pre>
# Btrfs default subvolume for /dev/mapper/system-root at /
# Format: btrfsdefaultsubvol &lt;device> &lt;mountpoint> &lt;btrfs_subvolume_ID> &lt;btrfs_subvolume_path>
btrfsdefaultsubvol /dev/mapper/system-root / 5 /
</pre>

<p>which is not what matches an original SLES12 btrfs stucture.</p>
<p>On SLES12-GA/SP0 the btrfs default subvolume is</p>
<pre>
# btrfs subvolume get-default /
ID 257 gen 601 top level 5 path @

# grep ^btrfsdefaultsubvol var/lib/rear/layout/disklayout.conf
btrfsdefaultsubvol /dev/mapper/system-root / 257 @
</pre>

<p>On SLES12-SP1-or-later the btrfs default subvolume is</p>
<pre>
# btrfs subvolume get-default /
ID 259 gen 654 top level 258 path @/.snapshots/1/snapshot

# grep ^btrfsdefaultsubvol var/lib/rear/layout/disklayout.conf
btrfsdefaultsubvol /dev/mapper/system-root / 259 @/.snapshots/1/snapshot
</pre>

<h4 id="bern66_commented_at_2018-05-24_1747"><img src="https://avatars.githubusercontent.com/u/38959869?u=f7f85617d38f6bebe9285f89b6794b229152df0c&v=4" width="50"><a href="https://github.com/bern66">bern66</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-391801925">2018-05-24 17:47</a>:<a class="headerlink" href="#bern66_commented_at_2018-05-24_1747" title="Permanent link">&para;</a></h4>
<p>As far as I understand it, the btrfs structure is ok.</p>
<pre><code>tstinf03:~&gt; findmnt -a -o SOURCE,TARGET -t btrfs
SOURCE                                                  TARGET
/dev/mapper/system-root[/@/.snapshots/1/snapshot]       /
/dev/mapper/system-root[/@/srv]                         |-/srv
/dev/mapper/system-root[/@/var/crash]                   |-/var/crash
/dev/mapper/system-root[/@/boot/grub2/powerpc-ieee1275] |-/boot/grub2/powerpc-ieee1275
/dev/mapper/system-root[/@/var/lib/machines]            |-/var/lib/machines
/dev/mapper/system-root[/@/var/opt]                     |-/var/opt
/dev/mapper/system-root[/@/opt]                         |-/opt
/dev/mapper/system-root[/@/var/spool]                   |-/var/spool
/dev/mapper/system-root[/@/var/lib/mysql]               |-/var/lib/mysql
/dev/mapper/system-root[/@/var/lib/libvirt/images]      |-/var/lib/libvirt/images
/dev/mapper/system-root[/@/.snapshots]                  |-/.snapshots
/dev/mapper/system-root[/@/var/lib/pgsql]               |-/var/lib/pgsql
/dev/mapper/system-root[/@/var/lib/mailman]             |-/var/lib/mailman
/dev/mapper/system-root[/@/home]                        |-/home
/dev/mapper/system-root[/@/tmp]                         |-/tmp
/dev/mapper/system-root[/@/usr/local]                   |-/usr/local
/dev/mapper/system-root[/@/var/lib/mariadb]             |-/var/lib/mariadb
/dev/mapper/system-root[/@/var/cache]                   |-/var/cache
/dev/mapper/system-root[/@/var/log]                     |-/var/log
/dev/mapper/system-root[/@/var/tmp]                     |-/var/tmp
/dev/mapper/system-root[/@/var/lib/named]               `-/var/lib/named
</code></pre>
<p>The / seems mounted at a normal place.</p>
<pre><code>tstinf03:~ # btrfs subvolume get-default /
ID 279 gen 2925 top level 277 path @/.snapshots/1/snapshot
</code></pre>
<p>Now that I know rear can do the job, I'll have to find a way to fix our
systems in problem.</p>
<p>Thanks for your assistance.</p>
<h4 id="jsmeix_commented_at_2018-05-25_0901"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-391989667">2018-05-25 09:01</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-05-25_0901" title="Permanent link">&para;</a></h4>
<p>@bern66<br />
now the btrfs structure looks good!</p>
<p>An addedum FYI which could be also of interest for @schabrolles<br />
what I meanwhile found out how a plain SLES12-SP2 default installation<br />
can be different from a default installation of SLES_SAP12-SP2<br />
"SUSE Linux Enterprise Server for SAP Applications 12 SP2":</p>
<p>I asked a colleague at SUSE about<br />
what kind of btrfs setup a default installation of<br />
"SUSE Linux Enterprise Server for SAP Applications 12 SP2"<br />
should result.</p>
<p>He told me that SLES_SAP-12-SP2 consists of a pristine SLES12-SP2<br />
plus additional stuff (mainly SLES_HA plus some SAP specific stuff)<br />
so that when one installs SLES_SAP-12-SP2 from scratch<br />
one should get a pristine SLES12-SP2 btrfs setup.</p>
<p>But this is not fully true because actually there are differences.</p>
<p>It is expected that the disk space makes a difference<br />
whether or not one gets a btrfs setup with enabled<br />
or disabled snapshots.</p>
<p>What is unexpected is that even with exactly same disk space<br />
a default SLES_SAP-12-SP2 installation still differs<br />
from a default SLES12-SP2 installation.</p>
<p>When I install SLES12-SP2<br />
on a single 20 GiB (virtual) harddisk<br />
on a KVM/QEMU virtual machine I get<br />
by default plain partitioning without LVM and<br />
a btrfs setup with enabled snapshots<br />
so that in particular what is mounted at '/'<br />
is a snapper controlled btrfs snapshot subvolume:</p>
<pre>
# findmnt -a -o SOURCE,TARGET -t btrfs
SOURCE                                             TARGET
/dev/mapper/system-root[/@/.snapshots/1/snapshot]  /
...
</pre>

<p>I also get that btrfs setup with enabled snapshots<br />
when I select the "LVM-based Proposal" during<br />
SLES12-SP2 installation on the same virtual machine.</p>
<p>When I install SLES_SAP-12-SP2<br />
on a single 20 GiB (virtual) harddisk<br />
on a KVM/QEMU virtual machine I get<br />
by default the "LVM-based Proposal"<br />
(in contrast to what I get with plain SLES12-SP2)<br />
and I get a btrfs setup with disabled snapshots<br />
(in contrast to what I get with SLES12-SP2 on a 20 GiB harddisk)<br />
as follows:</p>
<pre>
# lsblk -i -p -o NAME,KNAME,TYPE,FSTYPE,SIZE /dev/sda
NAME                        KNAME     TYPE FSTYPE       SIZE
/dev/sda                    /dev/sda  disk               20G
`-/dev/sda1                 /dev/sda1 part LVM2_member   20G
  |-/dev/mapper/system-swap /dev/dm-0 lvm  swap         636M
  `-/dev/mapper/system-root /dev/dm-1 lvm  btrfs       19.4G

# findmnt -a -o SOURCE,TARGET -t btrfs
SOURCE                                             TARGET
/dev/mapper/system-root[/@]                        /
/dev/mapper/system-root[/@/home]                   |-/home
/dev/mapper/system-root[/@/opt]                    |-/opt
/dev/mapper/system-root[/@/var/lib/machines]       |-/var/lib/machines
/dev/mapper/system-root[/@/boot/grub2/i386-pc]     |-/boot/grub2/i386-pc
/dev/mapper/system-root[/@/var/crash]              |-/var/crash
/dev/mapper/system-root[/@/boot/grub2/x86_64-efi]  |-/boot/grub2/x86_64-efi
/dev/mapper/system-root[/@/var/lib/pgsql]          |-/var/lib/pgsql
/dev/mapper/system-root[/@/var/lib/mailman]        |-/var/lib/mailman
/dev/mapper/system-root[/@/var/lib/libvirt/images] |-/var/lib/libvirt/images
/dev/mapper/system-root[/@/var/cache]              |-/var/cache
/dev/mapper/system-root[/@/var/lib/mysql]          |-/var/lib/mysql
/dev/mapper/system-root[/@/var/lib/mariadb]        |-/var/lib/mariadb
/dev/mapper/system-root[/@/var/opt]                |-/var/opt
/dev/mapper/system-root[/@/tmp]                    |-/tmp
/dev/mapper/system-root[/@/var/lib/named]          |-/var/lib/named
/dev/mapper/system-root[/@/srv]                    |-/srv
/dev/mapper/system-root[/@/var/tmp]                |-/var/tmp
/dev/mapper/system-root[/@/var/spool]              |-/var/spool
/dev/mapper/system-root[/@/var/log]                |-/var/log
/dev/mapper/system-root[/@/usr/local]              `-/usr/local
</pre>

<p>I tested "rear mkbackup" plus "rear recover" on that system<br />
(i.e. when what is mounted at '/' is the btrfs normal subvolume '/@')<br />
which worked for me<br />
(using ReaR with the
<a href="https://github.com/rear/rear/pull/1813">https://github.com/rear/rear/pull/1813</a>
fix).</p>
<p>When I install SLES_SAP-12-SP2<br />
on a single 40 GiB (virtual) harddisk<br />
on a KVM/QEMU virtual machine I get<br />
by default the "LVM-based Proposal" and<br />
a btrfs setup with enabled snapshots<br />
as follows:</p>
<pre>
# lsblk -i -p -o NAME,KNAME,TYPE,FSTYPE,SIZE /dev/sda
NAME                        KNAME     TYPE FSTYPE       SIZE
/dev/sda                    /dev/sda  disk               40G
`-/dev/sda1                 /dev/sda1 part LVM2_member   40G
  |-/dev/mapper/system-swap /dev/dm-0 lvm  swap           2G
  `-/dev/mapper/system-root /dev/dm-1 lvm  btrfs       38.1G

# findmnt -a -o SOURCE,TARGET -t btrfs
SOURCE                                             TARGET
/dev/mapper/system-root[/@/.snapshots/1/snapshot]  /
/dev/mapper/system-root[/@/var/lib/mysql]          |-/var/lib/mysql
/dev/mapper/system-root[/@/boot/grub2/x86_64-efi]  |-/boot/grub2/x86_64-efi
/dev/mapper/system-root[/@/var/lib/machines]       |-/var/lib/machines
/dev/mapper/system-root[/@/opt]                    |-/opt
/dev/mapper/system-root[/@/tmp]                    |-/tmp
/dev/mapper/system-root[/@/var/lib/mariadb]        |-/var/lib/mariadb
/dev/mapper/system-root[/@/usr/local]              |-/usr/local
/dev/mapper/system-root[/@/var/opt]                |-/var/opt
/dev/mapper/system-root[/@/var/crash]              |-/var/crash
/dev/mapper/system-root[/@/var/spool]              |-/var/spool
/dev/mapper/system-root[/@/var/lib/mailman]        |-/var/lib/mailman
/dev/mapper/system-root[/@/var/lib/named]          |-/var/lib/named
/dev/mapper/system-root[/@/var/cache]              |-/var/cache
/dev/mapper/system-root[/@/var/log]                |-/var/log
/dev/mapper/system-root[/@/home]                   |-/home
/dev/mapper/system-root[/@/var/tmp]                |-/var/tmp
/dev/mapper/system-root[/@/srv]                    |-/srv
/dev/mapper/system-root[/@/.snapshots]             |-/.snapshots
/dev/mapper/system-root[/@/var/lib/libvirt/images] |-/var/lib/libvirt/images
/dev/mapper/system-root[/@/var/lib/pgsql]          |-/var/lib/pgsql
/dev/mapper/system-root[/@/boot/grub2/i386-pc]     `-/boot/grub2/i386-pc
</pre>

<p>which is the same as when I install SLES12-SP2<br />
on a single 20 GiB (virtual) harddisk<br />
on a KVM/QEMU virtual machine<br />
and select the "LVM-based Proposal", cf.<br />
<a href="https://github.com/rear/rear/issues/1796#issuecomment-389775698">https://github.com/rear/rear/issues/1796#issuecomment-389775698</a><br />
for SLES12-SP3.</p>
<h4 id="bern66_commented_at_2018-05-25_1214"><img src="https://avatars.githubusercontent.com/u/38959869?u=f7f85617d38f6bebe9285f89b6794b229152df0c&v=4" width="50"><a href="https://github.com/bern66">bern66</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-392035533">2018-05-25 12:14</a>:<a class="headerlink" href="#bern66_commented_at_2018-05-25_1214" title="Permanent link">&para;</a></h4>
<p>@jsmeix<br />
All your examples shows / mounted under /@ or /@/.snapshots just like my
<em>test</em> system. All our systems show a root filesystem mounted directly
under / like below and I understand this is the source of all my
problems.</p>
<pre><code>tstinf01:~/scripts # findmnt -a -o SOURCE,TARGET -t btrfs
SOURCE                                                  TARGET
/dev/mapper/system-root                                 /
/dev/mapper/system-root[/@/opt]                         |-/opt
/dev/mapper/system-root[/@/var/spool]                   |-/var/spool
/dev/mapper/system-root[/@/var/cache]                   |-/var/cache
</code></pre>
<h4 id="jsmeix_commented_at_2018-05-25_1225"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-392040395">2018-05-25 12:25</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-05-25_1225" title="Permanent link">&para;</a></h4>
<p>@bern66<br />
exactly!</p>
<p>FYI (also @schabrolles ):<br />
Next week I am not in the office, therefore:<br />
Have a nice (and hopefully relaxed) weekend and a successful next week!</p>
<h4 id="bern66_commented_at_2018-05-28_1150"><img src="https://avatars.githubusercontent.com/u/38959869?u=f7f85617d38f6bebe9285f89b6794b229152df0c&v=4" width="50"><a href="https://github.com/bern66">bern66</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-392506239">2018-05-28 11:50</a>:<a class="headerlink" href="#bern66_commented_at_2018-05-28_1150" title="Permanent link">&para;</a></h4>
<p>@jsmeix @schabrolles<br />
The btrfs problem is easily fixed.</p>
<pre><code>tstinf04:~ # findmnt  -ao SOURCE,TARGET -t btrfs
SOURCE                                                  TARGET
/dev/mapper/system-root                                 /
/dev/mapper/system-root[/@/var/opt]                     |-/var/opt
/dev/mapper/system-root[/@/var/spool]                   |-/var/spool
/dev/mapper/system-root[/@/tmp]                         |-/tmp
/dev/mapper/system-root[/@/.snapshots]                  |-/.snapshots

tstinf04:~ # snapper create
tstinf04:~ # snapper ls
Type   | #   | Pre # | Date                     | User | Cleanup | Description  | Userdata
-------+-----+-------+--------------------------+------+---------+--------------+--------------
single | 0   |       |                          | root |         | current      |
pre    | 241 |       | Thu Jan 11 10:16:25 2018 | root | number  | zypp(zypper) | important=no
post   | 242 | 241   | Thu Jan 11 10:16:26 2018 | root | number  |              | important=no
pre    | 243 |       | Thu Jan 11 10:16:37 2018 | root | number  | zypp(zypper) | important=no
post   | 244 | 243   | Thu Jan 11 10:16:38 2018 | root | number  |              | important=no
pre    | 245 |       | Mon May  7 09:33:14 2018 | root | number  | zypp(zypper) | important=yes
post   | 246 | 245   | Mon May  7 09:34:36 2018 | root | number  |              | important=yes
single | 247 |       | Mon May 28 07:44:35 2018 | root |         |              |
tstinf04:~ # snapper rollback 247
Creating read-only snapshot of current system. (Snapshot 248.)
Creating read-write snapshot of snapshot 247. (Snapshot 249.)
Setting default subvolume to snapshot 249.

tstinf04:~ # shutdown -r now

pgiststinf04:~ # findmnt  -ao SOURCE,TARGET -t btrfs
SOURCE                                                  TARGET
/dev/mapper/system-root[/@/.snapshots/249/snapshot]     /
/dev/mapper/system-root[/@/usr/local]                   |-/usr/local
/dev/mapper/system-root[/@/var/lib/pgsql]               |-/var/lib/pgsql
/dev/mapper/system-root[/@/var/crash]                   |-/var/crash
</code></pre>
<p>It is that easy to fix this problem. Thanks for your time. Now I am on
intensive ReaR testing.</p>
<h4 id="bern66_commented_at_2018-05-28_1325"><img src="https://avatars.githubusercontent.com/u/38959869?u=f7f85617d38f6bebe9285f89b6794b229152df0c&v=4" width="50"><a href="https://github.com/bern66">bern66</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-392526551">2018-05-28 13:25</a>:<a class="headerlink" href="#bern66_commented_at_2018-05-28_1325" title="Permanent link">&para;</a></h4>
<p>After a rear recover the system show a snapshot of 1.</p>
<pre><code>tstinf04:~ # findmnt -ao SOURCE,TARGET -t btrfs
SOURCE                                                  TARGET
/dev/mapper/system-root[/@/.snapshots/1/snapshot]       /
/dev/mapper/system-root[/@/var/lib/named]               |-/var/lib/named
/dev/mapper/system-root[/@/var/log]                     |-/var/log
</code></pre>
<h4 id="schabrolles_commented_at_2018-05-29_1837"><img src="https://avatars.githubusercontent.com/u/19491077?u=0021b16ab426902cbe676f6831f41607bbe4d441&v=4" width="50"><a href="https://github.com/schabrolles">schabrolles</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-392890056">2018-05-29 18:37</a>:<a class="headerlink" href="#schabrolles_commented_at_2018-05-29_1837" title="Permanent link">&para;</a></h4>
<p>I mark this one as fixed as the problem described in the title is solved
by the different patches referenced into this thread.</p>
<h4 id="schabrolles_commented_at_2018-05-29_1842"><img src="https://avatars.githubusercontent.com/u/19491077?u=0021b16ab426902cbe676f6831f41607bbe4d441&v=4" width="50"><a href="https://github.com/schabrolles">schabrolles</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-392891800">2018-05-29 18:42</a>:<a class="headerlink" href="#schabrolles_commented_at_2018-05-29_1842" title="Permanent link">&para;</a></h4>
<p>@bern66,</p>
<p>The fact the the snapshot is now 1 looks good to me. ReaR doesn't backup
the snapshots layer. it backups the system as it is when you run the
<code>rear mkbackup</code> command and recreate a new system during recovery that
can still work with btrfs snapshot and snapper. (so restart with
snapshot 1)</p>
<h4 id="bern66_commented_at_2018-05-29_1849"><img src="https://avatars.githubusercontent.com/u/38959869?u=f7f85617d38f6bebe9285f89b6794b229152df0c&v=4" width="50"><a href="https://github.com/bern66">bern66</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-392894593">2018-05-29 18:49</a>:<a class="headerlink" href="#bern66_commented_at_2018-05-29_1849" title="Permanent link">&para;</a></h4>
<p>Ok, that is what I understood. Thanks!</p>
<h4 id="jsmeix_commented_at_2018-06-04_1201"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1796#issuecomment-394330414">2018-06-04 12:01</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-06-04_1201" title="Permanent link">&para;</a></h4>
<p>FYI regarding<br />
after <code>rear recover</code> the system show a snapshot of 1<br />
see in<br />
usr/share/rear/conf/examples/SLE12-SP2-btrfs-example.conf<br />
the comment</p>
<pre>
# Regarding btrfs snapshots:
# Recovery of btrfs snapshot subvolumes is not possible.
# Only recovery of "normal" btrfs subvolumes is possible.
# On SLE12-SP1 and SP2 the only exception is the btrfs snapshot subvolume
# that is mounted at '/' but that one is not recreated but instead
# it is created anew from scratch during the recovery installation with the
# default first btrfs snapper snapshot subvolume path "@/.snapshots/1/snapshot"
# by the SUSE tool "installation-helper --step 1" (cf. below).
# Other snapshots like "@/.snapshots/234/snapshot" are not recreated.
</pre>

<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2024 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2018-05-04.1796.issue.closed.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/rear/rear-user-guide" class="fa fa-code-fork" style="color: #fcfcfc"> rear/rear-user-guide</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
