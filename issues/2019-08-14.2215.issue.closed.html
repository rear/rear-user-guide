<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#2215 Issue closed: Exclude temporary/external drives and mountpoints from checklayout and mkrescue's disklayout - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#2215 Issue closed: Exclude temporary/external drives and mountpoints from checklayout and mkrescue\u0027s disklayout";
        var mkdocs_page_input_path = "issues/2019-08-14.2215.issue.closed.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a> &raquo;</li>
      <li class="breadcrumb-item active">#2215 Issue closed: Exclude temporary/external drives and mountpoints from checklayout and mkrescue's disklayout</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="2215_issue_closed_exclude_temporaryexternal_drives_and_mountpoints_from_checklayout_and_mkrescues_disklayout"><a href="https://github.com/rear/rear/issues/2215">#2215 Issue</a> <code>closed</code>: Exclude temporary/external drives and mountpoints from checklayout and mkrescue's disklayout<a class="headerlink" href="#2215_issue_closed_exclude_temporaryexternal_drives_and_mountpoints_from_checklayout_and_mkrescues_disklayout" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>support / question</code>, <code>fixed / solved / done</code></p>
<h4 id="adatum_opened_issue_at_2019-08-14_0309"><img src="https://avatars.githubusercontent.com/u/9773655?v=4" width="50"><a href="https://github.com/adatum">adatum</a> opened issue at <a href="https://github.com/rear/rear/issues/2215">2019-08-14 03:09</a>:<a class="headerlink" href="#adatum_opened_issue_at_2019-08-14_0309" title="Permanent link">&para;</a></h4>
<ul>
<li>
<p>Relax-and-Recover 2.5-git.3350.aa82834d.unknown / 2019-05-10</p>
</li>
<li>
<p>Fedora 30</p>
</li>
<li>
<p>ReaR configuration files ("cat /etc/rear/site.conf" and/or "cat
    /etc/rear/local.conf"):<br />
    PROGS=( "${PROGS[@]}" /home/test/Downloads/borg-linux64 locale )</p>
</li>
<li>
<p>PC, x86_64</p>
</li>
<li>
<p>UEFI, GRUB</p>
</li>
<li>
<p>local SSD</p>
</li>
<li>
<p>Description of the issue (ideally so that others can reproduce it):</p>
</li>
</ul>
<p>Currently, temporarily mounted external USB drives and HDDs will be
detected as changes by checklayout, and incorporated into the disk
layout made by mkrescue. Apparently this is by design according to
<a href="https://github.com/rear/rear/issues/2207">https://github.com/rear/rear/issues/2207</a>.</p>
<p>This is a problem because the recovery media created will be
unpredictable and depend on what temporary devices may be present at the
moment mkrescue is run. Their inclusion in mkrescue's disk layout will
be an unpleasant surprise at recovery and far from "relaxing."</p>
<p>Is it currently possible to exclude such devices that are not part of
the permanent system? For example, something like Borg's
<code>--one-file-system</code> or ReaR's <code>EXCLUDE_MOUNTPOINTS</code> for backups?</p>
<h4 id="jsmeix_commented_at_2019-08-14_1144"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2215#issuecomment-521212531">2019-08-14 11:44</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-08-14_1144" title="Permanent link">&para;</a></h4>
<p>@adatum<br />
I have no idea how to reliably and in a fail-safe way distinguish in
an<br />
automated way what is temporarily mounted from what is permanantly<br />
mounted and how to distinguish an external disk from a built-in disk.</p>
<p>I don't know what "temporarily mounted" should mean from a<br />
computer's internal point of view (in contrast to the user who knows
it).</p>
<p>I know about server hardware that has a USB disk built in on the
motherboard<br />
(which can even get into one's way when that device suddenly becomes
/dev/sda<br />
and you cannot just unplug that unwanted device because it is built-in).</p>
<p>Because I am currently and for some more weeks not in the office<br />
I cannot try out and test how current ReaR actually behaves but<br />
what you describe has never been an issue before (as far as I can<br />
remember) so that I think how current ReaR behaves is o.k. for<br />
how it was and is used by our current users.</p>
<p>As far as I see from plain looking at the code in<br />
<a href="https://github.com/rear/rear/blob/master/usr/share/rear/lib/checklayout-workflow.sh">https://github.com/rear/rear/blob/master/usr/share/rear/lib/checklayout-workflow.sh</a><br />
and in particular in<br />
<a href="https://github.com/rear/rear/blob/master/usr/share/rear/layout/compare/default/500_compare_layout.sh">https://github.com/rear/rear/blob/master/usr/share/rear/layout/compare/default/500_compare_layout.sh</a><br />
what happens is that a new temporary disklayout.conf file is created<br />
where its active (i.e. non-commented) entries are compared with<br />
those of the last stored "official" disklayout.conf file.</p>
<p>So all the usual ways how to exclude disk layout components<br />
should work to avoid that unwanted mounted stuff gets included<br />
in disklayout.conf.</p>
<p>See in particular the section "Including/Excluding components" in<br />
<a href="https://github.com/rear/rear/blob/master/doc/user-guide/06-layout-configuration.adoc">https://github.com/rear/rear/blob/master/doc/user-guide/06-layout-configuration.adoc</a></p>
<h4 id="adatum_commented_at_2019-08-15_2211"><img src="https://avatars.githubusercontent.com/u/9773655?v=4" width="50"><a href="https://github.com/adatum">adatum</a> commented at <a href="https://github.com/rear/rear/issues/2215#issuecomment-521815673">2019-08-15 22:11</a>:<a class="headerlink" href="#adatum_commented_at_2019-08-15_2211" title="Permanent link">&para;</a></h4>
<p>@jsmeix</p>
<p>Thank you so much for taking the time to write such detailed
explanations.</p>
<p>I can appreciate that it is difficult, maybe even impossible, to tell
programmatically what the user considers temporary or undesirable for
inclusion in the disklayout.conf.</p>
<p>Thanks for the links. The section on "Manual Excludes" is almost
perfectly what I was asking about, specifically something like:</p>
<p><code>EXCLUDE_RECREATE=( "${EXCLUDE_RECREATE[@]}" "fs:/run/media" )</code></p>
<p>The problem is that it seems to exclude only exact paths (eg.
<code>fs:/run/media/[USER]/[DISK_LABEL]</code>), and not everything inside
<code>/run/media</code>. It also does not expand globs like <code>fs:/run/media/*</code>.</p>
<p>Maybe I'm missing something?</p>
<h4 id="jsmeix_commented_at_2019-08-16_0845"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2215#issuecomment-521936107">2019-08-16 08:45</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-08-16_0845" title="Permanent link">&para;</a></h4>
<p>Offhandedly I think something like wildcards to exclude things<br />
is currently not supported by ReaR.</p>
<p>But all config files (in particular etc/rear/local.conf) are sourced by
the<br />
usr/sbin/rear main script which means the config files are read and<br />
executed as all the other ReaR scripts so that you can do any bash<br />
programming you like also in ReaR config files.<br />
In particular you could do whathever works for your particular use
case<br />
to determine automatically the currently right values for what you
need<br />
to exclude.<br />
Simply put: Replace the hardcoded
'fs:/run/media/some_user/some_disk_label'<br />
value with code that autodetects it at runtime.</p>
<h4 id="adatum_commented_at_2019-08-18_0619"><img src="https://avatars.githubusercontent.com/u/9773655?v=4" width="50"><a href="https://github.com/adatum">adatum</a> commented at <a href="https://github.com/rear/rear/issues/2215#issuecomment-522294876">2019-08-18 06:19</a>:<a class="headerlink" href="#adatum_commented_at_2019-08-18_0619" title="Permanent link">&para;</a></h4>
<p>Thanks for the reminder. That the config files are sourced as bash
scripts gives a lot of flexibility.</p>
<p>I am quite wary of adding my own code due to code
quality/maintainability and possible side effects. Nevertheless, this
seems to give me the behavior I want:</p>
<pre><code>EXCLUDE_RECREATE=( "${EXCLUDE_RECREATE[@]}" $( EXCLUDE_RECREATE_MOUNTPOINTS="/run/media|/mnt"; if [ -n "$EXCLUDE_RECREATE_MOUNTPOINTS" ]; then grep -Eo "(^|\s)($EXCLUDE_RECREATE_MOUNTPOINTS)\S*" /proc/mounts | sed -r 's/\s(.*)/ fs:\1 /' | tr -d '\n'; fi ) )
</code></pre>
<p>Breaking it down:</p>
<ul>
<li>
<p><code>EXCLUDE_RECREATE_MOUNTPOINTS</code></p>
<ul>
<li>Seems to be a unique variable name (searched the GitHub repo for
    this string).</li>
<li>The base mount points to exclude must all be included in one set
    of quotes, with no spaces, and separated by <code>|</code>.</li>
<li>Right now I made everything inline, but for clarity this
    variable should probably be placed outside on a line of its own.</li>
</ul>
</li>
<li>
<p><code>if [ -n "$EXCLUDE_RECREATE_MOUNTPOINTS" ]</code></p>
<ul>
<li>Run the logic only if the exclusion string is not empty.</li>
</ul>
</li>
<li>
<p><code>grep -Eo "(^|\s)($EXCLUDE_RECREATE_MOUNTPOINTS)\S*" /proc/mounts</code></p>
<ul>
<li>Look at <code>/proc/mounts</code> for the definitive list of mounts.</li>
<li>Use extended regular expressions <code>-E</code> to support parentheses.</li>
<li><code>-o</code>: output only the matched portion of the string instead of
    the entire line.</li>
<li><code>($EXCLUDE_RECREATE_MOUNTPOINTS)\S*</code>: match from the mount
    prefix until a whitespace character to capture all full paths.</li>
<li><code>(^|\s)</code>: start matching from whitespace as our starting
    delimiter (to make sure the exclusion prefix is the base and not
    a subdirectory, i.e. avoid capturing <code>/somedirectory/prefix</code>),
    or start of the line (to catch potential matches at the very
    beginning of the line/file without preceding whitespace).</li>
</ul>
</li>
<li>
<p><code>sed -r 's/\s(.*)/ fs:\1 /'</code></p>
<ul>
<li>Use <code>sed</code> to add the surrounding text necessary for
    <code>EXCLUDE_RECREATE</code></li>
<li><code>\s(.*)</code>: capture everything except the initial whitespace.
    Could this be a problem if the match was at the start of the
    line with no preceding whitespace? This is unlikely for this
    purpose since the desired match is always on the second column
    of <code>/proc/mounts</code>, but it would be nice to have robust logic
    nonetheless.</li>
<li><code>/ fs:\1 /</code>: prepend <code>fs:</code> and add a space before and after the
    mount point. Not sure if quotes are also needed, but it seems to
    work as is.</li>
</ul>
</li>
<li>
<p><code>tr -d '\n'</code>: delete newlines to have everything on one line to be
    included in the <code>EXCLUDE_RECREATE</code> array.</p>
</li>
</ul>
<p>Any comments about potential issues or corrections are appreciated.</p>
<h4 id="adatum_commented_at_2019-09-13_0241"><img src="https://avatars.githubusercontent.com/u/9773655?v=4" width="50"><a href="https://github.com/adatum">adatum</a> commented at <a href="https://github.com/rear/rear/issues/2215#issuecomment-531077535">2019-09-13 02:41</a>:<a class="headerlink" href="#adatum_commented_at_2019-09-13_0241" title="Permanent link">&para;</a></h4>
<p>As discovered in #2229, the <code>AUTOEXCLUDE_PATH</code> variable addresses the
request in this issue. It excludes not just exact paths but everything
below the specified paths as well.</p>
<p>However, wildcards still seem not to be supported. The solution in the
previous post does exclude partial matches for directories. i.e.
specifying <code>/dir</code> will exclude <code>/dir1</code>, <code>/dir2</code>, etc.</p>
<h4 id="jsmeix_commented_at_2019-09-13_1447"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2215#issuecomment-531266703">2019-09-13 14:47</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-09-13_1447" title="Permanent link">&para;</a></h4>
<p>@adatum<br />
thanks to mention <code>AUTOEXCLUDE_PATH</code>.<br />
Right now I did
<a href="https://github.com/rear/rear/issues/2239">https://github.com/rear/rear/issues/2239</a></p>
<p>In general see also<br />
<a href="https://github.com/rear/rear/issues/2229#issuecomment-531264805">https://github.com/rear/rear/issues/2229#issuecomment-531264805</a></p>
<p>Currently - as far as I see - there is no simple clear and consistently
working way<br />
how the user could specify what disk layout components he wants to get
recreated<br />
and what mountpoints or directories he wants to get included in the
backup, cf.<br />
<a href="https://github.com/rear/rear/issues/2236#issuecomment-531204474">https://github.com/rear/rear/issues/2236#issuecomment-531204474</a></p>
<h4 id="jsmeix_commented_at_2020-06-24_1056"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2215#issuecomment-648749930">2020-06-24 10:56</a>:<a class="headerlink" href="#jsmeix_commented_at_2020-06-24_1056" title="Permanent link">&para;</a></h4>
<p>I think with
<a href="https://github.com/rear/rear/issues/2239">https://github.com/rear/rear/issues/2239</a>
merged<br />
this issue is fixed to some acceptable extent so that I can close this
issue<br />
and we still have
<a href="https://github.com/rear/rear/issues/2229">https://github.com/rear/rear/issues/2229</a>
open<br />
for the more general case.</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2023 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2019-08-14.2215.issue.closed.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
