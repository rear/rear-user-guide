<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#2979 PR closed: superseded: non-interactive mode for ReaR - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#2979 PR closed: superseded: non-interactive mode for ReaR";
        var mkdocs_page_input_path = "issues/2023-05-04.2979.pr.closed.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/backup_netfs.html">Example of BACKUP=NETFS</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#2979 PR closed: superseded: non-interactive mode for ReaR</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="2979_pr_closed_superseded_non-interactive_mode_for_rear"><a href="https://github.com/rear/rear/pull/2979">#2979 PR</a> <code>closed</code>: superseded: non-interactive mode for ReaR<a class="headerlink" href="#2979_pr_closed_superseded_non-interactive_mode_for_rear" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>enhancement</code>, <code>won't fix / can't fix / obsolete</code></p>
<h4 id="codefritzel_opened_issue_at_2023-05-04_1156"><img src="https://avatars.githubusercontent.com/u/118316875?v=4" width="50"><a href="https://github.com/codefritzel">codefritzel</a> opened issue at <a href="https://github.com/rear/rear/pull/2979">2023-05-04 11:56</a>:<a class="headerlink" href="#codefritzel_opened_issue_at_2023-05-04_1156" title="Permanent link">&para;</a></h4>
<h4 id="relax-and-recover_rear_pull_request_template">Relax-and-Recover (ReaR) Pull Request Template<a class="headerlink" href="#relax-and-recover_rear_pull_request_template" title="Permanent link">&para;</a></h4>
<p>Please fill in the following items before submitting a new pull request:</p>
<h5 id="pull_request_details">Pull Request Details:<a class="headerlink" href="#pull_request_details" title="Permanent link">&para;</a></h5>
<ul>
<li>
<p>Type: <strong>Enhancement</strong></p>
</li>
<li>
<p>Impact: <strong>Normal</strong></p>
</li>
<li>
<p>How was this pull request tested?<br />
    manually on Ubu2204 and OL8</p>
</li>
<li>
<p>Brief description of the changes in this pull request:</p>
</li>
</ul>
<p>This PR adds a non-interactive mode in ReaR.<br />
This mode is intended when ReaR is started with an external automation
tool like Ansible and there is no possibility to do an user input.<br />
If a user input is needed, ReaR should abort with an error and not get
stuck in user input loop.<br />
The <code>UserInput</code> function has been modified so that it returns the
dafault value in non-interactive mode otherwise an error is thrown.<br />
In the scripts the mode can be checked and handled with the variable
<code>NON_INTERACTIVE</code>.<br />
For example, see
<code>usr/share/rear/verify/GALAXY11/default/420_login_to_galaxy_and_setup_environment.sh</code>:</p>
<pre><code>is_true "$NON_INTERACTIVE" &amp;&amp; \
            Error "Login is not possible in non-interactive mode. Set variables GALAXY11_USER and GALAXY11_PASSWORD."
</code></pre>
<p>The non-interactive mode mode can be activated with the command line
option <code>-n</code> or <code>--non-interactive</code>.</p>
<h4 id="jsmeix_commented_at_2023-05-04_1314"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2979#issuecomment-1534762436">2023-05-04 13:14</a>:<a class="headerlink" href="#jsmeix_commented_at_2023-05-04_1314" title="Permanent link">&para;</a></h4>
<p>Unfortunately in current ReaR code the UserInput function<br />
is not the only way how ReaR may ask for user input.</p>
<p>There are some code places left where 'read' or 'select'<br />
is called directly to get user input, for example<br />
in the ReaR recovery system startup scripts like 'select' in<br />
<a href="https://github.com/rear/rear/blob/master/usr/share/rear/skel/default/etc/scripts/system-setup.d/55-migrate-network-devices.sh">https://github.com/rear/rear/blob/master/usr/share/rear/skel/default/etc/scripts/system-setup.d/55-migrate-network-devices.sh</a><br />
but I think also for some third-party backup methods<br />
and at some other code places.</p>
<h4 id="jsmeix_commented_at_2023-05-04_1319"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2979#issuecomment-1534768715">2023-05-04 13:19</a>:<a class="headerlink" href="#jsmeix_commented_at_2023-05-04_1319" title="Permanent link">&para;</a></h4>
<p>The UserInput function is intentionally made<br />
to be ready for automated usage via the<br />
USER_INPUT_... config variables<br />
so no additional special code should be needed<br />
for UserInput() for automated usage.</p>
<p>I.e. from my current point of view I don't see<br />
why this pull request is needed - or in other words:</p>
<p>@codefritzel<br />
what does not work for you with<br />
the USER_INPUT_... config variables<br />
for your particular automated use case?</p>
<h4 id="jsmeix_commented_at_2023-05-04_1330"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2979#issuecomment-1534786831">2023-05-04 13:30</a>:<a class="headerlink" href="#jsmeix_commented_at_2023-05-04_1330" title="Permanent link">&para;</a></h4>
<p>The code places where UserInput is called without '-D'<br />
i.e. without a default input value are currently:</p>
<pre><code># find usr/sbin/rear usr/share/rear -type f | xargs grep 'UserInput ' | grep -v ': *#' | grep -v ' -D

usr/share/rear/format/USB/default/300_format_usb_disk.sh:
        USB_UEFI_PART_SIZE="$( UserInput -I USB_DEVICE_EFI_PARTITION_MIBS -p "Enter size for EFI system partition on $RAW_USB_DEVICE in MiB (default 512 MiB)" )"

usr/share/rear/layout/prepare/GNU/Linux/150_include_drbd_code.sh:
    user_input="$( UserInput -I DRBD_RESOURCE_BECOMES_PRIMARY -p "Type 'yes' if you want DRBD resource $resource to become primary" )"

usr/share/rear/restore/BORG/default/300_load_archives.sh:
    choice="$( UserInput -I BORGBACKUP_ARCHIVE_TO_RECOVER -p "Choose archive to recover from" )"

usr/share/rear/restore/NBKDC/default/400_restore_backup.sh:
    if is_true "$( UserInput -I NBKDC_WAIT_UNTIL_RESTORE_SUCCEEDED -t 0 -p "$user_input_prompt" )" ; then

usr/share/rear/verify/GALAXY11/default/500_select_backupset.sh:
 GALAXY11_BACKUPSET=$( UserInput -I GALAXY11_BACKUPSET -p "Select CommVault backupset to use:" "${backupsets[@]}" )

usr/share/rear/verify/GALAXY11/default/550_request_point_in_time_restore_parameters.sh:
 GALAXY11_PIT_RECOVERY=$( UserInput -I GALAXY11_PIT_RECOVERY -p "Select point-in-time restore to use (ENTER for latest):" "${job_end_times[@]}" )

usr/share/rear/verify/CDM/default/410_use_replica_cdm_cluster_cert.sh:
    CDM_CLUSTER_IP="$( UserInput -I CDM_CLUSTER_IP -r -t 0 -p "$prompt" )"

usr/share/rear/verify/CDM/default/410_use_replica_cdm_cluster_cert.sh:
            CDM_AGENT_URL="$( UserInput -I CDM_AGENT_URL -r -t 0 -p "$prompt" )"

usr/share/rear/verify/NBU/default/390_request_point_in_time_restore_parameters.sh:
    answer=$( UserInput -I NBU_RESTORE_PIT -r -p "Enter date (mm/dd/yyyy) or date and time (mm/dd/yyyy HH:MM:SS) or press ENTER" )

usr/share/rear/verify/TSM/default/390_request_point_in_time_restore_parameters.sh:
    answer=$( UserInput -I TSM_RESTORE_PIT -r -p "Enter date/time (YYYY-MM-DD HH:mm:ss) or press ENTER" )

usr/share/rear/verify/GALAXY10/default/550_request_point_in_time_restore_parameters.sh:
    answer=$( UserInput -I GALAXY10_RESTORE_PIT -r -p "Enter date/time (MM/DD/YYYY HH:mm:ss) or press ENTER" )

usr/share/rear/verify/NSR/default/390_request_point_in_time_restore_parameters.sh:
            answer=$( UserInput -I NSR_RESTORE_PIT -r -p "Enter date (mm/dd/yyyy) or date and time (mm/dd/yyyy HH:MM:SS) or press ENTER" )

usr/share/rear/lib/opal-functions.sh:
        password="$(UserInput -I "$id" -C -r -s -t 0 -p "$prompt")"
...
        result="$(UserInput -I "$id" -t 0 -p "$prompt")"
</code></pre>
<p>As far as I see nowhere is UserInput called without '-I'</p>
<pre><code># find usr/sbin/rear usr/share/rear -type f | xargs grep -h 'UserInput ' | grep -v '^ *#' | grep -v ' -I '

[no output ]
</code></pre>
<p>so for all cases where UserInput is called<br />
it is possible to specify a predefined user input value.</p>
<h4 id="jsmeix_commented_at_2023-05-04_1338"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2979#issuecomment-1534799915">2023-05-04 13:38</a>:<a class="headerlink" href="#jsmeix_commented_at_2023-05-04_1338" title="Permanent link">&para;</a></h4>
<p>I see there are perhaps some cases where<br />
any predefined user input value cannot make sense<br />
e.g. because any predefined value would be wrong<br />
or any predefined value would be a security issue.</p>
<p>So I could enhance the UserInput function to error out<br />
when a special predefined user input value is specified,<br />
for example when that value is 'ERROR_ABORT' e.g. like</p>
<pre><code>USER_INPUT_GALAXY10_RESTORE_PIT="ERROR_ABORT"
</code></pre>
<p>then the call</p>
<pre><code>UserInput -I GALAXY10_RESTORE_PIT ...
</code></pre>
<p>would just error out.</p>
<h4 id="jsmeix_commented_at_2023-05-04_1355"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2979#issuecomment-1534828520">2023-05-04 13:55</a>:<a class="headerlink" href="#jsmeix_commented_at_2023-05-04_1355" title="Permanent link">&para;</a></h4>
<p>In general see<br />
<a href="https://github.com/rear/rear/wiki/Coding-Style#it-should-be-possible-to-run-rear-unattended">https://github.com/rear/rear/wiki/Coding-Style#it-should-be-possible-to-run-rear-unattended</a></p>
<p>So in theory all code in ReaR should be so that it can run unattended.</p>
<p>In theory, theory and practice are the same. In practice, they are not.</p>
<p>I think it is more helpful in practice to fix those code places<br />
where ReaR cannot run unattended one by one as they become known<br />
than a new generic mode which does not work in general, see<br />
<a href="https://github.com/rear/rear/pull/2979#issuecomment-1534762436">https://github.com/rear/rear/pull/2979#issuecomment-1534762436</a><br />
because currently a non-interactive mode would be<br />
just one more false promise to the user.</p>
<h4 id="schlomo_commented_at_2023-05-04_1705"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/2979#issuecomment-1535102866">2023-05-04 17:05</a>:<a class="headerlink" href="#schlomo_commented_at_2023-05-04_1705" title="Permanent link">&para;</a></h4>
<p>@codefritzel there is a lot of wisdom in what @jsmeix says here.</p>
<p>Maybe another aproach would actually provide an easier solution? what
happens if you call ReaR like this</p>
<pre><code>yes "" | rear recover -v
</code></pre>
<p>In thise way every prompt will be answered with ENTER and I imagine that
your login prompt would also quickly lead to a failure, which you could
then detect from Ansible.</p>
<p>Or, rather:</p>
<pre><code>bash -c "exec rear recover -v &lt; &lt;(yes '')"
</code></pre>
<p>(bash creates the stdin input redirection and then replaces itself with
rear)</p>
<p>to easier get the return code of <code>rear</code>.</p>
<h4 id="codefritzel_commented_at_2023-05-04_2010"><img src="https://avatars.githubusercontent.com/u/118316875?v=4" width="50"><a href="https://github.com/codefritzel">codefritzel</a> commented at <a href="https://github.com/rear/rear/pull/2979#issuecomment-1535350129">2023-05-04 20:10</a>:<a class="headerlink" href="#codefritzel_commented_at_2023-05-04_2010" title="Permanent link">&para;</a></h4>
<blockquote>
<p>The UserInput function is intentionally made to be ready for automated
usage via the USER_INPUT_... config variables so no additional
special code should be needed for UserInput() for automated usage.</p>
<p>I.e. from my current point of view I don't see why this pull request
is needed - or in other words:</p>
<p>@codefritzel what does not work for you with the USER_INPUT_...
config variables for your particular automated use case?</p>
</blockquote>
<p>@jsmeix thanks for the tipp i did not know that at all.</p>
<blockquote>
<p>I see there are perhaps some cases where any predefined user input
value cannot make sense e.g. because any predefined value would be
wrong or any predefined value would be a security issue.</p>
<p>So I could enhance the UserInput function to error out when a special
predefined user input value is specified, for example when that value
is 'ERROR_ABORT' e.g. like</p>
<pre><code>USER_INPUT_GALAXY10_RESTORE_PIT="ERROR_ABORT"
</code></pre>
<p>then the call</p>
<pre><code>UserInput -I GALAXY10_RESTORE_PIT ...
</code></pre>
<p>would just error out.</p>
</blockquote>
<p>This could be an alternative, but the user must know all possible inputs
before.</p>
<blockquote>
<p>@codefritzel there is a lot of wisdom in what @jsmeix says here.</p>
<p>Maybe another aproach would actually provide an easier solution? what
happens if you call ReaR like this</p>
<pre><code>yes "" | rear recover -v
</code></pre>
<p>In thise way every prompt will be answered with ENTER and I imagine
that your login prompt would also quickly lead to a failure, which you
could then detect from Ansible.</p>
<p>Or, rather:</p>
<pre><code>bash -c "exec rear recover -v &lt; &lt;(yes '')"
</code></pre>
<p>(bash creates the stdin input redirection and then replaces itself
with rear)</p>
<p>to easier get the return code of <code>rear</code>.</p>
</blockquote>
<p>@schlomo in my opinion these are "dirty" workarounds which only work if
the inputs are not validated.<br />
Here is an example with GALAXY11_PIT_RECOVERY:<br />
ReaR was called by ansible and there was no feedback for a long time.
The reason was that a UserInput was requested for
GALAXY11_PIT_RECOVERY and this was validated in a loop. This had
created an infinite loop because of this code section:</p>
<pre><code>until IsInArray "$GALAXY11_PIT_RECOVERY" "${job_end_times[@]}"; do
    GALAXY11_PIT_RECOVERY=$( UserInput -I GALAXY11_PIT_RECOVERY -p "Select point-in-time restore to use (ENTER for latest):" "${job_end_times[@]}" )
done
</code></pre>
<p>This has already been fixed in
<a href="https://github.com/rear/rear/commit/0ebb2c62739c6c973b1c9d4d0682bdd48e3825fb">0ebb2c</a>
but there is still a concern that this problem will occur somewhere
else. In this case the desire for ReaR is to abort in such a case.</p>
<p>I think with the non-interactive mode this would be the cleanest way to
do it. If this it implemented in the relevant sections.</p>
<h4 id="jsmeix_commented_at_2023-05-05_0532"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2979#issuecomment-1535718277">2023-05-05 05:32</a>:<a class="headerlink" href="#jsmeix_commented_at_2023-05-05_0532" title="Permanent link">&para;</a></h4>
<p>@codefritzel<br />
as far as I understand it currently<br />
I think the generic functionality you need<br />
is to monitor a running process ('rear' in this case)<br />
whether or not it is actually doing something<br />
in contrast to only endlessly useless waiting.</p>
<p>I think the problem with that is how to distinguish<br />
between deliberate waiting (for something that will happen)<br />
and endlessly useless waiting.</p>
<p>For a nice example of deliberate waiting see your<br />
recent "nfs_server as new restore method"<br />
<a href="https://github.com/rear/rear/pull/2973">https://github.com/rear/rear/pull/2973</a><br />
via restore/NFS4SERVER/default/400_restore_with_nfs_server.sh<br />
<a href="https://github.com/rear/rear/blob/master/usr/share/rear/restore/NFS4SERVER/default/400_restore_with_nfs_server.sh">https://github.com/rear/rear/blob/master/usr/share/rear/restore/NFS4SERVER/default/400_restore_with_nfs_server.sh</a></p>
<p>The good thing of this deliberate waiting is<br />
that is is gentle busy waiting via</p>
<pre><code>while WAIT_CONDITION ; do
    ...
    sleep 5
    ...
done
</code></pre>
<p>so the waiting process is not totally idle<br />
i.e. the waiting process does not appear to be dead(locked).</p>
<h4 id="pcahyna_commented_at_2023-05-05_0955"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/2979#issuecomment-1536014573">2023-05-05 09:55</a>:<a class="headerlink" href="#pcahyna_commented_at_2023-05-05_0955" title="Permanent link">&para;</a></h4>
<p>@codefritzel</p>
<blockquote>
<p>Here is an example with GALAXY11_PIT_RECOVERY: ReaR was called by
ansible and there was no feedback for a long time.</p>
</blockquote>
<p>Note that there is the <code>USER_INPUT_TIMEOUT</code> variable, which can be used
to shorten waiting for input that never arrives</p>
<blockquote>
<p>The reason was that a UserInput was requested for
GALAXY11_PIT_RECOVERY and this was validated in a loop. This had
created an infinite loop because of this code section:</p>
</blockquote>
<p>I think that this infinite loop case warrants some extension of
<code>UserInput</code>: either one would be able to specify in the code that user
input must be provided, or the function would abort if called some
number of times for the same input and timed out (or some combination of
both).</p>
<blockquote>
<pre><code>until IsInArray "$GALAXY11_PIT_RECOVERY" "${job_end_times[@]}"; do
    GALAXY11_PIT_RECOVERY=$( UserInput -I GALAXY11_PIT_RECOVERY -p "Select point-in-time restore to use (ENTER for latest):" "${job_end_times[@]}" )
done
</code></pre>
<p>This has already been fixed in
<a href="https://github.com/rear/rear/commit/0ebb2c62739c6c973b1c9d4d0682bdd48e3825fb">0ebb2c</a>
but there is still a concern that this problem will occur somewhere
else. In this case the desire for ReaR is to abort in such a case.</p>
<p>I think with the non-interactive mode this would be the cleanest way
to do it. If this it implemented in the relevant sections.</p>
</blockquote>
<p>Note that there is already the <code>unattended</code> command line option, which
implements a sort of non-interactive mode. Could you check whether it
does what you need and if not whether it would make sense to extend it?</p>
<h4 id="schlomo_commented_at_2023-05-10_0817"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/2979#issuecomment-1541554552">2023-05-10 08:17</a>:<a class="headerlink" href="#schlomo_commented_at_2023-05-10_0817" title="Permanent link">&para;</a></h4>
<p>Here is another idea:</p>
<p>Extend the <code>UserInput</code> function so that it will automatically abort on
repeated calls on the same variable. That way interactive prompts can be
answered with the default response but loops that keep asking for the
same <code>UserInput</code> will then abort automatically on the second try.</p>
<p>What do you think about that?</p>
<h4 id="jsmeix_commented_at_2023-05-10_0853"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2979#issuecomment-1541609286">2023-05-10 08:53</a>:<a class="headerlink" href="#jsmeix_commented_at_2023-05-10_0853" title="Permanent link">&para;</a></h4>
<pre><code>for something in foo bar baz ; do
    ...
    UserInput -I WAIT_UNTIL_ENTER -t 0 -p 'Press [Enter] to continue'
    ...
done
</code></pre>
<h4 id="schlomo_commented_at_2023-05-10_1008"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/2979#issuecomment-1541857902">2023-05-10 10:08</a>:<a class="headerlink" href="#schlomo_commented_at_2023-05-10_1008" title="Permanent link">&para;</a></h4>
<p>@jsmeix what do you mean? That this example would not work with my
suggestion? Yes, of course not.</p>
<p>I'm still trying to find a solution for making ReaR work better in
unattended mode, and especially preventing endless <code>UserInput</code> loops.
The one during recovery #2984 is maybe one of the worst examples, but
there may be others.</p>
<p>I don't mind modifying my suggestion so that calling <code>UserInput</code> 10
times with the same variable will lead to an abort. And we can also make
it a configuration option that must be activated via a parameter, e.g.
the <code>--non-interactive</code> parameter.</p>
<h4 id="pcahyna_commented_at_2023-05-10_1124"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/2979#issuecomment-1542006691">2023-05-10 11:24</a>:<a class="headerlink" href="#pcahyna_commented_at_2023-05-10_1124" title="Permanent link">&para;</a></h4>
<blockquote>
<p>Here is another idea:</p>
<p>Extend the <code>UserInput</code> function so that it will automatically abort on
repeated calls on the same variable. That way interactive prompts can
be answered with the default response but loops that keep asking for
the same <code>UserInput</code> will then abort automatically on the second try.</p>
<p>What do you think about that?</p>
</blockquote>
<p>yes, it is similar to what I meant by "or the function would abort if
called some number of times for the same input and timed out" - by "same
input" I meant "on the same variable" - and I meant to abort on a
specific number of calls and not necessarily already at the second one.
Also, to abort only if the fucntion timed out multiple times, not when
the input has been entered properly. Aborting always would basically
prevent using UserInput in a loop, which could also have its would also
have its merits and possibly disadvantages.</p>
<h4 id="schlomo_commented_at_2023-05-10_1159"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/2979#issuecomment-1542078083">2023-05-10 11:59</a>:<a class="headerlink" href="#schlomo_commented_at_2023-05-10_1159" title="Permanent link">&para;</a></h4>
<p>Good idea, we can count the "nobody took care of me for the N-th time"
when triggering the timeout in <code>UserInput</code>. That way it really happens
only without user interaction</p>
<h4 id="jsmeix_commented_at_2023-05-10_1315"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2979#issuecomment-1542195362">2023-05-10 13:15</a>:<a class="headerlink" href="#jsmeix_commented_at_2023-05-10_1315" title="Permanent link">&para;</a></h4>
<p>@pcahyna<br />
thank you for your proposal.</p>
<p>@schlomo<br />
thank you for your summary reason why this proposal works.</p>
<p>Now I agree with the proposed method.</p>
<p>Regarding using the same UserInput in a loop:</p>
<p>This is what I meant with<br />
<a href="https://github.com/rear/rear/pull/2979#issuecomment-1541609286">https://github.com/rear/rear/pull/2979#issuecomment-1541609286</a><br />
where same input '[Enter]' is needed several times in a loop<br />
with same UserInput ID 'WAIT_UNTIL_ENTER'.</p>
<p>A real-world example is similar as<br />
<a href="https://github.com/rear/rear/issues/2984">https://github.com/rear/rear/issues/2984</a><br />
but in interactive mode when diskrestore.sh<br />
needs to be run several times in a loop<br />
with same UserInput 'LAYOUT_CODE_RUN' and<br />
same input "Rerun disk recreation script"<br />
because the user could also fix things<br />
by only calling command line tools via another shell<br />
which he could do on a second terminal (e.g. via ssh)<br />
so that via the terminal where 'rear' is run only the<br />
UserInput 'LAYOUT_CODE_RUN' is run several times in a loop<br />
with several times same input "Rerun disk recreation script".</p>
<h4 id="schlomo_commented_at_2023-05-10_1322"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/2979#issuecomment-1542204564">2023-05-10 13:22</a>:<a class="headerlink" href="#schlomo_commented_at_2023-05-10_1322" title="Permanent link">&para;</a></h4>
<p>We'll rework this PR to</p>
<ol>
<li>abort in the <code>UserInput</code> function if the <strong>timeout</strong> is hit too many
    times (configurable)</li>
<li>activate non-interactive together with the unattended recovery</li>
</ol>
<p>Any other wishes to include?</p>
<p>I'm actually wondering if we can have (1) always active but with a
higher count, e.g. 10, and then reduce that to 1 together with setting
the <code>USER_INPUT_TIMEOUT</code> to 3 seconds as the main action of the
<code>--non-interactive</code> flag? I can't imagine where somebody would want to
cycle more than 10 times through the same question and this approach
makes it simple to manually test ReaR with convenient timeouts and then
use ReaR "in production" and non-interactive with short timeouts and no
timeout-driven retries, without changing the configuration files.</p>
<h4 id="jsmeix_commented_at_2023-05-10_1442"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2979#issuecomment-1542329183">2023-05-10 14:42</a>:<a class="headerlink" href="#jsmeix_commented_at_2023-05-10_1442" title="Permanent link">&para;</a></h4>
<p>I think when there is a --non-interactive flag,<br />
then the maximum number of timeouts for the same UserInput<br />
could be even unlimited when --non-interactive is not set.<br />
In contrast when --non-interactive is set,<br />
then the maximum number of timeouts is what the user specified<br />
or as fallback what is specified for it in default.conf.</p>
<p>Or in other words:<br />
Keep the current behaviour when --non-interactive is not set.<br />
Do whatever is needed when --non-interactive is set.</p>
<p>My reason for unlimited number of timeouts<br />
when --non-interactive is not set is that<br />
I think it could be rather unfriendly behaviour<br />
for the user if it all of a sudden aborts ReaR<br />
after a relatively small number of timeouts<br />
(and a big number of timeouts behaves in practice<br />
same as unlimited number of timeouts).</p>
<p>In particular during "rear recover" any automated abort<br />
because of something that is not an actual hard error<br />
would be rather unfriendly behaviour for a user<br />
who is interactively struggling with "rear recover".</p>
<p>Simply put:<br />
In interactive mode only the user should abort ReaR.<br />
(It is a different thing when ReaR must error out.)</p>
<h4 id="schlomo_commented_at_2023-05-10_1656"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/2979#issuecomment-1542527549">2023-05-10 16:56</a>:<a class="headerlink" href="#schlomo_commented_at_2023-05-10_1656" title="Permanent link">&para;</a></h4>
<p>BTW, I'll keep the <code>Error</code> if non-interactive is used and a <code>UserInput</code>
has no default choice, as this affects only very few cases:</p>
<pre><code>git grep '\$(.*UserInput' | grep -v -- -D | grep -v functions.sh
usr/share/rear/format/USB/default/300_format_usb_disk.sh:        USB_UEFI_PART_SIZE="$( UserInput -I USB_DEVICE_EFI_PARTITION_MIBS -p "Enter size for EFI system partition on $RAW_USB_DEVICE in MiB (default 512 MiB)" )"
usr/share/rear/layout/prepare/GNU/Linux/150_include_drbd_code.sh:    user_input="$( UserInput -I DRBD_RESOURCE_BECOMES_PRIMARY -p "Type 'yes' if you want DRBD resource $resource to become primary" )"
usr/share/rear/restore/BORG/default/300_load_archives.sh:    choice="$( UserInput -I BORGBACKUP_ARCHIVE_TO_RECOVER -p "Choose archive to recover from" )"
usr/share/rear/restore/NBKDC/default/400_restore_backup.sh:    if is_true "$( UserInput -I NBKDC_WAIT_UNTIL_RESTORE_SUCCEEDED -t 0 -p "$user_input_prompt" )" ; then
usr/share/rear/verify/CDM/default/410_use_replica_cdm_cluster_cert.sh:    CDM_CLUSTER_IP="$( UserInput -I CDM_CLUSTER_IP -r -t 0 -p "$prompt" )"
usr/share/rear/verify/CDM/default/410_use_replica_cdm_cluster_cert.sh:            CDM_AGENT_URL="$( UserInput -I CDM_AGENT_URL -r -t 0 -p "$prompt" )"
usr/share/rear/verify/GALAXY10/default/550_request_point_in_time_restore_parameters.sh:    answer=$( UserInput -I GALAXY10_RESTORE_PIT -r -p "Enter date/time (MM/DD/YYYY HH:mm:ss) or press ENTER" )
usr/share/rear/verify/GALAXY11/default/500_select_backupset.sh: GALAXY11_BACKUPSET=$( UserInput -I GALAXY11_BACKUPSET -p "Select CommVault backupset to use:" "${backupsets[@]}" )
usr/share/rear/verify/NBU/default/390_request_point_in_time_restore_parameters.sh:    answer=$( UserInput -I NBU_RESTORE_PIT -r -p "Enter date (mm/dd/yyyy) or date and time (mm/dd/yyyy HH:MM:SS) or press ENTER" )
usr/share/rear/verify/NSR/default/390_request_point_in_time_restore_parameters.sh:            answer=$( UserInput -I NSR_RESTORE_PIT -r -p "Enter date (mm/dd/yyyy) or date and time (mm/dd/yyyy HH:MM:SS) or press ENTER" )
</code></pre>
<p>I'll have a look at those and add defaults where possible.</p>
<h4 id="schlomo_commented_at_2023-05-14_1515"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/2979#issuecomment-1546922558">2023-05-14 15:15</a>:<a class="headerlink" href="#schlomo_commented_at_2023-05-14_1515" title="Permanent link">&para;</a></h4>
<blockquote>
<p>There are some code places left where 'read' or 'select'<br />
is called directly to get user input, for example<br />
in the ReaR recovery system startup scripts like 'select' in<br />
<a href="https://github.com/rear/rear/blob/master/usr/share/rear/skel/default/etc/scripts/system-setup.d/55-migrate-network-devices.sh">https://github.com/rear/rear/blob/master/usr/share/rear/skel/default/etc/scripts/system-setup.d/55-migrate-network-devices.sh</a></p>
</blockquote>
<p>@jsmeix I just realized: Not an issue as the stuff in <code>skel</code> runs before
<code>rear recover</code> starts, while <code>--non-interactice</code> only works <em>within</em>
<code>rear</code> itself.</p>
<h4 id="schlomo_commented_at_2023-05-14_1532"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/pull/2979#issuecomment-1546925804">2023-05-14 15:32</a>:<a class="headerlink" href="#schlomo_commented_at_2023-05-14_1532" title="Permanent link">&para;</a></h4>
<p>This PR is superseded by #2988</p>
<h4 id="jsmeix_commented_at_2023-05-15_0614"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2979#issuecomment-1547248606">2023-05-15 06:14</a>:<a class="headerlink" href="#jsmeix_commented_at_2023-05-15_0614" title="Permanent link">&para;</a></h4>
<p>@schlomo<br />
regarding your<br />
<a href="https://github.com/rear/rear/pull/2979#issuecomment-1546922558">https://github.com/rear/rear/pull/2979#issuecomment-1546922558</a></p>
<p>I think you may have misunderstood.</p>
<p>I think in general a non-interactive / unattended mode for ReaR<br />
is meant to let ReaR either continue or abort automatically<br />
whenever user input is needed.</p>
<p>But in general when 'read' or 'select' is called directly<br />
to get user input the current implementation of those calls<br />
may not yet automatically continue or abort.</p>
<p>Off the top of my head I know at least about<br />
<a href="https://github.com/rear/rear/commit/dd0c7111c76f48c21e53f5184ede6aa5f07d6865">https://github.com/rear/rear/commit/dd0c7111c76f48c21e53f5184ede6aa5f07d6865</a><br />
so that at this code place it currently continues<br />
automatically only when there is only one choice<br />
<a href="https://github.com/rear/rear/blob/master/usr/share/rear/skel/default/etc/scripts/system-setup.d/55-migrate-network-devices.sh#L145">https://github.com/rear/rear/blob/master/usr/share/rear/skel/default/etc/scripts/system-setup.d/55-migrate-network-devices.sh#L145</a><br />
but when there is more than a single choice it calls 'select'<br />
<a href="https://github.com/rear/rear/blob/master/usr/share/rear/skel/default/etc/scripts/system-setup.d/55-migrate-network-devices.sh#L177">https://github.com/rear/rear/blob/master/usr/share/rear/skel/default/etc/scripts/system-setup.d/55-migrate-network-devices.sh#L177</a><br />
which waits endlessly for an input, cf.<br />
<a href="https://github.com/rear/rear/issues/1366">https://github.com/rear/rear/issues/1366</a></p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2024 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2023-05-04.2979.pr.closed.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/rear/rear-user-guide" class="fa fa-code-fork" style="color: #fcfcfc"> rear/rear-user-guide</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
