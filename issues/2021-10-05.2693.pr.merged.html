<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#2693 PR merged: Overhauled automapping in 300_map_disks.sh - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#2693 PR merged: Overhauled automapping in 300_map_disks.sh";
        var mkdocs_page_input_path = "issues/2021-10-05.2693.pr.merged.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/backup_netfs.html">Example of BACKUP=NETFS</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/netfs_nas.html">Internal Backup with tar to NFS server</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/rbme.html">External Backup using RBME</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../development/squash-git-log-commments.html">How to squash git log comments into one line</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear29.html">Release Notes ReaR 2.9</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear28.html">Release Notes ReaR 2.8</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#2693 PR merged: Overhauled automapping in 300_map_disks.sh</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="2693_pr_merged_overhauled_automapping_in_300_map_diskssh"><a href="https://github.com/rear/rear/pull/2693">#2693 PR</a> <code>merged</code>: Overhauled automapping in 300_map_disks.sh<a class="headerlink" href="#2693_pr_merged_overhauled_automapping_in_300_map_diskssh" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>enhancement</code>, <code>fixed / solved / done</code>, <code>minor bug</code></p>
<h4 id="jsmeix_opened_issue_at_2021-10-05_1519"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> opened issue at <a href="https://github.com/rear/rear/pull/2693">2021-10-05 15:19</a>:<a class="headerlink" href="#jsmeix_opened_issue_at_2021-10-05_1519" title="Permanent link">&para;</a></h4>
<ul>
<li>
<p>Type: <strong>Enhancement</strong></p>
</li>
<li>
<p>Impact: <strong>Normal</strong></p>
</li>
<li>
<p>Reference to related issue (URL):<br />
<a href="https://github.com/rear/rear/issues/2690">https://github.com/rear/rear/issues/2690</a></p>
</li>
<li>
<p>How was this pull request tested?<br />
    "rear mkbackup" and "rear recover"<br />
    on two KVM test systems with 4 disks</p>
</li>
</ul>
<!-- -->

<pre><code>original system   replacement system
sda 2.1 GiB       sda 2.2 GiB
sdb 2.4 GiB       sdb 2.1 GiB
sdc 2.3 GiB       sdc 2.4 GiB
sdd 2.2 GiB       sdd 2.3 GiB
</code></pre>
<p>"rear -D recover" terminal output (excerpt)</p>
<pre><code>Comparing disks
Device sda has size 2362232832 bytes but 2254858240 bytes is expected (needs manual configuration)
Device sdb has size 2254858240 bytes but 2576980992 bytes is expected (needs manual configuration)
Device sdc has size 2576980992 bytes but 2469606400 bytes is expected (needs manual configuration)
Device sdd has size 2469606400 bytes but 2362232832 bytes is expected (needs manual configuration)
Switching to manual disk layout configuration
Using /dev/sdb (same size) for recreating /dev/sda
Using /dev/sdc (same size) for recreating /dev/sdb
Using /dev/sdd (same size) for recreating /dev/sdc
Using /dev/sda (same size) for recreating /dev/sdd
Current disk mapping table (source =&gt; target):
  /dev/sda =&gt; /dev/sdb
  /dev/sdb =&gt; /dev/sdc
  /dev/sdc =&gt; /dev/sdd
  /dev/sdd =&gt; /dev/sda

UserInput -I LAYOUT_MIGRATION_CONFIRM_MAPPINGS needed in /usr/share/rear/layout/prepare/default/300_map_disks.sh line 291
Confirm or edit the disk mapping
1) Confirm disk mapping and continue 'rear recover'
2) n/a
3) Edit disk mapping (/var/lib/rear/layout/disk_mappings)
4) Use Relax-and-Recover shell and return back to here
5) Abort 'rear recover'
</code></pre>
<ul>
<li>Brief description of the changes in this pull request:</li>
</ul>
<p>In layout/prepare/default/300_map_disks.sh overhauled the<br />
automapping of original 'disk' devices and 'multipath' devices<br />
to current block devices in the currently running recovery system<br />
so that now it automatically finds an existing unique disk size
mapping.<br />
For details see the comments in the code that should (hopefully)
explain<br />
what goes on.</p>
<h4 id="jsmeix_commented_at_2021-10-06_1246"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2693#issuecomment-936168972">2021-10-06 12:46</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-10-06_1246" title="Permanent link">&para;</a></h4>
<p>Another test with latest<br />
<a href="https://github.com/rear/rear/pull/2693/commits/62a99159bc90daa86155d4dacb7c6312ec51eac7">https://github.com/rear/rear/pull/2693/commits/62a99159bc90daa86155d4dacb7c6312ec51eac7</a></p>
<p>"rear mkbackup" and "rear recover"<br />
on two KVM test systems with 3 disks</p>
<pre><code>original system   replacement system
sda 3 GiB         sda 1 GiB
sdb 2 GiB         sdb 2 GiB
sdc 1 GiB         sdc 3 GiB
</code></pre>
<p>"rear -D recover" terminal output (excerpt)</p>
<pre><code>Comparing disks
Device sda has size 1073741824 bytes but 3221225472 bytes is expected (needs manual configuration)
Device sdb has expected (same) size 2147483648 bytes (will be used for 'recover')
Device sdc has size 3221225472 bytes but 1073741824 bytes is expected (needs manual configuration)
Switching to manual disk layout configuration
Using /dev/sdc (same size 3221225472) for recreating /dev/sda
Using /dev/sdb (same name and same size 2147483648) for recreating /dev/sdb
Using /dev/sda (same size 1073741824) for recreating /dev/sdc
Current disk mapping table (source =&gt; target):
  /dev/sda =&gt; /dev/sdc
  /dev/sdb =&gt; /dev/sdb
  /dev/sdc =&gt; /dev/sda

UserInput -I LAYOUT_MIGRATION_CONFIRM_MAPPINGS needed in /usr/share/rear/layout/prepare/default/300_map_disks.sh line 291
Confirm or edit the disk mapping
1) Confirm disk mapping and continue 'rear recover'
2) n/a
3) Edit disk mapping (/var/lib/rear/layout/disk_mappings)
4) Use Relax-and-Recover shell and return back to here
5) Abort 'rear recover'
</code></pre>
<h4 id="gdha_commented_at_2021-10-06_1328"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/pull/2693#issuecomment-936236246">2021-10-06 13:28</a>:<a class="headerlink" href="#gdha_commented_at_2021-10-06_1328" title="Permanent link">&para;</a></h4>
<p>@jsmeix please also make a test with disk sizes completely different -
not the same as the originals. What will happen then?</p>
<h4 id="jsmeix_commented_at_2021-10-07_1123"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2693#issuecomment-937700504">2021-10-07 11:23</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-10-07_1123" title="Permanent link">&para;</a></h4>
<p>One more test with<br />
"rear mkbackup" and "rear recover"<br />
on two KVM test systems with 3 disks</p>
<pre><code>original system   replacement system
sda 3 GiB         sda 1 GiB
sdb 2 GiB         sdb 4 GiB
sdc 1 GiB         sdc 3 GiB
</code></pre>
<p>"rear -D recover" terminal output (excerpt)</p>
<pre><code>Comparing disks
Device sda has size 1073741824 bytes but 3221225472 bytes is expected (needs manual configuration)
Device sdb has size 4294967296 bytes but 2147483648 bytes is expected (needs manual configuration)
Device sdc has size 3221225472 bytes but 1073741824 bytes is expected (needs manual configuration)
Switching to manual disk layout configuration
Using /dev/sdc (same size 3221225472) for recreating /dev/sda
Could not automap /dev/sdb (no disk with same size 2147483648 found)
Using /dev/sda (same size 1073741824) for recreating /dev/sdc
Original disk /dev/sdb does not exist (with same size) in the target system
Using /dev/sdb (the only appropriate) for recreating /dev/sdb
Current disk mapping table (source =&gt; target):
  /dev/sda =&gt; /dev/sdc
  /dev/sdc =&gt; /dev/sda
  /dev/sdb =&gt; /dev/sdb

UserInput -I LAYOUT_MIGRATION_CONFIRM_MAPPINGS needed in /usr/share/rear/layout/prepare/default/300_map_disks.sh line 291
Confirm or edit the disk mapping
1) Confirm disk mapping and continue 'rear recover'
2) n/a
3) Edit disk mapping (/var/lib/rear/layout/disk_mappings)
4) Use Relax-and-Recover shell and return back to here
5) Abort 'rear recover'

UserInput: No real user input (empty or only spaces) - using default input
UserInput: Valid choice number result 'Confirm disk mapping and continue 'rear recover''
User confirmed disk mapping
Disabling excluded components in /var/lib/rear/layout/disklayout.conf
Applied disk layout mappings to /var/lib/rear/layout/disklayout.conf
Applied disk layout mappings to /var/lib/rear/layout/config/df.txt
Applied disk layout mappings to /etc/rear/rescue.conf
Examining gpt disk /dev/sdc to automatically resize its last active partition
Skipping /dev/sdc (size of new disk same as size of old disk)
Examining gpt disk /dev/sdb to automatically resize its last active partition
Checking /dev/sdb1 if it is the last partition on /dev/sdb
Found 'rear-noname' partition /dev/sdb1 as last partition on /dev/sdb
Determining if last partition /dev/sdb1 is resizeable
Determining new size for last partition /dev/sdb1
Determining if last partition /dev/sdb1 actually needs to be increased or shrinked
New /dev/sdb is 2147483648 bytes bigger than old disk
Increasing last partition /dev/sdb1 up to end of disk (new disk at least 10% bigger)
Changed last partition /dev/sdb1 size from 2146418176 to 4292870144 bytes
Examining gpt disk /dev/sda to automatically resize its last active partition
Skipping /dev/sda (size of new disk same as size of old disk)
UserInput -I LAYOUT_FILE_CONFIRMATION needed in /usr/share/rear/layout/prepare/default/500_confirm_layout_file.sh line 26
Confirm or edit the disk layout file
1) Confirm disk layout and continue 'rear recover'
2) Edit disk layout (/var/lib/rear/layout/disklayout.conf)
3) View disk layout (/var/lib/rear/layout/disklayout.conf)
4) View original disk space usage (/var/lib/rear/layout/config/df.txt)
5) Use Relax-and-Recover shell and return back to here
6) Abort 'rear recover'
</code></pre>
<p>Regarding <code>Using ... (the only appropriate) for recreating ...</code><br />
see the comment in layout/prepare/default/300_map_disks.sh<br />
that explains why that automatism should be OK</p>
<pre><code># Automatically map when only one appropriate current block device
 is found where to it could be mapped.
# At the end the mapping file is shown and the user can edit it
 if he does not like an automated mapping:
</code></pre>
<h4 id="jsmeix_commented_at_2021-10-07_1136"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2693#issuecomment-937709089">2021-10-07 11:36</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-10-07_1136" title="Permanent link">&para;</a></h4>
<p>Next test with<br />
"rear mkbackup" and "rear recover"<br />
on two KVM test systems with 3 disks</p>
<pre><code>original system   replacement system
sda 3 GiB         sda 1 GiB
sdb 2 GiB         sdb 3 GiB
sdc 1 GiB         sdc 3 GiB
</code></pre>
<p>"rear -D recover" terminal output (excerpt)</p>
<pre><code>Comparing disks
Ambiguous possible target disks need manual configuration (more than one with same size found)
Switching to manual disk layout configuration
Using /dev/sdb (same size 3221225472) for recreating /dev/sda
Could not automap /dev/sdb (no disk with same size 2147483648 found)
Using /dev/sda (same size 1073741824) for recreating /dev/sdc
Original disk /dev/sdb does not exist (with same size) in the target system
Using /dev/sdc (the only appropriate) for recreating /dev/sdb
Current disk mapping table (source =&gt; target):
  /dev/sda =&gt; /dev/sdb
  /dev/sdc =&gt; /dev/sda
  /dev/sdb =&gt; /dev/sdc

UserInput -I LAYOUT_MIGRATION_CONFIRM_MAPPINGS needed in /usr/share/rear/layout/prepare/default/300_map_disks.sh line 291
Confirm or edit the disk mapping
1) Confirm disk mapping and continue 'rear recover'
2) n/a
3) Edit disk mapping (/var/lib/rear/layout/disk_mappings)
4) Use Relax-and-Recover shell and return back to here
5) Abort 'rear recover'
(default '1' timeout 300 seconds)

UserInput: No real user input (empty or only spaces) - using default input
UserInput: Valid choice number result 'Confirm disk mapping and continue 'rear recover''
User confirmed disk mapping
Disabling excluded components in /var/lib/rear/layout/disklayout.conf
Applied disk layout mappings to /var/lib/rear/layout/disklayout.conf
Applied disk layout mappings to /var/lib/rear/layout/config/df.txt
Applied disk layout mappings to /etc/rear/rescue.conf
Examining gpt disk /dev/sdb to automatically resize its last active partition
Skipping /dev/sdb (size of new disk same as size of old disk)
Examining gpt disk /dev/sdc to automatically resize its last active partition
Checking /dev/sdc1 if it is the last partition on /dev/sdc
Found 'rear-noname' partition /dev/sdc1 as last partition on /dev/sdc
Determining if last partition /dev/sdc1 is resizeable
Determining new size for last partition /dev/sdc1
Determining if last partition /dev/sdc1 actually needs to be increased or shrinked
New /dev/sdc is 1073741824 bytes bigger than old disk
Increasing last partition /dev/sdc1 up to end of disk (new disk at least 10% bigger)
Changed last partition /dev/sdc1 size from 2146418176 to 3219128320 bytes
Examining gpt disk /dev/sda to automatically resize its last active partition
Skipping /dev/sda (size of new disk same as size of old disk)
UserInput -I LAYOUT_FILE_CONFIRMATION needed in /usr/share/rear/layout/prepare/default/500_confirm_layout_file.sh line 26
Confirm or edit the disk layout file
1) Confirm disk layout and continue 'rear recover'
2) Edit disk layout (/var/lib/rear/layout/disklayout.conf)
3) View disk layout (/var/lib/rear/layout/disklayout.conf)
4) View original disk space usage (/var/lib/rear/layout/config/df.txt)
5) Use Relax-and-Recover shell and return back to here
6) Abort 'rear recover'
</code></pre>
<h4 id="jsmeix_commented_at_2021-10-07_1146"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2693#issuecomment-937715428">2021-10-07 11:46</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-10-07_1146" title="Permanent link">&para;</a></h4>
<p>Another test with<br />
"rear mkbackup" and "rear recover"<br />
on two KVM test systems with 3 disks</p>
<pre><code>original system   replacement system
sda 3 GiB         sda 3 GiB
sdb 2 GiB         sdb 3 GiB
sdc 1 GiB         sdc 3 GiB
</code></pre>
<p>"rear -D recover" terminal output (excerpt)</p>
<pre><code>Comparing disks
Ambiguous possible target disks need manual configuration (more than one with same size found)
Switching to manual disk layout configuration
Using /dev/sda (same name and same size 3221225472) for recreating /dev/sda
Could not automap /dev/sdb (no disk with same size 2147483648 found)
Could not automap /dev/sdc (no disk with same size 1073741824 found)
Original disk /dev/sdb does not exist (with same size) in the target system
UserInput -I LAYOUT_MIGRATION_REPLACEMENT_SDB needed in /usr/share/rear/layout/prepare/default/300_map_disks.sh line 254
Choose an appropriate replacement for /dev/sdb
1) /dev/sdb
2) /dev/sdc
3) Do not map /dev/sdb
4) Use Relax-and-Recover shell and return back to here
(default '1' timeout 300 seconds)
1
UserInput: Valid choice number result '/dev/sdb'
Using /dev/sdb (chosen by user) for recreating /dev/sdb
Original disk /dev/sdc does not exist (with same size) in the target system
Using /dev/sdc (the only appropriate) for recreating /dev/sdc
Current disk mapping table (source =&gt; target):
  /dev/sda =&gt; /dev/sda
  /dev/sdb =&gt; /dev/sdb
  /dev/sdc =&gt; /dev/sdc

UserInput -I LAYOUT_MIGRATION_CONFIRM_MAPPINGS needed in /usr/share/rear/layout/prepare/default/300_map_disks.sh line 291
Confirm or edit the disk mapping
1) Confirm disk mapping and continue 'rear recover'
2) Confirm identical disk mapping and proceed without manual configuration
3) Edit disk mapping (/var/lib/rear/layout/disk_mappings)
4) Use Relax-and-Recover shell and return back to here
5) Abort 'rear recover'
(default '1' timeout 300 seconds)

UserInput: No real user input (empty or only spaces) - using default input
UserInput: Valid choice number result 'Confirm disk mapping and continue 'rear recover''
User confirmed disk mapping
Disabling excluded components in /var/lib/rear/layout/disklayout.conf
Applied disk layout mappings to /var/lib/rear/layout/disklayout.conf
Applied disk layout mappings to /var/lib/rear/layout/config/df.txt
Applied disk layout mappings to /etc/rear/rescue.conf
Examining gpt disk /dev/sda to automatically resize its last active partition
Skipping /dev/sda (size of new disk same as size of old disk)
Examining gpt disk /dev/sdb to automatically resize its last active partition
Checking /dev/sdb1 if it is the last partition on /dev/sdb
Found 'rear-noname' partition /dev/sdb1 as last partition on /dev/sdb
Determining if last partition /dev/sdb1 is resizeable
Determining new size for last partition /dev/sdb1
Determining if last partition /dev/sdb1 actually needs to be increased or shrinked
New /dev/sdb is 1073741824 bytes bigger than old disk
Increasing last partition /dev/sdb1 up to end of disk (new disk at least 10% bigger)
Changed last partition /dev/sdb1 size from 2146418176 to 3219128320 bytes
Examining gpt disk /dev/sdc to automatically resize its last active partition
Checking /dev/sdc1 if it is the last partition on /dev/sdc
Found 'rear-noname' partition /dev/sdc1 as last partition on /dev/sdc
Determining if last partition /dev/sdc1 is resizeable
Determining new size for last partition /dev/sdc1
Determining if last partition /dev/sdc1 actually needs to be increased or shrinked
New /dev/sdc is 2147483648 bytes bigger than old disk
Increasing last partition /dev/sdc1 up to end of disk (new disk at least 10% bigger)
Changed last partition /dev/sdc1 size from 1072676352 to 3219128320 bytes
UserInput -I LAYOUT_FILE_CONFIRMATION needed in /usr/share/rear/layout/prepare/default/500_confirm_layout_file.sh line 26
Confirm or edit the disk layout file
1) Confirm disk layout and continue 'rear recover'
2) Edit disk layout (/var/lib/rear/layout/disklayout.conf)
3) View disk layout (/var/lib/rear/layout/disklayout.conf)
4) View original disk space usage (/var/lib/rear/layout/config/df.txt)
5) Use Relax-and-Recover shell and return back to here
6) Abort 'rear recover'
</code></pre>
<h4 id="jsmeix_commented_at_2021-10-07_1156"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2693#issuecomment-937721748">2021-10-07 11:56</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-10-07_1156" title="Permanent link">&para;</a></h4>
<p>One more test with<br />
"rear mkbackup" and "rear recover"<br />
on two KVM test systems with 3 disks</p>
<pre><code>original system   replacement system
sda 3 GiB         sda 4 GiB
sdb 2 GiB         sdb 4 GiB
sdc 1 GiB         sdc 4 GiB
</code></pre>
<p>"rear -D recover" terminal output (excerpt)</p>
<pre><code>Comparing disks
Device sda has size 4294967296 bytes but 3221225472 bytes is expected (needs manual configuration)
Device sdb has size 4294967296 bytes but 2147483648 bytes is expected (needs manual configuration)
Device sdc has size 4294967296 bytes but 1073741824 bytes is expected (needs manual configuration)
Switching to manual disk layout configuration
Could not automap /dev/sda (no disk with same size 3221225472 found)
Could not automap /dev/sdb (no disk with same size 2147483648 found)
Could not automap /dev/sdc (no disk with same size 1073741824 found)
Original disk /dev/sda does not exist (with same size) in the target system
UserInput -I LAYOUT_MIGRATION_REPLACEMENT_SDA needed in /usr/share/rear/layout/prepare/default/300_map_disks.sh line 254
Choose an appropriate replacement for /dev/sda
1) /dev/sda
2) /dev/sdb
3) /dev/sdc
4) Do not map /dev/sda
5) Use Relax-and-Recover shell and return back to here
(default '1' timeout 300 seconds)
1
UserInput: Valid choice number result '/dev/sda'
Using /dev/sda (chosen by user) for recreating /dev/sda
Original disk /dev/sdb does not exist (with same size) in the target system
UserInput -I LAYOUT_MIGRATION_REPLACEMENT_SDB needed in /usr/share/rear/layout/prepare/default/300_map_disks.sh line 254
Choose an appropriate replacement for /dev/sdb
1) /dev/sdb
2) /dev/sdc
3) Do not map /dev/sdb
4) Use Relax-and-Recover shell and return back to here
(default '1' timeout 300 seconds)
1
UserInput: Valid choice number result '/dev/sdb'
Using /dev/sdb (chosen by user) for recreating /dev/sdb
Original disk /dev/sdc does not exist (with same size) in the target system
Using /dev/sdc (the only appropriate) for recreating /dev/sdc
Current disk mapping table (source =&gt; target):
  /dev/sda =&gt; /dev/sda
  /dev/sdb =&gt; /dev/sdb
  /dev/sdc =&gt; /dev/sdc

UserInput -I LAYOUT_MIGRATION_CONFIRM_MAPPINGS needed in /usr/share/rear/layout/prepare/default/300_map_disks.sh line 291
Confirm or edit the disk mapping
1) Confirm disk mapping and continue 'rear recover'
2) Confirm identical disk mapping and proceed without manual configuration
3) Edit disk mapping (/var/lib/rear/layout/disk_mappings)
4) Use Relax-and-Recover shell and return back to here
5) Abort 'rear recover'
(default '1' timeout 300 seconds)

UserInput: No real user input (empty or only spaces) - using default input
UserInput: Valid choice number result 'Confirm disk mapping and continue 'rear recover''
User confirmed disk mapping
Disabling excluded components in /var/lib/rear/layout/disklayout.conf
Applied disk layout mappings to /var/lib/rear/layout/disklayout.conf
Applied disk layout mappings to /var/lib/rear/layout/config/df.txt
Applied disk layout mappings to /etc/rear/rescue.conf
Examining gpt disk /dev/sda to automatically resize its last active partition
Checking /dev/sda1 if it is the last partition on /dev/sda
Checking /dev/sda2 if it is the last partition on /dev/sda
Found 'rear-noname' partition /dev/sda2 as last partition on /dev/sda
Determining if last partition /dev/sda2 is resizeable
Last partition /dev/sda2 not resizeable (used during boot)
Determining new size for last partition /dev/sda2
Determining if last partition /dev/sda2 actually needs to be increased or shrinked
New /dev/sda is 1073741824 bytes bigger than old disk
Skip increasing last partition /dev/sda2 (not resizeable)
Examining gpt disk /dev/sdb to automatically resize its last active partition
Checking /dev/sdb1 if it is the last partition on /dev/sdb
Found 'rear-noname' partition /dev/sdb1 as last partition on /dev/sdb
Determining if last partition /dev/sdb1 is resizeable
Determining new size for last partition /dev/sdb1
Determining if last partition /dev/sdb1 actually needs to be increased or shrinked
New /dev/sdb is 2147483648 bytes bigger than old disk
Increasing last partition /dev/sdb1 up to end of disk (new disk at least 10% bigger)
Changed last partition /dev/sdb1 size from 2146418176 to 4292870144 bytes
Examining gpt disk /dev/sdc to automatically resize its last active partition
Checking /dev/sdc1 if it is the last partition on /dev/sdc
Found 'rear-noname' partition /dev/sdc1 as last partition on /dev/sdc
Determining if last partition /dev/sdc1 is resizeable
Determining new size for last partition /dev/sdc1
Determining if last partition /dev/sdc1 actually needs to be increased or shrinked
New /dev/sdc is 3221225472 bytes bigger than old disk
Increasing last partition /dev/sdc1 up to end of disk (new disk at least 10% bigger)
Changed last partition /dev/sdc1 size from 1072676352 to 4292870144 bytes
UserInput -I LAYOUT_FILE_CONFIRMATION needed in /usr/share/rear/layout/prepare/default/500_confirm_layout_file.sh line 26
Confirm or edit the disk layout file
1) Confirm disk layout and continue 'rear recover'
2) Edit disk layout (/var/lib/rear/layout/disklayout.conf)
3) View disk layout (/var/lib/rear/layout/disklayout.conf)
4) View original disk space usage (/var/lib/rear/layout/config/df.txt)
5) Use Relax-and-Recover shell and return back to here
6) Abort 'rear recover'
</code></pre>
<h4 id="jsmeix_commented_at_2021-10-07_1308"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2693#issuecomment-937775436">2021-10-07 13:08</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-10-07_1308" title="Permanent link">&para;</a></h4>
<p>@gdha<br />
see my above tests - all looks well to me.<br />
Please check whether or not it also looks OK to you.<br />
Do you like to see some more other tests?</p>
<h4 id="pcahyna_commented_at_2021-10-07_1335"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/2693#issuecomment-937799291">2021-10-07 13:35</a>:<a class="headerlink" href="#pcahyna_commented_at_2021-10-07_1335" title="Permanent link">&para;</a></h4>
<p>@jsmeix I will have a look at the change, but it will take me a bit of
time because I am not familiar with this particular code (yet).</p>
<h4 id="jsmeix_commented_at_2021-10-07_1340"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2693#issuecomment-937803713">2021-10-07 13:40</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-10-07_1340" title="Permanent link">&para;</a></h4>
<p>@pcahyna<br />
thank you for having a look!</p>
<h4 id="jsmeix_commented_at_2021-10-13_1244"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2693#issuecomment-942266234">2021-10-13 12:44</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-10-13_1244" title="Permanent link">&para;</a></h4>
<p>@pcahyna<br />
do you soon have time to have a look?</p>
<p>@gdha<br />
are my tests sufficient for you?</p>
<p>I ask because I would like to merge it if there are no objections.</p>
<p>The changes improve things for me and also for a SUSE customer<br />
so the changes should be at least an improvement for MIGRATION_MODE.</p>
<p>Of course this does not mean current MIGRATION_MODE "just works", cf.<br />
<a href="https://github.com/rear/rear/issues/2696">https://github.com/rear/rear/issues/2696</a></p>
<h4 id="pcahyna_commented_at_2021-10-13_1542"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/2693#issuecomment-942433809">2021-10-13 15:42</a>:<a class="headerlink" href="#pcahyna_commented_at_2021-10-13_1542" title="Permanent link">&para;</a></h4>
<blockquote>
<p>@pcahyna do you soon have time to have a look?</p>
</blockquote>
<p>sure, looking at it now.</p>
<h4 id="gdha_commented_at_2021-10-14_1156"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/pull/2693#issuecomment-943285335">2021-10-14 11:56</a>:<a class="headerlink" href="#gdha_commented_at_2021-10-14_1156" title="Permanent link">&para;</a></h4>
<p>@jsmeix tests are fine to me - ok to merge the PR</p>
<h4 id="jsmeix_commented_at_2021-10-14_1308"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2693#issuecomment-943339565">2021-10-14 13:08</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-10-14_1308" title="Permanent link">&para;</a></h4>
<p>@gdha @pcahyna<br />
thank you for your reviews.</p>
<p>I will merge it tomorrow afternoon<br />
provided no objections appear until then.</p>
<h4 id="jsmeix_commented_at_2021-10-15_1028"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2693#issuecomment-944190272">2021-10-15 10:28</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-10-15_1028" title="Permanent link">&para;</a></h4>
<p>Test with two disks according to<br />
<a href="https://github.com/rear/rear/issues/2690#issuecomment-942548003">https://github.com/rear/rear/issues/2690#issuecomment-942548003</a></p>
<pre><code>original system  replacement system
sda 7 GiB        sda 2 GiB
sdb 2 GiB        sdb 7 GiB
</code></pre>
<p>This works with master code (i.e. without the changes in this pull
request)</p>
<pre><code># rear -D recover
...
Comparing disks
Device sda has size 2147483648 bytes but 7516192768 bytes is expected (needs manual configuration)
Device sdb has size 7516192768 bytes but 2147483648 bytes is expected (needs manual configuration)
Switching to manual disk layout configuration
Using /dev/sdb (same size) for recreating /dev/sda
Original disk /dev/sdb does not exist (with same size) in the target system
Using /dev/sda (the only appropriate) for recreating /dev/sdb
Current disk mapping table (source =&gt; target):
  /dev/sda =&gt; /dev/sdb
  /dev/sdb =&gt; /dev/sda

UserInput -I LAYOUT_MIGRATION_CONFIRM_MAPPINGS needed in /usr/share/rear/layout/prepare/default/300_map_disks.sh line 275
Confirm or edit the disk mapping
1) Confirm disk mapping and continue 'rear recover'
2) n/a
3) Edit disk mapping (/var/lib/rear/layout/disk_mappings)
4) Use Relax-and-Recover shell and return back to here
5) Abort 'rear recover'
(default '1' timeout 300 seconds)
</code></pre>
<p>This also explains why the current code in 300_map_disks.sh is as
is.<br />
Very likely I had only tested it with two disks.</p>
<p>How that works with the changes in this pull request:</p>
<pre><code># rear -D recover
...
Comparing disks
Device sda has size 2147483648 bytes but 7516192768 bytes is expected (needs manual configuration)
Device sdb has size 7516192768 bytes but 2147483648 bytes is expected (needs manual configuration)
Switching to manual disk layout configuration
Using /dev/sdb (same size 7516192768) for recreating /dev/sda
Using /dev/sda (same size 2147483648) for recreating /dev/sdb
Current disk mapping table (source =&gt; target):
  /dev/sda =&gt; /dev/sdb
  /dev/sdb =&gt; /dev/sda

UserInput -I LAYOUT_MIGRATION_CONFIRM_MAPPINGS needed in /usr/share/rear/layout/prepare/default/300_map_disks.sh line 291
Confirm or edit the disk mapping
1) Confirm disk mapping and continue 'rear recover'
2) n/a
3) Edit disk mapping (/var/lib/rear/layout/disk_mappings)
4) Use Relax-and-Recover shell and return back to here
5) Abort 'rear recover'
(default '1' timeout 300 seconds)
</code></pre>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2025 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2021-10-05.2693.pr.merged.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/rear/rear-user-guide" class="fa fa-code-fork" style="color: #fcfcfc"> rear/rear-user-guide</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
