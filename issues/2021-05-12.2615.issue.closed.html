<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#2615 Issue closed: Regression: Opal PBA shuts down because of incomplete kernel modules related to MODULES=( 'loaded_modules' ) on Ubuntu 20.04.2 - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#2615 Issue closed: Regression: Opal PBA shuts down because of incomplete kernel modules related to MODULES=( \u0027loaded_modules\u0027 ) on Ubuntu 20.04.2";
        var mkdocs_page_input_path = "issues/2021-05-12.2615.issue.closed.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/backup_netfs.html">Example of BACKUP=NETFS</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/netfs_nas.html">Internal Backup with tar to NFS server</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/netfs_rsync.html">Internal Backup with rsync to NFS server</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/rbme.html">External Backup using RBME</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/restic.html">External Backup using restic</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../development/squash-git-log-commments.html">How to squash git log comments into one line</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear29.html">Release Notes ReaR 2.9</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear28.html">Release Notes ReaR 2.8</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#2615 Issue closed: Regression: Opal PBA shuts down because of incomplete kernel modules related to MODULES=( 'loaded_modules' ) on Ubuntu 20.04.2</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="2615_issue_closed_regression_opal_pba_shuts_down_because_of_incomplete_kernel_modules_related_to_modules_loaded_modules_on_ubuntu_20042"><a href="https://github.com/rear/rear/issues/2615">#2615 Issue</a> <code>closed</code>: Regression: Opal PBA shuts down because of incomplete kernel modules related to MODULES=( 'loaded_modules' ) on Ubuntu 20.04.2<a class="headerlink" href="#2615_issue_closed_regression_opal_pba_shuts_down_because_of_incomplete_kernel_modules_related_to_modules_loaded_modules_on_ubuntu_20042" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>support / question</code>, <code>fixed / solved / done</code></p>
<h4 id="tolga9009_opened_issue_at_2021-05-12_0525"><img src="https://avatars.githubusercontent.com/u/6173663?v=4" width="50"><a href="https://github.com/tolga9009">tolga9009</a> opened issue at <a href="https://github.com/rear/rear/issues/2615">2021-05-12 05:25</a>:<a class="headerlink" href="#tolga9009_opened_issue_at_2021-05-12_0525" title="Permanent link">&para;</a></h4>
<h4 id="relax-and-recover_rear_issue_template">Relax-and-Recover (ReaR) Issue Template<a class="headerlink" href="#relax-and-recover_rear_issue_template" title="Permanent link">&para;</a></h4>
<p>Fill in the following items before submitting a new issue<br />
(quick response is not guaranteed with free support):</p>
<ul>
<li>
<p>ReaR version ("/usr/sbin/rear -V"):<br />
    master branch c6500f9c42f1e68a5aaf36d556b144cbb8e69369</p>
</li>
<li>
<p>OS version ("cat /etc/os-release" or "lsb_release -a" or "cat
    /etc/rear/os.conf"):<br />
    Ubuntu 20.04.2 LTS</p>
</li>
<li>
<p>ReaR configuration files ("cat /etc/rear/site.conf" and/or "cat
    /etc/rear/local.conf"):<br />
<strong>/etc/rear/local.conf:</strong></p>
</li>
</ul>
<!-- -->

<pre><code>OUTPUT=RAWDISK
OUTPUT_URL="file:///var/lib/rear/output"
SECURE_BOOT_BOOTLOADER="/boot/efi/EFI/ubuntu/shimx64.efi"
</code></pre>
<ul>
<li>
<p>Hardware (PC or PowerNV BareMetal or ARM) or virtual machine (KVM
    guest or PoverVM LPAR):<br />
    Dell M3800 (Intel Core i7-4702HQ, Nvidia Quadro K1100M)</p>
</li>
<li>
<p>System architecture (x86 compatible or PPC64/PPC64LE or what exact
    ARM device):<br />
    x86</p>
</li>
<li>
<p>Firmware (BIOS or UEFI or Open Firmware) and bootloader (GRUB or
    ELILO or Petitboot):<br />
    UEFI, GRUB</p>
</li>
<li>
<p>Storage (local disk or SSD) and/or SAN (FC or iSCSI or FCoE) and/or
    multipath (DM or NVMe):<br />
    Samsung SSD 860 EVO (SATA)</p>
</li>
<li>
<p>Description of the issue (ideally so that others can reproduce it):</p>
</li>
<li>
<p>Fresh, up-to-date Ubuntu 20.04.2 LTS install</p>
</li>
<li>install build-essential, devscripts,...</li>
<li><code>git clone rear</code>, <code>make deb</code>, install it</li>
<li><code>sudo rear mkopalpba</code>, copy to USB stick</li>
<li>reboot PC</li>
<li>boot screen only shows Dell Logo (nothing else)</li>
<li>
<p>after approx. 15 seconds "Shutting down..." and Ubuntu Logo appears
    on the lower part of the screen.</p>
</li>
<li>
<p>Workaround, if any:<br />
    Issue happens in c6500f9c42f1e68a5aaf36d556b144cbb8e69369, but
    <code>git checkout rear-2.6</code> works fine. So, downgrading fixes it. Seems
    to be a regression, caused somewhere between
    10e049b76a4e7a19c90d34c65bd9ab8e05dd3083 and
    c6500f9c42f1e68a5aaf36d556b144cbb8e69369. If you have any ideas
    which commits might have caused it, please let me know. I can test
    it.</p>
</li>
</ul>
<p>Cheers,<br />
Tolga</p>
<h4 id="jsmeix_commented_at_2021-05-12_0647"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2615#issuecomment-839510351">2021-05-12 06:47</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-05-12_0647" title="Permanent link">&para;</a></h4>
<p>@tolga9009<br />
usually I use in a <code>git clone https://github.com/rear/rear.git</code>
directory<br />
a command like</p>
<pre><code>git log --format="%ae %H %ad%n%s :%n%b%n" --graph | fmt -w 120 -u -t | less
</code></pre>
<p>to get an overview of the commits.</p>
<p>In this case looking for Opal PBA related commit messages<br />
point to the following issues here:</p>
<p><a href="https://github.com/rear/rear/pull/2538">https://github.com/rear/rear/pull/2538</a></p>
<p><a href="https://github.com/rear/rear/pull/2507">https://github.com/rear/rear/pull/2507</a>
and<br />
<a href="https://github.com/rear/rear/issues/2474">https://github.com/rear/rear/issues/2474</a></p>
<p><a href="https://github.com/rear/rear/pull/2488">https://github.com/rear/rear/pull/2488</a>
and<br />
<a href="https://github.com/rear/rear/issues/2475">https://github.com/rear/rear/issues/2475</a></p>
<p><a href="https://github.com/rear/rear/pull/2455">https://github.com/rear/rear/pull/2455</a>
and<br />
<a href="https://github.com/rear/rear/pull/2426">https://github.com/rear/rear/pull/2426</a>
and<br />
<a href="https://github.com/rear/rear/issues/2425">https://github.com/rear/rear/issues/2425</a><br />
I guess this one could be most related because it is about<br />
<code>OPALPBA: Reboot after unlocking self-encrpyting disks may hang on some UEFI systems</code></p>
<p><a href="https://github.com/rear/rear/pull/2448">https://github.com/rear/rear/pull/2448</a>
and<br />
<a href="https://github.com/rear/rear/issues/2436">https://github.com/rear/rear/issues/2436</a></p>
<h4 id="olivero2_commented_at_2021-05-12_1058"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/issues/2615#issuecomment-839678939">2021-05-12 10:58</a>:<a class="headerlink" href="#olivero2_commented_at_2021-05-12_1058" title="Permanent link">&para;</a></h4>
<p>@tolga9009 Thank you for the detailed issue description and the research
you have done.</p>
<p>It looks like something is going wrong in the PBA's startup script
<code>usr/share/rear/skel/default/etc/scripts/unlock-opal-disks</code>. It seems to
terminate before asking you for a password. If have already looked at
the commits since the ReaR 2.6 release and found nothing obvious.</p>
<p>So I'd ask you to use the latest master branch version of ReaR and turn
on the lights for the PBA. I have prepared a small patch file:
<a href="https://github.com/rear/rear/files/6465683/PBA-shutdown-debug.patch.txt">PBA-shutdown-debug.patch.txt</a></p>
<p>Please try:</p>
<ol>
<li>Check out the ReaR master branch c6500f9</li>
<li>Copy
    <a href="https://github.com/rear/rear/files/6465683/PBA-shutdown-debug.patch.txt">PBA-shutdown-debug.patch.txt</a>
    into the <code>rear</code> project directory.</li>
<li>If necessary, run <code>apt-get install patch</code></li>
<li>In the <code>rear</code> project directory, run
    <code>patch -p1 &lt;PBA-shutdown-debug.patch.txt</code></li>
<li>Create the PBA.</li>
<li>Boot with the PBA.</li>
</ol>
<p>You should now see a system booting in text mode, giving us details
about the boot process. Finally, the system should display
<code>Entering emergency shell...</code> where it would previously say
<code>Shutting down...</code>. I would also expect an error message indicating the
cause of the problem.</p>
<h4 id="tolga9009_commented_at_2021-05-12_1232"><img src="https://avatars.githubusercontent.com/u/6173663?v=4" width="50"><a href="https://github.com/tolga9009">tolga9009</a> commented at <a href="https://github.com/rear/rear/issues/2615#issuecomment-839733297">2021-05-12 12:32</a>:<a class="headerlink" href="#tolga9009_commented_at_2021-05-12_1232" title="Permanent link">&para;</a></h4>
<p>Thank you for the fast replies and the patch!</p>
<p>I started with Oliver's suggestion, as I already had everything set up.
For some reason, after booting I was greeted with a black screen. Boot
process was like this:</p>
<ol>
<li>Push Power Button</li>
<li>Dell Logo</li>
<li>Press F12 for Boot Menu, pick PBA USB Boot device</li>
<li>Plain black screen, no text, no boot log</li>
</ol>
<p>I was able to reboot by pressing Ctrl+Alt+Del, so the system was still
responsive. Came up with the idea, that maybe the fonts were invisible
and blindly typed "poweroff". And bingo: 3 seconds later, my PC powered
off. So, additionally to the original bug, I seem to have invisible
fonts now. Didn't happen with <code>rear-2.6</code>, I had boot log there, so this
is a new bug aswell. Maybe the missing / invisible font is causing my
shutdown issue (e.g. password prompt silently fails due to not beeing
able to find font)?</p>
<p>//Update: I was able to unlock disks and enter functional shell with
commit 055e3a1074df63d8981d37cb4cd1cee1e4a3f62d, so no problem there. I
will try to bisect.</p>
<h4 id="olivero2_commented_at_2021-05-12_1258"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/issues/2615#issuecomment-839751599">2021-05-12 12:58</a>:<a class="headerlink" href="#olivero2_commented_at_2021-05-12_1258" title="Permanent link">&para;</a></h4>
<p>Thanks for the quick reply. If the screen stays completely blank, it
could be that the kernel could not initialize your Nvidia graphics card
properly. Maybe some required kernel module or configuration file is
missing in the PBA.</p>
<p>Could you add</p>
<pre><code>nomodeset i915.modeset=0 nouveau.modeset=0
</code></pre>
<p>to the <code>KERNEL_CMDLINE</code> setting in
<code>usr/share/rear/prep/OPALPBA/Linux-i386/001_configure_workflow.sh</code>,
recreate the PBA and try again?</p>
<p>If that doesn't help, maybe you could configure your firmware a.k.a.
BIOS to disable the Nvidia graphics card on boot?</p>
<h4 id="tolga9009_commented_at_2021-05-12_1304"><img src="https://avatars.githubusercontent.com/u/6173663?v=4" width="50"><a href="https://github.com/tolga9009">tolga9009</a> commented at <a href="https://github.com/rear/rear/issues/2615#issuecomment-839755361">2021-05-12 13:04</a>:<a class="headerlink" href="#tolga9009_commented_at_2021-05-12_1304" title="Permanent link">&para;</a></h4>
<p>I can try it out, but I don't think that's the case. When booting with
"quiet splash", I can see UEFI BGRT, Ubuntu Logo and the "Shutting
down..." message. I think if this was a GPU issue, I should have a black
screen instead, right?</p>
<h4 id="jsmeix_commented_at_2021-05-12_1311"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2615#issuecomment-839760873">2021-05-12 13:11</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-05-12_1311" title="Permanent link">&para;</a></h4>
<p>@tolga9009<br />
only a blind guess (I don't have anything like your hardware):<br />
I think it is not the font (because I assume things happen on 'console'
where no special font is used).<br />
I think it is that no output at all appears on your screen - for
whatever reason.<br />
I.e. the usual 'stdout' of normal programs does not appear on your
screen.<br />
I mean programs output normally on their 'stdout' but that gets not
shown on your screen.<br />
So as also @OliverO2 thinks the root cause is likely some low level
issue with screen output<br />
in general like Linux kernel graphics drivers or UEFI firmware stuff or
whatnot.<br />
In contrast input (i.e. the usual 'stdin' of normal programs) comes from
your keyboard<br />
which has nothing to do whether or not something is shown on your
screen.</p>
<h4 id="olivero2_commented_at_2021-05-12_1313"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/issues/2615#issuecomment-839762211">2021-05-12 13:13</a>:<a class="headerlink" href="#olivero2_commented_at_2021-05-12_1313" title="Permanent link">&para;</a></h4>
<p>@tolga9009 If the Ubuntu logo appears, your graphics should be
operational. The black screen might be caused by Ubuntu's <code>vt.handoff</code>,
which switches to a blank virtual console at boot and might now
interfere with the other changes. To disable it, comment out the line</p>
<pre><code>    OPAL_PBA_KERNEL_CMDLINE+=" $vt_handoff"
</code></pre>
<p>in <code>usr/share/rear/conf/Ubuntu.conf</code>, then recreate the PBA. Hope this
helps.</p>
<h4 id="tolga9009_commented_at_2021-05-12_1324"><img src="https://avatars.githubusercontent.com/u/6173663?v=4" width="50"><a href="https://github.com/tolga9009">tolga9009</a> commented at <a href="https://github.com/rear/rear/issues/2615#issuecomment-839770337">2021-05-12 13:24</a>:<a class="headerlink" href="#tolga9009_commented_at_2021-05-12_1324" title="Permanent link">&para;</a></h4>
<p>Thank you! I had console output now. There was an error message:<br />
<code>Failed to find module 'autofs4'</code></p>
<p>I also bisected until e7338e54426493d48b626f297f4d301fb759d10f. That was
the last OPAL related commit. No problems so far, I will bisect further.
I will now look for commits related to <code>autofs4</code>.</p>
<h4 id="jsmeix_commented_at_2021-05-12_1337"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2615#issuecomment-839779491">2021-05-12 13:37</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-05-12_1337" title="Permanent link">&para;</a></h4>
<p>@OliverO2<br />
thank you so much for your
<a href="https://github.com/rear/rear/issues/2615#issuecomment-839762211">https://github.com/rear/rear/issues/2615#issuecomment-839762211</a></p>
<p>Incredible what Ubuntu does:<br />
<a href="https://help.ubuntu.com/community/vt.handoff">https://help.ubuntu.com/community/vt.handoff</a><br />
reads (excerpt)</p>
<pre><code>vt.handoff (vt = virtualterminal) is a kernel boot parameter unique to Ubuntu,
and is not an upstream kernel boot parameter.
</code></pre>
<p>why do they think it benefits their users with such crazy deviations
from upstream?</p>
<h4 id="tolga9009_commented_at_2021-05-12_1347"><img src="https://avatars.githubusercontent.com/u/6173663?v=4" width="50"><a href="https://github.com/tolga9009">tolga9009</a> commented at <a href="https://github.com/rear/rear/issues/2615#issuecomment-839787069">2021-05-12 13:47</a>:<a class="headerlink" href="#tolga9009_commented_at_2021-05-12_1347" title="Permanent link">&para;</a></h4>
<p>@jsmeix I think the title isn't quite fitting. I have display output in
the default state. It shows the Dell and Ubuntu Logo, but continues to
shutdown, without asking me for a password. I'm unable to unlock my Opal
drives.</p>
<p>The black screen was caused by disabling quiet / splash for debugging.
But I prefer the PBA booting silent and with splash for deployment.</p>
<p>I bisected further. The regression happened somewhere between
3058973cc4b4ba204b0cf17cc48bb9721d9bc9e1 and
c38e61db066196c90e6118cab8887b76df58b20a.</p>
<h4 id="jsmeix_commented_at_2021-05-12_1352"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2615#issuecomment-839790505">2021-05-12 13:52</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-05-12_1352" title="Permanent link">&para;</a></h4>
<p>@tolga9009<br />
don't worry - I adapt the title as needed and as things move forward.<br />
I am not a Ubuntu user so I don't know about their special things.</p>
<h4 id="olivero2_commented_at_2021-05-12_1354"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/issues/2615#issuecomment-839792149">2021-05-12 13:54</a>:<a class="headerlink" href="#olivero2_commented_at_2021-05-12_1354" title="Permanent link">&para;</a></h4>
<p>Maybe it is the changes in
<code>usr/share/rear/build/GNU/Linux/400_copy_modules.sh</code> by d2588e8 and
6a0013a.</p>
<h4 id="jsmeix_commented_at_2021-05-12_1400"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2615#issuecomment-839796368">2021-05-12 14:00</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-05-12_1400" title="Permanent link">&para;</a></h4>
<p>@OliverO2<br />
those <code>MODULES</code> related changes should have no effect<br />
when the default <code>MODULES=( 'all_modules' )</code> is used<br />
for "rear mkrescue/mkbackup".<br />
But perhaps things are different in case of Opal PBA?</p>
<h4 id="olivero2_commented_at_2021-05-12_1402"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/issues/2615#issuecomment-839798544">2021-05-12 14:02</a>:<a class="headerlink" href="#olivero2_commented_at_2021-05-12_1402" title="Permanent link">&para;</a></h4>
<p>The PBA uses <code>MODULES=( 'loaded_modules' )</code>.</p>
<h4 id="jsmeix_commented_at_2021-05-12_1403"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2615#issuecomment-839799063">2021-05-12 14:03</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-05-12_1403" title="Permanent link">&para;</a></h4>
<p>Yes, I see it right now<br />
in prep/OPALPBA/Linux-i386/001_configure_workflow.sh</p>
<h4 id="tolga9009_commented_at_2021-05-12_1404"><img src="https://avatars.githubusercontent.com/u/6173663?v=4" width="50"><a href="https://github.com/tolga9009">tolga9009</a> commented at <a href="https://github.com/rear/rear/issues/2615#issuecomment-839799597">2021-05-12 14:04</a>:<a class="headerlink" href="#tolga9009_commented_at_2021-05-12_1404" title="Permanent link">&para;</a></h4>
<p>The regression starts to happen exactly at
54f6fea96f1f22e5c9506fe55e1cfc626e541d59. I've quickly read through the
code and it doesn't make sense to me. I will double check.</p>
<p>//Edit: double checked. It's the commit above what causes the issue.
cf0c39d9d3dd7c40b53f2a71fc9d9516022ab546 works as expected.</p>
<h4 id="jsmeix_commented_at_2021-05-12_1409"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2615#issuecomment-839803562">2021-05-12 14:09</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-05-12_1409" title="Permanent link">&para;</a></h4>
<p>The default behaviour of<br />
<a href="https://github.com/rear/rear/commit/54f6fea96f1f22e5c9506fe55e1cfc626e541d59">https://github.com/rear/rear/commit/54f6fea96f1f22e5c9506fe55e1cfc626e541d59</a><br />
is</p>
<pre><code>DISKS_TO_BE_WIPED='false'
...
is_false "$DISKS_TO_BE_WIPED" &amp;&amp; return 0
...
is_false "$DISKS_TO_BE_WIPED" &amp;&amp; return 0
</code></pre>
<p>so nothing should happen.</p>
<h4 id="olivero2_commented_at_2021-05-12_1414"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/issues/2615#issuecomment-839807930">2021-05-12 14:14</a>:<a class="headerlink" href="#olivero2_commented_at_2021-05-12_1414" title="Permanent link">&para;</a></h4>
<p>cf0c39d9 is on a merged branch, which is based on a much older version
of master.</p>
<h4 id="jsmeix_commented_at_2021-05-12_1425"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2615#issuecomment-839816603">2021-05-12 14:25</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-05-12_1425" title="Permanent link">&para;</a></h4>
<p>As far as I see cf0c39d9d3dd7c40b53f2a71fc9d9516022ab546<br />
was branched after 8f09ede7d617290e948dd779539d4da385d454e3<br />
so the root cause should be<br />
between 8f09ede7d617290e948dd779539d4da385d454e3<br />
and 54f6fea96f1f22e5c9506fe55e1cfc626e541d59</p>
<h4 id="jsmeix_commented_at_2021-05-12_1431"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2615#issuecomment-839821166">2021-05-12 14:31</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-05-12_1431" title="Permanent link">&para;</a></h4>
<p>The only Opal PBA related commit message in<br />
<code>git log --format="%ae %H %ad%n%s :%n%b%n" --graph</code><br />
between 54f6fea96f1f22e5c9506fe55e1cfc626e541d59<br />
and 8f09ede7d617290e948dd779539d4da385d454e3<br />
belongs to
<a href="https://github.com/rear/rear/pull/2538">https://github.com/rear/rear/pull/2538</a><br />
i.e. 6466012947e933ca3cb821cba225517fff2d961e</p>
<h4 id="tolga9009_commented_at_2021-05-12_1434"><img src="https://avatars.githubusercontent.com/u/6173663?v=4" width="50"><a href="https://github.com/tolga9009">tolga9009</a> commented at <a href="https://github.com/rear/rear/issues/2615#issuecomment-839823349">2021-05-12 14:34</a>:<a class="headerlink" href="#tolga9009_commented_at_2021-05-12_1434" title="Permanent link">&para;</a></h4>
<p>Sorry for the confusion.</p>
<p>I have checked out at c6500f9c42f1e68a5aaf36d556b144cbb8e69369, applied
Oliver's patch from
<a href="https://github.com/rear/rear/issues/2615#issuecomment-839678939">https://github.com/rear/rear/issues/2615#issuecomment-839678939</a>
and got a more verbose output now. I will try to find a way to get the
full log, but for now:</p>
<pre><code>Could not detect TCG Opal 2-compliant disks.

Entering emergency shell...
[...]
The following error occured when executing /etc/scripts/unlock-opal-disks:
modprobe: FATAL: Module mac_hid not found in directory /lib/modules/5.8.0-50-generic
modprobe: FATAL: Module usbhid not found in directory /lib/modules/5.8.0-50-generic
modprobe: FATAL: Module hid not found in directory /lib/modules/5.8.0-50-generic
modprobe: FATAL: Module usb_storage not found in directory /lib/modules/5.8.0-50-generic
Could not detect TCG Opal 2-compliant disks.
</code></pre>
<h4 id="jsmeix_commented_at_2021-05-12_1441"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2615#issuecomment-839828630">2021-05-12 14:41</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-05-12_1441" title="Permanent link">&para;</a></h4>
<p>By the way:<br />
Today is logical Friday for me<br />
because tomorrow is public holiday in Germany<br />
<a href="https://en.wikipedia.org/wiki/Feast_of_the_Ascension">https://en.wikipedia.org/wiki/Feast_of_the_Ascension</a><br />
and the day after tomorrow is vacation for me<br />
so I wish you all a relaxed and recovering weekend!</p>
<h4 id="tolga9009_commented_at_2021-05-12_1447"><img src="https://avatars.githubusercontent.com/u/6173663?v=4" width="50"><a href="https://github.com/tolga9009">tolga9009</a> commented at <a href="https://github.com/rear/rear/issues/2615#issuecomment-839833697">2021-05-12 14:47</a>:<a class="headerlink" href="#tolga9009_commented_at_2021-05-12_1447" title="Permanent link">&para;</a></h4>
<p>I'm from Germany aswell, wish you a great holiday and good weekend ;)!</p>
<p>//Edit: I checked out at 6466012947e933ca3cb821cba225517fff2d961e, it's
working.</p>
<h4 id="olivero2_commented_at_2021-05-12_1518"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/issues/2615#issuecomment-839858731">2021-05-12 15:18</a>:<a class="headerlink" href="#olivero2_commented_at_2021-05-12_1518" title="Permanent link">&para;</a></h4>
<p>Have a great extended weekend, too! I'll be watching this space even
then and I'm somewhat curious about what the cause might be. c38e61d
(reported to work correctly
<a href="https://github.com/rear/rear/issues/2615#issuecomment-839787069">here</a>)
is on a branch based on master 4b43f439. So the cause must be after
that.</p>
<p>I'd still try reverting the changes from d2588e8 and 6a0013a first as
these commits seem to be the ones most likely influencing the situation.
The problem is diagnosed by
<code>Could not detect TCG Opal 2-compliant disks</code> which means that
<code>sedutil-cli</code> could not detect compatible devices â€“ possibly due to a
missing kernel module. From the emergency shell of the above PBA, you
could try:</p>
<pre><code>sedutil-cli --scan
</code></pre>
<p>The normal output should be something like this:</p>
<pre><code># sedutil-cli --scan
Scanning for Opal compliant disks
/dev/sda    2  Samsung SSD 860 PRO 256GB                RVM01B6Q
No more disks present ending scan
</code></pre>
<h4 id="tolga9009_commented_at_2021-05-12_1528"><img src="https://avatars.githubusercontent.com/u/6173663?v=4" width="50"><a href="https://github.com/tolga9009">tolga9009</a> commented at <a href="https://github.com/rear/rear/issues/2615#issuecomment-839865968">2021-05-12 15:28</a>:<a class="headerlink" href="#tolga9009_commented_at_2021-05-12_1528" title="Permanent link">&para;</a></h4>
<p>Alright, I was able to find the culprit. Seems to be
4480cc00ad0b9a46bbde6f56ca392051b134f949. Just to double check:
9a6b9a109aa77afc6c96cf05bbd7988cf0310d61 works fine,
4480cc00ad0b9a46bbde6f56ca392051b134f949 does not.</p>
<p>I will try to revert it now, as you suggested.</p>
<p>//Edit: I've checked the command above</p>
<pre><code># sedutil-cli --scan
Scanning for Opal compliant disks
No more disks present ending scan
</code></pre>
<h4 id="olivero2_commented_at_2021-05-12_1537"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/issues/2615#issuecomment-839873501">2021-05-12 15:37</a>:<a class="headerlink" href="#olivero2_commented_at_2021-05-12_1537" title="Permanent link">&para;</a></h4>
<p>4480cc0 is a merge commit, merging just d2588e8c into master. So
d2588e8c must be the real cause.</p>
<h4 id="tolga9009_commented_at_2021-05-12_1546"><img src="https://avatars.githubusercontent.com/u/6173663?v=4" width="50"><a href="https://github.com/tolga9009">tolga9009</a> commented at <a href="https://github.com/rear/rear/issues/2615#issuecomment-839880255">2021-05-12 15:46</a>:<a class="headerlink" href="#tolga9009_commented_at_2021-05-12_1546" title="Permanent link">&para;</a></h4>
<p>Yes! Thank you very much! Checked out at
c6500f9c42f1e68a5aaf36d556b144cbb8e69369, reverted
d2588e8c05aebfcdb3ac5cf1be7732aac2d78eb2 and everything works again!</p>
<h4 id="olivero2_commented_at_2021-05-12_1551"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/issues/2615#issuecomment-839883724">2021-05-12 15:51</a>:<a class="headerlink" href="#olivero2_commented_at_2021-05-12_1551" title="Permanent link">&para;</a></h4>
<p>Thank you for reporting and all of your research. Enjoy your PBA,
finally! The issue will affect more parts of ReaR than just the PBA. It
seems like the configuration option <code>MODULES=( 'loaded_modules' )</code> no
longer works as expected.</p>
<p>@jsmeix Could you look at the changes from d2588e8 again as time
permits?</p>
<h4 id="olivero2_commented_at_2021-05-13_1308"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/issues/2615#issuecomment-840544930">2021-05-13 13:08</a>:<a class="headerlink" href="#olivero2_commented_at_2021-05-13_1308" title="Permanent link">&para;</a></h4>
<p>@tolga9009 @jsmeix Could you please adjust the title again so that it
matches what we know now?</p>
<p>Something like this would be more precise and help people find answers:</p>
<blockquote>
<p>[Regression] MODULES=( 'loaded_modules' ) is broken, making Opal
PBA shut down without password prompt</p>
</blockquote>
<p>Take-aways:</p>
<ul>
<li>
<p>The issue is not Dell- or Nvidia-specific.</p>
</li>
<li>
<p>Ubuntu's <code>vt.handoff</code> setting is working as expected. In ReaR, it is
    only used in the PBA to achieve a purely graphical boot without
    intermediate switching to text mode. It did only affect this issue
    as we needed to see early kernel messages before the immediate
    shutdown happens. Under normal circumstances, there would be enough
    time for pressing <code>ESC</code> to switch from the graphical (logo) screen
    to the text console with boot messages.</p>
</li>
<li>
<p>Note that PBA intentionally chooses to shutdown immediately in case
    of non-recoverable problems. This avoids unauthenticated root access
    to unattended systems. (Yes, the disk is locked, but you could still
    change firmware settings...)</p>
</li>
</ul>
<h4 id="jsmeix_commented_at_2021-05-18_1240"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2615#issuecomment-843136495">2021-05-18 12:40</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-05-18_1240" title="Permanent link">&para;</a></h4>
<p>I cannot reproduce it on my openSUSE Leap 15.2 system<br />
with "rear mkrescue" and <code>MODULES=( 'loaded_modules' )</code><br />
(I am not a Opal PBA user).</p>
<p>But it should not make a real difference compared to "rear mkopalpba"<br />
because both "rear -s mkrescue" and "rear -s mkopalpba" show<br />
that <code>build/GNU/Linux/400_copy_modules.sh</code> is sourced which is<br />
the script that copies kernel modules into the ReaR recovery system.</p>
<p>I get exactly the &lt;module_name&gt;.ko files in the recovery system<br />
(in
/tmp/rear.XXXX/rootfs/lib/modules/5.3.18-lp152.75-default/kernel/...)<br />
that match what <code>lsmod</code> shows.</p>
<p>The tricky part how to verify it is that <code>lsmod</code> shows module names only
with <code>_</code><br />
while the kernel module files can contain both <code>_</code> and <code>-</code><br />
e.g. <code>lsmod</code> shows <code>aes_x86_64</code> but its module file is<br />
<code>lib/modules/5.3.18-lp152.75-default/kernel/arch/x86/crypto/aes-x86_64.ko</code></p>
<h4 id="jsmeix_commented_at_2021-05-18_1244"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2615#issuecomment-843139274">2021-05-18 12:44</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-05-18_1244" title="Permanent link">&para;</a></h4>
<p>@tolga9009<br />
how you could check what you get in your recovery system with your use
case:</p>
<p>See the <code>KEEP_BUILD_DIR</code> description in
usr/share/rear/conf/default.conf<br />
When you run it in debug mode KEEP_BUILD_DIR=1 is set in
usr/sbin/rear<br />
I use basically always debugscript mode via <code>rear -D ...</code><br />
to get meaningful info in the log for debugging.</p>
<p>With current ReaR GitHub master code<br />
you get with <code>MODULES=( 'loaded_modules' )</code><br />
this line output on the terminal (when you run it at least in verbose
mode):</p>
<pre><code>Copying only currently loaded kernel modules (MODULES contains 'loaded_modules') and those in MODULES_LOAD
</code></pre>
<p>In the log check what happens after
<code>Copying only currently loaded kernel modules</code> appears there<br />
up to the lines starting with <code>loaded_modules_files='...</code><br />
that show which module files have been found.</p>
<h4 id="jsmeix_commented_at_2021-05-19_1059"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2615#issuecomment-843990980">2021-05-19 10:59</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-05-19_1059" title="Permanent link">&para;</a></h4>
<p>@tolga9009 @OliverO2<br />
because I am not a Opal PBA user (so I can only test "rear mkrescue"):</p>
<p>I would like to ask if you could verify (as time permits)<br />
that "rear mkopalpba" really does not make a difference<br />
compared to "rear mkrescue" with MODULES=( 'loaded_modules' )<br />
regarding what kernel modules get included in the ReaR recovery system.</p>
<p>@OliverO2<br />
or could I myself somehow run "rear mkopalpba" as a test<br />
as non Opal PBA user (I don't have a self-encrypting device).<br />
If yes what etc/rear/local.conf would be right for such a test?</p>
<h4 id="olivero2_commented_at_2021-05-19_1213"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/issues/2615#issuecomment-844044274">2021-05-19 12:13</a>:<a class="headerlink" href="#olivero2_commented_at_2021-05-19_1213" title="Permanent link">&para;</a></h4>
<p>@jsmeix Well, you can test an Opal PBA on a machine without
self-encrypting devices by setting <code>OPAL_PBA_DEBUG_DEVICE_COUNT=1</code> to
simulate one such device. However, the binary <code>sedutil-cli</code> must be
available in the <code>PATH</code> to build and test the Opal-related code.</p>
<p>As the issue apparently did not reproduce on your test installation, I
have this on my list and will try to reproduce it here. I should be able
to do so, as I have a system configuration available roughly matching
Tolga's one. I'll try to test it, hopefully no later than the end of
next week.</p>
<h4 id="jsmeix_commented_at_2021-05-19_1240"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2615#issuecomment-844065982">2021-05-19 12:40</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-05-19_1240" title="Permanent link">&para;</a></h4>
<p>I could run <code>rear -D mkopalpba</code> on my openSUSE Leap 15.2 system<br />
with only this etc/rear/locl.conf (only this single line):</p>
<pre><code>OUTPUT=RAWDISK
</code></pre>
<p>plus</p>
<pre><code># ln -s /usr/bin/true /usr/bin/sedutil-cli
</code></pre>
<p>but without setting <code>OPAL_PBA_DEBUG_DEVICE_COUNT=1</code><br />
(I did it before
<a href="https://github.com/rear/rear/issues/2615#issuecomment-844044274">https://github.com/rear/rear/issues/2615#issuecomment-844044274</a>).</p>
<p>I got all loaded modules in the ReaR recovery system<br />
except <code>kvm</code> and <code>kvm_intel</code> which is expected because<br />
prep/OPALPBA/Linux-i386/001_configure_workflow.sh<br />
contains</p>
<pre><code>local exclude_modules='kvm.*|nvidia.*|vbox.*'
</code></pre>
<p>So the issue is something specific on Ubuntu.</p>
<h4 id="jsmeix_commented_at_2021-05-19_1244"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2615#issuecomment-844069508">2021-05-19 12:44</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-05-19_1244" title="Permanent link">&para;</a></h4>
<p>By the way:<br />
I did some <code>rear -D mkopalpba</code> tests and for the first one<br />
those modules were missing in the ReaR recovery system:</p>
<pre><code>fat
kvm
kvm_intel
loop
nls_cp437
nls_iso8859_1
vfat
</code></pre>
<p>Apparently they were loaded while <code>rear -D mkopalpba</code> was running<br />
but after build/GNU/Linux/400_copy_modules.sh was run because<br />
I compared the <code>lsmod</code> output after <code>rear -D mkopalpba</code> was run<br />
with what modules there are in the ReaR recovery system.<br />
Subsequent tests of <code>rear -D mkopalpba</code> where those modules were already
loaded<br />
copied them also into the ReaR recovery system (except <code>kvm</code> and
<code>kvm_intel</code>).</p>
<h4 id="jsmeix_commented_at_2021-05-19_1253"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2615#issuecomment-844076557">2021-05-19 12:53</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-05-19_1253" title="Permanent link">&para;</a></h4>
<p>Regarding the modules listed in<br />
<a href="https://github.com/rear/rear/issues/2615#issuecomment-839823349">https://github.com/rear/rear/issues/2615#issuecomment-839823349</a></p>
<p>I have those loaded and in the ReaR recovery system:</p>
<pre><code>hid_generic
usbcore
usbhid
</code></pre>
<h4 id="olivero2_commented_at_2021-05-28_1156"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/issues/2615#issuecomment-850366646">2021-05-28 11:56</a>:<a class="headerlink" href="#olivero2_commented_at_2021-05-28_1156" title="Permanent link">&para;</a></h4>
<p>I have tried to reproduce the issue on Ubuntu 20.04.2 LTS Desktop with
rear c6500f9c (2021-05-11) vs. e7338e54 (2020-12-20). It did not happen
in either configuration. <code>rear mkopalpba</code> generated root file systems
with an identical set of modules for both versions, one of which
including commit d2588e8, the other excluding it. I was able to
successfully boot a fully working PBA created by ReaR c6500f9c
(including commit d2588e8).</p>
<p>So the current state of affairs is:</p>
<ul>
<li>We have the observation that under specific conditions, a ReaR image
    is created, which contains an incomplete kernel configuration, in
    this case affecting the PBA.</li>
<li>We do not know the specific conditions so far, in particular:<ul>
<li>We cannot say that it is just d2588e8 causing the problem.</li>
<li>We cannot say that the issue is related to Ubuntu 20.04.</li>
<li>We cannot say that the issue affects the PBA (or <code>RAWDISK</code>
    output) only.</li>
</ul>
</li>
</ul>
<p>I have created a small test script which checks for modules in the same
way commit d2588e8 does. A reference output for Ubuntu 20.04.2 is at
<a href="https://pastebin.com/P6kGSqbz">https://pastebin.com/P6kGSqbz</a>.</p>
<p>@tolga9009 maybe you could try this on your system to avoid the issue
reappearing with a new ReaR release:</p>
<pre><code>#!/bin/bash

KERNEL_VERSION="$( uname -r )"

function Error() {
    echo "$*" &gt;&amp;2
}

function modinfo_filename () {
    local module_name=$1
    local module_filename=""
    local alias_module_name=( $( modprobe -n -R $module_name 2&gt;/dev/null ) )
    test $alias_module_name &amp;&amp; module_name=$alias_module_name
    module_filename="$( modinfo -k $KERNEL_VERSION -F filename $module_name )"
    if ! test "$module_filename" ; then
        test "$KERNEL_VERSION" = "$( uname -r )" || Error "modinfo_filename failed because KERNEL_VERSION does not match 'uname -r'"
        module_filename="$( modinfo -F filename $module_name )"
    fi
    grep -q '(builtin)' &lt;&lt;&lt;"$module_filename" &amp;&amp; echo '' || readlink -e $module_filename
}

loaded_modules+=" $( lsmod | tail -n +2 | cut -d ' ' -f 1 )"
loaded_modules_files="$( for loaded_module in $loaded_modules ; do modinfo_filename $loaded_module || Error "$loaded_module loaded or to be loaded but no module file?" ; done | sort -u )"

printf "%s\n" "$loaded_modules_files"
</code></pre>
<p>Is the output relevantly different from that of
<a href="https://pastebin.com/P6kGSqbz">https://pastebin.com/P6kGSqbz</a>?</p>
<h4 id="jsmeix_commented_at_2021-05-28_1259"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2615#issuecomment-850401353">2021-05-28 12:59</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-05-28_1259" title="Permanent link">&para;</a></h4>
<p>@OliverO2<br />
WOW - thank you for your thorough and exhaustive analysis!</p>
<h4 id="jsmeix_commented_at_2021-05-28_1319"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2615#issuecomment-850414044">2021-05-28 13:19</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-05-28_1319" title="Permanent link">&para;</a></h4>
<p>@OliverO2 @tolga9009<br />
I wish you a relaxed and recovering weekend!</p>
<h4 id="olivero2_commented_at_2021-05-28_1359"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/issues/2615#issuecomment-850439268">2021-05-28 13:59</a>:<a class="headerlink" href="#olivero2_commented_at_2021-05-28_1359" title="Permanent link">&para;</a></h4>
<p>Thank you! Have an excellent weekend, too!</p>
<h4 id="github-actions_commented_at_2021-07-28_0214"><img src="https://avatars.githubusercontent.com/in/15368?v=4" width="50"><a href="https://github.com/apps/github-actions">github-actions</a> commented at <a href="https://github.com/rear/rear/issues/2615#issuecomment-887956555">2021-07-28 02:14</a>:<a class="headerlink" href="#github-actions_commented_at_2021-07-28_0214" title="Permanent link">&para;</a></h4>
<p>Stale issue message</p>
<h4 id="nolocimes_commented_at_2021-12-17_2206"><img src="https://avatars.githubusercontent.com/u/96318232?v=4" width="50"><a href="https://github.com/nolocimes">nolocimes</a> commented at <a href="https://github.com/rear/rear/issues/2615#issuecomment-997058554">2021-12-17 22:06</a>:<a class="headerlink" href="#nolocimes_commented_at_2021-12-17_2206" title="Permanent link">&para;</a></h4>
<p>I ran into this same issue on a new ubuntu 20.04.3 build.</p>
<p>This issue is related to the following line in 400_copy_modules.sh:<br />
grep -q '(builtin)' &lt;&lt;&lt;"$module_filename" &amp;&amp; echo '' ||
readlink -e $module_filename</p>
<p>On my system, readlink -e $module_filename resolves to /usr/lib/XXXX
instead of /lib/XXXX<br />
The modules are subsequently copied to:
/var/tmp/rear.XXXX/rootfs/usr/lib/modules/XXXX/kernel<br />
as opposed to: /var/tmp/rear.XXXX/rootfs/lib/modules/XXXX/kernel</p>
<p>My temporary workaround was to replace 'readlink -e' with 'echo'.</p>
<h4 id="jsmeix_commented_at_2021-12-20_1119"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2615#issuecomment-997834167">2021-12-20 11:19</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-12-20_1119" title="Permanent link">&para;</a></h4>
<p>@nolocimes<br />
thank you for your report and what you did to fix it!<br />
Therefore it seems this issue is same as<br />
<a href="https://github.com/rear/rear/issues/2677">https://github.com/rear/rear/issues/2677</a><br />
I will continue there.</p>
<h4 id="jsmeix_commented_at_2021-12-22_1343"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2615#issuecomment-999586678">2021-12-22 13:43</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-12-22_1343" title="Permanent link">&para;</a></h4>
<p>I assume also this one is fixed by
<a href="https://github.com/rear/rear/pull/2731">https://github.com/rear/rear/pull/2731</a></p>
<h4 id="752377941_commented_at_2022-05-27_0708"><img src="https://avatars.githubusercontent.com/u/32575098?v=4" width="50"><a href="https://github.com/752377941">752377941</a> commented at <a href="https://github.com/rear/rear/issues/2615#issuecomment-1139346701">2022-05-27 07:08</a>:<a class="headerlink" href="#752377941_commented_at_2022-05-27_0708" title="Permanent link">&para;</a></h4>
<blockquote>
<p>Sorry for the confusion.</p>
<p>I have checked out at
<a href="https://github.com/rear/rear/commit/c6500f9c42f1e68a5aaf36d556b144cbb8e69369">c6500f9</a>,
applied Oliver's patch from <a href="https://github.com/rear/rear/issues/2615#issuecomment-839678939">#2615
(comment)</a>
and got a more verbose output now. I will try to find a way to get the
full log, but for now:</p>
<pre><code>Could not detect TCG Opal 2-compliant disks.

Entering emergency shell...
[...]
The following error occured when executing /etc/scripts/unlock-opal-disks:
modprobe: FATAL: Module mac_hid not found in directory /lib/modules/5.8.0-50-generic
modprobe: FATAL: Module usbhid not found in directory /lib/modules/5.8.0-50-generic
modprobe: FATAL: Module hid not found in directory /lib/modules/5.8.0-50-generic
modprobe: FATAL: Module usb_storage not found in directory /lib/modules/5.8.0-50-generic
Could not detect TCG Opal 2-compliant disks.
</code></pre>
</blockquote>
<p>Could you tell me how you solve this problem?</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2025 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2021-05-12.2615.issue.closed.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/rear/rear-user-guide" class="fa fa-code-fork" style="color: #fcfcfc"> rear/rear-user-guide</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
