<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#2088 PR merged: Error function must immediately exit (issue #2089) - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#2088 PR merged: Error function must immediately exit (issue #2089)";
        var mkdocs_page_input_path = "issues/2019-03-18.2088.pr.merged.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/backup_netfs.html">Example of BACKUP=NETFS</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear29.html">Release Notes ReaR 2.9</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear28.html">Release Notes ReaR 2.8</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#2088 PR merged: Error function must immediately exit (issue #2089)</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="2088_pr_merged_error_function_must_immediately_exit_issue_2089"><a href="https://github.com/rear/rear/pull/2088">#2088 PR</a> <code>merged</code>: Error function must immediately exit (issue #2089)<a class="headerlink" href="#2088_pr_merged_error_function_must_immediately_exit_issue_2089" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>fixed / solved / done</code>, <code>critical / security / legal</code></p>
<h4 id="jsmeix_opened_issue_at_2019-03-18_1046"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> opened issue at <a href="https://github.com/rear/rear/pull/2088">2019-03-18 10:46</a>:<a class="headerlink" href="#jsmeix_opened_issue_at_2019-03-18_1046" title="Permanent link">&para;</a></h4>
<ul>
<li>
<p>Type: <strong>Critical Bug Fix</strong></p>
</li>
<li>
<p>Impact: <strong>Critical</strong></p>
</li>
<li>
<p>Reference to related issue (URL):<br />
<a href="https://github.com/rear/rear/issues/2089">https://github.com/rear/rear/issues/2089</a><br />
<a href="https://github.com/rear/rear/issues/2089#issuecomment-474240386">https://github.com/rear/rear/issues/2089#issuecomment-474240386</a><br />
    For the history how this issue became known see<br />
<a href="https://github.com/rear/rear/issues/2087#issue-421604286">https://github.com/rear/rear/issues/2087#issue-421604286</a><br />
<a href="https://github.com/rear/rear/pull/2080/commits/f4a7d22f0dc07e518b750f445159320cac397952">https://github.com/rear/rear/pull/2080/commits/f4a7d22f0dc07e518b750f445159320cac397952</a></p>
</li>
<li>
<p>How was this pull request tested?</p>
</li>
</ul>
<p>By me on openSUSE Leap 15.0 with artificial Error calls<br />
in a script directly as</p>
<pre><code>Error "Test error"
</code></pre>
<p>and in a subshell as</p>
<pre><code>( Error "Test error" )
</code></pre>
<ul>
<li>Brief description of the changes in this pull request:</li>
</ul>
<p>The Error function must not return to its caller<br />
because then the caller could continue with the code<br />
after its Error function call, see<br />
<a href="https://github.com/rear/rear/issues/2089#issuecomment-474240386">https://github.com/rear/rear/issues/2089#issuecomment-474240386</a></p>
<h4 id="jsmeix_commented_at_2019-03-18_1049"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2088#issuecomment-473860973">2019-03-18 10:49</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-03-18_1049" title="Permanent link">&para;</a></h4>
<p>@rear/contributors<br />
if one of you has a better understanding<br />
how to cleanly abort via the Error function<br />
without possibly running further code after the Error function call<br />
I would appreciate information how to better implement things.</p>
<h4 id="jsmeix_commented_at_2019-03-18_1103"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2088#issuecomment-473865269">2019-03-18 11:03</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-03-18_1103" title="Permanent link">&para;</a></h4>
<p>FYI<br />
how the log for<br />
<a href="https://github.com/rear/rear/issues/2087#issue-421604286">https://github.com/rear/rear/issues/2087#issue-421604286</a><br />
in<br />
<a href="https://github.com/rear/rear/files/2972012/rear-testvm02.log">https://github.com/rear/rear/files/2972012/rear-testvm02.log</a><br />
looks (excerpts):</p>
<pre><code>+++ Error 'Partition number '\''0'\'' of partition mmcblk0boot0 is not a valid number.'
...
+++ kill -USR1 15126
+++ ((  0 &lt;= 128  ))
+++ StopIfError 'Partition mmcblk0boot0 is numbered '\''0'\''. More than 128 partitions is not supported.'
...
+++ Error 'Partition number '\'''\'' of partition mmcblk0rpmb is not a valid number.'
...
+++ kill -USR1 15126
+++ ((   &lt;= 128  ))
...
+++ Error 'Partition mmcblk0rpmb is numbered '\'''\''. More than 128 partitions is not supported.'
...
+++ kill -USR1 15126
...
[ here in between are 549 lines of debug messages about further executed code ]
...
++ EXIT_FAIL_MESSAGE=0
++ echo 'Aborting due to an error, check /var/log/rear/rear-testvm02.log for details'
++ kill 15126
++ DoExitTasks
</code></pre>
<p>versus how it looks for me with my <code>sleep 1</code> at the end of the Error
function</p>
<pre><code>++ kill -USR1 10714
++ sleep 1
+++ EXIT_FAIL_MESSAGE=0
+++ echo 'Aborting due to an error, check /root/rear.github.master/var/log/rear/rear-g243.log for details'
+++ kill 10714
+++ DoExitTasks
</code></pre>
<h4 id="jsmeix_commented_at_2019-03-18_1229"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2088#issuecomment-473889993">2019-03-18 12:29</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-03-18_1229" title="Permanent link">&para;</a></h4>
<p><a href="https://github.com/rear/rear/issues/2087#issuecomment-473884096">https://github.com/rear/rear/issues/2087#issuecomment-473884096</a><br />
shows that the <code>sleep 1</code> at the end of the Error function is useless<br />
so it seems something more severe is going on here...</p>
<h4 id="rmetrich_commented_at_2019-03-18_1235"><img src="https://avatars.githubusercontent.com/u/1163635?u=36b5e32e1dd55f1ce77cad431a5683fce40a7934&v=4" width="50"><a href="https://github.com/rmetrich">rmetrich</a> commented at <a href="https://github.com/rear/rear/pull/2088#issuecomment-473892043">2019-03-18 12:35</a>:<a class="headerlink" href="#rmetrich_commented_at_2019-03-18_1235" title="Permanent link">&para;</a></h4>
<p>I'm pretty sure it's due to how buffering is performed.<br />
IMHO, stderr is unbuffered whereas stdout is.</p>
<h4 id="jsmeix_commented_at_2019-03-18_1507"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2088#issuecomment-473949640">2019-03-18 15:07</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-03-18_1507" title="Permanent link">&para;</a></h4>
<p>As far as I see the root cause is<br />
<a href="https://github.com/rear/rear/issues/2089#issuecomment-473908710">https://github.com/rear/rear/issues/2089#issuecomment-473908710</a><br />
and my latest<br />
<a href="https://github.com/rear/rear/pull/2088/commits/cfd440158f7fd56fbc94835d2111f2d81176eb95">https://github.com/rear/rear/pull/2088/commits/cfd440158f7fd56fbc94835d2111f2d81176eb95</a><br />
implements what "helps a bit" in<br />
<a href="https://github.com/rear/rear/issues/2089#issuecomment-473919956">https://github.com/rear/rear/issues/2089#issuecomment-473919956</a><br />
as a first step to actually solve it.</p>
<h4 id="jsmeix_commented_at_2019-03-18_1730"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2088#issuecomment-474020900">2019-03-18 17:30</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-03-18_1730" title="Permanent link">&para;</a></h4>
<p>My latest commit here<br />
<a href="https://github.com/rear/rear/pull/2088/commits/d9a02ad1397331a2fbf24515311e3c30271e43e5">https://github.com/rear/rear/pull/2088/commits/d9a02ad1397331a2fbf24515311e3c30271e43e5</a><br />
is some bigger changes and perhaps too much code<br />
but at least for now things seem to work for me<br />
after a quick test (more testing tomorrow):</p>
<p>Now</p>
<pre><code>LogPrint "$( pstree -Aplau $MASTER_PID || ps f -g $MASTER_PID -o pid,args || ps --ppid $MASTER_PID -o pid,args )"
( LogPrint "First subshell"
  LogPrint "$( pstree -Aplau $MASTER_PID || ps f -g $MASTER_PID -o pid,args || ps --ppid $MASTER_PID -o pid,args )"
  ( LogPrint "Second subshell"
    LogPrint "$( pstree -Aplau $MASTER_PID || ps f -g $MASTER_PID -o pid,args || ps --ppid $MASTER_PID -o pid,args )"
    Error "Test error a"
    Error "Test error b"
  )
  LogPrint "Code in first subshell after second subshell"
  echo "foo" &gt;/tmp/rear_test_file
  LogPrint "$( cat /tmp/rear_test_file )"
  rm -v /tmp/rear_test_file 0&lt;&amp;6 1&gt;&amp;7 2&gt;&amp;8
  LogPrint "End of first subshell"
)
LogPrint "Message after first subshell"
</code></pre>
<p>errors out correctly - as far as I see - as follows:</p>
<pre><code># usr/sbin/rear -D mkrescue
Relax-and-Recover 2.4 / Git
Running rear mkrescue (PID 6099)
Using log file: /root/rear.github.master/var/log/rear/rear-g243.log
rear,6099 usr/sbin/rear -D mkrescue
  `-rear,6317 usr/sbin/rear -D mkrescue
      `-pstree,6318 -Aplau 6099
First subshell
rear,6099 usr/sbin/rear -D mkrescue
  `-rear,6321 usr/sbin/rear -D mkrescue
      `-rear,6324 usr/sbin/rear -D mkrescue
          `-pstree,6325 -Aplau 6099
Second subshell
rear,6099 usr/sbin/rear -D mkrescue
  `-rear,6321 usr/sbin/rear -D mkrescue
      `-rear,6328 usr/sbin/rear -D mkrescue
          `-rear,6331 usr/sbin/rear -D mkrescue
              `-pstree,6332 -Aplau 6099
ERROR: Test error a
Some latest log messages since the last called script 030_update_recovery_system.sh:
    `-rear,6321 usr/sbin/rear -D mkrescue
        `-rear,6328 usr/sbin/rear -D mkrescue
            `-rear,6331 usr/sbin/rear -D mkrescue
                `-pstree,6332 -Aplau 6099
    `-rear,6321 usr/sbin/rear -D mkrescue
        `-rear,6328 usr/sbin/rear -D mkrescue
            `-rear,6331 usr/sbin/rear -D mkrescue
                `-pstree,6332 -Aplau 6099'
Error exit of rear mkrescue (PID 6099) and its descendant processes
Terminating descendant process 6321 /bin/bash usr/sbin/rear -D mkrescue
Aborting due to an error, check /root/rear.github.master/var/log/rear/rear-g243.log for details
Exiting rear mkrescue (PID 6099) and its descendant processes
Terminating descendant process 6328 /bin/bash usr/sbin/rear -D mkrescue
Running exit tasks
Terminated
</code></pre>
<p>A normal Error() not in a subshell like</p>
<pre><code>LogPrint "$( pstree -Aplau $MASTER_PID || ps f -g $MASTER_PID -o pid,args || ps --ppid $MASTER_PID -o pid,args )"
Error "Test error"
LogPrint "Message after Error"
</code></pre>
<p>errors out this way:</p>
<pre><code># usr/sbin/rear -D mkrescue
Relax-and-Recover 2.4 / Git
Running rear mkrescue (PID 6727)
Using log file: /root/rear.github.master/var/log/rear/rear-g243.log
rear,6727 usr/sbin/rear -D mkrescue
  `-rear,6944 usr/sbin/rear -D mkrescue
      `-pstree,6945 -Aplau 6727
ERROR: Test error
Some latest log messages since the last called script 030_update_recovery_system.sh:
        `-pstree,6945 -Aplau 6727'
    `-rear,6944 usr/sbin/rear -D mkrescue
        `-pstree,6945 -Aplau 6727'
  2019-03-18 18:29:09.005623275 rear,6727 usr/sbin/rear -D mkrescue
    `-rear,6944 usr/sbin/rear -D mkrescue
        `-pstree,6945 -Aplau 6727
    `-rear,6944 usr/sbin/rear -D mkrescue
        `-pstree,6945 -Aplau 6727'
Aborting due to an error, check /root/rear.github.master/var/log/rear/rear-g243.log for details
Exiting rear mkrescue (PID 6727) and its descendant processes
Running exit tasks
Terminated
</code></pre>
<h4 id="jsmeix_commented_at_2019-03-18_1818"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2088#issuecomment-474040918">2019-03-18 18:18</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-03-18_1818" title="Permanent link">&para;</a></h4>
<p>FYI<br />
how it errors out without <code>pstree -Aplau $MASTER_PID</code> commands</p>
<pre><code>( LogPrint "First subshell"
  ( LogPrint "Second subshell"
    Error "Test error a"
    Error "Test error b"
  )
  LogPrint "Code in first subshell after second subshell"
  LogPrint "End of first subshell"
)
LogPrint "Message after first subshell"
</code></pre>
<p>that errors out like</p>
<pre><code># usr/sbin/rear -D mkrescue
Relax-and-Recover 2.4 / Git
Running rear mkrescue (PID 10422)
Using log file: /root/rear.github.master/var/log/rear/rear-g243.log
First subshell
Second subshell
ERROR: Test error a
Some latest log messages since the last called script 030_update_recovery_system.sh:
  2019-03-18 19:18:14.074503193 Including init/default/030_update_recovery_system.sh
  2019-03-18 19:18:14.075294725 Entering debugscripts mode via 'set -x'.
  2019-03-18 19:18:14.078691835 First subshell
  2019-03-18 19:18:14.080233165 Second subshell
Error exit of rear mkrescue (PID 10422) and its descendant processes
Terminating descendant process 10639 /bin/bash usr/sbin/rear -D mkrescue
Aborting due to an error, check /root/rear.github.master/var/log/rear/rear-g243.log for details
Exiting rear mkrescue (PID 10422) and its descendant processes
Terminating descendant process 10642 /bin/bash usr/sbin/rear -D mkrescue
Running exit tasks
Terminated
</code></pre>
<p>and a plain</p>
<pre><code>Error "Test error"
LogPrint "Message after Error"
</code></pre>
<p>errors out like</p>
<pre><code># usr/sbin/rear -D mkrescue
Relax-and-Recover 2.4 / Git
Running rear mkrescue (PID 10751)
Using log file: /root/rear.github.master/var/log/rear/rear-g243.log
ERROR: Test error
Some latest log messages since the last called script 030_update_recovery_system.sh:
  2019-03-18 19:19:17.796780805 Including init/default/030_update_recovery_system.sh
  2019-03-18 19:19:17.797625940 Entering debugscripts mode via 'set -x'.
Aborting due to an error, check /root/rear.github.master/var/log/rear/rear-g243.log for details
Exiting rear mkrescue (PID 10751) and its descendant processes
Running exit tasks
Terminated
</code></pre>
<h4 id="jsmeix_commented_at_2019-03-18_1827"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2088#issuecomment-474044245">2019-03-18 18:27</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-03-18_1827" title="Permanent link">&para;</a></h4>
<p>Something is not yet fully clean in case of three nested subshells</p>
<pre><code>( LogPrint "First subshell"
  ( LogPrint "Second subshell"
    ( LogPrint "Third subshell"
      Error "Test error a"
      Error "Test error b"
    )
    LogPrint "Code in second subshell after third subshell"
    LogPrint "End of second subshell"
  )
  LogPrint "Code in first subshell after second subshell"
  LogPrint "End of first subshell"
)
LogPrint "Message after first subshell"
</code></pre>
<p>which errors out this way:</p>
<pre><code># usr/sbin/rear -D mkrescue
Relax-and-Recover 2.4 / Git
Running rear mkrescue (PID 11824)
Using log file: /root/rear.github.master/var/log/rear/rear-g243.log
First subshell
Second subshell
Third subshell
ERROR: Test error a
Some latest log messages since the last called script 030_update_recovery_system.sh:
  2019-03-18 19:24:32.338361366 Including init/default/030_update_recovery_system.sh
  2019-03-18 19:24:32.339156300 Entering debugscripts mode via 'set -x'.
  2019-03-18 19:24:32.342579301 First subshell
  2019-03-18 19:24:32.344089500 Second subshell
  2019-03-18 19:24:32.345597625 Third subshell
Error exit of rear mkrescue (PID 11824) and its descendant processes
Terminating descendant process 12047 /bin/bash usr/sbin/rear -D mkrescue
Aborting due to an error, check /root/rear.github.master/var/log/rear/rear-g243.log for details
Exiting rear mkrescue (PID 11824) and its descendant processes
Terminating descendant process 12050 /bin/bash usr/sbin/rear -D mkrescue
Running exit tasks
Terminated
 # Terminating descendant process 12053 /bin/bash usr/sbin/rear -D mkrescue
</code></pre>
<p>i.e. the <code>Terminating descendant process 12053</code> appeasr too late.</p>
<h4 id="jsmeix_commented_at_2019-03-19_1253"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2088#issuecomment-474350195">2019-03-19 12:53</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-03-19_1253" title="Permanent link">&para;</a></h4>
<p>Now things work really well for me:</p>
<p>For testing I have at the beginning of
init/default/030_update_recovery_system.sh</p>
<pre><code>( LogPrint "First subshell $BASHPID"
  ( LogPrint "Second subshell $BASHPID"
    ( LogPrint "Third subshell $BASHPID"
      ( LogPrint "Fourth subshell $BASHPID"
        pstree -Aplau $MASTER_PID 0&lt;&amp;6 1&gt;&amp;7 2&gt;&amp;8
        Error "Test error a"
        Error "Test error b"
      )
      LogPrint "Code in third subshell after fourth subshell"
      LogPrint "End of third subshell"
    )
    LogPrint "Code in second subshell after third subshell"
    LogPrint "End of second subshell"
  )
  LogPrint "Code in first subshell after second subshell"
  LogPrint "End of first subshell"
)
LogPrint "Message after first subshell"
</code></pre>
<p>and then it errors out as follows</p>
<pre><code># usr/sbin/rear -D mkrescue
Relax-and-Recover 2.4 / Git
Running rear mkrescue (PID 12484)
Using log file: /root/rear.github.master/var/log/rear/rear-g243.log
First subshell 12701
Second subshell 12704
Third subshell 12707
Fourth subshell 12710
rear,12484 usr/sbin/rear -D mkrescue
  `-rear,12701 usr/sbin/rear -D mkrescue
      `-rear,12704 usr/sbin/rear -D mkrescue
          `-rear,12707 usr/sbin/rear -D mkrescue
              `-rear,12710 usr/sbin/rear -D mkrescue
                  `-pstree,12713 -Aplau 12484
ERROR: Test error a
Some latest log messages since the last called script 030_update_recovery_system.sh:
  2019-03-19 13:48:19.778593964 Including init/default/030_update_recovery_system.sh
  2019-03-19 13:48:19.779476109 Entering debugscripts mode via 'set -x'.
  2019-03-19 13:48:19.783102412 First subshell 12701
  2019-03-19 13:48:19.784684687 Second subshell 12704
  2019-03-19 13:48:19.786319435 Third subshell 12707
  2019-03-19 13:48:19.789484642 Fourth subshell 12710
Error exit of rear mkrescue (PID 12484) and its descendant processes
Terminating child process 12701 /bin/bash usr/sbin/rear -D mkrescue
Aborting due to an error, check /root/rear.github.master/var/log/rear/rear-g243.log for details
Exiting rear mkrescue (PID 12484) and its descendant processes ...
Terminating child process 12704 /bin/bash usr/sbin/rear -D mkrescue
Terminating child process 12707 /bin/bash usr/sbin/rear -D mkrescue
Terminating child process 12710 /bin/bash usr/sbin/rear -D mkrescue
Running exit tasks
Terminated
</code></pre>
<p>With Error() not from a subshell as in</p>
<pre><code>pstree -Aplau $MASTER_PID 0&lt;&amp;6 1&gt;&amp;7 2&gt;&amp;8
Error "Test error"
LogPrint "Message after Error"
</code></pre>
<p>it errors out as follows</p>
<pre><code># usr/sbin/rear -D mkrescue
Relax-and-Recover 2.4 / Git
Running rear mkrescue (PID 18494)
Using log file: /root/rear.github.master/var/log/rear/rear-g243.log
rear,18494 usr/sbin/rear -D mkrescue
  `-pstree,18711 -Aplau 18494
ERROR: Test error
Some latest log messages since the last called script 030_update_recovery_system.sh:
  2019-03-19 13:50:00.386331767 Including init/default/030_update_recovery_system.sh
  2019-03-19 13:50:00.387170921 Entering debugscripts mode via 'set -x'.
Aborting due to an error, check /root/rear.github.master/var/log/rear/rear-g243.log for details
Exiting rear mkrescue (PID 18494) and its descendant processes ...
Running exit tasks
Terminated
</code></pre>
<p>Without any Error it finishes as follows:</p>
<pre><code># usr/sbin/rear -D mkrescue
Relax-and-Recover 2.4 / Git
Running rear mkrescue (PID 22530)
...
Exiting rear mkrescue (PID 22530) and its descendant processes ...
Running exit tasks
You should also rm -Rf /tmp/rear.i5DoiT2uwBxcDOH
</code></pre>
<h4 id="jsmeix_commented_at_2019-03-19_1254"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2088#issuecomment-474350548">2019-03-19 12:54</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-03-19_1254" title="Permanent link">&para;</a></h4>
<p>@rear/contributors<br />
if there are no objections I would like to merge it tomorrow.</p>
<h4 id="jsmeix_commented_at_2019-03-19_1607"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2088#issuecomment-474446764">2019-03-19 16:07</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-03-19_1607" title="Permanent link">&para;</a></h4>
<p>I must not terminate the current process that runs the Error funtion.</p>
<p>Now with</p>
<pre><code>( LogPrint "First subshell $BASHPID"
  ( LogPrint "Second subshell $BASHPID"
    ( LogPrint "Third subshell $BASHPID"
      ( LogPrint "Fourth subshell $BASHPID"
        pstree -Aplau $MASTER_PID 0&lt;&amp;6 1&gt;&amp;7 2&gt;&amp;8
        Error "Test error a"
        Error "Test error b"
      )
      LogPrint "Code in third subshell after fourth subshell"
      LogPrint "End of third subshell"
    )
    LogPrint "Code in second subshell after third subshell"
    LogPrint "End of second subshell"
  )
  LogPrint "Code in first subshell after second subshell"
  LogPrint "End of first subshell"
)
LogPrint "Message after first subshell"
</code></pre>
<p>it errors out as follows</p>
<pre><code># usr/sbin/rear -D mkrescue
Relax-and-Recover 2.4 / Git
Running rear mkrescue (PID 19692)
Using log file: /root/rear.github.master/var/log/rear/rear-g243.log
First subshell 19909
Second subshell 19912
Third subshell 19915
Fourth subshell 19918
rear,19692 usr/sbin/rear -D mkrescue
  `-rear,19909 usr/sbin/rear -D mkrescue
      `-rear,19912 usr/sbin/rear -D mkrescue
          `-rear,19915 usr/sbin/rear -D mkrescue
              `-rear,19918 usr/sbin/rear -D mkrescue
                  `-pstree,19921 -Aplau 19692
ERROR: Test error a
Some latest log messages since the last called script 030_update_recovery_system.sh:
  2019-03-19 17:02:24.660213376 Including init/default/030_update_recovery_system.sh
  2019-03-19 17:02:24.661045553 Entering debugscripts mode via 'set -x'.
  2019-03-19 17:02:24.664613768 First subshell 19909
  2019-03-19 17:02:24.666223200 Second subshell 19912
  2019-03-19 17:02:24.667872244 Third subshell 19915
  2019-03-19 17:02:24.669971807 Fourth subshell 19918
Error exit of rear mkrescue (PID 19692) and its descendant processes
Terminating child process 19909 /bin/bash usr/sbin/rear -D mkrescue
Aborting due to an error, check /root/rear.github.master/var/log/rear/rear-g243.log for details
Exiting rear mkrescue (PID 19692) and its descendant processes ...
Terminating child process 19912 /bin/bash usr/sbin/rear -D mkrescue
Terminating child process 19915 /bin/bash usr/sbin/rear -D mkrescue
Exiting subshell 4
Running exit tasks
Terminated
</code></pre>
<p>Now the current process that runs the Error funtion (here subshell 4
with PID 19918)<br />
gets no longer terminated "from outside" (via SIGTERM)<br />
but exits latest on its own (via <code>Exiting subshell 4</code>).</p>
<h4 id="jsmeix_commented_at_2019-03-20_1535"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2088#issuecomment-474888371">2019-03-20 15:35</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-03-20_1535" title="Permanent link">&para;</a></h4>
<p>For the fun of it what I tested right now:<br />
The code</p>
<pre><code>( LogPrint "First subshell $BASHPID"
  ( LogPrint "First background subshell that ignores SIGTERM $BASHPID"
    builtin trap "LogPrint First background subshell got SIGTERM" SIGTERM
    for i in $( seq 5 ) ; do LogPrint "First background subshell $i" ; sleep 1 ; done
    LogPrint "First background subshell done"
  ) &amp;
  ( LogPrint "Second subshell $BASHPID"
    ( LogPrint "Second background subshell that ignores SIGTERM $BASHPID"
      builtin trap "LogPrint Second background subshell got SIGTERM" SIGTERM
      for i in $( seq 5 ) ; do LogPrint "Second background subshell $i" ; sleep 1 ; done
      LogPrint "Second background subshell done"
    ) &amp;
    ( LogPrint "Third subshell $BASHPID"
      ( LogPrint "Third background subshell that ignores SIGTERM $BASHPID"
        builtin trap "LogPrint Third background subshell got SIGTERM" SIGTERM
        for i in $( seq 5 ) ; do LogPrint "Third background subshell $i" ; sleep 1 ; done
        LogPrint "Third background subshell done"
      ) &amp;
      ( LogPrint "Fourth subshell $BASHPID"
        ( LogPrint "Fourth background subshell that ignores SIGTERM $BASHPID"
          builtin trap "LogPrint Fourth background subshell got SIGTERM" SIGTERM
          for i in $( seq 5 ) ; do LogPrint "Fourth background subshell $i" ; sleep 1 ; done
          LogPrint "Fourth background subshell done"
        ) &amp;
        pstree -Aplau $MASTER_PID 0&lt;&amp;6 1&gt;&amp;7 2&gt;&amp;8
        Error "Test error a"
        Error "Test error b"
      )
      LogPrint "Code in third subshell after fourth subshell"
      LogPrint "End of third subshell"
    )
    LogPrint "Code in second subshell after third subshell"
    LogPrint "End of second subshell"
  )
  LogPrint "Code in first subshell after second subshell"
  LogPrint "End of first subshell"
)
LogPrint "Message after first subshell"
</code></pre>
<p>errors out as follows</p>
<pre><code># usr/sbin/rear -D mkrescue
Relax-and-Recover 2.4 / Git
Running rear mkrescue (PID 14326)
Using log file: /root/rear.github.master/var/log/rear/rear-g243.log
First subshell 14543
First background subshell that ignores SIGTERM 14546
Second subshell 14547
Second background subshell that ignores SIGTERM 14553
First background subshell 1
Third subshell 14555
Second background subshell 1
Third background subshell that ignores SIGTERM 14565
Fourth subshell 14567
Fourth background subshell that ignores SIGTERM 14575
Third background subshell 1
Fourth background subshell 1
rear,14326 usr/sbin/rear -D mkrescue
  `-rear,14543 usr/sbin/rear -D mkrescue
      |-rear,14546 usr/sbin/rear -D mkrescue
      |   `-sleep,14564 1
      `-rear,14547 usr/sbin/rear -D mkrescue
          |-rear,14553 usr/sbin/rear -D mkrescue
          |   `-sleep,14573 1
          `-rear,14555 usr/sbin/rear -D mkrescue
              |-rear,14565 usr/sbin/rear -D mkrescue
              `-rear,14567 usr/sbin/rear -D mkrescue
                  |-pstree,14576 -Aplau 14326
                  `-rear,14575 usr/sbin/rear -D mkrescue
ERROR: Test error a
Some latest log messages since the last called script 030_update_recovery_system.sh:
  2019-03-20 16:25:35.895662577 First background subshell 1
  2019-03-20 16:25:35.894978735 Third subshell 14555
  2019-03-20 16:25:35.898088412 Second background subshell 1
  2019-03-20 16:25:35.898284400 Third background subshell that ignores SIGTERM 14565
  2019-03-20 16:25:35.898427918 Fourth subshell 14567
  2019-03-20 16:25:35.900234592 Fourth background subshell that ignores SIGTERM 14575
  2019-03-20 16:25:35.901375014 Third background subshell 1
  2019-03-20 16:25:35.903045800 Fourth background subshell 1
Error exit of rear mkrescue (PID 14326) and its descendant processes
Terminating child process 14543 /bin/bash usr/sbin/rear -D mkrescue
Aborting due to an error, check /root/rear.github.master/var/log/rear/rear-g243.log for details
Exiting rear mkrescue (PID 14326) and its descendant processes ...
Terminating child process 14547 /bin/bash usr/sbin/rear -D mkrescue
Terminating child process 14555 /bin/bash usr/sbin/rear -D mkrescue
Terminating child process 14575 /bin/bash usr/sbin/rear -D mkrescue
Terminating child process 14587 sleep 1
Fourth background subshell got SIGTERM
Fourth background subshell 2
Terminating child process 14565 /bin/bash usr/sbin/rear -D mkrescue
Terminating child process 14584 sleep 1
Third background subshell got SIGTERM
Third background subshell 2
Terminating child process 14553 /bin/bash usr/sbin/rear -D mkrescue
Terminating child process 14573 sleep 1
Second background subshell got SIGTERM
Second background subshell 2
Terminating child process 14546 /bin/bash usr/sbin/rear -D mkrescue
Terminating child process 14564 sleep 1
First background subshell got SIGTERM
First background subshell 2
Fourth background subshell 3
Third background subshell 3
Second background subshell 3
Child process 14575 not yet terminated
First background subshell 3
Child process 14565 not yet terminated
Child process 14553 not yet terminated
Child process 14546 not yet terminated
Killing child process 14575 /bin/bash usr/sbin/rear -D mkrescue
Killing child process 14565 /bin/bash usr/sbin/rear -D mkrescue
Killing child process 14553 /bin/bash usr/sbin/rear -D mkrescue
Killing child process 14546 /bin/bash usr/sbin/rear -D mkrescue
Exiting subshell 4 (where the actual error happened)
Running exit tasks
Terminated
</code></pre>
<h4 id="jsmeix_commented_at_2019-03-20_1603"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2088#issuecomment-474902999">2019-03-20 16:03</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-03-20_1603" title="Permanent link">&para;</a></h4>
<p>FYI:<br />
When one removes the</p>
<pre><code>        Error "Test error a"
        Error "Test error b"
</code></pre>
<p>from the above code and changes<br />
the <code>for i in $( seq 5 )</code> to <code>for i in $( seq 55 )</code><br />
to keep the background processes running longer than "rear -D mkrescue"
runs,<br />
the background processes are not terminated because when their parents<br />
which are the four subshells finish, init inherits the then orphaned<br />
background processes so that when "rear -D mkrescue" finishes<br />
the <code>pstree -Aplau</code> output looks as follows (excerpts)</p>
<pre><code>systemd,1 --system --deserialize 28
...
  |   ...   |   `-bash,21908
  |   ...   |       `-rear,2876 usr/sbin/rear -D mkrescue
  |   ...   |           `-rear,19197 usr/sbin/rear -D mkrescue
  |   ...   |               `-pstree,19198 -Aplau
...
  |-rear,3135 usr/sbin/rear -D mkrescue
  |   `-sleep,19185 1
  |-rear,3143 usr/sbin/rear -D mkrescue
  |   `-sleep,19186 1
  |-rear,3174 usr/sbin/rear -D mkrescue
  |   `-sleep,19192 1
  |-rear,3216 usr/sbin/rear -D mkrescue
  |   `-sleep,19191 1
</code></pre>
<p>which results that the orphaned background processes<br />
continue to run after "rear -D mkrescue" finished<br />
until each orphaned background process ends on its own<br />
which looks like (shortened):</p>
<pre><code>user@host:~/rear.github.master # usr/sbin/rear -D mkrescue
Relax-and-Recover 2.4 / Git
Running rear mkrescue (PID 2876)
Using log file: /root/rear.github.master/var/log/rear/rear-g243.log
First subshell 3132
First background subshell that ignores SIGTERM 3135
Second subshell 3136
Second background subshell that ignores SIGTERM 3143
Third subshell 3150
First background subshell 1
Third background subshell that ignores SIGTERM 3174
Second background subshell 1
Fourth subshell 3175
Fourth background subshell that ignores SIGTERM 3216
Third background subshell 1
Fourth background subshell 1
rear,2876 usr/sbin/rear -D mkrescue
  `-rear,3132 usr/sbin/rear -D mkrescue
      |-rear,3135 usr/sbin/rear -D mkrescue
      |   `-sleep,3206 1
      `-rear,3136 usr/sbin/rear -D mkrescue
          |-rear,3143 usr/sbin/rear -D mkrescue
          |   `-sleep,3217 1
          `-rear,3150 usr/sbin/rear -D mkrescue
              |-rear,3174 usr/sbin/rear -D mkrescue
              `-rear,3175 usr/sbin/rear -D mkrescue
                  |-pstree,3218 -Aplau 2876
                  `-rear,3216 usr/sbin/rear -D mkrescue
Code in third subshell after fourth subshell
End of third subshell
Code in second subshell after third subshell
End of second subshell
Code in first subshell after second subshell
End of first subshell
Message after first subshell
Message after first subshell
Using UEFI Boot Loader for Linux (USING_UEFI_BOOTLOADER=1)
Using autodetected kernel '/boot/vmlinuz-4.12.14-lp150.12.25-default' as kernel in the recovery system
Creating disk layout
First background subshell 2
Second background subshell 2
Third background subshell 2
Fourth background subshell 2
...
Second background subshell 36
First background subshell 36
Third background subshell 36
Fourth background subshell 36
Exiting rear mkrescue (PID 2876) and its descendant processes ...
Second background subshell 37
First background subshell 37
Fourth background subshell 37
Third background subshell 37
Second background subshell 38
First background subshell 38
Fourth background subshell 38
Third background subshell 38
First background subshell 39
Second background subshell 39
Fourth background subshell 39
Third background subshell 39
Running exit tasks
You should also rm -Rf /tmp/rear.sHHbRi39A3v6vhQ
user@host:~/rear.github.master # First background subshell 40
Second background subshell 40
Fourth background subshell 40
Third background subshell 40
...
First background subshell 55
Second background subshell 55
Third background subshell 55
Fourth background subshell 55
First background subshell done
Second background subshell done
Fourth background subshell done
Third background subshell done
</code></pre>
<h4 id="jsmeix_commented_at_2019-03-20_1608"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2088#issuecomment-474905547">2019-03-20 16:08</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-03-20_1608" title="Permanent link">&para;</a></h4>
<p>I will sleep one more time over it<br />
and if I see no further issues with it<br />
I would like to merge it tomorrow.</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2025 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2019-03-18.2088.pr.merged.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/rear/rear-user-guide" class="fa fa-code-fork" style="color: #fcfcfc"> rear/rear-user-guide</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
