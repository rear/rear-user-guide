<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#2523 PR merged: Completely overhauled ldd test in 990_verify_rootfs.sh - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#2523 PR merged: Completely overhauled ldd test in 990_verify_rootfs.sh";
        var mkdocs_page_input_path = "issues/2020-11-23.2523.pr.merged.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/backup_netfs.html">Example of BACKUP=NETFS</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear29.html">Release Notes ReaR 2.9</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear28.html">Release Notes ReaR 2.8</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#2523 PR merged: Completely overhauled ldd test in 990_verify_rootfs.sh</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="2523_pr_merged_completely_overhauled_ldd_test_in_990_verify_rootfssh"><a href="https://github.com/rear/rear/pull/2523">#2523 PR</a> <code>merged</code>: Completely overhauled ldd test in 990_verify_rootfs.sh<a class="headerlink" href="#2523_pr_merged_completely_overhauled_ldd_test_in_990_verify_rootfssh" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>enhancement</code>, <code>cleanup</code>, <code>fixed / solved / done</code>,
<code>minor bug</code></p>
<h4 id="jsmeix_opened_issue_at_2020-11-23_1348"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> opened issue at <a href="https://github.com/rear/rear/pull/2523">2020-11-23 13:48</a>:<a class="headerlink" href="#jsmeix_opened_issue_at_2020-11-23_1348" title="Permanent link">&para;</a></h4>
<ul>
<li>
<p>Type: <strong>Bug Fix</strong> / <strong>Enhancement</strong> / <strong>Cleanup</strong></p>
</li>
<li>
<p>Impact: <strong>Low</strong> / <strong>High</strong><br />
    Low for normal use cases with 'tar' as backup tool.<br />
    Probably high for users with third-party backup tools<br />
    that require special LD_LIBRARY_PATH settings.</p>
</li>
<li>
<p>Reference to related issue (URL):<br />
<a href="https://github.com/rear/rear/issues/2508#issuecomment-726711801">https://github.com/rear/rear/issues/2508#issuecomment-726711801</a></p>
</li>
<li>
<p>How was this pull request tested?<br />
    "rear mkrescue" still works well for me with backup tool 'tar'</p>
</li>
<li>
<p>Brief description of the changes in this pull request:</p>
</li>
</ul>
<p>The whole ldd testing code in 990_verify_rootfs.sh was completely
overhauled:</p>
<p>Now a special LD_LIBRARY_PATH is only set directly before the "chroot
... ldd" test<br />
and afterwards it is restored to what it was before.</p>
<p>Now each binary is first tested without any LD_LIBRARY_PATH set (which
is the normal case)<br />
and when that failed it is tested with the LD_LIBRARY_PATH setting
while "rear mkrescue" is run<br />
(if there is such a LD_LIBRARY_PATH setting) and when that also failed
it is tested with a<br />
BACKUP method specific LD_LIBRARY_PATH setting (if there is such a
LD_LIBRARY_PATH setting).</p>
<p>Only when all tests fail the binary is considered to have actually
missing shared objects dependencies.<br />
This way we do not need to know which binaries require what specific
LD_LIBRARY_PATH setting.</p>
<p>We assume when the ldd test succeeds with one of those LD_LIBRARY_PATH
settings that setting<br />
will be somehow 'magically' also happen inside the recovery system to
make things work therein<br />
because special backup tools should have their methods to set
LD_LIBRARY_PATH as they need it.</p>
<h4 id="jsmeix_commented_at_2020-11-24_0942"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2523#issuecomment-732779380">2020-11-24 09:42</a>:<a class="headerlink" href="#jsmeix_commented_at_2020-11-24_0942" title="Permanent link">&para;</a></h4>
<p>Before this pull request the ldd test code was basically</p>
<pre><code># Set special LD_LIBRARY_PATH
export LD_LIBRARY_PATH=$special_stuff
# Test all binaries with special LD_LIBRARY_PATH set
for binary in $( find_binaries ) ; do
    chroot $ROOTFS_DIR /bin/bash --login -c "... ldd $binary"
done
# Restore previous LD_LIBRARY_PATH
... export LD_LIBRARY_PATH=$saved_LD_LIBRARY_PATH ...
</code></pre>
<p>which is bad because after <code>export LD_LIBRARY_PATH=$special_stuff</code><br />
all programs run with that special LD_LIBRARY_PATH set, cf.<br />
<a href="https://github.com/rear/rear/issues/2508#issuecomment-726711801">https://github.com/rear/rear/issues/2508#issuecomment-726711801</a></p>
<p>With the current pull request the ldd test code is basically</p>
<pre><code>for binary in $( find_binaries ) ; do
    # Set special LD_LIBRARY_PATH
    export LD_LIBRARY_PATH=$special_stuff
    # Test the binary with special LD_LIBRARY_PATH set
    chroot $ROOTFS_DIR /bin/bash --login -c "... ldd $binary"
    # Restore previous LD_LIBRARY_PATH
    ... export LD_LIBRARY_PATH=$saved_LD_LIBRARY_PATH ...
done
</code></pre>
<p>which is better because only <code>chroot ... ldd</code> is run with special
LD_LIBRARY_PATH set.</p>
<p>But this still looks wrong because the actual program that needs to
run<br />
with special LD_LIBRARY_PATH set is only <code>ldd</code> inside the chroot
environment.<br />
There is no reason to set the special LD_LIBRARY_PATH in the bash that
runs <code>rear</code>.<br />
So I will further change the code to be like this:</p>
<pre><code>for binary in $( find_binaries ) ; do
    # Test the binary with special LD_LIBRARY_PATH set
    chroot $ROOTFS_DIR /bin/bash --login -c "export LD_LIBRARY_PATH=$special_stuff ... ldd $binary"
done
</code></pre>
<p>Now the special LD_LIBRARY_PATH is set only in the bash that runs
<code>ldd</code> and<br />
that bash exits after <code>ldd</code> finished so the special LD_LIBRARY_PATH
setting is gone with it.<br />
So there is no need to remember and restore some previously set
LD_LIBRARY_PATH<br />
because nothing was changed in the bash that runs <code>rear</code>.</p>
<h4 id="jsmeix_commented_at_2020-11-24_1126"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2523#issuecomment-732863081">2020-11-24 11:26</a>:<a class="headerlink" href="#jsmeix_commented_at_2020-11-24_1126" title="Permanent link">&para;</a></h4>
<p>@OliverO2<br />
only FYI:<br />
Via this pull request
<a href="https://github.com/rear/rear/pull/2523">https://github.com/rear/rear/pull/2523</a><br />
I completely overhauled the <code>ldd</code> test in 990_verify_rootfs.sh</p>
<p>See<br />
<a href="https://github.com/rear/rear/pull/2523#issuecomment-732779380">https://github.com/rear/rear/pull/2523#issuecomment-732779380</a><br />
for a summary how it was before and what I changed.</p>
<p>If you are interested and have time for it I would appreciate it<br />
if you could test if the current one in this pull request works for you.</p>
<p>To get a git clone of the current state of this pull request you could
do:</p>
<pre><code># git clone --single-branch --branch jsmeix-overhauled-ldd-test https://github.com/rear/rear.git

# mv rear rear.jsmeix-overhauled-ldd-test

# cd rear.jsmeix-overhauled-ldd-test

# vi etc/rear/local.conf

# usr/sbin/rear -D mkrescue
</code></pre>
<h4 id="olivero2_commented_at_2020-11-24_1153"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/pull/2523#issuecomment-732903559">2020-11-24 11:53</a>:<a class="headerlink" href="#olivero2_commented_at_2020-11-24_1153" title="Permanent link">&para;</a></h4>
<p>@jsmeix<br />
I'll have a look and I'll do a test run. Will probably take 2-3 days,
but if we're lucky, I can squeeze it in faster...</p>
<h4 id="olivero2_commented_at_2020-11-25_1405"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/pull/2523#issuecomment-733726490">2020-11-25 14:05</a>:<a class="headerlink" href="#olivero2_commented_at_2020-11-25_1405" title="Permanent link">&para;</a></h4>
<p>@jsmeix<br />
I ran your branch with minimal local configuration on Ubuntu 20.04.1 LTS
Desktop. Everything worked as expected. Relevant debug output was:</p>
<pre><code>Testing that the recovery system in /tmp/rear.mUiqWGXc9CVbk2Y/rootfs contains a usable system
Testing each binary with 'ldd' and look for 'not found' libraries within the recovery system
Testing that each program in the PROGS array can be found as executable command within the recovery system
Testing that each program in the REQUIRED_PROGS array can be found as executable command within the recovery system
</code></pre>
<p>(Tried to boot the recovery system on VirtualBox VM, but that froze
after completing its startup to the root login prompt. However, this is
an issue most probably completely unrelated to ReaR.)</p>
<p>I have also looked at the code and did not notice anything suspicious
;-). So LGTM...</p>
<h4 id="jsmeix_commented_at_2020-11-25_1431"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2523#issuecomment-733742013">2020-11-25 14:31</a>:<a class="headerlink" href="#jsmeix_commented_at_2020-11-25_1431" title="Permanent link">&para;</a></h4>
<p>@OliverO2<br />
thank you very much for testing it and for looking at the code!</p>
<p>@rear/contributors<br />
if there are no objections I would like to merge it tomorrow afternoon.</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2025 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2020-11-23.2523.pr.merged.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/rear/rear-user-guide" class="fa fa-code-fork" style="color: #fcfcfc"> rear/rear-user-guide</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
