<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#3147 Issue open: clevis luks bind - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#3147 Issue open: clevis luks bind";
        var mkdocs_page_input_path = "issues/2024-02-08.3147.issue.open.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/backup_netfs.html">Example of BACKUP=NETFS</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear29.html">Release Notes ReaR 2.9</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear28.html">Release Notes ReaR 2.8</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#3147 Issue open: clevis luks bind</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="3147_issue_open_clevis_luks_bind"><a href="https://github.com/rear/rear/issues/3147">#3147 Issue</a> <code>open</code>: clevis luks bind<a class="headerlink" href="#3147_issue_open_clevis_luks_bind" title="Permanent link">&para;</a></h1>
<h4 id="herpgon_opened_issue_at_2024-02-08_0135"><img src="https://avatars.githubusercontent.com/u/52363466?v=4" width="50"><a href="https://github.com/Herpgon">Herpgon</a> opened issue at <a href="https://github.com/rear/rear/issues/3147">2024-02-08 01:35</a>:<a class="headerlink" href="#herpgon_opened_issue_at_2024-02-08_0135" title="Permanent link">&para;</a></h4>
<!-- Relax-and-Recover (ReaR) Issue Template
Fill in the following items when submitting a new issue.
Use GitHub Markdown, see "Basic writing and formatting syntax" on
https://docs.github.com/en/get-started/writing-on-github
Support is voluntary without guarantee/warranty/liability -->

<ul>
<li>ReaR version ("/usr/sbin/rear -V"):<br />
<code>Relax-and-Recover 2.6 / 2020-06-17</code></li>
<li>If your ReaR version is not the current version, explain why you
    can't upgrade:<br />
    Enviroment has no direct internet access. Limited to a
    Nexus-Repository only.</li>
<li>OS version ("cat /etc/os-release" or "lsb_release -a" or "cat
    /etc/rear/os.conf"):<br />
    NAME="Rocky Linux"<br />
    VERSION="8.9 (Green Obsidian)"<br />
    ID="rocky"<br />
    ID_LIKE="rhel centos fedora"<br />
    VERSION_ID="8.9"<br />
    PLATFORM_ID="platform:el8"<br />
    PRETTY_NAME="Rocky Linux 8.9 (Green Obsidian)"<br />
    ANSI_COLOR="0;32"<br />
    LOGO="fedora-logo-icon"<br />
    CPE_NAME="cpe:/o:rocky:rocky:8:GA"<br />
    HOME_URL="<a href="https://rockylinux.org/">https://rockylinux.org/</a>"<br />
    BUG_REPORT_URL="<a href="https://bugs.rockylinux.org/">https://bugs.rockylinux.org/</a>"<br />
    SUPPORT_END="2029-05-31"<br />
    ROCKY_SUPPORT_PRODUCT="Rocky-Linux-8"<br />
    ROCKY_SUPPORT_PRODUCT_VERSION="8.9"<br />
    REDHAT_SUPPORT_PRODUCT="Rocky Linux"<br />
    REDHAT_SUPPORT_PRODUCT_VERSION="8.9"</li>
<li>ReaR configuration files ("cat /etc/rear/site.conf" and/or "cat
    /etc/rear/local.conf"):<br />
    OUPUT=ISO<br />
    BACKUP=NETFS<br />
    BACKUP_PROG_EXCLUDE=('/tmp/<em>' '/media/</em>' '/mnt/<em>' '/dev/shm/</em>')<br />
    UEFI_BOOTLOADER=/boot/efi/EFI/rocky/grubx64.efi<br />
    SECURE_BOOT_BOOTLOADER="/boot/efi/EFI/rocky/shimx64.efi"<br />
    USE_STATIC_NETWORKING=y<br />
    BACKUP_URL=nfs://10.160.148.128/backups/lukstest2</li>
<li>Hardware vendor/product (PC or PowerNV BareMetal or ARM) or VM (KVM
    guest or PowerVM LPAR):<br />
    ESXi 7.0 U2 VM</li>
<li>System architecture (x86 compatible or PPC64/PPC64LE or what exact
    ARM device):<br />
    x86-64</li>
<li>Firmware (BIOS or UEFI or Open Firmware) and bootloader (GRUB or
    ELILO or Petitboot):<br />
    UEFI Secure boot enabled</li>
<li>Storage (local disk or SSD) and/or SAN (FC or iSCSI or FCoE) and/or
    multipath (DM or NVMe):<br />
    Local VMHD</li>
<li>Storage layout ("lsblk -ipo
    NAME,KNAME,PKNAME,TRAN,TYPE,FSTYPE,LABEL,SIZE,MOUNTPOINT"):</li>
</ul>
<!-- -->

<pre><code>NAME                               KNAME     PKNAME    TRAN   TYPE  FSTYPE      LABEL                 SIZE MOUNTPOINT
/dev/sda                           /dev/sda                   disk                                    256G 
|-/dev/sda1                        /dev/sda1 /dev/sda         part  vfat                                1G /boot/efi
|-/dev/sda2                        /dev/sda2 /dev/sda         part  ext4                                1G /boot
`-/dev/sda3                        /dev/sda3 /dev/sda         part  crypto_LUKS STEELUKS              254G 
  `-/dev/mapper/luks-76ff4e74-cb27-47d8-b846-a3b6a600fa9e
                                   /dev/dm-0 /dev/sda3        crypt LVM2_member                       254G 
    |-/dev/mapper/rl-root          /dev/dm-1 /dev/dm-0        lvm   ext4                               50G /
    |-/dev/mapper/rl-swap          /dev/dm-2 /dev/dm-0        lvm   swap                               16G [SWAP]
    |-/dev/mapper/rl-home          /dev/dm-3 /dev/dm-0        lvm   ext4                               33G /home
    |-/dev/mapper/rl-var           /dev/dm-4 /dev/dm-0        lvm   ext4                               20G /var
    |-/dev/mapper/rl-var_log       /dev/dm-5 /dev/dm-0        lvm   ext4                               20G /var/log
    |-/dev/mapper/rl-var_tmp       /dev/dm-6 /dev/dm-0        lvm   ext4                               20G /var/tmp
    |-/dev/mapper/rl-var_log_audit /dev/dm-7 /dev/dm-0        lvm   ext4                               20G /var/log/audit
    `-/dev/mapper/rl-tmp           /dev/dm-8 /dev/dm-0        lvm   ext4                               75G /tmp
</code></pre>
<ul>
<li>Description of the issue (ideally so that others can reproduce
    it):<br />
    I have a LUKS encrypted LVM that can be successfully captured and
    restored using rear. The problem is when I use
    <code>clevis luks bind -d /dev/sda2 tang '{"url":"http://tang.srv"}'</code> to
    enable NBDE unlocking the rear restore no longer works. After using
    clevis to bind the key you have to run dracut in order for the VM to
    boot properly as described
    <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/security_hardening/configuring-automated-unlocking-of-encrypted-volumes-using-policy-based-decryption_security-hardening#configuring-manual-enrollment-of-volumes-using-clevis_configuring-automated-unlocking-of-encrypted-volumes-using-policy-based-decryption">here</a>.</li>
</ul>
<p>I can capture a backup and restore the image but upon reboot the error I
receive is:<br />
<code>dracut-initqueue[683]: Failed to start systemd-cryptsetup@luks\x2d....service: Unit systemd-cryptsetup@lus\x2d.....service not found</code><br />
<code>Dependency failed for cryptography Setup for luks-...</code><br />
I went through this <a href="https://github.com/rear/rear/issues/2509">post</a> but
my UUIDs in the crypttab matched fine. I even set a partlabel on the
working VM LUKS partition and modified the crypttab to use PARTLABEL=
instead of UUID but that did not work either. Is there a module that is
not getting put into the initrd upon restore?</p>
<ul>
<li>Attachments, as applicable ("rear -D mkrescue/mkbackup/recover"
    debug log files):<br />
<a href="https://github.com/rear/rear/files/14203149/rear-mkbackup.log">rear-mkbackup.log</a></li>
</ul>
<h4 id="herpgon_commented_at_2024-02-09_2147"><img src="https://avatars.githubusercontent.com/u/52363466?v=4" width="50"><a href="https://github.com/Herpgon">Herpgon</a> commented at <a href="https://github.com/rear/rear/issues/3147#issuecomment-1936648404">2024-02-09 21:47</a>:<a class="headerlink" href="#herpgon_commented_at_2024-02-09_2147" title="Permanent link">&para;</a></h4>
<p>I just wanted to update that I found a workaround for this issue by
using the PRE_BACKUP_SCRIPT and POST_BACKUP_SCRIPT settings. The pre
script unbinds the tang key and then the post script adds it back. Seems
to work well.</p>
<p>The PRE_BACKUP_SCRIPT is set to run right before the backup phase from
what I understand. I needed it to happen earlier in the process. I
changed the name and moved
/usr/share/rear/backup/default/010_pre_backup_script.sh to
/usr/share/rear/init/default/001_pre_backup_script.sh and this ran
the script earlier in the process and I was able to achieve the outcome
that is needed. If there is a better way to change the order of
processes, then please let me know.</p>
<p>Thanks</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2025 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2024-02-08.3147.issue.open.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/rear/rear-user-guide" class="fa fa-code-fork" style="color: #fcfcfc"> rear/rear-user-guide</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
