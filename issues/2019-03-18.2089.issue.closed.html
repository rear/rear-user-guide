<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#2089 Issue closed: Error() from subshell does not exit so that arbitrary further commands are run - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#2089 Issue closed: Error() from subshell does not exit so that arbitrary further commands are run";
        var mkdocs_page_input_path = "issues/2019-03-18.2089.issue.closed.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/backup_netfs.html">Example of BACKUP=NETFS</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/netfs_nas.html">Internal Backup with tar to NFS server</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/netfs_rsync.html">Internal Backup with rsync to NFS server</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/rsync.html">External Backup using BACKUP=RSYNC method</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/rbme.html">External Backup using RBME</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/restic.html">External Backup using restic</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/duplicity.html">External Backup using duplicity</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../development/squash-git-log-commments.html">How to squash git log comments into one line</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear29.html">Release Notes ReaR 2.9</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear28.html">Release Notes ReaR 2.8</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#2089 Issue closed: Error() from subshell does not exit so that arbitrary further commands are run</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="2089_issue_closed_error_from_subshell_does_not_exit_so_that_arbitrary_further_commands_are_run"><a href="https://github.com/rear/rear/issues/2089">#2089 Issue</a> <code>closed</code>: Error() from subshell does not exit so that arbitrary further commands are run<a class="headerlink" href="#2089_issue_closed_error_from_subshell_does_not_exit_so_that_arbitrary_further_commands_are_run" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>fixed / solved / done</code>, <code>critical / security / legal</code></p>
<h4 id="jsmeix_opened_issue_at_2019-03-18_1244"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> opened issue at <a href="https://github.com/rear/rear/issues/2089">2019-03-18 12:44</a>:<a class="headerlink" href="#jsmeix_opened_issue_at_2019-03-18_1244" title="Permanent link">&para;</a></h4>
<ul>
<li>
<p>ReaR version ("/usr/sbin/rear -V"):<br />
    current GitHub master code</p>
</li>
<li>
<p>Description of the issue (ideally so that others can reproduce it):</p>
</li>
</ul>
<p>When the Error function is called from code in<br />
layout/save/GNU/Linux/200_partition_layout.sh<br />
it does not error out where the Error function is called<br />
but instead it continues and shows more and more errors, cf.<br />
<a href="https://github.com/rear/rear/issues/2087#issuecomment-473884096">https://github.com/rear/rear/issues/2087#issuecomment-473884096</a></p>
<p>I think this is not how it should behave.<br />
I would expect that ReaR always aborts at the first Error function call.</p>
<p>To reproduce it change in usr/share/rear/lib/layout-functions.sh<br />
the get_partition_number() function to</p>
<pre><code> get_partition_number() {
     local partition=$1
     LogPrint "called get_partition_number with partition=$partition but using partition=mmcblk0boot0"
     partition="mmcblk0boot0"
    ...
</code></pre>
<p>and then run <code>usr/sbin/rear -D mkrescue</code> which results output like<br />
(depending on how many storage objects one has):</p>
<pre><code># usr/sbin/rear -D mkrescue
Relax-and-Recover 2.4 / Git
Running rear mkrescue (PID 22678)
Using log file: /root/rear.github.master/var/log/rear/rear-g243.log
Using UEFI Boot Loader for Linux (USING_UEFI_BOOTLOADER=1)
Using autodetected kernel '/boot/vmlinuz-4.12.14-lp150.12.25-default' as kernel in the recovery system
Creating disk layout
called get_partition_number with partition=sda1 but using partition=mmcblk0boot0
ERROR: Partition number '0' of partition mmcblk0boot0 is not a valid number.
Some latest log messages since the last called script 200_partition_layout.sh:
  2019-03-18 13:34:09.355052399 Including layout/save/GNU/Linux/200_partition_layout.sh
  2019-03-18 13:34:09.356037030 Entering debugscripts mode via 'set -x'.
  2019-03-18 13:34:09.366840669 Saving disk partitions.
  2019-03-18 13:34:09.413910975 called get_partition_number with partition=sda1 but using partition=mmcblk0boot0
called get_partition_number with partition=sda2 but using partition=mmcblk0boot0
ERROR: Partition number '0' of partition mmcblk0boot0 is not a valid number.
Some latest log messages since the last called script 200_partition_layout.sh:
  Trace 2: /root/rear.github.master/usr/share/rear/lib/framework-functions.sh:116 SourceStage
  Trace 3: /root/rear.github.master/usr/share/rear/lib/framework-functions.sh:56 Source
  Trace 4: /root/rear.github.master/usr/share/rear/layout/save/GNU/Linux/200_partition_layout.sh:323 source
  Trace 5: /root/rear.github.master/usr/share/rear/layout/save/GNU/Linux/200_partition_layout.sh:74 extract_partitions
  Trace 6: /root/rear.github.master/usr/share/rear/lib/layout-functions.sh:355 get_partition_number
  Trace 7: /root/rear.github.master/usr/share/rear/lib/_input-output-functions.sh:485 StopIfError
  === End stack trace ===
  2019-03-18 13:34:10.438831655 called get_partition_number with partition=sda2 but using partition=mmcblk0boot0
called get_partition_number with partition=sda3 but using partition=mmcblk0boot0
ERROR: Partition number '0' of partition mmcblk0boot0 is not a valid number.
Some latest log messages since the last called script 200_partition_layout.sh:
  Trace 2: /root/rear.github.master/usr/share/rear/lib/framework-functions.sh:116 SourceStage
  Trace 3: /root/rear.github.master/usr/share/rear/lib/framework-functions.sh:56 Source
  Trace 4: /root/rear.github.master/usr/share/rear/layout/save/GNU/Linux/200_partition_layout.sh:323 source
  Trace 5: /root/rear.github.master/usr/share/rear/layout/save/GNU/Linux/200_partition_layout.sh:74 extract_partitions
  Trace 6: /root/rear.github.master/usr/share/rear/lib/layout-functions.sh:355 get_partition_number
  Trace 7: /root/rear.github.master/usr/share/rear/lib/_input-output-functions.sh:485 StopIfError
  === End stack trace ===
  2019-03-18 13:34:10.438831655 called get_partition_number with partition=sda2 but using partition=mmcblk0boot0
called get_partition_number with partition=sdb1 but using partition=mmcblk0boot0
ERROR: Partition number '0' of partition mmcblk0boot0 is not a valid number.
Some latest log messages since the last called script 200_partition_layout.sh:
  Trace 2: /root/rear.github.master/usr/share/rear/lib/framework-functions.sh:116 SourceStage
  Trace 3: /root/rear.github.master/usr/share/rear/lib/framework-functions.sh:56 Source
  Trace 4: /root/rear.github.master/usr/share/rear/layout/save/GNU/Linux/200_partition_layout.sh:323 source
  Trace 5: /root/rear.github.master/usr/share/rear/layout/save/GNU/Linux/200_partition_layout.sh:74 extract_partitions
  Trace 6: /root/rear.github.master/usr/share/rear/lib/layout-functions.sh:355 get_partition_number
  Trace 7: /root/rear.github.master/usr/share/rear/lib/_input-output-functions.sh:485 StopIfError
  === End stack trace ===
  2019-03-18 13:34:10.438831655 called get_partition_number with partition=sda2 but using partition=mmcblk0boot0
called get_partition_number with partition=sdb2 but using partition=mmcblk0boot0
ERROR: Partition number '0' of partition mmcblk0boot0 is not a valid number.
Some latest log messages since the last called script 200_partition_layout.sh:
  Trace 2: /root/rear.github.master/usr/share/rear/lib/framework-functions.sh:116 SourceStage
  Trace 3: /root/rear.github.master/usr/share/rear/lib/framework-functions.sh:56 Source
  Trace 4: /root/rear.github.master/usr/share/rear/layout/save/GNU/Linux/200_partition_layout.sh:323 source
  Trace 5: /root/rear.github.master/usr/share/rear/layout/save/GNU/Linux/200_partition_layout.sh:74 extract_partitions
  Trace 6: /root/rear.github.master/usr/share/rear/lib/layout-functions.sh:355 get_partition_number
  Trace 7: /root/rear.github.master/usr/share/rear/lib/_input-output-functions.sh:485 StopIfError
  === End stack trace ===
  2019-03-18 13:34:10.438831655 called get_partition_number with partition=sda2 but using partition=mmcblk0boot0
called get_partition_number with partition=sdb3 but using partition=mmcblk0boot0
ERROR: Partition number '0' of partition mmcblk0boot0 is not a valid number.
Some latest log messages since the last called script 200_partition_layout.sh:
  Trace 2: /root/rear.github.master/usr/share/rear/lib/framework-functions.sh:116 SourceStage
  Trace 3: /root/rear.github.master/usr/share/rear/lib/framework-functions.sh:56 Source
  Trace 4: /root/rear.github.master/usr/share/rear/layout/save/GNU/Linux/200_partition_layout.sh:323 source
  Trace 5: /root/rear.github.master/usr/share/rear/layout/save/GNU/Linux/200_partition_layout.sh:74 extract_partitions
  Trace 6: /root/rear.github.master/usr/share/rear/lib/layout-functions.sh:355 get_partition_number
  Trace 7: /root/rear.github.master/usr/share/rear/lib/_input-output-functions.sh:485 StopIfError
  === End stack trace ===
  2019-03-18 13:34:10.438831655 called get_partition_number with partition=sda2 but using partition=mmcblk0boot0
called get_partition_number with partition=sdb5 but using partition=mmcblk0boot0
ERROR: Partition number '0' of partition mmcblk0boot0 is not a valid number.
Some latest log messages since the last called script 200_partition_layout.sh:
  Trace 2: /root/rear.github.master/usr/share/rear/lib/framework-functions.sh:116 SourceStage
  Trace 3: /root/rear.github.master/usr/share/rear/lib/framework-functions.sh:56 Source
  Trace 4: /root/rear.github.master/usr/share/rear/layout/save/GNU/Linux/200_partition_layout.sh:323 source
  Trace 5: /root/rear.github.master/usr/share/rear/layout/save/GNU/Linux/200_partition_layout.sh:74 extract_partitions
  Trace 6: /root/rear.github.master/usr/share/rear/lib/layout-functions.sh:355 get_partition_number
  Trace 7: /root/rear.github.master/usr/share/rear/lib/_input-output-functions.sh:485 StopIfError
  === End stack trace ===
  2019-03-18 13:34:10.438831655 called get_partition_number with partition=sda2 but using partition=mmcblk0boot0
called get_partition_number with partition=sdb6 but using partition=mmcblk0boot0
ERROR: Partition number '0' of partition mmcblk0boot0 is not a valid number.
Some latest log messages since the last called script 200_partition_layout.sh:
  Trace 2: /root/rear.github.master/usr/share/rear/lib/framework-functions.sh:116 SourceStage
  Trace 3: /root/rear.github.master/usr/share/rear/lib/framework-functions.sh:56 Source
  Trace 4: /root/rear.github.master/usr/share/rear/layout/save/GNU/Linux/200_partition_layout.sh:323 source
  Trace 5: /root/rear.github.master/usr/share/rear/layout/save/GNU/Linux/200_partition_layout.sh:74 extract_partitions
  Trace 6: /root/rear.github.master/usr/share/rear/lib/layout-functions.sh:355 get_partition_number
  Trace 7: /root/rear.github.master/usr/share/rear/lib/_input-output-functions.sh:485 StopIfError
  === End stack trace ===
  2019-03-18 13:34:10.438831655 called get_partition_number with partition=sda2 but using partition=mmcblk0boot0
called get_partition_number with partition=sdb7 but using partition=mmcblk0boot0
ERROR: Partition number '0' of partition mmcblk0boot0 is not a valid number.
Some latest log messages since the last called script 200_partition_layout.sh:
  Trace 2: /root/rear.github.master/usr/share/rear/lib/framework-functions.sh:116 SourceStage
  Trace 3: /root/rear.github.master/usr/share/rear/lib/framework-functions.sh:56 Source
  Trace 4: /root/rear.github.master/usr/share/rear/layout/save/GNU/Linux/200_partition_layout.sh:323 source
  Trace 5: /root/rear.github.master/usr/share/rear/layout/save/GNU/Linux/200_partition_layout.sh:74 extract_partitions
  Trace 6: /root/rear.github.master/usr/share/rear/lib/layout-functions.sh:355 get_partition_number
  Trace 7: /root/rear.github.master/usr/share/rear/lib/_input-output-functions.sh:485 StopIfError
  === End stack trace ===
  2019-03-18 13:34:10.438831655 called get_partition_number with partition=sda2 but using partition=mmcblk0boot0
Aborting due to an error, check /root/rear.github.master/var/log/rear/rear-g243.log for details
Exiting rear mkrescue (PID 22678) and its descendant processes
Running exit tasks
You should also rm -Rf /tmp/rear.UwrqXwBgg0MNI9Q
Terminated
</code></pre>
<p>In my case I have</p>
<pre><code># lsblk -ipo NAME,KNAME,PKNAME,TRAN,TYPE,FSTYPE,SIZE,MOUNTPOINT
NAME        KNAME     PKNAME   TRAN   TYPE FSTYPE   SIZE MOUNTPOINT
/dev/sda    /dev/sda           sata   disk        931.5G 
|-/dev/sda1 /dev/sda1 /dev/sda        part vfat     500M /boot/efi
|-/dev/sda2 /dev/sda2 /dev/sda        part ext4   915.5G /
`-/dev/sda3 /dev/sda3 /dev/sda        part swap    15.6G [SWAP]
/dev/sdb    /dev/sdb           sata   disk        238.5G 
|-/dev/sdb1 /dev/sdb1 /dev/sdb        part         1000M 
|-/dev/sdb2 /dev/sdb2 /dev/sdb        part         1000M 
|-/dev/sdb3 /dev/sdb3 /dev/sdb        part            1K 
|-/dev/sdb5 /dev/sdb5 /dev/sdb        part ext2    1000M /sdb5
|-/dev/sdb6 /dev/sdb6 /dev/sdb        part         1000M 
`-/dev/sdb7 /dev/sdb7 /dev/sdb        part         1000M 
/dev/sr0    /dev/sr0           sata   rom          1024M
</code></pre>
<h4 id="jsmeix_commented_at_2019-03-18_1313"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2089#issuecomment-473904131">2019-03-18 13:13</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-03-18_1313" title="Permanent link">&para;</a></h4>
<p>I can reproduce it in general:</p>
<p>The root cause is when Error is called within a subshell.</p>
<p>At the beginning of init/default/030_update_recovery_system.sh<br />
I added</p>
<pre><code>( Error "Test error 1"
  Error "Test error 2"
  Error "Test error 3"
)
LogPrint "Message after Error"
</code></pre>
<p>and now I got</p>
<pre><code># usr/sbin/rear -D mkrescue
Relax-and-Recover 2.4 / Git
Running rear mkrescue (PID 2810)
Using log file: /root/rear.github.master/var/log/rear/rear-g243.log
ERROR: Test error 1
Some latest log messages since the last called script 030_update_recovery_system.sh:
  2019-03-18 14:11:27.326733922 Including init/default/030_update_recovery_system.sh
  2019-03-18 14:11:27.327588697 Entering debugscripts mode via 'set -x'.
ERROR: Test error 2
Some latest log messages since the last called script 030_update_recovery_system.sh:
  ===== Stack trace =====
                     END { for (i=NR; i&gt;0;) print "Trace "NR-i": "l[i--] }
                   '
  Trace 0: usr/sbin/rear:509 main
  Trace 1: /root/rear.github.master/usr/share/rear/lib/framework-functions.sh:116 SourceStage
  Trace 2: /root/rear.github.master/usr/share/rear/lib/framework-functions.sh:56 Source
  Trace 3: /root/rear.github.master/usr/share/rear/init/default/030_update_recovery_system.sh:12 source
  === End stack trace ===
ERROR: Test error 3
Some latest log messages since the last called script 030_update_recovery_system.sh:
  ===== Stack trace =====
                     END { for (i=NR; i&gt;0;) print "Trace "NR-i": "l[i--] }
                   '
  Trace 0: usr/sbin/rear:509 main
  Trace 1: /root/rear.github.master/usr/share/rear/lib/framework-functions.sh:116 SourceStage
  Trace 2: /root/rear.github.master/usr/share/rear/lib/framework-functions.sh:56 Source
  Trace 3: /root/rear.github.master/usr/share/rear/init/default/030_update_recovery_system.sh:12 source
  === End stack trace ===
Aborting due to an error, check /root/rear.github.master/var/log/rear/rear-g243.log for details
Exiting rear mkrescue (PID 2810) and its descendant processes
Running exit tasks
Terminated
</code></pre>
<p>Inspecting the log shows that</p>
<pre><code># cat -n /root/rear.github.master/var/log/rear/rear-g243.log | egrep '+ Error |USR1|EXIT_FAIL_MESSAGE|DoExitTasks'
   137  ++ Error 'Test error 1'
   168  ++ kill -USR1 3865
   170  ++ Error 'Test error 2'
   207  ++ kill -USR1 3865
   209  ++ Error 'Test error 3'
   246  ++ kill -USR1 3865
   248  +++ EXIT_FAIL_MESSAGE=0
   251  +++ DoExitTasks
</code></pre>
<p>the actual abort/exit happens only at the end,<br />
I assume after the subshell is finished.<br />
There is only one <code>DoExitTasks</code> (regardless that Error was called three
times).</p>
<h4 id="jsmeix_commented_at_2019-03-18_1315"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2089#issuecomment-473904958">2019-03-18 13:15</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-03-18_1315" title="Permanent link">&para;</a></h4>
<p>@schlomo @gdha @gozora @schabrolles @rmetrich<br />
can one of you explain to me why it behaves this way?</p>
<p>I run it on openSUSE Leap 15.0 with <code>GNU bash, version 4.4.23</code></p>
<h4 id="jsmeix_commented_at_2019-03-18_1326"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2089#issuecomment-473908710">2019-03-18 13:26</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-03-18_1326" title="Permanent link">&para;</a></h4>
<p>Currently only a blind guess from what the log excerpts in<br />
<a href="https://github.com/rear/rear/issues/2089#issuecomment-473904131">https://github.com/rear/rear/issues/2089#issuecomment-473904131</a><br />
indicate:</p>
<pre><code>the actual abort/exit happens only at the end,
I assume after the subshell is finished
</code></pre>
<p>When Error is called it does <code>kill -USR1 $MASTER_PID</code> where<br />
that USR1 has a trap (see lib/_input-output-functions.sh)<br />
that does <code>kill $MASTER_PID</code> whicht triggers another trap on EXIT<br />
that calls DoExitTasks()</p>
<p>When Error is called multiple times from within a subshell<br />
the USR1 is sent multiple times to $MASTER_PID (i.e. to
usr/sbin/rear)<br />
but nothing happens at $MASTER_PID because it waits until its<br />
child subshell process is finished and after the subshell is finished<br />
$MASTER_PID processes USR1 immediately.</p>
<h4 id="jsmeix_commented_at_2019-03-18_1329"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2089#issuecomment-473909804">2019-03-18 13:29</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-03-18_1329" title="Permanent link">&para;</a></h4>
<p>@rear/contributors<br />
do you have an idea how to "wake up" $MASTER_PID<br />
from an Error function call that happens within a subshell?</p>
<h4 id="jsmeix_commented_at_2019-03-18_1356"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2089#issuecomment-473919956">2019-03-18 13:56</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-03-18_1356" title="Permanent link">&para;</a></h4>
<p>It seems it helps a bit to do</p>
<pre><code>    ...
    kill -USR1 $MASTER_PID
    if test $BASH_SUBSHELL -gt 0 ; then
        LogPrint "Exiting subshell $BASH_SUBSHELL"
        exit 0
    fi
}
</code></pre>
<p>at the end of the Error function.</p>
<p>That works for me for Error not in a subshells and for Error in a first
subshell.</p>
<p>But it does not work for Error in a second level subshell as in</p>
<pre><code>( LogPrint "First subshell"
  ( LogPrint "Second subshell"
    Error "Test error a"
    Error "Test error b"
  )
  Error "Test error 1"
  Error "Test error 2"
  LogPrint "Message after second subshell"
)
LogPrint "Message after first subshell"
</code></pre>
<p>which results</p>
<pre><code># usr/sbin/rear -D mkrescue
Relax-and-Recover 2.4 / Git
Running rear mkrescue (PID 12347)
Using log file: /root/rear.github.master/var/log/rear/rear-g243.log
First subshell
Second subshell
ERROR: Test error a
Some latest log messages since the last called script 030_update_recovery_system.sh:
  2019-03-18 15:00:21.617675796 Including init/default/030_update_recovery_system.sh
  2019-03-18 15:00:21.618557211 Entering debugscripts mode via 'set -x'.
  2019-03-18 15:00:21.622298786 First subshell
  2019-03-18 15:00:21.623905894 Second subshell
Exiting subshell 2
ERROR: Test error 1
Some latest log messages since the last called script 030_update_recovery_system.sh:
                     END { for (i=NR; i&gt;0;) print "Trace "NR-i": "l[i--] }
                   '
  Trace 0: usr/sbin/rear:509 main
  Trace 1: /root/rear.github.master/usr/share/rear/lib/framework-functions.sh:116 SourceStage
  Trace 2: /root/rear.github.master/usr/share/rear/lib/framework-functions.sh:56 Source
  Trace 3: /root/rear.github.master/usr/share/rear/init/default/030_update_recovery_system.sh:17 source
  === End stack trace ===
  2019-03-18 15:00:21.635646384 Exiting subshell 2
Exiting subshell 1
Aborting due to an error, check /root/rear.github.master/var/log/rear/rear-g243.log for details
Exiting rear mkrescue (PID 12347) and its descendant processes
Running exit tasks
Terminated
</code></pre>
<p>i.e. at each subshell level its first error is shown.</p>
<h4 id="jsmeix_commented_at_2019-03-18_1420"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2089#issuecomment-473929605">2019-03-18 14:20</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-03-18_1420" title="Permanent link">&para;</a></h4>
<p>The problem with neested subshells is code like that</p>
<pre><code>( LogPrint "First subshell"
  ( LogPrint "Second subshell"
    Error "Test error a"
    Error "Test error b"
  )
  LogPrint "Code in first subshell after second subshell"
  echo "foo" &gt;/tmp/rear_test_file
  LogPrint "$( cat /tmp/rear_test_file )"
  rm -v /tmp/rear_test_file 0&lt;&amp;6 1&gt;&amp;7 2&gt;&amp;8
  LogPrint "End of first subshell"
)
LogPrint "Message after first subshell"
</code></pre>
<p>which results</p>
<pre><code># usr/sbin/rear -D mkrescue
Relax-and-Recover 2.4 / Git
Running rear mkrescue (PID 16123)
Using log file: /root/rear.github.master/var/log/rear/rear-g243.log
First subshell
Second subshell
ERROR: Test error a
Some latest log messages since the last called script 030_update_recovery_system.sh:
  2019-03-18 15:18:44.875866796 Including init/default/030_update_recovery_system.sh
  2019-03-18 15:18:44.876702734 Entering debugscripts mode via 'set -x'.
  2019-03-18 15:18:44.880133608 First subshell
  2019-03-18 15:18:44.881709353 Second subshell
Exiting subshell 2
Code in first subshell after second subshell
foo
removed '/tmp/rear_test_file'
End of first subshell
Aborting due to an error, check /root/rear.github.master/var/log/rear/rear-g243.log for details
Exiting rear mkrescue (PID 16123) and its descendant processes
Running exit tasks
Terminated
</code></pre>
<p>i.e. all code in the first subshell is still executed regadless<br />
of the Error before in the second subshell.<br />
It exits only after the first subshell is exited.</p>
<h4 id="jsmeix_commented_at_2019-03-18_1510"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2089#issuecomment-473951068">2019-03-18 15:10</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-03-18_1510" title="Permanent link">&para;</a></h4>
<p>I think at the end of the Error function<br />
I have to recursively exit all subshells<br />
because if we are in the Error function within a subshell<br />
we cannot return from the Error function to its caller<br />
because that would execute further code of the caller.</p>
<h4 id="jsmeix_commented_at_2019-03-18_1730"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2089#issuecomment-474021193">2019-03-18 17:30</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-03-18_1730" title="Permanent link">&para;</a></h4>
<p>I think in<br />
<a href="https://github.com/rear/rear/pull/2088#issuecomment-474020900">https://github.com/rear/rear/pull/2088#issuecomment-474020900</a><br />
things look better now...</p>
<h4 id="jsmeix_commented_at_2019-03-19_0817"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2089#issuecomment-474240386">2019-03-19 08:17</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-03-19_0817" title="Permanent link">&para;</a></h4>
<p>I made this a critical bug because the current Error() in ReaR behaves
this way<br />
even if currently - as far as I know - there is no actual critical issue
because of this.</p>
<p>With the current Error() behaviour the following code in a script<br />
would destroy data</p>
<pre><code># backup and remove data in subshell
( backup_data || Error "Failed to backup data"
  remove_data
)
</code></pre>
<p>because when <code>backup_data</code> failed in the subshell<br />
Error() does not exit immediately so that <code>remove_data</code> is run<br />
and after the subshell finished it exits but then it is too late.</p>
<h4 id="schlomo_commented_at_2019-03-19_0837"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/issues/2089#issuecomment-474246499">2019-03-19 08:37</a>:<a class="headerlink" href="#schlomo_commented_at_2019-03-19_0837" title="Permanent link">&para;</a></h4>
<p>@jsmeix indeed a lot of complexity added to make up for the fact that
Bash is not a programming language.</p>
<p>First of all congrats on this deep research and the solution that you
found!</p>
<p>Do we have such a big need for erroring out of subshells? Wouldn't the
code be simpler if everybody know that this doesn't work and they they
need to do error handling in the top-level shell process?</p>
<p>Since we don't have unit tests I am afraid that the risk for new bugs in
this extremely complex new code (multi processing is always extremely
complex) is as large as the risk of the bugs that we have without this
complexity.</p>
<p>Reading through this entire issue again I am wondering if maybe <strong>we use
subshells too much</strong>? Maybe a lot of <code>( )</code> cases could be handled by
<code>{ ;}</code> as well? I really would prefer to discuss that question and to
work on reducing the overall complexity in our code.</p>
<p>If and once we switch to a real programming language like Python, then
all of this will be elegantly handled by language features like
exceptions (I am assuming that we won't use Go which believes in
explicit error handling via return values :-)). In the mean time we can
also think about adopting the Go model of explicit error handling, if we
really really need to error out of nested shells.</p>
<h4 id="jsmeix_commented_at_2019-03-19_0920"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2089#issuecomment-474260332">2019-03-19 09:20</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-03-19_0920" title="Permanent link">&para;</a></h4>
<p>Yesterday I was too much in "just hacking that issue out of my way"
mode<br />
but - as always - sleeping over an issue helps ;-)</p>
<p>Now I have a nice clean reproducer on plain command line<br />
(I use the outermost subshell only to not pollute my current bash):</p>
<pre><code># ( export MASTERPID=$BASHPID ; trap "echo $MASTERPID got USR1" USR1 ; ( echo begin subshell $BASHPID parent $MASTERPID ; pstree -Aplau $$ ; kill -USR1 $MASTERPID ; echo sent USR1 to $MASTERPID in subshell ; echo other stuff in subshell ; echo subshell done ) ; echo $MASTERPID done )

begin subshell 26109 parent 26108
bash,21908
  `-bash,26108
      `-bash,26109
          `-pstree,26110 -Aplau 21908
sent USR1 to 26108 in subshell
other stuff in subshell
subshell done
26108 got USR1
26108 done
</code></pre>
<p>One needs a recent bash version that supports BASHPID<br />
(my GNU bash, version 3.2.57 on SLES11 does not).</p>
<p>It shows that the parent waits until its subshell child has finished<br />
and then the parent processes the signal.<br />
This behaviour matches what "man bash" (also for bash 3.x) reads</p>
<pre><code>SIGNALS
...
If bash is waiting for a command to complete
and receives a signal for which a trap has been set,
the trap will not be executed until the command completes.
</code></pre>
<p>What is not 100% clear is that here <code>command</code><br />
not only means <code>simple command</code> but<br />
also means <code>compound command</code> cf. "man bash"</p>
<pre><code>Compound Commands
...
(list) list is executed in a subshell environment ...
</code></pre>
<p>Perhaps somewhere in "man bash" it is defined what <code>command</code> means ;-)</p>
<h4 id="schlomo_commented_at_2019-03-19_0937"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/issues/2089#issuecomment-474267674">2019-03-19 09:37</a>:<a class="headerlink" href="#schlomo_commented_at_2019-03-19_0937" title="Permanent link">&para;</a></h4>
<p>Yes, to the best of my knowledge a subshell behaves like a command in
the parent.</p>
<p>To summarize: I think that you are trying to work against the design of
Bash and therefore your solution is not trivial. You might also try to
look into the process group to kill off stuff (not sure, maybe
<a href="https://github.com/schlomo/kiosk-browser/blob/master/xsession.sh#L11">this</a>
can help for inspiration) and check for running background jobs.</p>
<p>I really do think that in ReaR we have to respect the boundaries of Bash
and rather limit our code constructs to work well within those limits.
Otherwise we raise complexity exponentially without any benefit on the
bit picture level.</p>
<h4 id="jsmeix_commented_at_2019-03-19_0941"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2089#issuecomment-474269231">2019-03-19 09:41</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-03-19_0941" title="Permanent link">&para;</a></h4>
<p>@schlomo<br />
I don't think we use subshells too often but we use<br />
subshells that are much longer than needed as in<br />
layout/save/GNU/Linux/230_filesystem_layout.sh<br />
(here with line numbers)</p>
<pre><code>    76  # Begin of the subshell that appends its stdout to DISKLAYOUT_FILE:
    77  (
...
   163                  StopIfError "Divide by zero detected"
...
   175                  StopIfError "Divide by zero detected"
...
   195                  StopIfError "Failed to save XFS options of $device"
...
   308                          Error "BTRFS_SUBVOLUME_SLES_SETUP is false but $info_message"
...
   509  ) &gt;&gt; $DISKLAYOUT_FILE
   510  # End of the subshell that appends its stdout to DISKLAYOUT_FILE.
</code></pre>
<p>in contrast to the subshells in<br />
layout/prepare/GNU/Linux/100_include_partition_code.sh<br />
that have basically the form</p>
<pre><code>  ( echo "..."
    echo "..."
    ....
    echo "..."
  ) &gt;&gt; $LAYOUT_CODE
</code></pre>
<p>i.e. only simple <code>echo</code> commands in the subshell<br />
and the subshell is not longer than actually needed.</p>
<p>So all our subshells should be checked but that is difficult<br />
because it is difficult to search for subshells in the code<br />
(searching for <code>(</code> and <code>)</code> would not help so much).</p>
<p>I like to have the fundamental functionality in ReaR fail-safe in
general<br />
to be safe against possibly unknowingly inappropriate code in scripts<br />
so that users who adapt the ReaR sctipts do not need to know about<br />
special limitations in our fundamental functionality.</p>
<p>And currently just before the ReaR 2.5 release<br />
I cannot check and clean up all our possibly problematic subshells.</p>
<h4 id="schlomo_commented_at_2019-03-19_1004"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/issues/2089#issuecomment-474279246">2019-03-19 10:04</a>:<a class="headerlink" href="#schlomo_commented_at_2019-03-19_1004" title="Permanent link">&para;</a></h4>
<p>Good example, here a group command with <code>{ ;}</code> is IMHO much much better
suited. It will aggregate the output but the error functions should
"just work"</p>
<h4 id="jsmeix_commented_at_2019-03-21_1043"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2089#issuecomment-475182404">2019-03-21 10:43</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-03-21_1043" title="Permanent link">&para;</a></h4>
<p>With
<a href="https://github.com/rear/rear/pull/2088">https://github.com/rear/rear/pull/2088</a>
merged<br />
this specific issue should be fixed/solved/done.<br />
I.e. now Error() from subshell exits completely<br />
so that arbitrary further commands are no longer run.</p>
<p>Now that part of ReaR's fundamental functionality should work<br />
reasonably fail-safe even in case of awkward code in scripts, e.g. see<br />
<a href="https://github.com/rear/rear/pull/2088#issuecomment-474888371">https://github.com/rear/rear/pull/2088#issuecomment-474888371</a><br />
where "reasonably fail-safe" means we cannot catch<br />
all cases with reasonable effort, e.g. see<br />
<a href="https://github.com/rear/rear/pull/2088#issuecomment-474902999">https://github.com/rear/rear/pull/2088#issuecomment-474902999</a></p>
<p>Regarding "awkward code in scripts":<br />
I think even if we clean up and adjust excessive subshell usage<br />
in all our own ReaR scripts cf.
<a href="https://github.com/rear/rear/issues/2090">https://github.com/rear/rear/issues/2090</a><br />
it would probably not really help us and our users<br />
to avoid that Error() sometimes fails to actually error out<br />
because ReaR calls arbitrary third-party tools (like backup/restore
tools)<br />
where we cannot know what those tools actually do.<br />
Therefore I think ReaR's fundamental functionality should work<br />
reasonably fail-safe in general (as above "reasonably" means<br />
"with reasonable effort").</p>
<p>In this particular case the effort became almost unreasonable for me<br />
in particular yesterday I spent much time on the simple looking task<br />
to "just get my own PID" in bash 3.x that has no $BASHPID, cf.<br />
<a href="https://github.com/rear/rear/blob/master/usr/share/rear/lib/_input-output-functions.sh#L212">https://github.com/rear/rear/blob/master/usr/share/rear/lib/_input-output-functions.sh#L212</a></p>
<p>I would be happy to learn if someone knows a simpler way<br />
how to "get my own PID in bash 3.x" that also works from within<br />
a (possibly nested) subshell (then "get my own subshell PID").</p>
<h4 id="jsmeix_commented_at_2019-03-22_1145"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2089#issuecomment-475590413">2019-03-22 11:45</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-03-22_1145" title="Permanent link">&para;</a></h4>
<p>For documentation to be preserved for the future<br />
as an example of developers life in our time ;-)</p>
<p>Interestingly on command line</p>
<pre><code>mypid=$( bash -c 'echo $PPID' )
</code></pre>
<p>works:</p>
<pre><code># ( echo \$\$ : $$ ; echo PPID : $PPID ; \
    ( echo in subshell ; \
      echo \$\$ : $$ ; echo PPID : $PPID ; \
      echo -n "( bash -c 'echo \$PPID' ) : " ; \
        ( : ; bash -c 'echo $PPID' ) ; \
      echo -n "bash -c 'echo \$PPID' : " ; \
        bash -c 'echo $PPID' ; \
      mypid=$( bash -c 'echo $PPID' ) ; \
        echo "mypid : $mypid" ; \
      cat /proc/self/stat &gt;/tmp/mystsat ; \
      mypid=$( cut -d ' ' -f4 /tmp/mystsat ) ; \
      echo "mypid : $mypid" ; \
      pstree -Aplau $$ ) )

$$ : 3951
PPID : 3948
in subshell
$$ : 3951
PPID : 3948
( bash -c 'echo $PPID' ) : 29829
bash -c 'echo $PPID' : 29828
mypid : 29828
mypid : 29828
bash,3951
  `-bash,29827
      `-bash,29828
          `-pstree,29835 -Aplau 3951
</code></pre>
<p>But <code>mypid=$( bash -c 'echo $PPID' )</code><br />
does no longer work when it is in a sourced script:</p>
<pre><code># cat myscript.sh
( echo \$\$ : $$
  echo PPID : $PPID
  ( echo in subshell
    echo \$\$ : $$
    echo PPID : $PPID
    echo -n "( bash -c 'echo \$PPID' ) : "
    ( : ; bash -c 'echo $PPID' )
    echo -n "bash -c 'echo \$PPID' : "
    bash -c 'echo $PPID'
    mypid=$( bash -c 'echo $PPID' )
    echo "mypid : $mypid"
    cat /proc/self/stat &gt;/tmp/mystsat
    mypid=$( cut -d ' ' -f4 /tmp/mystsat )
    echo "mypid : $mypid"
    pstree -Aplau $$
 )
)

# source myscript.sh
$$ : 3951
PPID : 3948
in subshell
$$ : 3951
PPID : 3948
( bash -c 'echo $PPID' ) : 29793
bash -c 'echo $PPID' : 29792
mypid : 29796
mypid : 29792
bash,3951
  `-bash,29791
      `-bash,29792
          `-pstree,29801 -Aplau 3951
</code></pre>
<p>So it seems</p>
<pre><code>cat /proc/self/stat &gt;/tmp/mystsat
mypid=$( cut -d ' ' -f4 /tmp/mystsat )
</code></pre>
<p>is the only reliable way to "get my own PID" in bash 3.x<br />
that also works from within a (possibly nested) subshell<br />
and then I want to "get my own subshell PID"<br />
that also works in a sourced script.</p>
<h4 id="jsmeix_commented_at_2019-03-26_1144"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2089#issuecomment-476590268">2019-03-26 11:44</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-03-26_1144" title="Permanent link">&para;</a></h4>
<p>A SUSE colleague found the simplest way<br />
to get the current PID without using bsh 4.x $BASHPID:</p>
<pre><code>read current_pid junk &lt;/proc/self/stat
</code></pre>
<p>This also works even in nested subshells in a sourced script<br />
and it is simpler because <code>read</code> is a shell builtin and<br />
the <code>&lt;</code> stdin redirection does not cause another subshell.</p>
<p>FYI<br />
here again my (slightly enhanced) test script as in my<br />
<a href="https://github.com/rear/rear/issues/2089#issuecomment-475590413">https://github.com/rear/rear/issues/2089#issuecomment-475590413</a><br />
and its output results:</p>
<pre><code># cat myscript.sh

( echo in subshell
  echo \$\$ : $$
  echo PPID : $PPID
  ( echo in sub-subshell
    echo \$\$ : $$
    echo PPID : $PPID
    echo -n "( bash -c 'echo \$PPID' ) : "
    ( : ; bash -c 'echo $PPID' )
    echo -n "bash -c 'echo \$PPID' : "
    bash -c 'echo $PPID'
    mypid=$( bash -c 'echo $PPID' )
    echo "bash -c 'echo $PPID' mypid : $mypid"
    cat /proc/self/stat &gt;/tmp/mystsat
    mypid=$( cut -d ' ' -f4 /tmp/mystsat )
    echo "cat /proc/self/stat mypid : $mypid"
    read mypid junk &lt;/proc/self/stat
    echo "read /proc/self/stat mypid : $mypid"
    pstree -Aplau $$
  )
)

# echo $$
3951

# echo $PPID
3948

# source myscript.sh

in subshell
$$ : 3951
PPID : 3948
in sub-subshell
$$ : 3951
PPID : 3948
( bash -c 'echo $PPID' ) : 6732
bash -c 'echo $PPID' : 6731
bash -c 'echo 3948' mypid : 6735
cat /proc/self/stat mypid : 6731
read /proc/self/stat mypid : 6731
bash,3951
  `-bash,6730
      `-bash,6731
          `-pstree,6740 -Aplau 3951
</code></pre>
<h4 id="jsmeix_commented_at_2019-03-26_1536"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2089#issuecomment-476707041">2019-03-26 15:36</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-03-26_1536" title="Permanent link">&para;</a></h4>
<p>Via
<a href="https://github.com/rear/rear/pull/2099">https://github.com/rear/rear/pull/2099</a>
the above<br />
<a href="https://github.com/rear/rear/issues/2089#issuecomment-476590268">https://github.com/rear/rear/issues/2089#issuecomment-476590268</a><br />
is now implemented.</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2025 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2019-03-18.2089.issue.closed.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/rear/rear-user-guide" class="fa fa-code-fork" style="color: #fcfcfc"> rear/rear-user-guide</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
