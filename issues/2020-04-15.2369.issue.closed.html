<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#2369 Issue closed: Set "dd ... bs=1M" blocksize for faster NETFS backup - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#2369 Issue closed: Set \"dd ... bs=1M\" blocksize for faster NETFS backup";
        var mkdocs_page_input_path = "issues/2020-04-15.2369.issue.closed.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#2369 Issue closed: Set "dd ... bs=1M" blocksize for faster NETFS backup</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="2369_issue_closed_set_dd_bs1m_blocksize_for_faster_netfs_backup"><a href="https://github.com/rear/rear/issues/2369">#2369 Issue</a> <code>closed</code>: Set "dd ... bs=1M" blocksize for faster NETFS backup<a class="headerlink" href="#2369_issue_closed_set_dd_bs1m_blocksize_for_faster_netfs_backup" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>enhancement</code>, <code>fixed / solved / done</code></p>
<h4 id="dsamx_opened_issue_at_2020-04-15_1442"><img src="https://avatars.githubusercontent.com/u/31438866?v=4" width="50"><a href="https://github.com/dsamx">dsamx</a> opened issue at <a href="https://github.com/rear/rear/issues/2369">2020-04-15 14:42</a>:<a class="headerlink" href="#dsamx_opened_issue_at_2020-04-15_1442" title="Permanent link">&para;</a></h4>
<h4 id="relax-and-recover_rear_issue_template">Relax-and-Recover (ReaR) Issue Template<a class="headerlink" href="#relax-and-recover_rear_issue_template" title="Permanent link">&para;</a></h4>
<p>Fill in the following items before submitting a new issue<br />
(quick response is not guaranteed with free support):</p>
<ul>
<li>
<p>ReaR version ("/usr/sbin/rear -V"):<br />
    Relax-and-Recover 2.4 / Git<br />
    This is actually the SLES15 SP1 package rear23a-2.3.a-9.6.1.x86_64</p>
</li>
<li>
<p>OS version ("cat /etc/rear/os.conf" or "lsb_release -a" or "cat
    /etc/os-release"):<br />
    NAME="SLES"<br />
    VERSION="15-SP1"<br />
    VERSION_ID="15.1"<br />
    PRETTY_NAME="SUSE Linux Enterprise Server 15 SP1"<br />
    ID="sles"<br />
    ID_LIKE="suse"<br />
    ANSI_COLOR="0;32"<br />
    CPE_NAME="cpe:/o:suse:sles:15:sp1"</p>
</li>
<li>
<p>ReaR configuration files ("cat /etc/rear/site.conf" and/or "cat
    /etc/rear/local.conf"):</p>
</li>
</ul>
<!-- -->

<pre><code>AUTOSHRINK_DISK_SIZE_LIMIT_PERCENTAGE=80

OUTPUT=ISO
KEEP_OLD_OUTPUT_COPY=y

BACKUP=NETFS
BACKUP_URL=cifs://....
BACKUP_OPTIONS="cred=/etc/rear/cifs"
BACKUP_INTEGRITY_CHECK=Y
NETFS_KEEP_OLD_BACKUP_COPY=y

PRE_BACKUP_SCRIPT=(
"rm -rf /data/supportconfig/*;"
"/sbin/supportconfig -Q -c -R /data/supportconfig;"
)
POST_BACKUP_SCRIPT=()
PRE_RECOVERY_SCRIPT=()
POST_RECOVERY_SCRIPT=()

BACKUP_PROG_EXCLUDE=(
"${BACKUP_PROG_EXCLUDE[@]}"
/lost+found/*
/mnt/*
/var/cache/*
/var/tmp/*
)

BACKUP_PROG_INCLUDE=(
/boot/grub2/i386-pc/*
/boot/grub2/x86_64-efi/*
/opt/*
/srv/*
/usr/local/*
/var/lib/libvirt/images/*
/var/lib/machines/*
/var/lib/mailman/*
/var/lib/mariadb/*
/var/lib/mysql/*
/var/lib/named/*
/var/lib/pgsql/*
/var/log/*
/var/opt/*
/var/spool/*
)

REQUIRED_PROGS=(
awk
base64
dialog
diff
dos2unix
lsblk
lsof
lspci
md5sum
mkfs.vfat
mkswap
mount
mount.cifs
mount.fuse
mount.nfs
mount.nfs4
parted
ping
ping6
pstree
renice
rsync
screen
sha256sum
tmux
swapon
touch
vim
vimdiff
traceroute
traceroute6
scp
ssh
watch
snapper
chattr
lsattr
clear
infocmp
reset
tabs
toe
tput
tset
"${REQUIRED_PROGS[@]}"
)

COPY_AS_IS=(
/usr/lib/snapper/installation-helper
/etc/snapper/config-templates/default
"${COPY_AS_IS[@]}"
)

MODULES=( 'all_modules' )
</code></pre>
<ul>
<li>
<p>Hardware (PC or PowerNV BareMetal or ARM) or virtual machine (KVM
    guest or PoverVM LPAR):<br />
    HPE ProLiant 380 Gen10</p>
</li>
<li>
<p>System architecture (x86 compatible or PPC64/PPC64LE or what exact
    ARM device):<br />
    x86_64</p>
</li>
<li>
<p>Firmware (BIOS or UEFI or Open Firmware) and bootloader (GRUB or
    ELILO or Petitboot):<br />
    grub2</p>
</li>
<li>
<p>Storage (local disk or SSD) and/or SAN (FC or iSCSI or FCoE) and/or
    multipath (DM or NVMe):<br />
    local disk, hardware raid</p>
</li>
<li>
<p>Description of the issue (ideally so that others can reproduce
    it):<br />
    The system was supposed to create a tar backup on a cifs mount. The
    problem was that the speed was 500KiB/s to a Windows share on a
    100MBit line. (The server itself has 1GBit bonding but that does not
    matter). During tests we never had such slow speed. We discovered
    that rear basically does the following: tar <files> | dd
    of=backup.tar<br />
    This is the case if no ISO_MAX_SIZE is set, otherwise dd would be
    replaced by split.<br />
    We were able to see in the network traffic that only very small
    packages were sent and ACK'ed by the samba server.<br />
    After adding bs=1M to the dd command the speed was now really fast
    in comparison: it used the full capacity of the line (about
    100MBit/s).</p>
</li>
<li>
<p>Workaround, if any:</p>
</li>
</ul>
<p>We created a one-liner patch that adds bs=1M to the dd command in
usr/share/rear/backup/NETFS/default/500_make_backup.sh which worked
pretty well for us.</p>
<p><a href="https://github.com/rear/rear/files/4481818/blocksize.patch.txt">blocksize.patch.txt</a></p>
<h4 id="jsmeix_commented_at_2020-04-15_1519"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2369#issuecomment-614102992">2020-04-15 15:19</a>:<a class="headerlink" href="#jsmeix_commented_at_2020-04-15_1519" title="Permanent link">&para;</a></h4>
<p>@dsamx<br />
thank you for your explanatory report that makes things very clear<br />
and for your analysis what the root cause was and for your fix!</p>
<p>I did
<a href="https://github.com/rear/rear/pull/2370">https://github.com/rear/rear/pull/2370</a><br />
so that the other ReaR maintainers could have a look.</p>
<p>I always had a vague feeling that making the backup via "rear
mkbackup"<br />
seems to run noticeably slower than restoring it via "rear recover"<br />
but I never analyzed things so perhaps this issue explains it.</p>
<h4 id="jsmeix_commented_at_2020-04-29_1403"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2369#issuecomment-621231553">2020-04-29 14:03</a>:<a class="headerlink" href="#jsmeix_commented_at_2020-04-29_1403" title="Permanent link">&para;</a></h4>
<p>I tested it in my usual testing environment where I run "rear
mkbackup"<br />
in a virtual machine and the backup.tar.gz goes to a NFS server<br />
and that NFS server is on the host where the virtual machine runs<br />
so in my usual testing environment there is no real outer network
used.<br />
Therefore I do not see a big improvement in my testing environment.</p>
<p>Before I had in backup.log from <code>tar</code> and <code>dd</code></p>
<pre><code>Total bytes written: 3065948160 (2.9GiB, 9.7MiB/s)

2379075+1 records in
2379075+1 records out
1218086742 bytes (1.2 GB, 1.1 GiB) copied, 303.749 s, 4.0 MB/s
</code></pre>
<p>and with the added <code>bs=1M</code> I get in backup.log from <code>tar</code> and <code>dd</code></p>
<pre><code>Total bytes written: 3065036800 (2.9GiB, 11MiB/s)

0+74145 records in
0+74145 records out
1217955985 bytes (1.2 GB, 1.1 GiB) copied, 285.225 s, 4.3 MB/s
</code></pre>
<p>The overall <code>time rear mkbackuponly</code><br />
was before 5 minutes 12 seconds<br />
that decreased a bit to 4 minutes 53 seconds.</p>
<p>Nevertheless <code>bs=1M</code> can make things very much faster:</p>
<pre><code># time dd if=/boot/vmlinuz of=/dev/null

14320+1 records in
14320+1 records out
7331952 bytes (7.3 MB, 7.0 MiB) copied, 0.0235268 s, 312 MB/s

real    0m0.025s
user    0m0.017s
sys     0m0.008s

# time dd if=/boot/vmlinuz of=/dev/null bs=1M

6+1 records in
6+1 records out
7331952 bytes (7.3 MB, 7.0 MiB) copied, 0.00251888 s, 2.9 GB/s

real    0m0.004s
user    0m0.000s
sys     0m0.004s

# time dd if=/etc/os-release of=/dev/null

0+1 records in
0+1 records out
265 bytes copied, 7.4226e-05 s, 3.6 MB/s

real    0m0.003s
user    0m0.002s
sys     0m0.000s

# time dd if=/etc/os-release of=/dev/null bs=1M

0+1 records in
0+1 records out
265 bytes copied, 5.8819e-05 s, 4.5 MB/s

real    0m0.002s
user    0m0.000s
sys     0m0.002s
</code></pre>
<p>(on my Intel Core i3-4000M CPU @ 2.40GHz homeoffice laptop)<br />
so adding <code>bs=1M</code> seems to be an improvement in any case<br />
(it gets a bit faster even if less than 512 bytes need to be copied).</p>
<h4 id="jsmeix_commented_at_2020-04-30_1228"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2369#issuecomment-621802301">2020-04-30 12:28</a>:<a class="headerlink" href="#jsmeix_commented_at_2020-04-30_1228" title="Permanent link">&para;</a></h4>
<p>With
<a href="https://github.com/rear/rear/pull/2370">https://github.com/rear/rear/pull/2370</a>
merged<br />
this issue is done.</p>
<p>@dsamx<br />
thank you for your improvement that makes ReaR working better!</p>
<h4 id="jsmeix_commented_at_2020-07-21_0916"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2369#issuecomment-661739038">2020-07-21 09:16</a>:<a class="headerlink" href="#jsmeix_commented_at_2020-07-21_0916" title="Permanent link">&para;</a></h4>
<p>With
<a href="https://github.com/rear/rear/pull/2459">https://github.com/rear/rear/pull/2459</a>
merged<br />
this issue should now be completely fixed.</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2023 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2020-04-15.2369.issue.closed.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
