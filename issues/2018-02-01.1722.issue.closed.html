<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>2018 02 01.1722.issue.closed - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "2018 02 01.1722.issue.closed";
        var mkdocs_page_input_path = "issues/2018-02-01.1722.issue.closed.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/rust.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', '366986045', 'auto');
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a> &raquo;</li>
      <li>2018 02 01.1722.issue.closed</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="1722_issue_closed_cannot_restore_disk_built_on_multipath_md"><a href="https://github.com/rear/rear/issues/1722">#1722 Issue</a> <code>closed</code>: Cannot restore disk built on multipath + md<a class="headerlink" href="#1722_issue_closed_cannot_restore_disk_built_on_multipath_md" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>enhancement</code>, <code>fixed / solved / done</code></p>
<h4 id="rmetrich_opened_issue_at_2018-02-01_1457"><img src="https://avatars.githubusercontent.com/u/1163635?u=36b5e32e1dd55f1ce77cad431a5683fce40a7934&v=4" width="50"><a href="https://github.com/rmetrich">rmetrich</a> opened issue at <a href="https://github.com/rear/rear/issues/1722">2018-02-01 14:57</a>:<a class="headerlink" href="#rmetrich_opened_issue_at_2018-02-01_1457" title="Permanent link">&para;</a></h4>
<h4 id="relax-and-recover_rear_issue_template">Relax-and-Recover (ReaR) Issue Template<a class="headerlink" href="#relax-and-recover_rear_issue_template" title="Permanent link">&para;</a></h4>
<p>Fill in the following items before submitting a new issue<br />
(quick response is not guaranteed with free support):</p>
<ul>
<li>rear version (/usr/sbin/rear -V):</li>
</ul>
<p>rear 2.3</p>
<ul>
<li>OS version (cat /etc/rear/os.conf or lsb_release -a):</li>
</ul>
<p>RHEL 6 or 7</p>
<ul>
<li>rear configuration files (cat /etc/rear/site.conf or cat
    /etc/rear/local.conf):</li>
</ul>
<p>AUTOEXCLUDE_MULTIPATH=n</p>
<ul>
<li>Brief description of the issue:</li>
</ul>
<p>When the system disk consists in a multipath disk + software RAID,
recovering the system if the disk is already partitioned will fail.</p>
<p>This is due to the Software Array being built at boot time, when disks
are discovered. On RHEL, at least, this is done using a udev rule.<br />
Because of the Software Array being built, the multipath map cannot be
created (devices are busy).</p>
<ul>
<li>Work-around, if any:</li>
</ul>
<p>Stop the Software Arrays, and disable the udev rule.</p>
<h4 id="rmetrich_commented_at_2018-02-01_1503"><img src="https://avatars.githubusercontent.com/u/1163635?u=36b5e32e1dd55f1ce77cad431a5683fce40a7934&v=4" width="50"><a href="https://github.com/rmetrich">rmetrich</a> commented at <a href="https://github.com/rear/rear/issues/1722#issuecomment-362292730">2018-02-01 15:03</a>:<a class="headerlink" href="#rmetrich_commented_at_2018-02-01_1503" title="Permanent link">&para;</a></h4>
<p>Some more details below.</p>
<ul>
<li>
<p>rear 2.0 would fail trying to partition the multipath device
    /dev/mpathX</p>
</li>
<li>
<p>rear 2.3 proposes some disk mapping from /dev/mpathX to one of the
    real disk (e.g. /dev/sda), because it believes the disk doesn't
    exist. Later, upon parted running, parted will fail with the
    following error:</p>
</li>
</ul>
<blockquote>
<p>+++ parted -s /dev/sda mklabel msdos<br />
Error: Partition(s) 2 on /dev/sda have been written, but we have been
unable to inform the kernel of the change, probably because it/they
are in use. As a result, the old partition(s) will remain in use. You
should reboot now before making further changes.</p>
</blockquote>
<p>The error is due to the use of /dev/sda by the MD array.</p>
<p>On RHEL, disabling the udev rule
<code>/lib/udev/rules.d/65-md-incremental.rules</code> does the trick, because
arrays will not be constructed automatically anymore<br />
<strong>I don't know for other Linux variants ...</strong></p>
<h4 id="jsmeix_commented_at_2018-02-06_1017"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1722#issuecomment-363376442">2018-02-06 10:17</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-02-06_1017" title="Permanent link">&para;</a></h4>
<p>@rmetrich<br />
regarding "disabling the udev rule
/lib/udev/rules.d/65-md-incremental.rules"<br />
cf. what we already try to do in<br />
usr/share/rear/layout/prepare/GNU/Linux/100_include_partition_code.sh<br />
and see<br />
<a href="https://github.com/rear/rear/commit/ff1bb730d38eb42e2abf866736cf188bef0b8b9b">https://github.com/rear/rear/commit/ff1bb730d38eb42e2abf866736cf188bef0b8b9b</a><br />
and
<a href="https://github.com/rear/rear/issues/533">https://github.com/rear/rear/issues/533</a><br />
how doing such things unconditioned could have<br />
bad consequences on other Linux distributions.</p>
<h4 id="rmetrich_commented_at_2018-02-06_1032"><img src="https://avatars.githubusercontent.com/u/1163635?u=36b5e32e1dd55f1ce77cad431a5683fce40a7934&v=4" width="50"><a href="https://github.com/rmetrich">rmetrich</a> commented at <a href="https://github.com/rear/rear/issues/1722#issuecomment-363380404">2018-02-06 10:32</a>:<a class="headerlink" href="#rmetrich_commented_at_2018-02-06_1032" title="Permanent link">&para;</a></h4>
<p>What is tried in #533 doesn't work for multipath devices, because
multipath devices are currently not "discovered" at boot, leading to the
creation of software raids, and then causing multipath, once loaded to
fail mapping the devices.</p>
<p>I do see 2 solutions:</p>
<ol>
<li>either disable software raid creation at boot completely (using my
    proposed udev rule overloading)</li>
<li>or include multipath support in the initramfs, as it is currently
    done in standard initramfs</li>
</ol>
<h4 id="jsmeix_commented_at_2018-02-06_1036"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1722#issuecomment-363381667">2018-02-06 10:36</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-02-06_1036" title="Permanent link">&para;</a></h4>
<p>@rmetrich<br />
because I have zero experience with multipath<br />
I agree with anything that you do for multipath.</p>
<p>Perhaps @schabrolles could have a look (as time permits)<br />
because he did lots of improvements for multipath in ReaR.</p>
<h4 id="jsmeix_commented_at_2018-02-06_1314"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1722#issuecomment-363418420">2018-02-06 13:14</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-02-06_1314" title="Permanent link">&para;</a></h4>
<p>@schabrolles<br />
I dared to assign this issue to you - even if you may not have time
right now.<br />
I will still have a look but as a multipath-noob I cannot actually help
here<br />
or do a meaningful review of a pull request.</p>
<h4 id="jsmeix_commented_at_2018-06-05_0857"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1722#issuecomment-394634627">2018-06-05 08:57</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-06-05_0857" title="Permanent link">&para;</a></h4>
<p>Because the initial description<br />
<a href="https://github.com/rear/rear/issues/1722#issue-293560693">https://github.com/rear/rear/issues/1722#issue-293560693</a><br />
reads (excerpts):</p>
<pre>
... recovering the system if the disk is already partitioned will fail ...
... at boot time ... [something] ... is done using a udev rule ...
... devices are busy 
</pre>

<p>the actual root cause of this issue is old (meta)-data on the disk<br />
which is known to cause arbitrary kind of weird failures for "rear
recover"<br />
and that ReaR still has no generic "cleanupdisk" script, see<br />
<a href="https://github.com/rear/rear/issues/799">https://github.com/rear/rear/issues/799</a></p>
<p>@rmetrich<br />
could you check in the ReaR recovery system before you run "rear
recover"<br />
what disk device nodes (like /dev/sda) and - even more important -
what<br />
partition device nodes (like /dev/sda1, /dev/sda2, ...) already exist.</p>
<p>Could you test if it helps to run <code>wipefs -a -f</code> for all of them in
reverse ordering,<br />
i.e. first <code>wipefs</code> the partitions starting with the last one<br />
and finally <code>wipefs</code> the disk e.g. like</p>
<pre>
wipefs -a -f /dev/sda2
wipefs -a -f /dev/sda1
wipefs -a -f /dev/sda
</pre>

<p>cf.
<a href="https://github.com/rear/rear/issues/799#issue-141001306">https://github.com/rear/rear/issues/799#issue-141001306</a></p>
<p>Probably to make the old partition device nodes go away<br />
an additional <code>parted /dev/sda mklabel</code> command is needed<br />
cf.
<a href="https://github.com/rear/rear/issues/799#issuecomment-197286229">https://github.com/rear/rear/issues/799#issuecomment-197286229</a></p>
<h4 id="rmetrich_commented_at_2018-06-05_1510"><img src="https://avatars.githubusercontent.com/u/1163635?u=36b5e32e1dd55f1ce77cad431a5683fce40a7934&v=4" width="50"><a href="https://github.com/rmetrich">rmetrich</a> commented at <a href="https://github.com/rear/rear/issues/1722#issuecomment-394746478">2018-06-05 15:10</a>:<a class="headerlink" href="#rmetrich_commented_at_2018-06-05_1510" title="Permanent link">&para;</a></h4>
<p>@jsmeix The issue is not solvable using <code>wipefs</code>.<br />
Indeed, at boot, ReaR deliberated doesn't load the multipath driver,
causing disks to not be mapped by devicemapper-multipath.<br />
However, the MD discovery mechanism still runs automatically (through
the udev rule), causing the device Arrays to be rebuilt automatically,
based on the content of the /etc/mdadm.conf file.<br />
For example, you will have this on SLES12sp3:</p>
<pre><code># cat /etc/mdadm.conf 
DEVICE containers partitions
ARRAY /dev/md0 UUID=2e09978c:ab423fe6:33d5210b:66a86e34
</code></pre>
<p>Causing the <code>/dev/md0</code> array to be built by selecting some disks
matching the UUID, as shown below:</p>
<pre><code># blkid
/dev/sda1: UUID="2e09978c-ab42-3fe6-33d5-210b66a86e34" UUID_SUB="d588af1a-de50-199f-bd5d-caac8f70ea16" LABEL="any:0" TYPE="linux_raid_member" PARTUUID="000d64bb-01"
/dev/sdb1: UUID="2e09978c-ab42-3fe6-33d5-210b66a86e34" UUID_SUB="5cfbaa1a-a277-2979-15c5-e2abb5b49dbc" LABEL="any:0" TYPE="linux_raid_member" PARTUUID="0006447c-01"
/dev/sdc1: UUID="2e09978c-ab42-3fe6-33d5-210b66a86e34" UUID_SUB="d588af1a-de50-199f-bd5d-caac8f70ea16" LABEL="any:0" TYPE="linux_raid_member" PARTUUID="000d64bb-01"
/dev/sdd1: UUID="2e09978c-ab42-3fe6-33d5-210b66a86e34" UUID_SUB="5cfbaa1a-a277-2979-15c5-e2abb5b49dbc" LABEL="any:0" TYPE="linux_raid_member" PARTUUID="0006447c-01"
/dev/md0: UUID="603f8753-f80a-4799-b862-ef2f5968bdb6" TYPE="ext4"
/dev/sr0: UUID="2018-06-05-14-43-15-00" LABEL="RELAXRECOVER" TYPE="iso9660"
</code></pre>
<p>In my case, it selected paths <code>sdd1</code> and <code>sdc1</code>:</p>
<pre><code># cat /proc/mdstat 
Personalities : [raid1] 
md0 : active raid1 sdd1[1] sdc1[0]
      20970368 blocks super 1.0 [2/2] [UU]
      bitmap: 0/1 pages [0KB], 65536KB chunk

unused devices: &lt;none&gt;
</code></pre>
<p>Then, upon running <code>rear recover</code>, Multipath fails to create the
multipath mapping (e.g. <code>/dev/mpatha</code>) because the disks are <strong>busy</strong>
due to the MD being built.</p>
<h4 id="jsmeix_commented_at_2018-06-06_0911"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1722#issuecomment-395001130">2018-06-06 09:11</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-06-06_0911" title="Permanent link">&para;</a></h4>
<p>@rmetrich<br />
thank you so much for your explanatory description<br />
how things behave special in case of multipath.<br />
It helps so much!</p>
<p>If you find time to play around even more with it<br />
I would like to know if you think there is a generic way<br />
how to clean up a used disk so that multipath issues<br />
would no longer happen.</p>
<p>As fas as I see it seems the UUID is the crucial point here<br />
because I assume on an unused disk there is no disk<br />
partition UUID that matches the UUID in /etc/mdadm.conf<br />
so that then no disk array is automatically built.</p>
<p>If my assumtion is right it might be possible to somehow<br />
clean all disk partition UUIDs from a disk as a generic solution<br />
to make an already used disk look as if it was a new disk.</p>
<p>My basic idea behind such a generic "cleanupdisk" script<br />
is to have a single place of code (i.e. one script) that<br />
does all what is needed to make an already used disk<br />
behave same for "rear recover" as a new disk<br />
instead of fixing each particular issue with used disks<br />
at various different places in the code.</p>
<p>But such a generic "cleanupdisk" script is for a future ReaR release.<br />
At least for now your
<a href="https://github.com/rear/rear/pull/1819">https://github.com/rear/rear/pull/1819</a><br />
is perfectly fine.</p>
<h4 id="jsmeix_commented_at_2018-06-06_0932"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1722#issuecomment-395007339">2018-06-06 09:32</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-06-06_0932" title="Permanent link">&para;</a></h4>
<p>@rmetrich<br />
can you explain why this issue is not solvable using <code>wipefs</code> in your
case?</p>
<p>Im my non-multipath case I can clean all disk partition UUIDs<br />
from the disks by using <code>wipefs</code> in the recovery system:</p>
<pre>
RESCUE f121:~ # blkid
/dev/sdb1: UUID="e1996af3-bc9d-46fc-a5fc-a3aac09e63d9" TYPE="ext4" PARTUUID="00070810-01"
/dev/sda1: UUID="b754c8dc-cd7d-42fa-8edc-a69c02c54f68" TYPE="swap" PARTUUID="00046bb9-01"
/dev/sda2: UUID="83a3ba1c-7c87-4249-a0cd-a60c3e41ac8a" UUID_SUB="0e0ab27c-9995-4005-a533-1013dd616675" TYPE="btrfs" PARTUUID="00046bb9-02"
/dev/sr0: UUID="2018-05-09-16-17-41-00" LABEL="RELAXRECOVER" TYPE="iso9660"

RESCUE f121:~ # parted -s /dev/sda unit MiB print
Model: ATA QEMU HARDDISK (scsi)
Disk /dev/sda: 20480MiB
Sector size (logical/physical): 512B/512B
Partition Table: msdos
Disk Flags: 
Number  Start    End       Size      Type     File system     Flags
 1      1.00MiB  1490MiB   1489MiB   primary  linux-swap(v1)  type=83
 2      1490MiB  20480MiB  18990MiB  primary  btrfs           boot, type=83

RESCUE f121:~ # parted -s /dev/sdb unit MiB print
Model: ATA QEMU HARDDISK (scsi)
Disk /dev/sdb: 2048MiB
Sector size (logical/physical): 512B/512B
Partition Table: msdos
Disk Flags: 
Number  Start    End      Size     Type     File system  Flags
 1      1.00MiB  2047MiB  2046MiB  primary  ext4         type=83

RESCUE f121:~ # ls -l /dev/sd*
brw-rw---- 1 root disk 8,  0 Jun  6 09:16 /dev/sda
brw-rw---- 1 root disk 8,  1 Jun  6 09:16 /dev/sda1
brw-rw---- 1 root disk 8,  2 Jun  6 09:16 /dev/sda2
brw-rw---- 1 root disk 8, 16 Jun  6 09:16 /dev/sdb
brw-rw---- 1 root disk 8, 17 Jun  6 09:16 /dev/sdb1

RESCUE f121:~ # wipefs -a -f /dev/sdb1
/dev/sdb1: 2 bytes were erased at offset 0x00000438 (ext4): 53 ef

RESCUE f121:~ # wipefs -a -f /dev/sdb 
/dev/sdb: 2 bytes were erased at offset 0x000001fe (dos): 55 aa

RESCUE f121:~ # wipefs -a -f /dev/sda2
/dev/sda2: 8 bytes were erased at offset 0x00010040 (btrfs): 5f 42 48 52 66 53 5f 4d

RESCUE f121:~ # wipefs -a -f /dev/sda1
/dev/sda1: 10 bytes were erased at offset 0x00000ff6 (swap): 53 57 41 50 53 50 41 43 45 32

RESCUE f121:~ # wipefs -a -f /dev/sda 
/dev/sda: 2 bytes were erased at offset 0x000001fe (dos): 55 aa

RESCUE f121:~ # blkid
/dev/sr0: UUID="2018-05-09-16-17-41-00" LABEL="RELAXRECOVER" TYPE="iso9660"

RESCUE f121:~ # parted -s /dev/sda unit MiB print
Error: /dev/sda: unrecognised disk label
Model: ATA QEMU HARDDISK (scsi)
Disk /dev/sda: 20480MiB
Sector size (logical/physical): 512B/512B
Partition Table: unknown
Disk Flags: 

RESCUE f121:~ # parted -s /dev/sdb unit MiB print
Error: /dev/sdb: unrecognised disk label
Model: ATA QEMU HARDDISK (scsi)
Disk /dev/sdb: 2048MiB
Sector size (logical/physical): 512B/512B
Partition Table: unknown
Disk Flags: 

RESCUE f121:~ # ls -l /dev/sd*
brw-rw---- 1 root disk 8,  0 Jun  6 09:21 /dev/sda
brw-rw---- 1 root disk 8,  2 Jun  6 09:21 /dev/sda2
brw-rw---- 1 root disk 8, 16 Jun  6 09:21 /dev/sdb

RESCUE f121:~ # parted -s /dev/sda mklabel msdos

RESCUE f121:~ # parted -s /dev/sdb mklabel msdos

RESCUE f121:~ # parted -s /dev/sda unit MiB print
Model: ATA QEMU HARDDISK (scsi)
Disk /dev/sda: 20480MiB
Sector size (logical/physical): 512B/512B
Partition Table: msdos
Disk Flags: 
Number  Start  End  Size  Type  File system  Flags

RESCUE f121:~ # parted -s /dev/sdb unit MiB print
Model: ATA QEMU HARDDISK (scsi)
Disk /dev/sdb: 2048MiB
Sector size (logical/physical): 512B/512B
Partition Table: msdos
Disk Flags: 
Number  Start  End  Size  Type  File system  Flags

RESCUE f121:~ # ls -l /dev/sd*
brw-rw---- 1 root disk 8,  0 Jun  6 09:26 /dev/sda
brw-rw---- 1 root disk 8, 16 Jun  6 09:27 /dev/sdb

RESCUE f121:~ # blkid
/dev/sr0: UUID="2018-05-09-16-17-41-00" LABEL="RELAXRECOVER" TYPE="iso9660"
/dev/sdb: PTUUID="000aaa99" PTTYPE="dos"
/dev/sda: PTUUID="00079970" PTTYPE="dos"
</pre>

<p>Now those already used disks look to me as if they were new disks.</p>
<p>But perhaps something subtle is still left somewhere which is the
reason<br />
why <code>wipefs</code> (in reverse ordering) plus <code>parted mklabel msdos</code><br />
are not yet sufficient in case of multipath.</p>
<h4 id="rmetrich_commented_at_2018-06-06_1433"><img src="https://avatars.githubusercontent.com/u/1163635?u=36b5e32e1dd55f1ce77cad431a5683fce40a7934&v=4" width="50"><a href="https://github.com/rmetrich">rmetrich</a> commented at <a href="https://github.com/rear/rear/issues/1722#issuecomment-395090220">2018-06-06 14:33</a>:<a class="headerlink" href="#rmetrich_commented_at_2018-06-06_1433" title="Permanent link">&para;</a></h4>
<p>For MD devices, you first need to stop the array:</p>
<pre><code># mdadm --stop /dev/md0
</code></pre>
<p>Then wiping the partitions and disks effectively works: after executing
<code>rear recover</code> the multipath driver will be brought up and devices
mapped properly.</p>
<p>However, how do want to do this automatic wipe? How will you select the
devices to wipe (you cannot just wipe the output of <code>blkid</code> otherwise
USB keys connected to the host will be wiped also).<br />
Will you wipe based on <code>/var/lib/rear/layout/disklayout.conf</code> ?</p>
<p>Even with wiping, this PR can still be useful in case the admin doesn't
want a real recover but fix some things in the system. I don't know if
this is a ReaR use case however.</p>
<h4 id="jsmeix_commented_at_2018-06-06_1454"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1722#issuecomment-395098205">2018-06-06 14:54</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-06-06_1454" title="Permanent link">&para;</a></h4>
<p>Currently I do not know how to do an automatic wipe.</p>
<p>Currently I am trying to find out if it is possible at all<br />
to generically wipe a disk at least for the common use cases.</p>
<p>I would try to wipe each active (i.e. non-commented) disk in
disklayout.conf<br />
i.e. wipe each disk where diskrestore.sh would do partitioning because<br />
doing partitioning would destroy all existing content on a disk<br />
(current "rear recover" cannot leave some old partitions unchanged<br />
on a disk, cf.
<a href="https://github.com/rear/rear/issues/1681">https://github.com/rear/rear/issues/1681</a>
)<br />
so that things cannot get worse when such a disk is wiped before.</p>
<h4 id="jsmeix_commented_at_2018-06-12_0707"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1722#issuecomment-396488033">2018-06-12 07:07</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-06-12_0707" title="Permanent link">&para;</a></h4>
<p>With
<a href="https://github.com/rear/rear/pull/1819">https://github.com/rear/rear/pull/1819</a>
merged<br />
this issue should be fixed.</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2022 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2018-02-01.1722.issue.closed.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
