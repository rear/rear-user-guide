<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#1731 Issue closed: Possibly destructive 400_autoresize_disks.sh must be completely overhauled - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#1731 Issue closed: Possibly destructive 400_autoresize_disks.sh must be completely overhauled";
        var mkdocs_page_input_path = "issues/2018-02-14.1731.issue.closed.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#1731 Issue closed: Possibly destructive 400_autoresize_disks.sh must be completely overhauled</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="1731_issue_closed_possibly_destructive_400_autoresize_diskssh_must_be_completely_overhauled"><a href="https://github.com/rear/rear/issues/1731">#1731 Issue</a> <code>closed</code>: Possibly destructive 400_autoresize_disks.sh must be completely overhauled<a class="headerlink" href="#1731_issue_closed_possibly_destructive_400_autoresize_diskssh_must_be_completely_overhauled" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>enhancement</code>, <code>bug</code>, <code>cleanup</code>, <code>fixed / solved / done</code></p>
<h4 id="jsmeix_opened_issue_at_2018-02-14_1208"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> opened issue at <a href="https://github.com/rear/rear/issues/1731">2018-02-14 12:08</a>:<a class="headerlink" href="#jsmeix_opened_issue_at_2018-02-14_1208" title="Permanent link">&para;</a></h4>
<p>The 400_autoresize_disks.sh script results possibly destructive data<br />
and therefore that script needs to be completely overhauled.</p>
<p>Related issues are<br />
<a href="https://github.com/rear/rear/issues/102">https://github.com/rear/rear/issues/102</a><br />
see in particular<br />
<a href="https://github.com/rear/rear/issues/102#issuecomment-365243334">https://github.com/rear/rear/issues/102#issuecomment-365243334</a><br />
and<br />
<a href="https://github.com/rear/rear/issues/1718">https://github.com/rear/rear/issues/1718</a></p>
<p>Details:</p>
<p>On my two QEMU/KVM virtual machines I added a sdb for the following
test<br />
whether or not 400_autoresize_disks.sh works fail safe - and it does
not.</p>
<p>On the original system:</p>
<pre>
# parted -s /dev/sdb unit MiB print
Model: ATA QEMU HARDDISK (scsi)
Disk /dev/sdb: 2048MiB
Sector size (logical/physical): 512B/512B
Partition Table: gpt
Number  Start    End      Size    File system     Name   Flags
 1      8.00MiB  808MiB   800MiB  ext2            data1
 2      808MiB   1208MiB  400MiB  linux-swap(v1)  swap1
 3      1208MiB  1408MiB  200MiB  ext2            data2
 4      1408MiB  2008MiB  600MiB  linux-swap(v1)  swap2

# parted -s /dev/sdb unit B print
Model: ATA QEMU HARDDISK (scsi)
Disk /dev/sdb: 2147483648B
Sector size (logical/physical): 512B/512B
Partition Table: gpt
Number  Start        End          Size        File system     Name   Flags
 1      8388608B     847249407B   838860800B  ext2            data1
 2      847249408B   1266679807B  419430400B  linux-swap(v1)  swap1
 3      1266679808B  1476395007B  209715200B  ext2            data2
 4      1476395008B  2105540607B  629145600B  linux-swap(v1)  swap2

# usr/sbin/rear -D mkrescue
...

# cat var/lib/rear/layout/disklayout.conf
...
# Disk /dev/sdb
# Format: disk &lt;devname> &lt;size(bytes)> &lt;partition label type>
#disk /dev/sdb 2147483648 gpt
# Partitions on /dev/sdb
# Format: part &lt;device> &lt;partition size(bytes)> &lt;partition start(bytes)> &lt;partition type|name> &lt;flags> /dev/&lt;partition>
#part /dev/sdb 838860800 8388608 data1 none /dev/sdb1
#part /dev/sdb 419430400 847249408 swap1 none /dev/sdb2
#part /dev/sdb 209715200 1266679808 data2 none /dev/sdb3
#part /dev/sdb 629145600 1476395008 swap2 none /dev/sdb4
...
</pre>

<p>On the replacement system (same kind of virtual machine)<br />
I use a sdb with double size (i.e. now 4 GiB).</p>
<p>In the running ReaR recovery system before "rear recover"<br />
I edited disklayout.conf and enabled the sdb disk and its partitions<br />
and added testing swap entries for my 'swap1' and 'swap2'<br />
to see what 400_autoresize_disks.sh will make of it:</p>
<pre>
...
# Disk /dev/sdb
# Format: disk &lt;devname> &lt;size(bytes)> &lt;partition label type>
disk /dev/sdb 2147483648 gpt
# Partitions on /dev/sdb
# Format: part &lt;device> &lt;partition size(bytes)> &lt;partition start(bytes)> &lt;partition type|name> &lt;flags> /dev/&lt;partition>
part /dev/sdb 838860800 8388608 data1 none /dev/sdb1
part /dev/sdb 419430400 847249408 swap1 none /dev/sdb2
part /dev/sdb 209715200 1266679808 data2 none /dev/sdb3
part /dev/sdb 629145600 1476395008 swap2 none /dev/sdb4
...
# Swap partitions or swap files
# Format: swap &lt;filename> uuid=&lt;uuid> label=&lt;label>
...
swap /dev/sdb2 uuid=12345 label=swap1
swap /dev/sdb4 uuid=23456 label=swap2
</pre>

<p>This is what 400_autoresize_disks.sh made of the sdb partitions:</p>
<pre>
# Partitions on /dev/sdb
# Format: part &lt;device> &lt;partition size(bytes)> &lt;partition start(bytes)> &lt;partition type|name> &lt;flags> /dev/&lt;partition>
part /dev/sdb 2597113036 8388608 data1 none /dev/sdb1
part /dev/sdb 419430400 847249408 swap1 none /dev/sdb2
part /dev/sdb 649278259 1266679808 data2 none /dev/sdb3
part /dev/sdb 629145600 1476395008 swap2 none /dev/sdb4
</pre>

<p>There are two kind of possibly destructive false values now:</p>
<p>1.)<br />
Because swap partition entries are not changed but others are enlarged<br />
now the enlagred data1 partition overlaps with the subsequent swap1
partition.<br />
The enlagred data1 partition ends at byte 2597113036 + 8388608 =
2605501644<br />
and the unchanged swap1 partition starts at byte 847249408<br />
but 847249408 - 2605501644 = -1758252236<br />
i.e. the new enlagred data1 partition overlaps with the unchanged swap1
partition<br />
by 1758252236 bytes (which is exactly the amount of enlagred bytes).</p>
<p>2.)<br />
Because the beginning of the other enlarged data2 partition is not
changed<br />
(only its size is changed) now also the data2 partition overlaps with
the<br />
enlarged data1 partition because the data1 partition ends at byte
2605501644<br />
and the data2 partition still starts at byte 1266679808<br />
but 1266679808 - 2605501644 = -1338821836<br />
i.e. the new enlagred data1 partition overlaps with the new enlagred
data2 partition<br />
by 1338821836 bytes.</p>
<p>Fortunately subsequent scripts that generate diskrestore.sh somehow fix
that<br />
so that the actual parted calls in diskrestore.sh do not have
overlapping<br />
partition data</p>
<pre>
parted -s /dev/sdb mklabel gpt >&2
parted -s /dev/sdb mkpart "'data1'" 2097152B 2599210187B >&2
parted -s /dev/sdb mkpart "'swap1'" 2599211008B 3018641407B >&2
parted -s /dev/sdb mkpart "'data2'" 3018645504B 3667923762B >&2
parted -s /dev/sdb mkpart "'swap2'" 3667927040B 4294950399B >&2
</pre>

<p>so that the actual partitioning result is not wrong</p>
<pre>
# parted -s /dev/sdb unit B print
Model: ATA QEMU HARDDISK (scsi)
Disk /dev/sdb: 4294967296B
Sector size (logical/physical): 512B/512B
Partition Table: gpt
Number  Start        End          Size         File system  Name   Flags
 1      2097152B     2599210495B  2597113344B               data1
 2      2599211008B  3018641407B  419430400B                swap1
 3      3018645504B  3667923967B  649278464B                data2
 4      3667927040B  4294950399B  627023360B                swap2

# parted -s /dev/sdb unit MiB print
Model: ATA QEMU HARDDISK (scsi)
Disk /dev/sdb: 4096MiB
Sector size (logical/physical): 512B/512B
Partition Table: gpt
Number  Start    End      Size     File system  Name   Flags
 1      2.00MiB  2479MiB  2477MiB               data1
 2      2479MiB  2879MiB  400MiB                swap1
 3      2879MiB  3498MiB  619MiB                data2
 4      3498MiB  4096MiB  598MiB                swap2
</pre>

<p>But it is more or less luck or an accident what the actual partitioning
result is<br />
because the actual partitioning result is not what is in
disklayout.conf.</p>
<p>In particular the swap2 partition was shrinked from 600MiB to 598MiB<br />
(not much in practice but "plain wrong" from a logical point of view)<br />
regardless that the new disk has double size.</p>
<p>Or in other words - simply put:<br />
The 400_autoresize_disks.sh script can result plain wrong data in
disklayout.conf.</p>
<h4 id="gdha_commented_at_2018-02-15_1241"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/issues/1731#issuecomment-365915935">2018-02-15 12:41</a>:<a class="headerlink" href="#gdha_commented_at_2018-02-15_1241" title="Permanent link">&para;</a></h4>
<p>@jsmeix Personally I think <em>bug</em> is not completely correct in this case.
It does not break ReaR, therefore, I propose to change the label from
<em>bug</em> to <em>minor bug</em>. Albeit, a difficult nut to crack IMHO to get it
right.<br />
It is the hardest piece of code to write (within ReaR).</p>
<h4 id="jsmeix_commented_at_2018-02-15_1525"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1731#issuecomment-365960554">2018-02-15 15:25</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-02-15_1525" title="Permanent link">&para;</a></h4>
<p>@gdha<br />
personally I think when "rear recover" may result partitioning<br />
that is worse than what it was on the original system<br />
it can be considered as a real bug in ReaR even if the<br />
recreated system also works with the worse partitioning, cf.<br />
<a href="https://github.com/rear/rear/issues/102#issuecomment-150703886">https://github.com/rear/rear/issues/102#issuecomment-150703886</a></p>
<p>I am currently working on it and I think meanwhile I have something<br />
that ensures the recreated partitioning will not be worse.</p>
<p>If things go sufficiently well for me I will do a pull request
tomorrow<br />
so that you can have a look...</p>
<h4 id="jsmeix_commented_at_2018-02-16_1335"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1731#issuecomment-366236492">2018-02-16 13:35</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-02-16_1335" title="Permanent link">&para;</a></h4>
<p>@gdha<br />
I did an "submit early" pull request
<a href="https://github.com/rear/rear/pull/1733">https://github.com/rear/rear/pull/1733</a><br />
so that you (and others) can have an early look what I am doing...</p>
<h4 id="jsmeix_commented_at_2018-02-23_1408"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1731#issuecomment-368018282">2018-02-23 14:08</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-02-23_1408" title="Permanent link">&para;</a></h4>
<p>There is a severe bug in current ReaR master code<br />
at least regarding the size of an extended partition:<br />
<a href="https://github.com/rear/rear/pull/1733#issuecomment-367680598">https://github.com/rear/rear/pull/1733#issuecomment-367680598</a></p>
<p>Now it seems at least in migration mode also<br />
layout/prepare/GNU/Linux/100_include_partition_code.sh<br />
works "possibly destructive" because it can result an<br />
arbitrarily changed partitioning compared to what the user<br />
had confirmed in disklayout.conf that should be set up.</p>
<p>From my point of view it does not actually mitigate the bug<br />
that there is another subsequent user confirmation dialog<br />
where the user has to also confirm the diskrestore.sh script.</p>
<p>If what the user confirmed in disklayout.conf that should be set up<br />
cannot be set up (e.g. because the disk is too small for it)<br />
layout/prepare/GNU/Linux/100_include_partition_code.sh<br />
has to error out (at least in migration mode) so that the user<br />
can adapt disklayout.conf but 100_include_partition_code.sh<br />
must not arbitrarily change the user's confirmed partitioning<br />
to whatever that script "thinks" is best.</p>
<h4 id="jsmeix_commented_at_2018-03-01_1344"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1731#issuecomment-369595333">2018-03-01 13:44</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-03-01_1344" title="Permanent link">&para;</a></h4>
<p>With
<a href="https://github.com/rear/rear/pull/1733">https://github.com/rear/rear/pull/1733</a>
merged<br />
this issue should be (hopefully) fixed, cf.<br />
<a href="https://github.com/rear/rear/pull/1733#issuecomment-369514406">https://github.com/rear/rear/pull/1733#issuecomment-369514406</a></p>
<h4 id="jsmeix_commented_at_2018-03-08_1017"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1731#issuecomment-371444064">2018-03-08 10:17</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-03-08_1017" title="Permanent link">&para;</a></h4>
<p>Only an addedum FYI:<br />
<a href="https://github.com/rear/rear/issues/1718">https://github.com/rear/rear/issues/1718</a><br />
proves what I suspected above in<br />
<a href="https://github.com/rear/rear/issues/1731#issue-297072881">https://github.com/rear/rear/issues/1731#issue-297072881</a><br />
that it is more or less luck or an accident when the actual<br />
partitioning result is not wrong because in case of<br />
<a href="https://github.com/rear/rear/issues/1718">https://github.com/rear/rear/issues/1718</a><br />
things actually went wrong.</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2024 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2018-02-14.1731.issue.closed.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
