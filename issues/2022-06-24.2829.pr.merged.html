<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#2829 PR merged: Set USB_DEVICE_PARTED_LABEL to match format-workflow.sh - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#2829 PR merged: Set USB_DEVICE_PARTED_LABEL to match format-workflow.sh";
        var mkdocs_page_input_path = "issues/2022-06-24.2829.pr.merged.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/backup_netfs.html">Example of BACKUP=NETFS</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/netfs_nas.html">Internal Backup with tar to NFS server</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/netfs_rsync.html">Internal Backup with rsync to NFS server</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/rbme.html">External Backup using RBME</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/restic.html">External Backup using restic</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../development/squash-git-log-commments.html">How to squash git log comments into one line</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear29.html">Release Notes ReaR 2.9</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear28.html">Release Notes ReaR 2.8</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#2829 PR merged: Set USB_DEVICE_PARTED_LABEL to match format-workflow.sh</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="2829_pr_merged_set_usb_device_parted_label_to_match_format-workflowsh"><a href="https://github.com/rear/rear/pull/2829">#2829 PR</a> <code>merged</code>: Set USB_DEVICE_PARTED_LABEL to match format-workflow.sh<a class="headerlink" href="#2829_pr_merged_set_usb_device_parted_label_to_match_format-workflowsh" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>enhancement</code>, <code>cleanup</code>, <code>fixed / solved / done</code>,
<code>minor bug</code></p>
<h4 id="jsmeix_opened_issue_at_2022-06-24_0628"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> opened issue at <a href="https://github.com/rear/rear/pull/2829">2022-06-24 06:28</a>:<a class="headerlink" href="#jsmeix_opened_issue_at_2022-06-24_0628" title="Permanent link">&para;</a></h4>
<ul>
<li>
<p>Type: <strong>Bug Fix</strong></p>
</li>
<li>
<p>Impact: <strong>Normal</strong></p>
</li>
<li>
<p>Reference to related issue (URL):</p>
</li>
</ul>
<p><a href="https://github.com/rear/rear/pull/2828#issuecomment-1164590100">https://github.com/rear/rear/pull/2828#issuecomment-1164590100</a></p>
<ul>
<li>How was this pull request tested?</li>
</ul>
<p>Tested on openSUSE Leap 15.3 laptop with BIOS, see<br />
<a href="https://github.com/rear/rear/pull/2829#issuecomment-1165460982">https://github.com/rear/rear/pull/2829#issuecomment-1165460982</a><br />
and on Red Hat with BIOS, see<br />
<a href="https://github.com/rear/rear/pull/2829#issuecomment-1165470884">https://github.com/rear/rear/pull/2829#issuecomment-1165470884</a><br />
and on on RHEL 8 with UEFI, see<br />
<a href="https://github.com/rear/rear/pull/2829#issuecomment-1165570472">https://github.com/rear/rear/pull/2829#issuecomment-1165570472</a><br />
and on openSUSE Leap 15.3 laptop with UEFI, see<br />
<a href="https://github.com/rear/rear/pull/2829#issuecomment-1166925033">https://github.com/rear/rear/pull/2829#issuecomment-1166925033</a><br />
and subsequent comments</p>
<ul>
<li>Brief description of the changes in this pull request:</li>
</ul>
<p>In format/USB/default/300_format_usb_disk.sh<br />
set USB_DEVICE_PARTED_LABEL to match format-workflow.sh<br />
which means when a format workflow option -b/--bios or -e/--efi was
specified<br />
set USB_DEVICE_PARTED_LABEL to "msdos" or "gpt" accordingly<br />
and when no format workflow option -b/--bios or -e/--efi was specified<br />
it means hybrid boot supporting BIOS and UEFI by default<br />
so USB_DEVICE_PARTED_LABEL must be set to "gpt".</p>
<h4 id="jsmeix_commented_at_2022-06-24_0658"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2829#issuecomment-1165265342">2022-06-24 06:58</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-06-24_0658" title="Permanent link">&para;</a></h4>
<p>It is only a "minor bug" because current ReaR<br />
does usually not "just work out of the box",<br />
cf. "Inappropriate expectations" in<br />
<a href="https://en.opensuse.org/SDB:Disaster_Recovery">https://en.opensuse.org/SDB:Disaster_Recovery</a></p>
<p>So the need to explicitly specify the right</p>
<pre><code>USB_DEVICE_PARTED_LABEL="gpt"
</code></pre>
<p>in etc/rear/local.conf is OK in current ReaR.</p>
<p>The minor bug is that the old default setting</p>
<pre><code>USB_DEVICE_PARTED_LABEL="msdos"
</code></pre>
<p>conflicts with the new default behaviour of what<br />
usr/share/rear/lib/format-workflow.sh<br />
does which is now UEFI and BIOS dual boot<br />
see
<a href="https://github.com/rear/rear/issues/2698">https://github.com/rear/rear/issues/2698</a></p>
<h4 id="jsmeix_commented_at_2022-06-24_0727"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2829#issuecomment-1165286765">2022-06-24 07:27</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-06-24_0727" title="Permanent link">&para;</a></h4>
<p>I fear now things fail in<br />
prep/USB/Linux-i386/340_find_mbr_bin.sh<br />
because with the changes in this pull request<br />
USB_DEVICE_PARTED_LABEL is not set during "rear mkrescue".</p>
<p>Sigh - so many subtle interdependencies everywhere...</p>
<h4 id="jsmeix_commented_at_2022-06-24_0815"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2829#issuecomment-1165323228">2022-06-24 08:15</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-06-24_0815" title="Permanent link">&para;</a></h4>
<p>With my two last commits I try to make it work again<br />
by default at least in some reasonable way<br />
as far as I currently could do it up to now,<br />
see my new description in default.conf</p>
<h4 id="jsmeix_commented_at_2022-06-24_1100"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2829#issuecomment-1165460982">2022-06-24 11:00</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-06-24_1100" title="Permanent link">&para;</a></h4>
<p>I tested on my openSUSE Leap 15.3 homeoffice laptop with BIOS<br />
that with this changes the new default works for me with BIOS<br />
so there should be no regressions with the new default<br />
hybrid UEFI and BIOS dual boot.</p>
<p>I use <code>USB_DEVICE_FILESYSTEM_PERCENTAGE=10</code> only<br />
to make testing faster with my 500GB USB disk.</p>
<pre><code># grep -v '^#' etc/rear/local.conf 
...
OUTPUT=USB
USB_DEVICE_FILESYSTEM_PERCENTAGE=10
BACKUP=NETFS
BACKUP_URL=usb:///dev/disk/by-label/REAR-000
...

# usr/sbin/rear -D format /dev/sdb
...
Running 'format' stage ======================
USB or disk device /dev/sdb is not formatted with ext2/3/4 or btrfs filesystem
Formatting /dev/sdb will remove all currently existing data on that whole device
UserInput -I USB_DEVICE_CONFIRM_FORMAT needed in /root/rear.github.master/usr/share/rear/format/USB/default/200_check_usb_layout.sh line 62
Type exactly 'Yes' to format /dev/sdb with ext3 filesystem
(default 'No' timeout 300 seconds)
Yes
UserInput: No choices - result is 'Yes'
Repartitioning /dev/sdb
Creating partition table of type gpt on /dev/sdb
Making a BIOS bootable device /dev/sdb
Creating BIOS boot partition /dev/sdb1
Setting 'bios_grub' flag on BIOS boot partition /dev/sdb1
Making an EFI bootable device /dev/sdb
Creating EFI system partition /dev/sdb2 with size 1024 MiB aligned at 8 MiB
Setting 'esp' flag on EFI partition /dev/sdb2
Creating ReaR data partition /dev/sdb3 up to 10% of /dev/sdb
Setting 'legacy_boot' flag on ReaR data partition /dev/sdb3
Creating vfat filesystem on EFI system partition on /dev/sdb2
Creating ext3 filesystem with label 'REAR-000' on ReaR data partition /dev/sdb3
Adjusting filesystem parameters on ReaR data partition /dev/sdb3
Exiting rear format (PID 10744) and its descendant processes ...

# parted -s /dev/sdb unit MiB print
Model: TOSHIBA External USB 3.0 (scsi)
Disk /dev/sdb: 476940MiB
Sector size (logical/physical): 512B/512B
Partition Table: gpt
Disk Flags: 
Number  Start    End       Size      File system  Name     Flags
 1      0.02MiB  8.00MiB   7.98MiB                primary  bios_grub
 2      8.00MiB  1032MiB   1024MiB   fat32        primary  boot, esp
 3      1032MiB  47694MiB  46662MiB  ext3         primary  legacy_boot

# usr/sbin/rear -D mkrescue
...
Running 'output' stage ======================
Saved /root/rear.github.master/var/log/rear/rear-linux-h9wr.log as rear/linux-h9wr/20220624.1223/rear-linux-h9wr.log
Making /dev/sdb bootable with syslinux/extlinux
Writing syslinux MBR /usr/share/syslinux/gptmbr.bin of type gpt to /dev/sdb
Exiting rear mkrescue (PID 12843) and its descendant processes ...

# usr/sbin/rear -D mkbackup
...
Saved /root/rear.github.master/var/log/rear/rear-linux-h9wr.log as rear/linux-h9wr/20220624.1225/rear-linux-h9wr.log
No need to update syslinux on /dev/sdb that has version 4.04
Running 'backup' stage ======================
Making backup (using backup method NETFS)
...
Exiting rear mkbackup (PID 5448) and its descendant processes ...

# mount /dev/sdb3 /tmp/sdb3

# find /tmp/sdb3
/tmp/sdb3
/tmp/sdb3/boot
/tmp/sdb3/boot/syslinux
/tmp/sdb3/boot/syslinux/cpuid.c32
/tmp/sdb3/boot/syslinux/hdt.c32
/tmp/sdb3/boot/syslinux/cat.c32
/tmp/sdb3/boot/syslinux/poweroff.com
/tmp/sdb3/boot/syslinux/reboot.c32
/tmp/sdb3/boot/syslinux/rear.help
/tmp/sdb3/boot/syslinux/pci.ids
/tmp/sdb3/boot/syslinux/config.c32
/tmp/sdb3/boot/syslinux/menu.c32
/tmp/sdb3/boot/syslinux/cmd.c32
/tmp/sdb3/boot/syslinux/ldlinux.sys
/tmp/sdb3/boot/syslinux/sysdump.c32
/tmp/sdb3/boot/syslinux/ls.c32
/tmp/sdb3/boot/syslinux/vesamenu.c32
/tmp/sdb3/boot/syslinux/host.c32
/tmp/sdb3/boot/syslinux/message
/tmp/sdb3/boot/syslinux/disk.c32
/tmp/sdb3/boot/syslinux/kbdmap.c32
/tmp/sdb3/boot/syslinux/chain.c32
/tmp/sdb3/boot/syslinux/extlinux.conf
/tmp/sdb3/boot/syslinux/rosh.c32
/tmp/sdb3/boot/syslinux/lua.c32
/tmp/sdb3/lost+found
/tmp/sdb3/rear
/tmp/sdb3/rear/syslinux.cfg
/tmp/sdb3/rear/linux-h9wr
/tmp/sdb3/rear/linux-h9wr/20220624.1225
/tmp/sdb3/rear/linux-h9wr/20220624.1225/backup.log
/tmp/sdb3/rear/linux-h9wr/20220624.1225/syslinux.cfg
/tmp/sdb3/rear/linux-h9wr/20220624.1225/kernel
/tmp/sdb3/rear/linux-h9wr/20220624.1225/initrd.cgz
/tmp/sdb3/rear/linux-h9wr/20220624.1225/rear-linux-h9wr.log
/tmp/sdb3/rear/linux-h9wr/20220624.1225/backup.tar.gz
/tmp/sdb3/rear/linux-h9wr/20220624.1223
/tmp/sdb3/rear/linux-h9wr/20220624.1223/syslinux.cfg
/tmp/sdb3/rear/linux-h9wr/20220624.1223/kernel
/tmp/sdb3/rear/linux-h9wr/20220624.1223/initrd.cgz
/tmp/sdb3/rear/linux-h9wr/20220624.1223/rear-linux-h9wr.log
/tmp/sdb3/linux-h9wr
/tmp/sdb3/linux-h9wr/.lockfile
</code></pre>
<p>I can boot the ReaR recovery from that USB disk<br />
on another rather old laptop that only supports BIOS<br />
and the booted ReaR recovery seems to work normally for me<br />
(i.e. logged in as 'root' and tried this or that commands).</p>
<p>But I cannot actually test "rear recover" because I want<br />
to keep what there currently is on that old laptop.</p>
<p>Currently I cannot test UEFI because I don't have<br />
sufficient test machines available for testing in homeoffice<br />
(currently I need my newer UEFI laptop for other work).</p>
<h4 id="lzaoral_commented_at_2022-06-24_1113"><img src="https://avatars.githubusercontent.com/u/48823770?v=4" width="50"><a href="https://github.com/lzaoral">lzaoral</a> commented at <a href="https://github.com/rear/rear/pull/2829#issuecomment-1165470884">2022-06-24 11:13</a>:<a class="headerlink" href="#lzaoral_commented_at_2022-06-24_1113" title="Permanent link">&para;</a></h4>
<p>@jsmeix thanks! I've also tested this PR in the BIOS setting and
formatting works and rescue boots and recovers fine. I'm testing EFI and
I'll report with the results soon.</p>
<h4 id="jsmeix_commented_at_2022-06-24_1141"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2829#issuecomment-1165491361">2022-06-24 11:41</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-06-24_1141" title="Permanent link">&para;</a></h4>
<p>@lzaoral<br />
thank you so much for your testing!<br />
It helps so much when at least one other person verifies things.<br />
Now I am rather confident that we don't introduce bad regressions<br />
with the new default hybrid UEFI and BIOS dual boot.</p>
<p>I will document possible consequences of that change<br />
in our release notes for ReaR 2.7<br />
which are currently (unfinished) at<br />
<a href="https://github.com/rear/rear.github.com/blob/jsmeix-release-notes-2-7/documentation/release-notes-2-7.md">https://github.com/rear/rear.github.com/blob/jsmeix-release-notes-2-7/documentation/release-notes-2-7.md</a></p>
<p>I tried to boot from my above made USB disk also<br />
on my newer UEFI laptop but I failed to specify<br />
in its rather limited "InsydeH2O UEFI BIOS" [sic!]<br />
(see
<a href="https://www.insyde.com/products">https://www.insyde.com/products</a><br />
they call their UEFI firmware "BIOS")<br />
how to boot from my USB disk.</p>
<p>I have openSUSE Leap 15.3 installed on this laptop<br />
from a USB stick so it must be possible to boot<br />
from an appropriately made USB stick.</p>
<p>My blind guess is the reason is that my current USB disk<br />
is not ready for EFI boot in particular because its ESP is empty:</p>
<pre><code># mount /dev/sdb2 /tmp/sdb2

# find /tmp/sdb2 -ls
        1      4 drwxr-xr-x   2 root     root         4096 Jan  1  1970 /tmp/sdb2
</code></pre>
<p>I will try out how things behave with</p>
<pre><code>USB_BOOTLOADER="grub"
</code></pre>
<h4 id="pcahyna_commented_at_2022-06-24_1150"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/2829#issuecomment-1165497740">2022-06-24 11:50</a>:<a class="headerlink" href="#pcahyna_commented_at_2022-06-24_1150" title="Permanent link">&para;</a></h4>
<blockquote>
<p>my current USB disk<br />
is not ready for EFI boot in particular because its ESP is empty</p>
</blockquote>
<p>this does not look good - does the master branch code (without your
change) behave the same way?</p>
<h4 id="jsmeix_commented_at_2022-06-24_1301"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2829#issuecomment-1165552512">2022-06-24 13:01</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-06-24_1301" title="Permanent link">&para;</a></h4>
<p>With my last two commits here I implemented<br />
<a href="https://github.com/rear/rear/pull/2829/files#r906006257">https://github.com/rear/rear/pull/2829/files#r906006257</a></p>
<h4 id="lzaoral_commented_at_2022-06-24_1322"><img src="https://avatars.githubusercontent.com/u/48823770?v=4" width="50"><a href="https://github.com/lzaoral">lzaoral</a> commented at <a href="https://github.com/rear/rear/pull/2829#issuecomment-1165570472">2022-06-24 13:22</a>:<a class="headerlink" href="#lzaoral_commented_at_2022-06-24_1322" title="Permanent link">&para;</a></h4>
<p>@jsmeix EFI seems to work both with hybrid and <code>--efi</code> USB layout
(though I tested it without the two latest commits). Rescue image boots
fine and the recovered OS also seems to work.</p>
<blockquote>
<p>my current USB disk<br />
is not ready for EFI boot in particular because its ESP is empty</p>
</blockquote>
<p>I've tested it on RHEL 8 and the ESP always contained all the necessary
files so maybe is this problem openSUSE specific? ESP on RHEL 8:</p>
<pre><code># tree /mnt/rear-esp/
/mnt/rear-esp/
└── EFI
    └── BOOT
        ├── BOOTX64.efi
        ├── grub.cfg
        ├── initrd.cgz
        └── kernel
</code></pre>
<p>I've also tested <code>-b</code> layout on a BIOS machine with latest <code>HEAD</code>without
<code>USB_DEVICE_PARTED_LABEL</code> being set and everything worked fine.</p>
<h4 id="jsmeix_commented_at_2022-06-24_1337"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2829#issuecomment-1165584336">2022-06-24 13:37</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-06-24_1337" title="Permanent link">&para;</a></h4>
<p>@lzaoral<br />
again very many thanks for your UEFI testing!</p>
<p>I don't have sufficient UEFI testing hardware<br />
so I cannot sufficiently test UEFI booting.<br />
But that is OK for me because I cannot do<br />
all and everything alone for ReaR in openSUSE and<br />
OUTPUT=USB is not much used in business environments.<br />
So whether or not OUTPUT=USB "just works" with UEFI<br />
has currently no high priority regarding SLES customers<br />
(which may instantly change when a SLES issue appears<br />
from a customer with an official SUSE support contract).<br />
Currently for me the topmost important thing is that<br />
our new UEFI and BIOS dual boot default for OUTPUT=USB<br />
does not cause major regressions.</p>
<h4 id="jsmeix_commented_at_2022-06-24_1349"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2829#issuecomment-1165595287">2022-06-24 13:49</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-06-24_1349" title="Permanent link">&para;</a></h4>
<p>@pcahyna<br />
regarding your<br />
<a href="https://github.com/rear/rear/pull/2829#issuecomment-1165497740">https://github.com/rear/rear/pull/2829#issuecomment-1165497740</a></p>
<p>also with master branch code (without the changes here)<br />
the ESP is empty for me</p>
<h4 id="jsmeix_commented_at_2022-06-24_1350"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2829#issuecomment-1165596680">2022-06-24 13:50</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-06-24_1350" title="Permanent link">&para;</a></h4>
<p>@pcahyna @lzaoral<br />
weekend is approaching so I leave now.<br />
I wish you a relaxed and recovering weekend!</p>
<h4 id="jsmeix_commented_at_2022-06-27_0622"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2829#issuecomment-1166925033">2022-06-27 06:22</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-06-27_0622" title="Permanent link">&para;</a></h4>
<p>I am testing on my newer openSUSE Leap 15.3 homeoffice laptop with
UEFI<br />
that with this changes the new default works for me with UEFI:</p>
<pre><code># cat etc/rear/local.conf 
...
OUTPUT=USB
USB_DEVICE_FILESYSTEM_PERCENTAGE=10
BACKUP=NETFS
BACKUP_URL=usb:///dev/disk/by-label/REAR-000
...

# usr/sbin/rear -D format /dev/sda
Relax-and-Recover 2.6 / Git
Running rear format (PID 6894 date 2022-06-27 08:08:50)
Command line options: usr/sbin/rear -D format /dev/sda
Using log file: /root/rear.github.master/var/log/rear/rear-linux.log
Using build area: /var/tmp/rear.KvhzPepOK8mSWkO
Running 'init' stage ======================
Running workflow format on the normal/original system
Running 'format' stage ======================
USB or disk device /dev/sda is not formatted with ext2/3/4 or btrfs filesystem
Formatting /dev/sda will remove all currently existing data on that whole device
UserInput -I USB_DEVICE_CONFIRM_FORMAT needed in /root/rear.github.master/usr/share/rear/format/USB/default/200_check_usb_layout.sh line 62
Type exactly 'Yes' to format /dev/sda with ext3 filesystem
(default 'No' timeout 300 seconds)
Yes
UserInput: No choices - result is 'Yes'
Repartitioning /dev/sda
Creating partition table of type gpt on /dev/sda
Making a BIOS bootable device /dev/sda
Creating BIOS boot partition /dev/sda1
Setting 'bios_grub' flag on BIOS boot partition /dev/sda1
Making an EFI bootable device /dev/sda
Creating EFI system partition /dev/sda2 with size 1024 MiB aligned at 8 MiB
Setting 'esp' flag on EFI partition /dev/sda2
Creating ReaR data partition /dev/sda3 up to 10% of /dev/sda
Setting 'legacy_boot' flag on ReaR data partition /dev/sda3
Creating vfat filesystem on EFI system partition on /dev/sda2
Creating ext3 filesystem with label 'REAR-000' on ReaR data partition /dev/sda3
Adjusting filesystem parameters on ReaR data partition /dev/sda3
Exiting rear format (PID 6894) and its descendant processes ...

# parted -s /dev/sda unit MiB print
Model: TOSHIBA External USB 3.0 (scsi)
Disk /dev/sda: 476940MiB
Sector size (logical/physical): 512B/512B
Partition Table: gpt
Disk Flags: 
Number  Start    End       Size      File system  Name     Flags
 1      0.02MiB  8.00MiB   7.98MiB                primary  bios_grub
 2      8.00MiB  1032MiB   1024MiB   fat32        primary  boot, esp
 3      1032MiB  47694MiB  46662MiB  ext3         primary  legacy_boot

# mount /dev/sda2 /tmp/sda2

# find /tmp/sda2
/tmp/sda2

# mount /dev/sda3 /tmp/sda3

# find /tmp/sda3
/tmp/sda3
/tmp/sda3/lost+found

# umount /tmp/sda2 /tmp/sda3

# usr/sbin/rear -D mkrescue
...
Running 'prep' stage ======================
Found EFI system partition /dev/nvme0n1p1 on /boot/efi type vfat
Using UEFI Boot Loader for Linux (USING_UEFI_BOOTLOADER=1)
...
Running 'rescue' stage ======================
...
Trying to find what to use as UEFI bootloader...
Trying to find a 'well known file' to be used as UEFI bootloader...
Using '/boot/efi/EFI/opensuse/grubx64.efi' as UEFI bootloader file
...
Running 'output' stage ======================
Configuring EFI partition '/dev/disk/by-label/REAR-EFI' for EFI boot with 'grubx64.efi'
Configuring GRUB2 for EFI boot
Configuring GRUB2 kernel /EFI/BOOT/kernel
Configuring GRUB2 initrd /EFI/BOOT/initrd.cgz
Configuring GRUB2 root device as 'search --no-floppy --set=root --label REAR-EFI'
GRUB2 modules to load: cryptodisk ext2 fat gcry_rijndael gcry_sha256 luks part_gpt part_msdos
Saved /root/rear.github.master/var/log/rear/rear-linux.log as rear/linux/20220627.0811/rear-linux.log
Making /dev/sda bootable with syslinux/extlinux
Writing syslinux MBR /usr/share/syslinux/gptmbr.bin of type gpt to /dev/sda
Exiting rear mkrescue (PID 7666) and its descendant processes ...

# mount /dev/sda2 /tmp/sda2

# find /tmp/sda2
/tmp/sda2
/tmp/sda2/EFI
/tmp/sda2/EFI/BOOT
/tmp/sda2/EFI/BOOT/BOOTX64.efi
/tmp/sda2/EFI/BOOT/kernel
/tmp/sda2/EFI/BOOT/initrd.cgz
/tmp/sda2/EFI/BOOT/grub.cfg

# mount /dev/sda3 /tmp/sda3

# find /tmp/sda3
/tmp/sda3
/tmp/sda3/lost+found
/tmp/sda3/linux
/tmp/sda3/linux/.lockfile
/tmp/sda3/rear
/tmp/sda3/rear/linux
/tmp/sda3/rear/linux/20220627.0811
/tmp/sda3/rear/linux/20220627.0811/syslinux.cfg
/tmp/sda3/rear/linux/20220627.0811/kernel
/tmp/sda3/rear/linux/20220627.0811/rear-linux.log
/tmp/sda3/rear/linux/20220627.0811/initrd.cgz
/tmp/sda3/rear/syslinux.cfg
/tmp/sda3/boot
/tmp/sda3/boot/syslinux
/tmp/sda3/boot/syslinux/config.c32
/tmp/sda3/boot/syslinux/disk.c32
/tmp/sda3/boot/syslinux/reboot.c32
/tmp/sda3/boot/syslinux/cat.c32
/tmp/sda3/boot/syslinux/message
/tmp/sda3/boot/syslinux/chain.c32
/tmp/sda3/boot/syslinux/lua.c32
/tmp/sda3/boot/syslinux/cpuid.c32
/tmp/sda3/boot/syslinux/menu.c32
/tmp/sda3/boot/syslinux/rear.help
/tmp/sda3/boot/syslinux/sysdump.c32
/tmp/sda3/boot/syslinux/kbdmap.c32
/tmp/sda3/boot/syslinux/ldlinux.sys
/tmp/sda3/boot/syslinux/pci.ids
/tmp/sda3/boot/syslinux/poweroff.com
/tmp/sda3/boot/syslinux/vesamenu.c32
/tmp/sda3/boot/syslinux/cmd.c32
/tmp/sda3/boot/syslinux/hdt.c32
/tmp/sda3/boot/syslinux/extlinux.conf
/tmp/sda3/boot/syslinux/rosh.c32
/tmp/sda3/boot/syslinux/ls.c32
/tmp/sda3/boot/syslinux/host.c32

# umount /tmp/sda2 /tmp/sda3

# lsblk -ipo NAME,TRAN,TYPE,FSTYPE,LABEL,SIZE /dev/sda
NAME        TRAN TYPE FSTYPE LABEL      SIZE
/dev/sda    usb  disk                 465.8G
|-/dev/sda1      part                     8M
|-/dev/sda2      part vfat   REAR-EFI     1G
`-/dev/sda3      part ext3   REAR-000  45.6G
</code></pre>
<h4 id="jsmeix_commented_at_2022-06-27_0727"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2829#issuecomment-1166985075">2022-06-27 07:27</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-06-27_0727" title="Permanent link">&para;</a></h4>
<p>Booting that same newer homeoffice laptop with UEFI<br />
from the USB disk in UEFI mode works for me.</p>
<p>The USB disk is automatically listed in the<br />
boot menu of the laptop's firmware.</p>
<p>When I boot from the USB disk I get the GRUB2 boot menu.</p>
<p>On that laptop it did not work out of the box<br />
to start up the ReaR recovery system<br />
because after some kernel boot messages<br />
there was no further output at the boot message</p>
<pre><code>Found device /dev/ttyS0.
</code></pre>
<p>but I still noticed some USB disk access activity noise.</p>
<p>I guessed it is perhaps only a graphics driver issue<br />
(i.e. a kernel mode setting issue)<br />
because that laptop has a separated Nvidia GPU<br />
and an AMD CPU with integrated AMD graphics<br />
so I guessed the actual issue is that I only<br />
do no longer see any further output on the console.</p>
<p>So I did another boot attempt and<br />
in the GRUB2 boot menu I edited the boot entry:<br />
I added the kernel command line parameters</p>
<pre><code>nomodeset vga=normal
</code></pre>
<p>(into the 'linux' line of the the boot entry)<br />
and with that the ReaR recovery system startup looks normal.</p>
<p>I don't know if both kernel command line parameters are needed.<br />
Perhaps only 'nomodeset' or only 'vga=normal' is sufficient.<br />
I try that out later.</p>
<p>The booted ReaR recovery seems to work normally for me<br />
(i.e. logged in as 'root' and tried this or that commands).</p>
<p>But I cannot actually test "rear recover"<br />
because I need that laptop for my normal work.</p>
<p>Regarding kernel command line parameter</p>
<pre><code>vga=normal
</code></pre>
<p>see
<a href="https://github.com/rear/rear/pull/2791">https://github.com/rear/rear/pull/2791</a><br />
where we tried to set it everywhere when booting<br />
the ReaR recovery system but it seems 'vga=normal'<br />
is missing when booting from USB via GRUB2.</p>
<p>Furhermore we should think about if additionally<br />
the kernel command line parameter</p>
<pre><code>nomodeset
</code></pre>
<p>may make sense in general when booting the ReaR recovery system<br />
because in general the ReaR recovery system does not need<br />
any sophisticated graphical mode so sticking to plain default<br />
traditional text console mode should be sufficient and<br />
perhaps enforcing that via 'nomodeset vga=normal' could<br />
make booting the ReaR recovery system more fail-safe.</p>
<p>But this would be a separated issue for ReaR 2.8<br />
that does not belong to this pull request.</p>
<h4 id="jsmeix_commented_at_2022-06-27_0736"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2829#issuecomment-1166992645">2022-06-27 07:36</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-06-27_0736" title="Permanent link">&para;</a></h4>
<p>Sigh - last Friday somehow I overlooked another place where<br />
the value of USB_DEVICE_PARTED_LABEL is used:</p>
<p>It is also used in output/USB/Linux-i386/850_make_USB_bootable.sh</p>
<pre><code>LogPrint "Writing syslinux MBR $SYSLINUX_MBR_BIN of type $USB_DEVICE_PARTED_LABEL to $RAW_USB_DEVICE"
</code></pre>
<p>So I will change prep/USB/Linux-i386/340_find_mbr_bin.sh<br />
to set USB_DEVICE_PARTED_LABEL to the right value<br />
via the current 'lsblk' automatism in this pull request<br />
and use a user specified value only as fallback<br />
when the 'lsblk' automatism doesn't work (on older systems).</p>
<h4 id="jsmeix_commented_at_2022-06-27_0855"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2829#issuecomment-1167073308">2022-06-27 08:55</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-06-27_0855" title="Permanent link">&para;</a></h4>
<p>The hybrid boot USB disk that I made<br />
on newer homeoffice laptop with UEFI in<br />
<a href="https://github.com/rear/rear/pull/2829#issuecomment-1166925033">https://github.com/rear/rear/pull/2829#issuecomment-1166925033</a><br />
booted well also on my rather old laptop that only supports BIOS.</p>
<p>In a second test I also added 'nomodeset'<br />
('vga=normal' was already there)<br />
to the SYSLINUX/EXTLINUX boot entry<br />
(via the [Tab] key in the SYSLINUX/EXTLINUX boot menu)<br />
and it made no difference how booting looks and<br />
how the running ReaR recovery system looks<br />
on that rather old laptop that only supports BIOS.</p>
<h4 id="jsmeix_commented_at_2022-06-27_1219"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2829#issuecomment-1167282206">2022-06-27 12:19</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-06-27_1219" title="Permanent link">&para;</a></h4>
<p>With latest commit<br />
<a href="https://github.com/rear/rear/pull/2829/commits/0ad6be092a033a154287db69829c66727e55ed71">https://github.com/rear/rear/pull/2829/commits/0ad6be092a033a154287db69829c66727e55ed71</a><br />
things look explicable to me for the first time<br />
when I create a USB disk for ReaR<br />
on my homeoffice laptop with BIOS<br />
in debug mode:</p>
<pre><code># usr/sbin/rear -D format /dev/sdb
...
Repartitioning /dev/sdb
Creating partition table of type gpt on /dev/sdb
Making a BIOS bootable device /dev/sdb
Creating BIOS boot partition /dev/sdb1
Setting 'bios_grub' flag on BIOS boot partition /dev/sdb1
Making an EFI bootable device /dev/sdb
Creating EFI system partition /dev/sdb2 with size 1024 MiB aligned at 8 MiB
Setting 'esp' flag on EFI partition /dev/sdb2
Creating ReaR data partition /dev/sdb3 up to 10% of /dev/sdb
Setting 'legacy_boot' flag on ReaR data partition /dev/sdb3
Creating vfat filesystem on EFI system partition on /dev/sdb2
Creating ext3 filesystem with label 'REAR-000' on ReaR data partition /dev/sdb3
Adjusting filesystem parameters on ReaR data partition /dev/sdb3
Exiting rear format (PID 25034) and its descendant processes ...

# usr/sbin/rear -D mkrescue
...
Running 'output' stage ======================
Skip configuring EFI partition '/dev/disk/by-label/REAR-EFI' for EFI boot (USING_UEFI_BOOTLOADER is not 'true')
...
Making /dev/sdb bootable with syslinux/extlinux
Writing syslinux MBR /usr/share/syslinux/gptmbr.bin of type gpt to /dev/sdb
Exiting rear mkrescue (PID 25721) and its descendant processes ...
</code></pre>
<h4 id="jsmeix_commented_at_2022-06-28_1034"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2829#issuecomment-1168547117">2022-06-28 10:34</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-06-28_1034" title="Permanent link">&para;</a></h4>
<p>Using my USB disk "as is" which I made above in<br />
<a href="https://github.com/rear/rear/pull/2829#issuecomment-1167282206">https://github.com/rear/rear/pull/2829#issuecomment-1167282206</a><br />
on my newer homeoffice laptop with UEFI<br />
(without doing a new "rear format")<br />
things look promising during "rear -D mkrescue":</p>
<pre><code># lsblk -ipo NAME,TRAN,TYPE,FSTYPE,LABEL,SIZE /dev/sda
NAME        TRAN TYPE FSTYPE LABEL      SIZE
/dev/sda    usb  disk                 465.8G
|-/dev/sda1      part                     8M
|-/dev/sda2      part vfat   REAR-EFI     1G
`-/dev/sda3      part ext3   REAR-000  45.6G

# usr/sbin/rear -D mkrescue
...
Running 'prep' stage ======================
Found EFI system partition /dev/nvme0n1p1 on /boot/efi type vfat
Using UEFI Boot Loader for Linux (USING_UEFI_BOOTLOADER=1)
...
Running 'rescue' stage ======================
...
Trying to find what to use as UEFI bootloader...
Trying to find a 'well known file' to be used as UEFI bootloader...
Using '/boot/efi/EFI/opensuse/grubx64.efi' as UEFI bootloader file
...
Running 'output' stage ======================
Configuring EFI partition '/dev/disk/by-label/REAR-EFI' for EFI boot with 'grubx64.efi'
Configuring GRUB2 for EFI boot
Configuring GRUB2 kernel /EFI/BOOT/kernel
Configuring GRUB2 initrd /EFI/BOOT/initrd.cgz
Configuring GRUB2 root device as 'search --no-floppy --set=root --label REAR-EFI'
GRUB2 modules to load: cryptodisk ext2 fat gcry_rijndael gcry_sha256 luks part_gpt part_msdos
...
No need to update syslinux on /dev/sda that has version 4.04
Exiting rear mkrescue (PID 8206) and its descendant processes ...

# mount /dev/sda2 /tmp/sda2

# find /tmp/sda2
/tmp/sda2
/tmp/sda2/EFI
/tmp/sda2/EFI/BOOT
/tmp/sda2/EFI/BOOT/BOOTX64.efi
/tmp/sda2/EFI/BOOT/kernel
/tmp/sda2/EFI/BOOT/initrd.cgz
/tmp/sda2/EFI/BOOT/grub.cfg

# cat /tmp/sda2/EFI/BOOT/grub.cfg
search --no-floppy --set=root --label REAR-EFI
insmod all_video
set gfxpayload=keep
insmod part_gpt
insmod part_msdos
insmod ext2

set timeout="300"
set default="chainloader"
set fallback="chainloader"
echo 'Switching to GRUB2 boot menu...'
sleep --verbose --interruptible 3
menuentry "Relax-and-Recover (BIOS or UEFI without Secure Boot)" --id=rear {
    insmod gzio
    insmod xzio
    echo 'Loading kernel /EFI/BOOT/kernel ...'
    linux /EFI/BOOT/kernel root=UUID=f71b20bf-dd1b-4d6f-94a4-0819c9a3f1dc  selinux=0
    echo 'Loading initial ramdisk /EFI/BOOT/initrd.cgz ...'
    initrd /EFI/BOOT/initrd.cgz
}

menuentry "Relax-and-Recover (UEFI and Secure Boot)" --id=rear_secure_boot {
    insmod gzio
    insmod xzio
    echo 'Loading kernel /EFI/BOOT/kernel ...'
    linuxefi /EFI/BOOT/kernel root=UUID=f71b20bf-dd1b-4d6f-94a4-0819c9a3f1dc  selinux=0
    echo 'Loading initial ramdisk /EFI/BOOT/initrd.cgz ...'
    initrdefi /EFI/BOOT/initrd.cgz
}
menuentry "Boot next EFI" --id=chainloader {
    insmod chain
    search --fs-uuid --no-floppy --set=esp EEA5-D588
    chainloader ($esp)/EFI/opensuse/grubx64.efi
}
menuentry "Reboot" --id=reboot {
    reboot
}
menuentry "Exit to EFI shell" --id=exit {
    exit
}
</code></pre>
<p>One thing that might look a bit inconsistent is</p>
<pre><code>Running 'prep' stage ======================
Found EFI system partition /dev/nvme0n1p1 on /boot/efi type vfat
Using UEFI Boot Loader for Linux (USING_UEFI_BOOTLOADER=1)
</code></pre>
<p>versus</p>
<pre><code>Running 'output' stage ======================
Configuring EFI partition '/dev/disk/by-label/REAR-EFI' for EFI boot with 'grubx64.efi'
</code></pre>
<p>i.e. it checks if there is an ESP on the original system<br />
to set USING_UEFI_BOOTLOADER=1 but later it checks<br />
if there is an ESP on the USB disk to set up EFI booting on the USB
disk.</p>
<p>I am not an EFI expert but I think this is not inconsistent<br />
but exactly right because to set up EFI booting on the USB disk<br />
an EFI application is needed and for that a prerequirement is<br />
that there is an ESP on the original system<br />
where such an EFI application can be found.</p>
<p>In rescue/default/850_save_sysfs_uefi_vars.sh<br />
UEFI_BOOTLOADER is set to such a found EFI application<br />
inside the ESP on the original system and later<br />
in output/USB/Linux-i386/100_create_efiboot.sh<br />
that UEFI_BOOTLOADER is copied into the ESP on the USB disk.</p>
<p>My USB disk contents on the "REAR-000" data partition:</p>
<pre><code># mount /dev/sda3 /tmp/sda3

# find /tmp/sda3
/tmp/sda3
/tmp/sda3/rear
/tmp/sda3/rear/linux-h9wr
/tmp/sda3/rear/linux-h9wr/20220627.1408
/tmp/sda3/rear/linux-h9wr/20220627.1408/kernel
/tmp/sda3/rear/linux-h9wr/20220627.1408/initrd.cgz
/tmp/sda3/rear/linux-h9wr/20220627.1408/rear-linux-h9wr.log
/tmp/sda3/rear/linux-h9wr/20220627.1408/syslinux.cfg
/tmp/sda3/rear/syslinux.cfg
/tmp/sda3/rear/linux
/tmp/sda3/rear/linux/20220628.1157
/tmp/sda3/rear/linux/20220628.1157/rear-linux.log
/tmp/sda3/rear/linux/20220628.1157/kernel
/tmp/sda3/rear/linux/20220628.1157/initrd.cgz
/tmp/sda3/rear/linux/20220628.1157/syslinux.cfg
/tmp/sda3/linux-h9wr
/tmp/sda3/linux-h9wr/.lockfile
/tmp/sda3/boot
/tmp/sda3/boot/syslinux
/tmp/sda3/boot/syslinux/config.c32
/tmp/sda3/boot/syslinux/cpuid.c32
/tmp/sda3/boot/syslinux/ldlinux.sys
/tmp/sda3/boot/syslinux/disk.c32
/tmp/sda3/boot/syslinux/cat.c32
/tmp/sda3/boot/syslinux/kbdmap.c32
/tmp/sda3/boot/syslinux/sysdump.c32
/tmp/sda3/boot/syslinux/rosh.c32
/tmp/sda3/boot/syslinux/host.c32
/tmp/sda3/boot/syslinux/lua.c32
/tmp/sda3/boot/syslinux/rear.help
/tmp/sda3/boot/syslinux/reboot.c32
/tmp/sda3/boot/syslinux/extlinux.conf
/tmp/sda3/boot/syslinux/poweroff.com
/tmp/sda3/boot/syslinux/menu.c32
/tmp/sda3/boot/syslinux/message
/tmp/sda3/boot/syslinux/hdt.c32
/tmp/sda3/boot/syslinux/pci.ids
/tmp/sda3/boot/syslinux/cmd.c32
/tmp/sda3/boot/syslinux/chain.c32
/tmp/sda3/boot/syslinux/vesamenu.c32
/tmp/sda3/boot/syslinux/ls.c32
/tmp/sda3/lost+found
/tmp/sda3/linux
/tmp/sda3/linux/.lockfile
</code></pre>
<h4 id="jsmeix_commented_at_2022-06-28_1100"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2829#issuecomment-1168572367">2022-06-28 11:00</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-06-28_1100" title="Permanent link">&para;</a></h4>
<p>I tried booting from the above in<br />
<a href="https://github.com/rear/rear/pull/2829#issuecomment-1168547117">https://github.com/rear/rear/pull/2829#issuecomment-1168547117</a><br />
made USB disk on my newer homeoffice laptop with UEFI:</p>
<p>In the GRUB2 boot menu I edited the boot entry:<br />
I added the kernel command line parameter 'vga=normal'<br />
(into the 'linux' line of the the boot entry)<br />
but with only that during ReaR recovery system startup<br />
there was no further output at the boot message<br />
"Found device /dev/ttyS0."<br />
so 'vga=normal' alone does not help, cf. above<br />
<a href="https://github.com/rear/rear/pull/2829#issuecomment-1166985075">https://github.com/rear/rear/pull/2829#issuecomment-1166985075</a></p>
<p>But adding only the kernel command line parameter 'nomodeset'<br />
is sufficient to let the ReaR recovery system startup look normal.</p>
<p>Again the booted ReaR recovery seems to work normally for me<br />
(i.e. logged in as 'root' and tried this or that commands).</p>
<h4 id="jsmeix_commented_at_2022-06-28_1140"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2829#issuecomment-1168610662">2022-06-28 11:40</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-06-28_1140" title="Permanent link">&para;</a></h4>
<p>Also I tried booting from the above in<br />
<a href="https://github.com/rear/rear/pull/2829#issuecomment-1168547117">https://github.com/rear/rear/pull/2829#issuecomment-1168547117</a><br />
made USB disk on my rather old laptop that only supports BIOS<br />
and the booted ReaR recovery seems to work normally for me<br />
(i.e. logged in as 'root' and tried this or that commands).</p>
<p>With SYSLINUX/EXTLINUX that is used as bootloader for BIOS<br />
I can select in the SYSLINUX/EXTLINUX boot menu<br />
which one of the two ReaR recovery systems to boot</p>
<pre><code>/tmp/sda3/rear/linux-h9wr
/tmp/sda3/rear/linux-h9wr/20220627.1408
/tmp/sda3/rear/linux-h9wr/20220627.1408/kernel
/tmp/sda3/rear/linux-h9wr/20220627.1408/initrd.cgz
/tmp/sda3/rear/linux-h9wr/20220627.1408/rear-linux-h9wr.log
/tmp/sda3/rear/linux-h9wr/20220627.1408/syslinux.cfg
</code></pre>
<p>or</p>
<pre><code>/tmp/sda3/rear/linux/20220628.1157
/tmp/sda3/rear/linux/20220628.1157/rear-linux.log
/tmp/sda3/rear/linux/20220628.1157/kernel
/tmp/sda3/rear/linux/20220628.1157/initrd.cgz
/tmp/sda3/rear/linux/20220628.1157/syslinux.cfg
</code></pre>
<p>This is currently not possible with UEFI booting<br />
where GRUB2 is used as bootloader, see item '(b)' in<br />
<a href="https://github.com/rear/rear/issues/2666">https://github.com/rear/rear/issues/2666</a><br />
and<br />
<a href="https://github.com/rear/rear/issues/2818">https://github.com/rear/rear/issues/2818</a></p>
<h4 id="jsmeix_commented_at_2022-06-28_1146"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2829#issuecomment-1168616914">2022-06-28 11:46</a>:<a class="headerlink" href="#jsmeix_commented_at_2022-06-28_1146" title="Permanent link">&para;</a></h4>
<p>@lzaoral @pcahyna @rear/contributors<br />
because things work sufficiently well for me<br />
according to my personal tests above<br />
I would like to merge it tomorrow afternoon<br />
unless there are objections.</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2025 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2022-06-24.2829.pr.merged.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/rear/rear-user-guide" class="fa fa-code-fork" style="color: #fcfcfc"> rear/rear-user-guide</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
