<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#3247 Issue open: How to setup ReaR for Fedora-Cloud-Base-Generic.x86_64-40-VERSION.qcow2 - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#3247 Issue open: How to setup ReaR for Fedora-Cloud-Base-Generic.x86_64-40-VERSION.qcow2";
        var mkdocs_page_input_path = "issues/2024-06-13.3247.issue.open.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/backup_netfs.html">Example of BACKUP=NETFS</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../development/squash-git-log-commments.html">How to squash git log comments into one line</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear29.html">Release Notes ReaR 2.9</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear28.html">Release Notes ReaR 2.8</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#3247 Issue open: How to setup ReaR for Fedora-Cloud-Base-Generic.x86_64-40-VERSION.qcow2</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="3247_issue_open_how_to_setup_rear_for_fedora-cloud-base-genericx86_64-40-versionqcow2"><a href="https://github.com/rear/rear/issues/3247">#3247 Issue</a> <code>open</code>: How to setup ReaR for Fedora-Cloud-Base-Generic.x86_64-40-VERSION.qcow2<a class="headerlink" href="#3247_issue_open_how_to_setup_rear_for_fedora-cloud-base-genericx86_64-40-versionqcow2" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>documentation</code>, <code>ReaR Project</code></p>
<h4 id="jsmeix_opened_issue_at_2024-06-13_0700"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> opened issue at <a href="https://github.com/rear/rear/issues/3247">2024-06-13 07:00</a>:<a class="headerlink" href="#jsmeix_opened_issue_at_2024-06-13_0700" title="Permanent link">&para;</a></h4>
<p>This issue is meant as documentation<br />
how to setup ReaR for a Fedora 40 Cloud Base Image.</p>
<h4 id="jsmeix_commented_at_2024-06-13_0701"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/3247#issuecomment-2164722039">2024-06-13 07:01</a>:<a class="headerlink" href="#jsmeix_commented_at_2024-06-13_0701" title="Permanent link">&para;</a></h4>
<p>How to setup a Fedora 40 Cloud Base Image<br />
so that it can be normally used when it runs<br />
in a KVM/QEMU virtual machine:</p>
<p>I am using here<br />
Fedora-Cloud-Base-Generic.x86_64-40-1.14.qcow2<br />
from<br />
<a href="https://download.fedoraproject.org/pub/fedora/linux/releases/40/Cloud/x86_64/images/">https://download.fedoraproject.org/pub/fedora/linux/releases/40/Cloud/x86_64/images/</a><br />
cf.<br />
<a href="https://github.com/rear/rear/pull/3175#issuecomment-2163125075">https://github.com/rear/rear/pull/3175#issuecomment-2163125075</a></p>
<p>I downloaded</p>
<pre><code>https://mirror.23m.com/fedora/linux/releases/40/Cloud/x86_64/images/Fedora-Cloud-Base-Generic.x86_64-40-1.14.qcow2
</code></pre>
<p>I can run that directly in a KVM/QEMU virtual machine.</p>
<p>But that image has login for 'root' disabled in etc/passwd - cf.<br />
<a href="https://github.com/rear/rear/pull/3175#issuecomment-2163180550">https://github.com/rear/rear/pull/3175#issuecomment-2163180550</a></p>
<p>So I needed to change etc/passwd to no password for 'root'<br />
manually in that image by mounting<br />
Fedora-Cloud-Base-Generic.x86_64-40-1.14.qcow2<br />
directly - cf.<br />
<a href="https://github.com/rear/rear/pull/3175#issuecomment-2163264761">https://github.com/rear/rear/pull/3175#issuecomment-2163264761</a></p>
<pre><code># modprobe nbd max_part=8

# qemu-nbd --connect=/dev/nbd0 Fedora-Cloud-Base-Generic.x86_64-40-1.14.qcow2

# fdisk /dev/nbd0 -l
Disk /dev/nbd0: 5 GiB, 5368709120 bytes, 10485760 sectors
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disklabel type: gpt
Disk identifier: EDB052F7-644C-490E-807C-FAD7E596DB80
Device        Start      End Sectors  Size Type
/dev/nbd0p1    2048     6143    4096    2M BIOS boot
/dev/nbd0p2    6144   210943  204800  100M EFI System
/dev/nbd0p3  210944  2258943 2048000 1000M Linux extended boot
/dev/nbd0p4 2258944 10485726 8226783  3.9G Linux root (x86-64)

# mkdir fedora40mp

# mount /dev/nbd0p4 fedora40mp

# cd fedora40mp

# ls -l
total 0
drwxr-xr-x. 1 root root   0 Jan 24 01:00 home
drwxrwxr-x. 1 root root 212 Apr 15 00:56 root
drwxr-xr-x. 1 root root 170 Jun 12 16:33 var

# ls -l root
total 24
...
drwxr-xr-x. 1 root root 2610 Jun 12 16:33 etc
...

# vi root/etc/passwd
...

# head root/etc/passwd
root::0:0:Super User:/root:/bin/bash
...

# cd

# umount /dev/nbd0p4

# qemu-nbd --disconnect /dev/nbd0
/dev/nbd0 disconnected

# rmmod nbd
</code></pre>
<p>and umounted the image and disabled nbd again.</p>
<p>Now I can log in as root when I run that<br />
Fedora-Cloud-Base-Generic.x86_64-40-1.14.qcow2<br />
in a KVM/QEMU virtual machine.</p>
<p>To be able to log in via 'ssh' I had to add<br />
a normal user 'tux' with a (non empty) password<br />
then I can log in as 'tux' via 'ssh' and finally<br />
I can do 'su -' to become 'root' (via 'ssh').</p>
<h4 id="jsmeix_commented_at_2024-06-13_0724"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/3247#issuecomment-2164808087">2024-06-13 07:24</a>:<a class="headerlink" href="#jsmeix_commented_at_2024-06-13_0724" title="Permanent link">&para;</a></h4>
<p>How to setup a Fedora 40 Cloud Base Image<br />
that can already be normally used in a KVM/QEMU VM<br />
so that the ReaR upstream master code can be used:</p>
<p>A lot of programs are missing which need to be installed - cf.<br />
<a href="https://github.com/rear/rear/pull/3239#issuecomment-2154680294">https://github.com/rear/rear/pull/3239#issuecomment-2154680294</a><br />
which points to<br />
<a href="https://github.com/rear/rear/blob/1ec0559b3fc43e69a0a52feeb3f5fe615e7c7241/tools/run-in-docker#L85-L94">https://github.com/rear/rear/blob/1ec0559b3fc43e69a0a52feeb3f5fe615e7c7241/tools/run-in-docker#L85-L94</a></p>
<p>To get the ReaR upstream master code 'git' is needed</p>
<pre><code># yum --nogpgcheck install git
...

# git clone https://github.com/rear/rear.git
Cloning into 'rear'...
...

# mv rear rear.github.master

# cd rear.github.master

# vi etc/rear/local.conf
...

# cat etc/rear/local.conf

OUTPUT=ISO
BACKUP=NETFS
BACKUP_OPTIONS="nfsvers=3,nolock"
BACKUP_URL=nfs://192.168.178.66/nfs
SSH_ROOT_PASSWORD='rear'
USE_DHCLIENT="yes"
PROGRESS_MODE="plain"
PROGRESS_WAIT_SECONDS="5"
MODULES=( loaded_modules )
FIRMWARE_FILES=( no )
</code></pre>
<p>ReaR needs several more programs to be installed:</p>
<pre><code># usr/sbin/rear -D mkrescue
...
ERROR: Cannot find required programs: bc strings

# yum --nogpgcheck install bc
...

# yum --nogpgcheck install binutils
...

# usr/sbin/rear -D mkrescue
...
ERROR: Mount command 'mount -v -t nfs -o nfsvers=3,nolock 192.168.178.66:/nfs /var/tmp/rear.cppMwUz5FMgLJlv/outputfs' failed.
Some latest log messages since the last called script 060_mount_NETFS_path.sh:
...
  mount: /var/tmp/rear.cppMwUz5FMgLJlv/outputfs: bad option; for several filesystems (e.g. nfs, cifs) you might need a /sbin/mount.&lt;type&gt; helper program.

# yum search --all mount.nfs
...
nfs-utils.x86_64 ...

# yum --nogpgcheck install nfs-utils
...

# usr/sbin/rear -D mkrescue
...
ERROR: Could not find program to make ISO9660 filesystem. Install 'xorrisofs', 'mkisofs', 'genisoimage' or 'ebiso' or specify ISO_MKISOFS_BIN (currently '')

# yum search --all xorrisofs
No matches found.

# yum search --all xorriso
...
xorriso.x86_64 ...

# yum --nogpgcheck install xorriso
...

# usr/sbin/rear -D mkrescue
...
ERROR: Could not find 'isolinux.bin' (ISO_ISOLINUX_BIN='')

# yum search --all isolinux
...
syslinux.x86_64 ...

# yum --nogpgcheck install syslinux
...

# usr/sbin/rear -D mkrescue
...
Exiting rear mkrescue (PID 6819) and its descendant processes ...
</code></pre>
<p>Now also "rear mkbackup" works<br />
(using BACKUP=NETFS with 'tar')</p>
<pre><code># usr/sbin/rear -D mkbackup
...
Archived 336 MiB in 41 seconds [avg 8410 KiB/sec]
Exiting rear mkbackup (PID 78087) and its descendant processes ...
</code></pre>
<h4 id="lzaoral_commented_at_2024-06-13_0736"><img src="https://avatars.githubusercontent.com/u/48823770?v=4" width="50"><a href="https://github.com/lzaoral">lzaoral</a> commented at <a href="https://github.com/rear/rear/issues/3247#issuecomment-2164852528">2024-06-13 07:36</a>:<a class="headerlink" href="#lzaoral_commented_at_2024-06-13_0736" title="Permanent link">&para;</a></h4>
<p>@jsmeix If you want to install all necessary packages, just install the
official <code>rear</code> Fedora package and then remove it while keeping the
dependencies:</p>
<pre><code>$ dnf install rear
...
$ dnf remove --noautoremove rear
...
</code></pre>
<h4 id="jsmeix_commented_at_2024-06-13_0804"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/3247#issuecomment-2164931282">2024-06-13 08:04</a>:<a class="headerlink" href="#jsmeix_commented_at_2024-06-13_0804" title="Permanent link">&para;</a></h4>
<p>@lzaoral<br />
thank you for the tip how to do it more easily.<br />
This is certainly the better way for users.</p>
<p>But I (as ReaR developer) wanted to experience myself<br />
what is missing and - even more important - when ReaR<br />
does not Error out when something essential is missing.<br />
I guess I will experience some currently hidden cases<br />
where ReaR blindly proceeds regardless that something<br />
essential is missing which needs to be fixed in ReaR.<br />
So I do want to install only what ReaR itself requires<br />
as mandatorily needed (via an Error exit).</p>
<h4 id="lzaoral_commented_at_2024-06-13_0914"><img src="https://avatars.githubusercontent.com/u/48823770?v=4" width="50"><a href="https://github.com/lzaoral">lzaoral</a> commented at <a href="https://github.com/rear/rear/issues/3247#issuecomment-2165085282">2024-06-13 09:14</a>:<a class="headerlink" href="#lzaoral_commented_at_2024-06-13_0914" title="Permanent link">&para;</a></h4>
<p><s>@jsmeix Understood! And thank you, this reminded me of the following
Fedora downstream patch that should be upstreamed:
<a href="https://src.fedoraproject.org/rpms/rear/blob/rawhide/f/rear-bz1492177-warning.patch">https://src.fedoraproject.org/rpms/rear/blob/rawhide/f/rear-bz1492177-warning.patch</a></s></p>
<p><s>I'll create a PR next week.</s></p>
<p>Obsolete, see:
<a href="https://github.com/rear/rear/issues/3247#issuecomment-2173025613">https://github.com/rear/rear/issues/3247#issuecomment-2173025613</a></p>
<h4 id="jsmeix_commented_at_2024-06-13_0914"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/3247#issuecomment-2165086416">2024-06-13 09:14</a>:<a class="headerlink" href="#jsmeix_commented_at_2024-06-13_0914" title="Permanent link">&para;</a></h4>
<p>Because a Fedora 40 Cloud Base Image<br />
uses btrfs subvolumes</p>
<pre><code># findmnt -a -o TARGET,SOURCE -t btrfs
TARGET  SOURCE
/       /dev/vda4[/root]
|-/home /dev/vda4[/home]
`-/var  /dev/vda4[/var]
</code></pre>
<p>and because<br />
<a href="https://github.com/rear/rear/pull/3175">https://github.com/rear/rear/pull/3175</a><br />
is not yet merged into ReaR GitHub master code<br />
those btrfs subvolumes which are not mounted at '/'<br />
need to be explicitly included in the backup via</p>
<pre><code>BACKUP_PROG_INCLUDE+=( /home /var )
</code></pre>
<p>so that "rear mkbackup" makes a complete backup.</p>
<p>Here my current var/lib/rear/layout/disklayout.conf</p>
<pre><code># Disk layout dated 20240613090414 (YYYYmmddHHMMSS)
# NAME        KNAME      PKNAME   TRAN   TYPE FSTYPE LABEL   SIZE MOUNTPOINT UUID                                 WWN
# /dev/zram0  /dev/zram0                 disk                1.9G [SWAP]                                          
# /dev/vda    /dev/vda            virtio disk                  5G                                                 
# |-/dev/vda1 /dev/vda1  /dev/vda virtio part                  2M                                                 
# |-/dev/vda2 /dev/vda2  /dev/vda virtio part vfat   EFI     100M /boot/efi  F011-3319                            
# |-/dev/vda3 /dev/vda3  /dev/vda virtio part ext4   BOOT   1000M /boot      0c1e380a-7f1b-4e86-8fa0-629d10202a44 
# `-/dev/vda4 /dev/vda4  /dev/vda virtio part btrfs  fedora  3.9G /var       8424dfd0-f878-4302-8ee5-b2ec6e5eb868 
# Disk /dev/vda
# Format: disk &lt;devname&gt; &lt;size(bytes)&gt; &lt;partition label type&gt;
disk /dev/vda 5368709120 gpt
# Partitions on /dev/vda
# Format: part &lt;device&gt; &lt;partition size(bytes)&gt; &lt;partition start(bytes)&gt; &lt;partition type|name&gt; &lt;flags&gt; /dev/&lt;partition&gt;
part /dev/vda 2097152 1048576 p.legacy bios_grub /dev/vda1
part /dev/vda 104857600 3145728 p.UEFI boot,esp /dev/vda2
part /dev/vda 1048576000 108003328 p.lxboot none /dev/vda3
part /dev/vda 4212112896 1156579328 p.lxroot none /dev/vda4
# Filesystems (only ext2,ext3,ext4,vfat,xfs,reiserfs,btrfs are supported).
# Format: fs &lt;device&gt; &lt;mountpoint&gt; &lt;fstype&gt; [uuid=&lt;uuid&gt;] [label=&lt;label&gt;] [&lt;attributes&gt;]
fs /dev/vda2 /boot/efi vfat uuid=F011-3319 label=EFI options=rw,relatime,fmask=0077,dmask=0077,codepage=437,iocharset=ascii,shortname=winnt,errors=remount-ro
fs /dev/vda3 /boot ext4 uuid=0c1e380a-7f1b-4e86-8fa0-629d10202a44 label=BOOT blocksize=4096 reserved_blocks=5% max_mounts=-1 check_interval=0d bytes_per_inode=16384 default_mount_options=user_xattr,acl options=rw,relatime,seclabel
fs /dev/vda4 / btrfs uuid=8424dfd0-f878-4302-8ee5-b2ec6e5eb868 label='fedora' options=rw,relatime,compress=zstd:1,discard=async,space_cache=v2,subvolid=256,subvol=/root
# Btrfs default subvolume for /dev/vda4 at /
# Format: btrfsdefaultsubvol &lt;device&gt; &lt;mountpoint&gt; &lt;btrfs_subvolume_ID&gt; &lt;btrfs_subvolume_path&gt;
btrfsdefaultsubvol /dev/vda4 / 5 /
# Btrfs normal subvolumes for /dev/vda4 at /
# Format: btrfsnormalsubvol &lt;device&gt; &lt;mountpoint&gt; &lt;btrfs_subvolume_ID&gt; &lt;btrfs_subvolume_path&gt;
btrfsnormalsubvol /dev/vda4 / 256 root
btrfsnormalsubvol /dev/vda4 / 257 home
btrfsnormalsubvol /dev/vda4 / 258 var
# All mounted btrfs subvolumes (including mounted btrfs default subvolumes and mounted btrfs snapshot subvolumes).
# Determined by the findmnt command that shows the mounted btrfs_subvolume_path.
# Format: btrfsmountedsubvol &lt;device&gt; &lt;subvolume_mountpoint&gt; &lt;mount_options&gt; &lt;btrfs_subvolume_path&gt;
btrfsmountedsubvol /dev/vda4 / rw,relatime,seclabel,compress=zstd:1,discard=async,space_cache=v2,subvolid=256,subvol=/root root
btrfsmountedsubvol /dev/vda4 /home rw,relatime,seclabel,compress=zstd:1,discard=async,space_cache=v2,subvolid=257,subvol=/home home
btrfsmountedsubvol /dev/vda4 /var rw,relatime,seclabel,compress=zstd:1,discard=async,space_cache=v2,subvolid=258,subvol=/var var
# Mounted btrfs subvolumes that have the 'no copy on write' attribute set.
# Format: btrfsnocopyonwrite &lt;btrfs_subvolume_path&gt;
# Swap partitions or swap files
# Format: swap &lt;filename&gt; uuid=&lt;uuid&gt; label=&lt;label&gt;
swap /dev/zram0 uuid=34f07c61-f520-4968-b3a8-1942852989da label=zram0
</code></pre>
<p>Here my current disk partitioning:</p>
<pre><code># parted -s /dev/vda unit GiB print
Model: Virtio Block Device (virtblk)
Disk /dev/vda: 5.00GiB
Sector size (logical/physical): 512B/512B
Partition Table: gpt
Disk Flags: 
Number  Start    End      Size     File system  Name      Flags
 1      0.00GiB  0.00GiB  0.00GiB               p.legacy  bios_grub
 2      0.00GiB  0.10GiB  0.10GiB  fat16        p.UEFI    boot, esp
 3      0.10GiB  1.08GiB  0.98GiB  ext4         p.lxboot  bls_boot
 4      1.08GiB  5.00GiB  3.92GiB  btrfs        p.lxroot

# parted -s /dev/vda unit B print
Model: Virtio Block Device (virtblk)
Disk /dev/vda: 5368709120B
Sector size (logical/physical): 512B/512B
Partition Table: gpt
Disk Flags: 
Number  Start        End          Size         File system  Name      Flags
 1      1048576B     3145727B     2097152B                  p.legacy  bios_grub
 2      3145728B     108003327B   104857600B   fat16        p.UEFI    boot, esp
 3      108003328B   1156579327B  1048576000B  ext4         p.lxboot  bls_boot
 4      1156579328B  5368692223B  4212112896B  btrfs        p.lxroot
</code></pre>
<p>Here lsblk, findmnt, btrfs subvolumes, ... - cf.<br />
<a href="https://github.com/rear/rear/pull/3175#issuecomment-2163308619">https://github.com/rear/rear/pull/3175#issuecomment-2163308619</a></p>
<pre><code># lsblk -ipo NAME,KNAME,PKNAME,TRAN,TYPE,FSTYPE,LABEL,PARTLABEL,SIZE,MOUNTPOINTS

NAME        KNAME      PKNAME   TRAN   TYPE FSTYPE LABEL  PARTLABEL  SIZE MOUNTPOINTS
/dev/zram0  /dev/zram0                 disk                          1.9G [SWAP]
/dev/vda    /dev/vda            virtio disk                            5G 
|-/dev/vda1 /dev/vda1  /dev/vda virtio part               p.legacy     2M 
|-/dev/vda2 /dev/vda2  /dev/vda virtio part vfat   EFI    p.UEFI     100M /boot/efi
|-/dev/vda3 /dev/vda3  /dev/vda virtio part ext4   BOOT   p.lxboot  1000M /boot
`-/dev/vda4 /dev/vda4  /dev/vda virtio part btrfs  fedora p.lxroot   3.9G /var
                                                                          /home
                                                                          /

# findmnt -at btrfs

TARGET  SOURCE           FSTYPE OPTIONS
/       /dev/vda4[/root] btrfs  rw,relatime,seclabel,compress=zstd:1,discard=async,space_cache=v2,subvolid=256,subvol=/root
|-/home /dev/vda4[/home] btrfs  rw,relatime,seclabel,compress=zstd:1,discard=async,space_cache=v2,subvolid=257,subvol=/home
`-/var  /dev/vda4[/var]  btrfs  rw,relatime,seclabel,compress=zstd:1,discard=async,space_cache=v2,subvolid=258,subvol=/var

# btrfs subvolume list -a /

ID 256 gen 167 top level 5 path &lt;FS_TREE&gt;/root
ID 257 gen 112 top level 5 path &lt;FS_TREE&gt;/home
ID 258 gen 169 top level 5 path &lt;FS_TREE&gt;/var

# cat /etc/fstab

UUID=8424dfd0-f878-4302-8ee5-b2ec6e5eb868 / btrfs compress=zstd:1,defaults,subvol=root 0 1
UUID=0c1e380a-7f1b-4e86-8fa0-629d10202a44 /boot ext4 defaults 0 0
UUID=8424dfd0-f878-4302-8ee5-b2ec6e5eb868 /home btrfs compress=zstd:1,subvol=home 0 0
UUID=8424dfd0-f878-4302-8ee5-b2ec6e5eb868 /var btrfs compress=zstd:1,subvol=var 0 0
UUID=F011-3319 /boot/efi vfat defaults,umask=0077,shortname=winnt 0 0

# cat /proc/cmdline

BOOT_IMAGE=(hd0,gpt3)/vmlinuz-6.8.5-301.fc40.x86_64 no_timer_check net.ifnames=0 console=tty1 console=ttyS0,115200n8 root=UUID=8424dfd0-f878-4302-8ee5-b2ec6e5eb868 rootflags=subvol=root
</code></pre>
<p>I think I better take a good breakfast now<br />
before I try out how "rear recover" behaves with that...<br />
;-)</p>
<h4 id="jsmeix_commented_at_2024-06-13_1050"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/3247#issuecomment-2165302551">2024-06-13 10:50</a>:<a class="headerlink" href="#jsmeix_commented_at_2024-06-13_1050" title="Permanent link">&para;</a></h4>
<p>I booted the ReaR ISO on a second KVM/QEMU VM<br />
with identical virtual disk /dev/vda size 5.0 GiB.</p>
<p>I did not get the ReaR recovery system startup messages<br />
which indicates an issue with the kernel command line<br />
'console' option setting.</p>
<p>I could log in as 'root' via 'ssh' as specified</p>
<pre><code>SSH_ROOT_PASSWORD='rear'
USE_DHCLIENT="yes"
</code></pre>
<p>which means the needed RPM packages for that<br />
were already installed in the<br />
Fedora-Cloud-Base-Generic.x86_64-40-1.14.qcow2<br />
image.</p>
<p>In the ReaR recovery system I have</p>
<pre><code>RESCUE linux:~ # parted -s /dev/vda unit GiB print
Error: /dev/vda: unrecognised disk label
Model: Virtio Block Device (virtblk)
Disk /dev/vda: 5.00GiB
Sector size (logical/physical): 512B/512B
Partition Table: unknown
Disk Flags:

# lsblk -ipo NAME,KNAME,PKNAME,TRAN,TYPE,FSTYPE,LABEL,PARTLABEL,SIZE,MOUNTPOINTS
NAME     KNAME    PKNAME TRAN   TYPE FSTYPE  LABEL    PARTLABEL SIZE MOUNTPOINTS
/dev/sr0 /dev/sr0        sata   rom  iso9660 REAR-ISO            70M 
/dev/vda /dev/vda        virtio disk                              5G
</code></pre>
<p>as expected for a new empty (virtual) disk.</p>
<p>My very first try of "rear recover":</p>
<p>I enforce MIGRATION_MODE to make "rear recover" stop<br />
in particular after the disk layout was recreated<br />
so that I could have a look (via the ReaR shell)<br />
what disk layout was actually recreated.</p>
<pre><code>RESCUE linux:~ # export MIGRATION_MODE='true'

RESCUE linux:~ # rear -D recover
Relax-and-Recover 2.7 / Git
Running rear recover (PID 678 date 2024-06-13 10:31:58)
Command line options: /bin/rear -D recover
Using log file: /var/log/rear/rear-linux.log
Using build area: /var/tmp/rear.i4ZOCgcblM0Wkq0
Setting TMPDIR to '/var/tmp' (was unset when ReaR was launched)
Running 'init' stage ======================
Running workflow recover within the ReaR rescue/recovery system
Running 'setup' stage ======================
Setting dmesg level 6
Running 'verify' stage ======================
Starting required daemons for NFS: RPC portmapper (portmap or rpcbind) and rpc.statd if available.
Started RPC portmapper 'rpcbind'.
RPC portmapper 'rpcbind' available.
Started rpc.statd.
RPC status rpc.statd available.
Using backup archive '/var/tmp/rear.i4ZOCgcblM0Wkq0/outputfs/linux/backup.tar.gz'
Will do driver migration (recreating initramfs/initrd)
Calculating backup archive size
Backup archive size is 428M     /var/tmp/rear.i4ZOCgcblM0Wkq0/outputfs/linux/backup.tar.gz (compressed)
Running 'layout/prepare' stage ======================
Enforced manual disk layout configuration (MIGRATION_MODE is 'true')
Using /dev/vda (same name and same size 5368709120) for recreating /dev/vda
Current disk mapping table (source =&gt; target):
  /dev/vda =&gt; /dev/vda

UserInput -I LAYOUT_MIGRATION_CONFIRM_MAPPINGS needed in /usr/share/rear/layout/prepare/default/300_map_disks.sh line 334
Confirm or edit the disk mapping
1) Confirm disk mapping and continue 'rear recover'
2) Confirm identical disk mapping and proceed without manual configuration
3) Edit disk mapping (/var/lib/rear/layout/disk_mappings)
4) Use Relax-and-Recover shell and return back to here
5) Abort 'rear recover'
(default '1' timeout 300 seconds)

UserInput: No real user input (empty or only spaces) - using default input
UserInput: Valid choice number result 'Confirm disk mapping and continue 'rear recover''
User confirmed disk mapping
Disabling excluded components in /var/lib/rear/layout/disklayout.conf
Applied disk layout mappings to /var/lib/rear/layout/disklayout.conf
Applied disk layout mappings to /var/lib/rear/layout/config/df.txt
Applied disk layout mappings to /etc/rear/rescue.conf
Trying to automatically resize last partition when disk size changed
Examining gpt device /dev/vda to automatically resize its last active partition
Skipping /dev/vda (size of new device same as size of old device)
UserInput -I LAYOUT_FILE_CONFIRMATION needed in /usr/share/rear/layout/prepare/default/500_confirm_layout_file.sh line 26
Confirm or edit the disk layout file
1) Confirm disk layout and continue 'rear recover'
2) Edit disk layout (/var/lib/rear/layout/disklayout.conf)
3) View disk layout (/var/lib/rear/layout/disklayout.conf)
4) View original disk space usage (/var/lib/rear/layout/config/df.txt)
5) Use Relax-and-Recover shell and return back to here
6) Abort 'rear recover'
(default '1' timeout 300 seconds)

UserInput: No real user input (empty or only spaces) - using default input
UserInput: Valid choice number result 'Confirm disk layout and continue 'rear recover''
User confirmed disk layout file
Marking component '/dev/vda' as done in /var/lib/rear/layout/disktodo.conf
Marking component '/dev/vda1' as done in /var/lib/rear/layout/disktodo.conf
Marking component '/dev/vda2' as done in /var/lib/rear/layout/disktodo.conf
Marking component '/dev/vda3' as done in /var/lib/rear/layout/disktodo.conf
Marking component '/dev/vda4' as done in /var/lib/rear/layout/disktodo.conf
Fallback SLES-like btrfs subvolumes setup for /dev/vda4 on / (no match in BTRFS_SUBVOLUME_GENERIC_SETUP or BTRFS_SUBVOLUME_SLES_SETUP)
Marking component 'fs:/' as done in /var/lib/rear/layout/disktodo.conf
Marking component 'btrfsmountedsubvol:/' as done in /var/lib/rear/layout/disktodo.conf
Marking component 'fs:/boot' as done in /var/lib/rear/layout/disktodo.conf
Marking component 'fs:/boot/efi' as done in /var/lib/rear/layout/disktodo.conf
Marking component 'btrfsmountedsubvol:/home' as done in /var/lib/rear/layout/disktodo.conf
Marking component 'btrfsmountedsubvol:/var' as done in /var/lib/rear/layout/disktodo.conf
No code has been generated to recreate swap:/dev/zram0 (swap)
To recreate swap:/dev/zram0 (swap) manually add code to /var/lib/rear/layout/diskrestore.sh or abort
UserInput -I ADD_CODE_TO_RECREATE_MISSING_SWAPDEVZRAM0SWAP needed in /usr/share/rear/layout/prepare/default/600_show_unprocessed.sh line 33
Manually add code that recreates swap:/dev/zram0 (swap)
1) View /var/lib/rear/layout/diskrestore.sh
2) Edit /var/lib/rear/layout/diskrestore.sh
3) Go to Relax-and-Recover shell
4) Continue 'rear recover'
5) Abort 'rear recover'
(default '4' timeout 300 seconds)

UserInput: No real user input (empty or only spaces) - using default input
UserInput: Valid choice number result 'Continue 'rear recover''
Running 'layout/recreate' stage ======================
UserInput -I LAYOUT_CODE_CONFIRMATION needed in /usr/share/rear/layout/recreate/default/100_confirm_layout_code.sh line 26
Confirm or edit the disk recreation script
1) Confirm disk recreation script and continue 'rear recover'
2) Edit disk recreation script (/var/lib/rear/layout/diskrestore.sh)
3) View disk recreation script (/var/lib/rear/layout/diskrestore.sh)
4) View original disk space usage (/var/lib/rear/layout/config/df.txt)
5) Use Relax-and-Recover shell and return back to here
6) Abort 'rear recover'
(default '1' timeout 300 seconds)

UserInput: No real user input (empty or only spaces) - using default input
UserInput: Valid choice number result 'Confirm disk recreation script and continue 'rear recover''
User confirmed disk recreation script
Disks to be completely overwritten and recreated by /var/lib/rear/layout/diskrestore.sh:
  /dev/vda 
Determining disks to be wiped ...
UserInput -I WIPE_DISKS_CONFIRMATION needed in /usr/share/rear/layout/recreate/default/120_confirm_wipedisk_disks.sh line 168
Disks to be wiped: /dev/vda 
1) Confirm disks to be wiped and continue 'rear recover'
2) Skip wiping disks and continue 'rear recover'
3) Use Relax-and-Recover shell and return back to here
4) Abort 'rear recover'
(default '1' timeout 300 seconds)

UserInput: No real user input (empty or only spaces) - using default input
UserInput: Valid choice number result 'Confirm disks to be wiped and continue 'rear recover''
User confirmed disks to be wiped
Wiping child devices of /dev/vda in reverse ordering: /dev/vda 
Wiped first 16777216 bytes of /dev/vda
Wiped last 16777216 bytes of /dev/vda
Start system layout restoration.
Disk '/dev/vda': creating 'gpt' partition table
Disk '/dev/vda': creating partition number 1 with name ''p.legacy''
Disk '/dev/vda': creating partition number 2 with name ''p.UEFI''
Disk '/dev/vda': creating partition number 3 with name ''p.lxboot''
Disk '/dev/vda': creating partition number 4 with name ''p.lxroot''
Creating filesystem of type btrfs with mount point / on /dev/vda4.
Mounting filesystem /
Creating filesystem of type ext4 with mount point /boot on /dev/vda3.
Mounting filesystem /boot
Creating filesystem of type vfat with mount point /boot/efi on /dev/vda2.
Mounting filesystem /boot/efi
Disk layout created.
Recreated storage layout:
NAME        KNAME     TRAN   TYPE FSTYPE  LABEL     SIZE MOUNTPOINTS
/dev/sr0    /dev/sr0  sata   rom  iso9660 REAR-ISO   70M 
/dev/vda    /dev/vda  virtio disk                     5G 
|-/dev/vda1 /dev/vda1 virtio part                     2M 
|-/dev/vda2 /dev/vda2 virtio part                   100M /mnt/local/boot/efi
|-/dev/vda3 /dev/vda3 virtio part ext4    BOOT     1000M /mnt/local/boot
`-/dev/vda4 /dev/vda4 virtio part btrfs   fedora    3.9G /mnt/local/var
                                                         /mnt/local/home
                                                         /mnt/local
UserInput -I LAYOUT_MIGRATED_CONFIRMATION needed in /usr/share/rear/layout/recreate/default/200_run_layout_code.sh line 168
Confirm the recreated disk layout or go back one step
1) Confirm recreated disk layout and continue 'rear recover'
2) Go back one step to redo disk layout recreation
3) Use Relax-and-Recover shell and return back to here
4) Abort 'rear recover'
(default '1' timeout 300 seconds)
3
UserInput: Valid choice number result 'Use Relax-and-Recover shell and return back to here'

rear&gt; lsblk -ipo NAME,KNAME,PKNAME,TRAN,TYPE,FSTYPE,LABEL,PARTLABEL,SIZE,MOUNTPOINTS
NAME        KNAME     PKNAME   TRAN   TYPE FSTYPE  LABEL    PARTLABEL  SIZE MOUNTPOINTS
/dev/sr0    /dev/sr0           sata   rom  iso9660 REAR-ISO             70M 
/dev/vda    /dev/vda           virtio disk                               5G 
|-/dev/vda1 /dev/vda1 /dev/vda virtio part                  p.legacy     2M 
|-/dev/vda2 /dev/vda2 /dev/vda virtio part                  p.UEFI     100M /mnt/local/boot/efi
|-/dev/vda3 /dev/vda3 /dev/vda virtio part ext4    BOOT     p.lxboot  1000M /mnt/local/boot
`-/dev/vda4 /dev/vda4 /dev/vda virtio part btrfs   fedora   p.lxroot   3.9G /mnt/local/var
                                                                            /mnt/local/home
                                                                            /mnt/local

rear&gt; findmnt -at btrfs           
TARGET            SOURCE           FSTYPE OPTIONS
/mnt/local        /dev/vda4[/root] btrfs  rw,relatime,compress=zstd:1,discard=async,space_cache=v2,subvolid=256,subvol=/root
|-/mnt/local/home /dev/vda4[/home] btrfs  rw,relatime,compress=zstd:1,discard=async,space_cache=v2,subvolid=257,subvol=/home
`-/mnt/local/var  /dev/vda4[/var]  btrfs  rw,relatime,compress=zstd:1,discard=async,space_cache=v2,subvolid=258,subvol=/var

rear&gt; btrfs subvolume list -a /mnt/local
ID 256 gen 10 top level 5 path &lt;FS_TREE&gt;/root
ID 257 gen 8 top level 5 path &lt;FS_TREE&gt;/home
ID 258 gen 8 top level 5 path &lt;FS_TREE&gt;/var

rear&gt; exit
Are you sure you want to exit the Relax-and-Recover shell ? y
exit
UserInput -I LAYOUT_MIGRATED_CONFIRMATION needed in /usr/share/rear/layout/recreate/default/200_run_layout_code.sh line 168
1) Confirm recreated disk layout and continue 'rear recover'
2) Go back one step to redo disk layout recreation
3) Use Relax-and-Recover shell and return back to here
4) Abort 'rear recover'
(default '1' timeout 300 seconds)

UserInput: No real user input (empty or only spaces) - using default input
UserInput: Valid choice number result 'Confirm recreated disk layout and continue 'rear recover''
User confirmed recreated disk layout
Running 'restore' stage ======================
Restoring from '/var/tmp/rear.i4ZOCgcblM0Wkq0/outputfs/linux/backup.tar.gz' (restore log in /var/lib/rear/restore/recover.backup.tar.gz.678.restore.log) ...
Backup restore program 'tar' started in subshell (PID=4843)
Restored 325 MiB [avg. 66611 KiB/sec] 
Restored 635 MiB [avg. 65025 KiB/sec] 
Restored 895 MiB [avg. 61135 KiB/sec] 
OK
Restored 1028 MiB in 20 seconds [avg. 52656 KiB/sec]
Restoring finished (verify backup restore log messages in /var/lib/rear/restore/recover.backup.tar.gz.678.restore.log)
Created SELinux /mnt/local/.autorelabel file : after reboot SELinux will relabel all files
Recreating directories (with permissions) from /var/lib/rear/recovery/directories_permissions_owner_group
Running 'finalize' stage ======================
Checking if certain restored files are consistent with the recreated system
See /var/lib/rear/layout/config/files.md5sum what files are checked
UserInput -I RESTORED_FILES_CONFIRMATION needed in /usr/share/rear/finalize/default/520_confirm_finalize.sh line 41
Confirm restored config files are OK or adapt them as needed
1) Confirm it is OK to recreate initrd and reinstall bootloader and continue 'rear recover'
2) Edit restored etc/fstab (/mnt/local/etc/fstab)
3) View restored etc/fstab (/mnt/local/etc/fstab)
4) Use Relax-and-Recover shell and return back to here
5) Abort 'rear recover'
(default '1' timeout 300 seconds)

UserInput: No real user input (empty or only spaces) - using default input
UserInput: Valid choice number result 'Confirm it is OK to recreate initrd and reinstall bootloader and continue 'rear recover''
User confirmed restored files
Running dracut...
Updated initrd with new drivers for kernel 6.8.5-301.fc40.x86_64.
Installing GRUB2 boot loader...
Determining where to install GRUB2 (no GRUB2_INSTALL_DEVICES specified)
Found possible boot disk /dev/vda - installing GRUB2 there
Running 'wrapup' stage ======================
Finished 'recover'. The target system is mounted at '/mnt/local'.
Exiting rear recover (PID 678) and its descendant processes ...
Running exit tasks
To remove the build area you may use (with caution): rm -Rf --one-file-system /var/tmp/rear.i4ZOCgcblM0Wkq0

RESCUE linux:~ # cat /mnt/local/etc/fstab
UUID=8424dfd0-f878-4302-8ee5-b2ec6e5eb868 / btrfs compress=zstd:1,defaults,subvol=root 0 1
UUID=0c1e380a-7f1b-4e86-8fa0-629d10202a44 /boot ext4 defaults 0 0
UUID=8424dfd0-f878-4302-8ee5-b2ec6e5eb868 /home btrfs compress=zstd:1,subvol=home 0 0
UUID=8424dfd0-f878-4302-8ee5-b2ec6e5eb868 /var btrfs compress=zstd:1,subvol=var 0 0
UUID=F011-3319 /boot/efi vfat defaults,umask=0077,shortname=winnt 0 0

RESCUE linux:~ # lsblk -ipo NAME,KNAME,SIZE,UUID,MOUNTPOINTS
NAME        KNAME      SIZE UUID                                 MOUNTPOINTS
/dev/sr0    /dev/sr0    70M 2024-06-13-09-04-48-00               
/dev/vda    /dev/vda     5G                                      
|-/dev/vda1 /dev/vda1    2M                                      
|-/dev/vda2 /dev/vda2  100M F011-3319                            /mnt/local/boot/efi
|-/dev/vda3 /dev/vda3 1000M 0c1e380a-7f1b-4e86-8fa0-629d10202a44 /mnt/local/boot
`-/dev/vda4 /dev/vda4  3.9G 8424dfd0-f878-4302-8ee5-b2ec6e5eb868 /mnt/local/var
                                                                 /mnt/local/home
                                                                 /mnt/local
</code></pre>
<p>So far - at least at first glance - things look good.</p>
<p>Regarding the missing ReaR recovery system startup messages<br />
which indicates an issue with the kernel command line<br />
'console' option setting:</p>
<pre><code>RESCUE linux:~ # cat /proc/cmdline 
BOOT_IMAGE=kernel initrd=initrd.cgz root=/dev/ram0 vga=normal rw  selinux=0 net.ifnames=0 console=tty1 console=ttyS0,115200n8
</code></pre>
<p>so</p>
<pre><code>USE_SERIAL_CONSOLE='no'
</code></pre>
<p>should help to get ReaR recovery system startup messages.</p>
<h4 id="jsmeix_commented_at_2024-06-13_1107"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/3247#issuecomment-2165338105">2024-06-13 11:07</a>:<a class="headerlink" href="#jsmeix_commented_at_2024-06-13_1107" title="Permanent link">&para;</a></h4>
<p>In the recreated system I did 'poweroff'<br />
but it did not do a real poweroff.<br />
Instead it looks as if it did a 'reboot'<br />
because I got the VM's firmware boot menu<br />
(I set up my VMs always with boot menu<br />
so that I can select the boot disk)<br />
and then I got GRUB<br />
and I saw the kernel boot messages<br />
until there were no further kernel boot messages<br />
(perhaps again a 'console' kernel command line issue)<br />
BUT then<br />
it suddenly rebooted again, i.e. I got again<br />
my VM's firmware boot menu and then GRUB.</p>
<p>I did a hard "power" switch off of the VM.</p>
<p>Then with a real poweroff it booted the recreated system<br />
and I can log in via 'ssh' as on the original system.</p>
<p>Now I have in the poweroff-rebooted recreated system:</p>
<pre><code># parted -s /dev/vda unit B print
Model: Virtio Block Device (virtblk)
Disk /dev/vda: 5368709120B
Sector size (logical/physical): 512B/512B
Partition Table: gpt
Disk Flags: 
Number  Start        End          Size         File system  Name      Flags
 1      1048576B     3145727B     2097152B                  p.legacy  bios_grub
 2      3145728B     108003327B   104857600B   fat16        p.UEFI    boot, esp
 3      108003328B   1156579327B  1048576000B  ext4         p.lxboot
 4      1156579328B  5368692223B  4212112896B  btrfs        p.lxroot

# lsblk -ipo NAME,KNAME,PKNAME,TRAN,TYPE,FSTYPE,LABEL,PARTLABEL,SIZE,MOUNTPOINTS
NAME        KNAME      PKNAME   TRAN   TYPE FSTYPE LABEL  PARTLABEL  SIZE MOUNTPOINTS
/dev/sr0    /dev/sr0            sata   rom                             2K 
/dev/zram0  /dev/zram0                 disk                          1.9G [SWAP]
/dev/vda    /dev/vda            virtio disk                            5G 
|-/dev/vda1 /dev/vda1  /dev/vda virtio part               p.legacy     2M 
|-/dev/vda2 /dev/vda2  /dev/vda virtio part vfat   EFI    p.UEFI     100M /boot/efi
|-/dev/vda3 /dev/vda3  /dev/vda virtio part ext4   BOOT   p.lxboot  1000M /boot
`-/dev/vda4 /dev/vda4  /dev/vda virtio part btrfs  fedora p.lxroot   3.9G /var
                                                                          /home
                                                                          /

# findmnt -at btrfs
TARGET  SOURCE           FSTYPE OPTIONS
/       /dev/vda4[/root] btrfs  rw,relatime,seclabel,compress=zstd:1,discard=async,space_cache=v2,subvolid=256,subvol=/root
|-/home /dev/vda4[/home] btrfs  rw,relatime,seclabel,compress=zstd:1,discard=async,space_cache=v2,subvolid=257,subvol=/home
`-/var  /dev/vda4[/var]  btrfs  rw,relatime,seclabel,compress=zstd:1,discard=async,space_cache=v2,subvolid=258,subvol=/var

# btrfs subvolume list -a /
ID 256 gen 29 top level 5 path &lt;FS_TREE&gt;/root
ID 257 gen 22 top level 5 path &lt;FS_TREE&gt;/home
ID 258 gen 28 top level 5 path &lt;FS_TREE&gt;/var

# cat /etc/fstab
UUID=8424dfd0-f878-4302-8ee5-b2ec6e5eb868 / btrfs compress=zstd:1,defaults,subvol=root 0 1
UUID=0c1e380a-7f1b-4e86-8fa0-629d10202a44 /boot ext4 defaults 0 0
UUID=8424dfd0-f878-4302-8ee5-b2ec6e5eb868 /home btrfs compress=zstd:1,subvol=home 0 0
UUID=8424dfd0-f878-4302-8ee5-b2ec6e5eb868 /var btrfs compress=zstd:1,subvol=var 0 0
UUID=F011-3319 /boot/efi vfat defaults,umask=0077,shortname=winnt 0 0

# cat /proc/cmdline
BOOT_IMAGE=(hd0,gpt3)/vmlinuz-6.8.5-301.fc40.x86_64 root=UUID=8424dfd0-f878-4302-8ee5-b2ec6e5eb868 ro rootflags=subvol=root no_timer_check net.ifnames=0 console=tty1 console=ttyS0,115200n8 rootflags=subvol=root

# mount -t btrfs -o subvolid=0 /dev/vda4 btrfsroot

# ls -l btrfsroot
total 0
drwxr-xr-x. 1 root root   6 Jun 12 15:11 home
drwxrwxr-x. 1 root root 212 Jun 13 10:52 root
drwxr-xr-x. 1 root root 170 Jun 12 14:33 var

# findmnt -at btrfs
TARGET            SOURCE           FSTYPE OPTIONS
/                 /dev/vda4[/root] btrfs  rw,relatime,seclabel,compress=zstd:1,discard=async,space_cache=v2,subvolid=256,subvol=/root
|-/home           /dev/vda4[/home] btrfs  rw,relatime,seclabel,compress=zstd:1,discard=async,space_cache=v2,subvolid=257,subvol=/home
|-/var            /dev/vda4[/var]  btrfs  rw,relatime,seclabel,compress=zstd:1,discard=async,space_cache=v2,subvolid=258,subvol=/var
`-/root/btrfsroot /dev/vda4        btrfs  rw,relatime,seclabel,compress=zstd:1,discard=async,space_cache=v2,subvolid=5,subvol=/
</code></pre>
<p>So - at least for now at first glance - all looks good<br />
in the with real poweroff rebooted recreated system.</p>
<p>In the with real poweroff rebooted recreated system<br />
I did 'poweroff' and that worked as it should<br />
i.e. the VM powered off.</p>
<h4 id="jsmeix_commented_at_2024-06-13_1141"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/3247#issuecomment-2165414153">2024-06-13 11:41</a>:<a class="headerlink" href="#jsmeix_commented_at_2024-06-13_1141" title="Permanent link">&para;</a></h4>
<p>Regarding the kernel command line 'console' option settings:</p>
<p>On the original system<br />
i.e. in Fedora-Cloud-Base-Generic.x86_64-40-1.14.qcow2</p>
<pre><code># find / /boot -xdev -type f | xargs grep 'console=.*115200' 2&gt;/dev/null | grep -v 'rear.github.master'

/etc/default/grub:
GRUB_CMDLINE_LINUX_DEFAULT="no_timer_check net.ifnames=0 console=tty1 console=ttyS0,115200n8 rootflags=subvol=root"

/etc/kernel/cmdline:
root=UUID=8424dfd0-f878-4302-8ee5-b2ec6e5eb868 ro rootflags=subvol=root  no_timer_check net.ifnames=0 console=tty1 console=ttyS0,115200n8 rootflags=subvol=root

/etc/sysconfig/bootloader:
DEFAULT_APPEND="no_timer_check net.ifnames=0 console=tty1 console=ttyS0,115200n8 root=UUID=8424dfd0-f878-4302-8ee5-b2ec6e5eb868 rootflags=subvol=root"
FAILSAFE_APPEND="no_timer_check net.ifnames=0 console=tty1 console=ttyS0,115200n8 root=UUID=8424dfd0-f878-4302-8ee5-b2ec6e5eb868 rootflags=subvol=root ide=nodma apm=off noresume edd=off nomodeset 3 rootflags=subvol=root"

/config.bootoptions:
no_timer_check net.ifnames=0 console=tty1 console=ttyS0,115200n8 root=UUID=8424dfd0-f878-4302-8ee5-b2ec6e5eb868 rootflags=subvol=root

/boot/grub2/grub.cfg:
  set kernelopts="root=UUID=8424dfd0-f878-4302-8ee5-b2ec6e5eb868 ro rootflags=subvol=root  no_timer_check net.ifnames=0 console=tty1 console=ttyS0,115200n8 rootflags=subvol=root"
/boot/loader/entries/b7be3f04d1af4fec81d4d27c7e1a64a0-6.8.5-301.fc40.x86_64.conf:options no_timer_check net.ifnames=0 console=tty1 console=ttyS0,115200n8 root=UUID=8424dfd0-f878-4302-8ee5-b2ec6e5eb868 rootflags=subvol=root
</code></pre>
<p>so</p>
<pre><code>console=tty1 console=ttyS0,115200n8
</code></pre>
<p>appears at several places.</p>
<p>@lzaoral @pcahyna<br />
what is "the right way" in Fedora 40 how to<br />
specifiy a different kernel command line<br />
and properly re-setup the whole booting stuff<br />
with that new different kernel command line?</p>
<h4 id="lzaoral_commented_at_2024-06-13_1152"><img src="https://avatars.githubusercontent.com/u/48823770?v=4" width="50"><a href="https://github.com/lzaoral">lzaoral</a> commented at <a href="https://github.com/rear/rear/issues/3247#issuecomment-2165438417">2024-06-13 11:52</a>:<a class="headerlink" href="#lzaoral_commented_at_2024-06-13_1152" title="Permanent link">&para;</a></h4>
<p>@jsmeix The recommended way to make permanent changes to kernel cmdline
with GRUB2 in Fedora is to use the <code>grubby</code> tool:
<a href="https://docs.fedoraproject.org/en-US/fedora/latest/system-administrators-guide/kernel-module-driver-configuration/Working_with_the_GRUB_2_Boot_Loader/#sec-Making_Persistent_Changes_to_a_GRUB_2_Menu_Using_the_grubby_Tool">https://docs.fedoraproject.org/en-US/fedora/latest/system-administrators-guide/kernel-module-driver-configuration/Working_with_the_GRUB_2_Boot_Loader/#sec-Making_Persistent_Changes_to_a_GRUB_2_Menu_Using_the_grubby_Tool</a></p>
<h4 id="lzaoral_commented_at_2024-06-17_1042"><img src="https://avatars.githubusercontent.com/u/48823770?v=4" width="50"><a href="https://github.com/lzaoral">lzaoral</a> commented at <a href="https://github.com/rear/rear/issues/3247#issuecomment-2173025613">2024-06-17 10:42</a>:<a class="headerlink" href="#lzaoral_commented_at_2024-06-17_1042" title="Permanent link">&para;</a></h4>
<p>Please, ignore
<a href="https://github.com/rear/rear/issues/3247#issuecomment-2165085282">https://github.com/rear/rear/issues/3247#issuecomment-2165085282</a>.
ReaR already has that a more general check for this issue (the
downstream one only adds a suggestion to install a particular package.)</p>
<h4 id="pcahyna_commented_at_2024-06-18_1616"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/3247#issuecomment-2176492110">2024-06-18 16:16</a>:<a class="headerlink" href="#pcahyna_commented_at_2024-06-18_1616" title="Permanent link">&para;</a></h4>
<p>@jsmeix</p>
<blockquote>
<p>BUT then<br />
it suddenly rebooted again, i.e. I got again<br />
my VM's firmware boot menu and then GRUB.</p>
</blockquote>
<p>This was probably due to SELinux relabeling (the system reboots
automatically after relabeling is done).</p>
<h4 id="jsmeix_commented_at_2024-06-19_0603"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/3247#issuecomment-2177818413">2024-06-19 06:03</a>:<a class="headerlink" href="#jsmeix_commented_at_2024-06-19_0603" title="Permanent link">&para;</a></h4>
<p>@pcahyna<br />
thank you for your explanation what may have caused<br />
that unexpected automated reboot.<br />
Perhaps there was a message somewhere about SELinux<br />
and the automated reboot - but at least it was not<br />
sufficiently obvious for me - perhaps I missed it?<br />
At least I noticed nothing that informed me<br />
about the reason for the automated reboot.</p>
<h4 id="pcahyna_commented_at_2024-06-19_1124"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/3247#issuecomment-2178435975">2024-06-19 11:24</a>:<a class="headerlink" href="#pcahyna_commented_at_2024-06-19_1124" title="Permanent link">&para;</a></h4>
<p>the relabel and reboot process is quick, so maybe you missed it? I
recommend using serial console if you don't already, enables you to keep
the messages that on a VGA screen would scroll into oblivion or get
erased.</p>
<h4 id="jsmeix_commented_at_2024-06-19_1244"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/3247#issuecomment-2178613162">2024-06-19 12:44</a>:<a class="headerlink" href="#jsmeix_commented_at_2024-06-19_1244" title="Permanent link">&para;</a></h4>
<p>Most likely I didn't pay attention to the messages<br />
because I didn't expect something special to happen<br />
so I was surprised by the unexpected automated reboot.</p>
<p>FWIW:<br />
In ReaR we have at several places some reasonable timeout<br />
to avoid that user information scrolls away too fast<br />
or gets erased when the screen content gets replaced<br />
e.g. during recovery system startup several 'sleep' in<br />
<a href="https://github.com/rear/rear/blob/master/usr/share/rear/skel/default/etc/scripts/system-setup">https://github.com/rear/rear/blob/master/usr/share/rear/skel/default/etc/scripts/system-setup</a><br />
and also during boot for GRUB at<br />
<a href="https://github.com/rear/rear/blob/master/usr/share/rear/lib/bootloader-functions.sh#L766">https://github.com/rear/rear/blob/master/usr/share/rear/lib/bootloader-functions.sh#L766</a></p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2025 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2024-06-13.3247.issue.open.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/rear/rear-user-guide" class="fa fa-code-fork" style="color: #fcfcfc"> rear/rear-user-guide</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
