<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#2055 PR merged: skip patching absolute symlinks during finalize stage (related to issue 1338) - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#2055 PR merged: skip patching absolute symlinks during finalize stage (related to issue 1338)";
        var mkdocs_page_input_path = "issues/2019-02-26.2055.pr.merged.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a> &raquo;</li>
      <li class="breadcrumb-item active">#2055 PR merged: skip patching absolute symlinks during finalize stage (related to issue 1338)</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="2055_pr_merged_skip_patching_absolute_symlinks_during_finalize_stage_related_to_issue_1338"><a href="https://github.com/rear/rear/pull/2055">#2055 PR</a> <code>merged</code>: skip patching absolute symlinks during finalize stage (related to issue 1338)<a class="headerlink" href="#2055_pr_merged_skip_patching_absolute_symlinks_during_finalize_stage_related_to_issue_1338" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>enhancement</code>, <code>bug</code>, <code>cleanup</code>, <code>fixed / solved / done</code></p>
<h4 id="jsmeix_opened_issue_at_2019-02-26_1404"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> opened issue at <a href="https://github.com/rear/rear/pull/2055">2019-02-26 14:04</a>:<a class="headerlink" href="#jsmeix_opened_issue_at_2019-02-26_1404" title="Permanent link">&para;</a></h4>
<ul>
<li>
<p>Type: <strong>Bug Fix</strong> <strong>Enhancement</strong> <strong>Cleanup</strong></p>
</li>
<li>
<p>Impact: <strong>Normal</strong></p>
</li>
<li>
<p>Reference to related issue (URL):<br />
    skip patching absolute symlinks during finalize stage<br />
    is only a first step towards actually fixing<br />
<a href="https://github.com/rear/rear/issues/1338">https://github.com/rear/rear/issues/1338</a></p>
</li>
<li>
<p>How was this pull request tested?<br />
    Not yet tested and not yet complete - some more commits are
    needed...</p>
</li>
<li>
<p>Brief description of the changes in this pull request:</p>
</li>
</ul>
<p>All finalize scripts that patch restored files within TARGET_FS_ROOT<br />
should do the same symlink handling which means</p>
<ol>
<li>
<p>Skip patching symlink targets that are not within TARGET_FS_ROOT<br />
    (i.e. when it is an absolute symlink)</p>
</li>
<li>
<p>Skip patching if the symlink target contains /proc/ /sys/ /dev/ or
    /run/</p>
</li>
<li>
<p>Skip patching dead symlinks</p>
</li>
</ol>
<p>Skip patching symlink targets that are not within TARGET_FS_ROOT<br />
does not actually fix
<a href="https://github.com/rear/rear/issues/1338">https://github.com/rear/rear/issues/1338</a><br />
but at least it should avoid patching wrong files<br />
so that for now this pull request before the ReaR 2.5 release<br />
is meant only as a first step towards actually fixing<br />
<a href="https://github.com/rear/rear/issues/1338">https://github.com/rear/rear/issues/1338</a></p>
<h4 id="jsmeix_commented_at_2019-02-26_1549"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2055#issuecomment-467492318">2019-02-26 15:49</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-02-26_1549" title="Permanent link">&para;</a></h4>
<p>For me on SLES12-SP4 with UEFI<br />
things still work but that does not mean much<br />
because most of what the finalize scripts can do<br />
is not needed to be done on my particular system.</p>
<h4 id="gozora_commented_at_2019-02-26_1752"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/pull/2055#issuecomment-467542885">2019-02-26 17:52</a>:<a class="headerlink" href="#gozora_commented_at_2019-02-26_1752" title="Permanent link">&para;</a></h4>
<p>@jsmeix</p>
<blockquote>
<p>For me on SLES12-SP4 with UEFI<br />
things still work but that does not mean much<br />
because most of what the finalize scripts can do<br />
is not needed to be done on my particular system.</p>
</blockquote>
<p>I can test this PR on my Arch Linux where I've observed this behavior
for first time
(<a href="https://github.com/rear/rear/pull/2047#issuecomment-464846777">https://github.com/rear/rear/pull/2047#issuecomment-464846777</a>),
but not sooner that tomorrow (27th Feb) afternoon ...</p>
<p>V.</p>
<h4 id="jsmeix_commented_at_2019-02-27_1532"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2055#issuecomment-467907910">2019-02-27 15:32</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-02-27_1532" title="Permanent link">&para;</a></h4>
<p>With my above recent<br />
<a href="https://github.com/rear/rear/pull/2055/commits/42b1f0f638732d47b078c31ff0aa4558409f9536">https://github.com/rear/rear/pull/2055/commits/42b1f0f638732d47b078c31ff0aa4558409f9536</a><br />
that etc/udev/rules.d/70-persistent-net.rules stuff<br />
seems to work o.k. at lest for me for the first time:<br />
Without</p>
<pre><code>BACKUP_RESTORE_MOVE_AWAY_FILES=( /etc/udev/rules.d/70-persistent-net.rules )
</code></pre>
<p>I get during finalize stage the restored<br />
/mnt/local/etc/udev/rules.d/70-persistent-net.rules<br />
replaced by the one in the recovery system<br />
but with</p>
<pre><code>BACKUP_RESTORE_MOVE_AWAY_FILES=( /etc/udev/rules.d/70-persistent-net.rules )
</code></pre>
<p>I do no longer get a etc/udev/rules.d/70-persistent-net.rules<br />
created in any case in my restored system even when I do not want it<br />
because that ReaR-created etc/udev/rules.d/70-persistent-net.rules<br />
gets in conflict with what systemd/udev normally should do,<br />
i.e. creating etc/udev/rules.d/70-persistent-net.rules<br />
so that from my corrent point of view it seems<br />
<a href="https://github.com/rear/rear/issues/770">https://github.com/rear/rear/issues/770</a><br />
is hereby (hopefully) finally fixed.</p>
<p>To no longer get etc/udev/rules.d/70-persistent-net.rules<br />
created by ReaR in the restored system by default we would<br />
have to add /etc/udev/rules.d/70-persistent-net.rules to<br />
BACKUP_RESTORE_MOVE_AWAY_FILES in default.conf</p>
<h4 id="gozora_commented_at_2019-02-27_1705"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/pull/2055#issuecomment-467945977">2019-02-27 17:05</a>:<a class="headerlink" href="#gozora_commented_at_2019-02-27_1705" title="Permanent link">&para;</a></h4>
<p>When I was running test restore of my Arch Linux (with EFISTUB, because
EFISTUB is cool :-)) I've hit something which does not feel right to
me.<br />
Since I was in migration mode (because why not ...) I was stopped by
<a href="https://github.com/rear/rear/blob/master/usr/share/rear/finalize/default/020_confirm_finalize.sh">020_confirm_finalize.sh</a>,
which prompted me:</p>
<pre><code>Confirm restored config files or edit them
1) Confirm it is OK to recreate initrd and reinstall bootloader and continue 'rear recover'
2) Edit restored etc/fstab (/mnt/local/etc/fstab)
3) View restored etc/fstab (/mnt/local/etc/fstab)
4) Use Relax-and-Recover shell and return back to here
5) Abort 'rear recover'
(default '1' timeout 300 seconds)
</code></pre>
<p>Now I was tempted to manually update my restored <em>fstab</em> because it did
not had right UUIDs ...<br />
Luckily I've let the file as it was because later
<em>usr/share/rear/finalize/GNU/Linux/280_migrate_uuid_tags.sh</em> took
care of this inconsistency.</p>
<p>What about moving
<a href="https://github.com/rear/rear/blob/master/usr/share/rear/finalize/default/020_confirm_finalize.sh">020_confirm_finalize.sh</a>
to later stage, ideally very close before <code>mkinird</code> ?</p>
<p>V.</p>
<h4 id="jsmeix_commented_at_2019-02-28_0905"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2055#issuecomment-468193571">2019-02-28 09:05</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-02-28_0905" title="Permanent link">&para;</a></h4>
<p>@gozora<br />
thank you so much for your careful observation.</p>
<p>You are absolutely right that 020_confirm_finalize.sh is too early.</p>
<p>When I added it via<br />
<a href="https://github.com/rear/rear/commit/0bdaf5f2ba13a7cacce14d878f1007d5c06f2075">https://github.com/rear/rear/commit/0bdaf5f2ba13a7cacce14d878f1007d5c06f2075</a><br />
I had only in mind to get that user dialog in any case<br />
after the backup was restored (independent of the backup method)<br />
so that I put that script at the beginning of the finalize stage<br />
and not at the end of the restore stage (to be independent of the<br />
particular restore scripts of the particular backup method), cf.<br />
<a href="https://github.com/rear/rear/pull/1758">https://github.com/rear/rear/pull/1758</a><br />
But at that time I did not have in mind that during finalize<br />
stage ReaR changes restored files which contradicts<br />
the whole idea behind 020_confirm_finalize.sh which is meant<br />
to provide final power to the user to adapt restored files as he wants.</p>
<p>So 020_confirm_finalize.sh must be after ReaR had changed<br />
any restored files and I need to adapt the comment in that script<br />
to better explain what is actually meant...</p>
<h4 id="jsmeix_commented_at_2019-02-28_1115"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2055#issuecomment-468235171">2019-02-28 11:15</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-02-28_1115" title="Permanent link">&para;</a></h4>
<p>With my latest<br />
<a href="https://github.com/rear/rear/pull/2055/commits/04013330c5f0ff77d69bd498960089bb471951c8">https://github.com/rear/rear/pull/2055/commits/04013330c5f0ff77d69bd498960089bb471951c8</a><br />
things look (and work) so much cleaner now<br />
in migration mode during "rear recover" (excerpts):</p>
<pre><code>Restoring finished (verify backup restore log messages in /var/lib/rear/restore/recover.backup.tar.gz.726.restore.log)
Recreating directories (with permissions) from /var/lib/rear/recovery/directories_permissions_owner_group
Migrating disk-by-id mappings in certain restored files in /mnt/local to current disk-by-id mappings ...
Migrating filesystem UUIDs in certain restored files in /mnt/local to current UUIDs ...
Patching filesystem UUIDs in boot/grub2/grub.cfg to current UUIDs
Patching filesystem UUIDs in etc/sysconfig/bootloader to current UUIDs
Skip patching symlink etc/mtab target /mnt/local/proc/5199/mounts on /proc/ /sys/ /dev/ or /run/
Patching filesystem UUIDs in etc/fstab to current UUIDs
Patching filesystem UUIDs in etc/mtools.conf to current UUIDs
Patching filesystem UUIDs in etc/smartd.conf to current UUIDs
Patching filesystem UUIDs in etc/sysconfig/smartmontools to current UUIDs
Patching filesystem UUIDs in etc/security/pam_mount.conf.xml to current UUIDs
Patching filesystem UUIDs in boot/efi/EFI/sles/grub.cfg to current UUIDs
Migrating network configuration files according to the mapping files ...
UserInput -I RESTORED_FILES_CONFIRMATION needed in /usr/share/rear/finalize/default/520_confirm_finalize.sh line 41
Confirm restored config files are OK or adapt them as needed
1) Confirm it is OK to recreate initrd and reinstall bootloader and continue 'rear recover'
2) Edit restored etc/fstab (/mnt/local/etc/fstab)
3) View restored etc/fstab (/mnt/local/etc/fstab)
4) Use Relax-and-Recover shell and return back to here
5) Abort 'rear recover'
(default '1' timeout 300 seconds)
UserInput: No real user input (empty or only spaces) - using default input
UserInput: Valid choice number result 'Confirm it is OK to recreate initrd and reinstall bootloader and continue 'rear recover''
User confirmed restored files
Running mkinitrd...
Recreated initrd (/sbin/mkinitrd).
Creating  EFI Boot Manager entry 'SUSE_LINUX 12.4' for 'EFI\sles\grubx64.efi' (UEFI_BOOTLOADER='/boot/efi/EFI/sles/grubx64.efi')
Finished recovering your system. You can explore it under '/mnt/local'.
</code></pre>
<p>FYI:<br />
I used a somewhat sophisticated command to launch "rear recover"<br />
with automated [Enter] responses (via plain 'echo') to all user
dialogs, cf.<br />
"It should be possible to run ReaR unattended" at<br />
<a href="https://github.com/rear/rear/wiki/Coding-Style">https://github.com/rear/rear/wiki/Coding-Style</a><br />
plus having the output on the terminal also saved in a file
'rear_recover.out'<br />
plus keeping my bash prompt by running all in the background in a
subshell</p>
<pre><code># ( exec 0&lt; &lt;( while true ; do echo ; sleep 1 ; done ) ; rear -D recover | tee -a rear_recover.out ) &amp;
</code></pre>
<p>because that 'while' loop (and the 'tee') run endlessly so that I won't
be able<br />
to just type <code>reboot</code> after 'rear recover' finished if it was not run in
the background<br />
(before the reboot I used <code>scp</code> to get 'rear_recover.out' out of the
recovery system).</p>
<h4 id="jsmeix_commented_at_2019-02-28_1117"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2055#issuecomment-468235800">2019-02-28 11:17</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-02-28_1117" title="Permanent link">&para;</a></h4>
<p>If there are no objections I would like to merge it today afternoon.</p>
<h4 id="jsmeix_commented_at_2019-02-28_1330"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2055#issuecomment-468272784">2019-02-28 13:30</a>:<a class="headerlink" href="#jsmeix_commented_at_2019-02-28_1330" title="Permanent link">&para;</a></h4>
<p>At least my browser shows here below</p>
<pre><code>Some checks haven’t completed yet
1 pending check
continuous-integration/travis-ci/pr Pending — The Travis CI build is in progress [Details]
</code></pre>
<p>but the [Details] link<br />
<a href="https://travis-ci.org/rear/rear/builds/499727007?utm_source=github_status&amp;utm_medium=notification">https://travis-ci.org/rear/rear/builds/499727007?utm_source=github_status&amp;utm_medium=notification</a><br />
shows (excerpts)</p>
<pre><code>#2017 passed
    Ran for 40 sec
    about 3 hours ago

The command "make validate" exited with 0.
Done. Your build exited with 0.
</code></pre>
<p>so that I think actually all is o.k. and I can merge it now...</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2023 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2019-02-26.2055.pr.merged.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
