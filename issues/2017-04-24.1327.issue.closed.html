<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#1327 Issue closed: Stalled recovery due to mkfs interactive prompt - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#1327 Issue closed: Stalled recovery due to mkfs interactive prompt";
        var mkdocs_page_input_path = "issues/2017-04-24.1327.issue.closed.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/backup_netfs.html">Example of BACKUP=NETFS</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../development/squash-git-log-commments.html">How to squash git log comments into one line</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear29.html">Release Notes ReaR 2.9</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear28.html">Release Notes ReaR 2.8</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#1327 Issue closed: Stalled recovery due to mkfs interactive prompt</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="1327_issue_closed_stalled_recovery_due_to_mkfs_interactive_prompt"><a href="https://github.com/rear/rear/issues/1327">#1327 Issue</a> <code>closed</code>: Stalled recovery due to mkfs interactive prompt<a class="headerlink" href="#1327_issue_closed_stalled_recovery_due_to_mkfs_interactive_prompt" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>enhancement</code>, <code>bug</code>, <code>cleanup</code>, <code>fixed / solved / done</code></p>
<h4 id="deacomm_opened_issue_at_2017-04-24_1251"><img src="https://avatars.githubusercontent.com/u/27956786?v=4" width="50"><a href="https://github.com/deacomm">deacomm</a> opened issue at <a href="https://github.com/rear/rear/issues/1327">2017-04-24 12:51</a>:<a class="headerlink" href="#deacomm_opened_issue_at_2017-04-24_1251" title="Permanent link">&para;</a></h4>
<p>During a restore, depending on what condition the target disk is in,
wipefs will sometimes not wipe existing filesystem from the block
device, and subsequent mkfs will stall the whole process, by
interactively asking for confirmation:</p>
<blockquote>
<p>2017-04-20 14:36:14 Creating filesystem of type ext3 with mount point
/boot on /dev/sda1.<br />
+++ Print 'Creating filesystem of type ext3 with mount point /boot on
/dev/sda1.'<br />
+++ test 1<br />
+++ echo -e 'Creating filesystem of type ext3 with mount point /boot
on /dev/sda1.'<br />
+++ wipefs -a /dev/sda1<br />
wipefs: /dev/sda1: ignoring nested "dos" partition table on non-whole
disk device<br />
wipefs: Use the --force option to force erase.<br />
+++ mkfs -t ext3 -b 4096 -i 16384 -U
5dc25119-fc7c-4d93-93fb-2b26a6916036 /dev/sda1<br />
mke2fs 1.42.11 (09-Jul-2014)<br />
Found a dos partition table in /dev/sda1<br />
Proceed anyway? (y,n)</p>
</blockquote>
<p>This prompt is visible in the log file, but not on system's console,
there is just an empty line with a blinking cursor. After I hit 'y' on
console, restore process continues.</p>
<p>This was on SLES12SP1, with rear 2.00 package from OBS:</p>
<blockquote>
<p>Name : rear Relocations: (not relocatable)<br />
Version : 2.00 Vendor: obs://build.opensuse.org/Archiving<br />
Release : 1 Build Date: Fri Jan 6 12:24:20 2017<br />
Install Date: (not installed) Build Host: lamb10<br />
Group : Applications/File Source RPM: rear-2.00-1.src.rpm<br />
Size : 1184748 License: GPLv3<br />
Signature : DSA/SHA1, Fri Jan 6 12:24:31 2017, Key ID 6b7485db725a0c43</p>
</blockquote>
<h4 id="schlomo_commented_at_2017-04-24_1310"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/issues/1327#issuecomment-296662350">2017-04-24 13:10</a>:<a class="headerlink" href="#schlomo_commented_at_2017-04-24_1310" title="Permanent link">&para;</a></h4>
<p>We could add <code>--force</code> to wipefs. Just need to find out if the older
distros support that parameter.</p>
<p>We already use <code>--force</code> with many other tools so that this would be
good thing for wipefs too.</p>
<h4 id="gozora_commented_at_2017-04-24_1315"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/1327#issuecomment-296663654">2017-04-24 13:15</a>:<a class="headerlink" href="#gozora_commented_at_2017-04-24_1315" title="Permanent link">&para;</a></h4>
<p>I'm afraid that will not be universal enough :-(<br />
on my Ubunty Trusty:</p>
<pre><code># wipefs --force
wipefs: unrecognized option '--force'
</code></pre>
<p>Maybe <code>--force</code> is available only on newer versions ?</p>
<p>V.</p>
<h4 id="schlomo_commented_at_2017-04-24_1316"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/issues/1327#issuecomment-296663977">2017-04-24 13:16</a>:<a class="headerlink" href="#schlomo_commented_at_2017-04-24_1316" title="Permanent link">&para;</a></h4>
<p>Or the traditional <code>wipefs .... &lt;&lt;&lt;y</code> :-)</p>
<h4 id="gozora_commented_at_2017-04-24_1318"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/1327#issuecomment-296664486">2017-04-24 13:18</a>:<a class="headerlink" href="#gozora_commented_at_2017-04-24_1318" title="Permanent link">&para;</a></h4>
<p>You just don't like pipes, do you? :-)</p>
<h4 id="jsmeix_commented_at_2017-04-24_1321"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1327#issuecomment-296665284">2017-04-24 13:21</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-04-24_1321" title="Permanent link">&para;</a></h4>
<p>In general FYI:<br />
The whole current 'wipefs' implementation is likely insufficient,<br />
see
<a href="https://github.com/rear/rear/issues/799">https://github.com/rear/rear/issues/799</a></p>
<h4 id="schlomo_commented_at_2017-04-24_1321"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/issues/1327#issuecomment-296665504">2017-04-24 13:21</a>:<a class="headerlink" href="#schlomo_commented_at_2017-04-24_1321" title="Permanent link">&para;</a></h4>
<p>I find <code>y | wipefs ...</code> indeed less readable. And it spawns another
shell for literally nothing. I prefer to use Bash with all what it can
do for us.</p>
<h4 id="jsmeix_commented_at_2017-04-24_1324"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1327#issuecomment-296666601">2017-04-24 13:24</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-04-24_1324" title="Permanent link">&para;</a></h4>
<p>@schlomo @gozora<br />
I think the issue is not about that wipefs needs user input,<br />
the issue is that mkfs stops and needs user input<br />
because wipefs did not fully clean up the disk before.</p>
<h4 id="jsmeix_commented_at_2017-04-24_1329"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1327#issuecomment-296668498">2017-04-24 13:29</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-04-24_1329" title="Permanent link">&para;</a></h4>
<p>@deacomm FYI:<br />
wipefs does not wipe whole existing filesystems.<br />
All what wipefs does is to wipe some well known areas<br />
of partitions (like /dev/sda2) or disks (like /dev/sda).<br />
Depending on what condition the target disk is in<br />
wipefs may fail to wipe this or that particular remainders.</p>
<h4 id="jsmeix_commented_at_2017-04-24_1331"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1327#issuecomment-296669217">2017-04-24 13:31</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-04-24_1331" title="Permanent link">&para;</a></h4>
<p>Regarding<br />
"prompt is visible in the log file, but not on system's console"<br />
see
<a href="https://github.com/rear/rear/issues/885">https://github.com/rear/rear/issues/885</a><br />
which is about the other way round.</p>
<h4 id="jsmeix_commented_at_2017-04-24_1342"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1327#issuecomment-296672094">2017-04-24 13:42</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-04-24_1342" title="Permanent link">&para;</a></h4>
<p>I know this mke2fs behaviour</p>
<pre>
Found a dos partition table in /dev/sda1
Proceed anyway? (y,n)
</pre>

<p>very well from my experiments with<br />
"Generic system installation with the plain SUSE installation system"<br />
cf.
<a href="https://en.opensuse.org/SDB:Disaster_Recovery">https://en.opensuse.org/SDB:Disaster_Recovery</a></p>
<p>I do not remember well but I think something like</p>
<pre>
wipefs -a -f /dev/sda1
wipefs -a -f /dev/sda
</pre>

<p>helped.</p>
<p>@gozora<br />
regarding whether or not wipefs supports '-f'<br />
remember how we implemented things like 'mkfs -U' in<br />
layout/prepare/GNU/Linux/130_include_filesystem_code.sh<br />
just try the preferred modern way and if that fails fall back<br />
to the traditional way:</p>
<pre>
wipefs -a -f /dev/sda1 || wipefs -a /dev/sda1
wipefs -a -f /dev/sda || wipefs -a /dev/sda
</pre>

<p>On my SLES12 system:</p>
<pre>
# man wipefs
...
  -f, --force
    Force erasure, even if the filesystem is mounted.
    This is required in order to erase a partition-table
    signature on a block device.
</pre>

<p>versus on my SLES11 system where "man wipefs"<br />
does not tell about '-f, --force'.</p>
<h4 id="deacomm_commented_at_2017-04-24_1343"><img src="https://avatars.githubusercontent.com/u/27956786?v=4" width="50"><a href="https://github.com/deacomm">deacomm</a> commented at <a href="https://github.com/rear/rear/issues/1327#issuecomment-296672294">2017-04-24 13:43</a>:<a class="headerlink" href="#deacomm_commented_at_2017-04-24_1343" title="Permanent link">&para;</a></h4>
<p>@jsmeix Either wipefs has to reliably prepare ground for subsequent
mkfs, or the script calling mkfs has to account for the possibility of
wipefs not doing its thing, and act accordingly. As it is now, between
wipefs and mkfs calls the system is in indeterminate state.</p>
<p>One partial workaround would be to print mkfs output to console, so that
user at least knows why the recovery is stalled, and knows that they can
just press 'y' to continue.</p>
<h4 id="jsmeix_commented_at_2017-04-24_1349"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1327#issuecomment-296674131">2017-04-24 13:49</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-04-24_1349" title="Permanent link">&para;</a></h4>
<p>Only FYI<br />
here some excerpts from my newest generic installation script<br />
(my quick and ditry hack to install a system with LVM)<br />
where I use wipefs as planned<br />
in
<a href="https://github.com/rear/rear/issues/799">https://github.com/rear/rear/issues/799</a><br />
plus proper waiting for block device nodes according<br />
to
<a href="https://github.com/rear/rear/issues/791">https://github.com/rear/rear/issues/791</a></p>
<pre>
# Partitioning:
harddisk_disklabel="msdos"
harddisk_devices="/dev/sda /dev/sdb /dev/sdc"
partition1_begin_percentage="0"
partition1_end_percentage="40"
partition2_begin_percentage="$partition1_end_percentage"
partition2_end_percentage="100"
# LVM:
lvm_PVs="/dev/sda1 /dev/sda2 /dev/sdb1 /dev/sdb2 /dev/sdc1 /dev/sdc2"
lvm_VG="system"
lvm_LV_swap_size="2g"
lvm_LV_root_size="4g"
lvm_LV_home_size="3g"
# Filesystems:
LV_swap_prepare_command="mkswap -f"
LV_filesystem="ext4"
LV_make_filesystem_command="mkfs.$LV_filesystem -F"
...
# First of all clean up possibly already existing partitions:
for partition in $lvm_PVs
do test -b $partition && wipefs -a -f $partition || true
done
for harddisk_device in $harddisk_devices
do test -b $harddisk_device && wipefs -a -f $harddisk_device || true
done
# Make partitions on the harddisk devices:
for harddisk_device in $harddisk_devices
do # Wait until the harddisk device node exists:
   until test -b $harddisk_device
   do echo "Waiting until $harddisk_device exists (retrying in 1 second)"
      sleep 1
   done
   # Erase filesystem, raid or partition-table signatures (magic strings) to clean up a used disk before making filesystems:
   wipefs -a -f $harddisk_device
   # Create new disk label. The new disk label will have no partitions:
   parted -s $harddisk_device mklabel $harddisk_disklabel
   # Make partitions on a harddisk device:
   # Use hardcoded parted fs-type "ext2" as dummy for now regardless what filesystem will be actually created there later:
   parted -s --align=optimal $harddisk_device unit % mkpart primary ext2 $partition1_begin_percentage $partition1_end_percentage
   parted -s $harddisk_device set 1 lvm on type 0x8e
   parted -s --align=optimal $harddisk_device unit % mkpart primary ext2 $partition2_begin_percentage $partition2_end_percentage
   parted -s $harddisk_device set 2 lvm on type 0x8e
done
# Enable boot flag on /dev/sda1:
parted -s /dev/sda set 1 boot on
# Report what is actually set up by parted:
for harddisk_device in $harddisk_devices
do parted -s $harddisk_device unit GiB print
done
# Wait until all partition device nodes exist:
for partition_device in $lvm_PVs
do until test -b $partition_device
   do echo "Waiting until $partition_device exists (retrying in 1 second)"
      sleep 1
   done
done
# LVM setup:
# LVM metadata cannot be backed up (to /etc/lvm) because /etc/lvm is read-only in the SUSE installation system
# and any backups that are stored inside the SUSE installation system are useless
# so that automated metadata backup is disabled with '--autobackup n'.
# Do not use lvmetad in the SUSE installation system to avoid many confusing warning messages from LVM tools.
# Because /etc/lvm is read-only it is moved away and a writable copy is created:
mv /etc/lvm /etc/lvm.orig
mkdir /etc/lvm
set +f
cp -a /etc/lvm.orig/* /etc/lvm
set -f
grep 'use_lvmetad = 1' /etc/lvm/lvm.conf && sed -i -e 's/use_lvmetad = 1/use_lvmetad = 0/' /etc/lvm/lvm.conf
# Initialize all partitions for use by LVM as PVs:
pvcreate --verbose --yes -ff $lvm_PVs
# Create a single volume group of all PVs (i.e. of all partitions):
vgcreate --verbose --yes --autobackup n $lvm_VG $lvm_PVs
# Create logical volumes in the existing volume group:
lvcreate --verbose --yes --autobackup n --size $lvm_LV_swap_size --name swap $lvm_VG
swap_LV_device="/dev/$lvm_VG/swap"
lvcreate --verbose --yes --autobackup n --size $lvm_LV_root_size --name root $lvm_VG
root_LV_device="/dev/$lvm_VG/root"
lvcreate --verbose --yes --autobackup n --size $lvm_LV_home_size --name home $lvm_VG
home_LV_device="/dev/$lvm_VG/home"
# Set up swap:
# Wait until the swap LV device node exists:
until test -b $swap_LV_device
do echo "Waiting until $swap_LV_device exists (retrying in 1 second)"
   sleep 1
done
# Erase filesystem, raid or partition-table signatures (magic strings) to clean up a used disk before making filesystems:
wipefs -a -f $swap_LV_device
# Prepare swap LV:
$LV_swap_prepare_command $swap_LV_device
# Use the swap LV:
swapon --fixpgsz $swap_LV_device
# Set up root filesystem:
# Wait until the root LV device node exists:
until test -b $root_LV_device
do echo "Waiting until $root_LV_device exists (retrying in 1 second)"
   sleep 1
done
# Erase filesystem, raid or partition-table signatures (magic strings) to clean up a used disk before making filesystems:
wipefs -a -f $root_LV_device
# Make root LV filesystem:
$LV_make_filesystem_command $root_LV_device
# Set up home filesystem:
# Wait until the home LV device node exists:
until test -b $home_LV_device
do echo "Waiting until $home_LV_device exists (retrying in 1 second)"
   sleep 1
done
# Erase filesystem, raid or partition-table signatures (magic strings) to clean up a used disk before making filesystems:
wipefs -a -f $home_LV_device
# Make home LV filesystem:
$LV_make_filesystem_command $home_LV_device
# Probably useless but to be on the safe side wait until udev has finished:
udevadm settle --timeout=20
</pre>

<h4 id="jsmeix_commented_at_2017-04-24_1356"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1327#issuecomment-296676245">2017-04-24 13:56</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-04-24_1356" title="Permanent link">&para;</a></h4>
<p>I fixed my<br />
<a href="https://github.com/rear/rear/issues/1327#issuecomment-296672094">https://github.com/rear/rear/issues/1327#issuecomment-296672094</a></p>
<p>On an already used disk with partitions on it<br />
one must first 'wipefs' each partition block device<br />
and finally one can 'wipefs' the whole disk, cf.<br />
<a href="https://github.com/rear/rear/issues/799#issue-141001306">https://github.com/rear/rear/issues/799#issue-141001306</a></p>
<p>The other way round after 'wipefs' the whole disk<br />
there are probably no longer any partition block devices<br />
so that one cannot 'wipefs' them which may still leave<br />
this or that unwanted remainders on the disk that may<br />
re-appear after same partitions had been recreated.</p>
<h4 id="jsmeix_commented_at_2017-04-24_1403"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1327#issuecomment-296678268">2017-04-24 14:03</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-04-24_1403" title="Permanent link">&para;</a></h4>
<p>@deacomm<br />
I think on SLE12 the easiest way is<br />
when you just adapt wipefs_command<br />
or perhaps even simply run<br />
yes | rear ...</p>
<h4 id="gdha_commented_at_2017-04-24_1426"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/issues/1327#issuecomment-296685274">2017-04-24 14:26</a>:<a class="headerlink" href="#gdha_commented_at_2017-04-24_1426" title="Permanent link">&para;</a></h4>
<p>@jsmeix is it ok we assign this to you as SME?</p>
<h4 id="jsmeix_commented_at_2017-04-24_1443"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1327#issuecomment-296690631">2017-04-24 14:43</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-04-24_1443" title="Permanent link">&para;</a></h4>
<p>One cannot run</p>
<pre>
yes | rear recover
</pre>

<p>because the recovery system does not have 'yes'<br />
but one can run</p>
<pre>
echo -e 'y\ny\ny\ny\ny\ny\n' | rear recover
</pre>

<p>;-)</p>
<h4 id="jsmeix_commented_at_2017-04-24_1450"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1327#issuecomment-296692837">2017-04-24 14:50</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-04-24_1450" title="Permanent link">&para;</a></h4>
<p>@deacomm<br />
when you replace in<br />
usr/share/rear/layout/prepare/GNU/Linux/130_include_filesystem_code.sh</p>
<pre>
  wipefs_command="wipefs -a $device"
</pre>

<p>with</p>
<pre>
  wipefs_command="wipefs -a -f $device || wipefs -a $device"
</pre>

<p>does it then also work for you?<br />
(For me it works on SLE12.)</p>
<h4 id="schlomo_commented_at_2017-04-24_1806"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/issues/1327#issuecomment-296773969">2017-04-24 18:06</a>:<a class="headerlink" href="#schlomo_commented_at_2017-04-24_1806" title="Permanent link">&para;</a></h4>
<p>Careful. Trying one and then the other might also fail for other
reasons. Then better auto-detect, e.g. like this:</p>
<pre><code>wipefs_command="wipefs --all $(wipefs --help 2&gt;&amp;1 | grep --quiet force &amp;&amp; echo --force) $device"
</code></pre>
<p>(I prefer to spell out arguments for better readability)</p>
<h4 id="jsmeix_commented_at_2017-04-25_0951"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1327#issuecomment-296979604">2017-04-25 09:51</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-04-25_0951" title="Permanent link">&para;</a></h4>
<p>@schlomo<br />
I do not understand what could go wrong with things like</p>
<pre>
try_something || try_something_else || do_fallback
</pre>

<p>Could you explain and provide an example<br />
why this kind of code is bad?</p>
<p>Of course in</p>
<pre>
try_something || try_something_else || do_fallback
</pre>

<p>each one could fail for its own specific and different reasons<br />
but compared to what we do currently which is only plain</p>
<pre>
try_something
</pre>

<p>without any failure or error handling</p>
<pre>
try_something || try_something_else || do_fallback
</pre>

<p>should be an improvement.</p>
<h4 id="deacomm_commented_at_2017-04-25_1138"><img src="https://avatars.githubusercontent.com/u/27956786?v=4" width="50"><a href="https://github.com/deacomm">deacomm</a> commented at <a href="https://github.com/rear/rear/issues/1327#issuecomment-297002650">2017-04-25 11:38</a>:<a class="headerlink" href="#deacomm_commented_at_2017-04-25_1138" title="Permanent link">&para;</a></h4>
<p>Schlomo's wipefs_command works, wipefs is always called with --all
--force, and the recovery process finishes.</p>
<p>Thinking about it, I prefer the simplicity of try_something ||
try_something else, especially since you can't tell what wipefs --help
text will say in the future. Naively checking for presence of string
"force" might not be the safest, although it is very improbable to cause
issues in this particular case.</p>
<p>It's a matter of taste, really.</p>
<h4 id="schlomo_commented_at_2017-04-25_1228"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/issues/1327#issuecomment-297014255">2017-04-25 12:28</a>:<a class="headerlink" href="#schlomo_commented_at_2017-04-25_1228" title="Permanent link">&para;</a></h4>
<p>@jsmeix:</p>
<ol>
<li><code>command1 || command1 || failed</code> will always fall through to
    <code>command2</code> if <strong>anything</strong> goes wrong with <code>command1</code>. You won't
    know why it failed and the log file will be spammed with error
    messages that we consciously ignore. We cannot hide the STDERR of
    the first wipe because we might need its errors in case it fails for
    another reason (not the missing support for force).</li>
<li>How long takes <code>command1</code>? If the first variant takes a long time to
    fail then the user has to wait a long time for nothing. Of course in
    this case of <code>wipefs</code> this is less likely.</li>
<li>Being more explicit is always better for people who read the code
    later. Failing the <code>wipefs</code> command because of missing parameter
    support and then trying without the problematic parameter means that
    we don't explicitly test for the <code>--force</code> support but implicitly
    fail if it is not there (or anything else goes wrong).</li>
</ol>
<p>@deacomm IMHO checking the help output if <code>--force</code> is mentioned is a
very safe interface to decide that we can use the <code>--force</code> option. The
only case where this would fail if the developers for <code>wipefs</code> remove
that option and leave a text like "--force is no longer supported". Also
that I find extremely unlikely for <code>wipefs</code></p>
<p>BTW, several years ago we had a similar discussion in relation to the
different <code>syslinux</code> versions found on different distros and there in
the end @dagwieers introduced the concept of feature flags (see
<a href="https://github.com/rear/rear/blob/master/usr/share/rear/lib/bootloader-functions.sh#L91">set_syslinux_features()</a>).
The rationale there was also to favor explicit checks over implicit
failing.</p>
<h4 id="jsmeix_commented_at_2017-04-25_1301"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1327#issuecomment-297022365">2017-04-25 13:01</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-04-25_1301" title="Permanent link">&para;</a></h4>
<p>Anyone who likes may do an appropriate GitHub pull request.</p>
<h4 id="jsmeix_commented_at_2017-04-26_0810"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1327#issuecomment-297282457">2017-04-26 08:10</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-04-26_0810" title="Permanent link">&para;</a></h4>
<p>I hit the wrong button. This issue should stay open<br />
until an appropriate GitHub pull request was merged.</p>
<h4 id="jsmeix_commented_at_2017-04-28_1026"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1327#issuecomment-297964501">2017-04-28 10:26</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-04-28_1026" title="Permanent link">&para;</a></h4>
<p>@schlomo because of your<br />
<a href="https://github.com/rear/rear/issues/700#issuecomment-297960017">https://github.com/rear/rear/issues/700#issuecomment-297960017</a></p>
<p>I like to mention that</p>
<pre>
wipefs_command="wipefs --all $(wipefs --help 2>&1 | grep --quiet force && echo --force) $device"
</pre>

<p>would let ReaR fail on SLE11 if 'set -eu' was set in<br />
layout/prepare/GNU/Linux/130_include_filesystem_code.sh<br />
What happens on my SLE11 system<br />
(where wipefs does not support '--force')</p>
<pre>
# ( set -e ; device=/dev/sdXn ; wipefs_command="wipefs --all $(wipefs --help 2>&1 | grep --quiet force && echo --force) $device" ; echo $wipefs_command )
[no output]
</pre>

<p>This is because here 'grep' results non-zero exit code.</p>
<p>An additional side-note</p>
<pre>
wipefs_command="wipefs --all $(wipefs --help 2>&1 | grep --quiet force && echo --force) $device"
</pre>

<p>would call 'wipefs --all --force' when any kind of 'force' (sub)string<br />
appears in 'wipefs --help' (not necessarily the word '--force').</p>
<h4 id="jsmeix_commented_at_2017-04-28_1410"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1327#issuecomment-298008186">2017-04-28 14:10</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-04-28_1410" title="Permanent link">&para;</a></h4>
<p>In
<a href="https://github.com/rear/rear/pull/1336">https://github.com/rear/rear/pull/1336</a><br />
I implemented basically my above proposal in<br />
<a href="https://github.com/rear/rear/issues/1327#issuecomment-296672094">https://github.com/rear/rear/issues/1327#issuecomment-296672094</a><br />
and additionally now dd is used as generic fallback in any case,<br />
see my comments in the new code.</p>
<p>It seems to work o.k. for me on SLE12 with and without wipefs.<br />
Further enhancements welcome from whoever likes<br />
to maintain his enhancements also in the future ;-)</p>
<h4 id="jsmeix_commented_at_2017-04-28_1445"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1327#issuecomment-298017755">2017-04-28 14:45</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-04-28_1445" title="Permanent link">&para;</a></h4>
<p>With
<a href="https://github.com/rear/rear/pull/1336">https://github.com/rear/rear/pull/1336</a>
merged<br />
this issue should no longer happen in practice<br />
regardless that
<a href="https://github.com/rear/rear/pull/1336">https://github.com/rear/rear/pull/1336</a><br />
is not yet the ultimate solution, cf.<br />
<a href="https://github.com/rear/rear/pull/1336#issuecomment-298011438">https://github.com/rear/rear/pull/1336#issuecomment-298011438</a></p>
<h4 id="jsmeix_commented_at_2017-05-04_0815"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1327#issuecomment-299122826">2017-05-04 08:15</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-05-04_0815" title="Permanent link">&para;</a></h4>
<p>With
<a href="https://github.com/rear/rear/pull/1341">https://github.com/rear/rear/pull/1341</a>
merged<br />
the wipefs code is now cleaned up as described in<br />
<a href="https://github.com/rear/rear/pull/1336#issuecomment-298016104">https://github.com/rear/rear/pull/1336#issuecomment-298016104</a></p>
<p>It is still not yet the ultimate solution, i.e.<br />
<a href="https://github.com/rear/rear/pull/1336#issuecomment-298011438">https://github.com/rear/rear/pull/1336#issuecomment-298011438</a><br />
still applies.</p>
<h4 id="schlomo_commented_at_2017-06-19_0905"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/issues/1327#issuecomment-309381866">2017-06-19 09:05</a>:<a class="headerlink" href="#schlomo_commented_at_2017-06-19_0905" title="Permanent link">&para;</a></h4>
<p>I just realized that the title was somewhat misleading. We started from
<code>mkfs</code> needing a confirmation and ended up with a better implementation
of <code>wipefs</code> which removes most <code>mkfs</code> confirmation requests.</p>
<p>However, <code>mkfs</code> will still ask for confirmation on whole disks without
partition tables and this fix does not solve that use case.</p>
<p>Do you see any problem with adding the appropriate <strong>force</strong> option to
the various <code>mkfs</code> calls?</p>
<h4 id="jsmeix_commented_at_2017-06-19_1128"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1327#issuecomment-309413118">2017-06-19 11:28</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-06-19_1128" title="Permanent link">&para;</a></h4>
<p>In general I think that "rear recover" should enforce<br />
to recreate filesystems because when the admin<br />
runs "rear recover" he knows and wants to get<br />
all existing stuff on that machine replaced.</p>
<p>FYI some details:</p>
<p>Currently we use '-f' in case of xfs and btrfs cf.<br />
layout/prepare/GNU/Linux/130_include_filesystem_code.sh</p>
<p>But as far as I see we do not use '-f' for reiserfs.</p>
<p>For ext2/ext3/ext4 we do not use '-F' as far as I see.</p>
<p>For vfat it seems there is no force option<br />
according to "man mkfs.vfat" (except '-I' which also<br />
seems to be for whole disks without partition table).</p>
<p>For the fallback case we cannot use a force option<br />
because various mkfs.filesystem commands use<br />
different option characters (like '-f' versus 'F')<br />
or do not provide a force option.</p>
<h4 id="deacomm_commented_at_2017-06-26_1009"><img src="https://avatars.githubusercontent.com/u/27956786?v=4" width="50"><a href="https://github.com/deacomm">deacomm</a> commented at <a href="https://github.com/rear/rear/issues/1327#issuecomment-311018185">2017-06-26 10:09</a>:<a class="headerlink" href="#deacomm_commented_at_2017-06-26_1009" title="Permanent link">&para;</a></h4>
<p>FWIW, the title was correct. The interactive prompt came from mkfs.
Wipefs was involved because it failed to wipe the previous filesystem
signature before the mkfs call. I'm not sure whether wipefs even has an
interactive prompt of any kind.</p>
<p>This is just splitting hair, of course. :)</p>
<h4 id="jsmeix_commented_at_2017-06-26_1129"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1327#issuecomment-311033397">2017-06-26 11:29</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-06-26_1129" title="Permanent link">&para;</a></h4>
<p>@deacomm<br />
thanks for mentioning it.<br />
I think it is not just splitting hair to have a correct title<br />
because otherwise things are misleading and might<br />
get falsely fixed.<br />
Actually this issue is two issues:<br />
The one that I noticed matches your<br />
<a href="https://github.com/rear/rear/issues/1327#issuecomment-311018185">https://github.com/rear/rear/issues/1327#issuecomment-311018185</a><br />
but that alone is not sufficient as @schlomo found out in his<br />
<a href="https://github.com/rear/rear/issues/1327#issuecomment-309381866">https://github.com/rear/rear/issues/1327#issuecomment-309381866</a><br />
so that the full fix for issues like that is:<br />
Better clean up disks to avoid most mkfs confirmation requests<br />
(that was what I did)<br />
plus<br />
call mkfs with a 'force' option as far as possible for each<br />
particular filesystem (what @schlomo does).</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2025 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2017-04-24.1327.issue.closed.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/rear/rear-user-guide" class="fa fa-code-fork" style="color: #fcfcfc"> rear/rear-user-guide</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
