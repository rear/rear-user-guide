<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#1271 Issue closed: During "rear recover" all what matches ReaR sources like /dev/disk/by-label/REAR-000 or BACKUP_URL=usb://... must be sacrosanct - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#1271 Issue closed: During \"rear recover\" all what matches ReaR sources like /dev/disk/by-label/REAR-000 or BACKUP_URL=usb://... must be sacrosanct";
        var mkdocs_page_input_path = "issues/2017-03-29.1271.issue.closed.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/backup_netfs.html">Example of BACKUP=NETFS</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear29.html">Release Notes ReaR 2.9</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear28.html">Release Notes ReaR 2.8</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#1271 Issue closed: During "rear recover" all what matches ReaR sources like /dev/disk/by-label/REAR-000 or BACKUP_URL=usb://... must be sacrosanct</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="1271_issue_closed_during_rear_recover_all_what_matches_rear_sources_like_devdiskby-labelrear-000_or_backup_urlusb_must_be_sacrosanct"><a href="https://github.com/rear/rear/issues/1271">#1271 Issue</a> <code>closed</code>: During "rear recover" all what matches ReaR sources like /dev/disk/by-label/REAR-000 or BACKUP_URL=usb://... must be sacrosanct<a class="headerlink" href="#1271_issue_closed_during_rear_recover_all_what_matches_rear_sources_like_devdiskby-labelrear-000_or_backup_urlusb_must_be_sacrosanct" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>enhancement</code>, <code>fixed / solved / done</code>,
<code>critical / security / legal</code>, <code>severe improvement</code></p>
<h4 id="amtuannguyen_opened_issue_at_2017-03-29_1616"><img src="https://avatars.githubusercontent.com/u/5570513?v=4" width="50"><a href="https://github.com/amtuannguyen">amtuannguyen</a> opened issue at <a href="https://github.com/rear/rear/issues/1271">2017-03-29 16:16</a>:<a class="headerlink" href="#amtuannguyen_opened_issue_at_2017-03-29_1616" title="Permanent link">&para;</a></h4>
<p>when restore from USB backup disk that is the same size as the source
sda, the USB backup disk is selected as the sda to restore to and
therefore overwrite itself.</p>
<p>scenario:</p>
<p>Source system has 1 disk /dev/sda, size is 250GB<br />
Insert a USB disk that is exactly 250GB<br />
Run rear format and rear mkbackup<br />
Take the USB disk to a new machine and attempt to restore<br />
The recovery sees that sda (which is now the USB rear backup disk) is
exactly the same as the original and selects it automatically. It does
not offer a chance to map drives.<br />
Choose continue and sda is now wiped out along with your rear backup
image.</p>
<h4 id="amtuannguyen_commented_at_2017-03-29_1709"><img src="https://avatars.githubusercontent.com/u/5570513?v=4" width="50"><a href="https://github.com/amtuannguyen">amtuannguyen</a> commented at <a href="https://github.com/rear/rear/issues/1271#issuecomment-290157485">2017-03-29 17:09</a>:<a class="headerlink" href="#amtuannguyen_commented_at_2017-03-29_1709" title="Permanent link">&para;</a></h4>
<p>cat /etc/rear/local.conf<br />
MODULES_LOAD=( "${MODULES_LOAD[@]}" hid_generic usbhid )</p>
<p>BACKUP=NETFS<br />
OUTPUT=USB<br />
USB_DEVICE=/dev/disk/by-label/REAR-000<br />
BACKUP_URL=usb:///dev/disk/by-label/REAR-000</p>
<p>The restore scripts should NOT offer itself as the drive to restore to.
This is a potentially serious issue. Imagine restoring a completely dead
machine from a backup usb disk and having that usb disk destroyed during
the restore process.</p>
<h4 id="jsmeix_commented_at_2017-03-30_0812"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1271#issuecomment-290335670">2017-03-30 08:12</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-03-30_0812" title="Permanent link">&para;</a></h4>
<p>The generic root cause is that during "rear recover"<br />
"sda ... is now the USB rear backup disk"<br />
but var/lib/rear/layout/disklayout.conf<br />
lists /dev/sda as the disk device node<br />
that has to be used for recreating the system.</p>
<p>Essentially this issue is a generic problem in ReaR.<br />
For some background information see<br />
<a href="https://github.com/rear/rear/issues/1057#issuecomment-258832970">https://github.com/rear/rear/issues/1057#issuecomment-258832970</a><br />
and<br />
<a href="https://github.com/rear/rear/issues/1057#issuecomment-259444183">https://github.com/rear/rear/issues/1057#issuecomment-259444183</a></p>
<p>Regarding the particular issue that a disk device node<br />
that is listed in var/lib/rear/layout/disklayout.conf<br />
is during "rear recover" a disk device node<br />
that matches /dev/disk/by-label/REAR-000:</p>
<p>I will implement a special protection against<br />
this particular issue in ReaR.</p>
<p>Simply put:<br />
@amtuannguyen you are right, during "rear recover"<br />
any disk device node that matches /dev/disk/by-label/REAR-000<br />
(or more generally that matches BACKUP_URL)<br />
is sacrosanct.</p>
<h4 id="jsmeix_commented_at_2017-03-30_0855"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1271#issuecomment-290346440">2017-03-30 08:55</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-03-30_0855" title="Permanent link">&para;</a></h4>
<p>@amtuannguyen<br />
as a workaround for now you need to avoid that<br />
while the recovery system boots, the disk device node<br />
that matches /dev/disk/by-label/REAR-000<br />
becomes a disk device node in var/lib/rear/layout/disklayout.conf<br />
that is listed there as target for the recovery.<br />
My untested proposal how to do that is to have the<br />
USB storage not connected while the recovery system boots<br />
and connect it later and check what device node it gets<br />
before you run "rear recover".</p>
<h4 id="gdha_commented_at_2017-03-30_0935"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/issues/1271#issuecomment-290356261">2017-03-30 09:35</a>:<a class="headerlink" href="#gdha_commented_at_2017-03-30_0935" title="Permanent link">&para;</a></h4>
<p>@jsmeix <code>OUTPUT=USB</code> means it boots up from USB ;-/</p>
<h4 id="jsmeix_commented_at_2017-03-30_1033"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1271#issuecomment-290371467">2017-03-30 10:33</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-03-30_1033" title="Permanent link">&para;</a></h4>
<p>@gdha<br />
I do not understand what you mean.<br />
When a (removable) disk (e.g. a USB mass storage device)<br />
is used whereto "rear mkbackup" will write the recovery system<br />
and the backup.tar.gz, then during "rear mkbackup/mkrescue"<br />
that (removable) disk will be (over)written.<br />
The issue here is that this same disk must be sacrosact<br />
during "rear recover".<br />
With sacrosact I mean that nothing will be (over)written<br />
on that disk - i.e. that disk must be used read-only.<br />
I do not mean that one cannot boot from such a disk.<br />
Basically such a disk must be used like a CDROM.</p>
<h4 id="gdha_commented_at_2017-03-30_1108"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/issues/1271#issuecomment-290379172">2017-03-30 11:08</a>:<a class="headerlink" href="#gdha_commented_at_2017-03-30_1108" title="Permanent link">&para;</a></h4>
<p>@jsmeix What I meant was that the USB disk is used to boot from and it
also contains the backups, so it cannot be unattached, and therefore, in
@amtuannguyen case it will always be <em>sda</em>.<br />
IMHO issue #1063 is the way to go, and we make a <strong>blacklist</strong> file of
disks which are forbidden to use (just like we can do with
multipath.conf)</p>
<h4 id="jsmeix_commented_at_2017-03-30_1115"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1271#issuecomment-290380517">2017-03-30 11:15</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-03-30_1115" title="Permanent link">&para;</a></h4>
<p>@gdha<br />
many thanks for your explanation - it seems I get old<br />
or I should not try to do several things at the same time ;-)</p>
<h4 id="amtuannguyen_commented_at_2017-03-30_1121"><img src="https://avatars.githubusercontent.com/u/5570513?v=4" width="50"><a href="https://github.com/amtuannguyen">amtuannguyen</a> commented at <a href="https://github.com/rear/rear/issues/1271#issuecomment-290381857">2017-03-30 11:21</a>:<a class="headerlink" href="#amtuannguyen_commented_at_2017-03-30_1121" title="Permanent link">&para;</a></h4>
<p>@jsmeix @gdha Thanks for looking into this. If there is a way to
blacklist the backup disk during drive mapping so that it is not offered
as an option, that would be ideal. As it is right now, we have to edit
the disk layout file at recovery time and replace all occurrences of sda
(usb disk) with sdb (internal disk) and the recovery can proceed as
normal.</p>
<h4 id="gdha_commented_at_2017-03-30_1128"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/issues/1271#issuecomment-290383190">2017-03-30 11:28</a>:<a class="headerlink" href="#gdha_commented_at_2017-03-30_1128" title="Permanent link">&para;</a></h4>
<p>@amtuannguyen Unfortunately, the blacklist code is not yet written. We
will put it on wish-list, but cannot predict when it will be written
(free of charge). Of course, if you look at the
<a href="http://relax-and-recover.org/support/sponsors">http://relax-and-recover.org/support/sponsors</a>
page you can see we have alternatives foreseen</p>
<h4 id="jsmeix_commented_at_2017-03-30_1129"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1271#issuecomment-290383489">2017-03-30 11:29</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-03-30_1129" title="Permanent link">&para;</a></h4>
<p>Strange:<br />
For me it "just works" (but I did not use an actual USB stick):</p>
<p>I tested it (in the past and right now again)<br />
on two "same" virtual machines where I use<br />
one same second virtual disk /dev/sdb<br />
as /dev/disk/by-label/REAR-000 and for me both<br />
"rear mkbackup" on the one virtual machine and<br />
"rear recover" on the other virtual machine just worked.</p>
<p>On the virtual machine where I run "rear mkbackup"<br />
/dev/sda is my system disk:</p>
<pre>
# parted -s /dev/sda unit MiB print
Model: ATA QEMU HARDDISK (scsi)
Disk /dev/sda: 20480MiB
Sector size (logical/physical): 512B/512B
Partition Table: msdos
Disk Flags: 
Number  Start    End       Size      Type     File system     Flags
 1      1.00MiB  1490MiB   1489MiB   primary  linux-swap(v1)  type=82
 2      1490MiB  20480MiB  18990MiB  primary  ext4            boot, type=83

# grep -i USB etc/rear/local.conf 
OUTPUT=USB
USB_DEVICE=/dev/disk/by-label/REAR-000
USB_SUFFIX="mystuff"
USB_PARTITION_ALIGN_BLOCK_SIZE="32"
USB_DEVICE_FILESYSTEM_PERCENTAGE=49
BACKUP_URL=usb:///dev/disk/by-label/REAR-000

# usr/sbin/rear -d -D format /dev/sdb
Relax-and-Recover 2.00 / Git
Using log file: /root/rear/var/log/rear/rear-e205.log
USB device /dev/sdb is not formatted with ext2/3/4 or btrfs filesystem
Type exactly 'Yes' to format /dev/sdb with ext3 filesystem: Yes
Repartitioning '/dev/sdb'
Creating partition table of type 'msdos' on '/dev/sdb'
Creating ReaR data partition up to 49% of '/dev/sdb'
Setting 'boot' flag on /dev/sdb
Creating ext3 filesystem with label 'REAR-000' on '/dev/sdb1'
Adjusting filesystem parameters on '/dev/sdb1'

# parted -s /dev/sdb unit MiB print
Model: ATA QEMU HARDDISK (scsi)
Disk /dev/sdb: 8192MiB
Sector size (logical/physical): 512B/512B
Partition Table: msdos
Disk Flags: 
Number  Start    End      Size     Type     File system  Flags
 1      32.0MiB  4014MiB  3982MiB  primary  ext3         boot, type=83

# usr/sbin/rear -d -D mkbackup
...

# mount /dev/sdb1 /mnt

# find /mnt/rear/e205/
/mnt/rear/e205/
/mnt/rear/e205/mystuff
/mnt/rear/e205/mystuff/kernel
/mnt/rear/e205/mystuff/rear-e205.log
/mnt/rear/e205/mystuff/backup.tar.gz
/mnt/rear/e205/mystuff/backup.log
/mnt/rear/e205/mystuff/initrd.cgz
/mnt/rear/e205/mystuff/syslinux.cfg
</pre>

<p>I attach this virtual disk as second virtual disk<br />
to the other virtual machine where I run "rear recover"<br />
and when I boot from that disk I get in the recovery system:</p>
<pre>
# parted -s /dev/sda unit MiB print
Model: ATA QEMU HARDDISK (scsi)
Disk /dev/sda: 20480MiB
Sector size (logical/physical): 512B/512B
Partition Table: msdos
Disk Flags: 
Number  Start    End       Size      Type     File system     Flags
 1      1.00MiB  1490MiB   1489MiB   primary  linux-swap(v1)  type=83
 2      1490MiB  20480MiB  18990MiB  primary  ext4            boot, type=83

# parted -s /dev/sdb unit MiB print
Model: ATA QEMU HARDDISK (scsi)
Disk /dev/sdb: 8192MiB
Sector size (logical/physical): 512B/512B
Partition Table: msdos
Disk Flags: 
Number  Start    End      Size     Type     File system  Flags
 1      32.0MiB  4014MiB  3982MiB  primary  ext3         boot, type=83

# rear -d -D recover
...
Disk configuration is identical, proceeding with restore.
Start system layout restoration.
Creating partitions for disk /dev/sda (msdos)
Creating filesystem of type ext4 with mount point / on /dev/sda2.
...
Finished recovering your system. You can explore it under '/mnt/local'.

# reboot
</pre>

<p>and the recreated system "just works".</p>
<h4 id="gdha_commented_at_2017-03-30_1136"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/issues/1271#issuecomment-290384973">2017-03-30 11:36</a>:<a class="headerlink" href="#gdha_commented_at_2017-03-30_1136" title="Permanent link">&para;</a></h4>
<p>@amtuannguyen Could you show us the output of
<code>lsblk -ro TYPE,NAME,SIZE,SERIAL | grep disk</code> ?</p>
<h4 id="amtuannguyen_commented_at_2017-03-30_1144"><img src="https://avatars.githubusercontent.com/u/5570513?v=4" width="50"><a href="https://github.com/amtuannguyen">amtuannguyen</a> commented at <a href="https://github.com/rear/rear/issues/1271#issuecomment-290386444">2017-03-30 11:44</a>:<a class="headerlink" href="#amtuannguyen_commented_at_2017-03-30_1144" title="Permanent link">&para;</a></h4>
<p>@gdha @jsmeix<br />
Yes, that will work.<br />
But, the problem is only when</p>
<ol>
<li>the backup+rear+boot disk is a USB disk<br />
<em>and</em></li>
<li>it is the same size as the original system disk,<br />
<em>and</em></li>
<li>recovering on a different system with a single internal disk<br />
    that is different size than the original system.</li>
</ol>
<p>In this case the USB disk becomes sda and the internal disk<br />
becomes sdb, but the recovery system chooses sda automatically<br />
because it is identical to the original system disk.</p>
<p>Hope my explanation makes sense.</p>
<h4 id="jsmeix_commented_at_2017-03-30_1332"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1271#issuecomment-290411502">2017-03-30 13:32</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-03-30_1332" title="Permanent link">&para;</a></h4>
<p>I think I can relatively easily add something to<br />
layout/prepare/default/520_exclude_components.sh<br />
so that any component that matches<br />
USB_DEVICE or BACKUP_URL<br />
gets autmatically excluded from recreation<br />
(plus appropriate user information message<br />
and probably with an Error abort to be safe).</p>
<p>Regarding "matches USB_DEVICE or BACKUP_URL":<br />
My current basic idea is something like</p>
<pre>
backup_source=$( url_path $BACKUP_URL )
backup_source_partition=$( readlink -e $backup_source )
backup_source_disk=${backup_source_partition%%[1-9]*}

rescue_source_partition=$( readlink -e $USB_DEVICE )
rescue_source_disk=${rescue_source_partition%%[1-9]*}
</pre>

<p>and then exclude backup_source_disk<br />
and rescue_source_disk from recreation.</p>
<h4 id="gdha_commented_at_2017-03-30_1347"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/issues/1271#issuecomment-290415648">2017-03-30 13:47</a>:<a class="headerlink" href="#gdha_commented_at_2017-03-30_1347" title="Permanent link">&para;</a></h4>
<p>@jsmeix No I would look for a disk with the REAR-000 label and exclude
it. The source is not important at all as that is always excluded during
mkrescue/mkbackup. The problem will only occur in recover mode.</p>
<h4 id="amtuannguyen_commented_at_2017-03-30_1349"><img src="https://avatars.githubusercontent.com/u/5570513?v=4" width="50"><a href="https://github.com/amtuannguyen">amtuannguyen</a> commented at <a href="https://github.com/rear/rear/issues/1271#issuecomment-290416350">2017-03-30 13:49</a>:<a class="headerlink" href="#amtuannguyen_commented_at_2017-03-30_1349" title="Permanent link">&para;</a></h4>
<p>@jsmeix @gdha Agree. Excluding the REAR-000 label at recover time would
be easiest I think.</p>
<h4 id="jsmeix_commented_at_2017-03-30_1416"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1271#issuecomment-290424400">2017-03-30 14:16</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-03-30_1416" title="Permanent link">&para;</a></h4>
<p>@gdha @amtuannguyen you both assure me that such a disk<br />
must be labeled REAR-000 and not anything else?<br />
;-)</p>
<p>ReaR has already enough overoptimistic code<br />
that mostly works but sometimes fails,<br />
for example see this issue.</p>
<p>For example for me this "just works"<br />
(nothing at all labeled REAR-000):</p>
<pre>
# grep -i USB etc/rear/local.conf
OUTPUT=USB
USB_DEVICE=/dev/sdb1
USB_SUFFIX="mystuff"
USB_PARTITION_ALIGN_BLOCK_SIZE="32"
USB_DEVICE_FILESYSTEM_PERCENTAGE=49
BACKUP_URL=usb:///dev/sdb1

# e2label /dev/sdb1 mystuff

# ls -l /dev/disk/by-label/
lrwxrwxrwx 1 root root 10 Mar 30 16:03 mystuff -> ../../sdb1

# usr/sbin/rear -d -D mkbackup
...
</pre>

<p>then on the other system I boot from that sdb disk and</p>
<pre>
RESCUE e205:~ # ls -l /dev/disk/by-label/
lrwxrwxrwx 1 root root 10 Mar 30 14:12 mystuff -> ../../sdb1

RESCUE e205:~ # rear -d -D recover
...

RESCUE e205:~ # reboot
</pre>

<p>and the recreated system just works.</p>
<p>See also in<br />
<a href="https://github.com/rear/rear/issues/1160#issuecomment-272147697">https://github.com/rear/rear/issues/1160#issuecomment-272147697</a></p>
<pre>
BACKUP=NETFS
OUTPUT=USB
USB_DEVICE=/dev/disk/by-label/REAR-000
USB_PREFIX="rear/$HOSTNAME/fixedbackupdir"
BACKUP_URL=usb:///dev/disk/by-label/REAR-DATA
</pre>

<p>when "rear recover" could blindly overwrite the partition<br />
that matches /dev/disk/by-label/REAR-DATA which is<br />
the most valuable partition because there is the backup.</p>
<h4 id="jsmeix_commented_at_2017-03-30_1419"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1271#issuecomment-290425298">2017-03-30 14:19</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-03-30_1419" title="Permanent link">&para;</a></h4>
<p>I will try to make code so that "rear recover"<br />
does not overwrite its own sources:<br />
its own backup source (i.e. wherefrom it inputs the backup) or<br />
its own rescue system source (i.e. wherefrom it was launched).</p>
<h4 id="jsmeix_commented_at_2017-03-30_1421"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1271#issuecomment-290425869">2017-03-30 14:21</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-03-30_1421" title="Permanent link">&para;</a></h4>
<p>But first and foremost I must be able to reproduce it,<br />
then I can make code, then I can test that it works for me,<br />
then there could be a PullRequest, and finally<br />
@amtuannguyen you can verify whether or not<br />
is also works for you.</p>
<h4 id="jsmeix_commented_at_2017-03-30_1427"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1271#issuecomment-290427676">2017-03-30 14:27</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-03-30_1427" title="Permanent link">&para;</a></h4>
<p>For clarification:<br />
My proposal in<br />
<a href="https://github.com/rear/rear/issues/1271#issuecomment-290411502">https://github.com/rear/rear/issues/1271#issuecomment-290411502</a><br />
is about 520_exclude_components.sh which is only<br />
run during "rear recover" (and during "rear layoutonly")</p>
<pre>
# for w in $( ls usr/share/rear/lib/*-workflow.sh | cut -d '/' -f 5 | cut -d '-' -f 1 ) ; do usr/sbin/rear -s $w | grep _exclude_components && echo $w ; done
Source layout/prepare/default/520_exclude_components.sh
layoutonly
Source layout/prepare/default/520_exclude_components.sh
recover
</pre>

<p>Currently I have no plans to change anything<br />
during "rear mkbackup/mkrescue".</p>
<h4 id="jsmeix_commented_at_2017-03-30_1506"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1271#issuecomment-290440224">2017-03-30 15:06</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-03-30_1506" title="Permanent link">&para;</a></h4>
<p>FYI<br />
my first failed attempt to reproduce it<br />
and then how I could reproduce it:</p>
<p>On each of my two virtual machines I have now<br />
two virtual disks with same size (20 GiB)<br />
where the first virtual disk on the one virtual machine<br />
is /dev/sda where the system is installed and<br />
the second virtual disk /deb/sdb is used for ReaR:</p>
<pre>
# grep -i USB etc/rear/local.conf
OUTPUT=USB
USB_DEVICE=/dev/sdb1
USB_SUFFIX="mystuff"
USB_PARTITION_ALIGN_BLOCK_SIZE="32"
USB_DEVICE_FILESYSTEM_PERCENTAGE=49
BACKUP_URL=usb:///dev/sdb1

# ls -l /dev/disk/by-label/
lrwxrwxrwx 1 root root 10 Mar 30 16:35 mystuff -> ../../sdb1

# rear -d -D mkbackup
...
</pre>

<p>on the second virtual machine I use the above disk for ReaR<br />
as first virtual disk so that the ReaR disk is /dev/sda there<br />
and I have a second virtual disk /dev/sdb that is intended<br />
for the system:</p>
<pre>
RESCUE e205:~ # ls -l /dev/disk/by-label/
lrwxrwxrwx 1 root root 10 Mar 30 14:43 mystuff -> ../../sda1

RESCUE e205:~ # rear -d -D recover
Relax-and-Recover 2.00 / Git
Using log file: /var/log/rear/rear-e205.log
Running workflow recover within the ReaR rescue/recovery system
ERROR: Mount command 'mount -v -o rw,noatime /dev/sdb1 /tmp/rear.IWGUskyoFit9VHd/outputfs' failed.
Aborting due to an error, check /var/log/rear/rear-e205.log for details
Terminated

RESCUE e205:~ # less /var/log/rear/rear-e205.log
...
+ source /usr/share/rear/verify/NETFS/default/060_mount_NETFS_path.sh
...
++ mount_cmd='mount -v -o rw,noatime /dev/sdb1 /tmp/rear.IWGUskyoFit9VHd/outputfs'
...
++ eval mount -v -o rw,noatime /dev/sdb1 /tmp/rear.IWGUskyoFit9VHd/outputfs
+++ mount -v -o rw,noatime /dev/sdb1 /tmp/rear.IWGUskyoFit9VHd/outputfs
mount: special device /dev/sdb1 does not exist
</pre>

<p>This is correct because it is actually /dev/sda1<br />
but the hardcoded /dev/sdb1 in /etc/rear/local.conf<br />
fortunately saved me.</p>
<p>So I must reference the ReaR disk by label<br />
and then it does fail destructively:</p>
<pre>
RESCUE e205:~ # ls -l /dev/disk/by-label/mystuff
lrwxrwxrwx 1 root root 10 Mar 30 14:43 /dev/disk/by-label/mystuff -> ../../sda1

RESCUE e205:~ # vi /etc/rear/local.conf
...

RESCUE e205:~ # grep -i usb /etc/rear/local.conf
OUTPUT=USB
USB_DEVICE=/dev/disk/by-label/mystuff
USB_SUFFIX="mystuff"
USB_PARTITION_ALIGN_BLOCK_SIZE="32"
USB_DEVICE_FILESYSTEM_PERCENTAGE=49
BACKUP_URL=usb:///dev/disk/by-label/mystuff

RESCUE e205:~ # rear -d -D recover
# rear -d -D recover
/bin/bash: warning: setlocale: LC_ALL: cannot change locale (en_GB.iso885915)
Relax-and-Recover 2.00 / Git
Using log file: /var/log/rear/rear-e205.log
Running workflow recover within the ReaR rescue/recovery system
Using backup archive '/tmp/rear.szmtNVnl86oW9wW/outputfs/rear/e205/mystuff/backup.tar.gz'
Will do driver migration (recreating initramfs/initrd)
Calculating backup archive size
Backup archive size is 1.3G     /tmp/rear.szmtNVnl86oW9wW/outputfs/rear/e205/mystuff/backup.tar.gz (compressed)
Comparing disks.
Disk configuration is identical, proceeding with restore.
Start system layout restoration.
Creating partitions for disk /dev/sda (msdos)
Creating filesystem of type ext4 with mount point / on /dev/sda2.
Mounting filesystem /
Creating swap on /dev/sda1
Disk layout created.
ERROR: Mount command 'mount -v -o ro /dev/disk/by-label/mystuff /tmp/rear.szmtNVnl86oW9wW/outputfs' failed.
Aborting due to an error, check /var/log/rear/rear-e205.log for details
Terminated
RESCUE e205:~ # echo $?
143

RESCUE e205:~ # less /var/log/rear/rear-e205.log
...
+++ mount -v -o ro /dev/disk/by-label/mystuff /tmp/rear.szmtNVnl86oW9wW/outputfs
mount: special device /dev/disk/by-label/mystuff does not exist
...
</pre>

<p>Now all content on the ReaR disk got destroyed<br />
by creating the disk layout on the ReaR disk.</p>
<h4 id="jsmeix_commented_at_2017-03-31_0739"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1271#issuecomment-290640190">2017-03-31 07:39</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-03-31_0739" title="Permanent link">&para;</a></h4>
<p>In my above<br />
<a href="https://github.com/rear/rear/issues/1271#issuecomment-290440224">https://github.com/rear/rear/issues/1271#issuecomment-290440224</a><br />
I noticed right now</p>
<pre>
RESCUE e205:~ # rear -d -D recover
...
RESCUE e205:~ # less /var/log/rear/rear-e205.log
...
+ source /usr/share/rear/verify/NETFS/default/060_mount_NETFS_path.sh
...
++ mount_cmd='mount -v -o rw,noatime /dev/sdb1 /tmp/rear.IWGUskyoFit9VHd/outputfs'
</pre>

<p>I think during "rear recover" there is no need to mount the<br />
NETFS path where the backup is with 'rw'.<br />
I think during "rear recover" nothing should be written there.<br />
I think this violates that during "rear recover"<br />
all ReaR sources must be sacrosanct.<br />
I think I need to enhance and adapt much more to make<br />
the recover (and layoutonly and restoreonly) workflows safe<br />
against accidental damaging any ReaR sources.</p>
<p>@amtuannguyen<br />
for a quick band-aid for your particular use case<br />
(i.e. with a ReaR disk that is labeled "REAR-000")<br />
it should be possible that you to make an appropriate<br />
PRE_RECOVERY_SCRIPT that errors out when<br />
your particular ReaR disk is found in disklayout.conf</p>
<h4 id="jsmeix_commented_at_2017-03-31_0900"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1271#issuecomment-290658377">2017-03-31 09:00</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-03-31_0900" title="Permanent link">&para;</a></h4>
<p>The following PRE_RECOVERY_SCRIPT<br />
works for my particular use case:</p>
<pre>
PRE_RECOVERY_SCRIPT='disklayout_file=$( find / | grep disklayout.conf ) ; backup_path=$( url_path $BACKUP_URL ) ; backup_partition=$( readlink -e $backup_path ) ; backup_disk=${backup_partition%%[1-9]*} ; if test $backup_disk ; then for component in disk part fs swap ; do grep -q "^$component $backup_disk" $disklayout_file && Error "Found ReaR source in disklayout.conf as: $component $backup_disk" ; done ; fi'
</pre>

<p>It checks only BACKUP_URL but it can be easily enhanced<br />
to also check more things like USB_DEVICE as needed.</p>
<p>Now "rear recover" errors out:</p>
<pre>
RESCUE e205:~ # grep -i USB /etc/rear/local.conf
OUTPUT=USB
USB_DEVICE=/dev/disk/by-label/mystuff
USB_SUFFIX="mystuff"
USB_PARTITION_ALIGN_BLOCK_SIZE="32"
USB_DEVICE_FILESYSTEM_PERCENTAGE=49
BACKUP_URL=usb:///dev/disk/by-label/mystuff

RESCUE e205:~ # ls -l /dev/disk/by-label/
lrwxrwxrwx 1 root root 10 Mar 31 08:49 mystuff -> ../../sda1

RESCUE e205:~ # rear -d -D recover
/bin/bash: warning: setlocale: LC_ALL: cannot change locale (en_GB.iso885915)
Relax-and-Recover 2.00 / Git
Using log file: /var/log/rear/rear-e205.log
Running workflow recover within the ReaR rescue/recovery system
ERROR: Found ReaR source in disklayout.conf as: disk /dev/sda
Aborting due to an error, check /var/log/rear/rear-e205.log for details
Terminated

RESCUE e205:~ # less /var/log/rear/rear-e205.log
...
+ source /usr/share/rear/setup/default/010_pre_recovery_script.sh
...
++ eval 'disklayout_file=$( find / | grep disklayout.conf ) ; backup_path=$( url_path $BACKUP_URL ) ; backup_partition=$( readlink -e $backup_path ) ; backup_disk=${backup_partition%%[1-9]*} ; if test $backup_disk ; then for component in disk part fs swap ; do grep -q "^$component $backup_disk" $disklayout_file && Error "Found ReaR source in disklayout.conf as: $component $backup_disk" ; done ; fi'
++++ grep disklayout.conf
++++ find /
+++ disklayout_file=/root/rear/var/lib/rear/layout/disklayout.conf
++++ url_path usb:///dev/disk/by-label/mystuff
++++ local url=usb:///dev/disk/by-label/mystuff
++++ local url_without_scheme=/dev/disk/by-label/mystuff
++++ echo /dev/disk/by-label/mystuff
+++ backup_path=/dev/disk/by-label/mystuff
++++ readlink -e /dev/disk/by-label/mystuff
+++ backup_partition=/dev/sda1
+++ backup_disk=/dev/sda
+++ test /dev/sda
+++ for component in disk part fs swap
+++ grep -q '^disk /dev/sda' /root/rear/var/lib/rear/layout/disklayout.conf
+++ Error 'Found ReaR source in disklayout.conf as: disk /dev/sda'
...

RESCUE e205:~ # grep -v '^#' /root/rear/var/lib/rear/layout/disklayout.conf
disk /dev/sda 21474836480 msdos
part /dev/sda 1561329664 1048576 primary none /dev/sda1
part /dev/sda 19912458240 1562378240 primary boot /dev/sda2
fs /dev/sda2 / ext4 uuid=46d7e8be-7812-49d1-8d24-e25ed0589e94 label= blocksize=4096 reserved_blocks=5% max_mounts=-1 check_interval=0d bytes_per_inode=16377 default_mount_options=user_xattr,acl options=rw,relatime,data=ordered
swap /dev/sda1 uuid=28e43119-dac1-4426-a71a-1d70b26d33d7 label=
</pre>

<p>FYI: I have /root/rear/var/lib/rear/layout/disklayout.conf because<br />
I use a ReaR GitHub checkout in the /root/rear directory.</p>
<p>I decided that it won't help to exclude ReaR sources components<br />
from recreation because this would result an incomplete recreation.</p>
<p>Instead a clear Error abort is right here because in such cases<br />
the user must revise and adapt his disklayout.conf file<br />
in his recovery system.</p>
<p>E.g. in my case:</p>
<pre>
RESCUE e205:~ # sed -i -e 's/sda/sdb/g' /root/rear/var/lib/rear/layout/disklayout.conf

RESCUE e205:~ # grep -v '^#' /root/rear/var/lib/rear/layout/disklayout.conf
disk /dev/sdb 21474836480 msdos
part /dev/sdb 1561329664 1048576 primary none /dev/sdb1
part /dev/sdb 19912458240 1562378240 primary boot /dev/sdb2
fs /dev/sdb2 / ext4 uuid=46d7e8be-7812-49d1-8d24-e25ed0589e94 label= blocksize=4096 reserved_blocks=5% max_mounts=-1 check_interval=0d bytes_per_inode=16377 default_mount_options=user_xattr,acl options=rw,relatime,data=ordered
swap /dev/sdb1 uuid=28e43119-dac1-4426-a71a-1d70b26d33d7 label=

RESCUE e205:~ # rear -d -D recover
...
Disk configuration is identical, proceeding with restore.
Start system layout restoration.
Creating partitions for disk /dev/sdb (msdos)
Creating filesystem of type ext4 with mount point / on /dev/sdb2.
Mounting filesystem /
Creating swap on /dev/sdb1
Disk layout created.
Restoring from '/tmp/rear.HOP25kFgcUD7xVG/outputfs/rear/e205/mystuff/backup.tar.gz'...
...
Restoring finished.
...
Running mkinitrd...
Recreated initrd (/sbin/mkinitrd).
Installing GRUB2 boot loader
Finished recovering your system. You can explore it under '/mnt/local'.

RESCUE e205:~ # reboot
</pre>

<p>and the recreated system "just works".</p>
<h4 id="jsmeix_commented_at_2017-03-31_1146"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1271#issuecomment-290691305">2017-03-31 11:46</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-03-31_1146" title="Permanent link">&para;</a></h4>
<p>In contrast to my proposal in<br />
<a href="https://github.com/rear/rear/issues/1271#issuecomment-290411502">https://github.com/rear/rear/issues/1271#issuecomment-290411502</a><br />
I think now that I will add a separated script<br />
that is run as early as feasible during "rear recover"<br />
(and the other recovery-like workflows layoutonly and restoreonly)<br />
that checks if ReaR sources (i.e. data input for "rear recover"<br />
in particular the source wherefrom the backup will be restored)<br />
are listed as active entries in disklayout.conf and<br />
if yes that new script will Error out, cf.<br />
"Try to care about possible errors" in<br />
<a href="https://github.com/rear/rear/wiki/Coding-Style">https://github.com/rear/rear/wiki/Coding-Style</a></p>
<p>For the reason for Error abort see my results in<br />
<a href="https://github.com/rear/rear/issues/1271#issuecomment-290658377">https://github.com/rear/rear/issues/1271#issuecomment-290658377</a><br />
therein</p>
<pre>
I decided that it won't help to exclude
ReaR sources components from recreation
because this would result an incomplete recreation.

Instead a clear Error abort is right here because
in such cases the user must revise and adapt
his disklayout.conf file in his recovery system.
</pre>

<h4 id="jsmeix_commented_at_2017-05-22_0729"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1271#issuecomment-303020945">2017-05-22 07:29</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-05-22_0729" title="Permanent link">&para;</a></h4>
<p>I postpone it to a ReaR release after 2.1 (for now 2.2)<br />
because for now I won't find the time to implement if for ReaR 2.1<br />
and a workaround via PRE_RECOVERY_SCRIPT is possible cf.<br />
<a href="https://github.com/rear/rear/issues/1271#issuecomment-290658377">https://github.com/rear/rear/issues/1271#issuecomment-290658377</a></p>
<h4 id="jsmeix_commented_at_2017-07-14_1041"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1271#issuecomment-315329638">2017-07-14 10:41</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-07-14_1041" title="Permanent link">&para;</a></h4>
<p>According to<br />
<a href="https://github.com/rear/rear/issues/1398#issuecomment-315318878">https://github.com/rear/rear/issues/1398#issuecomment-315318878</a><br />
this issue here is postponed to ReaR v 2.3</p>
<h4 id="jsmeix_commented_at_2017-10-20_0959"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1271#issuecomment-338162729">2017-10-20 09:59</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-10-20_0959" title="Permanent link">&para;</a></h4>
<p>Since
<a href="https://github.com/rear/rear/issues/1535">https://github.com/rear/rear/issues/1535</a><br />
is implemented via
<a href="https://github.com/rear/rear/pull/1536">https://github.com/rear/rear/pull/1536</a><br />
there is no longer a hardcoded 'REAR-000' label.</p>
<h4 id="jsmeix_commented_at_2017-11-20_0925"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1271#issuecomment-345637871">2017-11-20 09:25</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-11-20_0925" title="Permanent link">&para;</a></h4>
<p>I have to postpone it again to a ReaR release after 2.3 (for now 2.4)<br />
because for now I won't find the time to implement if for ReaR 2.3.</p>
<h4 id="jsmeix_commented_at_2017-11-23_1433"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1271#issuecomment-346633365">2017-11-23 14:33</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-11-23_1433" title="Permanent link">&para;</a></h4>
<p>With
<a href="https://github.com/rear/rear/pull/1593">https://github.com/rear/rear/pull/1593</a>
merged<br />
issues like this one can and should be avoided.</p>
<p>Now layout/prepare/default/250_compare_disks.sh<br />
is much enhanced to make "rear recover" hopefully<br />
sufficiently safe against blindly proceeding when<br />
"Disk configuration looks identical"<br />
that can destroy things as in this issue here.</p>
<p>Additionally when "Disk configuration looks identical"<br />
there is still a UserInput() confirmation dialog<br />
with 30 seconds timeout to be on the safe side.<br />
In case of automated recovery that timeout<br />
could needlessly delay things. See<br />
<a href="https://github.com/rear/rear/pull/1593#issuecomment-346628678">https://github.com/rear/rear/pull/1593#issuecomment-346628678</a><br />
how to avoid that 30 seconds delay.</p>
<p>To be 100% on the safe side the user can now<br />
enforce the manual disk layout configuration mode<br />
via MIGRATION_MODE='true'.</p>
<p>On the other hand when the user knows the content<br />
in his var/lib/rear/layout/disklayout.conf or in his<br />
etc/rear/disklayout.conf file is "the right one" then<br />
he can now enforce to not switch into manual disk layout<br />
configuration mode via MIGRATION_MODE='false'.<br />
In this case "rear recover" blindly recreates according<br />
to the content in disklayout.conf and there is also<br />
no UserInput() confirmation dialog.</p>
<p>Currently I think this issue might be even already<br />
sufficiently fixed (or at least sufficiently avoided)<br />
by
<a href="https://github.com/rear/rear/pull/1593">https://github.com/rear/rear/pull/1593</a><br />
but I will keep this issue open for some time<br />
until I got some user feedback how the current<br />
ReaR GitHub master code behaves for your<br />
particular use cases.</p>
<h4 id="jsmeix_commented_at_2017-11-24_0953"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1271#issuecomment-346788244">2017-11-24 09:53</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-11-24_0953" title="Permanent link">&para;</a></h4>
<p>An addedum FYI:</p>
<p>Perhaps you may wonder why that<br />
UserInput() confirmation dialog (with its delay)<br />
is shown in any case even when it seems<br />
"Disk configuration really is identical"<br />
when on the original system only one single /dev/sda was used<br />
and on the replacement hardware /dev/sda with same size is found:</p>
<p>Even in this case things could get terribly wrong<br />
if "rear recover" would "just proceed" automatically<br />
when on the replacement hardware /dev/sda (with same size)<br />
is not the actually intended target disk but a disk with the<br />
recovery system plus the backup but the actual target disk<br />
is /dev/sdb with different (e.g. bigger) size.</p>
<p>On physical hardware this is probably rather unlikely<br />
but not on virtual machines when one uses virtual disks<br />
with same standard size (e.g. I use by default 20GiB for<br />
the disks on my virtual machines).</p>
<p>Therefore "better safe than sorry" and have<br />
that UserInput() confirmation dialog in any case.</p>
<h4 id="jsmeix_commented_at_2017-11-28_1517"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1271#issuecomment-347555836">2017-11-28 15:17</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-11-28_1517" title="Permanent link">&para;</a></h4>
<p>Right now I noticed that probably also<br />
<a href="https://github.com/rear/rear/issues/1437">https://github.com/rear/rear/issues/1437</a><br />
is an issue that is related to this issue here:<br />
When the original system was on /dev/sda<br />
but on the replacement hardware /dev/sda is a disk<br />
with the ReaR recovery system and the backup<br />
then
<a href="https://github.com/rear/rear/issues/1437">https://github.com/rear/rear/issues/1437</a><br />
might result that the bootloader of the original system<br />
gets installed on that /dev/sda which probably<br />
destroys someting of the ReaR recovery system<br />
(perhaps it is no longer bootable or things like that).</p>
<h4 id="andhoo_commented_at_2018-03-07_0039"><img src="https://avatars.githubusercontent.com/u/8149516?v=4" width="50"><a href="https://github.com/andhoo">andhoo</a> commented at <a href="https://github.com/rear/rear/issues/1271#issuecomment-370980775">2018-03-07 00:39</a>:<a class="headerlink" href="#andhoo_commented_at_2018-03-07_0039" title="Permanent link">&para;</a></h4>
<p>Years ago I had something similar that the wrong disk got overwritten
without user intervention. I made an modification but didn't do a pull
request for it. Take a look maybe it can be temporarily solution.
<a href="https://github.com/andhoo/rear/commit/748b3d76e6dedc76b9608e6eef88d66a23aaabb8">https://github.com/andhoo/rear/commit/748b3d76e6dedc76b9608e6eef88d66a23aaabb8</a></p>
<h4 id="jsmeix_commented_at_2018-05-03_0647"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1271#issuecomment-386204739">2018-05-03 06:47</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-05-03_0647" title="Permanent link">&para;</a></h4>
<p>Since<br />
<a href="https://github.com/rear/rear/issues/1271#issuecomment-346633365">https://github.com/rear/rear/issues/1271#issuecomment-346633365</a><br />
this issue is (hopefully) sufficiently mitigated<br />
so that there is no longer an actual pressure to get it solved for ReaR
2.4<br />
which means I can make it an "enhancement" for a "ReaR future" verion,<br />
cf.
<a href="https://github.com/rear/rear/issues/1790#issue-319663141">https://github.com/rear/rear/issues/1790#issue-319663141</a></p>
<h4 id="jsmeix_commented_at_2018-07-06_1211"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1271#issuecomment-403015904">2018-07-06 12:11</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-07-06_1211" title="Permanent link">&para;</a></h4>
<p>@amtuannguyen<br />
see
<a href="https://github.com/rear/rear/issues/1854">https://github.com/rear/rear/issues/1854</a><br />
for possible problems that may happen when the ReaR recovery system<br />
is on a normal disk that becomes /dev/sda on the replacement hardware<br />
even if with the current MIGRATION_MODE implementation<br />
the ultimate disaster (destroyed backup) should be avoided.</p>
<h4 id="jsmeix_commented_at_2020-03-06_1417"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1271#issuecomment-595787187">2020-03-06 14:17</a>:<a class="headerlink" href="#jsmeix_commented_at_2020-03-06_1417" title="Permanent link">&para;</a></h4>
<p>I am not fully satisfied with the current mitigation, cf.<br />
<a href="https://github.com/rear/rear/issues/1271#issuecomment-386204739">https://github.com/rear/rear/issues/1271#issuecomment-386204739</a></p>
<p>I hope I may find time to implement a better solution<br />
so I like to keep it open for some more time.</p>
<h4 id="github-actions_commented_at_2020-07-02_0133"><img src="https://avatars.githubusercontent.com/in/15368?v=4" width="50"><a href="https://github.com/apps/github-actions">github-actions</a> commented at <a href="https://github.com/rear/rear/issues/1271#issuecomment-652727909">2020-07-02 01:33</a>:<a class="headerlink" href="#github-actions_commented_at_2020-07-02_0133" title="Permanent link">&para;</a></h4>
<p>Stale issue message</p>
<h4 id="jsmeix_commented_at_2021-04-19_1224"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1271#issuecomment-822425412">2021-04-19 12:24</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-04-19_1224" title="Permanent link">&para;</a></h4>
<p>I reopen the issue as critical bug that I like to fix for ReaR 2.7
because<br />
a user reported to me via personal mail the following special case
where<br />
"rear recover" did not automatically go into MIGRATION_MODE<br />
but "just tried" to overwrite the ReaR recovery disk with the backup on
it.</p>
<p>What he reported (excerpts):</p>
<pre><code>Backup was done for a notebook with a single disk (320GB);
The backup usb disk with exactly the same size (320GB)
was used for "mkbackup" (=&gt; rescue media and backup tar file);
The disk in the notebook was replaced by an SSD with different size (500GB);
Booting from backup disk and calling "rear recover";
Rear detected exactly one disk with the original size (rescue media!) and
proposed this one for the target disk, without switching to migration mode
(I think so, not sure how to notice this...);
If I remember correctly there was a timeout of 300 seconds
to chose automatically the proposed target disk,
and without interaction the rescue media would be destroyed.
In this case there are no ambiguous target disks
but by detecting a single disk with a correctly matching size
"rear seems to be sure" that this one will be the correct target.
</code></pre>
<p>I want to find a solution to avoid that ReaR destroys its own disk.</p>
<p>I need to find a generically and reliable working way<br />
how to detect if a disk is "ReaR's own disk".</p>
<p>Off the top of my head I think the problem is that "ReaR's own disk"<br />
is not mounted while the ReaR recovery system is running<br />
(I did not test it right now) because the ReaR recovery system<br />
is running within a ramdisk.<br />
I think all what happens is that during booting from "ReaR's own disk"<br />
the bootloader on that disk loads the kernel and initrd<br />
(the initrd contains the ReaR recovery system files)<br />
into RAM and then the files of the initrd are unpacked into a ramdisk.<br />
So while the ReaR recovery system is running "ReaR's own disk"<br />
looks like any other "normal" disk.<br />
I would not like to mount all "normal" looking disks to be able<br />
to inspect if their contents look like "ReaR's own disk".</p>
<p>At least a test if a "normal" looking disks is the target<br />
of a /dev/disk/by-label/REAR-000 symlink<br />
should be implemented to avoid at least this common case.</p>
<h4 id="jsmeix_commented_at_2021-04-19_1236"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1271#issuecomment-822432624">2021-04-19 12:36</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-04-19_1236" title="Permanent link">&para;</a></h4>
<p>See also<br />
<a href="https://github.com/rear/rear/pull/2597#issuecomment-822431778">https://github.com/rear/rear/pull/2597#issuecomment-822431778</a></p>
<h4 id="olivero2_commented_at_2021-06-03_2201"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/issues/1271#issuecomment-854214081">2021-06-03 22:01</a>:<a class="headerlink" href="#olivero2_commented_at_2021-06-03_2201" title="Permanent link">&para;</a></h4>
<p>These are my recent encounters with <code>RAWDISK</code> output and a separate
backup drive (independent of ReaR) which prompted me to try to...</p>
<h2 id="stop_rear_from_overwriting_its_own_disk_and_backup_drives">Stop ReaR from overwriting its own disk and backup drives<a class="headerlink" href="#stop_rear_from_overwriting_its_own_disk_and_backup_drives" title="Permanent link">&para;</a></h2>
<h4 id="use_cases">Use Cases<a class="headerlink" href="#use_cases" title="Permanent link">&para;</a></h4>
<ol>
<li>
<p>I start <code>rear recover</code> on a virtual machine. The original system has
    three drives (<code>sda</code>, <code>sdb</code>, <code>sdc</code>), the recovery VM has two drives
    (<code>vda</code>, <code>vdb</code>), plus the recovery partition on another drive
    (<code>vdc</code>). The intention is to leave <code>sdc</code> unmapped. ReaR asks
    remapping questions for <code>sda</code> and <code>sdb</code>. Then it decides to map
    <code>sdc</code> to <code>vdc</code> without even asking. Continuing would overwrite the
    recovery system. I have to edit <code>/var/lib/rear/layout/disk_mappings</code>
    manually.</p>
</li>
<li>
<p>I start <code>rear recover</code> on a virtual machine, with a USB backup drive
    connected as <code>/dev/sda</code>. The original system's boot drive was also
    <code>/dev/sda</code>. ReaR asks remapping questions, but I do not notice that
    the <code>/dev/sdaX</code> partitions on the VM are actually those of the
    backup drive, while the VM boot drive would have been <code>/dev/vdaX</code>.
    ReaR happily overwrites the backup drive. This should never be
    possible.</p>
</li>
</ol>
<h4 id="some_ideas">Some Ideas<a class="headerlink" href="#some_ideas" title="Permanent link">&para;</a></h4>
<ol>
<li>
<p>The idea for use case 1 is to make ReaR remember its own partition
    table UUID and prevent overwriting the corresponding disk. I'll have
    to check separately for cases where ReaR resides on a partition of a
    disk while it is used to restore other partitions on that same disk.</p>
</li>
<li>
<p>The idea for use case 2 is to have an array variable
    <code>PROTECTED_FILE_SYSTEM_LABELS</code> containing patterns for file systems
    labels. File systems with a matching label would then be protected
    from being overwritten. The user would generally have to specify
    these labels (we cannot know the labels of backup disks which are
    independent of ReaR).</p>
</li>
</ol>
<p>I'd like to explore this a bit further and might come up with a PR if
that doesn't interfere with other people's work. I'd like to do this in
a way that is either generic (not limited to <code>RAWDISK</code>) or at least
easily extendable (to <code>USB</code>, for example). No promises at this point (I
might not find a solution within the time I have available for this),
but: Should I try?</p>
<h4 id="github-actions_commented_at_2021-08-03_0219"><img src="https://avatars.githubusercontent.com/in/15368?v=4" width="50"><a href="https://github.com/apps/github-actions">github-actions</a> commented at <a href="https://github.com/rear/rear/issues/1271#issuecomment-891460899">2021-08-03 02:19</a>:<a class="headerlink" href="#github-actions_commented_at_2021-08-03_0219" title="Permanent link">&para;</a></h4>
<p>Stale issue message</p>
<h4 id="jsmeix_commented_at_2021-10-26_1213"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1271#issuecomment-951877610">2021-10-26 12:13</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-10-26_1213" title="Permanent link">&para;</a></h4>
<p>With
<a href="https://github.com/rear/rear/pull/2626">https://github.com/rear/rear/pull/2626</a>
merged<br />
this issue should be sufficiently solved now.</p>
<p>@OliverO2<br />
many thanks for your severe improvement of ReaR!</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2025 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2017-03-29.1271.issue.closed.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/rear/rear-user-guide" class="fa fa-code-fork" style="color: #fcfcfc"> rear/rear-user-guide</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
