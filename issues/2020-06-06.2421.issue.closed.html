<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#2421 Issue closed: Expect include files in OpenSSH client (ssh) and server (sshd) configuration - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#2421 Issue closed: Expect include files in OpenSSH client (ssh) and server (sshd) configuration";
        var mkdocs_page_input_path = "issues/2020-06-06.2421.issue.closed.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a> &raquo;</li>
      <li class="breadcrumb-item active">#2421 Issue closed: Expect include files in OpenSSH client (ssh) and server (sshd) configuration</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="2421_issue_closed_expect_include_files_in_openssh_client_ssh_and_server_sshd_configuration"><a href="https://github.com/rear/rear/issues/2421">#2421 Issue</a> <code>closed</code>: Expect include files in OpenSSH client (ssh) and server (sshd) configuration<a class="headerlink" href="#2421_issue_closed_expect_include_files_in_openssh_client_ssh_and_server_sshd_configuration" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>enhancement</code>, <code>fixed / solved / done</code></p>
<h4 id="olivero2_opened_issue_at_2020-06-06_2213"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> opened issue at <a href="https://github.com/rear/rear/issues/2421">2020-06-06 22:13</a>:<a class="headerlink" href="#olivero2_opened_issue_at_2020-06-06_2213" title="Permanent link">&para;</a></h4>
<p>From the OpenSSH <a href="https://www.openssh.com/releasenotes.html">release
notes</a>:</p>
<p><strong>OpenSSH 7.3</strong>/7.3p1 (2016-08-01):</p>
<ul>
<li>ssh(1): Add an Include directive for ssh_config(5) files.</li>
</ul>
<p><strong>OpenSSH 8.2</strong>/8.2p1 (2020-02-14):</p>
<ul>
<li>sshd(8): add an Include sshd_config keyword that allows including<br />
    additional configuration files via glob(3) patterns.</li>
</ul>
<p><strong>Ubuntu 20.04 LTS</strong> with OpenSSH 8.2 uses this directive at the top of
its configuration files.</p>
<ol>
<li>
<p>In <code>/etc/ssh/ssh_config</code>:
        Include /etc/ssh/ssh_config.d/*.conf</p>
</li>
<li>
<p>In <code>/etc/ssh/sshd_config</code>:
        Include /etc/ssh/sshd_config.d/*.conf</p>
</li>
</ol>
<p>Where ReaR currently scans, copies or patches such files, it should
expect additional settings living in seperate configuration files
referenced by the <code>Include</code> directive.</p>
<p>The current <a href="http://manpages.ubuntu.com/manpages/focal/en/man5/sshd_config.5.html">manual
page</a>
states:</p>
<blockquote>
<p>/etc/ssh/sshd_config.d/*.conf files are included at the start of the
configuration file, so<br />
options set there will override those in /etc/ssh/sshd_config.</p>
</blockquote>
<p>So it would be sufficient to insert ReaR overrides at the beginning of a
patched configuration file (as it is done currently) without worrying
about any duplicate setting later on in any include file or in the main
configuration file.</p>
<p>An important detail regarding <code>Match</code> directives is not documented in
the manual pages but in this <a href="https://bugzilla.mindrot.org/show_bug.cgi?id=2468#c26">Bugzilla
comment</a>:</p>
<blockquote>
<p>Included files do not affect the match context of the file including
them.</p>
</blockquote>
<h4 id="jsmeix_commented_at_2020-06-08_0823"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2421#issuecomment-640448800">2020-06-08 08:23</a>:<a class="headerlink" href="#jsmeix_commented_at_2020-06-08_0823" title="Permanent link">&para;</a></h4>
<p>@OliverO2 @gdha<br />
do you think this is something that must be done for ReaR 2.6<br />
or can it be done later for ReaR 2.7?</p>
<p>FYI:<br />
SLES15 SP1 and openSUSE Leap 15.1 have openssh-7.9p1 while<br />
SLES15 SP1 and openSUSE Leap 15.2 will have openssh-8.1p1<br />
and openSUSE Tubleweed already has openssh-8.1p1</p>
<h4 id="gdha_commented_at_2020-06-08_0925"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/issues/2421#issuecomment-640484829">2020-06-08 09:25</a>:<a class="headerlink" href="#gdha_commented_at_2020-06-08_0925" title="Permanent link">&para;</a></h4>
<p>@OliverO2 @jsmeix As ReaR-2.6 will be used on RedHat 8 and Ubuntu 20 I
would pin this issue to release 2.6 if you do not mind?</p>
<p>RedHat 7: openssh-7.4p1-21 and does not have a /etc/ssh/ssh_config.d
directory<br />
RedHat 8: openssh-8.0p1-4 and does have /etc/ssh/ssh_config.d/
directory<br />
Fedora 32: openssh-8.3p1-2 and does have /etc/ssh/ssh_config.d/
directory</p>
<h4 id="olivero2_commented_at_2020-06-08_0932"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/issues/2421#issuecomment-640488807">2020-06-08 09:32</a>:<a class="headerlink" href="#olivero2_commented_at_2020-06-08_0932" title="Permanent link">&para;</a></h4>
<p>@jsmeix @gdha The current code works as is on Ubuntu 20.04 as those <code>.d</code>
directories are empty as distributed. So I had considered it as an issue
to watch for future releases. If I remember correctly, we should be
mostly concerned with the code that scans for unprotected SSH private
keys as such keys might live in files below <code>/etc/ssh/ssh_config.d</code> in
the future.</p>
<h4 id="gdha_commented_at_2020-06-08_0938"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/issues/2421#issuecomment-640492076">2020-06-08 09:38</a>:<a class="headerlink" href="#gdha_commented_at_2020-06-08_0938" title="Permanent link">&para;</a></h4>
<p>@OliverO2 @jsmeix RedHat 8 includes the following:</p>
<pre><code>$ cat /etc/ssh/ssh_config.d/05-redhat.conf
# The options here are in the "Match final block" to be applied as the last
# options and could be potentially overwritten by the user configuration
Match final all
        # Follow system-wide Crypto Policy, if defined:
        Include /etc/crypto-policies/back-ends/openssh.config

        GSSAPIAuthentication yes

# If this option is set to yes then remote X11 clients will have full access
# to the original X11 display. As virtually no X11 client supports the untrusted
# mode correctly we set this to yes.
        ForwardX11Trusted yes

# Send locale-related environment variables
        SendEnv LANG LC_CTYPE LC_NUMERIC LC_TIME LC_COLLATE LC_MONETARY LC_MESSAGES
        SendEnv LC_PAPER LC_NAME LC_ADDRESS LC_TELEPHONE LC_MEASUREMENT
        SendEnv LC_IDENTIFICATION LC_ALL LANGUAGE
        SendEnv XMODIFIERS

# Uncomment this if you want to use .local domain
# Host *.local

$ cat /etc/crypto-policies/back-ends/openssh.config
Ciphers aes256-gcm@openssh.com,chacha20-poly1305@openssh.com,aes256-ctr,aes256-cbc,aes128-gcm@openssh.com,aes128-ctr,aes128-cbc
MACs hmac-sha2-256-etm@openssh.com,hmac-sha1-etm@openssh.com,umac-128-etm@openssh.com,hmac-sha2-512-etm@openssh.com,hmac-sha2-256,hmac-sha1,umac-128@openssh.com,hmac-sha2-512
GSSAPIKexAlgorithms gss-gex-sha1-,gss-group14-sha1-
KexAlgorithms curve25519-sha256,curve25519-sha256@libssh.org,ecdh-sha2-nistp256,ecdh-sha2-nistp384,ecdh-sha2-nistp521,diffie-hellman-group-exchange-sha256,diffie-hellman-group14-sha256,diffie-hellman-group16-sha512,diffie-hellman-group18-sha512,diffie-hellman-group-exchange-sha1,diffie-hellman-group14-sha1
PubkeyAcceptedKeyTypes rsa-sha2-256,rsa-sha2-256-cert-v01@openssh.com,ecdsa-sha2-nistp256,ecdsa-sha2-nistp256-cert-v01@openssh.com,ecdsa-sha2-nistp384,ecdsa-sha2-nistp384-cert-v01@openssh.com,rsa-sha2-512,rsa-sha2-512-cert-v01@openssh.com,ecdsa-sha2-nistp521,ecdsa-sha2-nistp521-cert-v01@openssh.com,ssh-ed25519,ssh-ed25519-cert-v01@openssh.com,ssh-rsa,ssh-rsa-cert-v01@openssh.com
CASignatureAlgorithms rsa-sha2-256,ecdsa-sha2-nistp256,ecdsa-sha2-nistp384,rsa-sha2-512,ecdsa-sha2-nistp521,ssh-ed25519,ssh-rsa
</code></pre>
<h4 id="olivero2_commented_at_2020-06-08_0951"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/issues/2421#issuecomment-640499017">2020-06-08 09:51</a>:<a class="headerlink" href="#olivero2_commented_at_2020-06-08_0951" title="Permanent link">&para;</a></h4>
<p>The RedHat 8 configuration looks Interesting. Two levels of <code>Include</code>
files.</p>
<p>If you'd like to tackle this, it would probably be safest to</p>
<ul>
<li>scan and interpret the include directives (which may contain glob
    expressions) recursively,</li>
<li>copy the included files onto the recovery system,</li>
<li>scan included <code>ssh</code> config files for unprotected private keys.</li>
</ul>
<p>To me, it looks like there is no need to change patching <code>sshd_config</code>
done by <code>usr/share/rear/build/default/500_ssh_setup.sh</code> as the current
code works properly even in the presence of included files.</p>
<p>(Note that you cannot just concatenate included files to create a new
configuration as this would change <code>Match</code> contexts and result in
different semantics.)</p>
<h4 id="jsmeix_commented_at_2020-06-08_1155"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2421#issuecomment-640557462">2020-06-08 11:55</a>:<a class="headerlink" href="#jsmeix_commented_at_2020-06-08_1155" title="Permanent link">&para;</a></h4>
<p>Regarding<br />
<a href="https://github.com/rear/rear/issues/2421#issuecomment-640488807">https://github.com/rear/rear/issues/2421#issuecomment-640488807</a></p>
<p>Via
<a href="https://github.com/rear/rear/pull/2422">https://github.com/rear/rear/pull/2422</a><br />
I overhauled how SSH config files are parsed for IdentityFile values<br />
to find (and remove) unprotected SSH keys in the recovery system.<br />
Now <code>find ./etc/ssh</code> should ensure that SSH 'Include' config files<br />
e.g. in /etc/ssh/ssh_config.d/ are also parsed.</p>
<h4 id="jsmeix_commented_at_2020-06-08_1211"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2421#issuecomment-640564259">2020-06-08 12:11</a>:<a class="headerlink" href="#jsmeix_commented_at_2020-06-08_1211" title="Permanent link">&para;</a></h4>
<p>Regarding "copy the included files onto the recovery system" in<br />
<a href="https://github.com/rear/rear/issues/2421#issuecomment-640499017">https://github.com/rear/rear/issues/2421#issuecomment-640499017</a></p>
<p>In usr/share/rear/rescue/default/500_ssh.sh we have (excerpts):</p>
<pre><code>if is_true "$SSH_FILES" ; then
    ...
    copy_as_is_ssh_files=( /etc/s[s]h ... )
...
... COPY_AS_IS+=( "${copy_as_is_ssh_files[@]}" )
</code></pre>
<p>so with explicit <code>SSH_FILES="yes"</code> the user can get<br />
all below <code>/etc/ssh</code> copied into his recovery system<br />
(including sensitive SSH files therein).</p>
<h4 id="jsmeix_commented_at_2020-06-09_0942"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2421#issuecomment-641170936">2020-06-09 09:42</a>:<a class="headerlink" href="#jsmeix_commented_at_2020-06-09_0942" title="Permanent link">&para;</a></h4>
<p>With
<a href="https://github.com/rear/rear/pull/2422">https://github.com/rear/rear/pull/2422</a>
merged the part<br />
about "the code that scans for unprotected SSH private keys" in<br />
<a href="https://github.com/rear/rear/issues/2421#issuecomment-640488807">https://github.com/rear/rear/issues/2421#issuecomment-640488807</a><br />
should now be fixed.</p>
<h4 id="olivero2_commented_at_2020-06-09_1347"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/issues/2421#issuecomment-641308421">2020-06-09 13:47</a>:<a class="headerlink" href="#olivero2_commented_at_2020-06-09_1347" title="Permanent link">&para;</a></h4>
<p>I'd say this issue can be closed.</p>
<p>The patching code is still correct. For recent OpenSSH versions, we
would no longer need to uncomment overridden settings which appear later
in the configuration file, as only the first setting rules. However,
older versions of sshd might see things differently and possibly
complain about multiple definitions of the same setting. So for now I'd
say it is best if we leave it at that.</p>
<h4 id="jsmeix_commented_at_2020-06-15_0748"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2421#issuecomment-643963209">2020-06-15 07:48</a>:<a class="headerlink" href="#jsmeix_commented_at_2020-06-15_0748" title="Permanent link">&para;</a></h4>
<p>@OliverO2<br />
thank you for attentive issue report and your help and your checks<br />
to have things properly adapted in ReaR for recent OpenSSH versions.</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2023 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2020-06-06.2421.issue.closed.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
