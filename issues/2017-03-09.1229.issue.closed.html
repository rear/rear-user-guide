<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#1229 Issue closed: DRLM ReaR multiple configs support (-C config_name) - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#1229 Issue closed: DRLM ReaR multiple configs support (-C config_name)";
        var mkdocs_page_input_path = "issues/2017-03-09.1229.issue.closed.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/backup_netfs.html">Example of BACKUP=NETFS</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/netfs_nas.html">Internal Backup with tar to NFS server</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../scenarios/netfs_rsync.md">Internal Backup with rsync to NFS server</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/rbme.html">External Backup using RBME</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/restic.html">External Backup using restic</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../development/squash-git-log-commments.html">How to squash git log comments into one line</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear29.html">Release Notes ReaR 2.9</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear28.html">Release Notes ReaR 2.8</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#1229 Issue closed: DRLM ReaR multiple configs support (-C config_name)</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="1229_issue_closed_drlm_rear_multiple_configs_support_-c_config_name"><a href="https://github.com/rear/rear/issues/1229">#1229 Issue</a> <code>closed</code>: DRLM ReaR multiple configs support (-C config_name)<a class="headerlink" href="#1229_issue_closed_drlm_rear_multiple_configs_support_-c_config_name" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>enhancement</code>, <code>documentation</code>, <code>fixed / solved / done</code>,
<code>external tool</code></p>
<h4 id="didacog_opened_issue_at_2017-03-09_0951"><img src="https://avatars.githubusercontent.com/u/5380209?u=163f1571e6b9c9c7df94e2c6ca152b0a7406b52d&v=4" width="50"><a href="https://github.com/didacog">didacog</a> opened issue at <a href="https://github.com/rear/rear/issues/1229">2017-03-09 09:51</a>:<a class="headerlink" href="#didacog_opened_issue_at_2017-03-09_0951" title="Permanent link">&para;</a></h4>
<h4 id="relax-and-recover_rear_issue_template">Relax-and-Recover (rear) Issue Template<a class="headerlink" href="#relax-and-recover_rear_issue_template" title="Permanent link">&para;</a></h4>
<p>Please fill in the following items before submitting a new issue (quick
response is not guaranteed with free support):</p>
<ul>
<li>rear version (/usr/sbin/rear -V): 2.00</li>
<li>Brief description of the issue: Provide support for Multiple backups
    configuration from DRLM.</li>
</ul>
<p>Hi @jsmeix,</p>
<p>In order to provide support for Multiple backup methods I'm almost ready
to send a PR with other improvements regarding ReaR-DRLM integration,
but I want to inform you about this because some code from ReaR main
script should be moved to the beginning of the init stage.</p>
<p>lines 417-455 from /usr/sbin/rear should be moved to:</p>
<p><strong>usr/share/rear/init/default/005_set_config_append_files.sh</strong>:</p>
<pre>
if drlm_is_managed ; then
    return 0
fi

# source additional configuration files if specified on the command line:
if test "$CONFIG_APPEND_FILES" ; then
    for config_append_file in $CONFIG_APPEND_FILES ; do
        # If what is specified on the command line starts with '/' an absolute path is meant
        # otherwise what is specified on the command line means a file in CONFIG_DIR.
        # Files in CONFIG_DIR get automatically copied into the recovery system but
        # other files are added to COPY_AS_IS to get them copied into the recovery system:
        case "$config_append_file" in
            (/*)
                config_append_file_path="$config_append_file"
                # If "-C foo" was specified on the command line but 'foo' does not exist
                # try if 'foo.conf' exists and if yes, use that:
                if test -r "$config_append_file_path" ; then
                    COPY_AS_IS=( "${COPY_AS_IS[@]}" "$config_append_file_path" )
                else if test -r "$config_append_file_path.conf" ; then
                         COPY_AS_IS=( "${COPY_AS_IS[@]}" "$config_append_file_path.conf" )
                     else
                         Error "There is '-C $config_append_file' but neither '$config_append_file_path' nor '$config_append_file_path.conf' can be read."
                     fi
                fi
                ;;
            (*)
                config_append_file_path="$CONFIG_DIR/$config_append_file"
                ;;
        esac
        # If "-C foo" was specified on the command line but 'foo' does not exist
        # try if 'foo.conf' exists and if yes, use that:
        if test -r "$config_append_file_path" ; then
            LogPrint "Sourcing additional configuration file '$config_append_file_path'"
            Source "$config_append_file_path"
        else if test -r "$config_append_file_path.conf" ; then
                 LogPrint "Sourcing additional configuration file '$config_append_file_path.conf'"
                 Source "$config_append_file_path.conf"
             else
                 Error "There is '-C $config_append_file' but neither '$config_append_file_path' nor '$config_append_file_path.conf' can be read."
             fi
        fi
    done
fi
</pre>

<p>This way works as expected if not managed by drlm, and in case is
managed the configurations are downloaded from DRLM REST api.</p>
<p>I tested it and works as expected, but before the PR I prefer to talk
with you about this change.</p>
<p>Regards,</p>
<h4 id="jsmeix_commented_at_2017-03-09_1005"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-285308905">2017-03-09 10:05</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-03-09_1005" title="Permanent link">&para;</a></h4>
<p>@didacog<br />
many thanks for your information in advance!</p>
<p>But I do not understand why the whole support for the<br />
generic '-C' parameter is disabled if drlm_is_managed?</p>
<p>The support for the '-C' parameter is generic functionality<br />
in ReaR which is not only meant for multiple backups<br />
but meant as general useful functionality.</p>
<p>Multiple backups require the '-C' parameter<br />
but the '-C' parameter does not require multiple backups.</p>
<p>Multiple backups is only one particular use case of the<br />
gererically working '-C' parameter.</p>
<p>Wiht what you propose you make the gereric '-C' parameter<br />
a DRLM dependant special case parameter.</p>
<p>This is not the intent of the gereric '-C' parameter.</p>
<p>Simply put:<br />
You cannot cripple a gereric parameter that is described<br />
generically in the rear man page and in 'rear --help'<br />
into a special case thing that depends on DRLM settings.</p>
<h4 id="jsmeix_commented_at_2017-03-09_1006"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-285309339">2017-03-09 10:06</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-03-09_1006" title="Permanent link">&para;</a></h4>
<p>@didacog<br />
when you describe me your reasoning behind why you think<br />
you must disable the '-C' parameter if drlm_is_managed,<br />
I think we can find a solution that works generically<br />
also if drlm_is_managed.</p>
<h4 id="jsmeix_commented_at_2017-03-09_1016"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-285311576">2017-03-09 10:16</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-03-09_1016" title="Permanent link">&para;</a></h4>
<p>@didacog<br />
a very quick offhanded proposal:</p>
<p>Because DRLM_MANAGED=y is set in local.conf<br />
and because local.conf is read before other config files<br />
are read that are specified via the '-C' parameter<br />
I think one can avoid that other config files have any effect<br />
by specifying in the other config files something like</p>
<pre>
drlm_is_managed && return
</pre>

<p>My proposal assumes the usr/share/rear/lib/drlm-functions.sh<br />
is read like the other ReaR functions files before rear<br />
reads the config files. If not a generic test for DRLM_MANAGED<br />
must be used.</p>
<h4 id="jsmeix_commented_at_2017-03-09_1022"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-285313075">2017-03-09 10:22</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-03-09_1022" title="Permanent link">&para;</a></h4>
<p>I have tested my above proposal and for me it "just works".</p>
<p>In etc/rear/local.conf I have</p>
<pre>
DRLM_MANAGED=y
</pre>

<p>and additionally I have that etc/rear/testy.conf</p>
<pre>
this_file_name=$( basename ${BASH_SOURCE[0]} )
if drlm_is_managed ; then
    echo DRLM_MANAGED
    return
else
    echo not DRLM_MANAGED
fi
echo reading $this_file_name
</pre>

<p>and I get</p>
<pre>
# usr/sbin/rear -d -D -C testy mkrescue
Relax-and-Recover 2.00 / Git
Using log file: /root/rear/var/log/rear/rear-e205.log
Sourcing additional configuration file '/root/rear/etc/rear/testy.conf'
DRLM_MANAGED
ERROR: ReaR only can be run from DRLM Server ('DRLM_MANAGED=y' is set)
Aborting due to an error, check /root/rear/var/log/rear/rear-e205.log for details
Terminated
</pre>

<h4 id="didacog_commented_at_2017-03-09_1037"><img src="https://avatars.githubusercontent.com/u/5380209?u=163f1571e6b9c9c7df94e2c6ca152b0a7406b52d&v=4" width="50"><a href="https://github.com/didacog">didacog</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-285316452">2017-03-09 10:37</a>:<a class="headerlink" href="#didacog_commented_at_2017-03-09_1037" title="Permanent link">&para;</a></h4>
<p>@jsmeix</p>
<p>I'm not disabling -C confname, just skip loading confname from
/etc/rear/* if DRLM_MANAGED=y because those config files will be
loaded from DRLM RESTful API.</p>
<p>if not managed ReaR will load confname as usual and returning Error if
not found.</p>
<h4 id="didacog_commented_at_2017-03-09_1045"><img src="https://avatars.githubusercontent.com/u/5380209?u=163f1571e6b9c9c7df94e2c6ca152b0a7406b52d&v=4" width="50"><a href="https://github.com/didacog">didacog</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-285318164">2017-03-09 10:45</a>:<a class="headerlink" href="#didacog_commented_at_2017-03-09_1045" title="Permanent link">&para;</a></h4>
<p>@jsmeix see the new code on drlm-functions that will be used in
<strong>usr/share/rear/init/default/010_set_drlm_env.sh</strong>:</p>
<pre>
function drlm_import_runtime_config() {

    for arg in "${ARGS[@]}" ; do
        key=DRLM_"${arg%%=*}"
        val="${arg#*=}"
        eval $key='$val'
        Log "Setting $key=$val"
    done

    if ! has_binary curl ; then
        Error "Need 'curl' to download DRLM dynamic configuration. Please install curl and try again."
    fi

    if [[ "$DRLM_SERVER" && "$DRLM_REST_OPTS" && "$DRLM_ID" ]]; then
        local DRLM_CFG="/tmp/drlm_config"
        local http_response_code=$(curl $verbose -f -s -S -w '%{http_code}' $DRLM_REST_OPTS -o $DRLM_CFG https://$DRLM_SERVER/clients/$DRLM_ID/config/$CONFIG_APPEND_FILES)
        test "200" = "$http_response_code" || Error "curl failed with HTTP response code '$http_response_code'."
        eval $(cat $DRLM_CFG)
        rm $DRLM_CFG
    else
        Error "ReaR only can be run from DRLM Server ('DRLM_MANAGED=y' is set)"
    fi

}

function drlm_send_log() {

    # send log file in real time to DRLM
    (
    tail -f --lines=5000 --pid=$$ $RUNTIME_LOGFILE | curl $verbose -T- -f -s -S $DRLM_REST_OPTS https://$DRLM_SERVER/client/$DRLM_ID/log/$WORKFLOW/$(date +%
Y%m%d%H%M%S)
    ) &

}
</pre>

<p>As you can see, the CONFIG_APPEND_FILES will be applied from DRLM:</p>
<pre>
curl $verbose -f -s -S -w '%{http_code}' $DRLM_REST_OPTS -o $DRLM_CFG https://$DRLM_SERVER/clients/$DRLM_ID/config/$CONFIG_APPEND_FILES
</pre>

<h4 id="jsmeix_commented_at_2017-03-09_1112"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-285323930">2017-03-09 11:12</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-03-09_1112" title="Permanent link">&para;</a></h4>
<p>I do not like how DRLM inferferes with ReaR's usual behaviour<br />
but when DRLM must inferfere I would prefer to do it directly<br />
where it is currently done i.e. in usr/sbin/rear and not to move<br />
functionality that is done in usr/sbin/rear (i.e. loading config
files)<br />
away into a rear script where such functionality is not expected.</p>
<p>For me the following change in usr/sbin/rear<br />
seems to do what you need:</p>
<pre>
# Finally source additional configuration files if specified on the command line:
if test "$CONFIG_APPEND_FILES" ; then
    # If DRLM_MANAGED=y additional configuration files will be loaded by DRLM:
    if drlm_is_managed ; then
        LogPrint "DRLM_MANAGED: DRLM will load additional configuration files: $CONFIG_APPEND_FILES"
    else
        for config_append_file in $CONFIG_APPEND_FILES ; do
            [...]
        done
    fi
fi
</pre>

<p>With that I get</p>
<pre>
# usr/sbin/rear -d -D -C 'foo bar baz' mkrescue
Relax-and-Recover 2.00 / Git
Using log file: /root/rear/var/log/rear/rear-e205.log
DRLM_MANAGED: DRLM will load additional configuration files: foo bar baz
ERROR: ReaR only can be run from DRLM Server ('DRLM_MANAGED=y' is set)
Aborting due to an error, check /root/rear/var/log/rear/rear-e205.log for details
Terminated
</pre>

<p>If this also works for you I would perefer to have it implemented<br />
this way (i.e. directly in usr/sbin/rear) because this way<br />
it is more obvious where and how DRLM inferferes<br />
with ReaR's usual behaviour (in contrast to when that<br />
is moved away and somewhat 'hidden' in a rear script).</p>
<h4 id="didacog_commented_at_2017-03-09_1120"><img src="https://avatars.githubusercontent.com/u/5380209?u=163f1571e6b9c9c7df94e2c6ca152b0a7406b52d&v=4" width="50"><a href="https://github.com/didacog">didacog</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-285325481">2017-03-09 11:20</a>:<a class="headerlink" href="#didacog_commented_at_2017-03-09_1120" title="Permanent link">&para;</a></h4>
<p>@jsmeix @gdha</p>
<p>No problem for me, I was just following the guidelines from @schlomo
when we integrated DRLM first time, that's why the init stage was
created for. and assuming that -C loads extra config I assumed that
should be moved to that init stage.</p>
<h4 id="jsmeix_commented_at_2017-03-09_1120"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-285325611">2017-03-09 11:20</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-03-09_1120" title="Permanent link">&para;</a></h4>
<p>@gdha<br />
I also assigned you because I would like to get your<br />
opinion about how currently @didacog plans how<br />
DRLM inferferes with ReaR's usual behaviour.</p>
<p>I would prefer when tools that use ReaR do not need<br />
code changes in ReaR but only call usr/sbin/rear with<br />
appropriate parameters and appropriate config files.</p>
<p>From my point of view when tools that use ReaR<br />
need code changes in ReaR, it looks as if something<br />
basic is not well designed in those tools?</p>
<h4 id="jsmeix_commented_at_2017-03-09_1122"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-285326000">2017-03-09 11:22</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-03-09_1122" title="Permanent link">&para;</a></h4>
<p>I don't know about the guidelines from @schlomo<br />
about how tools that use ReaR should do it.<br />
Can I get those guidelines or a URL of them?</p>
<h4 id="jsmeix_commented_at_2017-03-09_1123"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-285326233">2017-03-09 11:23</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-03-09_1123" title="Permanent link">&para;</a></h4>
<p>@schlomo<br />
I also assigned you because I would like to learn<br />
the above mentioned guidelines from you<br />
about how tools that use ReaR should do it.</p>
<h4 id="didacog_commented_at_2017-03-09_1319"><img src="https://avatars.githubusercontent.com/u/5380209?u=163f1571e6b9c9c7df94e2c6ca152b0a7406b52d&v=4" width="50"><a href="https://github.com/didacog">didacog</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-285349148">2017-03-09 13:19</a>:<a class="headerlink" href="#didacog_commented_at_2017-03-09_1319" title="Permanent link">&para;</a></h4>
<p>@jsmeix your proposal here is ok for me, as I said, I just wanted to
follow the first integration with rear, but is ok for me the following:</p>
<pre>
# Finally source additional configuration files if specified on the command line:
if test "$CONFIG_APPEND_FILES" ; then
    # If DRLM_MANAGED=y additional configuration files will be loaded by DRLM:
    if drlm_is_managed ; then
        LogPrint "DRLM_MANAGED: DRLM will load additional configuration files: $CONFIG_APPEND_FILES"
    else
        for config_append_file in $CONFIG_APPEND_FILES ; do
            [...]
        done
    fi
fi
</pre>

<p>If there is no problem, I will change this way.</p>
<p>Regards,</p>
<h4 id="jsmeix_commented_at_2017-03-09_1443"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-285369964">2017-03-09 14:43</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-03-09_1443" title="Permanent link">&para;</a></h4>
<p>@didacog<br />
at least from me you get hereby a clear OK<br />
to go ahead and change it as written above.</p>
<p>Regardless whether or not that is the final very best way<br />
to implement it, what is most important is that we can<br />
make it working, cf. "Dirty hacks welcome" in<br />
<a href="https://github.com/rear/rear/wiki/Coding-Style">https://github.com/rear/rear/wiki/Coding-Style</a></p>
<h4 id="jsmeix_commented_at_2017-03-15_1018"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-286699330">2017-03-15 10:18</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-03-15_1018" title="Permanent link">&para;</a></h4>
<p>I think no comments from @gdha or @schlomo<br />
means silent agreement.</p>
<h4 id="didacog_commented_at_2017-03-15_1043"><img src="https://avatars.githubusercontent.com/u/5380209?u=163f1571e6b9c9c7df94e2c6ca152b0a7406b52d&v=4" width="50"><a href="https://github.com/didacog">didacog</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-286705161">2017-03-15 10:43</a>:<a class="headerlink" href="#didacog_commented_at_2017-03-15_1043" title="Permanent link">&para;</a></h4>
<p>I guess so, I have my rear fork with the changes, I'll send the PR after
testing them.</p>
<h4 id="gdha_commented_at_2017-03-15_1047"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-286706036">2017-03-15 10:47</a>:<a class="headerlink" href="#gdha_commented_at_2017-03-15_1047" title="Permanent link">&para;</a></h4>
<p>ReaR config files have no direct connections with DRLM without that
being provided. Therefore, we should be careful with blowing up our main
script by trying to source other programs configs. I think that is what
@schlomo meant. So, I have not decided yet which way to go. Perhaps
@schlomo has no objections, but I cannot speak for him of course<br />
Gratien</p>
<p>Verstuurd vanaf mijn iPhone</p>
<blockquote>
<p>Op 15 mrt. 2017 om 11:18 heeft Johannes Meixner
<a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#110;&#111;&#116;&#105;&#102;&#105;&#99;&#97;&#116;&#105;&#111;&#110;&#115;&#64;&#103;&#105;&#116;&#104;&#117;&#98;&#46;&#99;&#111;&#109;">&#110;&#111;&#116;&#105;&#102;&#105;&#99;&#97;&#116;&#105;&#111;&#110;&#115;&#64;&#103;&#105;&#116;&#104;&#117;&#98;&#46;&#99;&#111;&#109;</a> het volgende geschreven:</p>
<p>I think no comments from @gdha or @schlomo<br />
means silent agreement.</p>
<p>‚Äî<br />
You are receiving this because you were mentioned.<br />
Reply to this email directly, view it on GitHub, or mute the thread.</p>
</blockquote>
<h4 id="schlomo_commented_at_2017-03-15_1147"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-286718863">2017-03-15 11:47</a>:<a class="headerlink" href="#schlomo_commented_at_2017-03-15_1147" title="Permanent link">&para;</a></h4>
<p>I went over this entire topic (BTW, first time I consciously notice the
extra configs feature so you get my thoughts on that as well) and would
like to share my thoughts with you:</p>
<p>About moving the code:</p>
<ul>
<li>I am in favor of moving stuff from the main script to the init
    stage. I think that it will help us to make the code more readable
    and should also bring us closer to writing unit tests for single
    scriptlets.</li>
<li>I am not entirely happy with the way that DRLM disables ReaR stuff
    in different places. IMHO we should strive for a better separation
    of concerns and also accept that a DRLM user could intentionally
    misconfigure his system. Therefore I would not like to have checks
    for DRLM mode to prevent loading of extra config or such. If a user
    calls ReaR manually with strange options under DRLM mode then "shit
    in - shit out" is fine for me and preferred to adding DRLM checks
    everywhere.</li>
</ul>
<p>About <code>CONFIG_APPEND_FILES</code>:</p>
<ul>
<li>I really would like to have the <code>CONFIG_APPEND_FILES</code> variable as an
    array to reflect the fact that it contains multiple values.</li>
<li>IMHO <code>CONFIG_APPEND_FILES</code> would be better named
    <code>ADDITIONAL_CONFIG_FILES</code> or such as there is no appending
    happening. IMHO renaming this should be painless as the variable is
    used only internally.</li>
<li>I find the automagic of CONFIG_APPEND_FILES to be dangerous,
    especially the part where we try adding the <code>.conf</code> suffix. IMHO
    such an option should take either absolute or relative file names
    without further guesswork.</li>
<li>I would suggest to add <code>CONFIG_APPEND_FILES</code> (however named) to
    <code>default.conf</code> and allow users to set this in their own
    configuration. This goes well together with having it as an array,
    moving it to the <code>init</code> stage and will make the entire feature much
    more consistent with ReaR's general behavior.</li>
<li>The help text says that the <code>-C</code> parameter supports a single file
    while the code supports multiple files (I didn't check the manpage
    or other docs). If the behavior is changed to use multiple <code>-C foo</code>
    arguments for multiple configs then this would be also more
    consistent with Unix command line semantics.</li>
</ul>
<p>One more thing: I don't understand why the additional config files are
<em>not loaded automatically</em> in the rescue system. This feels really off
but maybe I don't understand the way how this is supposed to be used. Do
we expect the user to remember which <code>-C magic</code> he needs to use with
<code>rear recover</code>? From the design perspective everything should work with
just a plain <code>rear recover</code> which is why we always generate a
specifically tailored rescue image and don't use a generic one.</p>
<h4 id="jsmeix_commented_at_2017-03-15_1217"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-286724833">2017-03-15 12:17</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-03-15_1217" title="Permanent link">&para;</a></h4>
<p>@schlomo<br />
regarding how '-C' is currently meant to be used see<br />
<a href="https://github.com/rear/rear/blob/master/doc/user-guide/11-multiple-backups.adoc">https://github.com/rear/rear/blob/master/doc/user-guide/11-multiple-backups.adoc</a><br />
and<br />
<a href="https://github.com/rear/rear/blob/master/doc/user-guide/12-BLOCKCLONE.adoc">https://github.com/rear/rear/blob/master/doc/user-guide/12-BLOCKCLONE.adoc</a></p>
<p>Regarding an automatism for that use case see<br />
<a href="https://github.com/rear/rear/issues/1131">https://github.com/rear/rear/issues/1131</a></p>
<p>ReaR cannot automatically source any additional config files<br />
because the intent behind is that such additional config files<br />
can be used as needed for different mutual exclusive rear runs<br />
for example as described in the above documentation files.</p>
<p>For the whole development story behind have a look at<br />
<a href="https://github.com/rear/rear/issues/1088">https://github.com/rear/rear/issues/1088</a></p>
<h4 id="didacog_commented_at_2017-03-15_1239"><img src="https://avatars.githubusercontent.com/u/5380209?u=163f1571e6b9c9c7df94e2c6ca152b0a7406b52d&v=4" width="50"><a href="https://github.com/didacog">didacog</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-286729237">2017-03-15 12:39</a>:<a class="headerlink" href="#didacog_commented_at_2017-03-15_1239" title="Permanent link">&para;</a></h4>
<p>@jsmeix @schlomo @gdha,</p>
<p>Then I will better move that part of code from the main script to
usr/share/rear/init/default/005_set_config_append_files.sh?</p>
<p>I can also set CONFIG_APPEND_FILES (however named) default for the
rescue and initialize in default.conf if you want, as I'm working on
this.</p>
<p>Regards,</p>
<h4 id="jsmeix_commented_at_2017-03-15_1246"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-286730687">2017-03-15 12:46</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-03-15_1246" title="Permanent link">&para;</a></h4>
<p>Then please do it completely right and move all code<br />
that sources config files out of usr/sbin/rear into<br />
one or more separated 'init' script(s).<br />
Half of the code with same functionality here and<br />
the rest elsewhere makes it nedlessly hard to see<br />
and understand the whole picture which causes<br />
in the future bad adaptions and enhancements<br />
by contributors who fail to see the whole picture.</p>
<h4 id="schlomo_commented_at_2017-03-15_1304"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-286734942">2017-03-15 13:04</a>:<a class="headerlink" href="#schlomo_commented_at_2017-03-15_1304" title="Permanent link">&para;</a></h4>
<p>@jsmeix I see, thanks for documenting the use case so clearly. I guess
that there is a lot of personal taste involved. Personally I would build
this with more default behavior and user guidance, e.g. by adding a
<code>select</code> block into site.conf that toggles different option sets on
recovery or sets them via an extra argument like
<code>rear mkbackuponly windows</code>. In total the behavior would be similar, in
detail regular rear usage would retain basic or the most common
functionality. In any case, those use cases are probably only for the
very advanced users and probably won't be used in heavily automated
environments.</p>
<p>From a project perspective, I am fine with all that and just ask to keep
the code base as clean and consistent as possible (e.g. improve the
variable name, use arrays where appropriate and split code into smaller
files by topic).</p>
<p>üëç for moving more stuff from the main script to the <code>init</code> stage. The
shorter we get the main script the better for everybody.</p>
<h4 id="didacog_commented_at_2017-03-15_1338"><img src="https://avatars.githubusercontent.com/u/5380209?u=163f1571e6b9c9c7df94e2c6ca152b0a7406b52d&v=4" width="50"><a href="https://github.com/didacog">didacog</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-286743368">2017-03-15 13:38</a>:<a class="headerlink" href="#didacog_commented_at_2017-03-15_1338" title="Permanent link">&para;</a></h4>
<p>OK, I will just move back that part of code to init stage, without
changing VARIABLE name or changing anything to be default at rescue yet.</p>
<p>Regards,</p>
<h4 id="jsmeix_commented_at_2017-03-15_1339"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-286743835">2017-03-15 13:39</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-03-15_1339" title="Permanent link">&para;</a></h4>
<p>@schlomo<br />
of course I implemented "multiple backups" basically<br />
"according to what I found out what worked easiest for me"<br />
and what was most important for me is that I liked to have it<br />
implemented without too big changes in the ReaR framework, cf.<br />
<a href="https://github.com/rear/rear/issues/1088#issuecomment-262981954">https://github.com/rear/rear/issues/1088#issuecomment-262981954</a></p>
<p>Regarding future adaptions and enhancements see<br />
<a href="https://github.com/rear/rear/issues/1088#issuecomment-264831535">https://github.com/rear/rear/issues/1088#issuecomment-264831535</a></p>
<h4 id="jsmeix_commented_at_2017-03-15_1347"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-286745827">2017-03-15 13:47</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-03-15_1347" title="Permanent link">&para;</a></h4>
<p>@didacog<br />
when moving sourcing config files into the 'init' stage<br />
be careful how currently it is about</p>
<pre>
# Now SHARE_DIR CONFIG_DIR VAR_DIR LOG_DIR and KERNEL_VERSION should be set to a fixed value:
readonly SHARE_DIR CONFIG_DIR VAR_DIR LOG_DIR KERNEL_VERSION
</pre>

<p>Simply put:<br />
When moving any code out of usr/sbin/rear to any later<br />
sourced script, just ensure that nothing could break.</p>
<h4 id="didacog_commented_at_2017-03-15_1357"><img src="https://avatars.githubusercontent.com/u/5380209?u=163f1571e6b9c9c7df94e2c6ca152b0a7406b52d&v=4" width="50"><a href="https://github.com/didacog">didacog</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-286748851">2017-03-15 13:57</a>:<a class="headerlink" href="#didacog_commented_at_2017-03-15_1357" title="Permanent link">&para;</a></h4>
<p>@jsmeix</p>
<p>This should be moved also? I only moved the whole IF statement that was
before that line because I did not appreciate any change on those
VARIABLES.</p>
<h4 id="jsmeix_commented_at_2017-03-15_1410"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-286752858">2017-03-15 14:10</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-03-15_1410" title="Permanent link">&para;</a></h4>
<p>@didacog<br />
I don't know what exactly you need to do when moving code.<br />
I only liked to point out that when one moves code<br />
one must be extra careful because when code is moved<br />
the execution ordering changes which could result any<br />
unexpected behavioural changes (a.k.a. "regressions").</p>
<h4 id="jsmeix_commented_at_2017-03-15_1415"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-286754316">2017-03-15 14:15</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-03-15_1415" title="Permanent link">&para;</a></h4>
<p>From my point of view your<br />
<a href="https://github.com/didacog/rear/commit/95b1fa72f592da596cbce5c6d380598a25eed583">https://github.com/didacog/rear/commit/95b1fa72f592da596cbce5c6d380598a25eed583</a><br />
is in the same way wrong as it was wrong before.<br />
At least I will not merge changes that cut code<br />
for one same functionality into pieces and spread it<br />
over different files that are executed at different time.</p>
<h4 id="didacog_commented_at_2017-03-15_1419"><img src="https://avatars.githubusercontent.com/u/5380209?u=163f1571e6b9c9c7df94e2c6ca152b0a7406b52d&v=4" width="50"><a href="https://github.com/didacog">didacog</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-286755669">2017-03-15 14:19</a>:<a class="headerlink" href="#didacog_commented_at_2017-03-15_1419" title="Permanent link">&para;</a></h4>
<p>@jsmeix I'm a bit confused, please can you give me some light on this
please. What is wrong? then I could adjust better if needed.</p>
<p>Thanks!</p>
<h4 id="didacog_commented_at_2017-03-15_1432"><img src="https://avatars.githubusercontent.com/u/5380209?u=163f1571e6b9c9c7df94e2c6ca152b0a7406b52d&v=4" width="50"><a href="https://github.com/didacog">didacog</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-286759758">2017-03-15 14:32</a>:<a class="headerlink" href="#didacog_commented_at_2017-03-15_1432" title="Permanent link">&para;</a></h4>
<p>Do you want that merge 005_set_config_append_files.sh and
010_set_drlm_env.sh to same script?</p>
<p>Regards,</p>
<h4 id="didacog_commented_at_2017-03-15_1500"><img src="https://avatars.githubusercontent.com/u/5380209?u=163f1571e6b9c9c7df94e2c6ca152b0a7406b52d&v=4" width="50"><a href="https://github.com/didacog">didacog</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-286768960">2017-03-15 15:00</a>:<a class="headerlink" href="#didacog_commented_at_2017-03-15_1500" title="Permanent link">&para;</a></h4>
<p>@jsmeix This way is better? same functionality in same file. Isn't it?</p>
<p><strong>usr/share/rear/init/default/005_source_additional_config_files.sh</strong></p>
<pre>

if drlm_is_managed ; then

    PROGS=( "${PROGS[@]}" curl )

    # Needed for curl (HTTPs)
    COPY_AS_IS=( ${COPY_AS_IS[@]} /etc/ssl/certs/* /etc/pki/* )

    LIBS=(
        "${LIBS[@]}"
        /lib*/libnsspem.so*
        /usr/lib*/libnsspem.so*
        /lib*/libfreebl*.so*
        /usr/lib*/libfreebl*.so*
        /lib*/libnss3.so*
        /usr/lib*/libnss3.so*
        /lib*/libnssutil3.so*
        /usr/lib*/libnssutil3.so*
        /lib*/libsoftokn3.so*
        /usr/lib*/libsoftokn3.so*
        /lib*/libsqlite3.so*
        /usr/lib*/libsqlite3.so*
        /lib*/libfreeblpriv3.so*
        /usr/lib*/libfreeblpriv3.so*
        /lib*/libssl.so*
        /usr/lib*/libssl.so*
        /lib*/libnssdbm3.so*
        /usr/lib*/libnssdbm3.so*
    )

    drlm_import_runtime_config
    drlm_send_log

else

    # source additional configuration files if specified on the command line:
    if test "$CONFIG_APPEND_FILES" ; then
        for config_append_file in $CONFIG_APPEND_FILES ; do
            # If what is specified on the command line starts with '/' an absolute path is meant
            # otherwise what is specified on the command line means a file in CONFIG_DIR.
            # Files in CONFIG_DIR get automatically copied into the recovery system but
            # other files are added to COPY_AS_IS to get them copied into the recovery system:
            case "$config_append_file" in
                (/*)
                    config_append_file_path="$config_append_file"
                    # If "-C foo" was specified on the command line but 'foo' does not exist
                    # try if 'foo.conf' exists and if yes, use that:
                    if test -r "$config_append_file_path" ; then
                        COPY_AS_IS=( "${COPY_AS_IS[@]}" "$config_append_file_path" )
                    else if test -r "$config_append_file_path.conf" ; then
                             COPY_AS_IS=( "${COPY_AS_IS[@]}" "$config_append_file_path.conf" )
                         else
                             Error "There is '-C $config_append_file' but neither '$config_append_file_path' nor '$config_append_file_path.conf' can be read."
                         fi
                    fi
                    ;;
                (*)
                    config_append_file_path="$CONFIG_DIR/$config_append_file"
                    ;;
            esac
            # If "-C foo" was specified on the command line but 'foo' does not exist
            # try if 'foo.conf' exists and if yes, use that:
            if test -r "$config_append_file_path" ; then
                LogPrint "Sourcing additional configuration file '$config_append_file_path'"
                Source "$config_append_file_path"
            else if test -r "$config_append_file_path.conf" ; then
                     LogPrint "Sourcing additional configuration file '$config_append_file_path.conf'"
                     Source "$config_append_file_path.conf"
                 else
                     Error "There is '-C $config_append_file' but neither '$config_append_file_path' nor '$config_append_file_path.conf' can be read."
                 fi
            fi
        done
    fi

fi

# Now SHARE_DIR CONFIG_DIR VAR_DIR LOG_DIR and KERNEL_VERSION should be set to a fixed value:
readonly SHARE_DIR CONFIG_DIR VAR_DIR LOG_DIR KERNEL_VERSION
</pre>

<p>Maybe this will be better moved to other script after loading config
files?</p>
<p><strong>usr/share/rear/init/default/010_send_log_to_drlm.sh</strong></p>
<pre>
if drlm_is_managed ; then
    drlm_send_log
fi
</pre>

<h4 id="schlomo_commented_at_2017-03-15_1510"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-286772308">2017-03-15 15:10</a>:<a class="headerlink" href="#schlomo_commented_at_2017-03-15_1510" title="Permanent link">&para;</a></h4>
<p>@didacog I don't understand why DRLM should disable the additional
config files feature (what if a user wants to use DRLM mode through
that? Or if a user wants to be able to use ReaR without DRLM through
this feature?). For me these are totally unrelated issues. In any case,
there are probably tons of other things in ReaR that users could use to
shoot themselves in the foot while using DRLM and you don't try to
disable all of them.</p>
<p>Can you explain why it is so important for you to disable this feature
under DRLM? My suggestion is to keep these two topics unrelated.</p>
<p>BTW, I would also not mind if ReaR would take along curl and its SSL
libraries if curl is present. I think that curl is such a useful tool
that we should consider that (although wget is not included by default).</p>
<p>The <code>readonly</code> part I would leave in the main script and use it to <em>lock
down</em> the important ReaR variables after the init stage. Or put it in
some <code>999_lock_important_variables.sh</code> if it must be in the init stage.</p>
<p>@didacog sorry for being so "difficult" here, I think that all of us
ReaR maintainers simply try to use this as a specific example to help us
all in finding a common understanding of how ReaR should be written.
Thanks a lot for your great patience! Everything you do makes ReaR
better!</p>
<h4 id="didacog_commented_at_2017-03-15_1512"><img src="https://avatars.githubusercontent.com/u/5380209?u=163f1571e6b9c9c7df94e2c6ca152b0a7406b52d&v=4" width="50"><a href="https://github.com/didacog">didacog</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-286772889">2017-03-15 15:12</a>:<a class="headerlink" href="#didacog_commented_at_2017-03-15_1512" title="Permanent link">&para;</a></h4>
<p>@schlomo DRLM does not disable this feature, if managed by drlm this
config files will be loaded from drlm instead from local fs.</p>
<h4 id="didacog_commented_at_2017-03-15_1514"><img src="https://avatars.githubusercontent.com/u/5380209?u=163f1571e6b9c9c7df94e2c6ca152b0a7406b52d&v=4" width="50"><a href="https://github.com/didacog">didacog</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-286773440">2017-03-15 15:14</a>:<a class="headerlink" href="#didacog_commented_at_2017-03-15_1514" title="Permanent link">&para;</a></h4>
<p>This changes are to support this on DRLM side, not to disable anithing.</p>
<p>see this:
<a href="https://github.com/didacog/rear/commit/e68d068bcbe05a54a1b9c1696d694354b1569b14#diff-1254e172b4ccbf4754e92b502337cb38">https://github.com/didacog/rear/commit/e68d068bcbe05a54a1b9c1696d694354b1569b14#diff-1254e172b4ccbf4754e92b502337cb38</a></p>
<h4 id="didacog_commented_at_2017-03-15_1518"><img src="https://avatars.githubusercontent.com/u/5380209?u=163f1571e6b9c9c7df94e2c6ca152b0a7406b52d&v=4" width="50"><a href="https://github.com/didacog">didacog</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-286774808">2017-03-15 15:18</a>:<a class="headerlink" href="#didacog_commented_at_2017-03-15_1518" title="Permanent link">&para;</a></h4>
<p>Regarding curl, nothing was changed since DRLM integration with rear
(since 1.17) I've just added more libs to the LIBS array to be able to
handle SSL certs from rescue image. see:
<a href="https://github.com/brainupdaters/drlm/issues/42">https://github.com/brainupdaters/drlm/issues/42</a></p>
<h4 id="schlomo_commented_at_2017-03-15_1536"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-286781056">2017-03-15 15:36</a>:<a class="headerlink" href="#schlomo_commented_at_2017-03-15_1536" title="Permanent link">&para;</a></h4>
<p>@didacog I don't follow. Your proposed code disables loading extra
configs in ReaR if DRLM mode is enabled. I would like to see this
decoupled. If DRLM also loads extra configs (I presume others than the
user has locally) then IMHO this is unrelated.</p>
<p>Or does DRLM actually check how ReaR was called, parse the <code>-C name</code>
option itself and then load these configs? That sounds like code
duplication to me, why not leave this with ReaR.</p>
<h4 id="didacog_commented_at_2017-03-15_1550"><img src="https://avatars.githubusercontent.com/u/5380209?u=163f1571e6b9c9c7df94e2c6ca152b0a7406b52d&v=4" width="50"><a href="https://github.com/didacog">didacog</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-286785456">2017-03-15 15:50</a>:<a class="headerlink" href="#didacog_commented_at_2017-03-15_1550" title="Permanent link">&para;</a></h4>
<p>@schlomo one of the DRLM features is to provide ReaR configurations from
a central management location (DRLM).<br />
In case of <pre>rear -C name</pre> is set, and if ReaR is managed by
DRLM, those extra local config files does not be present in the local fs
(/etc/rear/name) will be in DRLM. This is why we check if is managed
before loading them, because in that case, drlm_import_runtime_config
will load them from DRLM server. That's all.<br />
If not checked ReaR will fail because those files are not present, and
this is ok, because they are in DRLM.</p>
<h4 id="jsmeix_commented_at_2017-03-15_1602"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-286789925">2017-03-15 16:02</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-03-15_1602" title="Permanent link">&para;</a></h4>
<p>@didacog<br />
many thanks for your explanation in your above<br />
<a href="https://github.com/rear/rear/issues/1229#issuecomment-286785456">https://github.com/rear/rear/issues/1229#issuecomment-286785456</a></p>
<p>Now I think it is the first time that I understand the reason behind!<br />
But I will have to think a bit more about it...</p>
<p>For now a very first question:<br />
Why are only additional config files via '-C' affected?<br />
In other words:<br />
Why does DRLM need no DRLM-specific changes<br />
in usr/sbin/rear for all the traditional ReaR config files<br />
like /etc/rear/local.conf , .../site.conf, .../os.conf<br />
and/or when the '-c' option is used?</p>
<h4 id="didacog_commented_at_2017-03-15_1609"><img src="https://avatars.githubusercontent.com/u/5380209?u=163f1571e6b9c9c7df94e2c6ca152b0a7406b52d&v=4" width="50"><a href="https://github.com/didacog">didacog</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-286792043">2017-03-15 16:09</a>:<a class="headerlink" href="#didacog_commented_at_2017-03-15_1609" title="Permanent link">&para;</a></h4>
<p>@jsmeix</p>
<p>in local.conf/site.conf is where you must set DRLM_MANAGED=y.</p>
<p>With just setting that Rear will be able to load the configuration files
from DRLM. All rear configurations from DRLM must be loaded after
setting just DRLM_MANAGED=y or DRLM_* in local.conf because is the
main file to change default.conf settings.</p>
<p>Then all configurations can be managed from DRLM server. This code
change is to be able to support 'rear -C config' on DRLM also.</p>
<h4 id="schlomo_commented_at_2017-03-15_1614"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-286793697">2017-03-15 16:14</a>:<a class="headerlink" href="#schlomo_commented_at_2017-03-15_1614" title="Permanent link">&para;</a></h4>
<p>@didacog let me try in my own words: Do you want to prevent the user
from side-loading other local configs under DRLM control?</p>
<p>To help us understand, what would be the problem if your above code
would be changed to this:</p>
<pre><code>if drlm_is_managed ; then

    PROGS=( "${PROGS[@]}" curl )

    # Needed for curl (HTTPs)
    COPY_AS_IS=( ${COPY_AS_IS[@]} /etc/ssl/certs/* /etc/pki/* )

    LIBS=(
        "${LIBS[@]}"
        /lib*/libnsspem.so*
        /usr/lib*/libnsspem.so*
        /lib*/libfreebl*.so*
        /usr/lib*/libfreebl*.so*
        /lib*/libnss3.so*
        /usr/lib*/libnss3.so*
        /lib*/libnssutil3.so*
        /usr/lib*/libnssutil3.so*
        /lib*/libsoftokn3.so*
        /usr/lib*/libsoftokn3.so*
        /lib*/libsqlite3.so*
        /usr/lib*/libsqlite3.so*
        /lib*/libfreeblpriv3.so*
        /usr/lib*/libfreeblpriv3.so*
        /lib*/libssl.so*
        /usr/lib*/libssl.so*
        /lib*/libnssdbm3.so*
        /usr/lib*/libnssdbm3.so*
    )

    drlm_import_runtime_config
    drlm_send_log

fi
    # source additional configuration files if specified on the command line:
    if test "$CONFIG_APPEND_FILES" ; then
        for config_append_file in $CONFIG_APPEND_FILES ; do
            # If what is specified on the command line starts with '/' an absolute path is meant
            # otherwise what is specified on the command line means a file in CONFIG_DIR.
            # Files in CONFIG_DIR get automatically copied into the recovery system but
            # other files are added to COPY_AS_IS to get them copied into the recovery system:
            case "$config_append_file" in
                (/*)
                    config_append_file_path="$config_append_file"
                    # If "-C foo" was specified on the command line but 'foo' does not exist
                    # try if 'foo.conf' exists and if yes, use that:
                    if test -r "$config_append_file_path" ; then
                        COPY_AS_IS=( "${COPY_AS_IS[@]}" "$config_append_file_path" )
                    else if test -r "$config_append_file_path.conf" ; then
                             COPY_AS_IS=( "${COPY_AS_IS[@]}" "$config_append_file_path.conf" )
                         else
                             Error "There is '-C $config_append_file' but neither '$config_append_file_path' nor '$config_append_file_path.conf' can be read."
                         fi
                    fi
                    ;;
                (*)
                    config_append_file_path="$CONFIG_DIR/$config_append_file"
                    ;;
            esac
            # If "-C foo" was specified on the command line but 'foo' does not exist
            # try if 'foo.conf' exists and if yes, use that:
            if test -r "$config_append_file_path" ; then
                LogPrint "Sourcing additional configuration file '$config_append_file_path'"
                Source "$config_append_file_path"
            else if test -r "$config_append_file_path.conf" ; then
                     LogPrint "Sourcing additional configuration file '$config_append_file_path.conf'"
                     Source "$config_append_file_path.conf"
                 else
                     Error "There is '-C $config_append_file' but neither '$config_append_file_path' nor '$config_append_file_path.conf' can be read."
                 fi
            fi
        done
    fi
</code></pre>
<p>What would brake in DRLM under this change?</p>
<h4 id="didacog_commented_at_2017-03-15_1616"><img src="https://avatars.githubusercontent.com/u/5380209?u=163f1571e6b9c9c7df94e2c6ca152b0a7406b52d&v=4" width="50"><a href="https://github.com/didacog">didacog</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-286794563">2017-03-15 16:16</a>:<a class="headerlink" href="#didacog_commented_at_2017-03-15_1616" title="Permanent link">&para;</a></h4>
<p>@schlomo<br />
The problem with your suggestion is that these config files will never
be present in local fs if DRLM_MANAGED=y and test -r
"$config_append_file_path.conf" will fail.</p>
<h4 id="schlomo_commented_at_2017-03-15_1626"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-286797724">2017-03-15 16:26</a>:<a class="headerlink" href="#schlomo_commented_at_2017-03-15_1626" title="Permanent link">&para;</a></h4>
<p>@didacog That is fine for me. I just want to decouple things which are
not related. Is that fine for you, too? Then let's split it up.</p>
<h4 id="didacog_commented_at_2017-03-15_1631"><img src="https://avatars.githubusercontent.com/u/5380209?u=163f1571e6b9c9c7df94e2c6ca152b0a7406b52d&v=4" width="50"><a href="https://github.com/didacog">didacog</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-286799242">2017-03-15 16:31</a>:<a class="headerlink" href="#didacog_commented_at_2017-03-15_1631" title="Permanent link">&para;</a></h4>
<p>@schlomo I do not understood your last comment I guess.</p>
<p>If you are asking if is fine for me that
<code>test -r "$config_append_file_path.conf"</code> will fail, no is not fine for
me, because then always will fail and rear stop working with error after
loading configuration from DRLM fine :-P</p>
<h4 id="schlomo_commented_at_2017-03-15_1636"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-286800872">2017-03-15 16:36</a>:<a class="headerlink" href="#schlomo_commented_at_2017-03-15_1636" title="Permanent link">&para;</a></h4>
<p>Will this always happen or only if somebody does rear -C name ?</p>
<p>Will it break regular DLRM usage?</p>
<p>Am 15.03.2017 5:31 nachm. schrieb "Didac Oliveira"
&lt;<a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#110;&#111;&#116;&#105;&#102;&#105;&#99;&#97;&#116;&#105;&#111;&#110;&#115;&#64;&#103;&#105;&#116;&#104;&#117;&#98;&#46;&#99;&#111;&#109;">&#110;&#111;&#116;&#105;&#102;&#105;&#99;&#97;&#116;&#105;&#111;&#110;&#115;&#64;&#103;&#105;&#116;&#104;&#117;&#98;&#46;&#99;&#111;&#109;</a></p>
<blockquote>
<p>:</p>
<p>@schlomo <a href="https://github.com/schlomo">https://github.com/schlomo</a> I do
not understood your last<br />
comment I guess.</p>
<p>If you are asking if is fine for me that test -r<br />
"$config_append_file_path.conf" will fail, no is not fine for me,
because<br />
then always will fail and rear stop working with error. :-P</p>
<p>‚Äî<br />
You are receiving this because you were mentioned.<br />
Reply to this email directly, view it on GitHub<br />
<a href="https://github.com/rear/rear/issues/1229#issuecomment-286799242">https://github.com/rear/rear/issues/1229#issuecomment-286799242</a>,
or mute<br />
the thread<br />
<a href="https://github.com/notifications/unsubscribe-auth/AAGMCICtn2wJvaWwl1Km9hvFWI-VToTaks5rmBJZgaJpZM4MX3EM">https://github.com/notifications/unsubscribe-auth/AAGMCICtn2wJvaWwl1Km9hvFWI-VToTaks5rmBJZgaJpZM4MX3EM</a><br />
.</p>
</blockquote>
<h4 id="didacog_commented_at_2017-03-15_1638"><img src="https://avatars.githubusercontent.com/u/5380209?u=163f1571e6b9c9c7df94e2c6ca152b0a7406b52d&v=4" width="50"><a href="https://github.com/didacog">didacog</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-286801550">2017-03-15 16:38</a>:<a class="headerlink" href="#didacog_commented_at_2017-03-15_1638" title="Permanent link">&para;</a></h4>
<p>@schlomo</p>
<p>This will happen if somebody does <code>rear -C name</code> and DRLM_MANAGED=y.
And yes will break DRLM usage, because rear will not continue working as
expected by DRLM.</p>
<h4 id="didacog_commented_at_2017-03-15_1648"><img src="https://avatars.githubusercontent.com/u/5380209?u=163f1571e6b9c9c7df94e2c6ca152b0a7406b52d&v=4" width="50"><a href="https://github.com/didacog">didacog</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-286804977">2017-03-15 16:48</a>:<a class="headerlink" href="#didacog_commented_at_2017-03-15_1648" title="Permanent link">&para;</a></h4>
<p>@schlomo</p>
<p>If you do not want else statement, maybe this should be ok?</p>
<pre>
if drlm_is_managed ; then

    PROGS=( "${PROGS[@]}" curl )

    # Needed for curl (HTTPs)
    COPY_AS_IS=( ${COPY_AS_IS[@]} /etc/ssl/certs/* /etc/pki/* )

    LIBS=(
        "${LIBS[@]}"
        /lib*/libnsspem.so*
        /usr/lib*/libnsspem.so*
        /lib*/libfreebl*.so*
        /usr/lib*/libfreebl*.so*
        /lib*/libnss3.so*
        /usr/lib*/libnss3.so*
        /lib*/libnssutil3.so*
        /usr/lib*/libnssutil3.so*
        /lib*/libsoftokn3.so*
        /usr/lib*/libsoftokn3.so*
        /lib*/libsqlite3.so*
        /usr/lib*/libsqlite3.so*
        /lib*/libfreeblpriv3.so*
        /usr/lib*/libfreeblpriv3.so*
        /lib*/libssl.so*
        /usr/lib*/libssl.so*
        /lib*/libnssdbm3.so*
        /usr/lib*/libnssdbm3.so*
    )

    drlm_import_runtime_config
    drlm_send_log
   return 0
fi
    # source additional configuration files if specified on the command line:
    if test "$CONFIG_APPEND_FILES" ; then
        for config_append_file in $CONFIG_APPEND_FILES ; do
            # If what is specified on the command line starts with '/' an absolute path is meant
            # otherwise what is specified on the command line means a file in CONFIG_DIR.
            # Files in CONFIG_DIR get automatically copied into the recovery system but
            # other files are added to COPY_AS_IS to get them copied into the recovery system:
            case "$config_append_file" in
                (/*)
                    config_append_file_path="$config_append_file"
                    # If "-C foo" was specified on the command line but 'foo' does not exist
                    # try if 'foo.conf' exists and if yes, use that:
                    if test -r "$config_append_file_path" ; then
                        COPY_AS_IS=( "${COPY_AS_IS[@]}" "$config_append_file_path" )
                    else if test -r "$config_append_file_path.conf" ; then
                             COPY_AS_IS=( "${COPY_AS_IS[@]}" "$config_append_file_path.conf" )
                         else
                             Error "There is '-C $config_append_file' but neither '$config_append_file_path' nor '$config_append_file_path.conf' can be read."
                         fi
                    fi
                    ;;
                (*)
                    config_append_file_path="$CONFIG_DIR/$config_append_file"
                    ;;
            esac
            # If "-C foo" was specified on the command line but 'foo' does not exist
            # try if 'foo.conf' exists and if yes, use that:
            if test -r "$config_append_file_path" ; then
                LogPrint "Sourcing additional configuration file '$config_append_file_path'"
                Source "$config_append_file_path"
            else if test -r "$config_append_file_path.conf" ; then
                     LogPrint "Sourcing additional configuration file '$config_append_file_path.conf'"
                     Source "$config_append_file_path.conf"
                 else
                     Error "There is '-C $config_append_file' but neither '$config_append_file_path' nor '$config_append_file_path.conf' can be read."
                 fi
            fi
        done
    fi
</pre>

<h4 id="didacog_commented_at_2017-03-15_1650"><img src="https://avatars.githubusercontent.com/u/5380209?u=163f1571e6b9c9c7df94e2c6ca152b0a7406b52d&v=4" width="50"><a href="https://github.com/didacog">didacog</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-286805467">2017-03-15 16:50</a>:<a class="headerlink" href="#didacog_commented_at_2017-03-15_1650" title="Permanent link">&para;</a></h4>
<p>Anyway maybe <code>drlm_send_log</code> should be moved to other script? to keep
different things separated</p>
<h4 id="schlomo_commented_at_2017-03-15_1952"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-286859074">2017-03-15 19:52</a>:<a class="headerlink" href="#schlomo_commented_at_2017-03-15_1952" title="Permanent link">&para;</a></h4>
<p>@didacog this looks much better. I would put all drlm related stuff in a
single script in the init stage. And use another script for the config
include.</p>
<h4 id="didacog_commented_at_2017-03-15_2100"><img src="https://avatars.githubusercontent.com/u/5380209?u=163f1571e6b9c9c7df94e2c6ca152b0a7406b52d&v=4" width="50"><a href="https://github.com/didacog">didacog</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-286877456">2017-03-15 21:00</a>:<a class="headerlink" href="#didacog_commented_at_2017-03-15_2100" title="Permanent link">&para;</a></h4>
<p>@schlomo</p>
<p>This is how I started, see my initial:
<a href="https://github.com/rear/rear/issues/1229#issue-212985552">https://github.com/rear/rear/issues/1229#issue-212985552</a><br />
NEW <code>usr/share/rear/init/default/005_set_config_append_files.sh</code><br />
and<br />
SAME <code>usr/share/rear/init/default/010_set_drlm_env.sh</code> with the
<code>drlm_send_log</code> and more LIBS for curl with SSL.</p>
<p>But, as per:
<a href="https://github.com/rear/rear/issues/1229#issuecomment-286754316">https://github.com/rear/rear/issues/1229#issuecomment-286754316</a>
seems better to put in the same script?</p>
<h4 id="jsmeix_commented_at_2017-03-16_0912"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-286998459">2017-03-16 09:12</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-03-16_0912" title="Permanent link">&para;</a></h4>
<p>Regarding "use another script for the config include":</p>
<p>For me it is mandatory (i.e. I will not accept a violation of it)<br />
that one same functionality must be kept together, cf.<br />
<a href="https://github.com/rear/rear/issues/1229#issuecomment-286730687">https://github.com/rear/rear/issues/1229#issuecomment-286730687</a></p>
<p>Sourcing the config files was all the time and still is<br />
one same functionality in ReaR.</p>
<p>Therefore sourcing all config files must be kept<br />
in one same script at one same place.</p>
<p>I do not at all care if that one same script which implements<br />
the "sourcing all config files" functionality is usr/sbin/rear<br />
or a separated script in the 'init' stage. If it is a separated script<br />
that script should only implement this one functionality, cf.<br />
<a href="https://en.wikipedia.org/wiki/Unix_philosophy">https://en.wikipedia.org/wiki/Unix_philosophy</a><br />
therein in particular "do one thing and do it well".</p>
<p>To make it unmistakably clear what my point is:</p>
<p>I will not accept when the implementation of one single<br />
functionality gets cut into pieces and spread over various places.</p>
<p>I will not do any kind of help or maintenance for scattered code.</p>
<p>On the other hand this means - because ReaR is free software<br />
and I do fully support the ideas behind free software - that<br />
anyone who likes scattered code is free to do what he likes<br />
but then I am also free to not care about such code.</p>
<h4 id="jsmeix_commented_at_2017-03-16_0938"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-287004509">2017-03-16 09:38</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-03-16_0938" title="Permanent link">&para;</a></h4>
<p>@didacog<br />
to better understand your issue:</p>
<p>If in usr/sbin/rear the current</p>
<pre>
Error "There is '-C $config_append_file' but neither '$config_append_file_path' nor '$config_append_file_path.conf' can be read."
</pre>

<p>would be</p>
<pre>
LogPrint "There is '-C $config_append_file' but neither '$config_append_file_path' nor '$config_append_file_path.conf' can be read."
</pre>

<p>then - I guess - you would not see an issue<br />
in case of DRLM_MANAGED=y</p>
<p>Reason (as far as I understand it):</p>
<p>I assume that with DRLM_MANAGED=y one can have<br />
arbitrary settings in the local config files but that does<br />
not matter because usr/sbin/rear does not fail when<br />
sourcing the traditional local config files.</p>
<p>Later in some DRLM-specific scripts additional config files<br />
get downloaded from the DRLM server onto the local system<br />
where rear runs and then that downloaded additional config<br />
files get sourced by DRLM-specific scripts.<br />
As far as I understand it this is what the
drlm_import_runtime_config<br />
function in lib/drlm-functions.sh does.</p>
<p>This way whatever settings in the initial local config files<br />
could be overwriten when the downloaded additional config<br />
files get later sourced by DRLM-specific scripts.</p>
<p>If my understanding is right, it means:</p>
<p>All what DRLM_MANAGED=y actually means is basically<br />
the same as what '-C' implements:</p>
<p>Additional config files get sourced.</p>
<p>The only difference is that with DRLM_MANAGED=y<br />
the additional config files come from a remote server<br />
while '-C' only works for local files.</p>
<p>If my understanding is still right, it means:</p>
<p>The curent implementations for DRLM_MANAGED=y<br />
and '-C' are two separated implementations for two<br />
times almost the same functionality.</p>
<p>This is bad and I will fix it as soon as I can.</p>
<p>What I propose hereby is:</p>
<p>I will enhance ReaR to support downloading files<br />
from remote via a "DownloadFile" function plus<br />
appropriate config variables to specify the remote stuff<br />
(like the remote server and the download protocol<br />
i.e. the first part of the download URL).</p>
<p>I will enhance ReaR to source config files that need<br />
to be downloaded from a remote server.</p>
<p>This way ReaR will generically support<br />
to be managed from remote by using<br />
config files that exist on a remote server.</p>
<p>When this is done, DRLM_MANAGED=y will be only<br />
one particular use case of that new generic<br />
"Remotely Managed" feature in ReaR.</p>
<p>If my understanding is right and if we agree on a new<br />
"Remotely Managed" feature in ReaR<br />
I will implement it in a way so that it is useful on its own<br />
(which I can test on my systems) and also so that it is<br />
in particular useful for DRLM_MANAGED=y<br />
(which @didacog needs to test on his systems).</p>
<p>This way we can get rid of the current ugly special-case hacks<br />
for DRLM_MANAGED=y in the ReaR code and replace them<br />
with cleanly integrated calls of generic ReaR functionality.</p>
<p>Of course I will happily adapt and enhance and maintain<br />
such generic ReaR functionality in the future.</p>
<h4 id="schlomo_commented_at_2017-03-16_0958"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-287009367">2017-03-16 09:58</a>:<a class="headerlink" href="#schlomo_commented_at_2017-03-16_0958" title="Permanent link">&para;</a></h4>
<p>@didacog re
<a href="https://github.com/rear/rear/issues/1229#issuecomment-286877456">https://github.com/rear/rear/issues/1229#issuecomment-286877456</a>
What bothered me in your initial suggestion was the first 3 lines where
you skip the entire script under DRLM.</p>
<p>To recap what I learned so far:</p>
<ul>
<li>
<p>From DRLM perspective allowing the user to do <code>-C name</code> could be bad
    but only if the user actually does it. If the user does not use the
    <code>-C name</code> feature then there is no problem. @didacog is this
    correct?</p>
</li>
<li>
<p>@jsmeix wants to keep all related function in one script and not
    split it. In general I agree, for specific cases we need to discuss.
    For example, I would prefer to split config loading into 1) load
    standard configs, 2) load local custom config and 3) load remote
    config as I perceive those to be sufficiently different topics. I
    would also write separate unit tests for those, looking at the
    potential unit tests is always a good indicator for modularizing
    code. @jsmeix how do you feel about that?</p>
</li>
<li>
<p>@jsmeix proposes to add a remote configuration feature. I suggested
    <a href="https://www.slideshare.net/schlomo/rear-server-proposal-10">something like that back in
    2009</a>
    and would strongly suggest to develop this topic from the server
    side because then it will be much easier to see which client
    features are required. Specifically I would be careful to create yet
    another software/config distribution mechanism but rather rely on
    whatever the admin already employs. I would also like to caution
    against implementing an RPC-style interface through config loading.
    As long as ReaR is a command line utility that should remain our
    primary interface. If a server component wants to interact with it
    then it needs an RPC component that will then run our ReaR as a
    command line tool - and potentially add parameters when calling
    ReaR. Those should however be passed locally and not pulled in from
    remote to prevent having more than one remote channel.</p>
</li>
</ul>
<p>To get this long discussion of the hook I would like to suggest to
accept this PR with the small modification of removing the DRLM check at
the beginning.</p>
<h4 id="didacog_commented_at_2017-03-16_1014"><img src="https://avatars.githubusercontent.com/u/5380209?u=163f1571e6b9c9c7df94e2c6ca152b0a7406b52d&v=4" width="50"><a href="https://github.com/didacog">didacog</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-287013191">2017-03-16 10:14</a>:<a class="headerlink" href="#didacog_commented_at_2017-03-16_1014" title="Permanent link">&para;</a></h4>
<p>@jsmeix @schlomo</p>
<p>if this can be changed in the way @jsmeix says:</p>
<p><code>Error "There is '-C $config_append_file' but neither '$config_append_file_path' nor '$config_append_file_path.conf' can be read."</code><br />
to<br />
<code>LogPrint "There is '-C $config_append_file' but neither '$config_append_file_path' nor '$config_append_file_path.conf' can be read."</code></p>
<p>Then, my initial proposal without the check of drlm_managed in<br />
<strong>usr/share/rear/init/default/005_set_config_append_files.sh</strong> will
work with no issues, because rear will not fail if files not found in
the local filesystem and all stuff in
<strong>usr/share/rear/init/default/010_set_drlm_env.sh</strong> should work as
expected.</p>
<p>This will give us the support of Multiple configs from DRLM RESTful API
without the check before trying to load configs <code>-C name</code>.</p>
<p>I all of you are agree, i will adjust those things and send the PR.</p>
<p>We are working hard to provide better ReaR-DRLM integration over the
DRLM REST API, more secure and flexible than it was since rear-1.17.</p>
<h4 id="schlomo_commented_at_2017-03-16_1020"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-287014593">2017-03-16 10:20</a>:<a class="headerlink" href="#schlomo_commented_at_2017-03-16_1020" title="Permanent link">&para;</a></h4>
<p>@didacog sorry, I would prefer to keep the failure if the user does a
<code>-C name</code> and <code>name</code> cannot be loaded. ReaR should fail if that what the
user said cannot be done.</p>
<p>I don't really understand why this troubles you so much. Why do you
think that your users would be using this feature whatsoever? When DRLM
calls ReaR you don't use it in any case.</p>
<p>I have the feeling that we are discussing what happens in an extremely
specific error situation.</p>
<h4 id="didacog_commented_at_2017-03-16_1030"><img src="https://avatars.githubusercontent.com/u/5380209?u=163f1571e6b9c9c7df94e2c6ca152b0a7406b52d&v=4" width="50"><a href="https://github.com/didacog">didacog</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-287016944">2017-03-16 10:30</a>:<a class="headerlink" href="#didacog_commented_at_2017-03-16_1030" title="Permanent link">&para;</a></h4>
<p>@schlomo adding this support of multiple configs in DRLM will give the
users to chose what config to use from DRLM side like in ReaR. Today is
not yet ready (in development) in DRLM side, but before we can code this
changes in DRLM calling ReaR with <code>-C name</code> we can be able to handle
those configs from ReaR with the drlm_import_runtime_config function.</p>
<p>If not, we cannot code this part because ReaR &amp; DRLM cannot handle these
extra configs/profiles from DRLM.</p>
<p>You can see here (DRLM develop branch):<br />
<a href="https://github.com/brainupdaters/drlm/blob/develop/usr/share/drlm/www/cgi-bin/clients">https://github.com/brainupdaters/drlm/blob/develop/usr/share/drlm/www/cgi-bin/clients</a></p>
<p>That DRLM RESTful API is already written to support this, but before
calling rear with -C from DRLM first must be integrated in rear.</p>
<h4 id="schlomo_commented_at_2017-03-16_1055"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-287022795">2017-03-16 10:55</a>:<a class="headerlink" href="#schlomo_commented_at_2017-03-16_1055" title="Permanent link">&para;</a></h4>
<p>OK, I am giving up. You know my opinion - please @jsmeix and @gdha
decide how to proceed. I don't want to block anything here.</p>
<h4 id="didacog_commented_at_2017-03-16_1110"><img src="https://avatars.githubusercontent.com/u/5380209?u=163f1571e6b9c9c7df94e2c6ca152b0a7406b52d&v=4" width="50"><a href="https://github.com/didacog">didacog</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-287026368">2017-03-16 11:10</a>:<a class="headerlink" href="#didacog_commented_at_2017-03-16_1110" title="Permanent link">&para;</a></h4>
<p>@schlomo I understand that should fail if configurations not found, This
is what I check if drlm_managed before loading or not from local fs.</p>
<p>The problem I see is that you prefer to have 2 separated scripts in
'init' stage and @jsmeix have other opinion. From DRLM side we will send
the PR with your recommendations as always, but before that, all of you
must be agree how to proceed, I guess</p>
<p>Same script with return 0 at the end of the if drlm_managed statement,
or different scripts checking if is drlm_managed at the begining to not
finish with error.</p>
<p>From DRLM side we will adjust the code with your decision.</p>
<h4 id="didacog_commented_at_2017-03-16_1115"><img src="https://avatars.githubusercontent.com/u/5380209?u=163f1571e6b9c9c7df94e2c6ca152b0a7406b52d&v=4" width="50"><a href="https://github.com/didacog">didacog</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-287027326">2017-03-16 11:15</a>:<a class="headerlink" href="#didacog_commented_at_2017-03-16_1115" title="Permanent link">&para;</a></h4>
<p>@gdha Do you have an opinion on this? how to proceed better? I'm a bit
frustrated at this point. :_(</p>
<h4 id="jsmeix_commented_at_2017-03-16_1116"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-287027716">2017-03-16 11:16</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-03-16_1116" title="Permanent link">&para;</a></h4>
<p>@didacog<br />
don't be frustrated.<br />
I think I can make you happy very soon (i.e. in a few hours).</p>
<h4 id="gdha_commented_at_2017-03-16_1150"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-287034444">2017-03-16 11:50</a>:<a class="headerlink" href="#gdha_commented_at_2017-03-16_1150" title="Permanent link">&para;</a></h4>
<p>@didacog I'm fine with the current situation - I think we are on the
same page (more or less).</p>
<h4 id="jsmeix_commented_at_2017-03-16_1152"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-287034969">2017-03-16 11:52</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-03-16_1152" title="Permanent link">&para;</a></h4>
<p>With<br />
<a href="https://github.com/rear/rear/pull/1247">https://github.com/rear/rear/pull/1247</a><br />
merged, I hope @didacog can proceed.</p>
<p>Some explanation why I replaced the 'Error' with a 'LogPrint':</p>
<p>On the one hand - from a strict point of view - I regard this as<br />
a step backward that violates "care about possible errors" in<br />
<a href="https://github.com/rear/rear/wiki/Coding-Style">https://github.com/rear/rear/wiki/Coding-Style</a></p>
<p>On the other hand there is that "Dirty hacks welcome" in<br />
<a href="https://github.com/rear/rear/wiki/Coding-Style">https://github.com/rear/rear/wiki/Coding-Style</a><br />
which reads</p>
<pre>
it is more important that the Relax-and-Recover
code works than having nice looking clean code
that sometimes fails
</pre>

<p>which matches perfectly the current state of this issue here.</p>
<p>I always prefer to move forward little step by little step<br />
(I even prefer to move forward little ugly step by little ugly step)<br />
over big steps that do it right but change a lot at once.</p>
<p>With
<a href="https://github.com/rear/rear/pull/1247">https://github.com/rear/rear/pull/1247</a>
merged<br />
we can now proceed to get it in the end implemented<br />
in a good and clean way but we are no longer blocked.</p>
<p>In the end what I mean is "Worse is better", see<br />
<a href="https://en.wikipedia.org/wiki/Unix_philosophy">https://en.wikipedia.org/wiki/Unix_philosophy</a><br />
i.e. with
<a href="https://github.com/rear/rear/pull/1247">https://github.com/rear/rear/pull/1247</a>
merged I<br />
"favored simplicity over perfection" to be able to move forward.</p>
<h4 id="didacog_commented_at_2017-03-16_1410"><img src="https://avatars.githubusercontent.com/u/5380209?u=163f1571e6b9c9c7df94e2c6ca152b0a7406b52d&v=4" width="50"><a href="https://github.com/didacog">didacog</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-287068736">2017-03-16 14:10</a>:<a class="headerlink" href="#didacog_commented_at_2017-03-16_1410" title="Permanent link">&para;</a></h4>
<p>@jsmeix</p>
<p>Then with your commit, I will undo some commits on my fork to keep
<code>-C name</code> stuff in main script and proceed with the PR.</p>
<p>Hope this night I could have it ready to PR.</p>
<p>Regards,</p>
<h4 id="jsmeix_commented_at_2017-03-16_1435"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-287076797">2017-03-16 14:35</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-03-16_1435" title="Permanent link">&para;</a></h4>
<p>@didacog<br />
yes, please try to keep specific DRLM functionality<br />
separated from generic ReaR functionality.</p>
<p>It is a different and separated issue to move<br />
the whole "sourcing the config files" functionality<br />
out of usr/sbin/rear into one or more new script(s)<br />
in the 'init' stage.<br />
We can do this at any later time as needed and then<br />
with more real experience how the new "multiple backups"<br />
support via DRLM_MANAGED=y works.</p>
<h4 id="didacog_commented_at_2017-03-16_1439"><img src="https://avatars.githubusercontent.com/u/5380209?u=163f1571e6b9c9c7df94e2c6ca152b0a7406b52d&v=4" width="50"><a href="https://github.com/didacog">didacog</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-287077802">2017-03-16 14:39</a>:<a class="headerlink" href="#didacog_commented_at_2017-03-16_1439" title="Permanent link">&para;</a></h4>
<p>Yes, no problem. I just need to undo some changes, or at least create
new branch and redo all changes except that movement.</p>
<h4 id="didacog_commented_at_2017-03-16_1553"><img src="https://avatars.githubusercontent.com/u/5380209?u=163f1571e6b9c9c7df94e2c6ca152b0a7406b52d&v=4" width="50"><a href="https://github.com/didacog">didacog</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-287102023">2017-03-16 15:53</a>:<a class="headerlink" href="#didacog_commented_at_2017-03-16_1553" title="Permanent link">&para;</a></h4>
<p>@jsmeix</p>
<p>I have the changes in my fork, I will test all again, because after
several changes I want to be sure all is working ok. Then I will send
the PR.</p>
<h4 id="jsmeix_commented_at_2017-03-17_0934"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-287307992">2017-03-17 09:34</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-03-17_0934" title="Permanent link">&para;</a></h4>
<p>I submitted
<a href="https://github.com/rear/rear/issues/1251">https://github.com/rear/rear/issues/1251</a><br />
to implement a proper 'init' stage in the future.</p>
<p>@didacog<br />
With probability one
(<a href="https://en.wikipedia.org/wiki/Almost_surely">https://en.wikipedia.org/wiki/Almost_surely</a>)<br />
you will have to do some further adaptions when I implement<br />
<a href="https://github.com/rear/rear/issues/1251">https://github.com/rear/rear/issues/1251</a><br />
of how specific DRLM functionality in ReaR is implemented<br />
to get it cleaned up as a whole.</p>
<h4 id="didacog_commented_at_2017-03-17_1007"><img src="https://avatars.githubusercontent.com/u/5380209?u=163f1571e6b9c9c7df94e2c6ca152b0a7406b52d&v=4" width="50"><a href="https://github.com/didacog">didacog</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-287315118">2017-03-17 10:07</a>:<a class="headerlink" href="#didacog_commented_at_2017-03-17_1007" title="Permanent link">&para;</a></h4>
<p>@jsmeix</p>
<p>What kind of adaptions? please can you give me more info, because we are
working on that part of our code and we should know what is supposed to
change.</p>
<h4 id="jsmeix_commented_at_2017-03-17_1018"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-287317282">2017-03-17 10:18</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-03-17_1018" title="Permanent link">&para;</a></h4>
<p>@didacog<br />
I cannot give you info now what you<br />
will have to adapt when I implement<br />
<a href="https://github.com/rear/rear/issues/1251">https://github.com/rear/rear/issues/1251</a><br />
in the future.</p>
<p>For now, just go ahead based on what there is now in ReaR.</p>
<p>In the future, things in ReaR will change<br />
and then you need to adapt (with probability one).</p>
<h4 id="didacog_commented_at_2017-03-17_1022"><img src="https://avatars.githubusercontent.com/u/5380209?u=163f1571e6b9c9c7df94e2c6ca152b0a7406b52d&v=4" width="50"><a href="https://github.com/didacog">didacog</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-287318113">2017-03-17 10:22</a>:<a class="headerlink" href="#didacog_commented_at_2017-03-17_1022" title="Permanent link">&para;</a></h4>
<p>@jsmeix Ok, then will see what will happen :-), but I will appreciate
that when you start #1251 we can discuss the changes regarding DRLM
integration :-P</p>
<h4 id="didacog_commented_at_2017-03-22_1634"><img src="https://avatars.githubusercontent.com/u/5380209?u=163f1571e6b9c9c7df94e2c6ca152b0a7406b52d&v=4" width="50"><a href="https://github.com/didacog">didacog</a> commented at <a href="https://github.com/rear/rear/issues/1229#issuecomment-288458820">2017-03-22 16:34</a>:<a class="headerlink" href="#didacog_commented_at_2017-03-22_1634" title="Permanent link">&para;</a></h4>
<p>Hi all,<br />
I will close this issue because the PR #1252 was merged.</p>
<p>Regards,</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2025 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2017-03-09.1229.issue.closed.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/rear/rear-user-guide" class="fa fa-code-fork" style="color: #fcfcfc"> rear/rear-user-guide</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
