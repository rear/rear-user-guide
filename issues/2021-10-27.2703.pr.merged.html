<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#2703 PR merged: Enhanced disk write-protection - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#2703 PR merged: Enhanced disk write-protection";
        var mkdocs_page_input_path = "issues/2021-10-27.2703.pr.merged.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#2703 PR merged: Enhanced disk write-protection</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="2703_pr_merged_enhanced_disk_write-protection"><a href="https://github.com/rear/rear/pull/2703">#2703 PR</a> <code>merged</code>: Enhanced disk write-protection<a class="headerlink" href="#2703_pr_merged_enhanced_disk_write-protection" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>enhancement</code>, <code>fixed / solved / done</code></p>
<h4 id="jsmeix_opened_issue_at_2021-10-27_1115"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> opened issue at <a href="https://github.com/rear/rear/pull/2703">2021-10-27 11:15</a>:<a class="headerlink" href="#jsmeix_opened_issue_at_2021-10-27_1115" title="Permanent link">&para;</a></h4>
<ul>
<li>
<p>Type: <strong>Enhancement</strong></p>
</li>
<li>
<p>Impact: <strong>Normal</strong></p>
</li>
<li>
<p>Reference to related issue (URL):<br />
<a href="https://github.com/rear/rear/pull/2626">https://github.com/rear/rear/pull/2626</a></p>
</li>
<li>
<p>How was this pull request tested?<br />
    Not yet tested by me - will test soon...</p>
</li>
<li>
<p>Brief description of the changes in this pull request:</p>
</li>
</ul>
<p>The specific WRITE_PROTECTED_PARTITION_TABLE_UUIDS<br />
is replaced by WRITE_PROTECTED_IDS with generic functionality<br />
cf.
<a href="https://github.com/rear/rear/pull/2626#issuecomment-950953826">https://github.com/rear/rear/pull/2626#issuecomment-950953826</a><br />
together with the new WRITE_PROTECTED_ID_TYPES which<br />
defaults to UUID PTUUID PARTUUID WWN so that the user can<br />
specify different lsblk columns as needed in his particular environment</p>
<p>WRITE_PROTECTED_FILE_SYSTEM_LABEL_PATTERNS<br />
is shortened to WRITE_PROTECTED_FS_LABEL_PATTERNS</p>
<h4 id="jsmeix_commented_at_2021-10-27_1244"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2703#issuecomment-952888484">2021-10-27 12:44</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-10-27_1244" title="Permanent link">&para;</a></h4>
<p>I tested this one similar as I did in<br />
<a href="https://github.com/rear/rear/pull/2626#issuecomment-950935246">https://github.com/rear/rear/pull/2626#issuecomment-950935246</a><br />
but this pull request is based on latest ReaR upstream code<br />
so things behave a bit different now:</p>
<p>I tested it on the two VMs with those GPT disks</p>
<pre><code>original system            replacement system
sda 8 GiB system disk      sda the 8 GiB ReaR "USB" disk from the original system
sdb 8 GiB ReaR "USB" disk  sdb 9 GiB replacement system disk
</code></pre>
<p>as in
<a href="https://github.com/rear/rear/pull/2626#issuecomment-950935246">https://github.com/rear/rear/pull/2626#issuecomment-950935246</a></p>
<p>I use almost same etc/rear/local.conf<br />
as in
<a href="https://github.com/rear/rear/pull/2626#issuecomment-950935246">https://github.com/rear/rear/pull/2626#issuecomment-950935246</a><br />
but now only DISKS_TO_BE_WIPED='' is added</p>
<pre><code>DISKS_TO_BE_WIPED=''
FIRMWARE_FILES=( 'no' )
MODULES=( 'loaded_modules' )
PROGRESS_MODE="plain"
PROGRESS_WAIT_SECONDS="3"
SSH_ROOT_PASSWORD="rear"
OUTPUT=USB
USB_DEVICE_FILESYSTEM_PERCENTAGE=90
USB_DEVICE_FILESYSTEM_LABEL="MY-DATA"
USB_BOOT_PART_SIZE=1024
USB_BOOTLOADER="grub"
USB_DEVICE_BOOT_LABEL="MY-BOOT"
OUTPUT_URL=usb:///dev/disk/by-label/MY-BOOT
USB_DEVICE_PARTED_LABEL=gpt
BACKUP=NETFS
BACKUP_URL=usb:///dev/disk/by-label/MY-DATA
</code></pre>
<p>After "rear mkbackup" things in<br />
/var/tmp/rear.AtrtkGDGb5CP4qY/rootfs/etc/rear/rescue.conf<br />
look better now (excerpt)</p>
<pre><code># The following lines were added by 490_store_write_protect_settings.sh
WRITE_PROTECTED_UUIDS=( 8bd9f9e8-9043-4a80-84e1-64d417244529 e38c933c-d18f-4821-92c9-c99673738660 efee5e95-40a0-4a8e-bbe1-1cad7c0d255d )
WRITE_PROTECTED_FS_LABEL_PATTERNS=( 'MY-DATA' )
</code></pre>
<p>Those UUIDs and the LABEL match only /dev/sdb3</p>
<pre><code># lsblk -ipo NAME,LABEL,UUID,PTUUID,PARTUUID /dev/sdb
NAME        LABEL   UUID                                 PTUUID                               PARTUUID
/dev/sdb                                                 efee5e95-40a0-4a8e-bbe1-1cad7c0d255d 
|-/dev/sdb1                                              efee5e95-40a0-4a8e-bbe1-1cad7c0d255d aa3d3f8b-3adb-4ef8-a4c0-0e44cdadfff6
|-/dev/sdb2 MY-BOOT ff15e0f1-b4bb-4a02-bb10-1502ec2fe0be efee5e95-40a0-4a8e-bbe1-1cad7c0d255d 281246c5-d29f-4ed2-8cfb-c7404eca010d
`-/dev/sdb3 MY-DATA 8bd9f9e8-9043-4a80-84e1-64d417244529 efee5e95-40a0-4a8e-bbe1-1cad7c0d255d e38c933c-d18f-4821-92c9-c99673738660
</code></pre>
<p>because prep/USB/default/480_initialize_write_protect_settings.sh<br />
is run with USB_DEVICE=/dev/disk/by-label/MY-DATA</p>
<pre><code># grep -A20 'source /root/rear.github.master/usr/share/rear/prep/USB/default/480_initialize_write_protect_settings.sh' var/log/rear/rear-localhost.log
+ source /root/rear.github.master/usr/share/rear/prep/USB/default/480_initialize_write_protect_settings.sh
++ local uuids
+++ write_protection_uuids /dev/disk/by-label/MY-DATA
++++ write_protected_candidate_device /dev/disk/by-label/MY-DATA
++++ local device=/dev/disk/by-label/MY-DATA
++++ [[ /dev/disk/by-label/MY-DATA == /sys/block/* ]]
++++ test -b /dev/disk/by-label/MY-DATA
++++ echo /dev/disk/by-label/MY-DATA
+++ local 'device=/dev/disk/by-label/MY-DATA '
+++ local column
+++ sort -u
+++ awk NF
+++ for column in UUID PTUUID PARTUUID
+++ lsblk -ino UUID /dev/disk/by-label/MY-DATA
+++ for column in UUID PTUUID PARTUUID
+++ lsblk -ino PTUUID /dev/disk/by-label/MY-DATA
+++ for column in UUID PTUUID PARTUUID
+++ lsblk -ino PARTUUID /dev/disk/by-label/MY-DATA
++ uuids='8bd9f9e8-9043-4a80-84e1-64d417244529
e38c933c-d18f-4821-92c9-c99673738660
efee5e95-40a0-4a8e-bbe1-1cad7c0d255d'
</code></pre>
<p>This is good enough for now but I would prefer when<br />
the whole disk /dev/sdb could be used because the goal is<br />
to write-protect the whole disk.</p>
<p>"rear recover"<br />
the complete terminal output (except backup restore progress messages):</p>
<pre><code># rear -D recover
Relax-and-Recover 2.6 / Git
Running rear recover (PID 666 date 2021-10-27 14:17:30)
Command line options: /bin/rear -D recover
Using log file: /var/log/rear/rear-localhost.log
Using build area: /var/tmp/rear.XDBgxpA2pnwa9Yt
Running 'init' stage
Running workflow recover within the ReaR rescue/recovery system
Running 'setup' stage
Running 'verify' stage
Using backup archive '/var/tmp/rear.XDBgxpA2pnwa9Yt/outputfs/rear/localhost/20211027.1337/backup.tar.gz'
Will do driver migration (recreating initramfs/initrd)
Backup archive /var/tmp/rear.XDBgxpA2pnwa9Yt/outputfs/rear/localhost/20211025.1417/backup.tar.gz detected.
Backup archive /var/tmp/rear.XDBgxpA2pnwa9Yt/outputfs/rear/localhost/20211027.1337/backup.tar.gz detected.
Select a backup archive.
1) 20211025.1417
2) 20211027.1337
#? 2
Using backup archive '/var/tmp/rear.XDBgxpA2pnwa9Yt/outputfs/rear/localhost/20211027.1337/backup.tar.gz'.
Calculating backup archive size
Backup archive size is 1.2G     /var/tmp/rear.XDBgxpA2pnwa9Yt/outputfs/rear/localhost/20211027.1337/backup.tar.gz (compressed)
Running 'layout/prepare' stage
Comparing disks
Device sda is designated as write-protected (needs manual configuration)
Switching to manual disk layout configuration
Cannot use /dev/sda (same name and same size) for recreating /dev/sda (/dev/sda is write-protected)
Cannot use /dev/sda (same size) for recreating /dev/sda (/dev/sda is write-protected)
Could not automap /dev/sda (no disk with same size 8589934592 found)
Original disk /dev/sda does not exist (with same size) in the target system
No device found where to /dev/sda could be mapped so that it will not be recreated
Current disk mapping table (source =&gt; target):
  There is no valid disk mapping
Currently unmapped disks and dependant devices will not be recreated
(unless identical disk mapping and proceeding without manual configuration):
  /dev/sda /dev/sda1 /dev/sda2 fs:/
UserInput -I LAYOUT_MIGRATION_CONFIRM_MAPPINGS needed in /usr/share/rear/layout/prepare/default/300_map_disks.sh line 306
Confirm or edit the disk mapping
1) Confirm disk mapping and continue 'rear recover'
2) Confirm identical disk mapping and proceed without manual configuration
3) Edit disk mapping (/var/lib/rear/layout/disk_mappings)
4) Use Relax-and-Recover shell and return back to here
5) Abort 'rear recover'
(default '1' timeout 300 seconds)
4
UserInput: Valid choice number result 'Use Relax-and-Recover shell and return back to here'

Welcome to Relax-and-Recover.

rear&gt; echo "/dev/sda /dev/sdb" &gt;/var/lib/rear/layout/disk_mappings
rear&gt; exit
Are you sure you want to exit the Relax-and-Recover shell ? y
exit
Current disk mapping table (source =&gt; target):
  /dev/sda =&gt; /dev/sdb

UserInput -I LAYOUT_MIGRATION_CONFIRM_MAPPINGS needed in /usr/share/rear/layout/prepare/default/300_map_disks.sh line 306
Confirm or edit the disk mapping
1) Confirm disk mapping and continue 'rear recover'
2) n/a
3) Edit disk mapping (/var/lib/rear/layout/disk_mappings)
4) Use Relax-and-Recover shell and return back to here
5) Abort 'rear recover'
(default '1' timeout 300 seconds)

UserInput: No real user input (empty or only spaces) - using default input
UserInput: Valid choice number result 'Confirm disk mapping and continue 'rear recover''
User confirmed disk mapping
Disabling excluded components in /var/lib/rear/layout/disklayout.conf
Applied disk layout mappings to /var/lib/rear/layout/disklayout.conf
Applied disk layout mappings to /var/lib/rear/layout/config/df.txt
Applied disk layout mappings to /etc/rear/rescue.conf
Examining gpt disk /dev/sdb to automatically resize its last active partition
Checking /dev/sdb1 if it is the last partition on /dev/sdb
Checking /dev/sdb2 if it is the last partition on /dev/sdb
Found 'rear-noname' partition /dev/sdb2 as last partition on /dev/sdb
Determining if last partition /dev/sdb2 is resizeable
Last partition /dev/sdb2 not resizeable (used during boot)
Determining new size for last partition /dev/sdb2
Determining if last partition /dev/sdb2 actually needs to be increased or shrinked
New /dev/sdb is 1073741824 bytes bigger than old disk
Skip increasing last partition /dev/sdb2 (not resizeable)
UserInput -I LAYOUT_FILE_CONFIRMATION needed in /usr/share/rear/layout/prepare/default/500_confirm_layout_file.sh line 26
Confirm or edit the disk layout file
1) Confirm disk layout and continue 'rear recover'
2) Edit disk layout (/var/lib/rear/layout/disklayout.conf)
3) View disk layout (/var/lib/rear/layout/disklayout.conf)
4) View original disk space usage (/var/lib/rear/layout/config/df.txt)
5) Use Relax-and-Recover shell and return back to here
6) Abort 'rear recover'
(default '1' timeout 300 seconds)

UserInput: No real user input (empty or only spaces) - using default input
UserInput: Valid choice number result 'Confirm disk layout and continue 'rear recover''
User confirmed disk layout file
Marking component '/dev/sdb' as done in /var/lib/rear/layout/disktodo.conf
Marking component '/dev/sdb1' as done in /var/lib/rear/layout/disktodo.conf
Marking component '/dev/sdb2' as done in /var/lib/rear/layout/disktodo.conf
Marking component 'fs:/' as done in /var/lib/rear/layout/disktodo.conf
Running 'layout/recreate' stage
UserInput -I LAYOUT_CODE_CONFIRMATION needed in /usr/share/rear/layout/recreate/default/100_confirm_layout_code.sh line 26
Confirm or edit the disk recreation script
1) Confirm disk recreation script and continue 'rear recover'
2) Edit disk recreation script (/var/lib/rear/layout/diskrestore.sh)
3) View disk recreation script (/var/lib/rear/layout/diskrestore.sh)
4) View original disk space usage (/var/lib/rear/layout/config/df.txt)
5) Use Relax-and-Recover shell and return back to here
6) Abort 'rear recover'
(default '1' timeout 300 seconds)

UserInput: No real user input (empty or only spaces) - using default input
UserInput: Valid choice number result 'Confirm disk recreation script and continue 'rear recover''
User confirmed disk recreation script
UserInput -I WIPE_DISKS_CONFIRMATION needed in /usr/share/rear/layout/recreate/default/120_confirm_wipedisk_disks.sh line 36
Disks to be overwritten: /dev/sdb 
1) Confirm disks to be completely overwritten and continue 'rear recover'
2) Use Relax-and-Recover shell and return back to here
3) Abort 'rear recover'
(default '1' timeout 300 seconds)

UserInput: No real user input (empty or only spaces) - using default input
UserInput: Valid choice number result 'Confirm disks to be completely overwritten and continue 'rear recover''
User confirmed disks to be overwritten
Wiping child devices of /dev/sdb in reverse ordering: /dev/sdb2 /dev/sdb1 /dev/sdb 
Wiped first 16777216 bytes of /dev/sdb2
Wiped last 16777216 bytes of /dev/sdb2
Wiped first 8388608 bytes of /dev/sdb1
Skip wiping at the end of /dev/sdb1 (dvice size 8388608 not greater than the bytes that were wiped)
Wiped first 16777216 bytes of /dev/sdb
Wiped last 16777216 bytes of /dev/sdb
Start system layout restoration.
Disk '/dev/sdb': creating 'gpt' partition table
Disk '/dev/sdb': creating partition number 1 with name ''sdb1''
Disk '/dev/sdb': creating partition number 2 with name ''sdb2''
Creating filesystem of type ext4 with mount point / on /dev/sdb2.
Mounting filesystem /
Disk layout created.
UserInput -I LAYOUT_MIGRATED_CONFIRMATION needed in /usr/share/rear/layout/recreate/default/200_run_layout_code.sh line 98
Confirm the recreated disk layout or go back one step
1) Confirm recreated disk layout and continue 'rear recover'
2) Go back one step to redo disk layout recreation
3) Use Relax-and-Recover shell and return back to here
4) Abort 'rear recover'
(default '1' timeout 300 seconds)

UserInput: No real user input (empty or only spaces) - using default input
UserInput: Valid choice number result 'Confirm recreated disk layout and continue 'rear recover''
User confirmed recreated disk layout
Running 'restore' stage
Restoring from '/var/tmp/rear.XDBgxpA2pnwa9Yt/outputfs/rear/localhost/20211027.1337/backup.tar.gz' (restore log in /var/lib/rear/restore/recover.backup.tar.gz.666.restore.log) ...
Backup restore program 'tar' started in subshell (PID=3791)
Restored 155 MiB [avg. 53170 KiB/sec] 
.
.
.
OK
Restored 2822 MiB in 109 seconds [avg. 26518 KiB/sec]
Restoring finished (verify backup restore log messages in /var/lib/rear/restore/recover.backup.tar.gz.666.restore.log)
Created SELinux /mnt/local/.autorelabel file : after reboot SELinux will relabel all files
Recreating directories (with permissions) from /var/lib/rear/recovery/directories_permissions_owner_group
Running 'finalize' stage
Applying disk layout mappings in /var/lib/rear/layout/disk_mappings to certain restored files...
The original restored files get saved in var/lib/rear/saved_original_files/ (in /mnt/local)
Applied disk layout mappings to restored 'boot/grub2/grub.cfg' (in /mnt/local)
Failed to apply layout mappings to boot/grub2/device.map for /dev/sdb (probably no mapping for /dev/sdb in /var/lib/rear/layout/disk_mappings)
Failed to apply disk layout mappings to restored 'boot/grub2/device.map' (in /mnt/local)
Applied disk layout mappings to restored 'etc/sysconfig/bootloader' (in /mnt/local)
Skip patching symlink etc/mtab target /mnt/local/proc/4429/mounts on /proc/ /sys/ /dev/ or /run/
Applied disk layout mappings to restored 'etc/fstab' (in /mnt/local)
Applied disk layout mappings to restored 'etc/smartd.conf' (in /mnt/local)
Applied disk layout mappings to restored 'etc/sysconfig/smartmontools' (in /mnt/local)
Failed to apply layout mappings to /var/lib/rear/recovery/diskbyid_mappings for /dev/sdb (probably no mapping for /dev/sdb in /var/lib/rear/layout/disk_mappings)
Failed to apply layout mappings to /var/lib/rear/recovery/diskbyid_mappings (may cause failures during 'rename_diskbyid')
Migrating disk-by-id mappings in certain restored files in /mnt/local to current disk-by-id mappings ...
Replaced '/dev/disk/by-id/ata-QEMU_HARDDISK_QM00001' by '/dev/disk/by-id/ata-QEMU_HARDDISK_QM00002' in /mnt/local//etc/default/grub_installdevice
Replacing restored udev rule '/mnt/local//etc/udev/rules.d/70-persistent-net.rules' with the one from the ReaR rescue system
Migrating restored network configuration files according to the mapping files ...
UserInput -I RESTORED_FILES_CONFIRMATION needed in /usr/share/rear/finalize/default/520_confirm_finalize.sh line 41
Confirm restored config files are OK or adapt them as needed
1) Confirm it is OK to recreate initrd and reinstall bootloader and continue 'rear recover'
2) Edit restored etc/fstab (/mnt/local/etc/fstab)
3) View restored etc/fstab (/mnt/local/etc/fstab)
4) Use Relax-and-Recover shell and return back to here
5) Abort 'rear recover'
(default '1' timeout 300 seconds)
UserInput: No real user input (empty or only spaces) - using default input
UserInput: Valid choice number result 'Confirm it is OK to recreate initrd and reinstall bootloader and continue 'rear recover''
Continuing 'rear recover' by default
Running mkinitrd...
Recreated initrd (/sbin/mkinitrd).
Installing GRUB2 boot loader...
Determining where to install GRUB2 (no GRUB2_INSTALL_DEVICES specified)
Found possible boot disk /dev/sdb - installing GRUB2 there
Running 'wrapup' stage
Finished 'recover'. The target system is mounted at '/mnt/local'.
Exiting rear recover (PID 666) and its descendant processes ...
Running exit tasks
To remove the build area you may use (with caution): rm -Rf --one-file-system /var/tmp/rear.XDBgxpA2pnwa9Yt
</code></pre>
<p>The recreated system boots well from sdb and seems to work OK.</p>
<h4 id="jsmeix_commented_at_2021-10-27_1251"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2703#issuecomment-952894096">2021-10-27 12:51</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-10-27_1251" title="Permanent link">&para;</a></h4>
<p>Excerpts how automated disk mapping changed from<br />
<a href="https://github.com/rear/rear/pull/2626#issuecomment-950935246">https://github.com/rear/rear/pull/2626#issuecomment-950935246</a></p>
<pre><code>Comparing disks
Device sda is designated as write-protected (needs manual configuration)
Switching to manual disk layout configuration
Cannot use /dev/sda (same name and same size) for recreating /dev/sda (/dev/sda is write-protected)
Cannot use /dev/sda (same size) for recreating /dev/sda (/dev/sda is write-protected)
Could not automap /dev/sda (no disk with same size 8589934592 found)
Original disk /dev/sda does not exist (with same size) in the target system
Using /dev/sdb (the only appropriate) for recreating /dev/sda
Current disk mapping table (source =&gt; target):
  /dev/sda =&gt; /dev/sdb
</code></pre>
<p>to here where the latest Github master code is used</p>
<pre><code>Comparing disks
Device sda is designated as write-protected (needs manual configuration)
Switching to manual disk layout configuration
Cannot use /dev/sda (same name and same size) for recreating /dev/sda (/dev/sda is write-protected)
Cannot use /dev/sda (same size) for recreating /dev/sda (/dev/sda is write-protected)
Could not automap /dev/sda (no disk with same size 8589934592 found)
Original disk /dev/sda does not exist (with same size) in the target system
No device found where to /dev/sda could be mapped so that it will not be recreated
Current disk mapping table (source =&gt; target):
  There is no valid disk mapping
Currently unmapped disks and dependant devices will not be recreated
(unless identical disk mapping and proceeding without manual configuration):
  /dev/sda /dev/sda1 /dev/sda2 fs:/
</code></pre>
<p>so there is no longer an automated mapping to<br />
"just the last available disk regardless of its size"<br />
which means the issue in the "Note" at the end of<br />
<a href="https://github.com/rear/rear/pull/2626#issue-662429889">https://github.com/rear/rear/pull/2626#issue-662429889</a><br />
seems to be solved in latest Github master code.</p>
<h4 id="jsmeix_commented_at_2021-10-27_1312"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2703#issuecomment-952914433">2021-10-27 13:12</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-10-27_1312" title="Permanent link">&para;</a></h4>
<p>The "rear recover" log shows why /dev/sdb excluded from device mapping
choices</p>
<pre><code>... /dev/sdb is designated as write-protected by UUID 8bd9f9e8-9043-4a80-84e1-64d417244529
... 
... /dev/sdb excluded from device mapping choices (is designated as write-protected)
</code></pre>
<p>which is wrong because UUID 8bd9f9e8-9043-4a80-84e1-64d417244529<br />
does not belong to sdb but to sda</p>
<pre><code># lsblk --output NAME,LABEL,UUID,PTUUID,PARTUUID
NAME   LABEL   UUID                                 PTUUID                               PARTUUID
sda                                                 efee5e95-40a0-4a8e-bbe1-1cad7c0d255d 
├─sda1                                              efee5e95-40a0-4a8e-bbe1-1cad7c0d255d aa3d3f8b-3adb-4ef8-a4c0-0e44cdadfff6
├─sda2 MY-BOOT ff15e0f1-b4bb-4a02-bb10-1502ec2fe0be efee5e95-40a0-4a8e-bbe1-1cad7c0d255d 281246c5-d29f-4ed2-8cfb-c7404eca010d
└─sda3 MY-DATA 8bd9f9e8-9043-4a80-84e1-64d417244529 efee5e95-40a0-4a8e-bbe1-1cad7c0d255d e38c933c-d18f-4821-92c9-c99673738660
sdb                                                 fb6e13f1-f9c6-490f-b9dc-c49e10639cd9 
├─sdb1                                              fb6e13f1-f9c6-490f-b9dc-c49e10639cd9 e8c2b900-3064-401b-8ad7-fa2b45d65f73
└─sdb2         83a3f413-6e7d-4591-bd60-c87803613166 fb6e13f1-f9c6-490f-b9dc-c49e10639cd9 6a2c6852-e1d9-4b97-9e64-86f6d17e4b2b
</code></pre>
<p>In particular the "rear recover" log shows</p>
<pre><code>... /dev/sda is designated as write-protected by UUID 8bd9f9e8-9043-4a80-84e1-64d417244529
... /dev/sdb is designated as write-protected by UUID 8bd9f9e8-9043-4a80-84e1-64d417244529
</code></pre>
<p>so same UUID for both sda and sdb.</p>
<p>Investigating...</p>
<h4 id="jsmeix_commented_at_2021-10-27_1355"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2703#issuecomment-952955861">2021-10-27 13:55</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-10-27_1355" title="Permanent link">&para;</a></h4>
<p>With latest changes things look better:</p>
<p>"rear recover" excerpts:</p>
<pre><code>Comparing disks
Device sda is designated as write-protected (needs manual configuration)
Switching to manual disk layout configuration
Cannot use /dev/sda (same name and same size) for recreating /dev/sda (/dev/sda is write-protected)
Cannot use /dev/sda (same size) for recreating /dev/sda (/dev/sda is write-protected)
Could not automap /dev/sda (no disk with same size 8589934592 found)
Original disk /dev/sda does not exist (with same size) in the target system
Using /dev/sdb (the only appropriate) for recreating /dev/sda
Current disk mapping table (source =&gt; target):
  /dev/sda =&gt; /dev/sdb

UserInput -I LAYOUT_MIGRATION_CONFIRM_MAPPINGS needed in /usr/share/rear/layout/prepare/default/300_map_disks.sh line 306
Confirm or edit the disk mapping
1) Confirm disk mapping and continue 'rear recover'
2) n/a
3) Edit disk mapping (/var/lib/rear/layout/disk_mappings)
4) Use Relax-and-Recover shell and return back to here
5) Abort 'rear recover'
</code></pre>
<p>All user dialogs were accepted with the default (i.e. just proceed)
and<br />
the recreated system boots well from sdb and seems to work OK.</p>
<h4 id="jsmeix_commented_at_2021-10-27_1400"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2703#issuecomment-952960900">2021-10-27 14:00</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-10-27_1400" title="Permanent link">&para;</a></h4>
<p>@rear/contributors<br />
please have a look here (as time permits)</p>
<h4 id="pcahyna_commented_at_2021-10-27_1404"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/2703#issuecomment-952965032">2021-10-27 14:04</a>:<a class="headerlink" href="#pcahyna_commented_at_2021-10-27_1404" title="Permanent link">&para;</a></h4>
<p>@jsmeix I will have a look next week (this week we will have a holiday).</p>
<h4 id="jsmeix_commented_at_2021-10-28_0631"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2703#issuecomment-953542473">2021-10-28 06:31</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-10-28_0631" title="Permanent link">&para;</a></h4>
<p>@pcahyna<br />
you got the reviewer job ;-)<br />
Enjoy your holiday - relax and recover !</p>
<h4 id="jsmeix_commented_at_2021-10-28_1056"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2703#issuecomment-953734502">2021-10-28 10:56</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-10-28_1056" title="Permanent link">&para;</a></h4>
<p>With latest changes now all UUIDs are used.</p>
<p>After "rear mkbackup" I have in /etc/rear/rescue.conf<br />
(I wrapped the UUIDs here for better readability)</p>
<pre><code>WRITE_PROTECTED_UUIDS=( 281246c5-d29f-4ed2-8cfb-c7404eca010d
 8bd9f9e8-9043-4a80-84e1-64d417244529 aa3d3f8b-3adb-4ef8-a4c0-0e44cdadfff6
 e38c933c-d18f-4821-92c9-c99673738660 efee5e95-40a0-4a8e-bbe1-1cad7c0d255d
 ff15e0f1-b4bb-4a02-bb10-1502ec2fe0be )
WRITE_PROTECTED_FS_LABEL_PATTERNS=( 'MY-DATA' )
</code></pre>
<p>which are all UUIDs of the ReaR's own disk sda in the recovery system</p>
<pre><code>RESCUE localhost:~ # lsblk -ipo KNAME,LABEL,UUID,PTUUID,PARTUUID /dev/sda
KNAME     LABEL   UUID                                 PTUUID                               PARTUUID
/dev/sda                                               efee5e95-40a0-4a8e-bbe1-1cad7c0d255d 
/dev/sda1                                              efee5e95-40a0-4a8e-bbe1-1cad7c0d255d aa3d3f8b-3adb-4ef8-a4c0-0e44cdadfff6
/dev/sda2 MY-BOOT ff15e0f1-b4bb-4a02-bb10-1502ec2fe0be efee5e95-40a0-4a8e-bbe1-1cad7c0d255d 281246c5-d29f-4ed2-8cfb-c7404eca010d
/dev/sda3 MY-DATA 8bd9f9e8-9043-4a80-84e1-64d417244529 efee5e95-40a0-4a8e-bbe1-1cad7c0d255d e38c933c-d18f-4821-92c9-c99673738660
</code></pre>
<h4 id="jsmeix_commented_at_2021-10-28_1120"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2703#issuecomment-953751199">2021-10-28 11:20</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-10-28_1120" title="Permanent link">&para;</a></h4>
<p>Tested "rear recover" with only<br />
<code>WRITE_PROTECTED_FS_LABEL_PATTERNS=( 'MY-DATA' )</code><br />
in /etc/rear/rescue.conf<br />
(i.e. without any WRITE_PROTECTED_UUIDS)<br />
which also works OK for me (excerpt)</p>
<pre><code>Comparing disks
Device sda is designated as write-protected (needs manual configuration)
Switching to manual disk layout configuration
Cannot use /dev/sda (same name and same size) for recreating /dev/sda (/dev/sda is write-protected)
Cannot use /dev/sda (same size) for recreating /dev/sda (/dev/sda is write-protected)
Could not automap /dev/sda (no disk with same size 8589934592 found)
Original disk /dev/sda does not exist (with same size) in the target system
Using /dev/sdb (the only appropriate) for recreating /dev/sda
Current disk mapping table (source =&gt; target):
  /dev/sda =&gt; /dev/sdb
</code></pre>
<p>and the "rear -D recover" log contains</p>
<pre><code>... /dev/sda is not write-protected by UUID
... /dev/sda is designated as write-protected, its label 'MY-DATA' matches 'MY-DATA'
</code></pre>
<h4 id="jsmeix_commented_at_2021-10-29_1251"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2703#issuecomment-954718510">2021-10-29 12:51</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-10-29_1251" title="Permanent link">&para;</a></h4>
<p>I would like to optimize things by avoiding needless duplicate tests
like</p>
<pre><code>Cannot use /dev/sda (same name and same size) for recreating /dev/sda (/dev/sda is write-protected)
Cannot use /dev/sda (same size) for recreating /dev/sda (/dev/sda is write-protected)
</code></pre>
<p>cf.
<a href="https://github.com/rear/rear/pull/2703#issuecomment-953751199">https://github.com/rear/rear/pull/2703#issuecomment-953751199</a></p>
<h4 id="jsmeix_commented_at_2021-10-29_1255"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2703#issuecomment-954721118">2021-10-29 12:55</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-10-29_1255" title="Permanent link">&para;</a></h4>
<p>With latest commit needless duplicate tests do no longer happen.</p>
<p>"rear -D recover" excerpts in same test environment as above in<br />
<a href="https://github.com/rear/rear/pull/2703#issuecomment-952955861">https://github.com/rear/rear/pull/2703#issuecomment-952955861</a></p>
<pre><code>Comparing disks
Device sda is designated as write-protected (needs manual configuration)
Switching to manual disk layout configuration
Cannot use /dev/sda (same name and same size) for recreating /dev/sda (/dev/sda is write-protected)
Could not automap /dev/sda (no disk with same size 8589934592 found)
Original disk /dev/sda does not exist (with same size) in the target system
Using /dev/sdb (the only appropriate) for recreating /dev/sda
Current disk mapping table (source =&gt; target):
  /dev/sda =&gt; /dev/sdb
</code></pre>
<h4 id="jsmeix_commented_at_2021-10-29_1314"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2703#issuecomment-954734968">2021-10-29 13:14</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-10-29_1314" title="Permanent link">&para;</a></h4>
<p>The latest commit<br />
<a href="https://github.com/rear/rear/pull/2703/commits/4738313cdc011e905b8e63dbb012748e0dcb9f79">https://github.com/rear/rear/pull/2703/commits/4738313cdc011e905b8e63dbb012748e0dcb9f79</a><br />
should at least a bit address the issue in the "Note" at the end of<br />
<a href="https://github.com/rear/rear/pull/2626#issue-662429889">https://github.com/rear/rear/pull/2626#issue-662429889</a><br />
by less misleading wording why that disk is chosen<br />
so it should now look like</p>
<pre><code>Comparing disks
Device sda is designated as write-protected (needs manual configuration)
Switching to manual disk layout configuration
Cannot use /dev/sda (same name and same size) for recreating /dev/sda (/dev/sda is write-protected)
Could not automap /dev/sda (no disk with same size 8589934592 found)
Original disk /dev/sda does not exist (with same size) in the target system
Using /dev/sdb (the only available of the disks) for recreating /dev/sda
Current disk mapping table (source =&gt; target):
  /dev/sda =&gt; /dev/sdb
</code></pre>
<h4 id="jsmeix_commented_at_2021-11-03_1440"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2703#issuecomment-959283675">2021-11-03 14:40</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-11-03_1440" title="Permanent link">&para;</a></h4>
<p>@pcahyna<br />
do you have time to have a look here?</p>
<h4 id="pcahyna_commented_at_2021-11-03_1515"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/pull/2703#issuecomment-959402044">2021-11-03 15:15</a>:<a class="headerlink" href="#pcahyna_commented_at_2021-11-03_1515" title="Permanent link">&para;</a></h4>
<p>@jsmeix I am going to have a look tomorrow, sorry for the delay</p>
<h4 id="jsmeix_commented_at_2021-11-05_1150"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2703#issuecomment-961832248">2021-11-05 11:50</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-11-05_1150" title="Permanent link">&para;</a></h4>
<p>I did not yet test my recent commits.</p>
<h4 id="jsmeix_commented_at_2021-11-05_1212"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2703#issuecomment-961845716">2021-11-05 12:12</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-11-05_1212" title="Permanent link">&para;</a></h4>
<p>@pcahyna<br />
I think we cannot use SERIAL because on my KVM/QEMU system I get</p>
<pre><code># lsblk -ipo KNAME,LABEL,UUID,PTUUID,PARTUUID,SERIAL,WWN /dev/sda
KNAME     LABEL UUID                                 PTUUID                               PARTUUID                             SERIAL  WWN
/dev/sda                                             fc224eb1-9058-4b88-864a-1fb89018ecf7                                      QM00001 
/dev/sda1                                            fc224eb1-9058-4b88-864a-1fb89018ecf7 735f37c2-d5f1-4874-a546-b25d99b5cdfc         
/dev/sda2       83a3f413-6e7d-4591-bd60-c87803613166 fc224eb1-9058-4b88-864a-1fb89018ecf7 d5166397-8e27-41f4-94e1-428549ca36c4

# lsblk -ipo KNAME,LABEL,UUID,PTUUID,PARTUUID,SERIAL,WWN /dev/sdb
KNAME     LABEL    UUID                                 PTUUID                               PARTUUID                             SERIAL  WWN
/dev/sdb                                                e3c7fe07-f86b-434b-aefe-c5e64eda0e36                                      QM00003 
/dev/sdb1                                               e3c7fe07-f86b-434b-aefe-c5e64eda0e36 fc826b1b-6ed7-46d0-9f47-948cb77b4b42         
/dev/sdb2 REAR-EFI 296B-6A05                            e3c7fe07-f86b-434b-aefe-c5e64eda0e36 da1f0a9c-bb29-43dd-9161-0b72074c91ac         
/dev/sdb3 MY-BOOT  5badfdc3-10eb-4f0c-a4e0-a6a5176781de e3c7fe07-f86b-434b-aefe-c5e64eda0e36 a1fee4e3-fcbe-4d5a-8e6d-2105669d514c         
/dev/sdb4 MY-DATA  c0beb048-c9d8-4e17-a1cd-5c02096a6a38 e3c7fe07-f86b-434b-aefe-c5e64eda0e36 0137fd52-555d-4a16-8dc1-0240571f9c8b
</code></pre>
<p>where SERIAL <code>QM00001</code> and <code>QM00003</code> are much too less unique<br />
to be useful as reasonably unique disk identifiers.</p>
<p>Another possibly too less unique UUID is</p>
<pre><code>KNAME     LABEL    UUID
...
/dev/sdb2 REAR-EFI 296B-6A05
</code></pre>
<p>where <code>296B-6A05</code> does not look like a real UUID<br />
but more like some rather static default/fallback value.</p>
<p>With that I get after "rear mkbackup" in
/var/tmp/rear.XXX/rootfs/etc/rear/rescue.conf</p>
<pre><code>WRITE_PROTECTED_IDS=( 0137fd52-555d-4a16-8dc1-0240571f9c8b 296B-6A05
 5badfdc3-10eb-4f0c-a4e0-a6a5176781de QM00003 a1fee4e3-fcbe-4d5a-8e6d-2105669d514c
 c0beb048-c9d8-4e17-a1cd-5c02096a6a38 da1f0a9c-bb29-43dd-9161-0b72074c91ac
 e3c7fe07-f86b-434b-aefe-c5e64eda0e36 fc826b1b-6ed7-46d0-9f47-948cb77b4b42 )
WRITE_PROTECTED_FS_LABEL_PATTERNS=( 'MY-DATA' )
</code></pre>
<h4 id="jsmeix_commented_at_2021-11-05_1259"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2703#issuecomment-961875897">2021-11-05 12:59</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-11-05_1259" title="Permanent link">&para;</a></h4>
<p>In the ReaR recovery system on the replacement VM I have now</p>
<pre><code>RESCUE localhost:~ # lsblk -ipo KNAME,LABEL,UUID,PTUUID,PARTUUID,SERIAL,WWN /dev/sda
KNAME     LABEL    UUID                                 PTUUID                               PARTUUID                             SERIAL  WWN
/dev/sda                                                e3c7fe07-f86b-434b-aefe-c5e64eda0e36                                      QM00001 
/dev/sda1                                               e3c7fe07-f86b-434b-aefe-c5e64eda0e36 fc826b1b-6ed7-46d0-9f47-948cb77b4b42         
/dev/sda2 REAR-EFI 296B-6A05                            e3c7fe07-f86b-434b-aefe-c5e64eda0e36 da1f0a9c-bb29-43dd-9161-0b72074c91ac         
/dev/sda3 MY-BOOT  5badfdc3-10eb-4f0c-a4e0-a6a5176781de e3c7fe07-f86b-434b-aefe-c5e64eda0e36 a1fee4e3-fcbe-4d5a-8e6d-2105669d514c         
/dev/sda4 MY-DATA  c0beb048-c9d8-4e17-a1cd-5c02096a6a38 e3c7fe07-f86b-434b-aefe-c5e64eda0e36 0137fd52-555d-4a16-8dc1-0240571f9c8b

RESCUE localhost:~ # lsblk -ipo KNAME,LABEL,UUID,PTUUID,PARTUUID,SERIAL,WWN /dev/sdb
KNAME     LABEL UUID                                 PTUUID                               PARTUUID                             SERIAL  WWN
/dev/sdb                                             b87810ea-83f1-4583-a8d7-e095820e72cb                                      QM00002 
/dev/sdb1                                            b87810ea-83f1-4583-a8d7-e095820e72cb 859897f6-e166-4d07-a2a4-bd9c74fdada4         
/dev/sdb2       83a3f413-6e7d-4591-bd60-c87803613166 b87810ea-83f1-4583-a8d7-e095820e72cb b60fb4b2-0242-40fd-b152-520026504d78
</code></pre>
<p>so the SERIAL number of that exact same ReaR disk<br />
changed from <code>QM00003</code> on the original system<br />
to <code>QM00001</code> on the replacement system<br />
so for KVM/QEMU disks the SERIAL numbers<br />
are some completely useless fallback values<br />
so we cannot use them.</p>
<p>Nevertheless by luck "rear recover" just worked<br />
because the sdb SERIAL QM00002 is not one that is remembered as
write-protected.</p>
<h4 id="jsmeix_commented_at_2021-11-05_1326"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2703#issuecomment-961893408">2021-11-05 13:26</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-11-05_1326" title="Permanent link">&para;</a></h4>
<p>With latest commits "rear mkbackup" and "rear recover" work well for me.</p>
<p>I could not test WWN because the disks on my test VMs don't have a WWN
set.</p>
<h4 id="jsmeix_commented_at_2021-11-06_0830"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2703#issuecomment-962418441">2021-11-06 08:30</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-11-06_0830" title="Permanent link">&para;</a></h4>
<p>As always sleeping on an issue helps:</p>
<p>From my above experience with different behaviour what values<br />
a certain <code>lsblk</code> column can have in different storage environments<br />
I do not like the current hardcoded list of <code>lsblk</code> columns in<br />
the function write_protection_ids()</p>
<pre><code>for column in UUID PTUUID PARTUUID WWN
</code></pre>
<p>So I will add one more config variable in default.conf like</p>
<pre><code>WRITE_PROTECTED_ID_TYPES="UUID PTUUID PARTUUID WWN"
</code></pre>
<p>and then use it in write_protection_ids() like</p>
<pre><code>for column in $WRITE_PROTECTED_ID_TYPES
</code></pre>
<p>This provides final power to the user<br />
so if needed he can specify the <code>lsblk</code> columns he wants<br />
and it avoids bugs for us when UUID PTUUID PARTUUID WWN<br />
cause problems in this or that unforeseen special cases.</p>
<p>For example I have no idea how UUID PTUUID PARTUUID WWN<br />
behave for multipath (i.e. when same disks appear multiple times).<br />
Even if it is rather unlikely that someone uses a multipath disk<br />
as ReaR recovery system disk it is not impossible.<br />
I would expect that when the ReaR recovery system disk<br />
appears multiple times things "just work" because each appearance<br />
of the ReaR recovery system disk must be write-protected.<br />
But I don't know how things actually behave in practice.<br />
E.g. each appearance of the ReaR recovery system disk is
write-protected<br />
but its higher level multipath device is not write-protected and<br />
its higher level multipath device is what could get overwritten.</p>
<h4 id="jsmeix_commented_at_2021-11-08_1619"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2703#issuecomment-963320485">2021-11-08 16:19</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-11-08_1619" title="Permanent link">&para;</a></h4>
<p>Implemented
<a href="https://github.com/rear/rear/pull/2703#issuecomment-962418441">https://github.com/rear/rear/pull/2703#issuecomment-962418441</a><br />
via the recent commits.</p>
<p>The same test as above works well for me with that commits.</p>
<h4 id="jsmeix_commented_at_2021-11-09_1342"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2703#issuecomment-964162702">2021-11-09 13:42</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-11-09_1342" title="Permanent link">&para;</a></h4>
<p>Tested again with external real USB disk as ReaR disk<br />
on the above two VMs.</p>
<p>I have now on the original VM</p>
<pre><code># lsblk -ipo NAME,KNAME,MODEL,LABEL,SERIAL
NAME        KNAME     MODEL            LABEL    SERIAL
/dev/sda    /dev/sda  QEMU_HARDDISK             QM00001
|-/dev/sda1 /dev/sda1                           
`-/dev/sda2 /dev/sda2                           
/dev/sdb    /dev/sdb  QEMU_HARDDISK             QM00003
|-/dev/sdb1 /dev/sdb1                           
|-/dev/sdb2 /dev/sdb2                  REAR-EFI 
|-/dev/sdb3 /dev/sdb3                  MY-BOOT  
`-/dev/sdb4 /dev/sdb4                  MY-DATA  
/dev/sdc    /dev/sdc  External_USB_3.0          20170521000273F
|-/dev/sdc1 /dev/sdc1                           
|-/dev/sdc2 /dev/sdc2                  REAR-EFI 
|-/dev/sdc3 /dev/sdc3                  MY-BOOT  
`-/dev/sdc4 /dev/sdc4                  MY-DATA
</code></pre>
<p>I use this etc/rear/local.conf</p>
<pre><code>DISKS_TO_BE_WIPED=''
FIRMWARE_FILES=( 'no' )
MODULES=( 'loaded_modules' )
PROGRESS_MODE="plain"
PROGRESS_WAIT_SECONDS="3"
SSH_ROOT_PASSWORD="rear"
OUTPUT=USB
USB_DEVICE_FILESYSTEM_PERCENTAGE=90
USB_DEVICE_FILESYSTEM_LABEL="MY-DATA"
USB_BOOT_PART_SIZE=1024
USB_BOOTLOADER="grub"
USB_DEVICE_BOOT_LABEL="MY-BOOT"
OUTPUT_URL=usb:///dev/disk/by-label/MY-BOOT
USB_DEVICE_PARTED_LABEL=gpt
BACKUP=NETFS
BACKUP_URL=usb:///dev/disk/by-label/MY-DATA
WRITE_PROTECTED_ID_TYPES="MODEL"
WRITE_PROTECTED_IDS=( "External_USB_3.0" )
</code></pre>
<p>i.e. same as above with two added WRITE_PROTECTED_ entries<br />
to test how things work with one single different ID type.</p>
<p>"rear mkbackup" (excerpts)</p>
<pre><code># usr/sbin/rear -D mkbackup
...
USB disk IDs of '/dev/disk/by-label/MY-DATA' added to WRITE_PROTECTED_IDS
File system label of '/dev/disk/by-label/MY-DATA' added to WRITE_PROTECTED_FS_LABEL_PATTERNS
</code></pre>
<p>After "rear -D mkbackup" I got now (excerpt)</p>
<pre><code># cat /var/tmp/rear.7iI69pq3OvRqLyc/rootfs/etc/rear/rescue.conf
...
WRITE_PROTECTED_IDS=( External_USB_3.0 External_USB_3.0 )
WRITE_PROTECTED_FS_LABEL_PATTERNS=( 'MY-DATA' )
...
</code></pre>
<p>The duplicate <code>External_USB_3.0</code> comes from my setting in local.conf<br />
plus the automated addition by
prep/USB/default/480_initialize_write_protect_settings.sh<br />
but duplicated IDs in WRITE_PROTECTED_IDS don't matter.</p>
<p>The WRITE_PROTECTED_FS_LABEL_PATTERNS=( 'MY-DATA' )<br />
which comes from /dev/sdc4 will also write-protect /dev/sda<br />
on the replacement VM by luck because there 'MY-DATA'<br />
is also used on /dev/sda4 - see the following:</p>
<p>On the replacement VM I have</p>
<pre><code>RESCUE localhost:~ # lsblk -ipo NAME,KNAME,MODEL,LABEL,SERIAL
NAME        KNAME     MODEL            LABEL    SERIAL
/dev/sda    /dev/sda  QEMU_HARDDISK             QM00001
|-/dev/sda1 /dev/sda1                           
|-/dev/sda2 /dev/sda2                  REAR-EFI 
|-/dev/sda3 /dev/sda3                  MY-BOOT  
`-/dev/sda4 /dev/sda4                  MY-DATA  
/dev/sdb    /dev/sdb  QEMU_HARDDISK             QM00002
|-/dev/sdb1 /dev/sdb1                           
`-/dev/sdb2 /dev/sdb2                           
/dev/sdc    /dev/sdc  External_USB_3.0          20170521000273F
|-/dev/sdc1 /dev/sdc1                           
|-/dev/sdc2 /dev/sdc2                  REAR-EFI 
|-/dev/sdc3 /dev/sdc3                  MY-BOOT  
`-/dev/sdc4 /dev/sdc4                  MY-DATA

RESCUE localhost:~ # rear -D recover
...
Comparing disks
Device sda is designated as write-protected (needs manual configuration)
Switching to manual disk layout configuration
Cannot use /dev/sda (same name and same size) for recreating /dev/sda (/dev/sda is write-protected)
Could not automap /dev/sda (no disk with same size 8589934592 found)
Original disk /dev/sda does not exist (with same size) in the target system
Using /dev/sdb (the only available of the disks) for recreating /dev/sda
Current disk mapping table (source =&gt; target):
  /dev/sda =&gt; /dev/sdb
</code></pre>
<p>The "rear recover" log shows the write-protection test results</p>
<pre><code>RESCUE localhost:~ # grep '^2021.* write-protected' /var/log/rear/rear-localhost.log
2021-11-09 14:14:17.231764721 /dev/sda is not write-protected by ID
2021-11-09 14:14:17.240623355 /dev/sda is designated as write-protected, its label 'MY-DATA' matches 'MY-DATA'
2021-11-09 14:14:17.261690422 /dev/sdb is not write-protected by ID
2021-11-09 14:14:17.269836792 /dev/sdb is not write-protected by file system label
2021-11-09 14:14:17.293289865 /dev/sdc is designated as write-protected by ID External_USB_3.0
2021-11-09 14:14:17.328838709 /dev/sda is not write-protected by ID
2021-11-09 14:14:17.338716114 /dev/sda is designated as write-protected, its label 'MY-DATA' matches 'MY-DATA'
2021-11-09 14:14:17.342630182 Device sda is designated as write-protected (needs manual configuration)
2021-11-09 14:14:17.448098582 /dev/sda is not write-protected by ID
2021-11-09 14:14:17.456840183 /dev/sda is designated as write-protected, its label 'MY-DATA' matches 'MY-DATA'
2021-11-09 14:14:17.460422624 Cannot use /dev/sda (same name and same size) for recreating /dev/sda (/dev/sda is write-protected)
2021-11-09 14:14:17.518655279 /dev/sda is not write-protected by ID
2021-11-09 14:14:17.527663776 /dev/sda is designated as write-protected, its label 'MY-DATA' matches 'MY-DATA'
2021-11-09 14:14:17.531242534 /dev/sda excluded from device mapping choices (is designated as write-protected)
2021-11-09 14:14:17.555084512 /dev/sdb is not write-protected by ID
2021-11-09 14:14:17.563664684 /dev/sdb is not write-protected by file system label
2021-11-09 14:14:17.587401855 /dev/sdc is designated as write-protected by ID External_USB_3.0
2021-11-09 14:14:17.591366414 /dev/sdc excluded from device mapping choices (is designated as write-protected)
</code></pre>
<p>So a different ID type also works well for me.</p>
<h4 id="jsmeix_commented_at_2021-11-09_1343"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2703#issuecomment-964163070">2021-11-09 13:42</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-11-09_1343" title="Permanent link">&para;</a></h4>
<p>If there are no objections I would like to merge it tomorrow afternoon.</p>
<h4 id="jsmeix_commented_at_2021-11-10_1232"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2703#issuecomment-965088175">2021-11-10 12:32</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-11-10_1232" title="Permanent link">&para;</a></h4>
<p>I did one more test on the above two VMs<br />
but without external real USB disk as ReaR disk.</p>
<p>Now I have in local.conf only</p>
<pre><code>WRITE_PROTECTED_ID_TYPES="PTUUID"
</code></pre>
<p>but no WRITE_PROTECTED_IDS.</p>
<p>This results basically the same behaviour as before this pull request<br />
where only PTUUID was used as ID.</p>
<p>After "rear mkbackup" I have</p>
<pre><code># cat /var/tmp/rear.n6Yn1A9hsPcm7E2/rootfs/etc/rear/rescue.conf
...
WRITE_PROTECTED_IDS=( e3c7fe07-f86b-434b-aefe-c5e64eda0e36 )
WRITE_PROTECTED_FS_LABEL_PATTERNS=( 'MY-DATA' )
...

# lsblk -ipo NAME,LABEL,UUID,PTUUID,PARTUUID /dev/sdb
NAME        LABEL    UUID                                 PTUUID                               PARTUUID
/dev/sdb                                                  e3c7fe07-f86b-434b-aefe-c5e64eda0e36 
|-/dev/sdb1                                               e3c7fe07-f86b-434b-aefe-c5e64eda0e36 fc826b1b-6ed7-46d0-9f47-948cb77b4b42
|-/dev/sdb2 REAR-EFI 296B-6A05                            e3c7fe07-f86b-434b-aefe-c5e64eda0e36 da1f0a9c-bb29-43dd-9161-0b72074c91ac
|-/dev/sdb3 MY-BOOT  5badfdc3-10eb-4f0c-a4e0-a6a5176781de e3c7fe07-f86b-434b-aefe-c5e64eda0e36 a1fee4e3-fcbe-4d5a-8e6d-2105669d514c
`-/dev/sdb4 MY-DATA  c0beb048-c9d8-4e17-a1cd-5c02096a6a38 e3c7fe07-f86b-434b-aefe-c5e64eda0e36 0137fd52-555d-4a16-8dc1-0240571f9c8b
</code></pre>
<p>During "rear recover" I get on the terminal</p>
<pre><code>Comparing disks
Device sda is designated as write-protected (needs manual configuration)
Switching to manual disk layout configuration
Cannot use /dev/sda (same name and same size) for recreating /dev/sda (/dev/sda is write-protected)
Could not automap /dev/sda (no disk with same size 8589934592 found)
Original disk /dev/sda does not exist (with same size) in the target system
Using /dev/sdb (the only available of the disks) for recreating /dev/sda
Current disk mapping table (source =&gt; target):
  /dev/sda =&gt; /dev/sdb
</code></pre>
<p>and the recovery log shows</p>
<pre><code>RESCUE localhost:~ # grep '^2021.* write-protected' /var/log/rear/rear-localhost.log
2021-11-10 13:19:06.123714730 /dev/sda is designated as write-protected by ID e3c7fe07-f86b-434b-aefe-c5e64eda0e36
2021-11-10 13:19:06.153061505 /dev/sdb is not write-protected by ID
2021-11-10 13:19:06.163243663 /dev/sdb is not write-protected by file system label
2021-11-10 13:19:06.211360274 /dev/sda is designated as write-protected by ID e3c7fe07-f86b-434b-aefe-c5e64eda0e36
2021-11-10 13:19:06.215985676 Device sda is designated as write-protected (needs manual configuration)
2021-11-10 13:19:06.356062734 /dev/sda is designated as write-protected by ID e3c7fe07-f86b-434b-aefe-c5e64eda0e36
2021-11-10 13:19:06.360857672 Cannot use /dev/sda (same name and same size) for recreating /dev/sda (/dev/sda is write-protected)
2021-11-10 13:19:06.439972367 /dev/sda is designated as write-protected by ID e3c7fe07-f86b-434b-aefe-c5e64eda0e36
2021-11-10 13:19:06.444778534 /dev/sda excluded from device mapping choices (is designated as write-protected)
2021-11-10 13:19:06.475940197 /dev/sdb is not write-protected by ID
2021-11-10 13:19:06.485878743 /dev/sdb is not write-protected by file system label
</code></pre>
<h4 id="jsmeix_commented_at_2021-11-26_1202"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/2703#issuecomment-979928423">2021-11-26 12:02</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-11-26_1202" title="Permanent link">&para;</a></h4>
<p>I think we need further enhanced disk write-protection<br />
for the disks in DISKS_TO_BE_WIPED<br />
see how that currently works<br />
<a href="https://github.com/rear/rear/pull/2714/commits/0cb21299efea81900285a8f224e0a0c6a20160e5">https://github.com/rear/rear/pull/2714/commits/0cb21299efea81900285a8f224e0a0c6a20160e5</a></p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2023 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2021-10-27.2703.pr.merged.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
