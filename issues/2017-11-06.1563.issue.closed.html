<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#1563 Issue closed: 'EFI System Partition' name restoration fails (blanks in value) - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#1563 Issue closed: \u0027EFI System Partition\u0027 name restoration fails (blanks in value)";
        var mkdocs_page_input_path = "issues/2017-11-06.1563.issue.closed.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/backup_netfs.html">Example of BACKUP=NETFS</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../development/squash-git-log-commments.html">How to squash git log comments into one line</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear29.html">Release Notes ReaR 2.9</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear28.html">Release Notes ReaR 2.8</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#1563 Issue closed: 'EFI System Partition' name restoration fails (blanks in value)</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="1563_issue_closed_efi_system_partition_name_restoration_fails_blanks_in_value"><a href="https://github.com/rear/rear/issues/1563">#1563 Issue</a> <code>closed</code>: 'EFI System Partition' name restoration fails (blanks in value)<a class="headerlink" href="#1563_issue_closed_efi_system_partition_name_restoration_fails_blanks_in_value" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>bug</code>, <code>cleanup</code>, <code>fixed / solved / done</code></p>
<h4 id="marcos80_opened_issue_at_2017-11-06_0913"><img src="https://avatars.githubusercontent.com/u/33414417?v=4" width="50"><a href="https://github.com/MarcoS80">MarcoS80</a> opened issue at <a href="https://github.com/rear/rear/issues/1563">2017-11-06 09:13</a>:<a class="headerlink" href="#marcos80_opened_issue_at_2017-11-06_0913" title="Permanent link">&para;</a></h4>
<h4 id="relax-and-recover_rear_issue_template">Relax-and-Recover (ReaR) Issue Template<a class="headerlink" href="#relax-and-recover_rear_issue_template" title="Permanent link">&para;</a></h4>
<p>Fill in the following items before submitting a new issue<br />
(quick response is not guaranteed with free support):</p>
<ul>
<li>rear version (/usr/sbin/rear -V): Relax-and-Recover
    2.2-git.0.b7927e5.unknown.changed / 2017-10-31</li>
<li>OS version (cat /etc/rear/os.conf or lsb_release -a):
    Ubuntu/17.04/i386</li>
<li>rear configuration files (cat /etc/rear/site.conf or cat
    /etc/rear/local.conf):</li>
</ul>
<pre>
OUTPUT=ISO
BACKUP=NETFS
BACKUP_URL=iso:///backup
ISO_VOLID="REARISO"
OUTPUT_URL=file:///tmp
MODULES=( 'all_modules' )
</pre>

<ul>
<li>
<p>Are you using legacy BIOS or UEFI boot? UEFI</p>
</li>
<li>
<p>Brief description of the issue:<br />
    The EFI System Partition cannot be created correctly because the
    name "EFI System Partition" does not have double quotes.</p>
</li>
<li>
<p>Work-around, if any:<br />
    In:<br />
    /usr/share/rear/layout/prepare/GNU/Linux/100_include_partition_code.sh<br />
    the command:</p>
</li>
</ul>
<pre>
parted -s $device mkpart '$name' ${start}B $end >&2
</pre>

<p>at lines 190 and 203, should be:</p>
<pre>
parted -s $device mkpart '"$name"' ${start}B $end >&2
</pre>

<p>whereas the command:</p>
<pre>
echo "parted -s $device name $number '$name' >&2"
</pre>

<p>at line 246 should be:</p>
<pre>
echo "parted -s $device name $number '\"$name\"' >&2"
</pre>

<h4 id="gozora_commented_at_2017-11-06_1613"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/1563#issuecomment-342198448">2017-11-06 16:13</a>:<a class="headerlink" href="#gozora_commented_at_2017-11-06_1613" title="Permanent link">&para;</a></h4>
<p>@jsmeix as you are the master in (among other things) quoting, what is
your opinion here ?<br />
@MarcoS80 could you create pull request for changes mentioned above?</p>
<p>Thanks</p>
<p>V.</p>
<h4 id="jsmeix_commented_at_2017-11-07_1054"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1563#issuecomment-342446715">2017-11-07 10:54</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-11-07_1054" title="Permanent link">&para;</a></h4>
<p>@gozora<br />
yesterday I had a quick look at that code<br />
but I do not yet fully understand what goes on.</p>
<p>In particular I do not understand how those values<br />
could contain blanks (so that special quoting is needed).</p>
<p>I fear a plain wrong value gets used here - I mean<br />
a value that is not meant for that parted parameters.</p>
<p>Because the values in a disklayout.conf line are positional values<br />
a missing value (e.g. when one is empty) lead to false<br />
positional values in a disklayout.conf line which results that<br />
wrong values get used for certain parted parameters<br />
and that shows up as weird errors at unexpected places.</p>
<p>But currently I have no time for a deeper analysis<br />
what actually goes wrong here - be patient...</p>
<h4 id="rmetrich_commented_at_2018-01-19_1327"><img src="https://avatars.githubusercontent.com/u/1163635?u=36b5e32e1dd55f1ce77cad431a5683fce40a7934&v=4" width="50"><a href="https://github.com/rmetrich">rmetrich</a> commented at <a href="https://github.com/rear/rear/issues/1563#issuecomment-358965623">2018-01-19 13:27</a>:<a class="headerlink" href="#rmetrich_commented_at_2018-01-19_1327" title="Permanent link">&para;</a></h4>
<p>I hit the issue as well.<br />
Commit<br />
<a href="https://github.com/rear/rear/commit/2540c7a2319791b58fa2b9c87fdefbe3c5341b4c">https://github.com/rear/rear/commit/2540c7a2319791b58fa2b9c87fdefbe3c5341b4c</a><br />
removed the double-quote from the following lines:</p>
<pre><code>-parted -s $device mkpart '"$name"' ${start}B $end &gt;&amp;2
+parted -s $device mkpart '$name' ${start}B $end &gt;&amp;2
</code></pre>
<p>and</p>
<pre><code>-parted -s $device mkpart '"$name"' $start_mb $end_mb &gt;&amp;2
+parted -s $device mkpart '$name' $start_mb $end_mb &gt;&amp;2
</code></pre>
<p>which is wrong. This is needed for the UEFI partition which is usually
named "EFI System Partition".<br />
<strong>parted</strong> is likely not parsing arguments correctly:</p>
<ul>
<li>parted -s /dev/sda mkpart "EFI System Partition" ... fails</li>
<li>parted -s /dev/sda mkpart 'EFI System Partition' ... fails</li>
<li>parted -s /dev/sda mkpart EFI\ System\ Partition ... fails</li>
</ul>
<h4 id="jsmeix_commented_at_2018-01-23_1058"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1563#issuecomment-359755054">2018-01-23 10:58</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-01-23_1058" title="Permanent link">&para;</a></h4>
<p>@rmetrich<br />
additionally I wonder about when the $name variable gets evaluated<br />
compared to when the $device variable gets evaluated<br />
because there is a difference between</p>
<pre>
"'$var'"
</pre>

<p>and</p>
<pre>
'"$var"'
</pre>

<p>as in the following example</p>
<pre>
# device="/dev/sdX"

# name="EFI System Partition"

# echo parted -s $device mkpart '$name'
parted -s /dev/sdX mkpart $name

# echo parted -s $device mkpart "'$name'"
parted -s /dev/sdX mkpart 'EFI System Partition'

# echo parted -s $device mkpart '"$name"'
parted -s /dev/sdX mkpart "$name"
</pre>

<h4 id="jsmeix_commented_at_2018-01-23_1102"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1563#issuecomment-359756160">2018-01-23 11:02</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-01-23_1102" title="Permanent link">&para;</a></h4>
<p>@OliverO2<br />
what was the reason behind why you changed the quoting of the $name
variable in your<br />
<a href="https://github.com/rear/rear/commit/2540c7a2319791b58fa2b9c87fdefbe3c5341b4c">https://github.com/rear/rear/commit/2540c7a2319791b58fa2b9c87fdefbe3c5341b4c</a></p>
<h4 id="jsmeix_commented_at_2018-01-23_1110"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1563#issuecomment-359758005">2018-01-23 11:10</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-01-23_1110" title="Permanent link">&para;</a></h4>
<p>@rmetrich<br />
forget my above
<a href="https://github.com/rear/rear/issues/1563#issuecomment-359755054">https://github.com/rear/rear/issues/1563#issuecomment-359755054</a><br />
I overlooked the outer "..." quotation so that actually<br />
it was before</p>
<pre>
# echo "parted -s $device mkpart '"$name"' ..."
parted -s /dev/sdX mkpart 'EFI System Partition' ...
</pre>

<p>versus now</p>
<pre>
# echo "parted -s $device mkpart '$name' ..."
parted -s /dev/sdX mkpart 'EFI System Partition' ...
</pre>

<p>but I do not see a difference in the echo output?</p>
<h4 id="jsmeix_commented_at_2018-01-23_1144"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1563#issuecomment-359765522">2018-01-23 11:44</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-01-23_1144" title="Permanent link">&para;</a></h4>
<p>As I wrote in
<a href="https://github.com/rear/rear/issues/1563#issuecomment-342446715">https://github.com/rear/rear/issues/1563#issuecomment-342446715</a><br />
I cannot imagine how partition names with blanks could work at all
because<br />
as far as I see in
layout/prepare/GNU/Linux/100_include_partition_code.sh<br />
the code is basically as follows:</p>
<pre>
create_partitions() {
...
    while read part disk size pstart name flags partition junk; do
...
            cat >> "$LAYOUT_CODE" &lt;&lt;EOF
my_udevsettle
parted -s $device mkpart '$name' ${start}B $end >&2
my_udevsettle
EOF
...
    done &lt; &lt;(grep "^part $device " $LAYOUT_FILE)
...
}
</pre>

<p>For me name values with blanks (even if quoted) in disklayout.conf<br />
cause wrong reading and therefore wrong variable assignments<br />
when I use a disklayout.conf with name values with blanks as in</p>
<pre>
# grep ^part disklayout.conf
part /dev/sda 14173601792 1048576 partition_name1 none /dev/sda1
part /dev/sda 1048576 14174650368 partition name2 bios_grub /dev/sda2
part /dev/sda 2147483648 14175698944 'partition name3' swap /dev/sda3
part /dev/sda 5151636992 16323182592 "partition name4" none /dev/sda4

# while read part disk size pstart name flags partition junk ; do echo "'$part' '$disk' '$size' '$pstart' name='$name' flags='$flags' partition='$partition' junk='$junk'" ; done &lt; &lt;(grep "^part /dev/sda " disklayout.conf)
'part' '/dev/sda' '14173601792' '1048576' name='partition_name1' flags='none' partition='/dev/sda1' junk=''
'part' '/dev/sda' '1048576' '14174650368' name='partition' flags='name2' partition='bios_grub' junk='/dev/sda2'
'part' '/dev/sda' '2147483648' '14175698944' name=''partition' flags='name3'' partition='swap' junk='/dev/sda3'
'part' '/dev/sda' '5151636992' '16323182592' name='"partition' flags='name4"' partition='none' junk='/dev/sda4'
</pre>

<p>The only one that works is partition_name1 which does not contian a
character from $IFS<br />
cf.
<a href="https://github.com/rear/rear/issues/1372">https://github.com/rear/rear/issues/1372</a></p>
<h4 id="rmetrich_commented_at_2018-01-23_1148"><img src="https://avatars.githubusercontent.com/u/1163635?u=36b5e32e1dd55f1ce77cad431a5683fce40a7934&v=4" width="50"><a href="https://github.com/rmetrich">rmetrich</a> commented at <a href="https://github.com/rear/rear/issues/1563#issuecomment-359766458">2018-01-23 11:48</a>:<a class="headerlink" href="#rmetrich_commented_at_2018-01-23_1148" title="Permanent link">&para;</a></h4>
<p>@jsmeix There is encoding of partitions with space in their name:</p>
<p>usr/share/rear/layout/save/GNU/Linux/200_partition_layout.sh<br />
<code>type=$(echo "$type" | sed -e 's/ /0x20/g') # replace spaces with 0x20 in name field</code></p>
<h4 id="jsmeix_commented_at_2018-01-23_1215"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1563#issuecomment-359772584">2018-01-23 12:15</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-01-23_1215" title="Permanent link">&para;</a></h4>
<p>@rmetrich<br />
thanks to point that out!</p>
<p>In
usr/share/rear/layout/prepare/GNU/Linux/100_include_partition_code.sh<br />
there is the counterpart</p>
<pre>
        # The 'name' could contain spaces (were replaced with 0%20; need to change this again).
        name=$(echo "$name" | sed -e 's/0x20/ /g')
</pre>

<p>which was implemented by @gdha via<br />
<a href="https://github.com/rear/rear/commit/963dfd7a3968e1506830b42deb88b5f04eaa5e38">https://github.com/rear/rear/commit/963dfd7a3968e1506830b42deb88b5f04eaa5e38</a></p>
<h4 id="jsmeix_commented_at_2018-01-23_1223"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1563#issuecomment-359774531">2018-01-23 12:23</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-01-23_1223" title="Permanent link">&para;</a></h4>
<p>Unbelievable!<br />
Duplicated quoting as in</p>
<pre>
parted -s /dev/sdb unit MiB mkpart '"part name 4"' 7 8
</pre>

<p>and also the other way round via</p>
<pre>
parted -s /dev/sdb unit MiB mkpart "'part name 5'" 9 10
</pre>

<p>seem to be the only way how to make parted work,cf.<br />
<a href="https://github.com/rear/rear/commit/316b5f8d5aa5bb96b8aa037266912a59e6cda046">https://github.com/rear/rear/commit/316b5f8d5aa5bb96b8aa037266912a59e6cda046</a></p>
<h4 id="jsmeix_commented_at_2018-01-23_1232"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1563#issuecomment-359776628">2018-01-23 12:32</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-01-23_1232" title="Permanent link">&para;</a></h4>
<p>I will do a pull request to fix it again and <em>explain</em> it in the code.</p>
<h4 id="rmetrich_commented_at_2018-01-23_1244"><img src="https://avatars.githubusercontent.com/u/1163635?u=36b5e32e1dd55f1ce77cad431a5683fce40a7934&v=4" width="50"><a href="https://github.com/rmetrich">rmetrich</a> commented at <a href="https://github.com/rear/rear/issues/1563#issuecomment-359779454">2018-01-23 12:44</a>:<a class="headerlink" href="#rmetrich_commented_at_2018-01-23_1244" title="Permanent link">&para;</a></h4>
<p>Indeed, there is likely a big issue with parted command-line parsing ...</p>
<h4 id="jsmeix_commented_at_2018-01-23_1257"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1563#issuecomment-359782344">2018-01-23 12:57</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-01-23_1257" title="Permanent link">&para;</a></h4>
<p>Unfortunately the parted manual is very silent about quoting.<br />
In<br />
<a href="https://www.gnu.org/software/parted/manual/parted.html">https://www.gnu.org/software/parted/manual/parted.html</a><br />
the only place is</p>
<pre>
Command: name number name

Sets the name for the partition number (GPT, Mac, MIPS and PC98 only).
The name can be placed in quotes.

Example:
   (parted) name 2 'Secret Documents'

Set the name of partition 2 to ‘Secret Documents’. 
</pre>

<p>As far as I understand it this means parted's internal parser<br />
supports single quotes for values with blanks.</p>
<p>When calling parted on the command line it seems<br />
there is a bug in parted that it does not handle a<br />
command line argument argv[N] that contains blanks<br />
as a single value with single quotes for its internal parser.</p>
<p>It seems when calling parted on the command line all<br />
command line arguments get sent to its internal parser<br />
as a single string of all command line arguments.</p>
<p>In this case it explains why when calling parted on the command line<br />
a value with blanks must be provided with duplicated quoting<br />
to get it with the inner quoting caracters to parted's parser<br />
i.e. in the form like in the above example</p>
<pre>
parted -s /dev/sdb unit MiB mkpart "'part name 5'" 9 10
</pre>

<p>to get 'part name 5' to parted's parser.</p>
<h4 id="rmetrich_commented_at_2018-01-23_1300"><img src="https://avatars.githubusercontent.com/u/1163635?u=36b5e32e1dd55f1ce77cad431a5683fce40a7934&v=4" width="50"><a href="https://github.com/rmetrich">rmetrich</a> commented at <a href="https://github.com/rear/rear/issues/1563#issuecomment-359783107">2018-01-23 13:00</a>:<a class="headerlink" href="#rmetrich_commented_at_2018-01-23_1300" title="Permanent link">&para;</a></h4>
<p>Just tried <code>parted name 2 'Secret Documents'</code> and it doesn't work ...</p>
<h4 id="jsmeix_commented_at_2018-01-23_1304"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1563#issuecomment-359784102">2018-01-23 13:04</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-01-23_1304" title="Permanent link">&para;</a></h4>
<p>When you call plain 'parted' and then use it interactively<br />
single quotes work because then you talk directly<br />
to parted's parser:</p>
<pre>
# parted /dev/sdb
GNU Parted 3.2
Using /dev/sdb
Welcome to GNU Parted! Type 'help' to view a list of commands.
(parted) unit MiB mkpart 'part name 6' 11 12
</pre>

<p>In contrast when you call a whole parted command on command line<br />
you need duplicated quoting, the outer quoting for bash, the inner<br />
quoting for parted's internal parser:</p>
<pre>
# parted -s /dev/sdb unit MiB mkpart "'part name 7'" 13 14
</pre>

<h4 id="olivero2_commented_at_2018-01-23_1332"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/issues/1563#issuecomment-359791359">2018-01-23 13:32</a>:<a class="headerlink" href="#olivero2_commented_at_2018-01-23_1332" title="Permanent link">&para;</a></h4>
<p>@jsmeix</p>
<blockquote>
<p>what was the reason behind why you changed the quoting of the $name
variable in your<br />
2540c7a</p>
</blockquote>
<p>It was just a cleanup. Of course I don't know now what I was really
thinking at the time but I guess I was just surprised by the unusual
double quoting. In addition I might have overlooked that the lines
affected were inside a here document:</p>
<p>Here's a little test:</p>
<pre><code>#!/usr/bin/env bash

device='/dev/xd1'
name='EFI System Partition'
start=1024
end=4096

echo "Outside of here document:"
echo '#1' parted -s $device mkpart "$name" ${start}B $end &gt;&amp;2
echo '#2' parted -s $device mkpart '"$name"' ${start}B $end &gt;&amp;2

echo "Inside a here document:"
cat &lt;&lt;EOF | bash
echo '#1' parted -s $device mkpart "$name" ${start}B $end &gt;&amp;2
echo '#2' parted -s $device mkpart '"$name"' ${start}B $end &gt;&amp;2
EOF
</code></pre>
<p>Output is:</p>
<pre><code>Outside of here document:
#1 parted -s /dev/xd1 mkpart EFI System Partition 1024B 4096
#2 parted -s /dev/xd1 mkpart "$name" 1024B 4096
Inside a here document:
#1 parted -s /dev/xd1 mkpart EFI System Partition 1024B 4096
#2 parted -s /dev/xd1 mkpart "EFI System Partition" 1024B 4096
</code></pre>
<p>Your analysis seems absolutely plausible. Parted obviously has some
strange quoting requirements which would be expected with the MS-DOS
command interpreter but not here. Parted really should do the necessary
translations from arguments internally. (Parted has
<a href="https://www.jethrocarr.com/2012/08/10/gdisk-oh-glorious-gdisk/">other</a>
<a href="https://www.weisskunst.de/dr/node/60">issues</a> as well.)</p>
<p>So in a nutshell, my quoting changes for the parted calls should be
reverted. Parted would then be called as before with its partition name
argument enclosed in double quotes which are not stripped by the shell.</p>
<h4 id="jsmeix_commented_at_2018-01-23_1357"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1563#issuecomment-359797990">2018-01-23 13:57</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-01-23_1357" title="Permanent link">&para;</a></h4>
<p>I am thinking about a more fail-safe way how to encode<br />
possible $IFS characters (like spaces) in a GPT partition name<br />
because the current ' ' -&gt; '0x20' -&gt; ' ' re-replacement breaks<br />
when a partition name already contains the (sub)string '0x20'.</p>
<p>In<br />
<a href="http://download.intel.com/support/motherboards/server/sb/gpt_white_paper_1_1.pdf">http://download.intel.com/support/motherboards/server/sb/gpt_white_paper_1_1.pdf</a><br />
and also in<br />
<a href="http://www.jonrajewski.com/data/Presentations/CEIC2013/Partition_Table_Documentation_Compressed.pdf">http://www.jonrajewski.com/data/Presentations/CEIC2013/Partition_Table_Documentation_Compressed.pdf</a><br />
I found</p>
<pre>
Each GPT partition has a 36-character Unicode name

GPT allows for each partition to have a 36 character Unicode name
</pre>

<p>which looks scaring because Unicode is no character encoding<br />
(but e.g. UTF-8 would be a character encoding for Unicode)<br />
so that currently I do not know what byte values are valid<br />
for a GPT partition name (I guess UTF-8 would be valid).</p>
<h4 id="jsmeix_commented_at_2018-01-23_1413"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1563#issuecomment-359802651">2018-01-23 14:13</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-01-23_1413" title="Permanent link">&para;</a></h4>
<p>In<br />
<a href="https://askubuntu.com/questions/53770/how-can-i-encode-and-decode-percent-encoded-strings-on-the-command-line">https://askubuntu.com/questions/53770/how-can-i-encode-and-decode-percent-encoded-strings-on-the-command-line</a><br />
I found the bash functions</p>
<pre>
urlencode() {
    # urlencode <string>
    local length="${#1}"
    for (( i = 0; i < length; i++ )); do
        local c="${1:i:1}"
        case $c in
            [a-zA-Z0-9.~_-]) printf "$c" ;;
            *) printf '%%%02X' "'$c"
        esac
    done
}

urldecode() {
    # urldecode <string>
    local url_encoded="${1//+/ }"
    printf '%b' "${url_encoded//%/\\x}"
}
</pre>

<p>which look promising at least for ASCII strings<br />
(I did not yet test UTF-8 strings).</p>
<h4 id="olivero2_commented_at_2018-01-23_1414"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/issues/1563#issuecomment-359802893">2018-01-23 14:14</a>:<a class="headerlink" href="#olivero2_commented_at_2018-01-23_1414" title="Permanent link">&para;</a></h4>
<p><a href="https://en.wikipedia.org/wiki/GUID_Partition_Table">GUID Partition Table -
Wikipedia</a> says:</p>
<blockquote>
<p>Partition name (36 UTF-16LE code units)</p>
</blockquote>
<p>What about simply using the <code>&amp;nbsp;</code> HTML entity to encode spaces? If
someone had a partition name containing the <code>&amp;nbsp;</code> sequence it
probably happened by mistake anyway. In contrast <code>0x20</code> could appear as
part of something like <code>P10x200G</code>.</p>
<h4 id="olivero2_commented_at_2018-01-23_1426"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/issues/1563#issuecomment-359806641">2018-01-23 14:26</a>:<a class="headerlink" href="#olivero2_commented_at_2018-01-23_1426" title="Permanent link">&para;</a></h4>
<p>And another thought: There is probably no need to be concerned about
GPT-internal encodings. I'd expect command line tools such as <code>parted</code>
and <code>gdisk</code> to accept arguments in the current locale's encoding and do
necessary translations internally. Anything else would seem like a bug
to me.</p>
<h4 id="jsmeix_commented_at_2018-01-23_1527"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1563#issuecomment-359825855">2018-01-23 15:27</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-01-23_1527" title="Permanent link">&para;</a></h4>
<p>For the fun of it:<br />
ReaR's current locale is always POSIX/C, see /usr/sbin/rear</p>
<pre>
# make sure that we use only english
export LC_CTYPE=C LC_ALL=C LANG=C
</pre>

<p>so that any non-ASCII characters could lead to "interesing effects",<br />
cf. "Character encoding" in<br />
<a href="https://github.com/rear/rear/wiki/Coding-Style">https://github.com/rear/rear/wiki/Coding-Style</a><br />
and see<br />
<a href="https://en.opensuse.org/SDB:Plain_Text_versus_Locale">https://en.opensuse.org/SDB:Plain_Text_versus_Locale</a><br />
;-)</p>
<p>FWIW:<br />
This issue here is also about working around a bug<br />
in parted when it parses command line arguments<br />
but that's what ReaR must do,<br />
cf. "Dirty hacks welcome" in<br />
<a href="https://github.com/rear/rear/wiki/Coding-Style">https://github.com/rear/rear/wiki/Coding-Style</a></p>
<h4 id="jsmeix_commented_at_2018-01-24_1537"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1563#issuecomment-360173845">2018-01-24 15:37</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-01-24_1537" title="Permanent link">&para;</a></h4>
<p>I did the pull request
<a href="https://github.com/rear/rear/pull/1706">https://github.com/rear/rear/pull/1706</a><br />
regardless that it is not yet tested so that you could have an early
look.</p>
<h4 id="jsmeix_commented_at_2018-01-25_1030"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1563#issuecomment-360426188">2018-01-25 10:30</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-01-25_1030" title="Permanent link">&para;</a></h4>
<p>FWIW:</p>
<p>On SLES10 with GNU Parted 1.6.25.1<br />
parted does not support providing a GPT partition name<br />
directly in the mkpart command.</p>
<p>With GNU Parted 1.6.25.1 one must do it via a separated 'name' command<br />
as follows:</p>
<pre>
# parted -s /dev/hdc mklabel gpt

# parted -s /dev/hdc mkpart primary 10 20

# parted -s /dev/hdc print
Disk geometry for /dev/hdc: 0kB - 2147MB
Disk label type: gpt
Number  Start   End     Size    File system  Name                  Flags
1       10MB    20MB    10MB                                       

# parted -s /dev/hdc name 1 "'my first partition'"

# parted -s /dev/hdc print
Disk geometry for /dev/hdc: 0kB - 2147MB
Disk label type: gpt
Number  Start   End     Size    File system  Name                  Flags
1       10MB    20MB    10MB                 my first partition    
</pre>

<h4 id="jsmeix_commented_at_2018-01-25_1059"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1563#issuecomment-360433522">2018-01-25 10:59</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-01-25_1059" title="Permanent link">&para;</a></h4>
<p>On SLES11 SP4 with GNU parted 2.3 it works<br />
to provide a GPT partition name directly in the mkpart command:</p>
<pre>
# parted -s /dev/sdb mklabel gpt

# parted -s /dev/sdb unit MiB print
Model: ATA QEMU HARDDISK (scsi)
Disk /dev/sdb: 2048MiB
Sector size (logical/physical): 512B/512B
Partition Table: gpt
Number  Start  End  Size  File system  Name  Flags

# parted -s /dev/sdb unit MiB mkpart "'my first partition'" 10 20

# parted -s /dev/sdb unit MiB print
Model: ATA QEMU HARDDISK (scsi)
Disk /dev/sdb: 2048MiB
Sector size (logical/physical): 512B/512B
Partition Table: gpt

Number  Start    End      Size     File system  Name                Flags
 1      10.0MiB  20.0MiB  10.0MiB               my first partition
</pre>

<h4 id="jsmeix_commented_at_2018-01-26_1531"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1563#issuecomment-360816342">2018-01-26 15:31</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-01-26_1531" title="Permanent link">&para;</a></h4>
<p>With
<a href="https://github.com/rear/rear/pull/1706">https://github.com/rear/rear/pull/1706</a>
merged<br />
this issue should be fixed to a currently reasonable extent<br />
which means: Currently it fails for UTF-8 encoded strings<br />
so that UTF-8 encoded GPT partition names<br />
are not (yet?) supported.</p>
<h4 id="jsmeix_commented_at_2018-01-26_1552"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1563#issuecomment-360822610">2018-01-26 15:52</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-01-26_1552" title="Permanent link">&para;</a></h4>
<p>@OliverO2<br />
regarding your<br />
<a href="https://github.com/rear/rear/issues/1563#issuecomment-359806641">https://github.com/rear/rear/issues/1563#issuecomment-359806641</a><br />
and how UTF-8 stuff fails when the "current locale" is POSIX/C see<br />
<a href="https://github.com/rear/rear/pull/1706#issuecomment-360820779">https://github.com/rear/rear/pull/1706#issuecomment-360820779</a><br />
therein in particular</p>
<pre>
+++ parted -s /dev/sdb mkpart ''\''UTF-8 name bin&lt;C3>&lt;A4>r'\''' 12587008B 23072767B
Error during translation: Invalid or incomplete multibyte or wide character
</pre>

<p>Have fun with locales!<br />
Cf.<br />
<a href="https://en.opensuse.org/SDB:Plain_Text_versus_Locale">https://en.opensuse.org/SDB:Plain_Text_versus_Locale</a></p>
<h4 id="olivero2_commented_at_2018-01-29_2148"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/issues/1563#issuecomment-361397967">2018-01-29 21:48</a>:<a class="headerlink" href="#olivero2_commented_at_2018-01-29_2148" title="Permanent link">&para;</a></h4>
<p>Yes, that's always the problem with arguments being interpreted
according to the current locale, when we'd really like some
locale-agnostic binary string, which could be converted back and forth
in a lossless fashion without caring for its native locale.</p>
<h4 id="jsmeix_commented_at_2018-01-30_1054"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1563#issuecomment-361557086">2018-01-30 10:54</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-01-30_1054" title="Permanent link">&para;</a></h4>
<p>Ideally when during "rear mkrescue/mkbackup" that runs in POSIX/C
locale<br />
tools report values, those values are already "somehow right" so that<br />
later those same values can be used "as is" again as input for those
tools<br />
to set up something in POSIX/C locale - even if those vaules actually<br />
contain non-ASCII bytes.</p>
<p>But I fear in reality things "just break arbitrarily" when non-ASCII
bytes<br />
appear in values when tools run in POSIX/C locale.</p>
<p>Therefore I have the dim feeling that in the end we are forced to call<br />
specific tools as needed during "rear mkrescue/mkbackup" in a UTF-8
locale<br />
and accordingly we would need to have UTF-8 support by default in the<br />
recovery system so that those specific tools which need it can also
run<br />
in a UTF-8 locale during "rear recover" - but as far as I learned<br />
the whole scripts must still run in POSIX/C locale, cf.<br />
<a href="https://github.com/rear/rear/issues/1035">https://github.com/rear/rear/issues/1035</a></p>
<p>Currently only Borg backup restore is run in a UTF-8 locale,<br />
see prep/BORG/default/200_prep_borg.sh<br />
and restore/BORG/default/400_restore_backup.sh</p>
<p>By the way I found another place in the code where<br />
a dirty hack 'sed' workaround for UTF-8 is done,<br />
in lib/mkrescue-functions.sh - see also<br />
<a href="https://github.com/rear/rear/issues/1018#issuecomment-251385721">https://github.com/rear/rear/issues/1018#issuecomment-251385721</a></p>
<h4 id="jsmeix_commented_at_2018-01-30_1113"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1563#issuecomment-361561739">2018-01-30 11:13</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-01-30_1113" title="Permanent link">&para;</a></h4>
<p>I wonder if I should implememt a test<br />
that is run during "rear mkrescue/mkbackup"<br />
which tests if there is a non-ASCII byte in disklayout.conf<br />
and errors out perhaps even via BugError?</p>
<p>@gdha @rmetrich @gozora @OliverO2<br />
what do you think?</p>
<h4 id="olivero2_commented_at_2018-01-30_1429"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/issues/1563#issuecomment-361609816">2018-01-30 14:29</a>:<a class="headerlink" href="#olivero2_commented_at_2018-01-30_1429" title="Permanent link">&para;</a></h4>
<p>If ReaR character set support should be limited to 7-bit only, then yes,
I'd favor an early error message during <code>rear mkrescue/mkbackup</code> over a
failing rescue operation.</p>
<p>On the other hand, I'd prefer ReaR to move towards supporting an 8-bit
character set (the default being UTF-8), which is possible in my view in
a backward-compatible manner. Cf.
<a href="https://github.com/rear/rear/issues/1035#issuecomment-361609619">https://github.com/rear/rear/issues/1035#issuecomment-361609619</a>.</p>
<h4 id="jsmeix_commented_at_2018-01-30_1522"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1563#issuecomment-361626851">2018-01-30 15:22</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-01-30_1522" title="Permanent link">&para;</a></h4>
<p>@OliverO2<br />
of course an early error exit during "rear mkrescue/mkbackup"<br />
is preferred over a failing "rear recover" operation, cf.<br />
<a href="https://github.com/rear/rear/pull/1697#issuecomment-358922509">https://github.com/rear/rear/pull/1697#issuecomment-358922509</a></p>
<p>Only a nitpicking side note:<br />
I think the root of all evil is not 7-bit versus 8-bit character
encoding.<br />
I assume any single-byte character encoding would "just work" - only<br />
how characters look at the screen could be wrong - but I would think<br />
that for any single-byte encoding the actual byte values would not
change.<br />
I think the root of all evil is single byte encoding versus multibyte
encoding.</p>
<h4 id="olivero2_commented_at_2018-01-31_1851"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/issues/1563#issuecomment-362032342">2018-01-31 18:51</a>:<a class="headerlink" href="#olivero2_commented_at_2018-01-31_1851" title="Permanent link">&para;</a></h4>
<p>@jsmeix</p>
<blockquote>
<p>I assume any single-byte character encoding would "just work"</p>
</blockquote>
<p>Actually, probably not - at least with parted: See
<a href="https://github.com/rear/rear/pull/1706#issuecomment-362031250">https://github.com/rear/rear/pull/1706#issuecomment-362031250</a>
for an explanation.</p>
<h4 id="olivero2_commented_at_2018-01-31_1902"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/issues/1563#issuecomment-362035605">2018-01-31 19:02</a>:<a class="headerlink" href="#olivero2_commented_at_2018-01-31_1902" title="Permanent link">&para;</a></h4>
<p>@jsmeix</p>
<blockquote>
<p>I think the root of all evil is not 7-bit versus 8-bit character
encoding.</p>
</blockquote>
<p>Multi-byte encodings are downward compatible with 7-bit ASCII. So 7-bit
will always work.</p>
<blockquote>
<p>I think the root of all evil is single byte encoding versus multibyte
encoding.</p>
</blockquote>
<p>Not really. Even if you used a single-byte 8-bit encoding such as ISO
8859.1, a tool like parted operating in the <code>C</code> locale would have no
idea of how to convert this into a wide-character string: As soon as it
finds character codes &gt; 127, it would fail.</p>
<p>So it's all about proper locale setting, or sticking to 7-bit ASCII.</p>
<h4 id="olivero2_commented_at_2018-01-31_1908"><img src="https://avatars.githubusercontent.com/u/4660803?v=4" width="50"><a href="https://github.com/OliverO2">OliverO2</a> commented at <a href="https://github.com/rear/rear/issues/1563#issuecomment-362037550">2018-01-31 19:08</a>:<a class="headerlink" href="#olivero2_commented_at_2018-01-31_1908" title="Permanent link">&para;</a></h4>
<p>@jsmeix<br />
Below is some code you could use to reproduce what parted does:</p>
<pre><code>$ LC_CTYPE=C ./wcs Schön
Error during translation: Invalid or incomplete multibyte or wide character
$ LC_CTYPE=en_US.utf8 ./wcs Schön
"Schön" converted to a wide-character string is "Schön"
</code></pre>
<p>Store as <code>wcs.c</code> and use <code>cc -o wcs wcs.c</code> to compile:</p>
<pre><code>#include &lt;wchar.h&gt;
#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;errno.h&gt;
#include &lt;limits.h&gt;
#include &lt;malloc.h&gt;
#include &lt;locale.h&gt;

/* original function from parted's strlist.c, with xrealloc call replaced by realloc call */
static wchar_t*
gettext_to_wchar (const char* str)
{
    int     count;
    wchar_t*    result;
    size_t      status;
    mbstate_t   ps;

    count = strlen (str) + 1;
    result = malloc (count * sizeof (wchar_t));
    if (!result)
        goto error;

    memset(&amp;ps, 0, sizeof (ps));
    status = mbsrtowcs(result, &amp;str, count, &amp;ps);
    if (str != NULL)
        goto error;

    result = realloc (result, (status + 1) * sizeof (wchar_t));
    return result;

error:
    fprintf (stderr, "Error during translation: %s\n", strerror (errno));
    exit (EXIT_FAILURE);
}

int main(int argc, char *argv[]) {
    setlocale(LC_ALL, "");

    if (argc != 2) {
        fprintf(stderr, "usage: %s STRING\n", argv[0]);
        exit(1);
    }

    printf("\"%s\" converted to a wide-character string is \"%ls\"\n", argv[1], gettext_to_wchar(argv[1]));

    return 0;
}
</code></pre>
<h4 id="jsmeix_commented_at_2018-02-01_1127"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1563#issuecomment-362238059">2018-02-01 11:27</a>:<a class="headerlink" href="#jsmeix_commented_at_2018-02-01_1127" title="Permanent link">&para;</a></h4>
<p>@OliverO2<br />
many thanks for your analysis!</p>
<p>Currently I have no time to have a closer look<br />
how parted and ReaR in C locale interact, cf.<br />
<a href="https://github.com/rear/rear/pull/1706#issuecomment-362236133">https://github.com/rear/rear/pull/1706#issuecomment-362236133</a><br />
and after FOSDEM there are already "other important things" waiting...</p>
<p>I think my percent-encoding does not change any byte value<br />
so that I think I got UTF-8 encoded characters as output<br />
from parted regardless that parted runs in C locale<br />
during "rear mkrescue" and that looks wrong to me.<br />
Later when "rear recover" (that also runs in C locale)<br />
feeds that same bytes into parted (under the assumption<br />
that my percent-decode really results the same bytes)<br />
parted fails when it gets its own output bytes as input,<br />
cf. my "Ideally..." wish versus my "...fear..." and my "...dim
feeling..." in my above<br />
<a href="https://github.com/rear/rear/issues/1563#issuecomment-361557086">https://github.com/rear/rear/issues/1563#issuecomment-361557086</a></p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2025 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2017-11-06.1563.issue.closed.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/rear/rear-user-guide" class="fa fa-code-fork" style="color: #fcfcfc"> rear/rear-user-guide</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
