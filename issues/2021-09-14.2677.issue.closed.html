<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#2677 Issue closed: Recovery system has all needed kernel modules but something hinders loading them: tg3 and smartpqi on HPE ProLiant DL360 Gen10 - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#2677 Issue closed: Recovery system has all needed kernel modules but something hinders loading them: tg3 and smartpqi on HPE ProLiant DL360 Gen10";
        var mkdocs_page_input_path = "issues/2021-09-14.2677.issue.closed.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/backup_netfs.html">Example of BACKUP=NETFS</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear28.html">Release Notes ReaR 2.8</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#2677 Issue closed: Recovery system has all needed kernel modules but something hinders loading them: tg3 and smartpqi on HPE ProLiant DL360 Gen10</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="2677_issue_closed_recovery_system_has_all_needed_kernel_modules_but_something_hinders_loading_them_tg3_and_smartpqi_on_hpe_proliant_dl360_gen10"><a href="https://github.com/rear/rear/issues/2677">#2677 Issue</a> <code>closed</code>: Recovery system has all needed kernel modules but something hinders loading them: tg3 and smartpqi on HPE ProLiant DL360 Gen10<a class="headerlink" href="#2677_issue_closed_recovery_system_has_all_needed_kernel_modules_but_something_hinders_loading_them_tg3_and_smartpqi_on_hpe_proliant_dl360_gen10" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>bug</code>, <code>fixed / solved / done</code></p>
<h4 id="hpannenb_opened_issue_at_2021-09-14_0712"><img src="https://avatars.githubusercontent.com/u/13567759?u=b037e492e58a5f63f35277b3606d500cd622c8ed&v=4" width="50"><a href="https://github.com/hpannenb">hpannenb</a> opened issue at <a href="https://github.com/rear/rear/issues/2677">2021-09-14 07:12</a>:<a class="headerlink" href="#hpannenb_opened_issue_at_2021-09-14_0712" title="Permanent link">&para;</a></h4>
<ul>
<li>ReaR version ("/usr/sbin/rear -V"):<br />
    Relax-and-Recover 2.6 / Git from the current git master branch.</li>
<li>OS version ("cat /etc/os-release" or "lsb_release -a" or "cat
    /etc/rear/os.conf"):<br />
    OS_VENDOR=RedHatEnterpriseServer<br />
    OS_VERSION=7.9</li>
<li>ReaR configuration files ("cat /etc/rear/site.conf" and/or "cat
    /etc/rear/local.conf"):</li>
</ul>
<!-- -->

<pre><code>####################
##
# BACKUP=NSR (EMC Networker Client only; Legato)
#
# Note: NSR_CLIENT_MODE used
#
##
####################
export TMPDIR="/var/tmp"
export USER_INPUT_TIMEOUT=15

BACKUP=NSR
NSR_CLIENT_MODE=y
NSR_CLIENT_REQUESTRESTORE=n

OUTPUT=ISO
ISO_PREFIX="rear-git-nsr-$HOSTNAME"

OUTPUT_URL=nfs://ts2esesv802/var/backup/

# Static IP (no DHCP!)
USE_DHCLIENT=
USE_STATIC_NETWORKING=yes
USE_RESOLV_CONF=no

# Include only currently loaded modules
MODULES=( 'loaded_modules' )

# Set ROOT Password (optional)
SSH_ROOT_PASSWORD='root'

# Clone all users
CLONE_ALL_USERS=yes

# Execute recovery workaround after restore has been completed
# to set the STICKY bit for /tmp
#
POST_RECOVERY_SCRIPT="chmod +t $TARGET_FS_ROOT/tmp/"
</code></pre>
<ul>
<li>Hardware (PC or PowerNV BareMetal or ARM) or virtual machine (KVM
    guest or PoverVM LPAR):<br />
    BareMetal / HPE ProLiant DL360 Gen10</li>
<li>System architecture (x86 compatible or PPC64/PPC64LE or what exact
    ARM device):<br />
    x86 compatible</li>
<li>Firmware (BIOS or UEFI or Open Firmware) and bootloader (GRUB or
    ELILO or Petitboot):<br />
    BIOS / GRUB</li>
<li>Storage (local disk or SSD) and/or SAN (FC or iSCSI or FCoE) and/or
    multipath (DM or NVMe):<br />
    Local disks</li>
<li>Storage layout ("lsblk -ipo
    NAME,KNAME,PKNAME,TRAN,TYPE,FSTYPE,SIZE,MOUNTPOINT" or "lsblk" as
    makeshift):</li>
</ul>
<!-- -->

<pre><code>NAME                                   KNAME     PKNAME    TRAN TYPE FSTYPE        SIZE MOUNTPOINT
/dev/sda                               /dev/sda            sas  disk             279.4G 
|-/dev/sda1                            /dev/sda1 /dev/sda       part ext3          500M /boot
|-/dev/sda2                            /dev/sda2 /dev/sda       part swap         43.8G [SWAP]
`-/dev/sda3                            /dev/sda3 /dev/sda       part LVM2_member 235.1G 
  |-/dev/mapper/tproot-lv_root         /dev/dm-0 /dev/sda3      lvm  ext3         10.3G /
  |-/dev/mapper/tproot-lv_var          /dev/dm-1 /dev/sda3      lvm  ext3         33.7G /var
  `-/dev/mapper/tproot-lv_var_textpass /dev/dm-2 /dev/sda3      lvm  ext3        101.2G /var/TextPass
/dev/sdb                               /dev/sdb            sas  disk             279.4G 
`-/dev/sdb1                            /dev/sdb1 /dev/sdb       part ext3        279.4G /data
/dev/sdc                               /dev/sdc            sas  disk             279.4G 
`-/dev/sdc1                            /dev/sdc1 /dev/sdc       part ext3        279.4G /dbamsstore
/dev/sdd                               /dev/sdd            sas  disk             279.4G 
`-/dev/sdd1                            /dev/sdd1 /dev/sdd       part ext3        279.4G /dbamslog
</code></pre>
<ul>
<li>Description of the issue (ideally so that others can reproduce
    it):<br />
    In case of the config in use booting the server into the recovery
    environment with the created ISO (via iLO) does neither enable the
    tg3 interfaces nor load the smartpqi module so disk drives cannot be
    accessed. The same config with ReaR 2.6 (release) does work
    perfectly fine.</li>
<li>Workaround, if any:<br />
    Comment out the config line <code>MODULES=( 'loaded_modules' )</code> so ALL
    modules will be loaded by default.</li>
<li>Attachments, as applicable ("rear -D mkrescue/mkbackup/recover"
    debug log files):<br />
<a href="https://github.com/rear/rear/files/7159751/rear-ts9esesv801.log.gz">rear-ts9esesv801.log.gz</a></li>
</ul>
<p>The tg3 or smartpqi are both included in the "rootfs".
<code>rear.NvDzgi9heEURFEY</code> is of ReaR 2.6 / Git and <code>rear.Ox3B9qbBmXQipSL</code>
of ReaR 2.6 / 2020-06-17:</p>
<pre><code>[root@ts9esesv801 tmp]# find ./rear.* -type f | egrep "smart|tg3"
./rear.NvDzgi9heEURFEY/rootfs/etc/dracut.conf.d/smartpqi.conf
./rear.NvDzgi9heEURFEY/rootfs/opt/smartstorageadmin/ssacli/bin/rmstr
./rear.NvDzgi9heEURFEY/rootfs/opt/smartstorageadmin/ssacli/bin/mklocks.sh
./rear.NvDzgi9heEURFEY/rootfs/opt/smartstorageadmin/ssacli/bin/ssacli
./rear.NvDzgi9heEURFEY/rootfs/opt/smartstorageadmin/ssacli/bin/ssacli.license
./rear.NvDzgi9heEURFEY/rootfs/opt/smartstorageadmin/ssacli/bin/ssascripting
./rear.NvDzgi9heEURFEY/rootfs/opt/smartstorageadmin/ssacli/bin/ssacli-5.10-44.0.x86_64.txt
./rear.NvDzgi9heEURFEY/rootfs/usr/lib/modules/3.10.0-1160.el7.x86_64/extra/smartpqi/smartpqi.ko
./rear.NvDzgi9heEURFEY/rootfs/usr/lib/modules/3.10.0-1160.el7.x86_64/extra/tg3/tg3.ko
./rear.NvDzgi9heEURFEY/rootfs/usr/lib/firmware/tigon/tg3_tso5.bin
./rear.NvDzgi9heEURFEY/rootfs/usr/lib/firmware/tigon/tg3_tso.bin
./rear.NvDzgi9heEURFEY/rootfs/usr/lib/firmware/tigon/tg357766.bin
./rear.NvDzgi9heEURFEY/rootfs/usr/lib/firmware/tigon/tg3.bin
./rear.Ox3B9qbBmXQipSL/rootfs/etc/dracut.conf.d/smartpqi.conf
./rear.Ox3B9qbBmXQipSL/rootfs/opt/smartstorageadmin/ssacli/bin/rmstr
./rear.Ox3B9qbBmXQipSL/rootfs/opt/smartstorageadmin/ssacli/bin/mklocks.sh
./rear.Ox3B9qbBmXQipSL/rootfs/opt/smartstorageadmin/ssacli/bin/ssacli
./rear.Ox3B9qbBmXQipSL/rootfs/opt/smartstorageadmin/ssacli/bin/ssacli.license
./rear.Ox3B9qbBmXQipSL/rootfs/opt/smartstorageadmin/ssacli/bin/ssascripting
./rear.Ox3B9qbBmXQipSL/rootfs/opt/smartstorageadmin/ssacli/bin/ssacli-5.10-44.0.x86_64.txt
./rear.Ox3B9qbBmXQipSL/rootfs/usr/lib/modules/3.10.0-1160.2.2.el7.x86_64/weak-updates/smartpqi/smartpqi.ko
./rear.Ox3B9qbBmXQipSL/rootfs/usr/lib/modules/3.10.0-1160.2.2.el7.x86_64/weak-updates/tg3/tg3.ko
./rear.Ox3B9qbBmXQipSL/rootfs/usr/lib/firmware/tigon/tg3_tso5.bin
./rear.Ox3B9qbBmXQipSL/rootfs/usr/lib/firmware/tigon/tg3_tso.bin
./rear.Ox3B9qbBmXQipSL/rootfs/usr/lib/firmware/tigon/tg357766.bin
./rear.Ox3B9qbBmXQipSL/rootfs/usr/lib/firmware/tigon/tg3.bin
</code></pre>
<h4 id="jsmeix_commented_at_2021-09-14_0749"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2677#issuecomment-918901233">2021-09-14 07:49</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-09-14_0749" title="Permanent link">&para;</a></h4>
<p>@hpannenb<br />
I didn't check the details but from plain looking at your description<br />
I wonder if there is perhaps a confusion between what<br />
<code>MODULES</code> means versus what <code>MODULES_LOAD</code> means?</p>
<p>FYI: Via<br />
<a href="https://github.com/rear/rear/commit/4480cc00ad0b9a46bbde6f56ca392051b134f949">https://github.com/rear/rear/commit/4480cc00ad0b9a46bbde6f56ca392051b134f949</a><br />
I merged in particular that kernel modules that should be loaded<br />
during recovery system startup (i.e. those in MODULES_LOAD)<br />
get always copied into the recovery system, see the code in<br />
<a href="https://github.com/rear/rear/blob/master/usr/share/rear/build/GNU/Linux/400_copy_modules.sh">https://github.com/rear/rear/blob/master/usr/share/rear/build/GNU/Linux/400_copy_modules.sh</a><br />
so for debugging you should check your "rear -D mkrescue" log<br />
what 400_copy_modules.sh actually does in your particular case<br />
i.e. if 400_copy_modules.sh copies all what <code>lsmod</code> lists on your
system.<br />
The crucial part is the modinfo_filename() function which should
return<br />
the actual module file that needs to be copied for a module name.<br />
I know that in some obscure cases the modinfo_filename() function<br />
fails to determine the module file for a module name, see its code,<br />
there are rather awkward things that are done to get a module file
name.<br />
I already had a lot of "not so much fun" with that.</p>
<h4 id="jsmeix_commented_at_2021-09-14_0806"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2677#issuecomment-918914125">2021-09-14 08:06</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-09-14_0806" title="Permanent link">&para;</a></h4>
<p>@hpannenb<br />
does the same config work perfectly fine with ReaR 2.6 (release)<br />
on exactly the same system?<br />
I ask because if you run ReaR 2.6 (release) on a system with<br />
a different kernel there may be differences in module dependencies<br />
which may require more than what <code>MODULES=( 'loaded_modules' )</code>
copies,<br />
cf. the description in default.conf why we have now
<code>MODULES=( 'all_modules' )</code><br />
by default, see
<a href="https://github.com/rear/rear/issues/1202">https://github.com/rear/rear/issues/1202</a><br />
how missing kernel modules can result any kind of awkward unexpected
failures<br />
and see
<a href="https://github.com/rear/rear/issues/1355">https://github.com/rear/rear/issues/1355</a><br />
why in practice it is impossible to automatically determine<br />
all also needed other modules for a particular module.</p>
<h4 id="hpannenb_commented_at_2021-09-14_0808"><img src="https://avatars.githubusercontent.com/u/13567759?u=b037e492e58a5f63f35277b3606d500cd622c8ed&v=4" width="50"><a href="https://github.com/hpannenb">hpannenb</a> commented at <a href="https://github.com/rear/rear/issues/2677#issuecomment-918915526">2021-09-14 08:08</a>:<a class="headerlink" href="#hpannenb_commented_at_2021-09-14_0808" title="Permanent link">&para;</a></h4>
<blockquote>
<p>@hpannenb<br />
does the same config work perfectly fine with ReaR 2.6 (release)<br />
on exactly the same system?</p>
</blockquote>
<p>@jsmeix Yes. It is the same system where I am currently testing ReaR 2.6
/ Git versus ReaR 2.6 (release).</p>
<p>As mentioned the "currently in use" modules tg3 and smartpqi are both
copied into the "rootfs" but booting the server does not use/load them
which does prevent activating the NICs as well as accessing the harddisk
(via the Smart Controller).</p>
<h4 id="jsmeix_commented_at_2021-09-14_0833"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2677#issuecomment-918935106">2021-09-14 08:33</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-09-14_0833" title="Permanent link">&para;</a></h4>
<p>This is why I mentioned <code>MODULES_LOAD</code>.<br />
So does <code>MODULES=( 'loaded_modules' )</code><br />
plus <code>MODULES_LOAD=( tg3 smartpqi )</code><br />
make it work?</p>
<p>Currently I have no good idea how to debug what happens<br />
during the very initial ReaR recovery system startup phase<br />
when the kernel/udev automagic module loading happens<br />
i.e. before any ReaR recovery system startup scripts<br />
usr/share/rear/skel/default/etc/scripts/system-setup*<br />
are run. In particular<br />
etc/scripts/system-setup.d/40-start-udev-or-load-modules.shReaR 2.6
(release)<br />
loads the modules in etc/modules which contains<br />
those listed in MODULES_LOAD, cf. near the end of<br />
usr/share/rear/build/GNU/Linux/400_copy_modules.sh</p>
<p>@hpannenb<br />
could you compare what etc/modules contains in your case<br />
with ReaR 2.6 (release) versus with our GitHub master code?</p>
<h4 id="hpannenb_commented_at_2021-09-14_0915"><img src="https://avatars.githubusercontent.com/u/13567759?u=b037e492e58a5f63f35277b3606d500cd622c8ed&v=4" width="50"><a href="https://github.com/hpannenb">hpannenb</a> commented at <a href="https://github.com/rear/rear/issues/2677#issuecomment-918968862">2021-09-14 09:15</a>:<a class="headerlink" href="#hpannenb_commented_at_2021-09-14_0915" title="Permanent link">&para;</a></h4>
<p>[...]</p>
<blockquote>
<p>@hpannenb<br />
could you compare what etc/modules contains in your case<br />
with ReaR 2.6 (release) versus with our GitHub master code?</p>
</blockquote>
<p>First block is ReaR 2.6 / Git and second block shows the 2.6 /
2020-06-17 (release):</p>
<pre><code>[root@ts9esesv801 tmp]# cat ./rear.NvDzgi9heEURFEY/rootfs/etc/modules
smartpqi
[root@ts9esesv801 tmp]# cat ./rear.Ox3B9qbBmXQipSL/rootfs/etc/modules
smartpqi
</code></pre>
<p>I am currently checking the ReaR git version with <code>MODULES_LOAD</code>
parameter set. It does not "work around" the situation: During boot I
see FATAL errors the modules cannot be found.</p>
<h4 id="jsmeix_commented_at_2021-09-14_1054"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2677#issuecomment-919040042">2021-09-14 10:54</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-09-14_1054" title="Permanent link">&para;</a></h4>
<p>I.e. with current GitHub master code</p>
<pre><code>MODULES=( 'loaded_modules' )
MODULES_LOAD=( tg3 smartpqi )
</code></pre>
<p>the specified module files are present in the ReaR recovery system<br />
but during boot there are FATAL errors that the modules cannot be found.</p>
<p>In contrast<br />
with GitHub master code and its plain default</p>
<pre><code>MODULES=( 'all_modules' )
</code></pre>
<p>or with the ReaR 2.6 release and only</p>
<pre><code>MODULES=( 'loaded_modules' )
</code></pre>
<p>things "just work".</p>
<p>Currently I am clueless.</p>
<p>I think someone from Red Hat should have a look here<br />
because I don't use RHEL so I cannot reproduce things.</p>
<p>@pcahyna @rmetrich<br />
could you (as time permits) please have a look here?</p>
<h4 id="hpannenb_commented_at_2021-09-14_1152"><img src="https://avatars.githubusercontent.com/u/13567759?u=b037e492e58a5f63f35277b3606d500cd622c8ed&v=4" width="50"><a href="https://github.com/hpannenb">hpannenb</a> commented at <a href="https://github.com/rear/rear/issues/2677#issuecomment-919077370">2021-09-14 11:52</a>:<a class="headerlink" href="#hpannenb_commented_at_2021-09-14_1152" title="Permanent link">&para;</a></h4>
<p>I tested with the parameter <code>MODULES=( 'tg3' 'smartpqi' )</code> which is also
another workaround (for my current setup) since NIC and SmartController
are accessible in the rescue environment.</p>
<h4 id="jsmeix_commented_at_2021-09-14_1240"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2677#issuecomment-919111110">2021-09-14 12:40</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-09-14_1240" title="Permanent link">&para;</a></h4>
<p>For me this issue gets more and more inexplicable.<br />
When <code>MODULES=( 'loaded_modules' )</code> is insufficient<br />
but <code>MODULES=( 'tg3' 'smartpqi' )</code> is sufficient<br />
it means - as far as I can imagine things here - there are some<br />
special kernel modules that are needed to load tg3 and smartpqi<br />
but those special kernel modules are not shown by <code>lsmod</code><br />
afterwards in the running system - or something like that ???</p>
<h4 id="hpannenb_commented_at_2021-09-14_1314"><img src="https://avatars.githubusercontent.com/u/13567759?u=b037e492e58a5f63f35277b3606d500cd622c8ed&v=4" width="50"><a href="https://github.com/hpannenb">hpannenb</a> commented at <a href="https://github.com/rear/rear/issues/2677#issuecomment-919138936">2021-09-14 13:14</a>:<a class="headerlink" href="#hpannenb_commented_at_2021-09-14_1314" title="Permanent link">&para;</a></h4>
<p>So far I cannot determine any other "magic" behind the scenes; but I am
certainly lacking knowledge in this area.</p>
<pre><code>[root@ts9esesv801 rear.git.master]# modprobe --ignore-install --set-version 3.10.0-1160.2.2.el7.x86_64 --show-depends smartpqi
insmod /lib/modules/3.10.0-1160.2.2.el7.x86_64/kernel/drivers/scsi/scsi_transport_sas.ko.xz 
insmod /lib/modules/3.10.0-1160.2.2.el7.x86_64/weak-updates/smartpqi/smartpqi.ko

[root@ts9esesv801 rear.git.master]# modprobe --ignore-install --set-version 3.10.0-1160.2.2.el7.x86_64 --show-depends tg3
insmod /lib/modules/3.10.0-1160.2.2.el7.x86_64/kernel/drivers/pps/pps_core.ko.xz 
insmod /lib/modules/3.10.0-1160.2.2.el7.x86_64/kernel/drivers/ptp/ptp.ko.xz 
insmod /lib/modules/3.10.0-1160.2.2.el7.x86_64/weak-updates/tg3/tg3.ko

[root@ts9esesv801 rear.git.master]# cat /etc/depmod.d/smartpqi.conf
override smartpqi 3.10.0-* weak-updates/smartpqi
</code></pre>
<h4 id="hpannenb_commented_at_2021-09-14_1420"><img src="https://avatars.githubusercontent.com/u/13567759?u=b037e492e58a5f63f35277b3606d500cd622c8ed&v=4" width="50"><a href="https://github.com/hpannenb">hpannenb</a> commented at <a href="https://github.com/rear/rear/issues/2677#issuecomment-919198886">2021-09-14 14:20</a>:<a class="headerlink" href="#hpannenb_commented_at_2021-09-14_1420" title="Permanent link">&para;</a></h4>
<p>I performed a last test with my config from above. Booting into the
rescue environment and manually executing the following makes the drives
and the NICs available:</p>
<p>For smartpqi:</p>
<pre><code>insmod /lib/modules/3.10.0-1160.2.2.el7.x86_64/kernel/drivers/scsi/scsi_transport_sas.ko.xz 
insmod /usr/lib/modules/3.10.0-1160.el7.x86_64/extra/smartpqi/smartpqi.ko
</code></pre>
<p>For tg3:</p>
<pre><code>insmod /lib/modules/3.10.0-1160.2.2.el7.x86_64/kernel/drivers/pps/pps_core.ko.xz 
insmod /lib/modules/3.10.0-1160.2.2.el7.x86_64/kernel/drivers/ptp/ptp.ko.xz 
insmod /usr/lib/modules/3.10.0-1160.el7.x86_64/extra/tg3/tg3.ko
</code></pre>
<p>So overall the rescue system includes all required data but something
hinders the proper load of the required (kernel) modules.</p>
<h4 id="hpannenb_commented_at_2021-09-15_0810"><img src="https://avatars.githubusercontent.com/u/13567759?u=b037e492e58a5f63f35277b3606d500cd622c8ed&v=4" width="50"><a href="https://github.com/hpannenb">hpannenb</a> commented at <a href="https://github.com/rear/rear/issues/2677#issuecomment-919798160">2021-09-15 08:10</a>:<a class="headerlink" href="#hpannenb_commented_at_2021-09-15_0810" title="Permanent link">&para;</a></h4>
<p>I tried to bisect the ReaR changes a little - most likely related to the
mentioned part<br />
<a href="https://github.com/rear/rear/blob/master/usr/share/rear/build/GNU/Linux/400_copy_modules.sh">https://github.com/rear/rear/blob/master/usr/share/rear/build/GNU/Linux/400_copy_modules.sh</a><br />
only - and discovered the issue seems to be introduced with commit
d2588e8c05aebfcdb3ac5cf1be7732aac2d78eb2 .</p>
<h4 id="jsmeix_commented_at_2021-09-15_0811"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2677#issuecomment-919798492">2021-09-15 08:11</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-09-15_0811" title="Permanent link">&para;</a></h4>
<p>@hpannenb<br />
thank you for your testing.<br />
Now the actual issue is more clear.</p>
<h4 id="jsmeix_commented_at_2021-09-15_0815"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2677#issuecomment-919801331">2021-09-15 08:15</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-09-15_0815" title="Permanent link">&para;</a></h4>
<p>I still have no idea what that "something" could be<br />
i.e. what the root cause could be.</p>
<p>build/GNU/Linux/400_copy_modules.sh<br />
is about copying kernel modules into the recovery system<br />
so if build/GNU/Linux/400_copy_modules.sh would be the root cause<br />
it would mean kernel modules are missing in the recovery system<br />
but that is not the case so build/GNU/Linux/400_copy_modules.sh<br />
cannot be the root cause - as far as I can understand things currently.</p>
<h4 id="hpannenb_commented_at_2021-09-15_0843"><img src="https://avatars.githubusercontent.com/u/13567759?u=b037e492e58a5f63f35277b3606d500cd622c8ed&v=4" width="50"><a href="https://github.com/hpannenb">hpannenb</a> commented at <a href="https://github.com/rear/rear/issues/2677#issuecomment-919821855">2021-09-15 08:43</a>:<a class="headerlink" href="#hpannenb_commented_at_2021-09-15_0843" title="Permanent link">&para;</a></h4>
<p>@jsmeix Additional info: The basis for my "bisecting" was the current
ReaR from Git Master. The only thing I changed from that basis was the
script 400_copy_modules.sh starting from August 2020 onwards with my
initial config:</p>
<ul>
<li>Applying the changes of 5c11e507365f6719f3f579abae119b2d7d02740c the
    rescue environment could load the modules.</li>
<li>Applying the changes of d2588e8c05aebfcdb3ac5cf1be7732aac2d78eb2
    broke the proper loading.</li>
</ul>
<h4 id="jsmeix_commented_at_2021-09-15_0852"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2677#issuecomment-919827769">2021-09-15 08:52</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-09-15_0852" title="Permanent link">&para;</a></h4>
<p>@hpannenb<br />
could you provide two "rear -D mkrescue" debug log files (on the same
system)<br />
one with the changes of 5c11e50 and<br />
the other one with the changes of d2588e8<br />
and your /etc/rear/local.conf file that you used for both.</p>
<p>Thanks in advance!</p>
<h4 id="hpannenb_commented_at_2021-09-15_0943"><img src="https://avatars.githubusercontent.com/u/13567759?u=b037e492e58a5f63f35277b3606d500cd622c8ed&v=4" width="50"><a href="https://github.com/hpannenb">hpannenb</a> commented at <a href="https://github.com/rear/rear/issues/2677#issuecomment-919866160">2021-09-15 09:43</a>:<a class="headerlink" href="#hpannenb_commented_at_2021-09-15_0943" title="Permanent link">&para;</a></h4>
<p>@jsmeix Attached both the log files.<br />
<a href="https://github.com/rear/rear/files/7168910/rear-d2588e8-ts9esesv801.log.gz">rear-d2588e8-ts9esesv801.log.gz</a><br />
<a href="https://github.com/rear/rear/files/7168911/rear-5c11e50-ts9esesv801.log.gz">rear-5c11e50-ts9esesv801.log.gz</a></p>
<p>In all cases I used the <code>/etc/rear/site.conf</code> from above.</p>
<h4 id="hpannenb_commented_at_2021-09-15_1003"><img src="https://avatars.githubusercontent.com/u/13567759?u=b037e492e58a5f63f35277b3606d500cd622c8ed&v=4" width="50"><a href="https://github.com/hpannenb">hpannenb</a> commented at <a href="https://github.com/rear/rear/issues/2677#issuecomment-919879640">2021-09-15 10:03</a>:<a class="headerlink" href="#hpannenb_commented_at_2021-09-15_1003" title="Permanent link">&para;</a></h4>
<p>To have a faster testing opportunity I executed the following command
for all different build areas:</p>
<p>Original ReaR 2.6</p>
<pre><code>depmod -n -b /var/tmp/rear.26/rootfs/ -v 3.10.0-1160.2.2.el7.x86_64 | egrep "tg3|smartpqi"
/var/tmp/rear.26/rootfs//lib/modules/3.10.0-1160.2.2.el7.x86_64/weak-updates/smartpqi/smartpqi.ko needs "sas_port_alloc_num": /var/tmp/rear.26/rootfs//lib/modules/3.10.0-1160.2.2.el7.x86_64/kernel/drivers/scsi/scsi_transport_sas.ko.xz
/var/tmp/rear.26/rootfs//lib/modules/3.10.0-1160.2.2.el7.x86_64/weak-updates/tg3/tg3.ko needs "ptp_clock_index": /var/tmp/rear.26/rootfs//lib/modules/3.10.0-1160.2.2.el7.x86_64/kernel/drivers/ptp/ptp.ko.xz
...
</code></pre>
<p>ReaR Git Master with commit 5c11e50</p>
<pre><code>depmod -n -b /var/tmp/rear.yPIcv85F6TI0yiP/rootfs/ -v 3.10.0-1160.2.2.el7.x86_64 | egrep "tg3|smartpqi"
/var/tmp/rear.yPIcv85F6TI0yiP/rootfs//lib/modules/3.10.0-1160.2.2.el7.x86_64/weak-updates/smartpqi/smartpqi.ko needs "sas_port_alloc_num": /var/tmp/rear.yPIcv85F6TI0yiP/rootfs//lib/modules/3.10.0-1160.2.2.el7.x86_64/kernel/drivers/scsi/scsi_transport_sas.ko.xz
/var/tmp/rear.yPIcv85F6TI0yiP/rootfs//lib/modules/3.10.0-1160.2.2.el7.x86_64/weak-updates/tg3/tg3.ko needs "ptp_clock_index": /var/tmp/rear.yPIcv85F6TI0yiP/rootfs//lib/modules/3.10.0-1160.2.2.el7.x86_64/kernel/drivers/ptp/ptp.ko.xz
...
</code></pre>
<p>ReaR Git Master with commit d2588e8<br />
<code>depmod -n -b /var/tmp/rear.OqgFTxNJRXbrtFI/rootfs/ -v 3.10.0-1160.2.2.el7.x86_64 | egrep "tg3|smartpqi"</code></p>
<p>ReaR Git Master with commit d2588e8 (commented out MODULES in
/etc/rear/site.conf)<br />
...</p>
<pre><code>depmod -n -b /var/tmp/rear.PJo5MBBiGj9PDB6/rootfs/ -v 3.10.0-1160.2.2.el7.x86_64 | egrep "tg3|smartpqi"
/var/tmp/rear.PJo5MBBiGj9PDB6/rootfs//lib/modules/3.10.0-1160.2.2.el7.x86_64/weak-updates/smartpqi/smartpqi.ko needs "sas_port_alloc_num": /var/tmp/rear.PJo5MBBiGj9PDB6/rootfs//lib/modules/3.10.0-1160.2.2.el7.x86_64/kernel/drivers/scsi/scsi_transport_sas.ko.xz
/var/tmp/rear.PJo5MBBiGj9PDB6/rootfs//lib/modules/3.10.0-1160.2.2.el7.x86_64/weak-updates/tg3/tg3.ko needs "ptp_clock_index": /var/tmp/rear.PJo5MBBiGj9PDB6/rootfs//lib/modules/3.10.0-1160.2.2.el7.x86_64/kernel/drivers/ptp/ptp.ko.xz
...
</code></pre>
<h4 id="jsmeix_commented_at_2021-09-15_1015"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2677#issuecomment-919888561">2021-09-15 10:15</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-09-15_1015" title="Permanent link">&para;</a></h4>
<p>@hpannenb<br />
what exactly is your <code>the /etc/rear/site.conf from above</code>?<br />
You posted serveral things you had tried.<br />
I need to know 100% exactly what config you used.</p>
<h4 id="hpannenb_commented_at_2021-09-15_1033"><img src="https://avatars.githubusercontent.com/u/13567759?u=b037e492e58a5f63f35277b3606d500cd622c8ed&v=4" width="50"><a href="https://github.com/hpannenb">hpannenb</a> commented at <a href="https://github.com/rear/rear/issues/2677#issuecomment-919901693">2021-09-15 10:33</a>:<a class="headerlink" href="#hpannenb_commented_at_2021-09-15_1033" title="Permanent link">&para;</a></h4>
<p>@jsmeix The printout from the section "ReaR configuration files" when
opening this issue.</p>
<h4 id="jsmeix_commented_at_2021-09-15_1237"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2677#issuecomment-919981141">2021-09-15 12:37</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-09-15_1237" title="Permanent link">&para;</a></h4>
<p><a href="https://github.com/rear/rear/files/7168911/rear-5c11e50-ts9esesv801.log.gz">https://github.com/rear/rear/files/7168911/rear-5c11e50-ts9esesv801.log.gz</a><br />
contains (excerpts):</p>
<pre><code>++ loaded_modules='...
...
tg3
smartpqi
...'

...

++ loaded_modules_files=' ...
...
/lib/modules/3.10.0-1160.2.2.el7.x86_64/weak-updates/tg3/tg3.ko
/lib/modules/3.10.0-1160.2.2.el7.x86_64/weak-updates/smartpqi/smartpqi.ko
...'
</code></pre>
<p>where two times 85 module files are listed.</p>
<p>In contrast<br />
<a href="https://github.com/rear/rear/files/7168910/rear-d2588e8-ts9esesv801.log.gz">https://github.com/rear/rear/files/7168910/rear-d2588e8-ts9esesv801.log.gz</a><br />
contains (excerpt):</p>
<pre><code>++ loaded_modules='...
...
tg3
smartpqi
...'

...

++ loaded_modules_files=' ...
...
/usr/lib/modules/3.10.0-1160.2.2.el7.x86_64/kernel/net/sunrpc/sunrpc.ko.xz
/usr/lib/modules/3.10.0-1160.2.2.el7.x86_64/kernel/virt/lib/irqbypass.ko.xz
/usr/lib/modules/3.10.0-1160.el7.x86_64/extra/smartpqi/smartpqi.ko
/usr/lib/modules/3.10.0-1160.el7.x86_64/extra/tg3/tg3.ko'
</code></pre>
<p>where two times only 80 module files are listed<br />
i.e. 5 module files less than before and there are<br />
different module files for smartpqi and tg3.</p>
<p>My blind guess is that the different module files<br />
for smartpqi and tg3 is the actual root cause.</p>
<p>On my openSUSE Leap 15.2 homeoffice laptop I have</p>
<pre><code>/lib/modules/5.3.18-lp152.87-default/kernel/drivers/net/ethernet/broadcom/tg3.ko
/lib/modules/5.3.18-lp152.87-default/kernel/drivers/scsi/smartpqi/smartpqi.ko
</code></pre>
<p>both as real files (no links).</p>
<p>I guess that the different module files come from<br />
<code>readlink -e $module_filename</code> in the modinfo_filename function that is
cuttently at<br />
<a href="https://github.com/rear/rear/blob/master/usr/share/rear/build/GNU/Linux/400_copy_modules.sh#L64">https://github.com/rear/rear/blob/master/usr/share/rear/build/GNU/Linux/400_copy_modules.sh#L64</a></p>
<h4 id="jsmeix_commented_at_2021-09-15_1247"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2677#issuecomment-919987504">2021-09-15 12:47</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-09-15_1247" title="Permanent link">&para;</a></h4>
<p>@hpannenb<br />
please check what kind of files</p>
<pre><code>/lib/modules/3.10.0-1160.2.2.el7.x86_64/weak-updates/tg3/tg3.ko
/lib/modules/3.10.0-1160.2.2.el7.x86_64/weak-updates/smartpqi/smartpqi.ko

/usr/lib/modules/3.10.0-1160.el7.x86_64/extra/smartpqi/smartpqi.ko
/usr/lib/modules/3.10.0-1160.el7.x86_64/extra/tg3/tg3.ko
</code></pre>
<p>are on your system<br />
and if - just a blind guess - perhaps replacing<br />
<code>readlink -e $module_filename</code> in the modinfo_filename function<br />
by something like plain <code>echo $module_filename</code> makes it work for you?</p>
<h4 id="hpannenb_commented_at_2021-09-15_1249"><img src="https://avatars.githubusercontent.com/u/13567759?u=b037e492e58a5f63f35277b3606d500cd622c8ed&v=4" width="50"><a href="https://github.com/hpannenb">hpannenb</a> commented at <a href="https://github.com/rear/rear/issues/2677#issuecomment-919989178">2021-09-15 12:49</a>:<a class="headerlink" href="#hpannenb_commented_at_2021-09-15_1249" title="Permanent link">&para;</a></h4>
<p>@jsmeix This is the current situation:</p>
<pre><code>find /lib/modules/ -name "*smartpqi*" -type l | sort
/lib/modules/3.10.0-1127.el7.x86_64/weak-updates/smartpqi/smartpqi.ko
/lib/modules/3.10.0-1160.2.2.el7.x86_64/weak-updates/smartpqi/smartpqi.ko
/lib/modules/3.10.0-957.12.1.el7.x86_64/weak-updates/smartpqi/smartpqi.ko

find /lib/modules/ -name "*smartpqi*" -type f | sort
/lib/modules/3.10.0-1127.el7.x86_64/kernel/drivers/scsi/smartpqi/smartpqi.ko.xz
/lib/modules/3.10.0-1160.2.2.el7.x86_64/kernel/drivers/scsi/smartpqi/smartpqi.ko.xz
/lib/modules/3.10.0-1160.el7.x86_64/extra/smartpqi/smartpqi.ko
/lib/modules/3.10.0-957.12.1.el7.x86_64/kernel/drivers/scsi/smartpqi/smartpqi.ko.xz

readlink -e /lib/modules/3.10.0-1160.2.2.el7.x86_64/weak-updates/smartpqi/smartpqi.ko
/usr/lib/modules/3.10.0-1160.el7.x86_64/extra/smartpqi/smartpqi.ko
</code></pre>
<p>and</p>
<pre><code>find /lib/modules/ -name "*smartpqi*" -type l | sort
/lib/modules/3.10.0-1127.el7.x86_64/weak-updates/smartpqi/smartpqi.ko
/lib/modules/3.10.0-1160.2.2.el7.x86_64/weak-updates/smartpqi/smartpqi.ko
/lib/modules/3.10.0-957.12.1.el7.x86_64/weak-updates/smartpqi/smartpqi.ko

find /lib/modules/ -name "*smartpqi*" -type f | sort
/lib/modules/3.10.0-1127.el7.x86_64/kernel/drivers/scsi/smartpqi/smartpqi.ko.xz
/lib/modules/3.10.0-1160.2.2.el7.x86_64/kernel/drivers/scsi/smartpqi/smartpqi.ko.xz
/lib/modules/3.10.0-1160.el7.x86_64/extra/smartpqi/smartpqi.ko
/lib/modules/3.10.0-957.12.1.el7.x86_64/kernel/drivers/scsi/smartpqi/smartpqi.ko.xz

readlink -e /lib/modules/3.10.0-1160.2.2.el7.x86_64/weak-updates/smartpqi/smartpqi.ko
/usr/lib/modules/3.10.0-1160.el7.x86_64/extra/smartpqi/smartpqi.ko
</code></pre>
<h4 id="jsmeix_commented_at_2021-09-15_1313"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2677#issuecomment-920007195">2021-09-15 13:13</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-09-15_1313" title="Permanent link">&para;</a></h4>
<p>I really hate symbolic links and what comes out when using them :-(</p>
<p>Here it seems things work when <code>cp -L</code> is used to deal with symbolic
links<br />
but things fail when <code>readlink -e</code> is used to deal with symbolic links.</p>
<p>Furthermore in the <code>MODULES=( 'all_modules' )</code> case<br />
we don't call <code>cp -L</code> but <code>cp -a</code> which preserves links<br />
so I wonder why it worked with <code>MODULES=( 'all_modules' )</code>?</p>
<p>Additionally it looks as if there is some kernel module version
inconsistency<br />
because 3.10.0-1160.2.2.el7.x86_64 is not same as
3.10.0-1160.el7.x86_64<br />
which might be the reason why</p>
<pre><code>depmod -b /var/tmp/rear.OqgFTxNJRXbrtFI/rootfs -v 3.10.0-1160.2.2.el7.x86_64
</code></pre>
<p>could not generate sufficient module dependencies because<br />
tg3 and smartpqi are under <code>/usr/lib/modules/3.10.0-1160.el7.x86_64/</code><br />
and not under <code>/usr/lib/modules/3.10.0-1160.2.2.el7.x86_64/</code><br />
where all other kernel modules are.</p>
<h4 id="hpannenb_commented_at_2021-09-15_1323"><img src="https://avatars.githubusercontent.com/u/13567759?u=b037e492e58a5f63f35277b3606d500cd622c8ed&v=4" width="50"><a href="https://github.com/hpannenb">hpannenb</a> commented at <a href="https://github.com/rear/rear/issues/2677#issuecomment-920015132">2021-09-15 13:23</a>:<a class="headerlink" href="#hpannenb_commented_at_2021-09-15_1323" title="Permanent link">&para;</a></h4>
<p>@jmeix I do not know the details but there is no known inconsistency.
The links etc. might have been a side effect of the <code>weak-updates</code> (???)
performed with upgrading the kernel from RHEL 7.x to 7.9.</p>
<p>Using an <code>echo</code>instead of a <code>readlink -e</code> in
<a href="https://github.com/rear/rear/blob/master/usr/share/rear/build/GNU/Linux/400_copy_modules.sh#L64">https://github.com/rear/rear/blob/master/usr/share/rear/build/GNU/Linux/400_copy_modules.sh#L64</a><br />
shows the following in the build area which looks good to me:</p>
<pre><code>depmod -n -b /var/tmp/rear.OP8tLd6LP49WAL8/rootfs/ -v 3.10.0-1160.2.2.el7.x86_64 | egrep "tg3|smartpqi" | head -10
/var/tmp/rear.OP8tLd6LP49WAL8/rootfs//lib/modules/3.10.0-1160.2.2.el7.x86_64/weak-updates/smartpqi/smartpqi.ko needs "sas_port_alloc_num": /var/tmp/rear.OP8tLd6LP49WAL8/rootfs//lib/modules/3.10.0-1160.2.2.el7.x86_64/kernel/drivers/scsi/scsi_transport_sas.ko.xz
/var/tmp/rear.OP8tLd6LP49WAL8/rootfs//lib/modules/3.10.0-1160.2.2.el7.x86_64/weak-updates/tg3/tg3.ko needs "ptp_clock_index": /var/tmp/rear.OP8tLd6LP49WAL8/rootfs//lib/modules/3.10.0-1160.2.2.el7.x86_64/kernel/drivers/ptp/ptp.ko.xz
weak-updates/smartpqi/smartpqi.ko: kernel/drivers/scsi/scsi_transport_sas.ko.xz
weak-updates/tg3/tg3.ko: kernel/drivers/ptp/ptp.ko.xz kernel/drivers/pps/pps_core.ko.xz
alias pci:v00009005d0000028Fsv*sd*bc*sc*i* smartpqi
alias pci:v00009005d0000028Fsv00001458sd00001000bc*sc*i* smartpqi
...
</code></pre>
<p>P.S.: @jsmeix After booting the created ISO into the rescue environment
modules were loaded and NICs and harddisks were shown/enabled. So the
<code>echo</code>made it work in my usecase.</p>
<h4 id="jsmeix_commented_at_2021-09-15_1328"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2677#issuecomment-920019156">2021-09-15 13:28</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-09-15_1328" title="Permanent link">&para;</a></h4>
<p>@pcahyna @rmetrich<br />
could you please have a look here?</p>
<p>In particular whether or not the kernel modules files and directories<br />
and their symlinks are correct here for RHEL 7.9.</p>
<p>On my openSUSE Leap 15.2 homeoffice laptop<br />
I have neither symlinks in /lib/modules nor a /usr/lib/modules
directory<br />
so I cannot easily reproduce things.</p>
<h4 id="jsmeix_commented_at_2021-09-15_1334"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2677#issuecomment-920023851">2021-09-15 13:34</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-09-15_1334" title="Permanent link">&para;</a></h4>
<p>@hpannenb<br />
I will further enhance the modinfo_filename function<br />
to make things work fail-safe also in cases like this one.<br />
I want to keep that the modinfo_filename function exits with non-zero
exit code<br />
if $module_filename is a danging symlink or otherwise invalid.<br />
I think I call <code>readlink -e $module_filename</code> only as a test<br />
and if that succeeds I output with plain <code>echo $module_filename</code><br />
and leave it to <code>cp -L</code> to follow symbolic links.</p>
<h4 id="pcahyna_commented_at_2021-09-15_1345"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/2677#issuecomment-920032927">2021-09-15 13:45</a>:<a class="headerlink" href="#pcahyna_commented_at_2021-09-15_1345" title="Permanent link">&para;</a></h4>
<p>@hpannenb where do
<code>/usr/lib/modules/3.10.0-1160.el7.x86_64/extra/smartpqi/smartpqi.ko</code> and
<code>/usr/lib/modules/3.10.0-1160.el7.x86_64/extra/tg3/tg3.ko</code> come from? I
am surprised that you have modules in the <code>extra</code> directory. Are those
vendor-supplied drivers, overriding those that are packaged with the
kernel RPM?</p>
<h4 id="hpannenb_commented_at_2021-09-15_1354"><img src="https://avatars.githubusercontent.com/u/13567759?u=b037e492e58a5f63f35277b3606d500cd622c8ed&v=4" width="50"><a href="https://github.com/hpannenb">hpannenb</a> commented at <a href="https://github.com/rear/rear/issues/2677#issuecomment-920040748">2021-09-15 13:54</a>:<a class="headerlink" href="#hpannenb_commented_at_2021-09-15_1354" title="Permanent link">&para;</a></h4>
<p>@pcahyna I suppose they were installed by the HPE SPP RPMs that I had to
apply. So it is not RHEL based but side loaded "officially" from HPE's
packages:</p>
<pre><code>rpm -qa | egrep "tg3|smartpqi"
kmod-tg3-3.139b-1.rhel7u9.x86_64
kmod-smartpqi-2.1.8-040.rhel7u9.x86_64
</code></pre>
<p>and</p>
<pre><code>rpm -ql kmod-tg3-3.139b-1.rhel7u9.x86_64
/etc/depmod.d/tg3.conf
/lib/modules/3.10.0-1160.el7.x86_64
/lib/modules/3.10.0-1160.el7.x86_64/extra
/lib/modules/3.10.0-1160.el7.x86_64/extra/tg3
/lib/modules/3.10.0-1160.el7.x86_64/extra/tg3/tg3.ko
/usr/share/smartupdate/kmod-tg3/component.xml

rpm -ql kmod-smartpqi-2.1.8-040.rhel7u9.x86_64
/etc/depmod.d/smartpqi.conf
/etc/dracut.conf.d/smartpqi.conf
/lib/modules/3.10.0-1160.el7.x86_64
/lib/modules/3.10.0-1160.el7.x86_64/extra
/lib/modules/3.10.0-1160.el7.x86_64/extra/smartpqi
/lib/modules/3.10.0-1160.el7.x86_64/extra/smartpqi/smartpqi.ko
/usr/share/smartupdate/kmod-smartpqi/component.xml
</code></pre>
<h4 id="pcahyna_commented_at_2021-09-15_1358"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/2677#issuecomment-920044062">2021-09-15 13:58</a>:<a class="headerlink" href="#pcahyna_commented_at_2021-09-15_1358" title="Permanent link">&para;</a></h4>
<p>I suspect that there might lie the problem, but I am not that familiar
with drivers in RHEL, in particular with third-party ones overriding the
distributed ones with the same name (indeed, there are modules of the
same name in the kernel package). @rmetrich do you know whether that's
supported, and if so how that's supposed to work, please?</p>
<h4 id="hpannenb_commented_at_2021-09-15_1442"><img src="https://avatars.githubusercontent.com/u/13567759?u=b037e492e58a5f63f35277b3606d500cd622c8ed&v=4" width="50"><a href="https://github.com/hpannenb">hpannenb</a> commented at <a href="https://github.com/rear/rear/issues/2677#issuecomment-920083904">2021-09-15 14:42</a>:<a class="headerlink" href="#hpannenb_commented_at_2021-09-15_1442" title="Permanent link">&para;</a></h4>
<blockquote>
<p>@hpannenb<br />
I will further enhance the modinfo_filename function<br />
to make things work fail-safe also in cases like this one.<br />
I want to keep that the modinfo_filename function exits with non-zero
exit code<br />
if $module_filename is a danging symlink or otherwise invalid.<br />
I think I call <code>readlink -e $module_filename</code> only as a test<br />
and if that succeeds I output with plain <code>echo $module_filename</code><br />
and leave it to <code>cp -L</code> to follow symbolic links.</p>
</blockquote>
<p>@jsmeix at least the <code>readlink -e</code> to <code>echo</code>change did the job for my
use case.</p>
<h4 id="github-actions_commented_at_2021-11-15_0209"><img src="https://avatars.githubusercontent.com/in/15368?v=4" width="50"><a href="https://github.com/apps/github-actions">github-actions</a> commented at <a href="https://github.com/rear/rear/issues/2677#issuecomment-968454170">2021-11-15 02:09</a>:<a class="headerlink" href="#github-actions_commented_at_2021-11-15_0209" title="Permanent link">&para;</a></h4>
<p>Stale issue message</p>
<h4 id="hpannenb_commented_at_2021-11-22_1753"><img src="https://avatars.githubusercontent.com/u/13567759?u=b037e492e58a5f63f35277b3606d500cd622c8ed&v=4" width="50"><a href="https://github.com/hpannenb">hpannenb</a> commented at <a href="https://github.com/rear/rear/issues/2677#issuecomment-975775899">2021-11-22 17:53</a>:<a class="headerlink" href="#hpannenb_commented_at_2021-11-22_1753" title="Permanent link">&para;</a></h4>
<p>Quiet a nasty bot closing my beloved but yet not fixed issue... :-)</p>
<h4 id="jsmeix_commented_at_2021-11-23_0707"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2677#issuecomment-976212857">2021-11-23 07:07</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-11-23_0707" title="Permanent link">&para;</a></h4>
<p>Quiet a friendly human reopening your beloved but yet not fixed issue...
:-)</p>
<h4 id="jsmeix_commented_at_2021-12-16_1351"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2677#issuecomment-995836532">2021-12-16 13:51</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-12-16_1351" title="Permanent link">&para;</a></h4>
<p>FYI:<br />
There are some more issues in the specific modules including code<br />
see
<a href="https://github.com/rear/rear/pull/2728#issuecomment-995799489">https://github.com/rear/rear/pull/2728#issuecomment-995799489</a></p>
<h4 id="hpannenb_commented_at_2021-12-16_1931"><img src="https://avatars.githubusercontent.com/u/13567759?u=b037e492e58a5f63f35277b3606d500cd622c8ed&v=4" width="50"><a href="https://github.com/hpannenb">hpannenb</a> commented at <a href="https://github.com/rear/rear/issues/2677#issuecomment-996116226">2021-12-16 19:31</a>:<a class="headerlink" href="#hpannenb_commented_at_2021-12-16_1931" title="Permanent link">&para;</a></h4>
<blockquote>
<p>...I think I call <code>readlink -e $module_filename</code> only as a test and if
that succeeds I output with plain <code>echo $module_filename</code> and leave it
to <code>cp -L</code> to follow symbolic links.</p>
</blockquote>
<p>@jsmeix I would support Your approach since <code>readlink -e</code> would just
test for a broken kernel module link instead of renaming the entire
pathname in use for such kind of soft-linked kernel modules.</p>
<h4 id="jsmeix_commented_at_2021-12-20_1157"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2677#issuecomment-997859219">2021-12-20 11:57</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-12-20_1157" title="Permanent link">&para;</a></h4>
<p>@nolocimes reported<br />
<a href="https://github.com/rear/rear/issues/2615#issuecomment-997058554">https://github.com/rear/rear/issues/2615#issuecomment-997058554</a><br />
and that made me finally understand what is wrong with<br />
using the <code>readlink -e</code> output:</p>
<pre><code># cd /tmp
# mkdir issue2677
# cd issue2677

# mkdir thisdir
# echo this &gt;thisdir/thisfile
# chmod a+rwx thisdir/thisfile

# mkdir thatdir
# cd thatdir/
# ln -s ../thisdir/thisfile thisfilesymlink
# cd ..

# mkdir otherdir

# cp -vL thatdir/thisfilesymlink otherdir
'thatdir/thisfilesymlink' -&gt; 'otherdir/thisfilesymlink'

# cp -v $( readlink -e thatdir/thisfilesymlink ) otherdir
'/tmp/issue2677/thisdir/thisfile' -&gt; 'otherdir/thisfile'

# mkdir otherdir2

# cp -vaL thatdir/thisfilesymlink otherdir2
'thatdir/thisfilesymlink' -&gt; 'otherdir2/thisfilesymlink'

# cp -vaL $( readlink -e thatdir/thisfilesymlink ) otherdir2
'/tmp/issue2677/thisdir/thisfile' -&gt; 'otherdir2/thisfile'

# mkdir otherdir3

# cp -vaL --parents thatdir/thisfilesymlink otherdir3
thatdir -&gt; otherdir3/thatdir
'thatdir/thisfilesymlink' -&gt; 'otherdir3/thatdir/thisfilesymlink'

# cp -vaL --parents $( readlink -e thatdir/thisfilesymlink ) otherdir3
/tmp -&gt; otherdir3/tmp
/tmp/issue2677 -&gt; otherdir3/tmp/issue2677
/tmp/issue2677/thisdir -&gt; otherdir3/tmp/issue2677/thisdir
'/tmp/issue2677/thisdir/thisfile' -&gt; 'otherdir3/tmp/issue2677/thisdir/thisfile'

# find thisdir thatdir otherdir otherdir2 otherdir3 -ls
... drwxr-xr-x ... 4096 Dec 20 12:16 thisdir
... -rwxrwxrwx ...    5 Dec 20 12:16 thisdir/thisfile
... drwxr-xr-x ... 4096 Dec 20 12:17 thatdir
... lrwxrwxrwx ...   19 Dec 20 12:17 thatdir/thisfilesymlink -&gt; ../thisdir/thisfile
... drwxr-xr-x ... 4096 Dec 20 12:51 otherdir
... -rwxr-xr-x ...    5 Dec 20 12:50 otherdir/thisfilesymlink
... -rwxr-xr-x ...    5 Dec 20 12:51 otherdir/thisfile
... drwxr-xr-x ... 4096 Dec 20 12:51 otherdir2
... -rwxrwxrwx ...    5 Dec 20 12:16 otherdir2/thisfilesymlink
... -rwxrwxrwx ...    5 Dec 20 12:16 otherdir2/thisfile
... drwxr-xr-x ... 4096 Dec 21 10:10 otherdir3
... drwxr-xr-x ... 4096 Dec 20 12:17 otherdir3/thatdir
... -rwxrwxrwx ...    5 Dec 20 12:16 otherdir3/thatdir/thisfilesymlink
... drwxrwxrwt ... 4096 Dec 21 10:00 otherdir3/tmp
... drwxr-xr-x ... 4096 Dec 21 10:09 otherdir3/tmp/issue2677
... drwxr-xr-x ... 4096 Dec 20 12:16 otherdir3/tmp/issue2677/thisdir
... -rwxrwxrwx ...    5 Dec 20 12:16 otherdir3/tmp/issue2677/thisdir/thisfile
</code></pre>
<p>Using <code>cp -L</code> copies the symlink taget content<br />
as a new regular file with file name as the name of the symlink.</p>
<p>Using the <code>readlink -e</code> output copies the symlink target content<br />
as a new regular file with file name as the symlink target file name.</p>
<p>So the difference is the file name of the copied content<br />
where <code>cp -L</code> preserves its original name<br />
while using the <code>readlink -e</code> output changes the name<br />
so the copied content can no longer be found under its original name.</p>
<p>Using additionaly <code>cp ... --parents</code> makes the result even worse<br />
when the <code>readlink -e</code> output is used because also the sub-directory<br />
structure becomes different so the copied content can no longer<br />
be found under its original sub-directory under its original name.</p>
<h4 id="jsmeix_commented_at_2021-12-20_1230"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2677#issuecomment-997882993">2021-12-20 12:30</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-12-20_1230" title="Permanent link">&para;</a></h4>
<p><a href="https://github.com/rear/rear/pull/2731">https://github.com/rear/rear/pull/2731</a><br />
is a not yet tested attempt to fix this issue.</p>
<h4 id="hpannenb_commented_at_2021-12-20_1426"><img src="https://avatars.githubusercontent.com/u/13567759?u=b037e492e58a5f63f35277b3606d500cd622c8ed&v=4" width="50"><a href="https://github.com/hpannenb">hpannenb</a> commented at <a href="https://github.com/rear/rear/issues/2677#issuecomment-997971990">2021-12-20 14:26</a>:<a class="headerlink" href="#hpannenb_commented_at_2021-12-20_1426" title="Permanent link">&para;</a></h4>
<p>@jsmeix I successfully tested Your branch <code>jsmeix-fix-modinfo_filename</code>
for my usecase: I could boot the rescue image having access to both NIC
and SmartController / Disks. So IMHO those changes solve my issue.</p>
<p>P.S.: Under <code>/usr/lib/modules/</code> the <code>weak-updates</code> for the side-loaded
modules are available in the image now.</p>
<h4 id="jsmeix_commented_at_2021-12-21_0929"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2677#issuecomment-998615633">2021-12-21 09:29</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-12-21_0929" title="Permanent link">&para;</a></h4>
<p>I updated
<a href="https://github.com/rear/rear/issues/2677#issuecomment-997859219">https://github.com/rear/rear/issues/2677#issuecomment-997859219</a><br />
how using <code>cp ... --parents</code> makes it worse when the 'readlink -e'
output is used.</p>
<h4 id="jsmeix_commented_at_2021-12-21_1420"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2677#issuecomment-998817764">2021-12-21 14:20</a>:<a class="headerlink" href="#jsmeix_commented_at_2021-12-21_1420" title="Permanent link">&para;</a></h4>
<p>With
<a href="https://github.com/rear/rear/pull/2731">https://github.com/rear/rear/pull/2731</a>
merged<br />
this particular issue is fixed.</p>
<p>There are still other issues with
build/GNU/Linux/400_copy_modules.sh<br />
see
<a href="https://github.com/rear/rear/issues/2727">https://github.com/rear/rear/issues/2727</a><br />
and
<a href="https://github.com/rear/rear/pull/2728">https://github.com/rear/rear/pull/2728</a></p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2024 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2021-09-14.2677.issue.closed.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/rear/rear-user-guide" class="fa fa-code-fork" style="color: #fcfcfc"> rear/rear-user-guide</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
