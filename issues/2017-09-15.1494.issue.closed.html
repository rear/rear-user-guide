<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#1494 Issue closed: Recovery system libraries not consistent (e.g. when /lib64/noelision/libpthread is used kernel panics because init fails) - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#1494 Issue closed: Recovery system libraries not consistent (e.g. when /lib64/noelision/libpthread is used kernel panics because init fails)";
        var mkdocs_page_input_path = "issues/2017-09-15.1494.issue.closed.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#1494 Issue closed: Recovery system libraries not consistent (e.g. when /lib64/noelision/libpthread is used kernel panics because init fails)</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="1494_issue_closed_recovery_system_libraries_not_consistent_eg_when_lib64noelisionlibpthread_is_used_kernel_panics_because_init_fails"><a href="https://github.com/rear/rear/issues/1494">#1494 Issue</a> <code>closed</code>: Recovery system libraries not consistent (e.g. when /lib64/noelision/libpthread is used kernel panics because init fails)<a class="headerlink" href="#1494_issue_closed_recovery_system_libraries_not_consistent_eg_when_lib64noelisionlibpthread_is_used_kernel_panics_because_init_fails" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>bug</code>, <code>support / question</code>, <code>fixed / solved / done</code></p>
<h4 id="linuxstar2017_opened_issue_at_2017-09-15_1041"><img src="https://avatars.githubusercontent.com/u/31645285?v=4" width="50"><a href="https://github.com/linuxstar2017">linuxstar2017</a> opened issue at <a href="https://github.com/rear/rear/issues/1494">2017-09-15 10:41</a>:<a class="headerlink" href="#linuxstar2017_opened_issue_at_2017-09-15_1041" title="Permanent link">&para;</a></h4>
<h4 id="relax-and-recover_rear_issue_template">Relax-and-Recover (ReaR) Issue Template<a class="headerlink" href="#relax-and-recover_rear_issue_template" title="Permanent link">&para;</a></h4>
<p>Fill in the following items before submitting a new issue<br />
(quick response is not guaranteed with free support):</p>
<ul>
<li>rear version (/usr/sbin/rear -V):</li>
</ul>
<pre>
l9995988:~ # rpm -qa | grep -i rear
rear-1.18-3.x86_64
</pre>

<ul>
<li>OS version (cat /etc/rear/os.conf or lsb_release -a):<br />
    SLES12</li>
</ul>
<pre>
9995988:~ # uname -a
Linux l9995988 4.4.49-92.11.1.12564.2.PTF.1027273-default #1 SMP Thu Mar 9 10:34:40 UTC 2017 (6122209) x86_64 x86_64 x86_64 GNU/Linux
</pre>

<ul>
<li>rear configuration files (cat /etc/rear/site.conf or cat
    /etc/rear/local.conf):</li>
</ul>
<pre>
l9995988:~ # cat /etc/rear/local.conf
MODULES=af_packet iscsi_ibft iscsi_boot_sysfs vmw_vsock_vmci_transport vsock coretemp crct10dif_pclmul crc32_pclmul drbg ansi_cprng aesni_intel aes_x86_64 ppdev lrw gf128mul glue_helper ablk_helper cryptd i2c_piix4 joydev pcspkr shpchp mptctl vmw_balloon e1000 vmw_vmci battery parport_pc parport acpi_cpufreq fjes processor ac xfs libcrc32c sr_mod sd_mod cdrom ata_generic crc32c_intel serio_raw drm_kms_helper syscopyarea sysfillrect sysimgblt fb_sys_fops ttm mptspi drm scsi_transport_spi mptscsih mptbase floppy ata_piix ahci libahci libata button dm_mirror dm_region_hash dm_log sg dm_multipath dm_mod scsi_dh_rdac scsi_dh_emc scsi_dh_alua scsi_mod autofs4 
BACKUP=NSR
OUTPUT=ISO
ISO_DIR=/var/lib/rear/output
ISO_PREFIX=t32-rescue-l9995988
ISO_VOLID=t32-rescue-l9995988
AUTOEXCLUDE_PATH=( /media /tmp )
AUTOEXCLUDE_AUTOFS=y
AUTOEXCLUDE_MULTIPATH=y
AUTOEXCLUDE_DISKS=y
NSR_RETENTION_TIME="1 month"
NSR_POOL_NAME=REAR
COPY_AS_IS=(${COPY_AS_IS[@]} /lib64/noelision/)
</pre>

<ul>
<li>Are you using legacy BIOS or UEFI boot?<br />
    legacy BIOS</li>
<li>Brief description of the issue:<br />
    ReaR ISO recovery image leads to a kernel kernel panic.<br />
    /init: error while loading shared library: libpthread.s0.0: cannot
    open shared object file<br />
    Problem can be reproduced on physical and virtual servers and also<br />
    with ReaR version 2.x, found on OBS<br />
    Even we adapted the rear conf to include /lib64/noelision (it is
    actually copied over),<br />
    libpthread is not found</li>
<li>Work-around, if any:<br />
    Remove /lib64/noelision from /etc/ld.so.conf<br />
    Execute ldconfig<br />
    Create rescue ISO</li>
</ul>
<h4 id="jsmeix_commented_at_2017-09-15_1119"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1494#issuecomment-329754377">2017-09-15 11:19</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-09-15_1119" title="Permanent link">&para;</a></h4>
<p>@linuxstar2017<br />
I don't know about noelision stuff (and quick Googling did not<br />
show something explanatory - only various bug reports).</p>
<p>Nevertheless I try some guesswork:<br />
On my SLES12 system I have</p>
<pre>
e205:~/rear.master # find /lib64 | wc -l
234
</pre>

<p>but in the matching ReaR recovery system I have only</p>
<pre>
RESCUE e205:~ # find /lib64 | wc -l
71
</pre>

<p>In general the ReaR recovery system is by default very minimal<br />
so that this or that additional stuff might be missing which<br />
leads to this error.</p>
<p>@linuxstar2017<br />
could you try if</p>
<pre>
COPY_AS_IS=( "${COPY_AS_IS[@]}" /lib64/ )
</pre>

<p>helps?<br />
With that I get in my recovery system:</p>
<pre>
RESCUE e205:~ # find /lib64 | wc -l
230
</pre>

<p>That looks better but it is still 4 files less<br />
that in the original system which are those links</p>
<pre>
/lib64/libfuse.so.2 -> /usr/lib64/libfuse.so.2
/lib64/libfuse.so.2.9.3 -> /usr/lib64/libfuse.so.2.9.3
/lib64/libss.so.2 -> /usr/lib64/libss.so.2
/lib64/libss.so.2.0 -> /usr/lib64/libss.so.2.0
</pre>

<p>It seems there is a general problem<br />
with links and COPY_AS_IS ...<br />
but I guess that is not related to this issue here.</p>
<p>@linuxstar2017 onyl FYI<br />
you might have a possibly severe syntax issue in your</p>
<pre>
COPY_AS_IS=(${COPY_AS_IS[@]} /lib64/noelision/)
</pre>

<p>In almost all cases one must use quoted "${arr[@]}", cf.<br />
<a href="https://github.com/rear/rear/issues/1068">https://github.com/rear/rear/issues/1068</a><br />
and see in default.conf</p>
<pre>
# Some variables are actually bash arrays and should be treated with care.
# Use VAR=() to set an empty array.
# Use VAR=( "${VAR[@]}" 'value' ) to add a fixed value to an array.
# Use VAR=( "${VAR[@]}" "$var" ) to add a variable value to an array.
# Whether or not the latter case works as intended depends on when and
# how "$var" is set and evaluated by the Relax-and-Recover scripts.
# In general using ${VAR[*]} is problematic and using ${VAR[@]} without
# double-quotes is also problematic, see 'Arrays' in "man bash" and
# see https://github.com/rear/rear/issues/1068 for some examples.
</pre>

<h4 id="jsmeix_commented_at_2017-09-15_1200"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1494#issuecomment-329761835">2017-09-15 12:00</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-09-15_1200" title="Permanent link">&para;</a></h4>
<p>@linuxstar2017<br />
can you explain to me how I could reproduce it<br />
on a SLES12 virtual QEMU/KVM machine?<br />
On my current SLES12 virtual QEMU/KVM machine<br />
I do not have any noelision in my /etc/ld.so.conf.</p>
<h4 id="linuxstar2017_commented_at_2017-09-15_1224"><img src="https://avatars.githubusercontent.com/u/31645285?v=4" width="50"><a href="https://github.com/linuxstar2017">linuxstar2017</a> commented at <a href="https://github.com/rear/rear/issues/1494#issuecomment-329767446">2017-09-15 12:24</a>:<a class="headerlink" href="#linuxstar2017_commented_at_2017-09-15_1224" title="Permanent link">&para;</a></h4>
<p>@jsmeix</p>
<p>Sure ...<br />
(on my lab server)</p>
<p>denbvslnxs1:/lib64/noelision # ls<br />
libpthread-2.22.so libpthread.so.0<br />
denbvslnxs1:/lib64/noelision # rpm -q --whatprovides
/lib64/noelision/libpthread-2.22.so<br />
glibc-2.22-61.3.x86_64</p>
<p>Normally, you don't need it !</p>
<p>But in our case ..</p>
<p>/etc/ld.so.conf need to have the "noelision" library path at first to
prevent<br />
application crashes, which are caused by bad coded applications (like
Legato Networker's<br />
nsrexecd) and lead to a double-unlock.</p>
<p>I sent you in parallel a mail (in German) with all the background ...</p>
<h4 id="jsmeix_commented_at_2017-09-15_1322"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1494#issuecomment-329781102">2017-09-15 13:22</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-09-15_1322" title="Permanent link">&para;</a></h4>
<p>@linuxstar2017<br />
I also have the noelision library in /lib64/noelision/<br />
but I do not have any noelision in my /etc/ld.so.conf<br />
so that I like to know what exact "noelision" library path<br />
you have in your /etc/ld.so.conf that might help me<br />
to reproduce it - preferably just post your whole<br />
/etc/ld.so.conf here so that I do not need to guess.</p>
<p>Additionally to really reproduce it it seems one needs<br />
"a badly coded application" which requires the noelision library.<br />
Do you know a free software that requires the noelision library?</p>
<h4 id="linuxstar2017_commented_at_2017-09-15_1334"><img src="https://avatars.githubusercontent.com/u/31645285?v=4" width="50"><a href="https://github.com/linuxstar2017">linuxstar2017</a> commented at <a href="https://github.com/rear/rear/issues/1494#issuecomment-329784111">2017-09-15 13:34</a>:<a class="headerlink" href="#linuxstar2017_commented_at_2017-09-15_1334" title="Permanent link">&para;</a></h4>
<p>@jsmeix</p>
<pre>
l9995988:~ # cat /etc/ld.so.conf
/lib64/noelision
/usr/local/lib64
/usr/local/lib
include /etc/ld.so.conf.d/*.conf
# /lib64, /lib, /usr/lib64 and /usr/lib gets added
# automatically by ldconfig after parsing this file.
# So, they do not need to be listed.
</pre>

<p>I have no clue of any free sw, which requires<br />
this .. but for me, you don't need that step<br />
of verification ... the original issue need just<br />
to be fixed ... to do no kernel panic anymore<br />
and boot from recovery ISO.</p>
<p>Tests for the EMC Networker Recovery need<br />
to be done anyway later by the customer,<br />
as he owns the license and EMC is the original<br />
cause of the issues.</p>
<p>Just IMHO</p>
<h4 id="jsmeix_commented_at_2017-09-15_1356"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1494#issuecomment-329789991">2017-09-15 13:56</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-09-15_1356" title="Permanent link">&para;</a></h4>
<p>@linuxstar2017<br />
thanks - and have a nice weekend!</p>
<h4 id="jsmeix_commented_at_2017-09-18_1127"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1494#issuecomment-330192635">2017-09-18 11:27</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-09-18_1127" title="Permanent link">&para;</a></h4>
<p>I can reproduce it and<br />
I know a working workaround with the code as is and<br />
I know the solution (which needs a fix in a script):</p>
<p>I use always</p>
<pre>
KEEP_BUILD_DIR="yes"
</pre>

<p>so that I can 'chroot' into the ReaR recovery system<br />
directly on the system where I made it with "rear mkrescue"<br />
without the need to boot the ReaR recovery system<br />
on another (virtual) machine only to do some tests<br />
in the ReaR recovery system which is impossible<br />
when the ReaR recovery system fails to come up<br />
like here when the kernel panics because init fails.</p>
<p>I can reproduce it with</p>
<pre>
COPY_AS_IS=( "${COPY_AS_IS[@]}" /lib64/noelision/ )
</pre>

<p>I make a ReaR recovery system and<br />
'chroot' into it and do some tests therein:</p>
<pre>
e205:~/rear.master # usr/sbin/rear -d -D mkrescue
...
Creating recovery/rescue system initramfs/initrd
...
You should also rm -Rf /tmp/rear.mqtc7xtv52uuRgu

e205:~/rear.master # chroot /tmp/rear.mqtc7xtv52uuRgu/rootfs/

bash-4.3# export LC_ALL=C LANG=C

bash-4.3# ldd /bin/sort | grep pthread
grep: error while loading shared libraries: libpthread.so.0: cannot open shared object file: No such file or directory

bash-4.3# echo -e 'foo\nbar\nbaz' | sort
sort: error while loading shared libraries: libpthread.so.0: cannot open shared object file: No such file or directory
</pre>

<p>The working workaround without code changes is</p>
<pre>
COPY_AS_IS=( "${COPY_AS_IS[@]}" /lib64/ )
</pre>

<p>cf. "could you try if ... helps" in my above<br />
<a href="https://github.com/rear/rear/issues/1494#issuecomment-329754377">https://github.com/rear/rear/issues/1494#issuecomment-329754377</a></p>
<p>With that I get:</p>
<pre>
e205:~/rear.master # usr/sbin/rear -d -D mkrescue
...
Creating recovery/rescue system initramfs/initrd
...
You should also rm -Rf /tmp/rear.ICBQgUUoYcvDCap

e205:~/rear.master # chroot /tmp/rear.ICBQgUUoYcvDCap/rootfs/

bash-4.3# export LC_ALL=C LANG=C

bash-4.3# ldd /bin/sort | grep pthread
        libpthread.so.0 => /lib64/libpthread.so.0 (0x00007fc6a7267000)

bash-4.3# echo -e 'foo\nbar\nbaz' | sort
bar
baz
foo
</pre>

<p>The solution (which needs a fix in a ReaR script) is<br />
to run 'ldconfig' inside the ReaR recovery system before<br />
"Creating recovery/rescue system initramfs/initrd ..."</p>
<pre>
e205:~/rear.master # chroot /tmp/rear.mqtc7xtv52uuRgu/rootfs/

bash-4.3# export LC_ALL=C LANG=C

bash-4.3# ldconfig -v | egrep 'noelision|pthread'
...
/lib64/noelision:
        libpthread.so.0 -> libpthread-2.22.so
bash-4.3# ldd /bin/sort | grep pthread
        libpthread.so.0 => /lib64/noelision/libpthread.so.0 (0x00007f295567a000)

bash-4.3# echo -e 'foo\nbar\nbaz' | sort
bar
baz
foo
</pre>

<p>@linuxstar2017<br />
verify with your customer that</p>
<pre>
COPY_AS_IS=( "${COPY_AS_IS[@]}" /lib64/ )
</pre>

<p>also works for him with his particular backup program<br />
(I cannot test if his particular backup program also works).</p>
<h4 id="jsmeix_commented_at_2017-09-18_1243"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1494#issuecomment-330207733">2017-09-18 12:43</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-09-18_1243" title="Permanent link">&para;</a></h4>
<p>At the end of<br />
usr/share/rear/build/GNU/Linux/390_copy_binaries_libraries.sh<br />
there is</p>
<pre>
#ldconfig $v -r "$ROOTFS_DIR" >&2 || Error "Could not configure libraries with ldconfig"
</pre>

<p>which would have helped in this case if it was enabled.</p>
<p>With this line enabled and</p>
<pre>
COPY_AS_IS=( "${COPY_AS_IS[@]}" /lib64/noelision/ )
</pre>

<p>everything works for me.</p>
<p>@linuxstar2017<br />
verify with your customer that enabling the "#ldconfig ..."<br />
line at the end of build/GNU/Linux/390_copy_binaries_libraries.sh<br />
is sufficient so that it also works with only</p>
<pre>
COPY_AS_IS=( "${COPY_AS_IS[@]}" /lib64/noelision/ )
</pre>

<p>Because - as ususal :-( - there is not any comment that explains<br />
why the 'ldconfig' is disabled in 390_copy_binaries_libraries.sh<br />
I need to do forensics - but fortunately we have Git where</p>
<pre>
git log -p --follow usr/share/rear/build/GNU/Linux/390_copy_binaries_libraries.sh
</pre>

<p>shows that it was disabled via<br />
<a href="https://github.com/rear/rear/commit/d62a555fd3460a618e47e8a6c6288e13cbd940fb">https://github.com/rear/rear/commit/d62a555fd3460a618e47e8a6c6288e13cbd940fb</a><br />
which points to<br />
<a href="https://github.com/rear/rear/issues/772">https://github.com/rear/rear/issues/772</a><br />
and therein the reason behind is described in<br />
<a href="https://github.com/rear/rear/issues/772#issuecomment-183457540">https://github.com/rear/rear/issues/772#issuecomment-183457540</a><br />
and the commit<br />
<a href="https://github.com/rear/rear/commit/d62a555fd3460a618e47e8a6c6288e13cbd940fb">https://github.com/rear/rear/commit/d62a555fd3460a618e47e8a6c6288e13cbd940fb</a><br />
shows that the intent was to run 'ldconfig' in the booted<br />
recovery system but now as 'ldconfig -X' (WHY now the '-X'?)<br />
which is wrong because now it tries to boot the<br />
recovery system with inconsistent libraries configuration<br />
which can badly fail as in this case.</p>
<p>As far as I understand it the actually right solution seems<br />
to create a consistent libraries configuration at build-time<br />
of the recovery system with right confing files in the<br />
$ROOTFS_DIR/etc/ld.so.conf.d/ directory and<br />
Error out if that fails because that could mean<br />
the recovery system may fail to boot.</p>
<h4 id="schlomo_commented_at_2017-09-18_1319"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/issues/1494#issuecomment-330217766">2017-09-18 13:19</a>:<a class="headerlink" href="#schlomo_commented_at_2017-09-18_1319" title="Permanent link">&para;</a></h4>
<p>We actually have
<a href="../blob/master/usr/share/rear/build/default/980_verify_rootfs.sh">usr/share/rear/build/default/980_verify_rootfs.sh</a>
which does a <code>chroot</code> test.</p>
<p>It seems to me that we should improve this test to be more thorough. At
the moment it only checks <code>bash</code> which apparently does not have this
problem. Can you maybe expand the test there to be more thorough and to
also check for such problems?</p>
<h4 id="linuxstar2017_commented_at_2017-09-18_1340"><img src="https://avatars.githubusercontent.com/u/31645285?v=4" width="50"><a href="https://github.com/linuxstar2017">linuxstar2017</a> commented at <a href="https://github.com/rear/rear/issues/1494#issuecomment-330224625">2017-09-18 13:40</a>:<a class="headerlink" href="#linuxstar2017_commented_at_2017-09-18_1340" title="Permanent link">&para;</a></h4>
<p>Feedback:</p>
<p>Perfect, that change solved the issue ! Server is now recovering ....</p>
<p>Many thanks for your help, will now update the SR.....</p>
<h4 id="jsmeix_commented_at_2017-09-19_0753"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1494#issuecomment-330459391">2017-09-19 07:53</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-09-19_0753" title="Permanent link">&para;</a></h4>
<p>@linuxstar2017<br />
please be explicit so that I do not need to guess.<br />
If you do not invest your time to write explicit information<br />
others may not spend their time to investigate your issues.<br />
What change solved the issue?</p>
<pre>
COPY_AS_IS=( "${COPY_AS_IS[@]}" /lib64/ )
</pre>

<p>or</p>
<pre>
COPY_AS_IS=( "${COPY_AS_IS[@]}" /lib64/noelision/ )
</pre>

<p>plus in build/GNU/Linux/390_copy_binaries_libraries.sh</p>
<pre>
ldconfig $v -r "$ROOTFS_DIR" >&2 || Error " ..."
</pre>

<p>or did even both changes solve the issue?<br />
In the latter case what was the preferred way and why?<br />
I need such feedback to better understand user expectations.</p>
<h4 id="jsmeix_commented_at_2017-09-19_0756"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1494#issuecomment-330460262">2017-09-19 07:56</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-09-19_0756" title="Permanent link">&para;</a></h4>
<p>I reopen this issue because we still have a bug in ReaR<br />
that needs to be fixed.</p>
<p>@schlomo<br />
I will enhance build/default/980_verify_rootfs.sh<br />
but that is of secondary importance.</p>
<p>First and foremost I need some help how to implement correctly<br />
that the libraries in the recovery system are consistent because<br />
plain 'ldconfig $v -r "$ROOTFS_DIR"' seems to have<br />
unwanted side-effects
<a href="https://github.com/rear/rear/issues/772">https://github.com/rear/rear/issues/772</a></p>
<h4 id="linuxstar2017_commented_at_2017-09-19_0758"><img src="https://avatars.githubusercontent.com/u/31645285?v=4" width="50"><a href="https://github.com/linuxstar2017">linuxstar2017</a> commented at <a href="https://github.com/rear/rear/issues/1494#issuecomment-330460791">2017-09-19 07:58</a>:<a class="headerlink" href="#linuxstar2017_commented_at_2017-09-19_0758" title="Permanent link">&para;</a></h4>
<p>@jsmeix</p>
<p>Sorry, I was explicit ... but agreed, only in the SR solution comment:</p>
<p>ReaR adapted as per below:</p>
<p>File:<br />
/usr/share/rear/build/GNU/Linux/39_copy_binaries_libraries.sh:
ldconfig $v -r "$ROOTFS_DIR" &gt;&amp;2 || Error "Could not configure
libraries with ldconfig"<br />
==&gt; (line uncommented)</p>
<p>File:<br />
/etc/rear/local.conf: COPY_AS_IS=( "${COPY_AS_IS[@]}"
/lib64/noelision/ )<br />
==&gt; (/lib64/noelision added)</p>
<h4 id="schlomo_commented_at_2017-09-19_0804"><img src="https://avatars.githubusercontent.com/u/101384?v=4" width="50"><a href="https://github.com/schlomo">schlomo</a> commented at <a href="https://github.com/rear/rear/issues/1494#issuecomment-330462053">2017-09-19 08:04</a>:<a class="headerlink" href="#schlomo_commented_at_2017-09-19_0804" title="Permanent link">&para;</a></h4>
<p>@jsmeix thanks. ATM I only can offer a wild guess: The way how ReaR
copies libraries to the standard paths can mess up some setups to put
"override" libraries in special paths. To be 100% correct we might have
to:</p>
<ul>
<li>Take <code>ld.so.conf*</code> as it is</li>
<li>replicate the library directories when we copy libs</li>
<li>Have special code to handle known special cases</li>
</ul>
<h4 id="gdha_commented_at_2017-09-19_0939"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/issues/1494#issuecomment-330486060">2017-09-19 09:39</a>:<a class="headerlink" href="#gdha_commented_at_2017-09-19_0939" title="Permanent link">&para;</a></h4>
<p>@linuxstar2017 are you really sure it did not work with
<code>/usr/share/rear/build/GNU/Linux/39_copy_binaries_libraries.sh</code> and
leaving
<code>#ldconfig $v -r "$ROOTFS_DIR" &gt;&amp;2 || Error "Could not configure libraries with ldconfig"</code>
==&gt; (line <strong>commented</strong>)<br />
It worked like that for 1,5 year already with commented line. I suspect
the missing <code>/lib64/noelision/</code> was the real reason.<br />
However, we need to be sure.</p>
<h4 id="linuxstar2017_commented_at_2017-09-19_1004"><img src="https://avatars.githubusercontent.com/u/31645285?v=4" width="50"><a href="https://github.com/linuxstar2017">linuxstar2017</a> commented at <a href="https://github.com/rear/rear/issues/1494#issuecomment-330492425">2017-09-19 10:04</a>:<a class="headerlink" href="#linuxstar2017_commented_at_2017-09-19_1004" title="Permanent link">&para;</a></h4>
<p>@gdha<br />
At least this is , what we tried/tested .... after un-commenting the
ldconfig line, it worked,<br />
before not.</p>
<p>The addition of the library path was days before ... it was copied over
(verified),<br />
but failed nevertheless....</p>
<h4 id="jsmeix_commented_at_2017-09-19_1008"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1494#issuecomment-330493281">2017-09-19 10:08</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-09-19_1008" title="Permanent link">&para;</a></h4>
<p>@linuxstar2017<br />
I cannot read a "SR solution comment" and even more important:<br />
Nobody else from ReaR upstream can.</p>
<h4 id="jsmeix_commented_at_2017-09-19_1018"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1494#issuecomment-330495560">2017-09-19 10:18</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-09-19_1018" title="Permanent link">&para;</a></h4>
<p>@gdha<br />
you can reproduce it when you have<br />
/lib64/noelision/libpthread* libraries<br />
on your system.</p>
<p>Add a topmost line<br />
/lib64/noelision<br />
to your /etc/ld.so.conf cf.<br />
<a href="https://github.com/rear/rear/issues/1494#issuecomment-329784111">https://github.com/rear/rear/issues/1494#issuecomment-329784111</a><br />
and then do a 'ldconfig' so that you get on your system</p>
<pre>
# ldconfig -v | egrep 'libpthread|noelision'
...
/lib64/noelision:
        libpthread.so.0 -> libpthread-2.22.so
        libpthread.so.0 -> libpthread-2.22.so

# ldd /bin/sort | grep pthread
        libpthread.so.0 => /lib64/noelision/libpthread.so.0
</pre>

<p>I use /bin/sort as an example for a binary that is<br />
linked with libpthread which is now linked with<br />
the noelision version of libpthread.</p>
<p>Then reproduce it as I described in<br />
<a href="https://github.com/rear/rear/issues/1494#issuecomment-330192635">https://github.com/rear/rear/issues/1494#issuecomment-330192635</a></p>
<p>It worked like that for 1,5 year already with commented line<br />
because for 1,5 year already no ReaR user uses the<br />
noelision version of libpthread.</p>
<p>Simply put:<br />
As soon as a special libraries configuration is used,<br />
the libraries in the recovery system are likely inconsistent<br />
and when a library is involved where init is linked with,<br />
the recovery system fails to boot with kernel panic<br />
because init fails.</p>
<h4 id="gdha_commented_at_2017-09-19_1117"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/issues/1494#issuecomment-330508247">2017-09-19 11:17</a>:<a class="headerlink" href="#gdha_commented_at_2017-09-19_1117" title="Permanent link">&para;</a></h4>
<p>@jsmeix @linuxstar2017 Thank you both for the clear explanation of the
issue - now I'm following</p>
<h4 id="jsmeix_commented_at_2017-09-19_1428"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1494#issuecomment-330557699">2017-09-19 14:28</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-09-19_1428" title="Permanent link">&para;</a></h4>
<p>With
<a href="https://github.com/rear/rear/pull/1502">https://github.com/rear/rear/pull/1502</a>
merged<br />
issues like this one should now be avoided.</p>
<h4 id="jsmeix_commented_at_2017-09-26_1347"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1494#issuecomment-332203588">2017-09-26 13:47</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-09-26_1347" title="Permanent link">&para;</a></h4>
<p>The recovery system libraries are still not fully consistent,<br />
see
<a href="https://github.com/rear/rear/issues/1518">https://github.com/rear/rear/issues/1518</a>
but<br />
since
<a href="https://github.com/rear/rear/pull/1514">https://github.com/rear/rear/pull/1514</a>
is merged<br />
for programs (i.e. files in a .../bin/... or .../sbin/... directory)<br />
a missing library in the recovery system is now an Error.</p>
<h4 id="linuxstar2017_commented_at_2017-09-27_0633"><img src="https://avatars.githubusercontent.com/u/31645285?v=4" width="50"><a href="https://github.com/linuxstar2017">linuxstar2017</a> commented at <a href="https://github.com/rear/rear/issues/1494#issuecomment-332422981">2017-09-27 06:33</a>:<a class="headerlink" href="#linuxstar2017_commented_at_2017-09-27_0633" title="Permanent link">&para;</a></h4>
<p>O.K. let me ask more concrete ... what my customer need to know ....</p>
<p>When is the SUSE SLES-supported ReaR package able to work<br />
non-modfied ? As a consequence, customer expects a PTF or<br />
fix going upstream.</p>
<p>If no ETA or PTF (customer would challenge, why ?), what according<br />
to your experience, need the customer to implement to have current,
non-working<br />
situation corrected ?</p>
<p>For the given scenario ... including /lib64/noelision, a bootable
recovery image and<br />
working Networker recovery at the end .. pls. keep in mind, this is the
customers<br />
recovery environment, they rely on !</p>
<p>Many thanks ....</p>
<h4 id="jsmeix_commented_at_2017-09-27_0847"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1494#issuecomment-332453552">2017-09-27 08:47</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-09-27_0847" title="Permanent link">&para;</a></h4>
<p>@linuxstar2017</p>
<p>The fix is upstream:<br />
<a href="https://github.com/rear/rear/pull/1502">https://github.com/rear/rear/pull/1502</a><br />
<a href="https://github.com/rear/rear/issues/1494#issuecomment-330557699">https://github.com/rear/rear/issues/1494#issuecomment-330557699</a><br />
<a href="https://github.com/rear/rear/commit/6afc9a0a8b5b80429fb0aba545302c1af8ccbe70">https://github.com/rear/rear/commit/6afc9a0a8b5b80429fb0aba545302c1af8ccbe70</a></p>
<p>I do not understand why<br />
"customer ... have current, non-working situation"<br />
regardless of your<br />
<a href="https://github.com/rear/rear/issues/1494#issuecomment-330224625">https://github.com/rear/rear/issues/1494#issuecomment-330224625</a><br />
"that change solved the issue ! Server is now recovering"<br />
Why cannot the customer adapt his ReaR scripts?<br />
That's why ReaR is implemented as bash scripts, read<br />
"Disaster recovery with Relax-and-Recover (ReaR)" in<br />
<a href="https://en.opensuse.org/SDB:Disaster_Recovery">https://en.opensuse.org/SDB:Disaster_Recovery</a><br />
Regarding the upstream fix<br />
<a href="https://github.com/rear/rear/commit/6afc9a0a8b5b80429fb0aba545302c1af8ccbe70">https://github.com/rear/rear/commit/6afc9a0a8b5b80429fb0aba545302c1af8ccbe70</a><br />
When the customer uses an older ReaR version<br />
there is no LogPrintError function.<br />
In this case use the LogPrint function instead.</p>
<p>In general:</p>
<p>The public ReaR upstream GitHub is<br />
neither the right place for questions about SUSE's<br />
(or any company) official customer support handling<br />
nor for lecturing what people should "keep in mind"<br />
when working as ReaR upstream maintainers or contributors<br />
(where most of them do that even on a voluntary base).</p>
<p>The public ReaR upstream GitHub is the right place<br />
to report the plain facts about a ReaR issue<br />
to get the issue analyzed and ideally even fixed<br />
via direct communication with people who are here<br />
as ReaR upstream maintainers and contributors.<br />
This way an issue could get solved in a shorter time<br />
than via an indirectly working official company support.</p>
<p>The public ReaR upstream GitHub does not replace<br />
an official company support but it can complement it<br />
by providing an efficient direct communication with the<br />
ReaR upstream maintainers and contributors plus<br />
either fixes so that all official company support teams<br />
could get the fixes from the public ReaR upstream GitHub<br />
or alternatively by providing a public visible explanation<br />
why a particular issue cannot be fixed in ReaR<br />
(e.g. when the cause of an issue is not "inside" ReaR).</p>
<h4 id="gdha_commented_at_2017-09-27_0947"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/issues/1494#issuecomment-332469064">2017-09-27 09:47</a>:<a class="headerlink" href="#gdha_commented_at_2017-09-27_0947" title="Permanent link">&para;</a></h4>
<p>@linuxstar2017 As @jsmeix said for ReaR packages from SLES itself you
should open a software case at SuSE support center, and do not bother us
with these kind of questions as we have nothing to say what SuSE does or
has in the pipe-line with ReaR in their products.<br />
We are volunteers working on public ReaR upstream project and cannot
speak for RHEL, SuSE, Ubuntu or what-ever Linux distro.</p>
<h4 id="linuxstar2017_commented_at_2017-09-27_0954"><img src="https://avatars.githubusercontent.com/u/31645285?v=4" width="50"><a href="https://github.com/linuxstar2017">linuxstar2017</a> commented at <a href="https://github.com/rear/rear/issues/1494#issuecomment-332471030">2017-09-27 09:54</a>:<a class="headerlink" href="#linuxstar2017_commented_at_2017-09-27_0954" title="Permanent link">&para;</a></h4>
<p>@gdha @jsmeix<br />
Sorry (as explained already to jsmeix) my fault ....<br />
Just forget it ... it's already channeled again the right way ...</p>
<h4 id="jsmeix_commented_at_2017-10-04_1418"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/1494#issuecomment-334170567">2017-10-04 14:18</a>:<a class="headerlink" href="#jsmeix_commented_at_2017-10-04_1418" title="Permanent link">&para;</a></h4>
<p>With
<a href="https://github.com/rear/rear/pull/1521">https://github.com/rear/rear/pull/1521</a>
merged<br />
the whole binaries and libraries copying code is now<br />
cleaned up and simplified.</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2024 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2017-09-15.1494.issue.closed.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/rear/rear-user-guide" class="fa fa-code-fork" style="color: #fcfcfc"> rear/rear-user-guide</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
