<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#813 PR closed: determine EFI virtual disk size automatically - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#813 PR closed: determine EFI virtual disk size automatically";
        var mkdocs_page_input_path = "issues/2016-04-03.813.pr.closed.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/backup_netfs.html">Example of BACKUP=NETFS</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/netfs_nas.html">Scenarios Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../development/squash-git-log-commments.html">How to squash git log comments into one line</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear29.html">Release Notes ReaR 2.9</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear28.html">Release Notes ReaR 2.8</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#813 PR closed: determine EFI virtual disk size automatically</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="813_pr_closed_determine_efi_virtual_disk_size_automatically"><a href="https://github.com/rear/rear/pull/813">#813 PR</a> <code>closed</code>: determine EFI virtual disk size automatically<a class="headerlink" href="#813_pr_closed_determine_efi_virtual_disk_size_automatically" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>enhancement</code>, <code>bug</code>, <code>cleanup</code></p>
<h4 id="gozora_opened_issue_at_2016-04-03_1512"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> opened issue at <a href="https://github.com/rear/rear/pull/813">2016-04-03 15:12</a>:<a class="headerlink" href="#gozora_opened_issue_at_2016-04-03_1512" title="Permanent link">&para;</a></h4>
<p>Fix for manual detection of EFI virtual image (efiboot.img) size.</p>
<h4 id="jsmeix_commented_at_2016-04-04_0823"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/813#issuecomment-205189456">2016-04-04 08:23</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-04-04_0823" title="Permanent link">&para;</a></h4>
<p>@gozora<br />
many thanks for the fix!</p>
<p>It looks much cleaner now (at least for me).</p>
<p>In particular I prefer to have that single task now<br />
in one single script (including its mount and umount)<br />
and no longer split into several scripts.</p>
<p>In 70_create_efibootimg.sh I wonder about the commented out code</p>
<pre>
#mv $v -f $TMP_DIR/efiboot.img $TMP_DIR/boot/efiboot.img >&2
...
#ISO_FILES=( ${ISO_FILES[@]} $TMP_DIR/boot/efiboot.img )
</pre>

<p>which is a copy from the old 70_umount_efibootimg.sh<br />
because I do not understand why that commented out code<br />
is there.<br />
It looks as if it is it meant as an alternative way how to do it<br />
but then I would like to know the pros and cons of both ways.</p>
<p>An addendum only FYI because the following<br />
is a matter of personal preference<br />
how one likes to implement it:</p>
<p>In general I wonder when a function (like efiboot_img_size)<br />
is only called in one single script if then the function<br />
should be better also defined only in that script?<br />
I.e. if a function that is "local" for a single script<br />
shouldn't be better defined locally in that script?</p>
<p>And even a step further:<br />
I wonder if a function is needed at all when<br />
some functionality is only needed one single time.<br />
Why not have such functionality implemented<br />
directly "inline"?</p>
<p>Of course it can make code better readable when<br />
certain tasks are split out into function definitions<br />
even if each task is done only once.</p>
<p>But I think the efiboot_img_size functionality is<br />
sufficiently small and simple to be also readable<br />
when its code would be directly "inline"<br />
in the 70_create_efibootimg.sh script.</p>
<p>Again: This is a matter of personal preference<br />
how one likes to implement it.</p>
<h4 id="jsmeix_commented_at_2016-04-04_0828"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/813#issuecomment-205191789">2016-04-04 08:28</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-04-04_0828" title="Permanent link">&para;</a></h4>
<p>I forgot my main question:</p>
<p>Before the minimum EFI virtual image size was 32000 KiB<br />
(via "size=32000").</p>
<p>Now the minimum EFI virtual image size is 128 MiB.</p>
<p>Why?</p>
<p>As far as I understand it this could make the ISO image<br />
of the rear recovery system needlessly bigger.</p>
<p>Some users use rear on thousands of their servers<br />
and therefore they must store thosands of images<br />
of the rear recovery system (one for each server)<br />
and then about 100MiB more for each image can<br />
make a noticeable difference for them.</p>
<p>In other words:</p>
<p>When the exact right size of EFI virtual image is determined,<br />
why is there a minimum EFI virtual image size at all?</p>
<p>Why not always use the exact right size of EFI virtual image?</p>
<h4 id="gozora_commented_at_2016-04-04_0855"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/pull/813#issuecomment-205200296">2016-04-04 08:55</a>:<a class="headerlink" href="#gozora_commented_at_2016-04-04_0855" title="Permanent link">&para;</a></h4>
<p>For the functions I just followed what was already written (I'm lazy
person and it is more convenient like this), but I share your view.
Local functions should be local, so if you prefer to have function
directly in <em>70_create_efibootimg.sh</em>, in can move it there.</p>
<p>The size topic is a bit tricky, but to cut the story short, smaller
(32MB) image size is fine when GRUB is used, (BTW. now I've realized
that this check was committed, I'll correct in in next pull request with
something similar to
<a href="https://github.com/rear/rear/blob/ce01a145451f74f15c6610e8611d60cbc1ce360a/usr/share/rear/output/ISO/Linux-i386/20_mount_efibootimg.sh">this</a>).
As GRUB is capable to "escape" virtual image into ordinary ISO
filesystem, and read kernel and initrd from there. ELILO is not, so you
must copy kernel together with initrd into image which makes it
significantly bigger.</p>
<p>And one interesting fact that I've learned the hard way; virtual image
must be aligned to 32MB ...</p>
<h4 id="jsmeix_commented_at_2016-04-04_1106"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/813#issuecomment-205245354">2016-04-04 11:06</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-04-04_1106" title="Permanent link">&para;</a></h4>
<p>Regarding the efiboot_img_size function just do it as you like<br />
(i.e. it is perfectly fine to be lazy and leave it as is).</p>
<p>Regarding the size:<br />
I totally trust you because you are the expert here.</p>
<p>FYI regarding
<a href="https://github.com/rear/rear/blob/ce01a145451f74f15c6610e8611d60cbc1ce360a/usr/share/rear/output/ISO/Linux-i386/20_mount_efibootimg.sh">https://github.com/rear/rear/blob/ce01a145451f74f15c6610e8611d60cbc1ce360a/usr/share/rear/output/ISO/Linux-i386/20_mount_efibootimg.sh</a></p>
<p>I wonder if there could be perhaps a bug because MB != MiB<br />
and perhaps it must be MiB (1024 x 1024)<br />
and not MB (1000 x 1000)?</p>
<pre>
   size=128000
else
   size=32000
...
dd if=/dev/zero of=$TMP_DIR/efiboot.img count=$size bs=1024
</pre>

<p>does neither result a 128 MiB nor MB nor 32 MiB nor MB efiboot.img</p>
<p>Is 128 x 1000 x 1024 or 32 x 1000 x 1024 really correct<br />
or must it be 128 x 1024 x 1024 and 32 x 1024 x 1024 for MiB<br />
or 128 x 1000 x 1000 and 32 x 1000 x 1000 for MB?</p>
<p>Cf.<br />
<a href="https://en.wikipedia.org/wiki/Byte#Unit_symbol">https://en.wikipedia.org/wiki/Byte#Unit_symbol</a></p>
<p>Accordingly 1000 x 1024 would be kKiB ;-)</p>
<h4 id="jsmeix_commented_at_2016-04-04_1146"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/pull/813#issuecomment-205261133">2016-04-04 11:46</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-04-04_1146" title="Permanent link">&para;</a></h4>
<p>Sorry, I got a bit confused</p>
<p>I see that<br />
<a href="https://github.com/rear/rear/blob/ce01a145451f74f15c6610e8611d60cbc1ce360a/usr/share/rear/output/ISO/Linux-i386/20_mount_efibootimg.sh">https://github.com/rear/rear/blob/ce01a145451f74f15c6610e8611d60cbc1ce360a/usr/share/rear/output/ISO/Linux-i386/20_mount_efibootimg.sh</a>
is old code.</p>
<p>In the new code that uses</p>
<pre>
dd ... count=$(efiboot_img_size $TMP_DIR/mnt) bs=1M
</pre>

<p>the kKiB versus MiB issue is fixed.</p>
<p>But I found a kKiB versus MiB issue still in<br />
usr/share/rear/output/ISO/Linux-ia64/20_mount_bootimg.sh</p>
<pre>
dd if=/dev/zero of=$TMP_DIR/boot.img count=64000 bs=1024
</pre>

<p>"git blame" shows that @gdha made that one.</p>
<p>@gdha<br />
should<br />
usr/share/rear/output/ISO/Linux-ia64/20_mount_bootimg.sh<br />
be fixed to</p>
<pre>
dd if=/dev/zero of=$TMP_DIR/boot.img count=64 bs=1M
</pre>

<h4 id="gozora_commented_at_2016-04-04_1243"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/pull/813#issuecomment-205281728">2016-04-04 12:43</a>:<a class="headerlink" href="#gozora_commented_at_2016-04-04_1243" title="Permanent link">&para;</a></h4>
<p>I've just pushed a
<a href="https://github.com/gozora/rear/commit/4f37b15a4567786ff55e21faa1286335c8b99e9e">commit</a>
about "near to be finished patch".<br />
However I can't imagine in my head about possible site effect so I need
to test if first.<br />
Once I have tests finished I'll create another pull request.<br />
BTW. I've moved <strong>efiboot_img_size()</strong> directly to
<em>70_create_efibootimg.sh</em></p>
<h4 id="gdha_commented_at_2016-04-04_1252"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/pull/813#issuecomment-205283772">2016-04-04 12:52</a>:<a class="headerlink" href="#gdha_commented_at_2016-04-04_1252" title="Permanent link">&para;</a></h4>
<p>Do not bother the Linux-ia64 scripts - these systems are getting
obsolete anyway</p>
<h4 id="gozora_commented_at_2016-04-04_1545"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/pull/813#issuecomment-205359238">2016-04-04 15:45</a>:<a class="headerlink" href="#gozora_commented_at_2016-04-04_1545" title="Permanent link">&para;</a></h4>
<p>I've done some testing (unfortunately only on my virtual guests) and all
seems to be working fine.<br />
If you have some better test possibilities (some real HW), please try to
test this patch before merging with main tree.</p>
<h4 id="gozora_commented_at_2016-04-05_1016"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/pull/813#issuecomment-205743648">2016-04-05 10:16</a>:<a class="headerlink" href="#gozora_commented_at_2016-04-05_1016" title="Permanent link">&para;</a></h4>
<p>@gdha shall I file new pull request or can you somehow resolve the
conflicts manually?</p>
<h4 id="gdha_commented_at_2016-04-05_1237"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/pull/813#issuecomment-205781071">2016-04-05 12:37</a>:<a class="headerlink" href="#gdha_commented_at_2016-04-05_1237" title="Permanent link">&para;</a></h4>
<p>@gozora if it is not too much work, perhaps recreate the pull request?</p>
<h4 id="gozora_commented_at_2016-04-05_1241"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/pull/813#issuecomment-205782255">2016-04-05 12:41</a>:<a class="headerlink" href="#gozora_commented_at_2016-04-05_1241" title="Permanent link">&para;</a></h4>
<p>@gdha Can you please close this one? I'll create new pull request once
this one is closed ... (just to avoid confusion ;-) )</p>
<h4 id="gdha_commented_at_2016-04-05_1243"><img src="https://avatars.githubusercontent.com/u/888633?u=cdaeb31efcc0048d3619651aa18dd4b76e636b21&v=4" width="50"><a href="https://github.com/gdha">gdha</a> commented at <a href="https://github.com/rear/rear/pull/813#issuecomment-205782843">2016-04-05 12:43</a>:<a class="headerlink" href="#gdha_commented_at_2016-04-05_1243" title="Permanent link">&para;</a></h4>
<p>close pull request as asked by @gozora</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2025 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2016-04-03.813.pr.closed.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/rear/rear-user-guide" class="fa fa-code-fork" style="color: #fcfcfc"> rear/rear-user-guide</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
