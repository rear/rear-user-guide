<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#810 Issue closed: mkrescue fails with UEFI and TSM - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#810 Issue closed: mkrescue fails with UEFI and TSM";
        var mkdocs_page_input_path = "issues/2016-03-30.810.issue.closed.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/backup_netfs.html">Example of BACKUP=NETFS</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/netfs_nas.html">Internal Backup with tar to NFS server</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../scenarios/netfs_rsync.md">Internal Backup with rsync to NFS server</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/rbme.html">External Backup using RBME</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/restic.html">External Backup using restic</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../development/squash-git-log-commments.html">How to squash git log comments into one line</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear29.html">Release Notes ReaR 2.9</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear28.html">Release Notes ReaR 2.8</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#810 Issue closed: mkrescue fails with UEFI and TSM</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="810_issue_closed_mkrescue_fails_with_uefi_and_tsm"><a href="https://github.com/rear/rear/issues/810">#810 Issue</a> <code>closed</code>: mkrescue fails with UEFI and TSM<a class="headerlink" href="#810_issue_closed_mkrescue_fails_with_uefi_and_tsm" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>enhancement</code>, <code>bug</code>, <code>cleanup</code>, <code>fixed / solved / done</code></p>
<h4 id="pavoldomin_opened_issue_at_2016-03-30_2114"><img src="https://avatars.githubusercontent.com/u/1576908?v=4" width="50"><a href="https://github.com/pavoldomin">pavoldomin</a> opened issue at <a href="https://github.com/rear/rear/issues/810">2016-03-30 21:14</a>:<a class="headerlink" href="#pavoldomin_opened_issue_at_2016-03-30_2114" title="Permanent link">&para;</a></h4>
<ul>
<li>rear version (/usr/sbin/rear -V): Most likely any (tested with
    1.17.2)</li>
<li>OS version (cat /etc/rear/os.conf or lsb_release -a): (very likely
    any), tested with SLES11 SP3</li>
<li>rear configuration files (cat /etc/rear/site.conf or cat
    /etc/rear/local.conf):</li>
</ul>
<!-- -->

<pre><code>BACKUP=TSM
COPY_AS_IS_TSM=( /etc/adsm/TSM.PWD /opt/tivoli/tsm/client /usr/local/ibm/gsk8* )
COPY_AS_IS_EXCLUDE_TSM=( )
PROGS_TSM=( dsmc tput )
TSM_RESULT_FILE_PATH=/opt/tivoli/tsm/rear
TSM_DSMC_RESTORE_OPTIONS=( )
TSM_RESTORE_PIT_DATE=
TSM_RESTORE_PIT_TIME=
TSM_RESULT_SAVE=y
</code></pre>
<p>the rest is the usual stuff</p>
<ul>
<li>Brief description of the issue<br />
    rear mkrescue (or mkbackup) fails with the message like<br />
<code>2016-03-29 17:14:15.078510507 ERROR: Could not copy initrd to UEFI</code></li>
<li>Work-around, if any<br />
    I have modified rear code: extended UEFI image size by
    experimentally determined value for this particular setup. I have
    not tested an actual recovery though (but do not see reason why it
    would not work).</li>
</ul>
<p>I will post the patch I used immediately, for your consideration.</p>
<h4 id="gozora_commented_at_2016-04-03_1515"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/810#issuecomment-204994477">2016-04-03 15:15</a>:<a class="headerlink" href="#gozora_commented_at_2016-04-03_1515" title="Permanent link">&para;</a></h4>
<p>I just created pull request #813.<br />
@pavoldomin can you please test, if it works as expected with TSM?</p>
<p>Thanks!</p>
<h4 id="jsmeix_commented_at_2016-04-05_1245"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/810#issuecomment-205783287">2016-04-05 12:45</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-04-05_1245" title="Permanent link">&para;</a></h4>
<p>FYI my tests with unchanged rear 1.18 on an UEFI system:</p>
<p>"rear -d -D mkrescue" fails with 'Could not copy initrd to UEFI'<br />
because of that error in the log file:</p>
<pre>
cp: error writing '/tmp/rear.kAFGCscGy27EXW4/tmp/mnt/EFI/BOOT/initrd.cgz': No space left on device
</pre>

<p>The 128 kKiB (128000 KiB) rear 1.18 default is already<br />
too small for me (I do not use thrid-party backup software).</p>
<p>I simply changed<br />
/usr/share/rear/output/ISO/Linux-i386/20_mount_efibootimg.sh<br />
directly to</p>
<pre>
dd if=/dev/zero of=$TMP_DIR/efiboot.img count=5 bs=32M
</pre>

<p>i.e. with 5 x 32MiB = 160MiB it is sufficient for me.</p>
<p>This results in "rear -d -D mkrescue" output:<br />
Wrote ISO image: /var/lib/rear/output/rear-caps.iso (447M)</p>
<p>An UEFI bootable ISO image is much bigger (almost 450MiB)<br />
than a traditional BIOS bootable ISO image which is less than<br />
120 MiB for me.</p>
<h4 id="gozora_commented_at_2016-04-05_1300"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/810#issuecomment-205791306">2016-04-05 13:00</a>:<a class="headerlink" href="#gozora_commented_at_2016-04-05_1300" title="Permanent link">&para;</a></h4>
<p>As the things become a bit unclear recently, did you use
<a href="https://github.com/gozora/rear">https://github.com/gozora/rear</a> for
your tests or some different commit.</p>
<h4 id="jsmeix_commented_at_2016-04-05_1337"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/810#issuecomment-205808349">2016-04-05 13:37</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-04-05_1337" title="Permanent link">&para;</a></h4>
<p>@gozora</p>
<p>Regarding that the virtual image must be aligned to 32MB<br />
I suggest a (hopefully) cleaner and more fail-safe<br />
and (hopefully) more obvious way how to do it<br />
in your new 70_create_efibootimg.sh as follows<br />
(excerpt):</p>
<pre>
# function to calculate exact size of EFI virtual image (efiboot.img)
function efiboot_img_size {
    # Get size of directory holding EFI virtual image content.
    # The virtual image must be aligned to 32MiB blocks
    # therefore the size of directory is measured in 32MiB blocks.
    efi_img_dir=$1
    # Specify a minimum EFI virtual image size measured in 32MiB blocks:
    case "$( basename $UEFI_BOOTLOADER )" in
        (shim.efi|elilo.efi)
            # minimum EFI virtual image size for shim and elilo
            # default: 128MiB = 4 * 32MiB blocks
            efi_img_min_sz=4
        ;;
        (*)
            # minimum EFI virtual image size for grub
            # default: 32MiB = 1 * 32MiB block
            efi_img_min_sz=1
        ;;
    esac
    # Fallback output of the minimum EFI virtual image size measured in 32MiB blocks:
    test $efi_img_dir || echo $efi_img_min_sz
    # The du output is stored in an artificial bash array
    # so that $efi_img_sz can be simply used to get the first word
    # which is the efi_img_sz value measured in 32MiB blocks:
    efi_img_sz=( $( du --block-size=32M --summarize $efi_img_dir ) )
    # Fallback output of the minimum EFI virtual image size measured in 32MiB blocks:
    test $efi_img_sz || echo $efi_img_min_sz
    test $efi_img_sz -ge 1 || echo $efi_img_min_sz
    # Output at least the minimum EFI virtual image size measured in 32MiB blocks:
    if test $efi_img_sz -lt $efi_img_min_sz ; then
        echo $efi_img_min_sz
    else
        echo $efi_img_sz
    fi
}
# prepare EFI virtual image
dd if=/dev/zero of=$TMP_DIR/efiboot.img count=$( efiboot_img_size $TMP_DIR/mnt ) bs=32M
</pre>

<h4 id="jsmeix_commented_at_2016-04-05_1340"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/810#issuecomment-205809255">2016-04-05 13:40</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-04-05_1340" title="Permanent link">&para;</a></h4>
<p>I did not you use
<a href="https://github.com/gozora/rear">https://github.com/gozora/rear</a> for my
tests above.<br />
For my tests above I used the released rear 1.18 as is.<br />
I liked to show that for my system 128 MiB is too small.<br />
Perhaps the default minimal efi image size should be bigger?</p>
<p>But now I used your new 70_create_efibootimg.sh<br />
with the changes in my other comment directly above<br />
and that "just works" for me.</p>
<h4 id="jsmeix_commented_at_2016-04-05_1344"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/810#issuecomment-205811219">2016-04-05 13:44</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-04-05_1344" title="Permanent link">&para;</a></h4>
<p>FYI excerpts from my succesful "rear -d -D mkrescue" log<br />
with your new 70_create_efibootimg.sh with the changes<br />
in my other comment above:</p>
<pre>
+ source /usr/share/rear/output/ISO/Linux-i386/70_create_efibootimg.sh
++ is_true 1
++ case "$1" in
++ return 0
+++ efiboot_img_size /tmp/rear.XO6CsKzXPsuGy5c/tmp/mnt
+++ efi_img_dir=/tmp/rear.XO6CsKzXPsuGy5c/tmp/mnt
+++ case "$( basename $UEFI_BOOTLOADER )" in
++++ basename /boot/efi/EFI/opensuse/shim.efi
+++ efi_img_min_sz=4
+++ test /tmp/rear.XO6CsKzXPsuGy5c/tmp/mnt
+++ efi_img_sz=($( du --block-size=32M --summarize $efi_img_dir ))
++++ du --block-size=32M --summarize /tmp/rear.XO6CsKzXPsuGy5c/tmp/mnt
+++ test 5
+++ test 5 -ge 1
+++ test 5 -lt 4
+++ echo 5
++ dd if=/dev/zero of=/tmp/rear.XO6CsKzXPsuGy5c/tmp/efiboot.img count=5 bs=32M
5+0 records in
5+0 records out
167772160 bytes (168 MB) copied, 0.143509 s, 1.2 GB/s
</pre>

<h4 id="jsmeix_commented_at_2016-04-05_1353"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/810#issuecomment-205815297">2016-04-05 13:53</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-04-05_1353" title="Permanent link">&para;</a></h4>
<p>FYI why "du --block-size=32M -s" should work as expected<br />
(at least on my system):</p>
<p>33554433 = ( 32 x 1024 x 1024 ) + 1</p>
<pre>
# dd if=/dev/zero of=/tmp/foo count=1 bs=33554433
1+0 records in
1+0 records out
33554433 bytes (34 MB) copied, 0.0492154 s, 682 MB/s
# ls -lh /tmp/foo
-rw-r--r-- 1 root root 33M Apr  5 15:51 /tmp/foo
# du --block-size=32M -s /tmp/foo
2       /tmp/foo
</pre>

<h4 id="jsmeix_commented_at_2016-04-06_0717"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/810#issuecomment-206173327">2016-04-06 07:17</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-04-06_0717" title="Permanent link">&para;</a></h4>
<p>How embarrassing - my code in
<a href="https://github.com/rear/rear/issues/810#issuecomment-205808349">https://github.com/rear/rear/issues/810#issuecomment-205808349</a>
has bugs:</p>
<p>All fallback outputs must of course also<br />
return from the efiboot_img_size function, i.e.<br />
instead of things like</p>
<pre>
test condition-to-proceed || echo fallback-value
</pre>

<p>it must be</p>
<pre>
test condition-to-proceed || { echo fallback-value ; return ; }
</pre>

<p>Furthermore the</p>
<pre>
    test $efi_img_sz || ...
</pre>

<p>line is unnecessary<br />
because the subsequent test</p>
<pre>
    test $efi_img_sz -ge 1 || ...
</pre>

<p>alone is sufficient.</p>
<h4 id="gozora_commented_at_2016-04-06_0720"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/810#issuecomment-206176551">2016-04-06 07:20</a>:<a class="headerlink" href="#gozora_commented_at_2016-04-06_0720" title="Permanent link">&para;</a></h4>
<p>@jsmeix Can you send me corrected function by mail?<br />
I'll correct it ...</p>
<h4 id="jsmeix_commented_at_2016-04-06_0732"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/810#issuecomment-206182534">2016-04-06 07:32</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-04-06_0732" title="Permanent link">&para;</a></h4>
<p>@gozora</p>
<p>I will send you the corrected function.<br />
I am sorry that my bad code caused trouble for you.<br />
Yesterday I changed too much at once<br />
and worse I did it too fast and worst I did not test<br />
if my error handling code actually works :-(</p>
<p>Do you like to keep the current default 128MiB<br />
minimum EFI virtual image size for shim and elilo<br />
which is too small for me (i.e. it seems 128MiB<br />
is too small for my "usual" SLES12 UEFI system)<br />
or<br />
should I also specify 5 x 32MiB = 160 MiB for the<br />
minimum EFI virtual image size for shim and elilo?</p>
<h4 id="gozora_commented_at_2016-04-06_0752"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/810#issuecomment-206191629">2016-04-06 07:52</a>:<a class="headerlink" href="#gozora_commented_at_2016-04-06_0752" title="Permanent link">&para;</a></h4>
<p>Not a big deal, I could discover it as well, but like I mentioned
before, your style of code is a bit hard to read for me I preffer
<code>if [[ ]]; then else ...</code> rather than <code>test</code></p>
<p>For the default size, I guess that it doesn't matter what is the default
size, the function should automatically calculate size needed for EFI
virtual image, or am I wrong?</p>
<h4 id="jsmeix_commented_at_2016-04-06_0824"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/810#issuecomment-206214853">2016-04-06 08:24</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-04-06_0824" title="Permanent link">&para;</a></h4>
<p>Regarding what you called "default size":</p>
<p>Actually it is not a default size but a minimal size<br />
(and its variable is named "..._min_sz" - cf. below)<br />
so that a too big minimal size matters because<br />
the image could never be smaller than that.<br />
A too big minimal size wastes space for the user, cf.<br />
<a href="https://github.com/rear/rear/pull/813#issuecomment-205191789">https://github.com/rear/rear/pull/813#issuecomment-205191789</a></p>
<p>Regarding my coding syntax style:</p>
<p>Feel free to change my "test ..." into "if [[ ... ]] ; then ...".<br />
For me both are equally well understandable.<br />
It is just different syntax for the same meaning.<br />
I do not care much about coding syntax style.</p>
<p>But I do care very much about coding semantics style:</p>
<p>Where I am particularly picky in semantics style<br />
is naming of any "thingies" (variables, functions, files, ...).</p>
<p>Frankly I insist on using descriptive meaningful names.</p>
<p>In particular I insist on using differentiating
qualifiers/adjectives/...<br />
in names for example</p>
<ul>
<li>"efi_img_dir" instead of meaningless "$1"</li>
<li>"efi_img_sz" instead of meaningless "size"</li>
</ul>
<p>I insist on using different names for different things<br />
so that others can easily "grep" over the whole code<br />
for such names and get a correct overview what<br />
actually belongs to that particular "thingy".</p>
<p>For example I never use "i" as a variable name.<br />
Just try to "grep" for it over the whole code<br />
to find where a bug is that is related to "i" ;-)</p>
<h4 id="gozora_commented_at_2016-04-06_0838"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/810#issuecomment-206220784">2016-04-06 08:38</a>:<a class="headerlink" href="#gozora_commented_at_2016-04-06_0838" title="Permanent link">&para;</a></h4>
<p>Yes, sorry it is definitely not default size, my fault. It is clear to
me what efi_img_min_sz actually does.<br />
What I don't understand is why you want to increase it to 160MiB when
function it self can determine what the right size is? I mean when
128MiB are not enough for your SLES12, this function should return
160MiB, right?</p>
<h4 id="gozora_commented_at_2016-04-06_0844"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/810#issuecomment-206224192">2016-04-06 08:44</a>:<a class="headerlink" href="#gozora_commented_at_2016-04-06_0844" title="Permanent link">&para;</a></h4>
<p>And for the coding style, we don't need to change anything, I told it is
hard for me not impossible ;-).<br />
For the descriptive and meaningful names I can only agree! (however I
sometimes tend to forget to keep this rule)</p>
<h4 id="jsmeix_commented_at_2016-04-06_0850"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/810#issuecomment-206227461">2016-04-06 08:50</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-04-06_0850" title="Permanent link">&para;</a></h4>
<p>You are absolutely right.</p>
<p>But then I don't understand why there is a minimal size at all<br />
(i.e. I do not understand your
<a href="https://github.com/rear/rear/pull/813#issuecomment-205200296">https://github.com/rear/rear/pull/813#issuecomment-205200296</a>).</p>
<p>Shouldn't the "du" command determine what the right size is<br />
in all cases i.e. for shim and elilo and also for grub?</p>
<p>If the "du" command determines the right size in any case<br />
we could simply rely on it and remove all code that deals<br />
with the minimal size and its usage as fallback output value.</p>
<p>In case of errors with the "du" command we could then<br />
simply abort with "Error error-message" because I cannot<br />
imagine why the "du" command may fail in practice.</p>
<h4 id="gozora_commented_at_2016-04-06_0857"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/810#issuecomment-206234340">2016-04-06 08:57</a>:<a class="headerlink" href="#gozora_commented_at_2016-04-06_0857" title="Permanent link">&para;</a></h4>
<p>hmmm, actually you are right!<br />
All what we need is:</p>
<ol>
<li>determine size of staging directory ($TMP_DIR/mnt/)</li>
<li>and align it to 32 MiB</li>
<li>return the size to <code>dd</code></li>
</ol>
<p>Is this what you meant?</p>
<h4 id="jsmeix_commented_at_2016-04-06_0910"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/810#issuecomment-206243790">2016-04-06 09:10</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-04-06_0910" title="Permanent link">&para;</a></h4>
<p>Yes, and here my current stripped down 70_create_efibootimg.sh<br />
(that still works for me with same results as before):</p>
<pre>
# 70_create_efibootimg.sh
is_true $USING_UEFI_BOOTLOADER || return    # empty or 0 means NO UEFI
# Calculate exact size of EFI virtual image (efiboot.img):
# Get size of directory holding EFI virtual image content.
# The virtual image must be aligned to 32MiB blocks
# therefore the size of directory is measured in 32MiB blocks.
# The du output is stored in an artificial bash array
# so that $efi_img_sz can be simply used to get the first word
# which is the disk usage of the directory measured in 32MiB blocks:
efi_img_sz=( $( du --block-size=32M --summarize $TMP_DIR/mnt ) )
StopIfError "Failed to determine disk usage of EFI virtual image content directory."
# prepare EFI virtual image aligned to 32MiB blocks:
dd if=/dev/zero of=$TMP_DIR/efiboot.img count=$efi_img_sz bs=32M
mkfs.vfat $v -F 16 $TMP_DIR/efiboot.img >&2
mkdir -p $v $TMP_DIR/efi_virt >&2
mount $v -o loop -t vfat -o fat=16 $TMP_DIR/efiboot.img $TMP_DIR/efi_virt >&2
# copy files from staging directory
cp $v -r $TMP_DIR/mnt/. $TMP_DIR/efi_virt
umount $v $TMP_DIR/efiboot.img >&2
mv $v -f $TMP_DIR/efiboot.img $TMP_DIR/isofs/boot/efiboot.img >&2
StopIfError "Could not move efiboot.img file"
</pre>

<p>This time I even tested that the StopIfError<br />
actually works if the du command fails ;-)</p>
<p>And no longer any "test" usage ;-)</p>
<h4 id="gozora_commented_at_2016-04-06_0917"><img src="https://avatars.githubusercontent.com/u/12116358?u=1c5ba9dcee5ca3082f03029a7fbe647efd30eb49&v=4" width="50"><a href="https://github.com/gozora">gozora</a> commented at <a href="https://github.com/rear/rear/issues/810#issuecomment-206249744">2016-04-06 09:17</a>:<a class="headerlink" href="#gozora_commented_at_2016-04-06_0917" title="Permanent link">&para;</a></h4>
<p>This is what call code optimization!<br />
Will update pull request!</p>
<h4 id="jsmeix_commented_at_2016-04-06_1109"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/810#issuecomment-206313827">2016-04-06 11:09</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-04-06_1109" title="Permanent link">&para;</a></h4>
<p>This issue should be fixed with
<a href="https://github.com/rear/rear/pull/816">https://github.com/rear/rear/pull/816</a></p>
<h4 id="jsmeix_commented_at_2016-04-08_0746"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/810#issuecomment-207281944">2016-04-08 07:46</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-04-08_0746" title="Permanent link">&para;</a></h4>
<p>@pavoldomin<br />
I would greatly appreciate it if you could test<br />
whether or not the current rear master<br />
with full automated UEFI image size calculation<br />
(implemented in the new 70_create_efibootimg.sh that replaced<br />
the whole stuff before, cf.
<a href="https://github.com/rear/rear/pull/816/files">https://github.com/rear/rear/pull/816/files</a>)<br />
"just works" for you.</p>
<h4 id="pavoldomin_commented_at_2016-04-27_0611"><img src="https://avatars.githubusercontent.com/u/1576908?v=4" width="50"><a href="https://github.com/pavoldomin">pavoldomin</a> commented at <a href="https://github.com/rear/rear/issues/810#issuecomment-214980623">2016-04-27 06:11</a>:<a class="headerlink" href="#pavoldomin_commented_at_2016-04-27_0611" title="Permanent link">&para;</a></h4>
<p>Found in trash again. I've tested it already, works as charm.</p>
<h4 id="jsmeix_commented_at_2016-04-27_0701"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/810#issuecomment-214988928">2016-04-27 07:01</a>:<a class="headerlink" href="#jsmeix_commented_at_2016-04-27_0701" title="Permanent link">&para;</a></h4>
<p>@pavoldomin<br />
many thanks for your feedback!</p>
<p>I was already a bit wondering why you didn't reply,<br />
thinking about things like you are perhaps on vacation<br />
but actually it was some proprietary non-free software<br />
that made its own false decisions
(<a href="https://github.com/rear/rear/issues/821#issuecomment-214761409">https://github.com/rear/rear/issues/821#issuecomment-214761409</a>)<br />
about your incoming mail - presumably with the very best<br />
of intentions to protect you from possibly unpleasant stuff ;-)</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2025 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2016-03-30.810.issue.closed.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/rear/rear-user-guide" class="fa fa-code-fork" style="color: #fcfcfc"> rear/rear-user-guide</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
