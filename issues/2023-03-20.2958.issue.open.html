<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="Relax-and-Recover (ReaR) User Guide Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Relax-and-Recover (ReaR) kind of documentation ans starting with a good User Guide."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://relax-and-recover.org/rear-user-guide/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://relax-and-recover.org/rear-user-guide/img/rear_logo_50.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    
    <title>#2958 Issue open: ReaR fails while verifying the disklayout when a disk has a 0 size - Relax-and-Recover (ReaR) User Guide Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/rear.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "#2958 Issue open: ReaR fails while verifying the disklayout when a disk has a 0 size";
        var mkdocs_page_input_path = "issues/2023-03-20.2958.issue.open.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', "366986045", "auto");
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> Relax-and-Recover (ReaR) User Guide Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">BASICS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/introduction.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/history.html">Bit of History</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/getting-started.html">Getting started with ReaR</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/configuration.html">Basic configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../basics/backup_netfs.html">Example of BACKUP=NETFS</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SCENARIOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/index.html">Scenarios Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/netfs_nas.html">Internal Backup with tar to NFS server</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/rbme.html">External Backup using RBME</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../scenarios/restic.html">External Backup using restic</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPMENT</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../development/github-pr.html">Make a pull request with GitHub</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../development/squash-git-log-commments.html">How to squash git log comments into one line</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear29.html">Release Notes ReaR 2.9</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear28.html">Release Notes ReaR 2.8</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear27.html">Release Notes ReaR 2.7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/rear26.html">Release Notes ReaR 2.6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../releasenotes/knownproblems.html">Known Problems and Workarounds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ISSUES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Issues History</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Relax-and-Recover (ReaR) User Guide Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">#2958 Issue open: ReaR fails while verifying the disklayout when a disk has a 0 size</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="2958_issue_open_rear_fails_while_verifying_the_disklayout_when_a_disk_has_a_0_size"><a href="https://github.com/rear/rear/issues/2958">#2958 Issue</a> <code>open</code>: ReaR fails while verifying the disklayout when a disk has a 0 size<a class="headerlink" href="#2958_issue_open_rear_fails_while_verifying_the_disklayout_when_a_disk_has_a_0_size" title="Permanent link">&para;</a></h1>
<p><strong>Labels</strong>: <code>enhancement</code></p>
<h4 id="rmetrich_opened_issue_at_2023-03-20_1537"><img src="https://avatars.githubusercontent.com/u/1163635?u=36b5e32e1dd55f1ce77cad431a5683fce40a7934&v=4" width="50"><a href="https://github.com/rmetrich">rmetrich</a> opened issue at <a href="https://github.com/rear/rear/issues/2958">2023-03-20 15:37</a>:<a class="headerlink" href="#rmetrich_opened_issue_at_2023-03-20_1537" title="Permanent link">&para;</a></h4>
<ul>
<li>ReaR version ("/usr/sbin/rear -V"):</li>
</ul>
<p>latest upstream 2.7 at latest commit
7ce864210fc7a7c95a131ea8c933f543b6e3b9cb</p>
<ul>
<li>OS version ("cat /etc/os-release" or "lsb_release -a" or "cat
    /etc/rear/os.conf"):</li>
</ul>
<p>N/A</p>
<ul>
<li>ReaR configuration files ("cat /etc/rear/site.conf" and/or "cat
    /etc/rear/local.conf"):</li>
</ul>
<!-- -->

<pre><code>AUTOEXCLUDE_DISKS=n
</code></pre>
<ul>
<li>Hardware vendor/product (PC or PowerNV BareMetal or ARM) or VM (KVM
    guest or PowerVM LPAR):</li>
</ul>
<p>N/A</p>
<ul>
<li>System architecture (x86 compatible or PPC64/PPC64LE or what exact
    ARM device):</li>
</ul>
<p>N/A</p>
<ul>
<li>Firmware (BIOS or UEFI or Open Firmware) and bootloader (GRUB or
    ELILO or Petitboot):</li>
</ul>
<p>N/A</p>
<ul>
<li>Storage (local disk or SSD) and/or SAN (FC or iSCSI or FCoE) and/or
    multipath (DM or NVMe):</li>
</ul>
<p>USB Card Reader with no card inserted</p>
<ul>
<li>Storage layout ("lsblk -ipo
    NAME,KNAME,PKNAME,TRAN,TYPE,FSTYPE,LABEL,SIZE,MOUNTPOINT"):</li>
</ul>
<p>N/A</p>
<ul>
<li>Description of the issue (ideally so that others can reproduce it):</li>
</ul>
<p>When plugging in a USB multi-card reader (SD / MicroSD) which has no
card insert, the device (<code>/dev/sda</code>) has a 0 size.<br />
This leads to layout verification to fail:</p>
<pre><code>No partition label type for 'disk /dev/sda' (may cause 'rear recover' failure)
/dev/sda size 0 is not a positive integer
ERROR: 
====================
BUG in /root/rear/usr/share/rear/layout/save/default/950_verify_disklayout_file.sh line 254:
'Entries in /root/rear/var/lib/rear/layout/disklayout.conf are broken ('rear recover' would fail)'
</code></pre>
<p>This happens when <code>AUTOEXCLUDE_DISKS=n</code> (which is not the default).</p>
<ul>
<li>Workaround, if any:</li>
</ul>
<p>None found yet, except excluding the "disk" manually, which isn't always
possible due to non-persistent device naming.</p>
<ul>
<li>Attachments, as applicable ("rear -D mkrescue/mkbackup/recover"
    debug log files):</li>
</ul>
<p>The root cause is the code snippet in
<code>/usr/share/rear/layout/save/GNU/Linux/200_partition_layout.sh</code>, which
doesn't skip disks with <code>$devsize == 0</code> :</p>
<pre><code>415                 devsize=$(get_disk_size ${disk#/sys/block/})
416                 disktype=$(parted -s $devname print | grep -E "Partition Table|Disk label" | cut -d ":" -f "2" | t    r -d " ")
 :
430                     echo "disk $devname $devsize $disktype"
</code></pre>
<p>This leads to creating entry <code>disk sda 0</code>, which is invalid entry
(missing <code>$disktype</code>).</p>
<p>I think the solution is to skip those 0 size disks completely.</p>
<h4 id="pcahyna_commented_at_2023-03-20_1610"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/2958#issuecomment-1476526798">2023-03-20 16:10</a>:<a class="headerlink" href="#pcahyna_commented_at_2023-03-20_1610" title="Permanent link">&para;</a></h4>
<p>Potentially similar issue: #2810 , but details seem different. Possibly
because in #2810 disk access fails with "No medium found", while here
it returns size 0 (@rmetrich can you please check if <code>blockdev</code> reports
<code>blockdev: cannot open /dev/sdb: No medium found</code> which would indicate
that the drive actually behaves same as in #2810 ? ) Also please
provide the USB vendor and model (lsusb output).</p>
<h4 id="rmetrich_commented_at_2023-03-20_1704"><img src="https://avatars.githubusercontent.com/u/1163635?u=36b5e32e1dd55f1ce77cad431a5683fce40a7934&v=4" width="50"><a href="https://github.com/rmetrich">rmetrich</a> commented at <a href="https://github.com/rear/rear/issues/2958#issuecomment-1476615206">2023-03-20 17:04</a>:<a class="headerlink" href="#rmetrich_commented_at_2023-03-20_1704" title="Permanent link">&para;</a></h4>
<p>Yes it returns "Medium not found". But I think whenever the size
returned is 0, the disk should be skipped.</p>
<p>The SD card reader I used for reproducing is:</p>
<pre><code>Bus 002 Device 007: ID 8564:4000 Transcend Information, Inc. microSD/SD/CF UHS-II Card Reader [RDF8, RDF9]
</code></pre>
<h4 id="jsmeix_commented_at_2023-03-21_0935"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2958#issuecomment-1477522212">2023-03-21 09:35</a>:<a class="headerlink" href="#jsmeix_commented_at_2023-03-21_0935" title="Permanent link">&para;</a></h4>
<p>@rmetrich<br />
good to hear from you again!</p>
<p>Does "rear recover" work in your case<br />
with a disk with size 0 in disklayout.conf?<br />
I.e. when you disable (e.g. via 'return 0' as first line)<br />
layout/save/default/950_verify_disklayout_file.sh<br />
during "rear mkrescue/mkbackup"<br />
does then "rear recover" work for you?</p>
<p>The primary reason for the tests in<br />
layout/save/default/950_verify_disklayout_file.sh<br />
is to avoid known cases where "rear recover" fails.<br />
Better error out "too often" during "rear mkrescue"<br />
than possibly let the user learn the "too hard" way<br />
why he must verify in advance that "rear recover"<br />
will work for him for his specific use case ;-)</p>
<h4 id="jsmeix_commented_at_2023-03-21_0941"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2958#issuecomment-1477530189">2023-03-21 09:41</a>:<a class="headerlink" href="#jsmeix_commented_at_2023-03-21_0941" title="Permanent link">&para;</a></h4>
<p>Regarding<br />
<a href="https://github.com/rear/rear/issues/2958#issue-1632369838">https://github.com/rear/rear/issues/2958#issue-1632369838</a></p>
<pre><code>entry 'disk sda 0', which is invalid entry (missing $disktype)
</code></pre>
<p>see my test in<br />
<a href="https://github.com/rear/rear/issues/2810#issuecomment-1141138162">https://github.com/rear/rear/issues/2810#issuecomment-1141138162</a><br />
which shows that "rear recover" even works when there is<br />
only a 'disk' entry without partition type label value<br />
but nothing else for this disk exists in disklayout.conf like</p>
<pre><code>disk /dev/sdb 5368709120
</code></pre>
<p>so perhaps "rear recover" also works when there is<br />
only a 'disk' entry without partition type label value<br />
and with zero disk size but nothing else for this disk<br />
exists in disklayout.conf like</p>
<pre><code>disk /dev/sdb 0
</code></pre>
<p>Next test would be if "rear recover" also works when there is<br />
only a 'disk' entry without partition type label value<br />
and without a disk size value but nothing else for this disk<br />
exists in disklayout.conf like</p>
<pre><code>disk /dev/sdb
</code></pre>
<h4 id="jsmeix_commented_at_2023-03-21_0952"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2958#issuecomment-1477543465">2023-03-21 09:52</a>:<a class="headerlink" href="#jsmeix_commented_at_2023-03-21_0952" title="Permanent link">&para;</a></h4>
<p>Only an offhanded idea regarding the workaroud</p>
<pre><code>excluding the "disk" manually, which isn't always possible
due to non-persistent device naming
</code></pre>
<p>Because etc/rear/local.conf is executed as bash script<br />
one can implement therein whatever works in the specific case<br />
to autodetect the right disk which must be excluded.</p>
<h4 id="jsmeix_commented_at_2023-03-21_1250"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2958#issuecomment-1477783731">2023-03-21 12:50</a>:<a class="headerlink" href="#jsmeix_commented_at_2023-03-21_1250" title="Permanent link">&para;</a></h4>
<p>I tested how "rear recover" behaves<br />
when there is only a 'disk' entry<br />
but nothing else for this disk<br />
exists in disklayout.conf</p>
<p>To test that I created an empty 1GiB disk on a KVM/QEMU VM.</p>
<p>"rear mkrescue" makes only this one disabled entry<br />
in disklayout.conf</p>
<pre><code>#disk /dev/sdb 1073741824 unknown
</code></pre>
<h3 id="1_disk_devsdb_1073741824_unknown">(1) disk /dev/sdb 1073741824 unknown<a class="headerlink" href="#1_disk_devsdb_1073741824_unknown" title="Permanent link">&para;</a></h3>
<p>I tested "rear recover" with this entry enabled</p>
<pre><code>disk /dev/sdb 1073741824 unknown
</code></pre>
<p>"rear recover" works.</p>
<p>I got this in diskrestore.sh</p>
<pre><code>if create_component "/dev/sdb" "disk" ; then
# Create /dev/sdb (disk)

#
# Code handling disk '/dev/sdb'
#

### Disks should be block devices.
[ -b "/dev/sdb" ] || BugError "Disk /dev/sdb is not a block device."

Log "Stop mdadm"
if grep -q md /proc/mdstat 2&gt;/dev/null; then
    mdadm --stop -s &gt;&amp;2 || echo "stop mdadm failed"
    # Prevent udev waking up mdadm later.
    # Reasoning: At least on RHEL6 when parted created a raid partition on disk,
    # udev (via /lib/udev/rules.d/65-md-incremental.rules) wakes up mdadm which locks the disk,
    # so further parted commands with the disk will fail since the disk is busy now.
    # The /lib/udev/rules.d/65-md-incremental.rules detects anaconda (the Red Hat installer),
    # and if it find itself running under anaconda, it will not run.
    # Accordingly also for other installers (in particular the ReaR installer)
    # this rule should not be there (and other Linux distros probably do not have it)
    # which means removing it is the right solution to make ReaR work also for RHEL6:
    if [ -e /lib/udev/rules.d/65-md-incremental.rules ] ; then
        rm -f /lib/udev/rules.d/65-md-incremental.rules || echo "rm 65-md-incremental.rules failed"
    fi
fi
Log "Erasing MBR of disk /dev/sdb"
dd if=/dev/zero of=/dev/sdb bs=512 count=1
sync

# Make sure device nodes are visible (eg. in RHEL4)
my_udevtrigger
my_udevsettle

# Clean up transient partitions and resize shrinked ones
delete_dummy_partitions_and_resize_real_ones

#
# End of code handling disk '/dev/sdb'
#

component_created "/dev/sdb" "disk"
else
    LogPrint "Skipping /dev/sdb (disk) as it has already been created."
fi
</code></pre>
<h3 id="2_disk_devsdb_1073741824">(2) disk /dev/sdb 1073741824<a class="headerlink" href="#2_disk_devsdb_1073741824" title="Permanent link">&para;</a></h3>
<p>I tested "rear recover" with this entry</p>
<pre><code>disk /dev/sdb 1073741824
</code></pre>
<p>"rear recover" works.</p>
<p>I got this in diskrestore.sh</p>
<pre><code>if create_component "/dev/sdb" "disk" ; then
# Create /dev/sdb (disk)

#
# Code handling disk '/dev/sdb'
#

### Disks should be block devices.
[ -b "/dev/sdb" ] || BugError "Disk /dev/sdb is not a block device."

Log "Stop mdadm"
if grep -q md /proc/mdstat 2&gt;/dev/null; then
    mdadm --stop -s &gt;&amp;2 || echo "stop mdadm failed"
    # Prevent udev waking up mdadm later.
    # Reasoning: At least on RHEL6 when parted created a raid partition on disk,
    # udev (via /lib/udev/rules.d/65-md-incremental.rules) wakes up mdadm which locks the disk,
    # so further parted commands with the disk will fail since the disk is busy now.
    # The /lib/udev/rules.d/65-md-incremental.rules detects anaconda (the Red Hat installer),
    # and if it find itself running under anaconda, it will not run.
    # Accordingly also for other installers (in particular the ReaR installer)
    # this rule should not be there (and other Linux distros probably do not have it)
    # which means removing it is the right solution to make ReaR work also for RHEL6:
    if [ -e /lib/udev/rules.d/65-md-incremental.rules ] ; then
        rm -f /lib/udev/rules.d/65-md-incremental.rules || echo "rm 65-md-incremental.rules failed"
    fi
fi
Log "Erasing MBR of disk /dev/sdb"
dd if=/dev/zero of=/dev/sdb bs=512 count=1
sync

# Make sure device nodes are visible (eg. in RHEL4)
my_udevtrigger
my_udevsettle

# Clean up transient partitions and resize shrinked ones
delete_dummy_partitions_and_resize_real_ones

#
# End of code handling disk '/dev/sdb'
#

component_created "/dev/sdb" "disk"
else
    LogPrint "Skipping /dev/sdb (disk) as it has already been created."
fi
</code></pre>
<p>I.e. same as in case (1) before</p>
<h3 id="3_disk_devsdb_0">(3) disk /dev/sdb 0<a class="headerlink" href="#3_disk_devsdb_0" title="Permanent link">&para;</a></h3>
<p>I tested "rear recover" with this entry</p>
<pre><code>disk /dev/sdb 0
</code></pre>
<p>"rear recover" works<br />
but now it goes into MIGRATION_MODE (as expected):</p>
<pre><code>Device sda has expected (same) size 21474836480 bytes (will be used for 'recover')
Device sdb has size 1073741824 bytes but 0 bytes is expected (needs manual configuration)
Switching to manual disk layout configuration (GiB sizes rounded down to integer)
/dev/sda has same size 21474836480 (20 GiB)
/dev/sdb had size 0 (0 GiB) but is now 1073741824 (1 GiB)
Using /dev/sda (same name and same size 21474836480) for recreating /dev/sda
Could not automap /dev/sdb (no disk with same size 0 found)
Original disk /dev/sdb does not exist (with same size) in the target system
Cannot check write protection by ID for /dev/sdb (no ID found)
Using /dev/sdb (the only available of the disks) for recreating /dev/sdb
Current disk mapping table (source =&gt; target):
  /dev/sda =&gt; /dev/sda
  /dev/sdb =&gt; /dev/sdb
...
Confirm or edit the disk mapping
...
User confirmed disk mapping
</code></pre>
<p>I got this in diskrestore.sh</p>
<pre><code>if create_component "/dev/sdb" "disk" ; then
# Create /dev/sdb (disk)

#
# Code handling disk '/dev/sdb'
#

### Disks should be block devices.
[ -b "/dev/sdb" ] || BugError "Disk /dev/sdb is not a block device."

Log "Stop mdadm"
if grep -q md /proc/mdstat 2&gt;/dev/null; then
    mdadm --stop -s &gt;&amp;2 || echo "stop mdadm failed"
    # Prevent udev waking up mdadm later.
    # Reasoning: At least on RHEL6 when parted created a raid partition on disk,
    # udev (via /lib/udev/rules.d/65-md-incremental.rules) wakes up mdadm which locks the disk,
    # so further parted commands with the disk will fail since the disk is busy now.
    # The /lib/udev/rules.d/65-md-incremental.rules detects anaconda (the Red Hat installer),
    # and if it find itself running under anaconda, it will not run.
    # Accordingly also for other installers (in particular the ReaR installer)
    # this rule should not be there (and other Linux distros probably do not have it)
    # which means removing it is the right solution to make ReaR work also for RHEL6:
    if [ -e /lib/udev/rules.d/65-md-incremental.rules ] ; then
        rm -f /lib/udev/rules.d/65-md-incremental.rules || echo "rm 65-md-incremental.rules failed"
    fi
fi
Log "Erasing MBR of disk /dev/sdb"
dd if=/dev/zero of=/dev/sdb bs=512 count=1
sync

# Make sure device nodes are visible (eg. in RHEL4)
my_udevtrigger
my_udevsettle

# Clean up transient partitions and resize shrinked ones
delete_dummy_partitions_and_resize_real_ones

#
# End of code handling disk '/dev/sdb'
#

component_created "/dev/sdb" "disk"
else
    LogPrint "Skipping /dev/sdb (disk) as it has already been created."
fi
</code></pre>
<p>I.e. same as in case (1) and (2) before</p>
<h3 id="4_disk_devsdb">(4) disk /dev/sdb<a class="headerlink" href="#4_disk_devsdb" title="Permanent link">&para;</a></h3>
<p>I tested "rear recover" with this entry</p>
<pre><code>disk /dev/sdb
</code></pre>
<p>Now "rear recover" fails</p>
<pre><code>Device sda has expected (same) size 21474836480 bytes (will be used for 'recover')
Device sdb has size 1073741824 bytes but  bytes is expected (needs manual configuration)
Switching to manual disk layout configuration (GiB sizes rounded down to integer)
/dev/sda has same size 21474836480 (20 GiB)
/dev/sdb had size  (0 GiB) but is now 1073741824 (1 GiB)
Using /dev/sda (same name and same size 21474836480) for recreating /dev/sda
Could not automap /dev/sdb (no disk with same size  found)
Original disk /dev/sdb does not exist (with same size) in the target system
Cannot check write protection by ID for /dev/sdb (no ID found)
Using /dev/sdb (the only available of the disks) for recreating /dev/sdb
Current disk mapping table (source =&gt; target):
  /dev/sda =&gt; /dev/sda
  /dev/sdb =&gt; /dev/sdb
...
Confirm or edit the disk mapping
...
User confirmed disk mapping
...
Start system layout restoration.
Disk '/dev/sda': creating 'gpt' partition table
Disk '/dev/sda': creating partition number 1 with name ''sda1''
Disk '/dev/sda': creating partition number 2 with name ''sda2''
ERROR: 
====================
BUG in /var/lib/rear/layout/diskrestore.sh line 112:
'Disk  is not a block device.'
--------------------
Please report it at https://github.com/rear/rear/issues
and include all related parts from /var/log/rear/rear-localhost.log
preferably the whole debug information via 'rear -D recover'
====================
Some latest log messages since the last called script 200_run_layout_code.sh:
  2023-03-21 13:33:09.742193096 Erasing MBR of disk /dev/sda
  1+0 records in
  1+0 records out
  512 bytes copied, 0.00330212 s, 155 kB/s
  2023-03-21 13:33:09.756683476 Disk '/dev/sda': creating 'gpt' partition table
  2023-03-21 13:33:09.832794541 Disk '/dev/sda': creating partition number 1 with name ''sda1''
  2023-03-21 13:33:10.143920489 Disk '/dev/sda': creating partition number 2 with name ''sda2''
  /dev/sda: gpt partitions 1 2
Error exit of rear recover (PID 764) and its descendant processes
</code></pre>
<p>I got this in diskrestore.sh</p>
<pre><code>if create_component "/dev/sdb" "disk" ; then
# Create /dev/sdb (disk)

#
# Code handling disk ''
#

### Disks should be block devices.
[ -b "" ] || BugError "Disk  is not a block device."

Log "Stop mdadm"
if grep -q md /proc/mdstat 2&gt;/dev/null; then
    mdadm --stop -s &gt;&amp;2 || echo "stop mdadm failed"
    # Prevent udev waking up mdadm later.
    # Reasoning: At least on RHEL6 when parted created a raid partition on disk,
    # udev (via /lib/udev/rules.d/65-md-incremental.rules) wakes up mdadm which locks the disk,
    # so further parted commands with the disk will fail since the disk is busy now.
    # The /lib/udev/rules.d/65-md-incremental.rules detects anaconda (the Red Hat installer),
    # and if it find itself running under anaconda, it will not run.
    # Accordingly also for other installers (in particular the ReaR installer)
    # this rule should not be there (and other Linux distros probably do not have it)
    # which means removing it is the right solution to make ReaR work also for RHEL6:
    if [ -e /lib/udev/rules.d/65-md-incremental.rules ] ; then
        rm -f /lib/udev/rules.d/65-md-incremental.rules || echo "rm 65-md-incremental.rules failed"
    fi
fi
Log "Erasing MBR of disk "
dd if=/dev/zero of= bs=512 count=1
sync

# Make sure device nodes are visible (eg. in RHEL4)
my_udevtrigger
my_udevsettle

# Clean up transient partitions and resize shrinked ones
delete_dummy_partitions_and_resize_real_ones

#
# End of code handling disk ''
#

component_created "/dev/sdb" "disk"
else
    LogPrint "Skipping /dev/sdb (disk) as it has already been created."
fi
</code></pre>
<p>which is different than before at those places</p>
<pre><code>#
# Code handling disk ''
#

### Disks should be block devices.
[ -b "" ] || BugError "Disk  is not a block device."
</code></pre>
<p>and</p>
<pre><code>Log "Erasing MBR of disk "
dd if=/dev/zero of= bs=512 count=1
</code></pre>
<h4 id="jsmeix_commented_at_2023-03-21_1307"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2958#issuecomment-1477807951">2023-03-21 13:07</a>:<a class="headerlink" href="#jsmeix_commented_at_2023-03-21_1307" title="Permanent link">&para;</a></h4>
<p>I think the issue is more generic:</p>
<p>I wonder what to do when there is only a 'disk' entry<br />
but nothing else for this disk exists in disklayout.conf?</p>
<p>Should such a "lonely" 'disk' entry be commented out<br />
as it happens above for my "empty disk" test case<br />
OR<br />
should disks where we cannot detect the usually needed values<br />
for disk size and partition type label be skipped<br />
and all what possibly depends on such disks<br />
(partitions filesystems and so one)<br />
OR<br />
should we somehow try to autodetect when<br />
a disk is an empty SD card slot or the like<br />
and then skip all of it?</p>
<p>If we skip disks and all what belongs to them<br />
should we report that to the user so he is informed<br />
(we may skip things the user expects to be included)<br />
or would that be only unwanted noise in almost all cases?<br />
Perhaps report it only via DebugPrint so the user can<br />
see it when unexpected things got skipped?</p>
<h4 id="pcahyna_commented_at_2023-03-21_1355"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/2958#issuecomment-1477881234">2023-03-21 13:55</a>:<a class="headerlink" href="#pcahyna_commented_at_2023-03-21_1355" title="Permanent link">&para;</a></h4>
<blockquote>
<p>I wonder what to do when there is only a 'disk' entry but nothing else
for this disk exists in disklayout.conf?</p>
<p>Should such a "lonely" 'disk' entry be commented out as it happens
above for my "empty disk" test case</p>
</blockquote>
<p>My preference. That's how the component exclusion code works now. If
there is nothing useful on the disk (either because there is nothing at
all, or because the components got excluded by the include/exclude
rules) , the entry for the disk is itself excluded (commented out). This
prevents formatting of disks that are not included in the backup. I rely
on it in the s390 code (where the <code>disk</code> entry also governs low-level
formatting of the disk). But even outside the context of dasd-specific
stuff it makes sense.</p>
<blockquote>
<p>OR should disks where we cannot detect the usually needed values for
disk size and partition type label be skipped and all what possibly
depends on such disks (partitions filesystems and so one)</p>
</blockquote>
<p>This should not happen - if we can't detect basic stuff like partition
table and size, there shouldn't be anything that depends on the disk
(like partitions and anything on them)? Having a partition on a disk
whose size can't be even determined or which does not have a partition
table is not an expected situation. I would call BugError in this case.</p>
<blockquote>
<p>OR should we somehow try to autodetect when a disk is an empty SD card
slot or the like and then skip all of it?</p>
</blockquote>
<p>Yes, I think we should skip disk drives without disk media (or with bad
media - I saw a failing SCSI disk that was reported but with a size of 0
- it was not even a removable disk).</p>
<h4 id="pcahyna_commented_at_2023-03-21_1400"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/2958#issuecomment-1477889365">2023-03-21 14:00</a>:<a class="headerlink" href="#pcahyna_commented_at_2023-03-21_1400" title="Permanent link">&para;</a></h4>
<blockquote>
<h3 id="3_disk_devsdb_1">(3) disk /dev/sdb 0<a class="headerlink" href="#3_disk_devsdb_1" title="Permanent link">&para;</a></h3>
<p>I tested "rear recover" with this entry</p>
<pre><code>disk /dev/sdb 0
</code></pre>
<p>"rear recover" works</p>
</blockquote>
<p>Note that as soon as the USB card reader is unplugged from the USB port,
the layout code will fail because of the</p>
<pre><code>[ -b "/dev/sdb" ] || BugError "Disk /dev/sdb is not a block device."
</code></pre>
<p>part.<br />
So in this case it is indeed better if the <code>disk</code> entry gets commented
out. (Of course this does not protect you against the situation where
there is an actual card with data in the reader during backup and then
the reader gets removed for recovery.)</p>
<h4 id="pcahyna_commented_at_2023-03-21_1404"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/2958#issuecomment-1477896992">2023-03-21 14:04</a>:<a class="headerlink" href="#pcahyna_commented_at_2023-03-21_1404" title="Permanent link">&para;</a></h4>
<p>(Note that all the reasoning about commenting out the unused <code>disk</code>
entries does not apply to this bug report, because the problem happens
when <code>AUTOEXCLUDE_DISKS=n</code>)</p>
<h4 id="jsmeix_commented_at_2023-03-21_1413"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2958#issuecomment-1477914092">2023-03-21 14:13</a>:<a class="headerlink" href="#jsmeix_commented_at_2023-03-21_1413" title="Permanent link">&para;</a></h4>
<p>The case when there is an actual card with data in the reader<br />
during backup and then the reader gets removed for recovery<br />
is an unsupported migration case:<br />
Recreating on hardware with different number of disks.<br />
In such cases the user must manually adapt his disklayout.conf.</p>
<h4 id="jsmeix_commented_at_2023-03-21_1416"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2958#issuecomment-1477918947">2023-03-21 14:16</a>:<a class="headerlink" href="#jsmeix_commented_at_2023-03-21_1416" title="Permanent link">&para;</a></h4>
<p>Perhaps with <code>AUTOEXCLUDE_DISKS=n</code> the user cannot expect that<br />
then certain unwanted disks get automatically excluded or skipped?</p>
<h4 id="jsmeix_commented_at_2023-03-21_1441"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2958#issuecomment-1477963982">2023-03-21 14:41</a>:<a class="headerlink" href="#jsmeix_commented_at_2023-03-21_1441" title="Permanent link">&para;</a></h4>
<p>I think I see now how it failed in the above case<br />
(4) disk /dev/sdb</p>
<p>In layout/prepare/GNU/Linux/100_include_partition_code.sh<br />
there is</p>
<pre><code>create_disk() {
    local component disk size label junk
    local blocksize layout dasdtype dasdcyls junk2
    read component disk size label junk &lt; &lt;(grep "^disk $1 " "$LAYOUT_FILE")

    cat &gt;&gt; "$LAYOUT_CODE" &lt;&lt;EOF

#
# Code handling disk '$disk'
#

### Disks should be block devices.
[ -b "$disk" ] || BugError "Disk $disk is not a block device."
</code></pre>
<p>where the <code>grep "^disk $1 " "$LAYOUT_FILE"</code><br />
results nothing for <code>disk /dev/sdb</code><br />
because there is no trailing space after '/dev/sdb'.</p>
<p>In the log file that code results</p>
<pre><code>++ create_disk /dev/sdb
++ local component disk size label junk
++ local blocksize layout dasdtype dasdcyls junk2
++ read component disk size label junk
+++ grep '^disk /dev/sdb ' /var/lib/rear/layout/disklayout.conf
++ cat
</code></pre>
<p>Sigh!<br />
Just the usual old "blindly proceed" code, cf.<br />
"Try hard to care about possible errors" in<br />
<a href="https://github.com/rear/rear/wiki/Coding-Style">https://github.com/rear/rear/wiki/Coding-Style</a></p>
<h4 id="jsmeix_commented_at_2023-03-21_1508"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2958#issuecomment-1478010520">2023-03-21 15:08</a>:<a class="headerlink" href="#jsmeix_commented_at_2023-03-21_1508" title="Permanent link">&para;</a></h4>
<p>With<br />
<a href="https://github.com/rear/rear/commit/8bb07de7a552e72657b11b02c95f1b3c9089513c">https://github.com/rear/rear/commit/8bb07de7a552e72657b11b02c95f1b3c9089513c</a><br />
it fails now "better" in the above case<br />
(4) disk /dev/sdb</p>
<pre><code>User confirmed disk layout file
Marking component '/dev/sda' as done in /var/lib/rear/layout/disktodo.conf
Marking component '/dev/sda1' as done in /var/lib/rear/layout/disktodo.conf
Marking component '/dev/sda2' as done in /var/lib/rear/layout/disktodo.conf
ERROR: 
====================
BUG in /usr/share/rear/layout/prepare/GNU/Linux/100_include_partition_code.sh line 31:
'No 'disk /dev/sdb ' entry in /var/lib/rear/layout/disklayout.conf'
--------------------
Please report it at https://github.com/rear/rear/issues
and include all related parts from /var/log/rear/rear-localhost.log
preferably the whole debug information via 'rear -D recover'
====================
Some latest log messages since the last called script 540_generate_device_code.sh:
  2023-03-21 16:04:29.898569368 Marking component '/dev/sda1' as done in /var/lib/rear/layout/disktodo.conf
  2023-03-21 16:04:29.909547264 Testing /dev/sda2 for dependencies...
  2023-03-21 16:04:29.917718888 deps (1): /dev/sda
  2023-03-21 16:04:29.923187643 All dependencies for /dev/sda2 are present, processing...
  2023-03-21 16:04:29.933992874 Marking component '/dev/sda2' as done in /var/lib/rear/layout/disktodo.conf
  2023-03-21 16:04:29.944777845 Testing /dev/sdb for dependencies...
  2023-03-21 16:04:29.952433935 deps (0): 
  2023-03-21 16:04:29.956760120 All dependencies for /dev/sdb are present, processing...
Aborting due to an error, check /var/log/rear/rear-localhost.log for details
</code></pre>
<p>It fails "better" because now it fails earlier in<br />
layout/prepare/default/540_generate_device_code.sh<br />
with a message that tells the actual error<br />
and not arbitrarily later when running<br />
the broken generated diskrestore.sh script.</p>
<h4 id="pcahyna_commented_at_2023-03-21_1510"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/2958#issuecomment-1478012476">2023-03-21 15:10</a>:<a class="headerlink" href="#pcahyna_commented_at_2023-03-21_1510" title="Permanent link">&para;</a></h4>
<blockquote>
<p>the <code>grep "^disk $1 " "$LAYOUT_FILE"</code><br />
results nothing for <code>disk /dev/sdb</code><br />
because there is no trailing space after '/dev/sdb'.</p>
</blockquote>
<p>If the third field is mandatory, perhaps it is not a big problem if the
code misbehaves without it?</p>
<h4 id="jsmeix_commented_at_2023-03-21_1513"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2958#issuecomment-1478017206">2023-03-21 15:13</a>:<a class="headerlink" href="#jsmeix_commented_at_2023-03-21_1513" title="Permanent link">&para;</a></h4>
<p>Yes, it is OK that the third field is mandatory.<br />
But when it is mandatory the code should<br />
not "blindly proceed" when it is not there.<br />
In particular because disklayout.conf is meant<br />
to be edited by the user when needed.</p>
<h4 id="jsmeix_commented_at_2023-03-21_1515"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2958#issuecomment-1478022308">2023-03-21 15:15</a>:<a class="headerlink" href="#jsmeix_commented_at_2023-03-21_1515" title="Permanent link">&para;</a></h4>
<p>With</p>
<h3 id="5_disk_devsdb_with_a_trailing_space">(5) 'disk /dev/sdb ' (with a trailing space)<a class="headerlink" href="#5_disk_devsdb_with_a_trailing_space" title="Permanent link">&para;</a></h3>
<p>"rear recover" works as in the other cases (1)...(3)</p>
<h4 id="pcahyna_commented_at_2023-03-21_1526"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/2958#issuecomment-1478040683">2023-03-21 15:26</a>:<a class="headerlink" href="#pcahyna_commented_at_2023-03-21_1526" title="Permanent link">&para;</a></h4>
<blockquote>
<p>Perhaps with <code>AUTOEXCLUDE_DISKS=n</code> the user cannot expect that then
certain unwanted disks get automatically excluded</p>
</blockquote>
<p>Indeed, <code>AUTOEXCLUDE_DISKS=y</code> is documented as "Automatically exclude
disks that are not used by mounted filesystems" in default.conf</p>
<blockquote>
<p>or skipped?</p>
</blockquote>
<p>I would think that invalid disks (zero-sized, missing media) should
still be skipped, even with <code>AUTOEXCLUDE_DISKS=n</code>. It is not documented
that this such a functionality (not even implemented) would depend on
<code>AUTOEXCLUDE_DISKS=y</code>. And since excluding unused disks is a very
different operation than excluding broken disks (even if in practice
they tend to occur together since a broken disk is typically unused as
well), I would not conflate them.</p>
<h4 id="jsmeix_commented_at_2023-03-21_1530"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2958#issuecomment-1478047502">2023-03-21 15:30</a>:<a class="headerlink" href="#jsmeix_commented_at_2023-03-21_1530" title="Permanent link">&para;</a></h4>
<p>OK from me to automatically exclude or silently skip<br />
(silent means without user notification in normal modes)<br />
broken disks regardless how AUTOEXCLUDE_DISKS is set.</p>
<h4 id="pcahyna_commented_at_2023-03-21_1554"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/2958#issuecomment-1478092432">2023-03-21 15:54</a>:<a class="headerlink" href="#pcahyna_commented_at_2023-03-21_1554" title="Permanent link">&para;</a></h4>
<blockquote>
<p>The case when there is an actual card with data in the reader during
backup and then the reader gets removed for recovery is an unsupported
migration case: Recreating on hardware with different number of disks.
In such cases the user must manually adapt his disklayout.conf.</p>
</blockquote>
<p>Indeed. I don't have any ambition to extend the code to support this
case. I mentioned it only for completeness.</p>
<h4 id="pcahyna_commented_at_2023-03-22_0943"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/2958#issuecomment-1479221836">2023-03-22 09:43</a>:<a class="headerlink" href="#pcahyna_commented_at_2023-03-22_0943" title="Permanent link">&para;</a></h4>
<p>Thank you @rmetrich and @jsmeix for all your information and thoughts. I
now have the hardware which triggers the problem so I can continue.</p>
<h4 id="jsmeix_commented_at_2023-03-22_1341"><img src="https://avatars.githubusercontent.com/u/1788608?u=925fc54e2ce01551392622446ece427f51e2f0ce&v=4" width="50"><a href="https://github.com/jsmeix">jsmeix</a> commented at <a href="https://github.com/rear/rear/issues/2958#issuecomment-1479588829">2023-03-22 13:41</a>:<a class="headerlink" href="#jsmeix_commented_at_2023-03-22_1341" title="Permanent link">&para;</a></h4>
<p>I think I found a (possibly severe) issue<br />
with the current behaviour of "rear recover"<br />
for incomplete 'disk' entries in disklayout.conf</p>
<p>See<br />
<a href="https://github.com/rear/rear/issues/2958#issuecomment-1477783731">https://github.com/rear/rear/issues/2958#issuecomment-1477783731</a><br />
and<br />
<a href="https://github.com/rear/rear/issues/2810#issuecomment-1141138162">https://github.com/rear/rear/issues/2810#issuecomment-1141138162</a></p>
<p>The current behaviour of "rear recover"<br />
for incomplete 'disk /dev/sdb' entries in disklayout.conf<br />
results in diskrestore.sh (excerpt)</p>
<pre><code>Log "Erasing MBR of disk /dev/sdb"
dd if=/dev/zero of=/dev/sdb bs=512 count=1
sync
</code></pre>
<p>which destroys the first 512 data bytes on the disk.</p>
<p>I am wondering if this might damage data on a disk<br />
that is not meant to be touched by ReaR?</p>
<p>For example assume during "rear mkrescue/mkbackup" there is<br />
a disk /dev/sdb with removable medium that has no medium loaded<br />
(e.g. because that disk is not meant to be touched by ReaR)<br />
which results an incomplete 'disk /dev/sdb' entry in disklayout.conf<br />
but during "rear recover" there is (perhaps accidentally)<br />
a medium loaded so "rear recover" will damage the data on the medium.</p>
<h4 id="pcahyna_commented_at_2023-03-22_1352"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/2958#issuecomment-1479607035">2023-03-22 13:52</a>:<a class="headerlink" href="#pcahyna_commented_at_2023-03-22_1352" title="Permanent link">&para;</a></h4>
<p>IMO incomplete entries should not be allowed to occur. Unknown disk
label types are covered by the literal <code>unknown</code>, right?<br />
And if a device should be skipped (e.g. because there is no actual disk
in the drive), I would completely avoid adding it to disklayout, instead
of adding a incomplete entry.</p>
<p>The <code>dd</code> command will be problematic in any case, because if there is no
medium, we do not lose any data, but <code>dd</code> will abort with the error
message <code>... No medium found</code>. And diskrestore.sh runs with <code>errexit</code>
set...</p>
<p>EDIT: to answer the question - indeed it is a problem - @jsmeix good
catch!</p>
<h4 id="pcahyna_commented_at_2023-03-22_1357"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/2958#issuecomment-1479615071">2023-03-22 13:57</a>:<a class="headerlink" href="#pcahyna_commented_at_2023-03-22_1357" title="Permanent link">&para;</a></h4>
<p>By the way, after my update of the S/390 code, unformatted DASDs (which
also report zero size, but unlike drives with missing media they can be
opened) are already skipped from the layout entirely (except for the
<code>dasd_channel</code> directive that causes them to be activated (to not cause
unnecessary shifts in naming)).</p>
<h4 id="drakkainenn_commented_at_2023-04-19_1007"><img src="https://avatars.githubusercontent.com/u/111309896?v=4" width="50"><a href="https://github.com/drakkainenn">drakkainenn</a> commented at <a href="https://github.com/rear/rear/issues/2958#issuecomment-1514471944">2023-04-19 10:07</a>:<a class="headerlink" href="#drakkainenn_commented_at_2023-04-19_1007" title="Permanent link">&para;</a></h4>
<p>I have almost the same issue.<br />
My /dev/sdab is cdrom or some other device.<br />
errors:</p>
<p>No partition label type for 'disk /dev/sdab' (may cause 'rear recover'
failure<br />
Verifying that the entries in /var/lib/rear/layout/disklayout.conf are
correct<br />
/dev/sdab size 0 is not a positive integer</p>
<p>ERROR:<br />
BUG in
/usr/share/rear/layout/save/default/950_verify_disklayout_file.sh
line 254:<br />
'Entries in /var/lib/rear/layout/disklayout.conf are broken ('rear
recover' would fail)'</p>
<pre><code>disklayout.conf:
# Disk /dev/sdab
# Format: disk &lt;devname&gt; &lt;size(bytes)&gt; &lt;partition label type&gt;
disk /dev/sdab 0
</code></pre>
<h4 id="pcahyna_commented_at_2023-04-25_0909"><img src="https://avatars.githubusercontent.com/u/26300485?u=9105d243bc9f7ade463a3e52e8dd13fa67837158&v=4" width="50"><a href="https://github.com/pcahyna">pcahyna</a> commented at <a href="https://github.com/rear/rear/issues/2958#issuecomment-1521442335">2023-04-25 09:09</a>:<a class="headerlink" href="#pcahyna_commented_at_2023-04-25_0909" title="Permanent link">&para;</a></h4>
<p>@drakkainenn I believe for CD-ROM drives it should not happen, because
they should not show up as <code>/dev/sd*</code>. But for "some other device" it
certainly could, if it has removable media (e.g. a Iomega Zip would
probably fall in this category).</p>
<p>Are you also using <code>AUTOEXCLUDE_DISKS=n</code> ? The problem should not happen
without this setting.</p>
<hr />
<p>[Export of Github issue for
<a href="https://github.com/rear/rear">rear/rear</a>.]</p>
              
            </div>
          </div>

<footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2025 - CC0 1.0 Universal<br />Give <a href="https://github.com/rear/rear-user-guide/issues/new?title=issues/2023-03-20.2958.issue.open.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/rear/rear-user-guide" class="fa fa-code-fork" style="color: #fcfcfc"> rear/rear-user-guide</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
